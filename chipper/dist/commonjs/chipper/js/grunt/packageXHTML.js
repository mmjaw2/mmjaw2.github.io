"use strict";

// Copyright 2018-2024, University of Colorado Boulder

/**
 * Combines all parts of a runnable's built file into an XHTML structure (with separate files)
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

// modules
var assert = require('assert');
var ChipperConstants = require('../common/ChipperConstants');
var ChipperStringUtils = require('../common/ChipperStringUtils');
var getTitleStringKey = require('./getTitleStringKey');
var grunt = require('grunt');
var nodeHTMLEncoder = require('node-html-encoder'); // eslint-disable-line require-statement-match

/**
 * From a given set of config (including the JS and other required things), it creates an XHTML structure.
 * @public
 *
 * @param {string} xhtmlDir
 * @param {Object} config
 * @returns {string} - The HTML for the file.
 */
module.exports = function (xhtmlDir, config) {
  var encoder = new nodeHTMLEncoder.Encoder('entity');
  var repo = config.repo,
    brand = config.brand,
    stringMap = config.stringMap,
    initializationScript = config.initializationScript,
    licenseScript = config.licenseScript,
    scripts = config.scripts,
    htmlHeader = config.htmlHeader;
  assert(typeof repo === 'string', 'Requires repo');
  assert(stringMap, 'Requires stringMap');
  assert(scripts, 'Requires scripts');
  assert(typeof htmlHeader === 'string', 'Requires htmlHeader');
  var localizedTitle = stringMap[ChipperConstants.FALLBACK_LOCALE][getTitleStringKey(repo)];
  var licenseScriptFilename = "".concat(repo, "_license_").concat(brand, ".js");
  var initializationScriptFilename = "".concat(repo, "_initialization_").concat(brand, ".js");
  var script = scripts.join('\n');
  var scriptFilename = "".concat(repo, "_").concat(brand, ".js");
  var xhtml = ChipperStringUtils.replacePlaceholders(grunt.file.read('../chipper/templates/sim.xhtml'), {
    PHET_SIM_TITLE: encoder.htmlEncode(localizedTitle),
    PHET_HTML_HEADER: htmlHeader,
    PHET_INITIALIZATION_SCRIPT: "<script type=\"text/javascript\" src=\"".concat(licenseScriptFilename, "\" charset=\"utf-8\"></script><script type=\"text/javascript\" src=\"").concat(initializationScriptFilename, "\" charset=\"utf-8\"></script>"),
    PHET_SIM_SCRIPTS: "<script type=\"text/javascript\" src=\"".concat(scriptFilename, "\" charset=\"utf-8\"></script>")
  });
  grunt.file.write("".concat(xhtmlDir, "/").concat(repo, "_all").concat(brand === 'phet' ? '' : "_".concat(brand), ".xhtml"), xhtml);
  grunt.file.write("".concat(xhtmlDir, "/").concat(licenseScriptFilename), licenseScript);
  grunt.file.write("".concat(xhtmlDir, "/").concat(initializationScriptFilename), initializationScript);
  grunt.file.write("".concat(xhtmlDir, "/").concat(scriptFilename), script);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhc3NlcnQiLCJyZXF1aXJlIiwiQ2hpcHBlckNvbnN0YW50cyIsIkNoaXBwZXJTdHJpbmdVdGlscyIsImdldFRpdGxlU3RyaW5nS2V5IiwiZ3J1bnQiLCJub2RlSFRNTEVuY29kZXIiLCJtb2R1bGUiLCJleHBvcnRzIiwieGh0bWxEaXIiLCJjb25maWciLCJlbmNvZGVyIiwiRW5jb2RlciIsInJlcG8iLCJicmFuZCIsInN0cmluZ01hcCIsImluaXRpYWxpemF0aW9uU2NyaXB0IiwibGljZW5zZVNjcmlwdCIsInNjcmlwdHMiLCJodG1sSGVhZGVyIiwibG9jYWxpemVkVGl0bGUiLCJGQUxMQkFDS19MT0NBTEUiLCJsaWNlbnNlU2NyaXB0RmlsZW5hbWUiLCJjb25jYXQiLCJpbml0aWFsaXphdGlvblNjcmlwdEZpbGVuYW1lIiwic2NyaXB0Iiwiam9pbiIsInNjcmlwdEZpbGVuYW1lIiwieGh0bWwiLCJyZXBsYWNlUGxhY2Vob2xkZXJzIiwiZmlsZSIsInJlYWQiLCJQSEVUX1NJTV9USVRMRSIsImh0bWxFbmNvZGUiLCJQSEVUX0hUTUxfSEVBREVSIiwiUEhFVF9JTklUSUFMSVpBVElPTl9TQ1JJUFQiLCJQSEVUX1NJTV9TQ1JJUFRTIiwid3JpdGUiXSwic291cmNlcyI6WyJwYWNrYWdlWEhUTUwuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyNCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQ29tYmluZXMgYWxsIHBhcnRzIG9mIGEgcnVubmFibGUncyBidWlsdCBmaWxlIGludG8gYW4gWEhUTUwgc3RydWN0dXJlICh3aXRoIHNlcGFyYXRlIGZpbGVzKVxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuXHJcbi8vIG1vZHVsZXNcclxuY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSggJ2Fzc2VydCcgKTtcclxuY29uc3QgQ2hpcHBlckNvbnN0YW50cyA9IHJlcXVpcmUoICcuLi9jb21tb24vQ2hpcHBlckNvbnN0YW50cycgKTtcclxuY29uc3QgQ2hpcHBlclN0cmluZ1V0aWxzID0gcmVxdWlyZSggJy4uL2NvbW1vbi9DaGlwcGVyU3RyaW5nVXRpbHMnICk7XHJcbmNvbnN0IGdldFRpdGxlU3RyaW5nS2V5ID0gcmVxdWlyZSggJy4vZ2V0VGl0bGVTdHJpbmdLZXknICk7XHJcbmNvbnN0IGdydW50ID0gcmVxdWlyZSggJ2dydW50JyApO1xyXG5jb25zdCBub2RlSFRNTEVuY29kZXIgPSByZXF1aXJlKCAnbm9kZS1odG1sLWVuY29kZXInICk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1zdGF0ZW1lbnQtbWF0Y2hcclxuXHJcbi8qKlxyXG4gKiBGcm9tIGEgZ2l2ZW4gc2V0IG9mIGNvbmZpZyAoaW5jbHVkaW5nIHRoZSBKUyBhbmQgb3RoZXIgcmVxdWlyZWQgdGhpbmdzKSwgaXQgY3JlYXRlcyBhbiBYSFRNTCBzdHJ1Y3R1cmUuXHJcbiAqIEBwdWJsaWNcclxuICpcclxuICogQHBhcmFtIHtzdHJpbmd9IHhodG1sRGlyXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWdcclxuICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgSFRNTCBmb3IgdGhlIGZpbGUuXHJcbiAqL1xyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCB4aHRtbERpciwgY29uZmlnICkge1xyXG4gIGNvbnN0IGVuY29kZXIgPSBuZXcgbm9kZUhUTUxFbmNvZGVyLkVuY29kZXIoICdlbnRpdHknICk7XHJcblxyXG4gIGNvbnN0IHtcclxuICAgIHJlcG8sIC8vIHtzdHJpbmd9XHJcbiAgICBicmFuZCwgLy8ge3N0cmluZ31cclxuICAgIHN0cmluZ01hcCwgLy8ge09iamVjdH0sIG1hcFsgbG9jYWxlIF1bIHN0cmluZ0tleSBdID0+IHtzdHJpbmd9XHJcbiAgICBpbml0aWFsaXphdGlvblNjcmlwdCwgLy8ge3N0cmluZ30gLSBzZXBhcmF0ZSBmcm9tIHRoZSByZXN0IG9mIHRoZSBzY3JpcHRzIHNpbmNlIGl0IG5lZWRzIHRvIGJlIGFibGUgdG8gcnVuIGluIElFLlxyXG4gICAgbGljZW5zZVNjcmlwdCwgLy8ge3N0cmluZ31cclxuICAgIHNjcmlwdHMsIC8vIHtBcnJheS48c3RyaW5nPn1cclxuICAgIGh0bWxIZWFkZXIgLy8ge3N0cmluZ31cclxuICB9ID0gY29uZmlnO1xyXG4gIGFzc2VydCggdHlwZW9mIHJlcG8gPT09ICdzdHJpbmcnLCAnUmVxdWlyZXMgcmVwbycgKTtcclxuICBhc3NlcnQoIHN0cmluZ01hcCwgJ1JlcXVpcmVzIHN0cmluZ01hcCcgKTtcclxuICBhc3NlcnQoIHNjcmlwdHMsICdSZXF1aXJlcyBzY3JpcHRzJyApO1xyXG4gIGFzc2VydCggdHlwZW9mIGh0bWxIZWFkZXIgPT09ICdzdHJpbmcnLCAnUmVxdWlyZXMgaHRtbEhlYWRlcicgKTtcclxuXHJcbiAgY29uc3QgbG9jYWxpemVkVGl0bGUgPSBzdHJpbmdNYXBbIENoaXBwZXJDb25zdGFudHMuRkFMTEJBQ0tfTE9DQUxFIF1bIGdldFRpdGxlU3RyaW5nS2V5KCByZXBvICkgXTtcclxuXHJcbiAgY29uc3QgbGljZW5zZVNjcmlwdEZpbGVuYW1lID0gYCR7cmVwb31fbGljZW5zZV8ke2JyYW5kfS5qc2A7XHJcbiAgY29uc3QgaW5pdGlhbGl6YXRpb25TY3JpcHRGaWxlbmFtZSA9IGAke3JlcG99X2luaXRpYWxpemF0aW9uXyR7YnJhbmR9LmpzYDtcclxuXHJcbiAgY29uc3Qgc2NyaXB0ID0gc2NyaXB0cy5qb2luKCAnXFxuJyApO1xyXG4gIGNvbnN0IHNjcmlwdEZpbGVuYW1lID0gYCR7cmVwb31fJHticmFuZH0uanNgO1xyXG5cclxuICBjb25zdCB4aHRtbCA9IENoaXBwZXJTdHJpbmdVdGlscy5yZXBsYWNlUGxhY2Vob2xkZXJzKCBncnVudC5maWxlLnJlYWQoICcuLi9jaGlwcGVyL3RlbXBsYXRlcy9zaW0ueGh0bWwnICksIHtcclxuICAgIFBIRVRfU0lNX1RJVExFOiBlbmNvZGVyLmh0bWxFbmNvZGUoIGxvY2FsaXplZFRpdGxlICksXHJcbiAgICBQSEVUX0hUTUxfSEVBREVSOiBodG1sSGVhZGVyLFxyXG4gICAgUEhFVF9JTklUSUFMSVpBVElPTl9TQ1JJUFQ6IGA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIke2xpY2Vuc2VTY3JpcHRGaWxlbmFtZX1cIiBjaGFyc2V0PVwidXRmLThcIj48L3NjcmlwdD48c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIke2luaXRpYWxpemF0aW9uU2NyaXB0RmlsZW5hbWV9XCIgY2hhcnNldD1cInV0Zi04XCI+PC9zY3JpcHQ+YCxcclxuICAgIFBIRVRfU0lNX1NDUklQVFM6IGA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIke3NjcmlwdEZpbGVuYW1lfVwiIGNoYXJzZXQ9XCJ1dGYtOFwiPjwvc2NyaXB0PmBcclxuICB9ICk7XHJcbiAgZ3J1bnQuZmlsZS53cml0ZSggYCR7eGh0bWxEaXJ9LyR7cmVwb31fYWxsJHticmFuZCA9PT0gJ3BoZXQnID8gJycgOiBgXyR7YnJhbmR9YH0ueGh0bWxgLCB4aHRtbCApO1xyXG4gIGdydW50LmZpbGUud3JpdGUoIGAke3hodG1sRGlyfS8ke2xpY2Vuc2VTY3JpcHRGaWxlbmFtZX1gLCBsaWNlbnNlU2NyaXB0ICk7XHJcbiAgZ3J1bnQuZmlsZS53cml0ZSggYCR7eGh0bWxEaXJ9LyR7aW5pdGlhbGl6YXRpb25TY3JpcHRGaWxlbmFtZX1gLCBpbml0aWFsaXphdGlvblNjcmlwdCApO1xyXG4gIGdydW50LmZpbGUud3JpdGUoIGAke3hodG1sRGlyfS8ke3NjcmlwdEZpbGVuYW1lfWAsIHNjcmlwdCApO1xyXG59OyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBO0FBQ0EsSUFBTUEsTUFBTSxHQUFHQyxPQUFPLENBQUUsUUFBUyxDQUFDO0FBQ2xDLElBQU1DLGdCQUFnQixHQUFHRCxPQUFPLENBQUUsNEJBQTZCLENBQUM7QUFDaEUsSUFBTUUsa0JBQWtCLEdBQUdGLE9BQU8sQ0FBRSw4QkFBK0IsQ0FBQztBQUNwRSxJQUFNRyxpQkFBaUIsR0FBR0gsT0FBTyxDQUFFLHFCQUFzQixDQUFDO0FBQzFELElBQU1JLEtBQUssR0FBR0osT0FBTyxDQUFFLE9BQVEsQ0FBQztBQUNoQyxJQUFNSyxlQUFlLEdBQUdMLE9BQU8sQ0FBRSxtQkFBb0IsQ0FBQyxDQUFDLENBQUM7O0FBRXhEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQU0sTUFBTSxDQUFDQyxPQUFPLEdBQUcsVUFBVUMsUUFBUSxFQUFFQyxNQUFNLEVBQUc7RUFDNUMsSUFBTUMsT0FBTyxHQUFHLElBQUlMLGVBQWUsQ0FBQ00sT0FBTyxDQUFFLFFBQVMsQ0FBQztFQUV2RCxJQUNFQyxJQUFJLEdBT0ZILE1BQU0sQ0FQUkcsSUFBSTtJQUNKQyxLQUFLLEdBTUhKLE1BQU0sQ0FOUkksS0FBSztJQUNMQyxTQUFTLEdBS1BMLE1BQU0sQ0FMUkssU0FBUztJQUNUQyxvQkFBb0IsR0FJbEJOLE1BQU0sQ0FKUk0sb0JBQW9CO0lBQ3BCQyxhQUFhLEdBR1hQLE1BQU0sQ0FIUk8sYUFBYTtJQUNiQyxPQUFPLEdBRUxSLE1BQU0sQ0FGUlEsT0FBTztJQUNQQyxVQUFVLEdBQ1JULE1BQU0sQ0FEUlMsVUFBVTtFQUVabkIsTUFBTSxDQUFFLE9BQU9hLElBQUksS0FBSyxRQUFRLEVBQUUsZUFBZ0IsQ0FBQztFQUNuRGIsTUFBTSxDQUFFZSxTQUFTLEVBQUUsb0JBQXFCLENBQUM7RUFDekNmLE1BQU0sQ0FBRWtCLE9BQU8sRUFBRSxrQkFBbUIsQ0FBQztFQUNyQ2xCLE1BQU0sQ0FBRSxPQUFPbUIsVUFBVSxLQUFLLFFBQVEsRUFBRSxxQkFBc0IsQ0FBQztFQUUvRCxJQUFNQyxjQUFjLEdBQUdMLFNBQVMsQ0FBRWIsZ0JBQWdCLENBQUNtQixlQUFlLENBQUUsQ0FBRWpCLGlCQUFpQixDQUFFUyxJQUFLLENBQUMsQ0FBRTtFQUVqRyxJQUFNUyxxQkFBcUIsTUFBQUMsTUFBQSxDQUFNVixJQUFJLGVBQUFVLE1BQUEsQ0FBWVQsS0FBSyxRQUFLO0VBQzNELElBQU1VLDRCQUE0QixNQUFBRCxNQUFBLENBQU1WLElBQUksc0JBQUFVLE1BQUEsQ0FBbUJULEtBQUssUUFBSztFQUV6RSxJQUFNVyxNQUFNLEdBQUdQLE9BQU8sQ0FBQ1EsSUFBSSxDQUFFLElBQUssQ0FBQztFQUNuQyxJQUFNQyxjQUFjLE1BQUFKLE1BQUEsQ0FBTVYsSUFBSSxPQUFBVSxNQUFBLENBQUlULEtBQUssUUFBSztFQUU1QyxJQUFNYyxLQUFLLEdBQUd6QixrQkFBa0IsQ0FBQzBCLG1CQUFtQixDQUFFeEIsS0FBSyxDQUFDeUIsSUFBSSxDQUFDQyxJQUFJLENBQUUsZ0NBQWlDLENBQUMsRUFBRTtJQUN6R0MsY0FBYyxFQUFFckIsT0FBTyxDQUFDc0IsVUFBVSxDQUFFYixjQUFlLENBQUM7SUFDcERjLGdCQUFnQixFQUFFZixVQUFVO0lBQzVCZ0IsMEJBQTBCLDRDQUFBWixNQUFBLENBQXlDRCxxQkFBcUIsMkVBQUFDLE1BQUEsQ0FBa0VDLDRCQUE0QixtQ0FBNkI7SUFDbk5ZLGdCQUFnQiw0Q0FBQWIsTUFBQSxDQUF5Q0ksY0FBYztFQUN6RSxDQUFFLENBQUM7RUFDSHRCLEtBQUssQ0FBQ3lCLElBQUksQ0FBQ08sS0FBSyxJQUFBZCxNQUFBLENBQUtkLFFBQVEsT0FBQWMsTUFBQSxDQUFJVixJQUFJLFVBQUFVLE1BQUEsQ0FBT1QsS0FBSyxLQUFLLE1BQU0sR0FBRyxFQUFFLE9BQUFTLE1BQUEsQ0FBT1QsS0FBSyxDQUFFLGFBQVVjLEtBQU0sQ0FBQztFQUNoR3ZCLEtBQUssQ0FBQ3lCLElBQUksQ0FBQ08sS0FBSyxJQUFBZCxNQUFBLENBQUtkLFFBQVEsT0FBQWMsTUFBQSxDQUFJRCxxQkFBcUIsR0FBSUwsYUFBYyxDQUFDO0VBQ3pFWixLQUFLLENBQUN5QixJQUFJLENBQUNPLEtBQUssSUFBQWQsTUFBQSxDQUFLZCxRQUFRLE9BQUFjLE1BQUEsQ0FBSUMsNEJBQTRCLEdBQUlSLG9CQUFxQixDQUFDO0VBQ3ZGWCxLQUFLLENBQUN5QixJQUFJLENBQUNPLEtBQUssSUFBQWQsTUFBQSxDQUFLZCxRQUFRLE9BQUFjLE1BQUEsQ0FBSUksY0FBYyxHQUFJRixNQUFPLENBQUM7QUFDN0QsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==