"use strict";

// Copyright 2017-2024, University of Colorado Boulder

/**
 * Determines a list of all dependent repositories (for dependencies.json or other creation)
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

var _ = require('lodash');
var assert = require('assert');
var ChipperConstants = require('../common/ChipperConstants');
var grunt = require('grunt');

/**
 * Returns a list of all dependent repositories.
 * @public
 *
 * @param {string} repo
 * @param {string} [brand] - If not specified, it will return the dependencies for all brands.
 * @returns {Array.<string>}
 */
module.exports = function getPhetLibs(repo, brand) {
  assert(typeof repo === 'string', 'Repository required for getPhetLibs');
  if (brand === undefined) {
    return getPhetLibs(repo, ChipperConstants.BRANDS);
  } else if (Array.isArray(brand)) {
    return _.reduce(brand, function (dependencies, brand) {
      return _.uniq(dependencies.concat(getPhetLibs(repo, brand)).sort());
    }, []);
  } else {
    var packageObject = grunt.file.readJSON("../".concat(repo, "/package.json"));
    var buildObject;
    try {
      buildObject = grunt.file.readJSON('../chipper/build.json');
    } catch (e) {
      buildObject = {};
    }

    // start with package.json
    var phetLibs = packageObject && packageObject.phet && packageObject.phet.phetLibs ? packageObject.phet.phetLibs : [];

    // add the repo that's being built
    phetLibs.push(packageObject.name);

    // add common and brand-specific entries from build.json
    ['common', brand].forEach(function (id) {
      if (buildObject[id] && buildObject[id].phetLibs) {
        phetLibs = phetLibs.concat(buildObject[id].phetLibs);
      }
    });

    // add brand specific dependencies from the package json
    if (packageObject.phet && packageObject.phet[brand] && packageObject.phet[brand].phetLibs) {
      phetLibs = phetLibs.concat(packageObject.phet[brand].phetLibs);
    }

    // wrappers are also marked as phetLibs, so we can get their shas without listing them twice
    if (brand === 'phet-io' && packageObject.phet && packageObject.phet[brand] && packageObject.phet[brand].wrappers) {
      var wrapperRepos = packageObject.phet[brand].wrappers.filter(function (wrapper) {
        return !wrapper.startsWith('phet-io-sim-specific');
      });
      phetLibs = phetLibs.concat(wrapperRepos);
    }

    // sort and remove duplicates
    return _.uniq(phetLibs.sort());
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImFzc2VydCIsIkNoaXBwZXJDb25zdGFudHMiLCJncnVudCIsIm1vZHVsZSIsImV4cG9ydHMiLCJnZXRQaGV0TGlicyIsInJlcG8iLCJicmFuZCIsInVuZGVmaW5lZCIsIkJSQU5EUyIsIkFycmF5IiwiaXNBcnJheSIsInJlZHVjZSIsImRlcGVuZGVuY2llcyIsInVuaXEiLCJjb25jYXQiLCJzb3J0IiwicGFja2FnZU9iamVjdCIsImZpbGUiLCJyZWFkSlNPTiIsImJ1aWxkT2JqZWN0IiwiZSIsInBoZXRMaWJzIiwicGhldCIsInB1c2giLCJuYW1lIiwiZm9yRWFjaCIsImlkIiwid3JhcHBlcnMiLCJ3cmFwcGVyUmVwb3MiLCJmaWx0ZXIiLCJ3cmFwcGVyIiwic3RhcnRzV2l0aCJdLCJzb3VyY2VzIjpbImdldFBoZXRMaWJzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LTIwMjQsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIERldGVybWluZXMgYSBsaXN0IG9mIGFsbCBkZXBlbmRlbnQgcmVwb3NpdG9yaWVzIChmb3IgZGVwZW5kZW5jaWVzLmpzb24gb3Igb3RoZXIgY3JlYXRpb24pXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5cclxuY29uc3QgXyA9IHJlcXVpcmUoICdsb2Rhc2gnICk7XHJcbmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoICdhc3NlcnQnICk7XHJcbmNvbnN0IENoaXBwZXJDb25zdGFudHMgPSByZXF1aXJlKCAnLi4vY29tbW9uL0NoaXBwZXJDb25zdGFudHMnICk7XHJcbmNvbnN0IGdydW50ID0gcmVxdWlyZSggJ2dydW50JyApO1xyXG5cclxuLyoqXHJcbiAqIFJldHVybnMgYSBsaXN0IG9mIGFsbCBkZXBlbmRlbnQgcmVwb3NpdG9yaWVzLlxyXG4gKiBAcHVibGljXHJcbiAqXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSByZXBvXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBbYnJhbmRdIC0gSWYgbm90IHNwZWNpZmllZCwgaXQgd2lsbCByZXR1cm4gdGhlIGRlcGVuZGVuY2llcyBmb3IgYWxsIGJyYW5kcy5cclxuICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fVxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBnZXRQaGV0TGlicyggcmVwbywgYnJhbmQgKSB7XHJcbiAgYXNzZXJ0KCB0eXBlb2YgcmVwbyA9PT0gJ3N0cmluZycsICdSZXBvc2l0b3J5IHJlcXVpcmVkIGZvciBnZXRQaGV0TGlicycgKTtcclxuXHJcbiAgaWYgKCBicmFuZCA9PT0gdW5kZWZpbmVkICkge1xyXG4gICAgcmV0dXJuIGdldFBoZXRMaWJzKCByZXBvLCBDaGlwcGVyQ29uc3RhbnRzLkJSQU5EUyApO1xyXG4gIH1cclxuICBlbHNlIGlmICggQXJyYXkuaXNBcnJheSggYnJhbmQgKSApIHtcclxuICAgIHJldHVybiBfLnJlZHVjZSggYnJhbmQsICggZGVwZW5kZW5jaWVzLCBicmFuZCApID0+IHtcclxuICAgICAgcmV0dXJuIF8udW5pcSggZGVwZW5kZW5jaWVzLmNvbmNhdCggZ2V0UGhldExpYnMoIHJlcG8sIGJyYW5kICkgKS5zb3J0KCkgKTtcclxuICAgIH0sIFtdICk7XHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgY29uc3QgcGFja2FnZU9iamVjdCA9IGdydW50LmZpbGUucmVhZEpTT04oIGAuLi8ke3JlcG99L3BhY2thZ2UuanNvbmAgKTtcclxuICAgIGxldCBidWlsZE9iamVjdDtcclxuICAgIHRyeSB7XHJcbiAgICAgIGJ1aWxkT2JqZWN0ID0gZ3J1bnQuZmlsZS5yZWFkSlNPTiggJy4uL2NoaXBwZXIvYnVpbGQuanNvbicgKTtcclxuICAgIH1cclxuICAgIGNhdGNoKCBlICkge1xyXG4gICAgICBidWlsZE9iamVjdCA9IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHN0YXJ0IHdpdGggcGFja2FnZS5qc29uXHJcbiAgICBsZXQgcGhldExpYnMgPSBwYWNrYWdlT2JqZWN0ICYmXHJcbiAgICAgICAgICAgICAgICAgICBwYWNrYWdlT2JqZWN0LnBoZXQgJiZcclxuICAgICAgICAgICAgICAgICAgIHBhY2thZ2VPYmplY3QucGhldC5waGV0TGlicyA/XHJcbiAgICAgICAgICAgICAgICAgICBwYWNrYWdlT2JqZWN0LnBoZXQucGhldExpYnMgOiBbXTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIHJlcG8gdGhhdCdzIGJlaW5nIGJ1aWx0XHJcbiAgICBwaGV0TGlicy5wdXNoKCBwYWNrYWdlT2JqZWN0Lm5hbWUgKTtcclxuXHJcbiAgICAvLyBhZGQgY29tbW9uIGFuZCBicmFuZC1zcGVjaWZpYyBlbnRyaWVzIGZyb20gYnVpbGQuanNvblxyXG4gICAgWyAnY29tbW9uJywgYnJhbmQgXS5mb3JFYWNoKCBpZCA9PiB7XHJcbiAgICAgIGlmICggYnVpbGRPYmplY3RbIGlkIF0gJiYgYnVpbGRPYmplY3RbIGlkIF0ucGhldExpYnMgKSB7XHJcbiAgICAgICAgcGhldExpYnMgPSBwaGV0TGlicy5jb25jYXQoIGJ1aWxkT2JqZWN0WyBpZCBdLnBoZXRMaWJzICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBhZGQgYnJhbmQgc3BlY2lmaWMgZGVwZW5kZW5jaWVzIGZyb20gdGhlIHBhY2thZ2UganNvblxyXG4gICAgaWYgKCBwYWNrYWdlT2JqZWN0LnBoZXQgJiYgcGFja2FnZU9iamVjdC5waGV0WyBicmFuZCBdICYmIHBhY2thZ2VPYmplY3QucGhldFsgYnJhbmQgXS5waGV0TGlicyApIHtcclxuICAgICAgcGhldExpYnMgPSBwaGV0TGlicy5jb25jYXQoIHBhY2thZ2VPYmplY3QucGhldFsgYnJhbmQgXS5waGV0TGlicyApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHdyYXBwZXJzIGFyZSBhbHNvIG1hcmtlZCBhcyBwaGV0TGlicywgc28gd2UgY2FuIGdldCB0aGVpciBzaGFzIHdpdGhvdXQgbGlzdGluZyB0aGVtIHR3aWNlXHJcbiAgICBpZiAoIGJyYW5kID09PSAncGhldC1pbycgJiYgcGFja2FnZU9iamVjdC5waGV0ICYmIHBhY2thZ2VPYmplY3QucGhldFsgYnJhbmQgXSAmJiBwYWNrYWdlT2JqZWN0LnBoZXRbIGJyYW5kIF0ud3JhcHBlcnMgKSB7XHJcbiAgICAgIGNvbnN0IHdyYXBwZXJSZXBvcyA9ICggcGFja2FnZU9iamVjdC5waGV0WyBicmFuZCBdLndyYXBwZXJzICkuZmlsdGVyKCB3cmFwcGVyID0+ICF3cmFwcGVyLnN0YXJ0c1dpdGgoICdwaGV0LWlvLXNpbS1zcGVjaWZpYycgKSApO1xyXG4gICAgICBwaGV0TGlicyA9IHBoZXRMaWJzLmNvbmNhdCggd3JhcHBlclJlcG9zICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc29ydCBhbmQgcmVtb3ZlIGR1cGxpY2F0ZXNcclxuICAgIHJldHVybiBfLnVuaXEoIHBoZXRMaWJzLnNvcnQoKSApO1xyXG4gIH1cclxufTsiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLElBQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFFLFFBQVMsQ0FBQztBQUM3QixJQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBRSxRQUFTLENBQUM7QUFDbEMsSUFBTUUsZ0JBQWdCLEdBQUdGLE9BQU8sQ0FBRSw0QkFBNkIsQ0FBQztBQUNoRSxJQUFNRyxLQUFLLEdBQUdILE9BQU8sQ0FBRSxPQUFRLENBQUM7O0FBRWhDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQUksTUFBTSxDQUFDQyxPQUFPLEdBQUcsU0FBU0MsV0FBV0EsQ0FBRUMsSUFBSSxFQUFFQyxLQUFLLEVBQUc7RUFDbkRQLE1BQU0sQ0FBRSxPQUFPTSxJQUFJLEtBQUssUUFBUSxFQUFFLHFD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