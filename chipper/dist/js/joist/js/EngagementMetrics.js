// Copyright 2019-2023, University of Colorado Boulder

/**
 * Monitors the engagement as it relates to time spent on each screen of a sim. Mainly this is to provide this information
 * to a PhET-iO wrapper frame.
 *
 * The main output of this file is powered by the data stream. As a result the finest granularity of this data is based on
 * the most frequent events that are emitting. As of this writing, when emitting high frequency events, that is every
 * frame on the "stepSimulation" event. Note that this Type requires high frequency events to be emitted.
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 * @author Chris Klusendorf (PhET Interactive Simulations)
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Property from '../../axon/js/Property.js';
import joist from './joist.js';
import TemporalCounter from './TemporalCounter.js';

/////////////////////////////////
// TODO: Duplication alert! MK doesn't want to import from phet-io into joist, so we will just duplicate the type for now. https://github.com/phetsims/joist/issues/553

////////////////////////////////

class EngagementMetrics {
  screens = []; // {ScreenData[]}

  startTimestamp = null; // number, the timestamp of the start of the sim.

  constructor(sim) {
    const dataStream = phet && phet.phetio && phet.phetio.dataStream;
    assert && assert(dataStream, 'cannot add dataStream listener because dataStream is not defined');
    let currentScreenEntry = this.screens[sim.screens.indexOf(sim.selectedScreenProperty.value)];
    sim.screens.forEach(screen => {
      this.screens.push(new ScreenData(screen.tandem.name));
    });
    const updateCurrentScreenEntry = event => {
      currentScreenEntry = this.screens[sim.screens.indexOf(sim.selectedScreenProperty.value)];

      // initial condition if first time on this screen
      currentScreenEntry.firstTimestamp = currentScreenEntry.firstTimestamp || event.time;
    };

    // phet-io data stream listener for every sim event.
    dataStream.addAllEventListener(event => {
      // initial condition
      if (this.startTimestamp === null) {
        this.startTimestamp = event.time;
        updateCurrentScreenEntry(event);
      }

      // screenIndex changedr
      if (event.phetioID === sim.selectedScreenProperty.tandem.phetioID && event.name === Property.CHANGED_EVENT_NAME) {
        updateCurrentScreenEntry(event);
      }

      // Handle the case if the event signifies engagement with the simulation.
      this.isEngagedEvent(event) && currentScreenEntry.onEngagedEvent(event, this.startTimestamp);
      if (event.phetioID === sim.stepSimulationAction.tandem.phetioID) {
        // TODO: counted even when not in the active browser tab, perhaps we need to use browserTabVisibleProperty, https://github.com/phetsims/joist/issues/553
        // TODO: or just be adding up dt values instead of trying to use event.time, which is just from Date.now(), https://github.com/phetsims/joist/issues/553
        currentScreenEntry.lastTimestamp = event.time;
        currentScreenEntry.totalTime += Math.floor(event.data.dt * 1000);
      }
    });
  }

  /**
   * Returns true if the event signifies that the student is "engaged." The current definition is just pointer down
   * events.
   */
  isEngagedEvent(event) {
    let engaged = false;
    ['mouseDownAction', 'touchDownAction', 'keydownAction', 'penDownAction'].forEach(eventName => {
      if (window.phetio.PhetioIDUtils.getComponentName(event.phetioID) === eventName) {
        engaged = true;
      }
    });
    return engaged;
  }

  /**
   * get the current engagement data of the simulation.
   */
  getEngagementMetrics() {
    const screens = this.screens;
    return {
      sim: {
        // the timestamp of the first received model step
        startTimestamp: this.startTimestamp,
        // number of seconds since startTimestamp
        elapsedTime: _.sum(screens.map(screen => screen.totalTime)),
        // number of seconds in which "engagement" occurred
        engagedTime: _.sum(screens.map(screen => screen.engagedTime)),
        // the timestamp of the first time the sim is engaged with
        firstEngagementTimestamp: _.min(screens.map(screen => screen.firstTimestamp)),
        // current time of the sim
        currentTimestamp: _.max(screens.map(screen => screen.lastTimestamp))
      },
      screens: screens.map(screen => screen.getData())
    };
  }
}

// private class to keep track of data for each screen.
class ScreenData {
  firstTimestamp = null;
  lastTimestamp = null;
  totalTime = 0;
  firstEngagedTimestamp = null;
  temporalCounter = new TemporalCounter(1000);
  constructor(name) {
    this.name = name;
  }

  /**
   * Getter to keep things a bit more modular
   * @returns - the ms of engagement for the sim
   */
  get engagedTime() {
    return this.temporalCounter.counts * 1000;
  }
  onEngagedEvent(event, simStartTimestamp) {
    this.temporalCounter.onEvent(event.time - simStartTimestamp);

    // case for first engaged event
    this.firstTimestamp = this.firstTimestamp || event.time;
  }

  /**
   * Public facing info, mainer getter for this POJSO.
   */
  getData() {
    return {
      name: this.name,
      totalTime: this.totalTime,
      engagedTime: this.engagedTime,
      firstTimestamp: this.firstTimestamp,
      lastTimestamp: this.lastTimestamp
    };
  }
}
joist.register('EngagementMetrics', EngagementMetrics);
export default EngagementMetrics;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsImpvaXN0IiwiVGVtcG9yYWxDb3VudGVyIiwiRW5nYWdlbWVudE1ldHJpY3MiLCJzY3JlZW5zIiwic3RhcnRUaW1lc3RhbXAiLCJjb25zdHJ1Y3RvciIsInNpbSIsImRhdGFTdHJlYW0iLCJwaGV0IiwicGhldGlvIiwiYXNzZXJ0IiwiY3VycmVudFNjcmVlbkVudHJ5IiwiaW5kZXhPZiIsInNlbGVjdGVkU2NyZWVuUHJvcGVydHkiLCJ2YWx1ZSIsImZvckVhY2giLCJzY3JlZW4iLCJwdXNoIiwiU2NyZWVuRGF0YSIsInRhbmRlbSIsIm5hbWUiLCJ1cGRhdGVDdXJyZW50U2NyZWVuRW50cnkiLCJldmVudCIsImZpcnN0VGltZXN0YW1wIiwidGltZSIsImFkZEFsbEV2ZW50TGlzdGVuZXIiLCJwaGV0aW9JRCIsIkNIQU5HRURfRVZFTlRfTkFNRSIsImlzRW5nYWdlZEV2ZW50Iiwib25FbmdhZ2VkRXZlbnQiLCJzdGVwU2ltdWxhdGlvbkFjdGlvbiIsImxhc3RUaW1lc3RhbXAiLCJ0b3RhbFRpbWUiLCJNYXRoIiwiZmxvb3IiLCJkYXRhIiwiZHQiLCJlbmdhZ2VkIiwiZXZlbnROYW1lIiwid2luZG93IiwiUGhldGlvSURVdGlscyIsImdldENvbXBvbmVudE5hbWUiLCJnZXRFbmdhZ2VtZW50TWV0cmljcyIsImVsYXBzZWRUaW1lIiwiXyIsInN1bSIsIm1hcCIsImVuZ2FnZWRUaW1lIiwiZmlyc3RFbmdhZ2VtZW50VGltZXN0YW1wIiwibWluIiwiY3VycmVudFRpbWVzdGFtcCIsIm1heCIsImdldERhdGEiLCJmaXJzdEVuZ2FnZWRUaW1lc3RhbXAiLCJ0ZW1wb3JhbENvdW50ZXIiLCJjb3VudHMiLCJzaW1TdGFydFRpbWVzdGFtcCIsIm9uRXZlbnQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVuZ2FnZW1lbnRNZXRyaWNzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE5LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE1vbml0b3JzIHRoZSBlbmdhZ2VtZW50IGFzIGl0IHJlbGF0ZXMgdG8gdGltZSBzcGVudCBvbiBlYWNoIHNjcmVlbiBvZiBhIHNpbS4gTWFpbmx5IHRoaXMgaXMgdG8gcHJvdmlkZSB0aGlzIGluZm9ybWF0aW9uXHJcbiAqIHRvIGEgUGhFVC1pTyB3cmFwcGVyIGZyYW1lLlxyXG4gKlxyXG4gKiBUaGUgbWFpbiBvdXRwdXQgb2YgdGhpcyBmaWxlIGlzIHBvd2VyZWQgYnkgdGhlIGRhdGEgc3RyZWFtLiBBcyBhIHJlc3VsdCB0aGUgZmluZXN0IGdyYW51bGFyaXR5IG9mIHRoaXMgZGF0YSBpcyBiYXNlZCBvblxyXG4gKiB0aGUgbW9zdCBmcmVxdWVudCBldmVudHMgdGhhdCBhcmUgZW1pdHRpbmcuIEFzIG9mIHRoaXMgd3JpdGluZywgd2hlbiBlbWl0dGluZyBoaWdoIGZyZXF1ZW5jeSBldmVudHMsIHRoYXQgaXMgZXZlcnlcclxuICogZnJhbWUgb24gdGhlIFwic3RlcFNpbXVsYXRpb25cIiBldmVudC4gTm90ZSB0aGF0IHRoaXMgVHlwZSByZXF1aXJlcyBoaWdoIGZyZXF1ZW5jeSBldmVudHMgdG8gYmUgZW1pdHRlZC5cclxuICpcclxuICogQGF1dGhvciBNaWNoYWVsIEthdXptYW5uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIENocmlzIEtsdXNlbmRvcmYgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgSW50ZW50aW9uYWxBbnkgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL0ludGVudGlvbmFsQW55LmpzJztcclxuaW1wb3J0IGpvaXN0IGZyb20gJy4vam9pc3QuanMnO1xyXG5pbXBvcnQgU2ltIGZyb20gJy4vU2ltLmpzJztcclxuaW1wb3J0IFRlbXBvcmFsQ291bnRlciBmcm9tICcuL1RlbXBvcmFsQ291bnRlci5qcyc7XHJcbmltcG9ydCB7IFBoZXRpb0lEIH0gZnJvbSAnLi4vLi4vdGFuZGVtL2pzL1RhbmRlbUNvbnN0YW50cy5qcyc7XHJcblxyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cclxuLy8gVE9ETzogRHVwbGljYXRpb24gYWxlcnQhIE1LIGRvZXNuJ3Qgd2FudCB0byBpbXBvcnQgZnJvbSBwaGV0LWlvIGludG8gam9pc3QsIHNvIHdlIHdpbGwganVzdCBkdXBsaWNhdGUgdGhlIHR5cGUgZm9yIG5vdy4gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy81NTNcclxudHlwZSBQaGV0aW9FdmVudERhdGEgPSBSZWNvcmQ8c3RyaW5nLCBJbnRlbnRpb25hbEFueT47XHJcbnR5cGUgUGhldGlvRXZlbnQgPSB7XHJcbiAgaW5kZXg6IG51bWJlcjtcclxuICB0aW1lOiBudW1iZXI7XHJcbiAgdHlwZTogc3RyaW5nO1xyXG4gIHBoZXRpb0lEOiBQaGV0aW9JRDtcclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgY29tcG9uZW50VHlwZTogc3RyaW5nO1xyXG4gIGNoaWxkcmVuPzogUGhldGlvRXZlbnRbXTtcclxuICBkYXRhPzogUGhldGlvRXZlbnREYXRhO1xyXG4gIG1ldGFkYXRhPzogUGhldGlvRXZlbnREYXRhO1xyXG59O1xyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xyXG5cclxudHlwZSBTY3JlZW5EYXRhVHlwZSA9IHtcclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgdG90YWxUaW1lOiBudW1iZXI7XHJcbiAgZW5nYWdlZFRpbWU6IG51bWJlcjtcclxuICBmaXJzdFRpbWVzdGFtcDogbnVtYmVyO1xyXG4gIGxhc3RUaW1lc3RhbXA6IG51bWJlcjtcclxufTtcclxudHlwZSBFbmdhZ2VtZW50TWV0cmljc0RhdGEgPSB7XHJcbiAgc2ltOiB7XHJcblxyXG4gICAgLy8gdGhlIHRpbWVzdGFtcCBvZiB0aGUgZmlyc3QgcmVjZWl2ZWQgbW9kZWwgc3RlcFxyXG4gICAgc3RhcnRUaW1lc3RhbXA6IG51bWJlcjtcclxuXHJcbiAgICAvLyBudW1iZXIgb2Ygc2Vjb25kcyBzaW5jZSBzdGFydFRpbWVzdGFtcFxyXG4gICAgZWxhcHNlZFRpbWU6IG51bWJlcjtcclxuXHJcbiAgICAvLyBudW1iZXIgb2Ygc2Vjb25kcyBpbiB3aGljaCBcImVuZ2FnZW1lbnRcIiBvY2N1cnJlZFxyXG4gICAgZW5nYWdlZFRpbWU6IG51bWJlcjtcclxuXHJcbiAgICAvLyB0aGUgdGltZXN0YW1wIG9mIHRoZSBmaXJzdCB0aW1lIHRoZSBzaW0gaXMgZW5nYWdlZCB3aXRoXHJcbiAgICBmaXJzdEVuZ2FnZW1lbnRUaW1lc3RhbXA6IG51bWJlcjtcclxuXHJcbiAgICAvLyBjdXJyZW50IHRpbWUgb2YgdGhlIHNpbVxyXG4gICAgY3VycmVudFRpbWVzdGFtcDogbnVtYmVyO1xyXG4gIH07XHJcbiAgc2NyZWVuczogU2NyZWVuRGF0YVR5cGVbXTtcclxufTtcclxuXHJcblxyXG5jbGFzcyBFbmdhZ2VtZW50TWV0cmljcyB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgc2NyZWVuczogU2NyZWVuRGF0YVtdID0gW107IC8vIHtTY3JlZW5EYXRhW119XHJcblxyXG4gIHByaXZhdGUgc3RhcnRUaW1lc3RhbXA6IG51bWJlciB8IG51bGwgPSBudWxsOyAvLyBudW1iZXIsIHRoZSB0aW1lc3RhbXAgb2YgdGhlIHN0YXJ0IG9mIHRoZSBzaW0uXHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvciggc2ltOiBTaW0gKSB7XHJcbiAgICBjb25zdCBkYXRhU3RyZWFtID0gcGhldCAmJiBwaGV0LnBoZXRpbyAmJiBwaGV0LnBoZXRpby5kYXRhU3RyZWFtO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZGF0YVN0cmVhbSwgJ2Nhbm5vdCBhZGQgZGF0YVN0cmVhbSBsaXN0ZW5lciBiZWNhdXNlIGRhdGFTdHJlYW0gaXMgbm90IGRlZmluZWQnICk7XHJcblxyXG4gICAgbGV0IGN1cnJlbnRTY3JlZW5FbnRyeSA9IHRoaXMuc2NyZWVuc1sgc2ltLnNjcmVlbnMuaW5kZXhPZiggc2ltLnNlbGVjdGVkU2NyZWVuUHJvcGVydHkudmFsdWUgKSBdO1xyXG5cclxuICAgIHNpbS5zY3JlZW5zLmZvckVhY2goIHNjcmVlbiA9PiB7XHJcbiAgICAgIHRoaXMuc2NyZWVucy5wdXNoKCBuZXcgU2NyZWVuRGF0YSggc2NyZWVuLnRhbmRlbS5uYW1lICkgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCB1cGRhdGVDdXJyZW50U2NyZWVuRW50cnkgPSAoIGV2ZW50OiBQaGV0aW9FdmVudCApID0+IHtcclxuICAgICAgY3VycmVudFNjcmVlbkVudHJ5ID0gdGhpcy5zY3JlZW5zWyBzaW0uc2NyZWVucy5pbmRleE9mKCBzaW0uc2VsZWN0ZWRTY3JlZW5Qcm9wZXJ0eS52YWx1ZSApIF07XHJcblxyXG4gICAgICAvLyBpbml0aWFsIGNvbmRpdGlvbiBpZiBmaXJzdCB0aW1lIG9uIHRoaXMgc2NyZWVuXHJcbiAgICAgIGN1cnJlbnRTY3JlZW5FbnRyeS5maXJzdFRpbWVzdGFtcCA9IGN1cnJlbnRTY3JlZW5FbnRyeS5maXJzdFRpbWVzdGFtcCEgfHwgZXZlbnQudGltZTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gcGhldC1pbyBkYXRhIHN0cmVhbSBsaXN0ZW5lciBmb3IgZXZlcnkgc2ltIGV2ZW50LlxyXG4gICAgZGF0YVN0cmVhbS5hZGRBbGxFdmVudExpc3RlbmVyKCAoIGV2ZW50OiBQaGV0aW9FdmVudCApID0+IHtcclxuXHJcbiAgICAgIC8vIGluaXRpYWwgY29uZGl0aW9uXHJcbiAgICAgIGlmICggdGhpcy5zdGFydFRpbWVzdGFtcCA9PT0gbnVsbCApIHtcclxuICAgICAgICB0aGlzLnN0YXJ0VGltZXN0YW1wID0gZXZlbnQudGltZTtcclxuICAgICAgICB1cGRhdGVDdXJyZW50U2NyZWVuRW50cnkoIGV2ZW50ICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIHNjcmVlbkluZGV4IGNoYW5nZWRyXHJcbiAgICAgIGlmICggZXZlbnQucGhldGlvSUQgPT09IHNpbS5zZWxlY3RlZFNjcmVlblByb3BlcnR5LnRhbmRlbS5waGV0aW9JRCAmJlxyXG4gICAgICAgICAgIGV2ZW50Lm5hbWUgPT09IFByb3BlcnR5LkNIQU5HRURfRVZFTlRfTkFNRSApIHtcclxuICAgICAgICB1cGRhdGVDdXJyZW50U2NyZWVuRW50cnkoIGV2ZW50ICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIEhhbmRsZSB0aGUgY2FzZSBpZiB0aGUgZXZlbnQgc2lnbmlmaWVzIGVuZ2FnZW1lbnQgd2l0aCB0aGUgc2ltdWxhdGlvbi5cclxuICAgICAgdGhpcy5pc0VuZ2FnZWRFdmVudCggZXZlbnQgKSAmJiBjdXJyZW50U2NyZWVuRW50cnkub25FbmdhZ2VkRXZlbnQoIGV2ZW50LCB0aGlzLnN0YXJ0VGltZXN0YW1wICk7XHJcblxyXG4gICAgICBpZiAoIGV2ZW50LnBoZXRpb0lEID09PSBzaW0uc3RlcFNpbXVsYXRpb25BY3Rpb24udGFuZGVtLnBoZXRpb0lEICkge1xyXG5cclxuICAgICAgICAvLyBUT0RPOiBjb3VudGVkIGV2ZW4gd2hlbiBub3QgaW4gdGhlIGFjdGl2ZSBicm93c2VyIHRhYiwgcGVyaGFwcyB3ZSBuZWVkIHRvIHVzZSBicm93c2VyVGFiVmlzaWJsZVByb3BlcnR5LCBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvam9pc3QvaXNzdWVzLzU1M1xyXG4gICAgICAgIC8vIFRPRE86IG9yIGp1c3QgYmUgYWRkaW5nIHVwIGR0IHZhbHVlcyBpbnN0ZWFkIG9mIHRyeWluZyB0byB1c2UgZXZlbnQudGltZSwgd2hpY2ggaXMganVzdCBmcm9tIERhdGUubm93KCksIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9qb2lzdC9pc3N1ZXMvNTUzXHJcbiAgICAgICAgY3VycmVudFNjcmVlbkVudHJ5Lmxhc3RUaW1lc3RhbXAgPSBldmVudC50aW1lO1xyXG4gICAgICAgIGN1cnJlbnRTY3JlZW5FbnRyeS50b3RhbFRpbWUgKz0gTWF0aC5mbG9vciggZXZlbnQuZGF0YSEuZHQgKiAxMDAwICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgZXZlbnQgc2lnbmlmaWVzIHRoYXQgdGhlIHN0dWRlbnQgaXMgXCJlbmdhZ2VkLlwiIFRoZSBjdXJyZW50IGRlZmluaXRpb24gaXMganVzdCBwb2ludGVyIGRvd25cclxuICAgKiBldmVudHMuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0VuZ2FnZWRFdmVudCggZXZlbnQ6IFBoZXRpb0V2ZW50ICk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IGVuZ2FnZWQgPSBmYWxzZTtcclxuICAgIFsgJ21vdXNlRG93bkFjdGlvbicsICd0b3VjaERvd25BY3Rpb24nLCAna2V5ZG93bkFjdGlvbicsICdwZW5Eb3duQWN0aW9uJyBdLmZvckVhY2goIGV2ZW50TmFtZSA9PiB7XHJcbiAgICAgIGlmICggd2luZG93LnBoZXRpby5QaGV0aW9JRFV0aWxzLmdldENvbXBvbmVudE5hbWUoIGV2ZW50LnBoZXRpb0lEICkgPT09IGV2ZW50TmFtZSApIHtcclxuICAgICAgICBlbmdhZ2VkID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gICAgcmV0dXJuIGVuZ2FnZWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBnZXQgdGhlIGN1cnJlbnQgZW5nYWdlbWVudCBkYXRhIG9mIHRoZSBzaW11bGF0aW9uLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRFbmdhZ2VtZW50TWV0cmljcygpOiBFbmdhZ2VtZW50TWV0cmljc0RhdGEge1xyXG4gICAgY29uc3Qgc2NyZWVucyA9IHRoaXMuc2NyZWVucztcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHNpbToge1xyXG5cclxuICAgICAgICAvLyB0aGUgdGltZXN0YW1wIG9mIHRoZSBmaXJzdCByZWNlaXZlZCBtb2RlbCBzdGVwXHJcbiAgICAgICAgc3RhcnRUaW1lc3RhbXA6IHRoaXMuc3RhcnRUaW1lc3RhbXAhLFxyXG5cclxuICAgICAgICAvLyBudW1iZXIgb2Ygc2Vjb25kcyBzaW5jZSBzdGFydFRpbWVzdGFtcFxyXG4gICAgICAgIGVsYXBzZWRUaW1lOiBfLnN1bSggc2NyZWVucy5tYXAoIHNjcmVlbiA9PiBzY3JlZW4udG90YWxUaW1lICkgKSxcclxuXHJcbiAgICAgICAgLy8gbnVtYmVyIG9mIHNlY29uZHMgaW4gd2hpY2ggXCJlbmdhZ2VtZW50XCIgb2NjdXJyZWRcclxuICAgICAgICBlbmdhZ2VkVGltZTogXy5zdW0oIHNjcmVlbnMubWFwKCBzY3JlZW4gPT4gc2NyZWVuLmVuZ2FnZWRUaW1lICkgKSxcclxuXHJcbiAgICAgICAgLy8gdGhlIHRpbWVzdGFtcCBvZiB0aGUgZmlyc3QgdGltZSB0aGUgc2ltIGlzIGVuZ2FnZWQgd2l0aFxyXG4gICAgICAgIGZpcnN0RW5nYWdlbWVudFRpbWVzdGFtcDogXy5taW4oIHNjcmVlbnMubWFwKCBzY3JlZW4gPT4gc2NyZWVuLmZpcnN0VGltZXN0YW1wICkgKSEsXHJcblxyXG4gICAgICAgIC8vIGN1cnJlbnQgdGltZSBvZiB0aGUgc2ltXHJcbiAgICAgICAgY3VycmVudFRpbWVzdGFtcDogXy5tYXgoIHNjcmVlbnMubWFwKCBzY3JlZW4gPT4gc2NyZWVuLmxhc3RUaW1lc3RhbXAgKSApIVxyXG4gICAgICB9LFxyXG4gICAgICBzY3JlZW5zOiBzY3JlZW5zLm1hcCggc2NyZWVuID0+IHNjcmVlbi5nZXREYXRhKCkgKVxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuXHJcbi8vIHByaXZhdGUgY2xhc3MgdG8ga2VlcCB0cmFjayBvZiBkYXRhIGZvciBlYWNoIHNjcmVlbi5cclxuY2xhc3MgU2NyZWVuRGF0YSB7XHJcblxyXG4gIHB1YmxpYyBuYW1lOiBzdHJpbmc7XHJcbiAgcHVibGljIGZpcnN0VGltZXN0YW1wOiBudW1iZXIgfCBudWxsID0gbnVsbDtcclxuICBwdWJsaWMgbGFzdFRpbWVzdGFtcDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XHJcbiAgcHVibGljIHRvdGFsVGltZSA9IDA7XHJcbiAgcHVibGljIGZpcnN0RW5nYWdlZFRpbWVzdGFtcCA9IG51bGw7XHJcbiAgcHVibGljIHJlYWRvbmx5IHRlbXBvcmFsQ291bnRlciA9IG5ldyBUZW1wb3JhbENvdW50ZXIoIDEwMDAgKTtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBuYW1lOiBzdHJpbmcgKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0dGVyIHRvIGtlZXAgdGhpbmdzIGEgYml0IG1vcmUgbW9kdWxhclxyXG4gICAqIEByZXR1cm5zIC0gdGhlIG1zIG9mIGVuZ2FnZW1lbnQgZm9yIHRoZSBzaW1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGVuZ2FnZWRUaW1lKCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy50ZW1wb3JhbENvdW50ZXIuY291bnRzICogMTAwMDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvbkVuZ2FnZWRFdmVudCggZXZlbnQ6IFBoZXRpb0V2ZW50LCBzaW1TdGFydFRpbWVzdGFtcDogbnVtYmVyICk6IHZvaWQge1xyXG5cclxuICAgIHRoaXMudGVtcG9yYWxDb3VudGVyLm9uRXZlbnQoIGV2ZW50LnRpbWUgLSBzaW1TdGFydFRpbWVzdGFtcCApO1xyXG5cclxuICAgIC8vIGNhc2UgZm9yIGZpcnN0IGVuZ2FnZWQgZXZlbnRcclxuICAgIHRoaXMuZmlyc3RUaW1lc3RhbXAgPSB0aGlzLmZpcnN0VGltZXN0YW1wISB8fCBldmVudC50aW1lO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUHVibGljIGZhY2luZyBpbmZvLCBtYWluZXIgZ2V0dGVyIGZvciB0aGlzIFBPSlNPLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXREYXRhKCk6IFNjcmVlbkRhdGFUeXBlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IHRoaXMubmFtZSxcclxuICAgICAgdG90YWxUaW1lOiB0aGlzLnRvdGFsVGltZSxcclxuICAgICAgZW5nYWdlZFRpbWU6IHRoaXMuZW5nYWdlZFRpbWUsXHJcbiAgICAgIGZpcnN0VGltZXN0YW1wOiB0aGlzLmZpcnN0VGltZXN0YW1wISxcclxuICAgICAgbGFzdFRpbWVzdGFtcDogdGhpcy5sYXN0VGltZXN0YW1wIVxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuXHJcbmpvaXN0LnJlZ2lzdGVyKCAnRW5nYWdlbWVudE1ldHJpY3MnLCBFbmdhZ2VtZW50TWV0cmljcyApO1xyXG5leHBvcnQgZGVmYXVsdCBFbmdhZ2VtZW50TWV0cmljczsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxRQUFRLE1BQU0sMkJBQTJCO0FBRWhELE9BQU9DLEtBQUssTUFBTSxZQUFZO0FBRTlCLE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7O0FBR2xEO0FBQ0E7O0FBYUE7O0FBK0JBLE1BQU1DLGlCQUFpQixDQUFDO0VBRUxDLE9BQU8sR0FBaUIsRUFBRSxDQUFDLENBQUM7O0VBRXJDQyxjQUFjLEdBQWtCLElBQUksQ0FBQyxDQUFDOztFQUV2Q0MsV0FBV0EsQ0FBRUMsR0FBUSxFQUFHO0lBQzdCLE1BQU1DLFVBQVUsR0FBR0MsSUFBSSxJQUFJQSxJQUFJLENBQUNDLE1BQU0sSUFBSUQsSUFBSSxDQUFDQyxNQUFNLENBQUNGLFVBQVU7SUFDaEVHLE1BQU0sSUFBSUEsTUFBTSxDQUFFSCxVQUFVLEVBQUUsa0VBQW1FLENBQUM7SUFFbEcsSUFBSUksa0JBQWtCLEdBQUcsSUFBSSxDQUFDUixPQUFPLENBQUVHLEdBQUcsQ0FBQ0gsT0FBTyxDQUFDUyxPQUFPLENBQUVOLEdBQUcsQ0FBQ08sc0JBQXNCLENBQUNDLEtB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QUUsQ0FBQztRQUVqRTtRQUNBQyx3QkFBd0IsRUFBRUosQ0FBQyxDQUFDSyxHQUFHLENBQUU5QyxPQUFPLENBQUMyQyxHQUFHLENBQUU5QixNQUFNLElBQUlBLE1BQU0sQ0FBQ08sY0FBZSxDQUFFLENBQUU7UUFFbEY7UUFDQTJCLGdCQUFnQixFQUFFTixDQUFDLENBQUNPLEdBQUcsQ0FBRWhELE9BQU8sQ0FBQzJDLEdBQUcsQ0FBRTlCLE1BQU0sSUFBSUEsTUFBTSxDQUFDZSxhQUFjLENBQUU7TUFDekUsQ0FBQztNQUNENUIsT0FBTyxFQUFFQSxPQUFPLENBQUMyQyxHQUFHLENBQUU5QixNQUFNLElBQUlBLE1BQU0sQ0FBQ29DLE9BQU8sQ0FBQyxDQUFFO0lBQ25ELENBQUM7RUFDSDtBQUNGOztBQUVBO0FBQ0EsTUFBTWxDLFVBQVUsQ0FBQztFQUdSSyxjQUFjLEdBQWtCLElBQUk7RUFDcENRLGFBQWEsR0FBa0IsSUFBSTtFQUNuQ0MsU0FBUyxHQUFHLENBQUM7RUFDYnFCLHFCQUFxQixHQUFHLElBQUk7RUFDbkJDLGVBQWUsR0FBRyxJQUFJckQsZUFBZSxDQUFFLElBQUssQ0FBQztFQUV0REksV0FBV0EsQ0FBRWUsSUFBWSxFQUFHO0lBQ2pDLElBQUksQ0FBQ0EsSUFBSSxHQUFHQSxJQUFJO0VBQ2xCOztFQUVBO0FBQ0Y7QUFDQTtBQUNBO0VBQ0UsSUFBVzJCLFdBQVdBLENBQUEsRUFBVztJQUMvQixPQUFPLElBQUksQ0FBQ08sZUFBZSxDQUFDQyxNQUFNLEdBQUcsSUFBSTtFQUMzQztFQUVPMUIsY0FBY0EsQ0FBRVAsS0FBa0IsRUFBRWtDLGlCQUF5QixFQUFTO0lBRTNFLElBQUksQ0FBQ0YsZUFBZSxDQUFDRyxPQUFPLENBQUVuQyxLQUFLLENBQUNFLElBQUksR0FBR2dDLGlCQUFrQixDQUFDOztJQUU5RDtJQUNBLElBQUksQ0FBQ2pDLGNBQWMsR0FBRyxJQUFJLENBQUNBLGNBQWMsSUFBS0QsS0FBSyxDQUFDRSxJQUFJO0VBQzFEOztFQUVBO0FBQ0Y7QUFDQTtFQUNTNEIsT0FBT0EsQ0FBQSxFQUFtQjtJQUMvQixPQUFPO01BQ0xoQyxJQUFJLEVBQUUsSUFBSSxDQUFDQSxJQUFJO01BQ2ZZLFNBQVMsRUFBRSxJQUFJLENBQUNBLFNBQVM7TUFDekJlLFdBQVcsRUFBRSxJQUFJLENBQUNBLFdBQVc7TUFDN0J4QixjQUFjLEVBQUUsSUFBSSxDQUFDQSxjQUFlO01BQ3BDUSxhQUFhLEVBQUUsSUFBSSxDQUFDQTtJQUN0QixDQUFDO0VBQ0g7QUFDRjtBQUVBL0IsS0FBSyxDQUFDMEQsUUFBUSxDQUFFLG1CQUFtQixFQUFFeEQsaUJBQWtCLENBQUM7QUFDeEQsZUFBZUEsaUJBQWlCIiwiaWdub3JlTGlzdCI6W119