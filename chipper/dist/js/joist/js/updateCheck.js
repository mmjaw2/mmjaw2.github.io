// Copyright 2015-2024, University of Colorado Boulder

/**
 * A singleton type/object for handling checking whether our simulation is up-to-date, or whether there is an
 * updated version. See https://github.com/phetsims/joist/issues/189
 *
 * It exposes its current state (for UIs to hook into), and a check() function used to start checking the version.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import EnumerationProperty from '../../axon/js/EnumerationProperty.js';
import joist from './joist.js';
import packageJSON from './packageJSON.js'; // parse name/version out of the package.json
import UpdateState from './UpdateState.js';
const SimVersion = phet.preloads.chipper.SimVersion; // use preload from chipper (auto-copied from perennial)

// constants
const simName = packageJSON.name;
const simVersion = SimVersion.parse(packageJSON.version, phet.chipper.buildTimestamp);
const requestProtocolString = document.location.protocol === 'https:' ? 'https:' : 'http:';
const TIMEOUT_MILLISECONDS = 15000; // How many ms before we time out (set to 'offline')

class UpdateCheck {
  // {SimVersion|null} will be filled in by check() if applicable
  // (joist-internal) {SimVersion} version of the sim that is running

  // Whether we actually allow checking for updates, or showing any update-related UIs.
  // The URL to be used for "New version available" clicks
  // Valid only if `state === UpdateState.CHECKING`, the timeout ID of our timeout listener

  constructor() {
    this.stateProperty = new EnumerationProperty(UpdateState.UNCHECKED);
    this.latestVersion = null;
    this.ourVersion = simVersion;
    this.timeoutCallback = this.timeout.bind(this);

    // If it's not PhET-branded OR if it is phet-io or in the phet-app, do not check for updates
    this.areUpdatesChecked = phet.chipper.brand === 'phet' && !phet.chipper.isApp && phet.chipper.queryParameters.yotta;
    this.updateURL = `${'http://phet.colorado.edu/html-sim-update' + '?simulation='}${encodeURIComponent(simName)}&version=${encodeURIComponent(simVersion.toString())}&buildTimestamp=${encodeURIComponent(`${phet.chipper.buildTimestamp}`)}`;
    this.timeoutId = -1;
  }

  // Clears our timeout listener.
  clearTimeout() {
    window.clearTimeout(this.timeoutId);
  }

  //Sets our timeout listener.
  setTimeout() {
    // eslint-disable-line bad-sim-text
    this.timeoutId = window.setTimeout(this.timeoutCallback, TIMEOUT_MILLISECONDS); // eslint-disable-line bad-sim-text
  }

  // If we are checking, it resets our timeout timer to TIMEOUT_MILLISECONDS
  resetTimeout() {
    if (this.stateProperty.value === UpdateState.CHECKING) {
      this.clearTimeout();
      this.setTimeout();
    }
  }

  // What happens when we actually time out.
  timeout() {
    this.stateProperty.value = UpdateState.OFFLINE;
  }

  /**
   * Kicks off the version checking request (if able), resulting in state changes.
   */
  check() {
    if (!this.areUpdatesChecked || this.stateProperty.value !== UpdateState.UNCHECKED && this.stateProperty.value !== UpdateState.OFFLINE) {
      return;
    }

    // If our sim's version indicates it hasn't been published, don't attempt to send a request for now
    if (this.ourVersion.isSimNotPublished) {
      this.stateProperty.value = UpdateState.UP_TO_DATE;
      return;
    }
    const req = new XMLHttpRequest();
    if ('withCredentials' in req) {
      // we'll be able to send the proper type of request, so we mark ourself as checking
      this.stateProperty.value = UpdateState.CHECKING;
      this.setTimeout();
      req.onload = () => {
        this.clearTimeout();
        try {
          const data = JSON.parse(req.responseText);
          if (data.error) {
            console.log(`Update check failure: ${data.error}`);
            this.stateProperty.value = UpdateState.OFFLINE;
          } else {
            if (this.updateURL) {
              this.updateURL = data.updateURL;
            }
            this.latestVersion = SimVersion.parse(data.latestVersion, data.buildTimestamp);

            // these `state` strings come from the website service, and should be kept in sync with
            // website\src\java\edu\colorado\phet\website\services\CheckHTMLUpdates.java
            if (data.state === 'out-of-date') {
              this.stateProperty.value = UpdateState.OUT_OF_DATE;
            } else if (data.state === 'up-to-date') {
              this.stateProperty.value = UpdateState.UP_TO_DATE;
            } else {
              console.log(`Failed to get proper state: ${data.state}`);
              this.stateProperty.value = UpdateState.OFFLINE;
            }
          }
        } catch (e) {
          this.stateProperty.value = UpdateState.OFFLINE;
        }
      };
      req.onerror = () => {
        this.clearTimeout();
        this.stateProperty.value = UpdateState.OFFLINE;
      };
      req.open('post', `${requestProtocolString}//phet.colorado.edu/services/check-html-updates`, true); // enable CORS
      req.send(JSON.stringify({
        api: '1.0',
        simulation: simName,
        locale: phet.joist.sim.locale,
        currentVersion: this.ourVersion.toString(),
        buildTimestamp: phet.chipper.buildTimestamp
      }));
    }
  }
}
const updateCheck = new UpdateCheck();
joist.register('updateCheck', updateCheck);
export default updateCheck;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFbnVtZXJhdGlvblByb3BlcnR5Iiwiam9pc3QiLCJwYWNrYWdlSlNPTiIsIlVwZGF0ZVN0YXRlIiwiU2ltVmVyc2lvbiIsInBoZXQiLCJwcmVsb2FkcyIsImNoaXBwZXIiLCJzaW1OYW1lIiwibmFtZSIsInNpbVZlcnNpb24iLCJwYXJzZSIsInZlcnNpb24iLCJidWlsZFRpbWVzdGFtcCIsInJlcXVlc3RQcm90b2NvbFN0cmluZyIsImRvY3VtZW50IiwibG9jYXRpb24iLCJwcm90b2NvbCIsIlRJTUVPVVRfTUlMTElTRUNPTkRTIiwiVXBkYXRlQ2hlY2siLCJjb25zdHJ1Y3RvciIsInN0YXRlUHJvcGVydHkiLCJVTkNIRUNLRUQiLCJsYXRlc3RWZXJzaW9uIiwib3VyVmVyc2lvbiIsInRpbWVvdXRDYWxsYmFjayIsInRpbWVvdXQiLCJiaW5kIiwiYXJlVXBkYXRlc0NoZWNrZWQiLCJicmFuZCIsImlzQXBwIiwicXVlcnlQYXJhbWV0ZXJzIiwieW90dGEiLCJ1cGRhdGVVUkwiLCJlbmNvZGVVUklDb21wb25lbnQiLCJ0b1N0cmluZyIsInRpbWVvdXRJZCIsImNsZWFyVGltZW91dCIsIndpbmRvdyIsInNldFRpbWVvdXQiLCJyZXNldFRpbWVvdXQiLCJ2YWx1ZSIsIkNIRUNLSU5HIiwiT0ZGTElORSIsImNoZWNrIiwiaXNTaW1Ob3RQdWJsaXNoZWQiLCJVUF9UT19EQVRFIiwicmVxIiwiWE1MSHR0cFJlcXVlc3QiLCJvbmxvYWQiLCJkYXRhIiwiSlNPTiIsInJlc3BvbnNlVGV4dCIsImVycm9yIiwiY29uc29sZSIsImxvZyIsInN0YXRlIiwiT1VUX09GX0RBVEUiLCJlIiwib25lcnJvciIsIm9wZW4iLCJzZW5kIiwic3RyaW5naWZ5IiwiYXBpIiwic2ltdWxhdGlvbiIsImxvY2FsZSIsInNpbSIsImN1cnJlbnRWZXJzaW9uIiwidXBkYXRlQ2hlY2siLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbInVwZGF0ZUNoZWNrLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE1LTIwMjQsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgc2luZ2xldG9uIHR5cGUvb2JqZWN0IGZvciBoYW5kbGluZyBjaGVja2luZyB3aGV0aGVyIG91ciBzaW11bGF0aW9uIGlzIHVwLXRvLWRhdGUsIG9yIHdoZXRoZXIgdGhlcmUgaXMgYW5cclxuICogdXBkYXRlZCB2ZXJzaW9uLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy8xODlcclxuICpcclxuICogSXQgZXhwb3NlcyBpdHMgY3VycmVudCBzdGF0ZSAoZm9yIFVJcyB0byBob29rIGludG8pLCBhbmQgYSBjaGVjaygpIGZ1bmN0aW9uIHVzZWQgdG8gc3RhcnQgY2hlY2tpbmcgdGhlIHZlcnNpb24uXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgam9pc3QgZnJvbSAnLi9qb2lzdC5qcyc7XHJcbmltcG9ydCBwYWNrYWdlSlNPTiBmcm9tICcuL3BhY2thZ2VKU09OLmpzJzsgLy8gcGFyc2UgbmFtZS92ZXJzaW9uIG91dCBvZiB0aGUgcGFja2FnZS5qc29uXHJcbmltcG9ydCBVcGRhdGVTdGF0ZSBmcm9tICcuL1VwZGF0ZVN0YXRlLmpzJztcclxuXHJcbmNvbnN0IFNpbVZlcnNpb24gPSBwaGV0LnByZWxvYWRzLmNoaXBwZXIuU2ltVmVyc2lvbjsgLy8gdXNlIHByZWxvYWQgZnJvbSBjaGlwcGVyIChhdXRvLWNvcGllZCBmcm9tIHBlcmVubmlhbClcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBzaW1OYW1lID0gcGFja2FnZUpTT04ubmFtZTtcclxuY29uc3Qgc2ltVmVyc2lvbiA9IFNpbVZlcnNpb24ucGFyc2UoIHBhY2thZ2VKU09OLnZlcnNpb24sIHBoZXQuY2hpcHBlci5idWlsZFRpbWVzdGFtcCApO1xyXG5jb25zdCByZXF1ZXN0UHJvdG9jb2xTdHJpbmcgPSAoIGRvY3VtZW50LmxvY2F0aW9uLnByb3RvY29sID09PSAnaHR0cHM6JyA/ICdodHRwczonIDogJ2h0dHA6JyApO1xyXG5jb25zdCBUSU1FT1VUX01JTExJU0VDT05EUyA9IDE1MDAwOyAvLyBIb3cgbWFueSBtcyBiZWZvcmUgd2UgdGltZSBvdXQgKHNldCB0byAnb2ZmbGluZScpXHJcblxyXG50eXBlIFRTaW1WZXJzaW9uID0gc3RyaW5nICYge1xyXG4gIGlzU2ltTm90UHVibGlzaGVkOiBib29sZWFuO1xyXG59O1xyXG5cclxuY2xhc3MgVXBkYXRlQ2hlY2sge1xyXG4gIHB1YmxpYyByZWFkb25seSBzdGF0ZVByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PFVwZGF0ZVN0YXRlPjtcclxuICBwdWJsaWMgbGF0ZXN0VmVyc2lvbjogVFNpbVZlcnNpb24gfCBudWxsOyAvLyB7U2ltVmVyc2lvbnxudWxsfSB3aWxsIGJlIGZpbGxlZCBpbiBieSBjaGVjaygpIGlmIGFwcGxpY2FibGVcclxuICBwdWJsaWMgcmVhZG9ubHkgb3VyVmVyc2lvbjogVFNpbVZlcnNpb247IC8vIChqb2lzdC1pbnRlcm5hbCkge1NpbVZlcnNpb259IHZlcnNpb24gb2YgdGhlIHNpbSB0aGF0IGlzIHJ1bm5pbmdcclxuICBwcml2YXRlIHJlYWRvbmx5IHRpbWVvdXRDYWxsYmFjazogKCkgPT4gdm9pZDtcclxuICBwdWJsaWMgcmVhZG9ubHkgYXJlVXBkYXRlc0NoZWNrZWQ6IGJvb2xlYW47IC8vIFdoZXRoZXIgd2UgYWN0dWFsbHkgYWxsb3cgY2hlY2tpbmcgZm9yIHVwZGF0ZXMsIG9yIHNob3dpbmcgYW55IHVwZGF0ZS1yZWxhdGVkIFVJcy5cclxuICBwdWJsaWMgdXBkYXRlVVJMOiBzdHJpbmc7IC8vIFRoZSBVUkwgdG8gYmUgdXNlZCBmb3IgXCJOZXcgdmVyc2lvbiBhdmFpbGFibGVcIiBjbGlja3NcclxuICBwcml2YXRlIHRpbWVvdXRJZDogbnVtYmVyOyAvLyBWYWxpZCBvbmx5IGlmIGBzdGF0ZSA9PT0gVXBkYXRlU3RhdGUuQ0hFQ0tJTkdgLCB0aGUgdGltZW91dCBJRCBvZiBvdXIgdGltZW91dCBsaXN0ZW5lclxyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoKSB7XHJcblxyXG4gICAgdGhpcy5zdGF0ZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIFVwZGF0ZVN0YXRlLlVOQ0hFQ0tFRCApO1xyXG4gICAgdGhpcy5sYXRlc3RWZXJzaW9uID0gbnVsbDtcclxuICAgIHRoaXMub3VyVmVyc2lvbiA9IHNpbVZlcnNpb247XHJcbiAgICB0aGlzLnRpbWVvdXRDYWxsYmFjayA9IHRoaXMudGltZW91dC5iaW5kKCB0aGlzICk7XHJcblxyXG4gICAgLy8gSWYgaXQncyBub3QgUGhFVC1icmFuZGVkIE9SIGlmIGl0IGlzIHBoZXQtaW8gb3IgaW4gdGhlIHBoZXQtYXBwLCBkbyBub3QgY2hlY2sgZm9yIHVwZGF0ZXNcclxuICAgIHRoaXMuYXJlVXBkYXRlc0NoZWNrZWQgPSBwaGV0LmNoaXBwZXIuYnJhbmQgPT09ICdwaGV0JyAmJiAhcGhldC5jaGlwcGVyLmlzQXBwICYmIHBoZXQuY2hpcHBlci5xdWVyeVBhcmFtZXRlcnMueW90dGE7XHJcblxyXG4gICAgdGhpcy51cGRhdGVVUkwgPSBgJHsnaHR0cDovL3BoZXQuY29sb3JhZG8uZWR1L2h0bWwtc2ltLXVwZGF0ZScgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAnP3NpbXVsYXRpb249J30ke2VuY29kZVVSSUNvbXBvbmVudCggc2ltTmFtZSApXHJcbiAgICB9JnZlcnNpb249JHtlbmNvZGVVUklDb21wb25lbnQoIHNpbVZlcnNpb24udG9TdHJpbmcoKSApXHJcbiAgICB9JmJ1aWxkVGltZXN0YW1wPSR7ZW5jb2RlVVJJQ29tcG9uZW50KCBgJHtwaGV0LmNoaXBwZXIuYnVpbGRUaW1lc3RhbXB9YCApfWA7XHJcblxyXG4gICAgdGhpcy50aW1lb3V0SWQgPSAtMTtcclxuICB9XHJcblxyXG4gIC8vIENsZWFycyBvdXIgdGltZW91dCBsaXN0ZW5lci5cclxuICBwcml2YXRlIGNsZWFyVGltZW91dCgpOiB2b2lkIHtcclxuICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMudGltZW91dElkICk7XHJcbiAgfVxyXG5cclxuICAvL1NldHMgb3VyIHRpbWVvdXQgbGlzdGVuZXIuXHJcbiAgcHJpdmF0ZSBzZXRUaW1lb3V0KCk6IHZvaWQgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGJhZC1zaW0tdGV4dFxyXG4gICAgdGhpcy50aW1lb3V0SWQgPSB3aW5kb3cuc2V0VGltZW91dCggdGhpcy50aW1lb3V0Q2FsbGJhY2ssIFRJTUVPVVRfTUlMTElTRUNPTkRTICk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgYmFkLXNpbS10ZXh0XHJcbiAgfVxyXG5cclxuICAvLyBJZiB3ZSBhcmUgY2hlY2tpbmcsIGl0IHJlc2V0cyBvdXIgdGltZW91dCB0aW1lciB0byBUSU1FT1VUX01JTExJU0VDT05EU1xyXG4gIHB1YmxpYyByZXNldFRpbWVvdXQoKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMuc3RhdGVQcm9wZXJ0eS52YWx1ZSA9PT0gVXBkYXRlU3RhdGUuQ0hFQ0tJTkcgKSB7XHJcbiAgICAgIHRoaXMuY2xlYXJUaW1lb3V0KCk7XHJcbiAgICAgIHRoaXMuc2V0VGltZW91dCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gV2hhdCBoYXBwZW5zIHdoZW4gd2UgYWN0dWFsbHkgdGltZSBvdXQuXHJcbiAgcHJpdmF0ZSB0aW1lb3V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID0gVXBkYXRlU3RhdGUuT0ZGTElORTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEtpY2tzIG9mZiB0aGUgdmVyc2lvbiBjaGVja2luZyByZXF1ZXN0IChpZiBhYmxlKSwgcmVzdWx0aW5nIGluIHN0YXRlIGNoYW5nZXMuXHJcbiAgICovXHJcbiAgcHVibGljIGNoZWNrKCk6IHZvaWQge1xyXG4gICAgaWYgKCAhdGhpcy5hcmVVcGRhdGVzQ2hlY2tlZCB8fCAoIHRoaXMuc3RhdGVQcm9wZXJ0eS52YWx1ZSAhPT0gVXBkYXRlU3RhdGUuVU5DSEVDS0VEICYmIHRoaXMuc3RhdGVQcm9wZXJ0eS52YWx1ZSAhPT0gVXBkYXRlU3RhdGUuT0ZGTElORSApICkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSWYgb3VyIHNpbSdzIHZlcnNpb24gaW5kaWNhdGVzIGl0IGhhc24ndCBiZWVuIHB1Ymxpc2hlZCwgZG9uJ3QgYXR0ZW1wdCB0byBzZW5kIGEgcmVxdWVzdCBmb3Igbm93XHJcbiAgICBpZiAoIHRoaXMub3VyVmVyc2lvbi5pc1NpbU5vdFB1Ymxpc2hlZCApIHtcclxuICAgICAgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID0gVXBkYXRlU3RhdGUuVVBfVE9fREFURTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG5cclxuICAgIGlmICggJ3dpdGhDcmVkZW50aWFscycgaW4gcmVxICkge1xyXG5cclxuICAgICAgLy8gd2UnbGwgYmUgYWJsZSB0byBzZW5kIHRoZSBwcm9wZXIgdHlwZSBvZiByZXF1ZXN0LCBzbyB3ZSBtYXJrIG91cnNlbGYgYXMgY2hlY2tpbmdcclxuICAgICAgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID0gVXBkYXRlU3RhdGUuQ0hFQ0tJTkc7XHJcblxyXG4gICAgICB0aGlzLnNldFRpbWVvdXQoKTtcclxuXHJcbiAgICAgIHJlcS5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5jbGVhclRpbWVvdXQoKTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKCByZXEucmVzcG9uc2VUZXh0ICk7XHJcblxyXG4gICAgICAgICAgaWYgKCBkYXRhLmVycm9yICkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyggYFVwZGF0ZSBjaGVjayBmYWlsdXJlOiAke2RhdGEuZXJyb3J9YCApO1xyXG4gICAgICAgICAgICB0aGlzLnN0YXRlUHJvcGVydHkudmFsdWUgPSBVcGRhdGVTdGF0ZS5PRkZMSU5FO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICggdGhpcy51cGRhdGVVUkwgKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVVUkwgPSBkYXRhLnVwZGF0ZVVSTDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmxhdGVzdFZlcnNpb24gPSBTaW1WZXJzaW9uLnBhcnNlKCBkYXRhLmxhdGVzdFZlcnNpb24sIGRhdGEuYnVpbGRUaW1lc3RhbXAgKTtcclxuXHJcbiAgICAgICAgICAgIC8vIHRoZXNlIGBzdGF0ZWAgc3RyaW5ncyBjb21lIGZyb20gdGhlIHdlYnNpdGUgc2VydmljZSwgYW5kIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aFxyXG4gICAgICAgICAgICAvLyB3ZWJzaXRlXFxzcmNcXGphdmFcXGVkdVxcY29sb3JhZG9cXHBoZXRcXHdlYnNpdGVcXHNlcnZpY2VzXFxDaGVja0hUTUxVcGRhdGVzLmphdmFcclxuICAgICAgICAgICAgaWYgKCBkYXRhLnN0YXRlID09PSAnb3V0LW9mLWRhdGUnICkge1xyXG4gICAgICAgICAgICAgIHRoaXMuc3RhdGVQcm9wZXJ0eS52YWx1ZSA9IFVwZGF0ZVN0YXRlLk9VVF9PRl9EQVRFO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCBkYXRhLnN0YXRlID09PSAndXAtdG8tZGF0ZScgKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID0gVXBkYXRlU3RhdGUuVVBfVE9fREFURTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyggYEZhaWxlZCB0byBnZXQgcHJvcGVyIHN0YXRlOiAke2RhdGEuc3RhdGV9YCApO1xyXG4gICAgICAgICAgICAgIHRoaXMuc3RhdGVQcm9wZXJ0eS52YWx1ZSA9IFVwZGF0ZVN0YXRlLk9GRkxJTkU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2goIGUgKSB7XHJcbiAgICAgICAgICB0aGlzLnN0YXRlUHJvcGVydHkudmFsdWUgPSBVcGRhdGVTdGF0ZS5PRkZMSU5FO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgcmVxLm9uZXJyb3IgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5jbGVhclRpbWVvdXQoKTtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID0gVXBkYXRlU3RhdGUuT0ZGTElORTtcclxuICAgICAgfTtcclxuICAgICAgcmVxLm9wZW4oICdwb3N0JywgYCR7cmVxdWVzdFByb3RvY29sU3RyaW5nfS8vcGhldC5jb2xvcmFkby5lZHUvc2VydmljZXMvY2hlY2staHRtbC11cGRhdGVzYCwgdHJ1ZSApOyAvLyBlbmFibGUgQ09SU1xyXG4gICAgICByZXEuc2VuZCggSlNPTi5zdHJpbmdpZnkoIHtcclxuICAgICAgICBhcGk6ICcxLjAnLFxyXG4gICAgICAgIHNpbXVsYXRpb246IHNpbU5hbWUsXHJcbiAgICAgICAgbG9jYWxlOiBwaGV0LmpvaXN0LnNpbS5sb2NhbGUsXHJcbiAgICAgICAgY3VycmVudFZlcnNpb246IHRoaXMub3VyVmVyc2lvbi50b1N0cmluZygpLFxyXG4gICAgICAgIGJ1aWxkVGltZXN0YW1wOiBwaGV0LmNoaXBwZXIuYnVpbGRUaW1lc3RhbXBcclxuICAgICAgfSApICk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCB1cGRhdGVDaGVjayA9IG5ldyBVcGRhdGVDaGVjaygpO1xyXG5qb2lzdC5yZWdpc3RlciggJ3VwZGF0ZUNoZWNrJywgdXBkYXRlQ2hlY2sgKTtcclxuZXhwb3J0IGRlZmF1bHQgdXBkYXRlQ2hlY2s7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLG1CQUFtQixNQUFNLHNDQUFzQztBQUN0RSxPQUFPQyxLQUFLLE1BQU0sWUFBWTtBQUM5QixPQUFPQyxXQUFXLE1BQU0sa0JBQWtCLENBQUMsQ0FBQztBQUM1QyxPQUFPQyxXQUFXLE1BQU0sa0JBQWtCO0FBRTFDLE1BQU1DLFVBQVUsR0FBR0MsSUFBSSxDQUFDQyxRQUFRLENBQUNDLE9BQU8sQ0FBQ0gsVUFBVSxDQUFDLENBQUM7O0FBRXJEO0FBQ0EsTUFBTUksT0FBTyxHQUFHTixXQUFXLENBQUNPLElBQUk7QUFDaEMsTUFBTUMsVUFBVSxHQUFHTixVQUFVLENBQUNPLEtBQUssQ0FBRVQsV0FBVyxDQUFDVSxPQUFPLEVBQUVQLElBQUksQ0FBQ0UsT0FBTyxDQUFDTSxjQUFlLENBQUM7QUFDdkYsTUFBTUMscUJBQXFCLEdBQUtDLFFBQVEsQ0FBQ0MsUUFBUSxDQUFDQyxRQUFRLEtBQUssUUFBUSxHQUFHLFFBQVEsR0FBRyxPQUFTO0FBQzlGLE1BQU1DLG9CQUFvQixHQUFHLEtBQUssQ0FBQyxDQUFDOztBQU1wQyxNQUFNQyxXQUFXLENBQUM7RUFFMEI7RUFDRDs7RUFFRztFQUNsQjtFQUNDOztFQUVwQkMsV0FBV0EsQ0FBQSxFQUFHO0lBRW5CLElBQUksQ0FBQ0MsYUFBYSxHQUFHLElBQUlyQixtQkFBbUIsQ0FBRUcsV0FBVyxDQUFDbUIsU0FBVSxDQUFDO0lBQ3JFLElBQUksQ0FBQ0MsYUFBYSxHQUFHLElBQUk7SUFDekIsSUFBSSxDQUFDQyxVQUFVLEdBQUdkLFVBQVU7SUFDNUIsSUFBSSxDQUFDZSxlQUFlLEdBQUcsSUFBSSxDQUFDQyxPQUFPLENBQUNDLElBQUksQ0FBRSxJQUFLLENBQUM7O0lB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R0FBR25CLFVBQVUsQ0FBQ08sS0FBSyxDQUFFdUMsSUFBSSxDQUFDM0IsYUFBYSxFQUFFMkIsSUFBSSxDQUFDckMsY0FBZSxDQUFDOztZQUVoRjtZQUNBO1lBQ0EsSUFBS3FDLElBQUksQ0FBQ00sS0FBSyxLQUFLLGFBQWEsRUFBRztjQUNsQyxJQUFJLENBQUNuQyxhQUFhLENBQUNvQixLQUFLLEdBQUd0QyxXQUFXLENBQUNzRCxXQUFXO1lBQ3BELENBQUMsTUFDSSxJQUFLUCxJQUFJLENBQUNNLEtBQUssS0FBSyxZQUFZLEVBQUc7Y0FDdEMsSUFBSSxDQUFDbkMsYUFBYSxDQUFDb0IsS0FBSyxHQUFHdEMsV0FBVyxDQUFDMkMsVUFBVTtZQUNuRCxDQUFDLE1BQ0k7Y0FDSFEsT0FBTyxDQUFDQyxHQUFHLENBQUcsK0JBQThCTCxJQUFJLENBQUNNLEtBQU0sRUFBRSxDQUFDO2NBQzFELElBQUksQ0FBQ25DLGFBQWEsQ0FBQ29CLEtBQUssR0FBR3RDLFdBQVcsQ0FBQ3dDLE9BQU87WUFDaEQ7VUFDRjtRQUNGLENBQUMsQ0FDRCxPQUFPZSxDQUFDLEVBQUc7VUFDVCxJQUFJLENBQUNyQyxhQUFhLENBQUNvQixLQUFLLEdBQUd0QyxXQUFXLENBQUN3QyxPQUFPO1FBQ2hEO01BQ0YsQ0FBQztNQUNESSxHQUFHLENBQUNZLE9BQU8sR0FBRyxNQUFNO1FBQ2xCLElBQUksQ0FBQ3RCLFlBQVksQ0FBQyxDQUFDO1FBRW5CLElBQUksQ0FBQ2hCLGFBQWEsQ0FBQ29CLEtBQUssR0FBR3RDLFdBQVcsQ0FBQ3dDLE9BQU87TUFDaEQsQ0FBQztNQUNESSxHQUFHLENBQUNhLElBQUksQ0FBRSxNQUFNLEVBQUcsR0FBRTlDLHFCQUFzQixpREFBZ0QsRUFBRSxJQUFLLENBQUMsQ0FBQyxDQUFDO01BQ3JHaUMsR0FBRyxDQUFDYyxJQUFJLENBQUVWLElBQUksQ0FBQ1csU0FBUyxDQUFFO1FBQ3hCQyxHQUFHLEVBQUUsS0FBSztRQUNWQyxVQUFVLEVBQUV4RCxPQUFPO1FBQ25CeUQsTUFBTSxFQUFFNUQsSUFBSSxDQUFDSixLQUFLLENBQUNpRSxHQUFHLENBQUNELE1BQU07UUFDN0JFLGNBQWMsRUFBRSxJQUFJLENBQUMzQyxVQUFVLENBQUNXLFFBQVEsQ0FBQyxDQUFDO1FBQzFDdEIsY0FBYyxFQUFFUixJQUFJLENBQUNFLE9BQU8sQ0FBQ007TUFDL0IsQ0FBRSxDQUFFLENBQUM7SUFDUDtFQUNGO0FBQ0Y7QUFFQSxNQUFNdUQsV0FBVyxHQUFHLElBQUlqRCxXQUFXLENBQUMsQ0FBQztBQUNyQ2xCLEtBQUssQ0FBQ29FLFFBQVEsQ0FBRSxhQUFhLEVBQUVELFdBQVksQ0FBQztBQUM1QyxlQUFlQSxXQUFXIiwiaWdub3JlTGlzdCI6W119