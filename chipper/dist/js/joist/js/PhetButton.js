// Copyright 2013-2024, University of Colorado Boulder

/**
 * The button that pops up the PhET menu, which appears in the bottom right of the home screen and on the right side
 * of the navbar.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import Multilink from '../../axon/js/Multilink.js';
import { AriaHasPopUpMutator, Color, Image, Line, Node } from '../../scenery/js/imports.js';
import pushButtonSoundPlayer from '../../tambo/js/shared-sound-players/pushButtonSoundPlayer.js';
import Tandem from '../../tandem/js/Tandem.js';
import IOType from '../../tandem/js/types/IOType.js';
import joist from './joist.js';
import JoistButton from './JoistButton.js';
import JoistStrings from './JoistStrings.js';
import KebabMenuIcon from './KebabMenuIcon.js';
import PhetMenu from './PhetMenu.js';
import updateCheck from './updateCheck.js';
import UpdateState from './UpdateState.js';

// Accommodate logos of any height by scaling them down proportionately.
// The primary logo is 108px high and we have been scaling it at 0.28 to make it look good even on higher resolution
// displays.  The logo will be scaled up to 108px high so the rest of the layout code will work smoothly
// Scale to the same height as the PhET logo, so that layout code works correctly.
// height of the PhET logo, brand/phet/images/logo.png or brand/adapted-from-phet/images/logo.png
const PHET_LOGO_HEIGHT = 108;
const PHET_LOGO_SCALE = 0.28; // scale applied to the PhET logo

class PhetButton extends JoistButton {
  /**
   * PhET-iO Type for PhetButton, to interface with PhET-iO API.  The PhetButtonIO acts as the main phet-io branding/logo in
   * the sim. It doesn't inherit from NodeIO because we neither need all of NodeIO's API methods, nor do we want to
   * support maintaining overriding no-ops in this file see https://github.com/phetsims/scenery/issues/711 for more info.
   */
  static PhetButtonIO = new IOType('PhetButtonIO', {
    valueType: PhetButton,
    documentation: 'The PhET Button in the bottom right of the screen'
  });
  constructor(sim, backgroundFillProperty, tandem) {
    // Dynamic modules are loaded in simLauncher and accessed through their namespace
    const Brand = phet.brand.Brand;
    assert && assert(Brand, 'Brand should exist by now');

    // The logo images are loaded from the brand which is selected via query parameter (during unbuilt mode)
    // or a grunt option (during the build), please see initialize-globals.js window.phet.chipper.brand for more
    // details
    const logoOnBlackBackground = Brand.logoOnBlackBackground;
    const logoOnWhiteBackground = Brand.logoOnWhiteBackground;

    // PhET logo
    const logoImage = new Image(logoOnBlackBackground, {
      scale: PHET_LOGO_SCALE / logoOnBlackBackground.height * PHET_LOGO_HEIGHT * 0.85,
      pickable: false
    });

    // The menu icon, to the right of the logo
    const menuIcon = new KebabMenuIcon({
      scale: 0.83,
      left: logoImage.width + 8,
      bottom: logoImage.bottom - 0.5,
      pickable: false
    });

    // Assert here means that ?ea was provided (potentially from the wrapper) AND that there are actually assertions
    // available for debugging.
    const children = assert && Tandem.PHET_IO_ENABLED ? [
    // The underline in phet-io debug mode. "7" is the right distance to avoid hiding the trademark.
    new Line(0, 0, logoImage.width - 7, 0, {
      stroke: 'red',
      lineWidth: 3,
      left: logoImage.left,
      bottom: logoImage.bottom
    }), logoImage, menuIcon] : [logoImage, menuIcon];

    // The icon combines the PhET logo and the menu icon
    const icon = new Node({
      children: children
    });
    super(icon, backgroundFillProperty, {
      highlightExtensionWidth: 6,
      highlightExtensionHeight: 5,
      highlightCenterOffsetY: 4,
      listener: () => {
        phetMenu.show();
        phetMenu.items[0].focus();
        pushButtonSoundPlayer.play();
      },
      tandem: tandem,
      phetioType: PhetButton.PhetButtonIO,
      phetioDocumentation: 'The button that appears at the right side of the navigation bar, which shows a menu when pressed',
      // This is the primary way to prevent learners from accessing the PhET menu in PhET-iO, so feature it.
      enabledPropertyOptions: {
        phetioFeatured: true,
        phetioDocumentation: 'When disabled, the (three dots) are hidden and the button cannot be pressed, hiding the PhET menu.'
      },
      phetioVisiblePropertyInstrumented: false,
      // This button is our branding, don't ever hide it.

      // pdom
      innerContent: JoistStrings.a11y.phetMenuStringProperty,
      // voicing
      voicingNameResponse: JoistStrings.a11y.phetMenuStringProperty
    });
    const phetMenu = new PhetMenu(sim, {
      tandem: tandem.createTandem('phetMenu'),
      focusOnHideNode: this
    });

    // Sim.js handles scaling the popup menu.  This code sets the position of the popup menu.
    // sim.bounds are null on init, but we will get the callback when it is sized for the first time
    // Does not need to be unlinked or disposed because PhetButton persists for the lifetime of the sim
    Multilink.multilink([sim.boundsProperty, sim.screenBoundsProperty, sim.scaleProperty, phetMenu.localBoundsProperty], (bounds, screenBounds, scale) => {
      if (bounds && screenBounds && scale) {
        phetMenu.setScaleMagnitude(scale);
        phetMenu.right = bounds.right - 2;
        const navBarHeight = bounds.height - screenBounds.height;
        phetMenu.bottom = screenBounds.bottom + navBarHeight / 2;
      }
    });

    // No need to unlink, as the PhetButton exists for the lifetime of the sim
    Multilink.multilink([backgroundFillProperty, sim.selectedScreenProperty, updateCheck.stateProperty], (backgroundFill, screen, updateState) => {
      const showHomeScreen = screen === sim.homeScreen;
      const backgroundIsWhite = !backgroundFill.equals(Color.BLACK) && !showHomeScreen;
      const outOfDate = updateState === UpdateState.OUT_OF_DATE;
      menuIcon.fill = backgroundIsWhite ? outOfDate ? '#0a0' : '#222' : outOfDate ? '#3F3' : 'white';
      logoImage.image = backgroundIsWhite ? logoOnWhiteBackground : logoOnBlackBackground;
    });

    // Added for phet-io, when toggling enabled, hide the option dots to prevent the cueing.
    // No need to be removed because the PhetButton exists for the lifetime of the sim.
    this.buttonModel.enabledProperty.link(enabled => {
      menuIcon.visible = enabled;
    });

    // pdom - add an attribute that lets the user know the button opens a menu
    AriaHasPopUpMutator.mutateNode(this, true);
  }
}
joist.register('PhetButton', PhetButton);
export default PhetButton;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJBcmlhSGFzUG9wVXBNdXRhdG9yIiwiQ29sb3IiLCJJbWFnZSIsIkxpbmUiLCJOb2RlIiwicHVzaEJ1dHRvblNvdW5kUGxheWVyIiwiVGFuZGVtIiwiSU9UeXBlIiwiam9pc3QiLCJKb2lzdEJ1dHRvbiIsIkpvaXN0U3RyaW5ncyIsIktlYmFiTWVudUljb24iLCJQaGV0TWVudSIsInVwZGF0ZUNoZWNrIiwiVXBkYXRlU3RhdGUiLCJQSEVUX0xPR09fSEVJR0hUIiwiUEhFVF9MT0dPX1NDQUxFIiwiUGhldEJ1dHRvbiIsIlBoZXRCdXR0b25JTyIsInZhbHVlVHlwZSIsImRvY3VtZW50YXRpb24iLCJjb25zdHJ1Y3RvciIsInNpbSIsImJhY2tncm91bmRGaWxsUHJvcGVydHkiLCJ0YW5kZW0iLCJCcmFuZCIsInBoZXQiLCJicmFuZCIsImFzc2VydCIsImxvZ29PbkJsYWNrQmFja2dyb3VuZCIsImxvZ29PbldoaXRlQmFja2dyb3VuZCIsImxvZ29JbWFnZSIsInNjYWxlIiwiaGVpZ2h0IiwicGlja2FibGUiLCJtZW51SWNvbiIsImxlZnQiLCJ3aWR0aCIsImJvdHRvbSIsImNoaWxkcmVuIiwiUEhFVF9JT19FTkFCTEVEIiwic3Ryb2tlIiwibGluZVdpZHRoIiwiaWNvbiIsImhpZ2hsaWdodEV4dGVuc2lvbldpZHRoIiwiaGlnaGxpZ2h0RXh0ZW5zaW9uSGVpZ2h0IiwiaGlnaGxpZ2h0Q2VudGVyT2Zmc2V0WSIsImxpc3RlbmVyIiwicGhldE1lbnUiLCJzaG93IiwiaXRlbXMiLCJmb2N1cyIsInBsYXkiLCJwaGV0aW9UeXBlIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsImVuYWJsZWRQcm9wZXJ0eU9wdGlvbnMiLCJwaGV0aW9GZWF0dXJlZCIsInBoZXRpb1Zpc2libGVQcm9wZXJ0eUluc3RydW1lbnRlZCIsImlubmVyQ29udGVudCIsImExMXkiLCJwaGV0TWVudVN0cmluZ1Byb3BlcnR5Iiwidm9pY2luZ05hbWVSZXNwb25zZSIsImNyZWF0ZVRhbmRlbSIsImZvY3VzT25IaWRlTm9kZSIsIm11bHRpbGluayIsImJvdW5kc1Byb3BlcnR5Iiwic2NyZWVuQm91bmRzUHJvcGVydHkiLCJzY2FsZVByb3BlcnR5IiwibG9jYWxCb3VuZHNQcm9wZXJ0eSIsImJvdW5kcyIsInNjcmVlbkJvdW5kcyIsInNldFNjYWxlTWFnbml0dWRlIiwicmlnaHQiLCJuYXZCYXJIZWlnaHQiLCJzZWxlY3RlZFNjcmVlblByb3BlcnR5Iiwic3RhdGVQcm9wZXJ0eSIsImJhY2tncm91bmRGaWxsIiwic2NyZWVuIiwidXBkYXRlU3RhdGUiLCJzaG93SG9tZVNjcmVlbiIsImhvbWVTY3JlZW4iLCJiYWNrZ3JvdW5kSXNXaGl0ZSIsImVxdWFscyIsIkJMQUNLIiwib3V0T2ZEYXRlIiwiT1VUX09GX0RBVEUiLCJmaWxsIiwiaW1hZ2UiLCJidXR0b25Nb2RlbCIsImVuYWJsZWRQcm9wZXJ0eSIsImxpbmsiLCJlbmFibGVkIiwidmlzaWJsZSIsIm11dGF0ZU5vZGUiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlBoZXRCdXR0b24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTMtMjAyNCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVGhlIGJ1dHRvbiB0aGF0IHBvcHMgdXAgdGhlIFBoRVQgbWVudSwgd2hpY2ggYXBwZWFycyBpbiB0aGUgYm90dG9tIHJpZ2h0IG9mIHRoZSBob21lIHNjcmVlbiBhbmQgb24gdGhlIHJpZ2h0IHNpZGVcclxuICogb2YgdGhlIG5hdmJhci5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICogQGF1dGhvciBNaWNoYWVsIEthdXptYW5uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBUQnJhbmQgZnJvbSAnLi4vLi4vYnJhbmQvanMvVEJyYW5kLmpzJztcclxuaW1wb3J0IHsgQXJpYUhhc1BvcFVwTXV0YXRvciwgQ29sb3IsIEltYWdlLCBMaW5lLCBOb2RlIH0gZnJvbSAnLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHB1c2hCdXR0b25Tb3VuZFBsYXllciBmcm9tICcuLi8uLi90YW1iby9qcy9zaGFyZWQtc291bmQtcGxheWVycy9wdXNoQnV0dG9uU291bmRQbGF5ZXIuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgSU9UeXBlIGZyb20gJy4uLy4uL3RhbmRlbS9qcy90eXBlcy9JT1R5cGUuanMnO1xyXG5pbXBvcnQgam9pc3QgZnJvbSAnLi9qb2lzdC5qcyc7XHJcbmltcG9ydCBKb2lzdEJ1dHRvbiBmcm9tICcuL0pvaXN0QnV0dG9uLmpzJztcclxuaW1wb3J0IEpvaXN0U3RyaW5ncyBmcm9tICcuL0pvaXN0U3RyaW5ncy5qcyc7XHJcbmltcG9ydCBLZWJhYk1lbnVJY29uIGZyb20gJy4vS2ViYWJNZW51SWNvbi5qcyc7XHJcbmltcG9ydCBQaGV0TWVudSBmcm9tICcuL1BoZXRNZW51LmpzJztcclxuaW1wb3J0IFNpbSBmcm9tICcuL1NpbS5qcyc7XHJcbmltcG9ydCB1cGRhdGVDaGVjayBmcm9tICcuL3VwZGF0ZUNoZWNrLmpzJztcclxuaW1wb3J0IFVwZGF0ZVN0YXRlIGZyb20gJy4vVXBkYXRlU3RhdGUuanMnO1xyXG5cclxuLy8gQWNjb21tb2RhdGUgbG9nb3Mgb2YgYW55IGhlaWdodCBieSBzY2FsaW5nIHRoZW0gZG93biBwcm9wb3J0aW9uYXRlbHkuXHJcbi8vIFRoZSBwcmltYXJ5IGxvZ28gaXMgMTA4cHggaGlnaCBhbmQgd2UgaGF2ZSBiZWVuIHNjYWxpbmcgaXQgYXQgMC4yOCB0byBtYWtlIGl0IGxvb2sgZ29vZCBldmVuIG9uIGhpZ2hlciByZXNvbHV0aW9uXHJcbi8vIGRpc3BsYXlzLiAgVGhlIGxvZ28gd2lsbCBiZSBzY2FsZWQgdXAgdG8gMTA4cHggaGlnaCBzbyB0aGUgcmVzdCBvZiB0aGUgbGF5b3V0IGNvZGUgd2lsbCB3b3JrIHNtb290aGx5XHJcbi8vIFNjYWxlIHRvIHRoZSBzYW1lIGhlaWdodCBhcyB0aGUgUGhFVCBsb2dvLCBzbyB0aGF0IGxheW91dCBjb2RlIHdvcmtzIGNvcnJlY3RseS5cclxuLy8gaGVpZ2h0IG9mIHRoZSBQaEVUIGxvZ28sIGJyYW5kL3BoZXQvaW1hZ2VzL2xvZ28ucG5nIG9yIGJyYW5kL2FkYXB0ZWQtZnJvbS1waGV0L2ltYWdlcy9sb2dvLnBuZ1xyXG5jb25zdCBQSEVUX0xPR09fSEVJR0hUID0gMTA4O1xyXG5jb25zdCBQSEVUX0xPR09fU0NBTEUgPSAwLjI4OyAvLyBzY2FsZSBhcHBsaWVkIHRvIHRoZSBQaEVUIGxvZ29cclxuXHJcbmNsYXNzIFBoZXRCdXR0b24gZXh0ZW5kcyBKb2lzdEJ1dHRvbiB7XHJcbiAgLyoqXHJcbiAgICogUGhFVC1pTyBUeXBlIGZvciBQaGV0QnV0dG9uLCB0byBpbnRlcmZhY2Ugd2l0aCBQaEVULWlPIEFQSS4gIFRoZSBQaGV0QnV0dG9uSU8gYWN0cyBhcyB0aGUgbWFpbiBwaGV0LWlvIGJyYW5kaW5nL2xvZ28gaW5cclxuICAgKiB0aGUgc2ltLiBJdCBkb2Vzbid0IGluaGVyaXQgZnJvbSBOb2RlSU8gYmVjYXVzZSB3ZSBuZWl0aGVyIG5lZWQgYWxsIG9mIE5vZGVJTydzIEFQSSBtZXRob2RzLCBub3IgZG8gd2Ugd2FudCB0b1xyXG4gICAqIHN1cHBvcnQgbWFpbnRhaW5pbmcgb3ZlcnJpZGluZyBuby1vcHMgaW4gdGhpcyBmaWxlIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvc2NlbmVyeS9pc3N1ZXMvNzExIGZvciBtb3JlIGluZm8uXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBQaGV0QnV0dG9uSU8gPSBuZXcgSU9UeXBlKCAnUGhldEJ1dHRvbklPJywge1xyXG4gICAgdmFsdWVUeXBlOiBQaGV0QnV0dG9uLFxyXG4gICAgZG9jdW1lbnRhdGlvbjogJ1RoZSBQaEVUIEJ1dHRvbiBpbiB0aGUgYm90dG9tIHJpZ2h0IG9mIHRoZSBzY3JlZW4nXHJcbiAgfSApO1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHNpbTogU2ltLCBiYWNrZ3JvdW5kRmlsbFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxDb2xvcj4sIHRhbmRlbTogVGFuZGVtICkge1xyXG5cclxuICAgIC8vIER5bmFtaWMgbW9kdWxlcyBhcmUgbG9hZGVkIGluIHNpbUxhdW5jaGVyIGFuZCBhY2Nlc3NlZCB0aHJvdWdoIHRoZWlyIG5hbWVzcGFjZVxyXG4gICAgY29uc3QgQnJhbmQ6IFRCcmFuZCA9IHBoZXQuYnJhbmQuQnJhbmQ7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBCcmFuZCwgJ0JyYW5kIHNob3VsZCBleGlzdCBieSBub3cnICk7XHJcblxyXG4gICAgLy8gVGhlIGxvZ28gaW1hZ2VzIGFyZSBsb2FkZWQgZnJvbSB0aGUgYnJhbmQgd2hpY2ggaXMgc2VsZWN0ZWQgdmlhIHF1ZXJ5IHBhcmFtZXRlciAoZHVyaW5nIHVuYnVpbHQgbW9kZSlcclxuICAgIC8vIG9yIGEgZ3J1bnQgb3B0aW9uIChkdXJpbmcgdGhlIGJ1aWxkKSwgcGxlYXNlIHNlZSBpbml0aWFsaXplLWdsb2JhbHMuanMgd2luZG93LnBoZXQuY2hpcHBlci5icmFuZCBmb3IgbW9yZVxyXG4gICAgLy8gZGV0YWlsc1xyXG4gICAgY29uc3QgbG9nb09uQmxhY2tCYWNrZ3JvdW5kID0gQnJhbmQubG9nb09uQmxhY2tCYWNrZ3JvdW5kO1xyXG4gICAgY29uc3QgbG9nb09uV2hpdGVCYWNrZ3JvdW5kID0gQnJhbmQubG9nb09uV2hpdGVCYWNrZ3JvdW5kO1xyXG5cclxuICAgIC8vIFBoRVQgbG9nb1xyXG4gICAgY29uc3QgbG9nb0ltYWdlID0gbmV3IEltYWdlKCBsb2dvT25CbGFja0JhY2tncm91bmQsIHtcclxuICAgICAgc2NhbGU6IFBIRVRfTE9HT19TQ0FMRSAvIGxvZ29PbkJsYWNrQmFja2dyb3VuZC5oZWlnaHQgKiBQSEVUX0xPR09fSEVJR0hUICogMC44NSxcclxuICAgICAgcGlja2FibGU6IGZhbHNlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVGhlIG1lbnUgaWNvbiwgdG8gdGhlIHJpZ2h0IG9mIHRoZSBsb2dvXHJcbiAgICBjb25zdCBtZW51SWNvbiA9IG5ldyBLZWJhYk1lbnVJY29uKCB7XHJcbiAgICAgIHNjYWxlOiAwLjgzLFxyXG4gICAgICBsZWZ0OiBsb2dvSW1hZ2Uud2lkdGggKyA4LFxyXG4gICAgICBib3R0b206IGxvZ29JbWFnZS5ib3R0b20gLSAwLjUsXHJcbiAgICAgIHBpY2thYmxlOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEFzc2VydCBoZXJlIG1lYW5zIHRoYXQgP2VhIHdhcyBwcm92aWRlZCAocG90ZW50aWFsbHkgZnJvbSB0aGUgd3JhcHBlcikgQU5EIHRoYXQgdGhlcmUgYXJlIGFjdHVhbGx5IGFzc2VydGlvbnNcclxuICAgIC8vIGF2YWlsYWJsZSBmb3IgZGVidWdnaW5nLlxyXG4gICAgY29uc3QgY2hpbGRyZW4gPSBhc3NlcnQgJiYgVGFuZGVtLlBIRVRfSU9fRU5BQkxFRCA/XHJcbiAgICAgIFtcclxuXHJcbiAgICAgICAgLy8gVGhlIHVuZGVybGluZSBpbiBwaGV0LWlvIGRlYnVnIG1vZGUuIFwiN1wiIGlzIHRoZSByaWdodCBkaXN0YW5jZSB0byBhdm9pZCBoaWRpbmcgdGhlIHRyYWRlbWFyay5cclxuICAgICAgICBuZXcgTGluZSggMCwgMCwgbG9nb0ltYWdlLndpZHRoIC0gNywgMCwge1xyXG4gICAgICAgICAgc3Ryb2tlOiAncmVkJywgbGluZVdpZHRoOiAzLFxyXG4gICAgICAgICAgbGVmdDogbG9nb0ltYWdlLmxlZnQsXHJcbiAgICAgICAgICBib3R0b206IGxvZ29JbWFnZS5ib3R0b21cclxuICAgICAgICB9ICksIGxvZ29JbWFnZSwgbWVudUljb24gXSA6XHJcbiAgICAgIFsgbG9nb0ltYWdlLCBtZW51SWNvbiBdO1xyXG5cclxuICAgIC8vIFRoZSBpY29uIGNvbWJpbmVzIHRoZSBQaEVUIGxvZ28gYW5kIHRoZSBtZW51IGljb25cclxuICAgIGNvbnN0IGljb24gPSBuZXcgTm9kZSggeyBjaGlsZHJlbjogY2hpbGRyZW4gfSApO1xyXG5cclxuICAgIHN1cGVyKCBpY29uLCBiYWNrZ3JvdW5kRmlsbFByb3BlcnR5LCB7XHJcbiAgICAgIGhpZ2hsaWdodEV4dGVuc2lvbldpZHRoOiA2LFxyXG4gICAgICBoaWdobGlnaHRFeHRlbnNpb25IZWlnaHQ6IDUsXHJcbiAgICAgIGhpZ2hsaWdodENlbnRlck9mZnNldFk6IDQsXHJcbiAgICAgIGxpc3RlbmVyOiAoKSA9PiB7XHJcbiAgICAgICAgcGhldE1lbnUuc2hvdygpO1xyXG4gICAgICAgIHBoZXRNZW51Lml0ZW1zWyAwIF0uZm9jdXMoKTtcclxuICAgICAgICBwdXNoQnV0dG9uU291bmRQbGF5ZXIucGxheSgpO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgdGFuZGVtOiB0YW5kZW0sXHJcbiAgICAgIHBoZXRpb1R5cGU6IFBoZXRCdXR0b24uUGhldEJ1dHRvbklPLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnVGhlIGJ1dHRvbiB0aGF0IGFwcGVhcnMgYXQgdGhlIHJpZ2h0IHNpZGUgb2YgdGhlIG5hdmlnYXRpb24gYmFyLCB3aGljaCBzaG93cyBhIG1lbnUgd2hlbiBwcmVzc2VkJyxcclxuXHJcbiAgICAgIC8vIFRoaXMgaXMgdGhlIHByaW1hcnkgd2F5IHRvIHByZXZlbnQgbGVhcm5lcnMgZnJvbSBhY2Nlc3NpbmcgdGhlIFBoRVQgbWVudSBpbiBQaEVULWlPLCBzbyBmZWF0dXJlIGl0LlxyXG4gICAgICBlbmFibGVkUHJvcGVydHlPcHRpb25zOiB7XHJcbiAgICAgICAgcGhldGlvRmVhdHVyZWQ6IHRydWUsXHJcbiAgICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ1doZW4gZGlzYWJsZWQsIHRoZSAodGhyZWUgZG90cykgYXJlIGhpZGRlbiBhbmQgdGhlIGJ1dHRvbiBjYW5ub3QgYmUgcHJlc3NlZCwgaGlkaW5nIHRoZSBQaEVUIG1lbnUuJ1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgcGhldGlvVmlzaWJsZVByb3BlcnR5SW5zdHJ1bWVudGVkOiBmYWxzZSwgLy8gVGhpcyBidXR0b24gaXMgb3VyIGJyYW5kaW5nLCBkb24ndCBldmVyIGhpZGUgaXQuXHJcblxyXG4gICAgICAvLyBwZG9tXHJcbiAgICAgIGlubmVyQ29udGVudDogSm9pc3RTdHJpbmdzLmExMXkucGhldE1lbnVTdHJpbmdQcm9wZXJ0eSxcclxuXHJcbiAgICAgIC8vIHZvaWNpbmdcclxuICAgICAgdm9pY2luZ05hbWVSZXNwb25zZTogSm9pc3RTdHJpbmdzLmExMXkucGhldE1lbnVTdHJpbmdQcm9wZXJ0eVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHBoZXRNZW51ID0gbmV3IFBoZXRNZW51KCBzaW0sIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAncGhldE1lbnUnICksXHJcbiAgICAgIGZvY3VzT25IaWRlTm9kZTogdGhpc1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFNpbS5qcyBoYW5kbGVzIHNjYWxpbmcgdGhlIHBvcHVwIG1lbnUuICBUaGlzIGNvZGUgc2V0cyB0aGUgcG9zaXRpb24gb2YgdGhlIHBvcHVwIG1lbnUuXHJcbiAgICAvLyBzaW0uYm91bmRzIGFyZSBudWxsIG9uIGluaXQsIGJ1dCB3ZSB3aWxsIGdldCB0aGUgY2FsbGJhY2sgd2hlbiBpdCBpcyBzaXplZCBmb3IgdGhlIGZpcnN0IHRpbWVcclxuICAgIC8vIERvZXMgbm90IG5lZWQgdG8gYmUgdW5saW5rZWQgb3IgZGlzcG9zZWQgYmVjYXVzZSBQaGV0QnV0dG9uIHBlcnNpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbVxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggWyBzaW0uYm91bmRzUHJvcGVydHksIHNpbS5zY3JlZW5Cb3VuZHNQcm9wZXJ0eSwgc2ltLnNjYWxlUHJvcGVydHksIHBoZXRNZW51LmxvY2FsQm91bmRzUHJvcGVydHkgXSxcclxuICAgICAgKCBib3VuZHMsIHNjcmVlbkJvdW5kcywgc2NhbGUgKSA9PiB7XHJcbiAgICAgICAgaWYgKCBib3VuZHMgJiYgc2NyZWVuQm91bmRzICYmIHNjYWxlICkge1xyXG4gICAgICAgICAgcGhldE1lbnUuc2V0U2NhbGVNYWduaXR1ZGUoIHNjYWxlICk7XHJcbiAgICAgICAgICBwaGV0TWVudS5yaWdodCA9IGJvdW5kcy5yaWdodCAtIDI7XHJcbiAgICAgICAgICBjb25zdCBuYXZCYXJIZWlnaHQgPSBib3VuZHMuaGVpZ2h0IC0gc2NyZWVuQm91bmRzLmhlaWdodDtcclxuICAgICAgICAgIHBoZXRNZW51LmJvdHRvbSA9IHNjcmVlbkJvdW5kcy5ib3R0b20gKyBuYXZCYXJIZWlnaHQgLyAyO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG5cclxuXHJcbiAgICAvLyBObyBuZWVkIHRvIHVubGluaywgYXMgdGhlIFBoZXRCdXR0b24gZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbVxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggWyBiYWNrZ3JvdW5kRmlsbFByb3BlcnR5LCBzaW0uc2VsZWN0ZWRTY3JlZW5Qcm9wZXJ0eSwgdXBkYXRlQ2hlY2suc3RhdGVQcm9wZXJ0eSBdLFxyXG4gICAgICAoIGJhY2tncm91bmRGaWxsLCBzY3JlZW4sIHVwZGF0ZVN0YXRlICkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNob3dIb21lU2NyZWVuID0gc2NyZWVuID09PSBzaW0uaG9tZVNjcmVlbjtcclxuICAgICAgICBjb25zdCBiYWNrZ3JvdW5kSXNXaGl0ZSA9ICFiYWNrZ3JvdW5kRmlsbC5lcXVhbHMoIENvbG9yLkJMQUNLICkgJiYgIXNob3dIb21lU2NyZWVuO1xyXG5cclxuICAgICAgICBjb25zdCBvdXRPZkRhdGUgPSB1cGRhdGVTdGF0ZSA9PT0gVXBkYXRlU3RhdGUuT1VUX09GX0RBVEU7XHJcbiAgICAgICAgbWVudUljb24uZmlsbCA9IGJhY2tncm91bmRJc1doaXRlID8gKCBvdXRPZkRhdGUgPyAnIzBhMCcgOiAnIzIyMicgKSA6ICggb3V0T2ZEYXRlID8gJyMzRjMnIDogJ3doaXRlJyApO1xyXG4gICAgICAgIGxvZ29JbWFnZS5pbWFnZSA9IGJhY2tncm91bmRJc1doaXRlID8gbG9nb09uV2hpdGVCYWNrZ3JvdW5kIDogbG9nb09uQmxhY2tCYWNrZ3JvdW5kO1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgLy8gQWRkZWQgZm9yIHBoZXQtaW8sIHdoZW4gdG9nZ2xpbmcgZW5hYmxlZCwgaGlkZSB0aGUgb3B0aW9uIGRvdHMgdG8gcHJldmVudCB0aGUgY3VlaW5nLlxyXG4gICAgLy8gTm8gbmVlZCB0byBiZSByZW1vdmVkIGJlY2F1c2UgdGhlIFBoZXRCdXR0b24gZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbS5cclxuICAgIHRoaXMuYnV0dG9uTW9kZWwuZW5hYmxlZFByb3BlcnR5LmxpbmsoIGVuYWJsZWQgPT4geyBtZW51SWNvbi52aXNpYmxlID0gZW5hYmxlZDsgfSApO1xyXG5cclxuICAgIC8vIHBkb20gLSBhZGQgYW4gYXR0cmlidXRlIHRoYXQgbGV0cyB0aGUgdXNlciBrbm93IHRoZSBidXR0b24gb3BlbnMgYSBtZW51XHJcbiAgICBBcmlhSGFzUG9wVXBNdXRhdG9yLm11dGF0ZU5vZGUoIHRoaXMsIHRydWUgKTtcclxuICB9XHJcbn1cclxuXHJcbmpvaXN0LnJlZ2lzdGVyKCAnUGhldEJ1dHRvbicsIFBoZXRCdXR0b24gKTtcclxuZXhwb3J0IGRlZmF1bHQgUGhldEJ1dHRvbjsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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