// Copyright 2020-2024, University of Colorado Boulder

import joist from './joist.js';
/**
 * Given an array of all possible screens that a sim can have, select and order them according to the relevant query
 * parameters. This also will create a homeScreen if needed, and specify the initialScreen for startup.
 *
 * Parameters suffixed with "Provided" will be true if the that query parameter was actually in the URL, as opposed to
 * the value of the query parameter being the default.
 *
 * @author Chris Klusendorf (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 * @author Sam Reid (PhET Interactive Simulations)
 *
 * @param allSimScreens - all of the screens declared by the sim, duck-typed for tests
 * @param homeScreenQueryParameter - from phet.chipper.queryParameters.homeScreen
 * @param homeScreenQueryParameterProvided
 * @param initialScreenIndex - from phet.chipper.queryParameters.initialScreen
 * @param initialScreenQueryParameterProvided
 * @param screensQueryParameter - from phet.chipper.queryParameters.screens
 * @param screensQueryParameterProvided
 * @param createHomeScreen
 * @returns - duck-typed for tests
 * @throws Error if incompatible data is provided
 */
export default function selectScreens(allSimScreens, homeScreenQueryParameter, homeScreenQueryParameterProvided, initialScreenIndex, initialScreenQueryParameterProvided, screensQueryParameter, screensQueryParameterProvided, setupScreens, createHomeScreen) {
  if (allSimScreens.length === 1 && homeScreenQueryParameterProvided && homeScreenQueryParameter) {
    gracefulAssert('homeScreen', homeScreenQueryParameter, 'cannot specify homeScreen=true for single-screen sims');
  }

  // the ordered list of sim screens for this runtime
  let selectedSimScreens = [];
  if (screensQueryParameterProvided && (!screensQueryParameter || screensQueryParameter.length === 0)) {
    gracefulAssert('screens', screensQueryParameter, '"?screens" query parameter must have screen values');
    selectedSimScreens = allSimScreens;
  }

  // If a subset of screens was specified with the `screens` query parameter, add them to selectedSimScreens. Otherwise,
  // use all of the available sim screens as the default. Note that if the value of `screens` did not pass validation
  // in QueryStringMachine, it will be reverted to its default value of `null`, so it also needs to be checked for
  // truthiness before attempting to use it. For `screens` documentation, see the schema at
  // phet.chipper.queryParameters.screens in initialize-globals.js.
  if (screensQueryParameterProvided && screensQueryParameter) {
    for (let i = 0; i < screensQueryParameter.length; i++) {
      const userIndex = screensQueryParameter[i];
      const screenIndex = userIndex - 1; // screens query parameter uses 1-based indices, so convert to 0-based index

      if (screenIndex >= 0 && screenIndex < allSimScreens.length) {
        // index is valid, add screen
        selectedSimScreens.push(allSimScreens[screenIndex]);
      } else {
        // index is invalid
        gracefulAssert('screens', screensQueryParameter, `invalid value in screens query parameter: ${userIndex}`);
        selectedSimScreens = allSimScreens;
        break;
      }
    }
  } else {
    selectedSimScreens = allSimScreens;
  }
  setupScreens(selectedSimScreens);

  // Specifying ?homeScreen=false creates a simulation with no HomeScreen, and hence is incompatible with
  // ?initialScreen=0, which specifies to show the home screen. Note that the default value of initialScreen:0 is
  // ignored when there is no HomeScreen.
  if (initialScreenQueryParameterProvided && initialScreenIndex === 0 && !homeScreenQueryParameter) {
    const errorMessage = 'cannot specify initialScreen=0 when home screen is disabled with homeScreen=false';
    gracefulAssert('initialScreen', initialScreenIndex, errorMessage);
    gracefulAssert('homeScreen', homeScreenQueryParameter, errorMessage);
  }

  // For a single screen simulation (whether the simulation only declares one screen, or whether the user has specified
  // a single screen via ?screens), there is no HomeScreen, and hence ?initialScreen=0 which requests to show the
  // HomeScreen on startup should fail.
  if (initialScreenQueryParameterProvided && initialScreenIndex === 0 && selectedSimScreens.length === 1) {
    // handle gracefully when running without ?ea
    gracefulAssert('initialScreen', initialScreenIndex, 'cannot specify initialScreen=0 for single-screen sims or when only one screen is loaded with screens=n');
  }
  const screens = selectedSimScreens.slice();
  let homeScreen = null;

  // If a sim has multiple screens and the query parameter homeScreen=false is not provided, add a HomeScreen
  if (selectedSimScreens.length > 1 && homeScreenQueryParameter) {
    homeScreen = createHomeScreen(selectedSimScreens);
    screens.unshift(homeScreen);
  }

  // Initial screen is 1-indexed, but taken from the 0-index list of allSimScreens. If the initial screen index is 0, then we need to consider if there is a
  // home screen to show (which "screens" already does for us).
  let initialScreen = initialScreenIndex === 0 ? screens[0] : allSimScreens[initialScreenIndex - 1];
  if (!screens.includes(initialScreen)) {
    gracefulAssert('initialScreen', initialScreenIndex, `invalid initial screen: ${initialScreenIndex}`);
    initialScreen = screens[0];
  }

  // {boolean} indicates whether all possible screens have been created (order-independent)
  const allScreensCreated = _.isEqual(new Set(allSimScreens), new Set(selectedSimScreens)) && (allSimScreens.length > 1 ? !!homeScreen : true);
  return {
    homeScreen: homeScreen,
    initialScreen: initialScreen,
    selectedSimScreens: selectedSimScreens,
    screens: screens,
    allScreensCreated: allScreensCreated
  };
}

// handle gracefully when running without ?ea, and to support setting selectedSimScreens to default values,
// see https://github.com/phetsims/joist/issues/599
function gracefulAssert(key, value, message) {
  // handle gracefully when running without ?ea
  QueryStringMachine.addWarning(key, value, message);

  // to support expected failures in selectScreensTests.js unit tests
  assert && assert(false, message);
}
joist.register('selectScreens', selectScreens);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJqb2lzdCIsInNlbGVjdFNjcmVlbnMiLCJhbGxTaW1TY3JlZW5zIiwiaG9tZVNjcmVlblF1ZXJ5UGFyYW1ldGVyIiwiaG9tZVNjcmVlblF1ZXJ5UGFyYW1ldGVyUHJvdmlkZWQiLCJpbml0aWFsU2NyZWVuSW5kZXgiLCJpbml0aWFsU2NyZWVuUXVlcnlQYXJhbWV0ZXJQcm92aWRlZCIsInNjcmVlbnNRdWVyeVBhcmFtZXRlciIsInNjcmVlbnNRdWVyeVBhcmFtZXRlclByb3ZpZGVkIiwic2V0dXBTY3JlZW5zIiwiY3JlYXRlSG9tZVNjcmVlbiIsImxlbmd0aCIsImdyYWNlZnVsQXNzZXJ0Iiwic2VsZWN0ZWRTaW1TY3JlZW5zIiwiaSIsInVzZXJJbmRleCIsInNjcmVlbkluZGV4IiwicHVzaCIsImVycm9yTWVzc2FnZSIsInNjcmVlbnMiLCJzbGljZSIsImhvbWVTY3JlZW4iLCJ1bnNoaWZ0IiwiaW5pdGlhbFNjcmVlbiIsImluY2x1ZGVzIiwiYWxsU2NyZWVuc0NyZWF0ZWQiLCJfIiwiaXNFcXVhbCIsIlNldCIsImtleSIsInZhbHVlIiwibWVzc2FnZSIsIlF1ZXJ5U3RyaW5nTWFjaGluZSIsImFkZFdhcm5pbmciLCJhc3NlcnQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbInNlbGVjdFNjcmVlbnMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyNCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG5pbXBvcnQgam9pc3QgZnJvbSAnLi9qb2lzdC5qcyc7XHJcbmltcG9ydCBIb21lU2NyZWVuIGZyb20gJy4vSG9tZVNjcmVlbi5qcyc7XHJcbmltcG9ydCB7IEFueVNjcmVlbiB9IGZyb20gJy4vU2NyZWVuLmpzJztcclxuaW1wb3J0IEludGVudGlvbmFsQW55IGZyb20gJy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9JbnRlbnRpb25hbEFueS5qcyc7XHJcblxyXG5leHBvcnQgdHlwZSBTY3JlZW5SZXR1cm5UeXBlID0ge1xyXG4gIGhvbWVTY3JlZW46IEhvbWVTY3JlZW4gfCBudWxsO1xyXG4gIGluaXRpYWxTY3JlZW46IEFueVNjcmVlbjtcclxuICBzZWxlY3RlZFNpbVNjcmVlbnM6IEFueVNjcmVlbltdO1xyXG4gIHNjcmVlbnM6IEFueVNjcmVlbltdO1xyXG4gIGFsbFNjcmVlbnNDcmVhdGVkOiBib29sZWFuO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEdpdmVuIGFuIGFycmF5IG9mIGFsbCBwb3NzaWJsZSBzY3JlZW5zIHRoYXQgYSBzaW0gY2FuIGhhdmUsIHNlbGVjdCBhbmQgb3JkZXIgdGhlbSBhY2NvcmRpbmcgdG8gdGhlIHJlbGV2YW50IHF1ZXJ5XHJcbiAqIHBhcmFtZXRlcnMuIFRoaXMgYWxzbyB3aWxsIGNyZWF0ZSBhIGhvbWVTY3JlZW4gaWYgbmVlZGVkLCBhbmQgc3BlY2lmeSB0aGUgaW5pdGlhbFNjcmVlbiBmb3Igc3RhcnR1cC5cclxuICpcclxuICogUGFyYW1ldGVycyBzdWZmaXhlZCB3aXRoIFwiUHJvdmlkZWRcIiB3aWxsIGJlIHRydWUgaWYgdGhlIHRoYXQgcXVlcnkgcGFyYW1ldGVyIHdhcyBhY3R1YWxseSBpbiB0aGUgVVJMLCBhcyBvcHBvc2VkIHRvXHJcbiAqIHRoZSB2YWx1ZSBvZiB0aGUgcXVlcnkgcGFyYW1ldGVyIGJlaW5nIHRoZSBkZWZhdWx0LlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIEtsdXNlbmRvcmYgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgTWljaGFlbCBLYXV6bWFubiAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICpcclxuICogQHBhcmFtIGFsbFNpbVNjcmVlbnMgLSBhbGwgb2YgdGhlIHNjcmVlbnMgZGVjbGFyZWQgYnkgdGhlIHNpbSwgZHVjay10eXBlZCBmb3IgdGVzdHNcclxuICogQHBhcmFtIGhvbWVTY3JlZW5RdWVyeVBhcmFtZXRlciAtIGZyb20gcGhldC5jaGlwcGVyLnF1ZXJ5UGFyYW1ldGVycy5ob21lU2NyZWVuXHJcbiAqIEBwYXJhbSBob21lU2NyZWVuUXVlcnlQYXJhbWV0ZXJQcm92aWRlZFxyXG4gKiBAcGFyYW0gaW5pdGlhbFNjcmVlbkluZGV4IC0gZnJvbSBwaGV0LmNoaXBwZXIucXVlcnlQYXJhbWV0ZXJzLmluaXRpYWxTY3JlZW5cclxuICogQHBhcmFtIGluaXRpYWxTY3JlZW5RdWVyeVBhcmFtZXRlclByb3ZpZGVkXHJcbiAqIEBwYXJhbSBzY3JlZW5zUXVlcnlQYXJhbWV0ZXIgLSBmcm9tIHBoZXQuY2hpcHBlci5xdWVyeVBhcmFtZXRlcnMuc2NyZWVuc1xyXG4gKiBAcGFyYW0gc2NyZWVuc1F1ZXJ5UGFyYW1ldGVyUHJvdmlkZWRcclxuICogQHBhcmFtIGNyZWF0ZUhvbWVTY3JlZW5cclxuICogQHJldHVybnMgLSBkdWNrLXR5cGVkIGZvciB0ZXN0c1xyXG4gKiBAdGhyb3dzIEVycm9yIGlmIGluY29tcGF0aWJsZSBkYXRhIGlzIHByb3ZpZGVkXHJcbiAqL1xyXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBzZWxlY3RTY3JlZW5zKCBhbGxTaW1TY3JlZW5zOiBBbnlTY3JlZW5bXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9tZVNjcmVlblF1ZXJ5UGFyYW1ldGVyOiBib29sZWFuLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBob21lU2NyZWVuUXVlcnlQYXJhbWV0ZXJQcm92aWRlZDogYm9vbGVhbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbFNjcmVlbkluZGV4OiBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxTY3JlZW5RdWVyeVBhcmFtZXRlclByb3ZpZGVkOiBib29sZWFuLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5zUXVlcnlQYXJhbWV0ZXI6IG51bWJlcltdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5zUXVlcnlQYXJhbWV0ZXJQcm92aWRlZDogYm9vbGVhbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dXBTY3JlZW5zOiAoIHNjcmVlbnM6IEFueVNjcmVlbltdICkgPT4gdm9pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlSG9tZVNjcmVlbjogKCBzY3JlZW5zOiBBbnlTY3JlZW5bXSApID0+IEhvbWVTY3JlZW4gKTogU2NyZWVuUmV0dXJuVHlwZSB7XHJcblxyXG4gIGlmICggYWxsU2ltU2NyZWVucy5sZW5ndGggPT09IDEgJiYgaG9tZVNjcmVlblF1ZXJ5UGFyYW1ldGVyUHJvdmlkZWQgJiYgaG9tZVNjcmVlblF1ZXJ5UGFyYW1ldGVyICkge1xyXG4gICAgZ3JhY2VmdWxBc3NlcnQoICdob21lU2NyZWVuJywgaG9tZVNjcmVlblF1ZXJ5UGFyYW1ldGVyLCAnY2Fubm90IHNwZWNpZnkgaG9tZVNjcmVlbj10cnVlIGZvciBzaW5nbGUtc2NyZWVuIHNpbXMnICk7XHJcbiAgfVxyXG5cclxuICAvLyB0aGUgb3JkZXJlZCBsaXN0IG9mIHNpbSBzY3JlZW5zIGZvciB0aGlzIHJ1bnRpbWVcclxuICBsZXQgc2VsZWN0ZWRTaW1TY3JlZW5zOiBBbnlTY3JlZW5bXSA9IFtdO1xyXG5cclxuICBpZiAoIHNjcmVlbnNRdWVyeVBhcmFtZXRlclByb3ZpZGVkICYmICggIXNjcmVlbnNRdWVyeVBhcmFtZXRlciB8fCBzY3JlZW5zUXVlcnlQYXJhbWV0ZXIubGVuZ3RoID09PSAwICkgKSB7XHJcbiAgICBncmFjZWZ1bEFzc2VydCggJ3NjcmVlbnMnLCBzY3JlZW5zUXVlcnlQYXJhbWV0ZXIsICdcIj9zY3JlZW5zXCIgcXVlcnkgcGFyYW1ldGVyIG11c3QgaGF2ZSBzY3JlZW4gdmFsdWVzJyApO1xyXG4gICAgc2VsZWN0ZWRTaW1TY3JlZW5zID0gYWxsU2ltU2NyZWVucztcclxuICB9XHJcblxyXG4gIC8vIElmIGEgc3Vic2V0IG9mIHNjcmVlbnMgd2FzIHNwZWNpZmllZCB3aXRoIHRoZSBgc2NyZWVuc2AgcXVlcnkgcGFyYW1ldGVyLCBhZGQgdGhlbSB0byBzZWxlY3RlZFNpbVNjcmVlbnMuIE90aGVyd2lzZSxcclxuICAvLyB1c2UgYWxsIG9mIHRoZSBhdmFpbGFibGUgc2ltIHNjcmVlbnMgYXMgdGhlIGRlZmF1bHQuIE5vdGUgdGhhdCBpZiB0aGUgdmFsdWUgb2YgYHNjcmVlbnNgIGRpZCBub3QgcGFzcyB2YWxpZGF0aW9uXHJcbiAgLy8gaW4gUXVlcnlTdHJpbmdNYWNoaW5lLCBpdCB3aWxsIGJlIHJldmVydGVkIHRvIGl0cyBkZWZhdWx0IHZhbHVlIG9mIGBudWxsYCwgc28gaXQgYWxzbyBuZWVkcyB0byBiZSBjaGVja2VkIGZvclxyXG4gIC8vIHRydXRoaW5lc3MgYmVmb3JlIGF0dGVtcHRpbmcgdG8gdXNlIGl0LiBGb3IgYHNjcmVlbnNgIGRvY3VtZW50YXRpb24sIHNlZSB0aGUgc2NoZW1hIGF0XHJcbiAgLy8gcGhldC5jaGlwcGVyLnF1ZXJ5UGFyYW1ldGVycy5zY3JlZW5zIGluIGluaXRpYWxpemUtZ2xvYmFscy5qcy5cclxuICBpZiAoIHNjcmVlbnNRdWVyeVBhcmFtZXRlclByb3ZpZGVkICYmIHNjcmVlbnNRdWVyeVBhcmFtZXRlciApIHtcclxuXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBzY3JlZW5zUXVlcnlQYXJhbWV0ZXIubGVuZ3RoOyBpKysgKSB7XHJcblxyXG4gICAgICBjb25zdCB1c2VySW5kZXggPSBzY3JlZW5zUXVlcnlQYXJhbWV0ZXJbIGkgXTtcclxuICAgICAgY29uc3Qgc2NyZWVuSW5kZXggPSB1c2VySW5kZXggLSAxOyAvLyBzY3JlZW5zIHF1ZXJ5IHBhcmFtZXRlciB1c2VzIDEtYmFzZWQgaW5kaWNlcywgc28gY29udmVydCB0byAwLWJhc2VkIGluZGV4XHJcblxyXG4gICAgICBpZiAoIHNjcmVlbkluZGV4ID49IDAgJiYgc2NyZWVuSW5kZXggPCBhbGxTaW1TY3JlZW5zLmxlbmd0aCApIHtcclxuXHJcbiAgICAgICAgLy8gaW5kZXggaXMgdmFsaWQsIGFkZCBzY3JlZW5cclxuICAgICAgICBzZWxlY3RlZFNpbVNjcmVlbnMucHVzaCggYWxsU2ltU2NyZWVuc1sgc2NyZWVuSW5kZXggXSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBpbmRleCBpcyBpbnZhbGlkXHJcbiAgICAgICAgZ3JhY2VmdWxBc3NlcnQoICdzY3JlZW5zJywgc2NyZWVuc1F1ZXJ5UGFyYW1ldGVyLCBgaW52YWxpZCB2YWx1ZSBpbiBzY3JlZW5zIHF1ZXJ5IHBhcmFtZXRlcjogJHt1c2VySW5kZXh9YCApO1xyXG4gICAgICAgIHNlbGVjdGVkU2ltU2NyZWVucyA9IGFsbFNpbVNjcmVlbnM7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgZWxzZSB7XHJcbiAgICBzZWxlY3RlZFNpbVNjcmVlbnMgPSBhbGxTaW1TY3JlZW5zO1xyXG4gIH1cclxuXHJcbiAgc2V0dXBTY3JlZW5zKCBzZWxlY3RlZFNpbVNjcmVlbnMgKTtcclxuXHJcbiAgLy8gU3BlY2lmeWluZyA/aG9tZVNjcmVlbj1mYWxzZSBjcmVhdGVzIGEgc2ltdWxhdGlvbiB3aXRoIG5vIEhvbWVTY3JlZW4sIGFuZCBoZW5jZSBpcyBpbmNvbXBhdGlibGUgd2l0aFxyXG4gIC8vID9pbml0aWFsU2NyZWVuPTAsIHdoaWNoIHNwZWNpZmllcyB0byBzaG93IHRoZSBob21lIHNjcmVlbi4gTm90ZSB0aGF0IHRoZSBkZWZhdWx0IHZhbHVlIG9mIGluaXRpYWxTY3JlZW46MCBpc1xyXG4gIC8vIGlnbm9yZWQgd2hlbiB0aGVyZSBpcyBubyBIb21lU2NyZWVuLlxyXG4gIGlmICggaW5pdGlhbFNjcmVlblF1ZXJ5UGFyYW1ldGVyUHJvdmlkZWQgJiYgaW5pdGlhbFNjcmVlbkluZGV4ID09PSAwICYmICFob21lU2NyZWVuUXVlcnlQYXJhbWV0ZXIgKSB7XHJcbiAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSAnY2Fubm90IHNwZWNpZnkgaW5pdGlhbFNjcmVlbj0wIHdoZW4gaG9tZSBzY3JlZW4gaXMgZGlzYWJsZWQgd2l0aCBob21lU2NyZWVuPWZhbHNlJztcclxuXHJcbiAgICBncmFjZWZ1bEFzc2VydCggJ2luaXRpYWxTY3JlZW4nLCBpbml0aWFsU2NyZWVuSW5kZXgsIGVycm9yTWVzc2FnZSApO1xyXG4gICAgZ3JhY2VmdWxBc3NlcnQoICdob21lU2NyZWVuJywgaG9tZVNjcmVlblF1ZXJ5UGFyYW1ldGVyLCBlcnJvck1lc3NhZ2UgKTtcclxuICB9XHJcblxyXG4gIC8vIEZvciBhIHNpbmdsZSBzY3JlZW4gc2ltdWxhdGlvbiAod2hldGhlciB0aGUgc2ltdWxhdGlvbiBvbmx5IGRlY2xhcmVzIG9uZSBzY3JlZW4sIG9yIHdoZXRoZXIgdGhlIHVzZXIgaGFzIHNwZWNpZmllZFxyXG4gIC8vIGEgc2luZ2xlIHNjcmVlbiB2aWEgP3NjcmVlbnMpLCB0aGVyZSBpcyBubyBIb21lU2NyZWVuLCBhbmQgaGVuY2UgP2luaXRpYWxTY3JlZW49MCB3aGljaCByZXF1ZXN0cyB0byBzaG93IHRoZVxyXG4gIC8vIEhvbWVTY3JlZW4gb24gc3RhcnR1cCBzaG91bGQgZmFpbC5cclxuICBpZiAoIGluaXRpYWxTY3JlZW5RdWVyeVBhcmFtZXRlclByb3ZpZGVkICYmIGluaXRpYWxTY3JlZW5JbmRleCA9PT0gMCAmJiBzZWxlY3RlZFNpbVNjcmVlbnMubGVuZ3RoID09PSAxICkge1xyXG5cclxuICAgIC8vIGhhbmRsZSBncmFjZWZ1bGx5IHdoZW4gcnVubmluZyB3aXRob3V0ID9lYVxyXG4gICAgZ3JhY2VmdWxBc3NlcnQoICdpbml0aWFsU2NyZWVuJywgaW5pdGlhbFNjcmVlbkluZGV4LFxyXG4gICAgICAnY2Fubm90IHNwZWNpZnkgaW5pdGlhbFNjcmVlbj0wIGZvciBzaW5nbGUtc2NyZWVuIHNpbXMgb3Igd2hlbiBvbmx5IG9uZSBzY3JlZW4gaXMgbG9hZGVkIHdpdGggc2NyZWVucz1uJyApO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2NyZWVucyA9IHNlbGVjdGVkU2ltU2NyZWVucy5zbGljZSgpO1xyXG5cclxuICBsZXQgaG9tZVNjcmVlbiA9IG51bGw7XHJcblxyXG4gIC8vIElmIGEgc2ltIGhhcyBtdWx0aXBsZSBzY3JlZW5zIGFuZCB0aGUgcXVlcnkgcGFyYW1ldGVyIGhvbWVTY3JlZW49ZmFsc2UgaXMgbm90IHByb3ZpZGVkLCBhZGQgYSBIb21lU2NyZWVuXHJcbiAgaWYgKCBzZWxlY3RlZFNpbVNjcmVlbnMubGVuZ3RoID4gMSAmJiBob21lU2NyZWVuUXVlcnlQYXJhbWV0ZXIgKSB7XHJcbiAgICBob21lU2NyZWVuID0gY3JlYXRlSG9tZVNjcmVlbiggc2VsZWN0ZWRTaW1TY3JlZW5zICk7XHJcbiAgICBzY3JlZW5zLnVuc2hpZnQoIGhvbWVTY3JlZW4gKTtcclxuICB9XHJcblxyXG4gIC8vIEluaXRpYWwgc2NyZWVuIGlzIDEtaW5kZXhlZCwgYnV0IHRha2VuIGZyb20gdGhlIDAtaW5kZXggbGlzdCBvZiBhbGxTaW1TY3JlZW5zLiBJZiB0aGUgaW5pdGlhbCBzY3JlZW4gaW5kZXggaXMgMCwgdGhlbiB3ZSBuZWVkIHRvIGNvbnNpZGVyIGlmIHRoZXJlIGlzIGFcclxuICAvLyBob21lIHNjcmVlbiB0byBzaG93ICh3aGljaCBcInNjcmVlbnNcIiBhbHJlYWR5IGRvZXMgZm9yIHVzKS5cclxuICBsZXQgaW5pdGlhbFNjcmVlbiA9IGluaXRpYWxTY3JlZW5JbmRleCA9PT0gMCA/IHNjcmVlbnNbIDAgXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogYWxsU2ltU2NyZWVuc1sgaW5pdGlhbFNjcmVlbkluZGV4IC0gMSBdO1xyXG5cclxuICBpZiAoICFzY3JlZW5zLmluY2x1ZGVzKCBpbml0aWFsU2NyZWVuICkgKSB7XHJcbiAgICBncmFjZWZ1bEFzc2VydCggJ2luaXRpYWxTY3JlZW4nLCBpbml0aWFsU2NyZWVuSW5kZXgsIGBpbnZhbGlkIGluaXRpYWwgc2NyZWVuOiAke2luaXRpYWxTY3JlZW5JbmRleH1gICk7XHJcbiAgICBpbml0aWFsU2NyZWVuID0gc2NyZWVuc1sgMCBdO1xyXG4gIH1cclxuXHJcbiAgLy8ge2Jvb2xlYW59IGluZGljYXRlcyB3aGV0aGVyIGFsbCBwb3NzaWJsZSBzY3JlZW5zIGhhdmUgYmVlbiBjcmVhdGVkIChvcmRlci1pbmRlcGVuZGVudClcclxuICBjb25zdCBhbGxTY3JlZW5zQ3JlYXRlZCA9IF8uaXNFcXVhbCggbmV3IFNldCggYWxsU2ltU2NyZWVucyApLCBuZXcgU2V0KCBzZWxlY3RlZFNpbVNjcmVlbnMgKSApICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIGFsbFNpbVNjcmVlbnMubGVuZ3RoID4gMSA/ICEhaG9tZVNjcmVlbiA6IHRydWUgKTtcclxuICByZXR1cm4ge1xyXG4gICAgaG9tZVNjcmVlbjogaG9tZVNjcmVlbixcclxuICAgIGluaXRpYWxTY3JlZW46IGluaXRpYWxTY3JlZW4sXHJcbiAgICBzZWxlY3RlZFNpbVNjcmVlbnM6IHNlbGVjdGVkU2ltU2NyZWVucyxcclxuICAgIHNjcmVlbnM6IHNjcmVlbnMsXHJcbiAgICBhbGxTY3JlZW5zQ3JlYXRlZDogYWxsU2NyZWVuc0NyZWF0ZWRcclxuICB9O1xyXG59XHJcblxyXG4vLyBoYW5kbGUgZ3JhY2VmdWxseSB3aGVuIHJ1bm5pbmcgd2l0aG91dCA/ZWEsIGFuZCB0byBzdXBwb3J0IHNldHRpbmcgc2VsZWN0ZWRTaW1TY3JlZW5zIHRvIGRlZmF1bHQgdmFsdWVzLFxyXG4vLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy81OTlcclxuZnVuY3Rpb24gZ3JhY2VmdWxBc3NlcnQoIGtleTogc3RyaW5nLCB2YWx1ZTogSW50ZW50aW9uYWxBbnksIG1lc3NhZ2U6IHN0cmluZyApOiB2b2lkIHtcclxuXHJcbiAgLy8gaGFuZGxlIGdyYWNlZnVsbHkgd2hlbiBydW5uaW5nIHdpdGhvdXQgP2VhXHJcbiAgUXVlcnlTdHJpbmdNYWNoaW5lLmFkZFdhcm5pbmcoIGtleSwgdmFsdWUsIG1lc3NhZ2UgKTtcclxuXHJcbiAgLy8gdG8gc3VwcG9ydCBleHBlY3RlZCBmYWlsdXJlcyBpbiBzZWxlY3RTY3JlZW5zVGVzdHMuanMgdW5pdCB0ZXN0c1xyXG4gIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCBtZXNzYWdlICk7XHJcbn1cclxuXHJcbmpvaXN0LnJlZ2lzdGVyKCAnc2VsZWN0U2NyZWVucycsIHNlbGVjdFNjcmVlbnMgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE9BQU9BLEtBQUssTUFBTSxZQUFZO0FBYTlCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSxTQUFTQyxhQUFhQSxDQUFFQyxhQUEwQixFQUMxQkMsd0JBQWlDLEVBQ2pDQyxnQ0FBeUMsRUFDekNDLGtCQUEwQixFQUMxQkMsbUNBQTRDLEVBQzVDQyxxQkFBK0IsRUFDL0JDLDZCQUFzQyxFQUN0Q0MsWUFBOEMsRUFDOUNDLGdCQUF3RCxFQUFxQjtFQUVsSCxJQUFLUixhQUFhLENBQUNTLE1BQU0sS0FBSyxDQUFDLElBQUlQLGdDQUFnQyxJQUFJRCx3QkFBd0IsRUFBRztJQUNoR1MsY0FBYyxDQUFFLFlBQVksRUFBRVQsd0JBQXdCLEVBQUUsdURBQXdELENBQUM7RUFDbkg7O0VBRUE7RUFDQSxJQUFJVSxrQkFBK0IsR0FBRyxFQUFFO0VBRXhDLElBQUtMLDZCQUE2QixLQUFNLENBQUNELHFCQUFxQixJQUFJQSxxQkFBcUIsQ0FBQ0ksTUFBTSxLQUFLLENBQUMsQ0FBRSxFQUFHO0lBQ3ZHQyxjQUFjLENB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