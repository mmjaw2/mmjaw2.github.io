// Copyright 2018-2024, University of Colorado Boulder

/**
 * SoundGenerator is an abstract base class for Web-Audio-based sound-producing elements that work in conjunction with
 * the soundManager to produces sounds.
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../axon/js/DerivedProperty.js';
import createObservableArray from '../../../axon/js/createObservableArray.js';
import optionize from '../../../phet-core/js/optionize.js';
import Tandem from '../../../tandem/js/Tandem.js';
import phetAudioContext from '../phetAudioContext.js';
import soundConstants from '../soundConstants.js';
import tambo from '../tambo.js';
import isSettingPhetioStateProperty from '../../../tandem/js/isSettingPhetioStateProperty.js';
import Disposable from '../../../axon/js/Disposable.js';

// constants
const DEFAULT_TIME_CONSTANT = soundConstants.DEFAULT_PARAM_CHANGE_TIME_CONSTANT;
const notSettingPhetioStateProperty = DerivedProperty.not(isSettingPhetioStateProperty);
class SoundGenerator extends Disposable {
  // a list of all audio nodes to which this sound generator is connected

  // A set of boolean Properties that collectively control whether the sound generator is enabled.  All of these must be
  // true in order for the sound generator to be "fully enabled", meaning that it will produce sound.

  // A Property that tracks whether this sound generator is fully enabled, meaning that all the enable control
  // Properties are in a state indicating that sound can be produced.  This should only be updated in the listener
  // function defined below, nowhere else.

  // A Property that tracks whether this sound generator is "locally enabled", which means that it is internally set to
  // produce sound.  Setting this to true does not guarantee that sound will be produced, since other Properties can all
  // affect this, see fullyEnabledProperty.

  // main gain control that will be used to control the volume of the sound

  // The audio node to which the sound sources will connect, analogous to AudioContext.destination.  If no additional
  // audio nodes were provided upon construction, this will be the main gain node.

  constructor(providedOptions) {
    super();
    const options = optionize()({
      initialOutputLevel: 1,
      audioContext: phetAudioContext,
      connectImmediately: false,
      enableControlProperties: [],
      additionalAudioNodes: [],
      enabledDuringPhetioStateSetting: false
    }, providedOptions);
    this.audioContext = options.audioContext;
    this._outputLevel = options.initialOutputLevel;
    this.connectionList = [];
    this.enableControlProperties = createObservableArray();
    this.fullyEnabledProperty = new BooleanProperty(true);

    // listener that updates the state of fullyEnabledProperty
    const updateFullyEnabledState = () => {
      this.fullyEnabledProperty.value = _.every(this.enableControlProperties, enableControlProperty => enableControlProperty.value);
    };

    // Listen for new enable control Properties and hook them up as they arrive.
    this.enableControlProperties.addItemAddedListener(addedItem => {
      addedItem.link(updateFullyEnabledState);
      const checkAndRemove = removedItem => {
        if (removedItem === addedItem) {
          removedItem.unlink(updateFullyEnabledState);
          this.enableControlProperties.removeItemRemovedListener(checkAndRemove);
        }
      };
      this.enableControlProperties.addItemRemovedListener(checkAndRemove);
    });

    // Add any enable control Properties that were provided in the options object.
    options.enableControlProperties.forEach(enableControlProperty => {
      this.addEnableControlProperty(enableControlProperty);
    });
    this.locallyEnabledProperty = new BooleanProperty(true);

    // Add the local Property to the list of enable controls.
    this.addEnableControlProperty(this.locallyEnabledProperty);
    this.mainGainNode = this.audioContext.createGain();
    this.mainGainNode.gain.setValueAtTime(this._outputLevel, this.audioContext.currentTime);

    // If the option specifies immediate connection, connect the main gain node to the audio context destination.
    if (options.connectImmediately) {
      this.mainGainNode.connect(this.audioContext.destination);
    }

    // Turn down the gain to zero when not fully enabled and up to the current output level when becoming fully enabled.
    this.fullyEnabledProperty.link(fullyEnabled => {
      const previousGainSetting = fullyEnabled ? 0 : this._outputLevel;
      const newGainSetting = fullyEnabled ? this._outputLevel : 0;
      const now = this.audioContext.currentTime;

      // For the linear ramp to work consistently on all browsers, the gain must be explicitly set to what it is
      // supposed to be before making any changes.  Otherwise, it may extrapolate from the most recent previous event.
      this.mainGainNode.gain.setValueAtTime(previousGainSetting, now);

      // Ramp the gain to the new level.
      this.mainGainNode.gain.linearRampToValueAtTime(newGainSetting, this.audioContext.currentTime + soundConstants.DEFAULT_LINEAR_GAIN_CHANGE_TIME);
    });
    this.soundSourceDestination = this.mainGainNode;

    // Insert any additional audio nodes into the signal chain by iterating backwards through the provided list.
    for (let i = options.additionalAudioNodes.length - 1; i >= 0; i--) {
      const audioNode = options.additionalAudioNodes[i];
      audioNode.connect(this.soundSourceDestination);
      this.soundSourceDestination = audioNode;
    }

    // Make sure that this sound never plays when setting PhET-iO state
    if (Tandem.PHET_IO_ENABLED && !options.enabledDuringPhetioStateSetting) {
      this.addEnableControlProperty(notSettingPhetioStateProperty);
    }

    // Clean up memory references when this object is disposed to avoid memory leaks.
    this.disposeEmitter.addListener(() => {
      // Clearing this observable array should cause the Properties within it to be unlinked.
      this.enableControlProperties.clear();
    });
  }

  /**
   * Connect the sound generator to an audio parameter.
   */
  connect(audioParam) {
    this.mainGainNode.connect(audioParam);

    // Track this sound generator's connections.  This is necessary because Web Audio doesn't support checking which
    // nodes are connected to which, and we need this information when disconnecting.
    this.connectionList.push(audioParam);
  }

  /**
   * Disconnect the sound generator from an audio parameter.
   */
  disconnect(audioParam) {
    this.mainGainNode.disconnect(audioParam);
    this.connectionList = _.without(this.connectionList, audioParam);
  }

  /**
   * Test if this sound generator is connected to the provided audio param.
   */
  isConnectedTo(audioParam) {
    return this.connectionList.includes(audioParam);
  }

  /**
   * Sets the output level of the sound generator.
   *
   * @param outputLevel - generally between 0 and 1, but can be larger than 1 if necessary to amplify a small signal,
   *   and can be negative to invert the phase.
   * @param [timeConstant] - time constant for output level change, longer values mean slower transitions, in seconds.
   *   Note that timeConstant is NOT a fade time. It's an exponential approach to the target output level, and the argument to
   *   setTargetAtTime, documented at https://developer.mozilla.org/en-US/docs/Web/API/AudioParam/setTargetAtTime#timeconstant
   *   The document has this suggestion for choosing the value for timeConstant: "Depending on your use case, getting
   *   95% toward the target value may already be enough; in that case, you could set timeConstant to one third of the
   *   desired duration."
   */
  setOutputLevel(outputLevel, timeConstant = DEFAULT_TIME_CONSTANT) {
    // Ignore attempts to set the output level to the same value.
    if (outputLevel !== this._outputLevel) {
      const now = this.audioContext.currentTime;

      // The output level should take effect immediately if this sound generator is fully enabled.  Otherwise, the value
      // is saved and restored the next time the sound generator transitions to fully enabled.
      if (this.fullyEnabledProperty.value) {
        // Cancel any gain transitions that are currently in progress.
        this.mainGainNode.gain.cancelScheduledValues(now);

        // Set the output level on the gain node.  A different method is used for instant changes.
        if (timeConstant === 0) {
          this.mainGainNode.gain.setValueAtTime(outputLevel, now);
        } else {
          // The setTargetAtTime method doesn't seem to work if the audio context isn't running, and the event doesn't
          // seem to be scheduled - it's just ignored.  So, if the audio context isn't running, use an alternative
          // approach.  See https://github.com/phetsims/tambo/issues/74.
          if (this.audioContext.state === 'running') {
            this.mainGainNode.gain.setTargetAtTime(outputLevel, now, timeConstant);
          } else {
            this.mainGainNode.gain.linearRampToValueAtTime(outputLevel, now + soundConstants.DEFAULT_LINEAR_GAIN_CHANGE_TIME);
          }
        }
      }

      // Set local copy of output level.
      this._outputLevel = outputLevel;
    }
  }
  set outputLevel(outputLevel) {
    this.setOutputLevel(outputLevel);
  }
  get outputLevel() {
    return this.getOutputLevel();
  }

  /**
   * Get the current output level setting.  Note that if the sound generator is disabled, this could return a non-zero
   * value but the sound generator won't produce audible sound.
   */
  getOutputLevel() {
    return this._outputLevel;
  }

  /**
   * Add a Property to the list of those used to control the enabled state of this sound generator.
   */
  addEnableControlProperty(enableControlProperty) {
    this.enableControlProperties.push(enableControlProperty);
  }

  /**
   * Remove a Property from the list of those used to control the enabled state of this sound generator.
   */
  removeEnableControlProperty(enableControlProperty) {
    this.enableControlProperties.remove(enableControlProperty);
  }
  get locallyEnabled() {
    return this.locallyEnabledProperty.value;
  }
  set locallyEnabled(locallyEnabled) {
    this.locallyEnabledProperty.value = locallyEnabled;
  }
  get fullyEnabled() {
    return this.fullyEnabledProperty.value;
  }
}
tambo.register('SoundGenerator', SoundGenerator);
export default SoundGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJjcmVhdGVPYnNlcnZhYmxlQXJyYXkiLCJvcHRpb25pemUiLCJUYW5kZW0iLCJwaGV0QXVkaW9Db250ZXh0Iiwic291bmRDb25zdGFudHMiLCJ0YW1ibyIsImlzU2V0dGluZ1BoZXRpb1N0YXRlUHJvcGVydHkiLCJEaXNwb3NhYmxlIiwiREVGQVVMVF9USU1FX0NPTlNUQU5UIiwiREVGQVVMVF9QQVJBTV9DSEFOR0VfVElNRV9DT05TVEFOVCIsIm5vdFNldHRpbmdQaGV0aW9TdGF0ZVByb3BlcnR5Iiwibm90IiwiU291bmRHZW5lcmF0b3IiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJpbml0aWFsT3V0cHV0TGV2ZWwiLCJhdWRpb0NvbnRleHQiLCJjb25uZWN0SW1tZWRpYXRlbHkiLCJlbmFibGVDb250cm9sUHJvcGVydGllcyIsImFkZGl0aW9uYWxBdWRpb05vZGVzIiwiZW5hYmxlZER1cmluZ1BoZXRpb1N0YXRlU2V0dGluZyIsIl9vdXRwdXRMZXZlbCIsImNvbm5lY3Rpb25MaXN0IiwiZnVsbHlFbmFibGVkUHJvcGVydHkiLCJ1cGRhdGVGdWxseUVuYWJsZWRTdGF0ZSIsInZhbHVlIiwiXyIsImV2ZXJ5IiwiZW5hYmxlQ29udHJvbFByb3BlcnR5IiwiYWRkSXRlbUFkZGVkTGlzdGVuZXIiLCJhZGRlZEl0ZW0iLCJsaW5rIiwiY2hlY2tBbmRSZW1vdmUiLCJyZW1vdmVkSXRlbSIsInVubGluayIsInJlbW92ZUl0ZW1SZW1vdmVkTGlzdGVuZXIiLCJhZGRJdGVtUmVtb3ZlZExpc3RlbmVyIiwiZm9yRWFjaCIsImFkZEVuYWJsZUNvbnRyb2xQcm9wZXJ0eSIsImxvY2FsbHlFbmFibGVkUHJvcGVydHkiLCJtYWluR2Fpbk5vZGUiLCJjcmVhdGVHYWluIiwiZ2FpbiIsInNldFZhbHVlQXRUaW1lIiwiY3VycmVudFRpbWUiLCJjb25uZWN0IiwiZGVzdGluYXRpb24iLCJmdWxseUVuYWJsZWQiLCJwcmV2aW91c0dhaW5TZXR0aW5nIiwibmV3R2FpblNldHRpbmciLCJub3ciLCJsaW5lYXJSYW1wVG9WYWx1ZUF0VGltZSIsIkRFRkFVTFRfTElORUFSX0dBSU5fQ0hBTkdFX1RJTUUiLCJzb3VuZFNvdXJjZURlc3RpbmF0aW9uIiwiaSIsImxlbmd0aCIsImF1ZGlvTm9kZSIsIlBIRVRfSU9fRU5BQkxFRCIsImRpc3Bvc2VFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJjbGVhciIsImF1ZGlvUGFyYW0iLCJwdXNoIiwiZGlzY29ubmVjdCIsIndpdGhvdXQiLCJpc0Nvbm5lY3RlZFRvIiwiaW5jbHVkZXMiLCJzZXRPdXRwdXRMZXZlbCIsIm91dHB1dExldmVsIiwidGltZUNvbnN0YW50IiwiY2FuY2VsU2NoZWR1bGVkVmFsdWVzIiwic3RhdGUiLCJzZXRUYXJnZXRBdFRpbWUiLCJnZXRPdXRwdXRMZXZlbCIsInJlbW92ZUVuYWJsZUNvbnRyb2xQcm9wZXJ0eSIsInJlbW92ZSIsImxvY2FsbHlFbmFibGVkIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJTb3VuZEdlbmVyYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTb3VuZEdlbmVyYXRvciBpcyBhbiBhYnN0cmFjdCBiYXNlIGNsYXNzIGZvciBXZWItQXVkaW8tYmFzZWQgc291bmQtcHJvZHVjaW5nIGVsZW1lbnRzIHRoYXQgd29yayBpbiBjb25qdW5jdGlvbiB3aXRoXHJcbiAqIHRoZSBzb3VuZE1hbmFnZXIgdG8gcHJvZHVjZXMgc291bmRzLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IGNyZWF0ZU9ic2VydmFibGVBcnJheSwgeyBPYnNlcnZhYmxlQXJyYXkgfSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL2NyZWF0ZU9ic2VydmFibGVBcnJheS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBwaGV0QXVkaW9Db250ZXh0IGZyb20gJy4uL3BoZXRBdWRpb0NvbnRleHQuanMnO1xyXG5pbXBvcnQgc291bmRDb25zdGFudHMgZnJvbSAnLi4vc291bmRDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgdGFtYm8gZnJvbSAnLi4vdGFtYm8uanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9UUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBpc1NldHRpbmdQaGV0aW9TdGF0ZVByb3BlcnR5IGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9pc1NldHRpbmdQaGV0aW9TdGF0ZVByb3BlcnR5LmpzJztcclxuaW1wb3J0IERpc3Bvc2FibGUgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9EaXNwb3NhYmxlLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBERUZBVUxUX1RJTUVfQ09OU1RBTlQgPSBzb3VuZENvbnN0YW50cy5ERUZBVUxUX1BBUkFNX0NIQU5HRV9USU1FX0NPTlNUQU5UO1xyXG5cclxuY29uc3Qgbm90U2V0dGluZ1BoZXRpb1N0YXRlUHJvcGVydHkgPSBEZXJpdmVkUHJvcGVydHkubm90KCBpc1NldHRpbmdQaGV0aW9TdGF0ZVByb3BlcnR5ICk7XHJcblxyXG5leHBvcnQgdHlwZSBTb3VuZEdlbmVyYXRvck9wdGlvbnMgPSB7XHJcblxyXG4gIC8vIEluaXRpYWwgdmFsdWUgZm9yIHRoZSBvdXRwdXQgbGV2ZWwuICBHZW5lcmFsbHksIHRoaXMgc2hvdWxkIGFsd2F5cyBiZSBiZXR3ZWVuIDAgYW5kIDEsIGJ1dCB2YWx1ZXMgZ3JlYXRlciB0aGFuIDFcclxuICAvLyBtYXkgYmUgbmVlZGVkIGluIHNvbWUgcmFyZSBjYXNlcyBpbiBvcmRlciB0byBjcmVhdGUgZW5vdWdoIG91dHB1dCB0byBiZSBhdWRpYmxlLlxyXG4gIGluaXRpYWxPdXRwdXRMZXZlbD86IG51bWJlcjtcclxuXHJcbiAgLy8gQnkgZGVmYXVsdCwgdGhlIHNoYXJlZCBhdWRpbyBjb250ZXh0IGlzIHVzZWQgc28gdGhhdCB0aGlzIHNvdW5kIGNhbiBiZSByZWdpc3RlcmVkIHdpdGggdGhlIHNvbmlmaWNhdGlvbiBtYW5hZ2VyLFxyXG4gIC8vIGJ1dCB0aGlzIGNhbiBiZSBvdmVycmlkZGVuIGlmIGRlc2lyZWQuICBJbiBnZW5lcmFsLCBvdmVycmlkaW5nIHdpbGwgb25seSBiZSBkb25lIGZvciB0ZXN0aW5nLlxyXG4gIGF1ZGlvQ29udGV4dD86IEF1ZGlvQ29udGV4dDtcclxuXHJcbiAgLy8gVGhpcyBmbGFnIGNvbnRyb2xzIHdoZXRoZXIgdGhlIG91dHB1dCBvZiB0aGlzIHNvdW5kIGdlbmVyYXRvciBpcyBpbW1lZGlhdGVseSBjb25uZWN0ZWQgdG8gdGhlIGF1ZGlvIGNvbnRleHRcclxuICAvLyBkZXN0aW5hdGlvbi4gIFRoaXMgaXMgdXNlZnVsIGZvciB0ZXN0aW5nLCBidXQgc2hvdWxkIG5vdCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGlzIHNvdW5kIGdlbmVyYXRvciBpcyBiZWluZyB1c2VkXHJcbiAgLy8gaW4gY29uanVuY3Rpb24gd2l0aCB0aGUgc291bmQgbWFuYWdlci5cclxuICBjb25uZWN0SW1tZWRpYXRlbHk/OiBib29sZWFuO1xyXG5cclxuICAvLyBBbiBpbml0aWFsIHNldCBvZiBQcm9wZXJ0aWVzIHRoYXQgd2lsbCBiZSBob29rZWQgdG8gdGhpcyBzb3VuZCBnZW5lcmF0b3IncyBlbmFibGVkIHN0YXRlLCBhbGwgb2Ygd2hpY2ggbXVzdCBiZSB0cnVlXHJcbiAgLy8gZm9yIHNvdW5kIHRvIGJlIHByb2R1Y2VkLiAgTW9yZSBvZiB0aGVzZSBwcm9wZXJ0aWVzIGNhbiBiZSBhZGRlZCBhZnRlciBjb25zdHJ1Y3Rpb24gdmlhIG1ldGhvZHMgaWYgbmVlZGVkLlxyXG4gIGVuYWJsZUNvbnRyb2xQcm9wZXJ0aWVzPzogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj5bXTtcclxuXHJcbiAgLy8gQXVkaW8gbm9kZXMgdGhhdCB3aWxsIGJlIGNvbm5lY3RlZCBpbiB0aGUgc3BlY2lmaWVkIG9yZGVyIGJldHdlZW4gdGhlIGJ1ZmZlclNvdXJjZSBhbmQgbG9jYWxHYWluTm9kZSwgdXNlZCB0b1xyXG4gIC8vIGluc2VydCB0aGluZ3MgbGlrZSBmaWx0ZXJzLCBjb21wcmVzc29ycywgZXRjLlxyXG4gIGFkZGl0aW9uYWxBdWRpb05vZGVzPzogQXVkaW9Ob2RlW107XHJcblxyXG4gIC8vIFdoZW4gZmFsc2UsIGFuIGVuYWJsZS1jb250cm9sIFByb3BlcnR5IHdpbGwgYmUgYWRkZWQgdGhhdCBtdXRlcyB0aGUgc291bmQgd2hlbiBzZXR0aW5nIFBoRVQtaU8gc3RhdGUuIEFsbW9zdCBhbGxcclxuICAvLyBzb3VuZHMgd2FudCB0aGlzIG11dGluZyB0byBvY2N1ciwgcGxlYXNlIHRlc3QgdGhvcm91Z2hseSBiZWZvcmUgdHVybmluZyB0aGlzIG9wdGlvbiBvbi5cclxuICBlbmFibGVkRHVyaW5nUGhldGlvU3RhdGVTZXR0aW5nPzogYm9vbGVhbjtcclxufTtcclxuXHJcbmFic3RyYWN0IGNsYXNzIFNvdW5kR2VuZXJhdG9yIGV4dGVuZHMgRGlzcG9zYWJsZSB7XHJcblxyXG4gIHByb3RlY3RlZCBhdWRpb0NvbnRleHQ6IEF1ZGlvQ29udGV4dDtcclxuICBwcml2YXRlIF9vdXRwdXRMZXZlbDogbnVtYmVyO1xyXG5cclxuICAvLyBhIGxpc3Qgb2YgYWxsIGF1ZGlvIG5vZGVzIHRvIHdoaWNoIHRoaXMgc291bmQgZ2VuZXJhdG9yIGlzIGNvbm5lY3RlZFxyXG4gIHByaXZhdGUgY29ubmVjdGlvbkxpc3Q6ICggQXVkaW9QYXJhbSB8IEF1ZGlvTm9kZSApW107XHJcblxyXG4gIC8vIEEgc2V0IG9mIGJvb2xlYW4gUHJvcGVydGllcyB0aGF0IGNvbGxlY3RpdmVseSBjb250cm9sIHdoZXRoZXIgdGhlIHNvdW5kIGdlbmVyYXRvciBpcyBlbmFibGVkLiAgQWxsIG9mIHRoZXNlIG11c3QgYmVcclxuICAvLyB0cnVlIGluIG9yZGVyIGZvciB0aGUgc291bmQgZ2VuZXJhdG9yIHRvIGJlIFwiZnVsbHkgZW5hYmxlZFwiLCBtZWFuaW5nIHRoYXQgaXQgd2lsbCBwcm9kdWNlIHNvdW5kLlxyXG4gIHByb3RlY3RlZCBlbmFibGVDb250cm9sUHJvcGVydGllczogT2JzZXJ2YWJsZUFycmF5PFRSZWFkT25seVByb3BlcnR5PGJvb2xlYW4+PjtcclxuXHJcbiAgLy8gQSBQcm9wZXJ0eSB0aGF0IHRyYWNrcyB3aGV0aGVyIHRoaXMgc291bmQgZ2VuZXJhdG9yIGlzIGZ1bGx5IGVuYWJsZWQsIG1lYW5pbmcgdGhhdCBhbGwgdGhlIGVuYWJsZSBjb250cm9sXHJcbiAgLy8gUHJvcGVydGllcyBhcmUgaW4gYSBzdGF0ZSBpbmRpY2F0aW5nIHRoYXQgc291bmQgY2FuIGJlIHByb2R1Y2VkLiAgVGhpcyBzaG91bGQgb25seSBiZSB1cGRhdGVkIGluIHRoZSBsaXN0ZW5lclxyXG4gIC8vIGZ1bmN0aW9uIGRlZmluZWQgYmVsb3csIG5vd2hlcmUgZWxzZS5cclxuICBwdWJsaWMgcmVhZG9ubHkgZnVsbHlFbmFibGVkUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+O1xyXG5cclxuICAvLyBBIFByb3BlcnR5IHRoYXQgdHJhY2tzIHdoZXRoZXIgdGhpcyBzb3VuZCBnZW5lcmF0b3IgaXMgXCJsb2NhbGx5IGVuYWJsZWRcIiwgd2hpY2ggbWVhbnMgdGhhdCBpdCBpcyBpbnRlcm5hbGx5IHNldCB0b1xyXG4gIC8vIHByb2R1Y2Ugc291bmQuICBTZXR0aW5nIHRoaXMgdG8gdHJ1ZSBkb2VzIG5vdCBndWFyYW50ZWUgdGhhdCBzb3VuZCB3aWxsIGJlIHByb2R1Y2VkLCBzaW5jZSBvdGhlciBQcm9wZXJ0aWVzIGNhbiBhbGxcclxuICAvLyBhZmZlY3QgdGhpcywgc2VlIGZ1bGx5RW5hYmxlZFByb3BlcnR5LlxyXG4gIHB1YmxpYyByZWFkb25seSBsb2NhbGx5RW5hYmxlZFByb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gbWFpbiBnYWluIGNvbnRyb2wgdGhhdCB3aWxsIGJlIHVzZWQgdG8gY29udHJvbCB0aGUgdm9sdW1lIG9mIHRoZSBzb3VuZFxyXG4gIHByb3RlY3RlZCBtYWluR2Fpbk5vZGU6IEdhaW5Ob2RlO1xyXG5cclxuICAvLyBUaGUgYXVkaW8gbm9kZSB0byB3aGljaCB0aGUgc291bmQgc291cmNlcyB3aWxsIGNvbm5lY3QsIGFuYWxvZ291cyB0byBBdWRpb0NvbnRleHQuZGVzdGluYXRpb24uICBJZiBubyBhZGRpdGlvbmFsXHJcbiAgLy8gYXVkaW8gbm9kZXMgd2VyZSBwcm92aWRlZCB1cG9uIGNvbnN0cnVjdGlvbiwgdGhpcyB3aWxsIGJlIHRoZSBtYWluIGdhaW4gbm9kZS5cclxuICBwcm90ZWN0ZWQgc291bmRTb3VyY2VEZXN0aW5hdGlvbjogQXVkaW9Ob2RlO1xyXG5cclxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IoIHByb3ZpZGVkT3B0aW9ucz86IFNvdW5kR2VuZXJhdG9yT3B0aW9ucyApIHtcclxuXHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8U291bmRHZW5lcmF0b3JPcHRpb25zLCBTb3VuZEdlbmVyYXRvck9wdGlvbnM+KCkoIHtcclxuICAgICAgaW5pdGlhbE91dHB1dExldmVsOiAxLFxyXG4gICAgICBhdWRpb0NvbnRleHQ6IHBoZXRBdWRpb0NvbnRleHQsXHJcbiAgICAgIGNvbm5lY3RJbW1lZGlhdGVseTogZmFsc2UsXHJcbiAgICAgIGVuYWJsZUNvbnRyb2xQcm9wZXJ0aWVzOiBbXSxcclxuICAgICAgYWRkaXRpb25hbEF1ZGlvTm9kZXM6IFtdLFxyXG4gICAgICBlbmFibGVkRHVyaW5nUGhldGlvU3RhdGVTZXR0aW5nOiBmYWxzZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5hdWRpb0NvbnRleHQgPSBvcHRpb25zLmF1ZGlvQ29udGV4dDtcclxuICAgIHRoaXMuX291dHB1dExldmVsID0gb3B0aW9ucy5pbml0aWFsT3V0cHV0TGV2ZWw7XHJcbiAgICB0aGlzLmNvbm5lY3Rpb25MaXN0ID0gW107XHJcbiAgICB0aGlzLmVuYWJsZUNvbnRyb2xQcm9wZXJ0aWVzID0gY3JlYXRlT2JzZXJ2YWJsZUFycmF5KCk7XHJcbiAgICB0aGlzLmZ1bGx5RW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSApO1xyXG5cclxuICAgIC8vIGxpc3RlbmVyIHRoYXQgdXBkYXRlcyB0aGUgc3RhdGUgb2YgZnVsbHlFbmFibGVkUHJvcGVydHlcclxuICAgIGNvbnN0IHVwZGF0ZUZ1bGx5RW5hYmxlZFN0YXRlID0gKCkgPT4ge1xyXG4gICAgICB0aGlzLmZ1bGx5RW5hYmxlZFByb3BlcnR5LnZhbHVlID0gXy5ldmVyeShcclxuICAgICAgICB0aGlzLmVuYWJsZUNvbnRyb2xQcm9wZXJ0aWVzLFxyXG4gICAgICAgICggZW5hYmxlQ29udHJvbFByb3BlcnR5OiBUUHJvcGVydHk8Ym9vbGVhbj4gKSA9PiBlbmFibGVDb250cm9sUHJvcGVydHkudmFsdWVcclxuICAgICAgKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gTGlzdGVuIGZvciBuZXcgZW5hYmxlIGNvbnRyb2wgUHJvcGVydGllcyBhbmQgaG9vayB0aGVtIHVwIGFzIHRoZXkgYXJyaXZlLlxyXG4gICAgdGhpcy5lbmFibGVDb250cm9sUHJvcGVydGllcy5hZGRJdGVtQWRkZWRMaXN0ZW5lciggYWRkZWRJdGVtID0+IHtcclxuICAgICAgYWRkZWRJdGVtLmxpbmsoIHVwZGF0ZUZ1bGx5RW5hYmxlZFN0YXRlICk7XHJcbiAgICAgIGNvbnN0IGNoZWNrQW5kUmVtb3ZlID0gKCByZW1vdmVkSXRlbTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4gKSA9PiB7XHJcbiAgICAgICAgaWYgKCByZW1vdmVkSXRlbSA9PT0gYWRkZWRJdGVtICkge1xyXG4gICAgICAgICAgcmVtb3ZlZEl0ZW0udW5saW5rKCB1cGRhdGVGdWxseUVuYWJsZWRTdGF0ZSApO1xyXG4gICAgICAgICAgdGhpcy5lbmFibGVDb250cm9sUHJvcGVydGllcy5yZW1vdmVJdGVtUmVtb3ZlZExpc3RlbmVyKCBjaGVja0FuZFJlbW92ZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgdGhpcy5lbmFibGVDb250cm9sUHJvcGVydGllcy5hZGRJdGVtUmVtb3ZlZExpc3RlbmVyKCBjaGVja0FuZFJlbW92ZSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEFkZCBhbnkgZW5hYmxlIGNvbnRyb2wgUHJvcGVydGllcyB0aGF0IHdlcmUgcHJvdmlkZWQgaW4gdGhlIG9wdGlvbnMgb2JqZWN0LlxyXG4gICAgb3B0aW9ucy5lbmFibGVDb250cm9sUHJvcGVydGllcy5mb3JFYWNoKCBlbmFibGVDb250cm9sUHJvcGVydHkgPT4ge1xyXG4gICAgICB0aGlzLmFkZEVuYWJsZUNvbnRyb2xQcm9wZXJ0eSggZW5hYmxlQ29udHJvbFByb3BlcnR5ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5sb2NhbGx5RW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSApO1xyXG5cclxuICAgIC8vIEFkZCB0aGUgbG9jYWwgUHJvcGVydHkgdG8gdGhlIGxpc3Qgb2YgZW5hYmxlIGNvbnRyb2xzLlxyXG4gICAgdGhpcy5hZGRFbmFibGVDb250cm9sUHJvcGVydHkoIHRoaXMubG9jYWxseUVuYWJsZWRQcm9wZXJ0eSApO1xyXG5cclxuICAgIHRoaXMubWFpbkdhaW5Ob2RlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlR2FpbigpO1xyXG4gICAgdGhpcy5tYWluR2Fpbk5vZGUuZ2Fpbi5zZXRWYWx1ZUF0VGltZShcclxuICAgICAgdGhpcy5fb3V0cHV0TGV2ZWwsXHJcbiAgICAgIHRoaXMuYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lXHJcbiAgICApO1xyXG5cclxuICAgIC8vIElmIHRoZSBvcHRpb24gc3BlY2lmaWVzIGltbWVkaWF0ZSBjb25uZWN0aW9uLCBjb25uZWN0IHRoZSBtYWluIGdhaW4gbm9kZSB0byB0aGUgYXVkaW8gY29udGV4dCBkZXN0aW5hdGlvbi5cclxuICAgIGlmICggb3B0aW9ucy5jb25uZWN0SW1tZWRpYXRlbHkgKSB7XHJcbiAgICAgIHRoaXMubWFpbkdhaW5Ob2RlLmNvbm5lY3QoIHRoaXMuYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVHVybiBkb3duIHRoZSBnYWluIHRvIHplcm8gd2hlbiBub3QgZnVsbHkgZW5hYmxlZCBhbmQgdXAgdG8gdGhlIGN1cnJlbnQgb3V0cHV0IGxldmVsIHdoZW4gYmVjb21pbmcgZnVsbHkgZW5hYmxlZC5cclxuICAgIHRoaXMuZnVsbHlFbmFibGVkUHJvcGVydHkubGluayggZnVsbHlFbmFibGVkID0+IHtcclxuXHJcbiAgICAgIGNvbnN0IHByZXZpb3VzR2FpblNldHRpbmcgPSBmdWxseUVuYWJsZWQgPyAwIDogdGhpcy5fb3V0cHV0TGV2ZWw7XHJcbiAgICAgIGNvbnN0IG5ld0dhaW5TZXR0aW5nID0gZnVsbHlFbmFibGVkID8gdGhpcy5fb3V0cHV0TGV2ZWwgOiAwO1xyXG4gICAgICBjb25zdCBub3cgPSB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZTtcclxuXHJcbiAgICAgIC8vIEZvciB0aGUgbGluZWFyIHJhbXAgdG8gd29yayBjb25zaXN0ZW50bHkgb24gYWxsIGJyb3dzZXJzLCB0aGUgZ2FpbiBtdXN0IGJlIGV4cGxpY2l0bHkgc2V0IHRvIHdoYXQgaXQgaXNcclxuICAgICAgLy8gc3VwcG9zZWQgdG8gYmUgYmVmb3JlIG1ha2luZyBhbnkgY2hhbmdlcy4gIE90aGVyd2lzZSwgaXQgbWF5IGV4dHJhcG9sYXRlIGZyb20gdGhlIG1vc3QgcmVjZW50IHByZXZpb3VzIGV2ZW50LlxyXG4gICAgICB0aGlzLm1haW5HYWluTm9kZS5nYWluLnNldFZhbHVlQXRUaW1lKCBwcmV2aW91c0dhaW5TZXR0aW5nLCBub3cgKTtcclxuXHJcbiAgICAgIC8vIFJhbXAgdGhlIGdhaW4gdG8gdGhlIG5ldyBsZXZlbC5cclxuICAgICAgdGhpcy5tYWluR2Fpbk5vZGUuZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZShcclxuICAgICAgICBuZXdHYWluU2V0dGluZyxcclxuICAgICAgICB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZSArIHNvdW5kQ29uc3RhbnRzLkRFRkFVTFRfTElORUFSX0dBSU5fQ0hBTkdFX1RJTUVcclxuICAgICAgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnNvdW5kU291cmNlRGVzdGluYXRpb24gPSB0aGlzLm1haW5HYWluTm9kZTtcclxuXHJcbiAgICAvLyBJbnNlcnQgYW55IGFkZGl0aW9uYWwgYXVkaW8gbm9kZXMgaW50byB0aGUgc2lnbmFsIGNoYWluIGJ5IGl0ZXJhdGluZyBiYWNrd2FyZHMgdGhyb3VnaCB0aGUgcHJvdmlkZWQgbGlzdC5cclxuICAgIGZvciAoIGxldCBpID0gb3B0aW9ucy5hZGRpdGlvbmFsQXVkaW9Ob2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHtcclxuICAgICAgY29uc3QgYXVkaW9Ob2RlID0gb3B0aW9ucy5hZGRpdGlvbmFsQXVkaW9Ob2Rlc1sgaSBdO1xyXG4gICAgICBhdWRpb05vZGUuY29ubmVjdCggdGhpcy5zb3VuZFNvdXJjZURlc3RpbmF0aW9uICk7XHJcbiAgICAgIHRoaXMuc291bmRTb3VyY2VEZXN0aW5hdGlvbiA9IGF1ZGlvTm9kZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGlzIHNvdW5kIG5ldmVyIHBsYXlzIHdoZW4gc2V0dGluZyBQaEVULWlPIHN0YXRlXHJcbiAgICBpZiAoIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgJiYgIW9wdGlvbnMuZW5hYmxlZER1cmluZ1BoZXRpb1N0YXRlU2V0dGluZyApIHtcclxuICAgICAgdGhpcy5hZGRFbmFibGVDb250cm9sUHJvcGVydHkoIG5vdFNldHRpbmdQaGV0aW9TdGF0ZVByb3BlcnR5ICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2xlYW4gdXAgbWVtb3J5IHJlZmVyZW5jZXMgd2hlbiB0aGlzIG9iamVjdCBpcyBkaXNwb3NlZCB0byBhdm9pZCBtZW1vcnkgbGVha3MuXHJcbiAgICB0aGlzLmRpc3Bvc2VFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB7XHJcblxyXG4gICAgICAvLyBDbGVhcmluZyB0aGlzIG9ic2VydmFibGUgYXJyYXkgc2hvdWxkIGNhdXNlIHRoZSBQcm9wZXJ0aWVzIHdpdGhpbiBpdCB0byBiZSB1bmxpbmtlZC5cclxuICAgICAgdGhpcy5lbmFibGVDb250cm9sUHJvcGVydGllcy5jbGVhcigpO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29ubmVjdCB0aGUgc291bmQgZ2VuZXJhdG9yIHRvIGFuIGF1ZGlvIHBhcmFtZXRlci5cclxuICAgKi9cclxuICBwdWJsaWMgY29ubmVjdCggYXVkaW9QYXJhbTogQXVkaW9QYXJhbSB8IEF1ZGlvTm9kZSApOiB2b2lkIHtcclxuICAgIHRoaXMubWFpbkdhaW5Ob2RlLmNvbm5lY3QoIGF1ZGlvUGFyYW0gYXMgQXVkaW9QYXJhbSApO1xyXG5cclxuICAgIC8vIFRyYWNrIHRoaXMgc291bmQgZ2VuZXJhdG9yJ3MgY29ubmVjdGlvbnMuICBUaGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIFdlYiBBdWRpbyBkb2Vzbid0IHN1cHBvcnQgY2hlY2tpbmcgd2hpY2hcclxuICAgIC8vIG5vZGVzIGFyZSBjb25uZWN0ZWQgdG8gd2hpY2gsIGFuZCB3ZSBuZWVkIHRoaXMgaW5mb3JtYXRpb24gd2hlbiBkaXNjb25uZWN0aW5nLlxyXG4gICAgdGhpcy5jb25uZWN0aW9uTGlzdC5wdXNoKCBhdWRpb1BhcmFtIGFzIEF1ZGlvUGFyYW0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERpc2Nvbm5lY3QgdGhlIHNvdW5kIGdlbmVyYXRvciBmcm9tIGFuIGF1ZGlvIHBhcmFtZXRlci5cclxuICAgKi9cclxuICBwdWJsaWMgZGlzY29ubmVjdCggYXVkaW9QYXJhbTogQXVkaW9QYXJhbSB8IEF1ZGlvTm9kZSApOiB2b2lkIHtcclxuICAgIHRoaXMubWFpbkdhaW5Ob2RlLmRpc2Nvbm5lY3QoIGF1ZGlvUGFyYW0gYXMgQXVkaW9Ob2RlICk7XHJcbiAgICB0aGlzLmNvbm5lY3Rpb25MaXN0ID0gXy53aXRob3V0KCB0aGlzLmNvbm5lY3Rpb25MaXN0LCBhdWRpb1BhcmFtICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUZXN0IGlmIHRoaXMgc291bmQgZ2VuZXJhdG9yIGlzIGNvbm5lY3RlZCB0byB0aGUgcHJvdmlkZWQgYXVkaW8gcGFyYW0uXHJcbiAgICovXHJcbiAgcHVibGljIGlzQ29ubmVjdGVkVG8oIGF1ZGlvUGFyYW06IEF1ZGlvUGFyYW0gfCBBdWRpb05vZGUgKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uTGlzdC5pbmNsdWRlcyggYXVkaW9QYXJhbSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0cyB0aGUgb3V0cHV0IGxldmVsIG9mIHRoZSBzb3VuZCBnZW5lcmF0b3IuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gb3V0cHV0TGV2ZWwgLSBnZW5lcmFsbHkgYmV0d2VlbiAwIGFuZCAxLCBidXQgY2FuIGJlIGxhcmdlciB0aGFuIDEgaWYgbmVjZXNzYXJ5IHRvIGFtcGxpZnkgYSBzbWFsbCBzaWduYWwsXHJcbiAgICogICBhbmQgY2FuIGJlIG5lZ2F0aXZlIHRvIGludmVydCB0aGUgcGhhc2UuXHJcbiAgICogQHBhcmFtIFt0aW1lQ29uc3RhbnRdIC0gdGltZSBjb25zdGFudCBmb3Igb3V0cHV0IGxldmVsIGNoYW5nZSwgbG9uZ2VyIHZhbHVlcyBtZWFuIHNsb3dlciB0cmFuc2l0aW9ucywgaW4gc2Vjb25kcy5cclxuICAgKiAgIE5vdGUgdGhhdCB0aW1lQ29uc3RhbnQgaXMgTk9UIGEgZmFkZSB0aW1lLiBJdCdzIGFuIGV4cG9uZW50aWFsIGFwcHJvYWNoIHRvIHRoZSB0YXJnZXQgb3V0cHV0IGxldmVsLCBhbmQgdGhlIGFyZ3VtZW50IHRvXHJcbiAgICogICBzZXRUYXJnZXRBdFRpbWUsIGRvY3VtZW50ZWQgYXQgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0F1ZGlvUGFyYW0vc2V0VGFyZ2V0QXRUaW1lI3RpbWVjb25zdGFudFxyXG4gICAqICAgVGhlIGRvY3VtZW50IGhhcyB0aGlzIHN1Z2dlc3Rpb24gZm9yIGNob29zaW5nIHRoZSB2YWx1ZSBmb3IgdGltZUNvbnN0YW50OiBcIkRlcGVuZGluZyBvbiB5b3VyIHVzZSBjYXNlLCBnZXR0aW5nXHJcbiAgICogICA5NSUgdG93YXJkIHRoZSB0YXJnZXQgdmFsdWUgbWF5IGFscmVhZHkgYmUgZW5vdWdoOyBpbiB0aGF0IGNhc2UsIHlvdSBjb3VsZCBzZXQgdGltZUNvbnN0YW50IHRvIG9uZSB0aGlyZCBvZiB0aGVcclxuICAgKiAgIGRlc2lyZWQgZHVyYXRpb24uXCJcclxuICAgKi9cclxuICBwdWJsaWMgc2V0T3V0cHV0TGV2ZWwoIG91dHB1dExldmVsOiBudW1iZXIsIHRpbWVDb25zdGFudDogbnVtYmVyID0gREVGQVVMVF9USU1FX0NPTlNUQU5UICk6IHZvaWQge1xyXG5cclxuICAgIC8vIElnbm9yZSBhdHRlbXB0cyB0byBzZXQgdGhlIG91dHB1dCBsZXZlbCB0byB0aGUgc2FtZSB2YWx1ZS5cclxuICAgIGlmICggb3V0cHV0TGV2ZWwgIT09IHRoaXMuX291dHB1dExldmVsICkge1xyXG4gICAgICBjb25zdCBub3cgPSB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZTtcclxuXHJcbiAgICAgIC8vIFRoZSBvdXRwdXQgbGV2ZWwgc2hvdWxkIHRha2UgZWZmZWN0IGltbWVkaWF0ZWx5IGlmIHRoaXMgc291bmQgZ2VuZXJhdG9yIGlzIGZ1bGx5IGVuYWJsZWQuICBPdGhlcndpc2UsIHRoZSB2YWx1ZVxyXG4gICAgICAvLyBpcyBzYXZlZCBhbmQgcmVzdG9yZWQgdGhlIG5leHQgdGltZSB0aGUgc291bmQgZ2VuZXJhdG9yIHRyYW5zaXRpb25zIHRvIGZ1bGx5IGVuYWJsZWQuXHJcbiAgICAgIGlmICggdGhpcy5mdWxseUVuYWJsZWRQcm9wZXJ0eS52YWx1ZSApIHtcclxuXHJcbiAgICAgICAgLy8gQ2FuY2VsIGFueSBnYWluIHRyYW5zaXRpb25zIHRoYXQgYXJlIGN1cnJlbnRseSBpbiBwcm9ncmVzcy5cclxuICAgICAgICB0aGlzLm1haW5HYWluTm9kZS5nYWluLmNhbmNlbFNjaGVkdWxlZFZhbHVlcyggbm93ICk7XHJcblxyXG4gICAgICAgIC8vIFNldCB0aGUgb3V0cHV0IGxldmVsIG9uIHRoZSBnYWluIG5vZGUuICBBIGRpZmZlcmVudCBtZXRob2QgaXMgdXNlZCBmb3IgaW5zdGFudCBjaGFuZ2VzLlxyXG4gICAgICAgIGlmICggdGltZUNvbnN0YW50ID09PSAwICkge1xyXG4gICAgICAgICAgdGhpcy5tYWluR2Fpbk5vZGUuZ2Fpbi5zZXRWYWx1ZUF0VGltZSggb3V0cHV0TGV2ZWwsIG5vdyApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgICAvLyBUaGUgc2V0VGFyZ2V0QXRUaW1lIG1ldGhvZCBkb2Vzbid0IHNlZW0gdG8gd29yayBpZiB0aGUgYXVkaW8gY29udGV4dCBpc24ndCBydW5uaW5nLCBhbmQgdGhlIGV2ZW50IGRvZXNuJ3RcclxuICAgICAgICAgIC8vIHNlZW0gdG8gYmUgc2NoZWR1bGVkIC0gaXQncyBqdXN0IGlnbm9yZWQuICBTbywgaWYgdGhlIGF1ZGlvIGNvbnRleHQgaXNuJ3QgcnVubmluZywgdXNlIGFuIGFsdGVybmF0aXZlXHJcbiAgICAgICAgICAvLyBhcHByb2FjaC4gIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvdGFtYm8vaXNzdWVzLzc0LlxyXG4gICAgICAgICAgaWYgKCB0aGlzLmF1ZGlvQ29udGV4dC5zdGF0ZSA9PT0gJ3J1bm5pbmcnICkge1xyXG4gICAgICAgICAgICB0aGlzLm1haW5HYWluTm9kZS5nYWluLnNldFRhcmdldEF0VGltZSggb3V0cHV0TGV2ZWwsIG5vdywgdGltZUNvbnN0YW50ICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5tYWluR2Fpbk5vZGUuZ2Fpbi5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZShcclxuICAgICAgICAgICAgICBvdXRwdXRMZXZlbCxcclxuICAgICAgICAgICAgICBub3cgKyBzb3VuZENvbnN0YW50cy5ERUZBVUxUX0xJTkVBUl9HQUlOX0NIQU5HRV9USU1FXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBTZXQgbG9jYWwgY29weSBvZiBvdXRwdXQgbGV2ZWwuXHJcbiAgICAgIHRoaXMuX291dHB1dExldmVsID0gb3V0cHV0TGV2ZWw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0IG91dHB1dExldmVsKCBvdXRwdXRMZXZlbDogbnVtYmVyICkge1xyXG4gICAgdGhpcy5zZXRPdXRwdXRMZXZlbCggb3V0cHV0TGV2ZWwgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQgb3V0cHV0TGV2ZWwoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLmdldE91dHB1dExldmVsKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgdGhlIGN1cnJlbnQgb3V0cHV0IGxldmVsIHNldHRpbmcuICBOb3RlIHRoYXQgaWYgdGhlIHNvdW5kIGdlbmVyYXRvciBpcyBkaXNhYmxlZCwgdGhpcyBjb3VsZCByZXR1cm4gYSBub24temVyb1xyXG4gICAqIHZhbHVlIGJ1dCB0aGUgc291bmQgZ2VuZXJhdG9yIHdvbid0IHByb2R1Y2UgYXVkaWJsZSBzb3VuZC5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0T3V0cHV0TGV2ZWwoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9vdXRwdXRMZXZlbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFkZCBhIFByb3BlcnR5IHRvIHRoZSBsaXN0IG9mIHRob3NlIHVzZWQgdG8gY29udHJvbCB0aGUgZW5hYmxlZCBzdGF0ZSBvZiB0aGlzIHNvdW5kIGdlbmVyYXRvci5cclxuICAgKi9cclxuICBwdWJsaWMgYWRkRW5hYmxlQ29udHJvbFByb3BlcnR5KCBlbmFibGVDb250cm9sUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PGJvb2xlYW4+ICk6IHZvaWQge1xyXG4gICAgdGhpcy5lbmFibGVDb250cm9sUHJvcGVydGllcy5wdXNoKCBlbmFibGVDb250cm9sUHJvcGVydHkgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbW92ZSBhIFByb3BlcnR5IGZyb20gdGhlIGxpc3Qgb2YgdGhvc2UgdXNlZCB0byBjb250cm9sIHRoZSBlbmFibGVkIHN0YXRlIG9mIHRoaXMgc291bmQgZ2VuZXJhdG9yLlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVFbmFibGVDb250cm9sUHJvcGVydHkoIGVuYWJsZUNvbnRyb2xQcm9wZXJ0eTogVFByb3BlcnR5PGJvb2xlYW4+ICk6IHZvaWQge1xyXG4gICAgdGhpcy5lbmFibGVDb250cm9sUHJvcGVydGllcy5yZW1vdmUoIGVuYWJsZUNvbnRyb2xQcm9wZXJ0eSApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCBsb2NhbGx5RW5hYmxlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLmxvY2FsbHlFbmFibGVkUHJvcGVydHkudmFsdWU7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0IGxvY2FsbHlFbmFibGVkKCBsb2NhbGx5RW5hYmxlZDogYm9vbGVhbiApIHtcclxuICAgIHRoaXMubG9jYWxseUVuYWJsZWRQcm9wZXJ0eS52YWx1ZSA9IGxvY2FsbHlFbmFibGVkO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCBmdWxseUVuYWJsZWQoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5mdWxseUVuYWJsZWRQcm9wZXJ0eS52YWx1ZTtcclxuICB9XHJcbn1cclxuXHJcbnRhbWJvLnJlZ2lzdGVyKCAnU291bmRHZW5lcmF0b3InLCBTb3VuZEdlbmVyYXRvciApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgU291bmRHZW5lcmF0b3I7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHFDQUFxQztBQUNqRSxPQUFPQyxlQUFlLE1BQU0scUNBQXFDO0FBQ2pFLE9BQU9DLHFCQUFxQixNQUEyQiwyQ0FBMkM7QUFDbEcsT0FBT0MsU0FBUyxNQUFNLG9DQUFvQztBQUMxRCxPQUFPQyxNQUFNLE1BQU0sOEJBQThCO0FBQ2pELE9BQU9DLGdCQUFnQixNQUFNLHdCQUF3QjtBQUNyRCxPQUFPQyxjQUFjLE1BQU0sc0JBQXNCO0FBQ2pELE9BQU9DLEtBQUssTUFBTSxhQUFhO0FBSS9CLE9BQU9DLDRCQUE0QixNQUFNLG9EQUFvRDtBQUM3RixPQUFPQyxVQUFVLE1BQU0sZ0NBQWdDOztBQUV2RDtBQUNBLE1B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