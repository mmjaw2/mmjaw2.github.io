// Copyright 2020-2024, University of Colorado Boulder

/**
 * QUnit tests for Emitter
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 * @author Chris Klusendorf (PhET Interactive Simulations)
 */

import TinyProperty from './TinyProperty.js';
import Vector2 from '../../dot/js/Vector2.js';
QUnit.module('TinyProperty');
QUnit.test('TinyProperty Basics', assert => {
  const property = new TinyProperty('x');
  property.link(value => {
    console.log(value);
  });
  assert.ok(true, 'one test');
});
QUnit.test('TinyProperty onBeforeNotify', assert => {
  class MyObservedObject {
    constructor() {
      this.hasFun = false;
      this.hadFun = false;
      this.hasFunProperty = new TinyProperty(false, (newValue, oldValue) => {
        this.hasFun = newValue;
        this.hadFun = oldValue;
      });
    }
  }
  const x = new MyObservedObject();
  x.hasFunProperty.lazyLink((newValue, oldValue) => {
    assert.ok(x.hadFun === oldValue, 'old value should match');
    assert.ok(x.hasFun === newValue, 'new value should match');
  });
  x.hasFunProperty.value = true;
  x.hasFunProperty.value = false;
  x.hasFunProperty.value = true;
});
QUnit.test('TinyProperty valueComparisonStrategy', assert => {
  let calledCount = 0;
  const myProperty = new TinyProperty(0);
  myProperty.lazyLink(() => calledCount++);
  myProperty.value = 0;
  assert.ok(calledCount === 0, 'no value change');
  myProperty.value = 1;
  assert.ok(calledCount === 1, 'reference number valueChange');
  myProperty.valueComparisonStrategy = 'reference';
  myProperty.value = 1;
  assert.ok(calledCount === 1, 'no reference number valueChange');
  myProperty.value = 3;
  assert.ok(calledCount === 2, 'reference number valueChange');
  myProperty.value = new Vector2(0, 0);
  assert.ok(calledCount === 3, 'vector is different');
  myProperty.value = new Vector2(0, 0);
  assert.ok(calledCount === 4, 'still reference vector is different');
  myProperty.valueComparisonStrategy = 'equalsFunction';
  myProperty.value = new Vector2(0, 0);
  assert.ok(calledCount === 4, 'equal');
  myProperty.value = new Vector2(0, 3);
  assert.ok(calledCount === 5, 'not equal');
  myProperty.valueComparisonStrategy = 'lodashDeep';
  myProperty.value = {
    something: 'hi'
  };
  assert.ok(calledCount === 6, 'not equal');
  myProperty.value = {
    something: 'hi'
  };
  assert.ok(calledCount === 6, 'equal');
  myProperty.value = {
    something: 'hi',
    other: false
  };
  assert.ok(calledCount === 7, 'not equal with other key');
});
QUnit.test('TinyProperty reentrant notify order (reentrantNotificationStrategy:queue)', assert => {
  let count = 2; // starts as a value of 1, so 2 is the first value we change to.

  // queue is default
  const myProperty = new TinyProperty(1);
  myProperty.lazyLink((value, oldValue) => {
    if (value < 10) {
      myProperty.value = value + 1;
      console.log('queue:', oldValue, '->', value);
    }
  });

  // notify-queue:
  // 1->2
  // 2->3
  // 3->4
  // ...
  // 8->9

  myProperty.lazyLink((value, oldValue) => {
    assert.ok(value === oldValue + 1, `increment each time: ${oldValue} -> ${value}`);
    assert.ok(value === count++, `increment by most recent changed: ${count - 2}->${count - 1}, received: ${oldValue} -> ${value}`);
  });
  myProperty.value = count;
});
QUnit.test('TinyProperty reentrant notify order (reentrantNotificationStrategy:stack)', assert => {
  let count = 2; // starts as a value of 1, so 2 is the first value we change to.
  const finalCount = 10;
  let lastListenerCount = 10;
  const myProperty = new TinyProperty(count - 1, null, null, 'stack');
  myProperty.lazyLink((value, oldValue) => {
    if (value < finalCount) {
      myProperty.value = value + 1;
      console.log('stack:', oldValue, '->', value);
    }
  });

  // stack-notify:
  // 8->9
  // 7->8
  // 6->7
  // ...
  // 1->2
  myProperty.lazyLink((value, oldValue) => {
    count++;
    assert.ok(value === oldValue + 1, `increment each time: ${oldValue} -> ${value}`);
    assert.ok(value === lastListenerCount--, `increment in order expected: ${lastListenerCount}->${lastListenerCount + 1}, received: ${oldValue} -> ${value}`);
    assert.ok(oldValue === lastListenerCount, `new count is ${lastListenerCount}: the oldValue (most recent first in stack first`);
  });
  myProperty.value = count;
});
QUnit.test('TinyProperty reentrant lazyLinks (reentrantNotificationStrategy:queue)', assert => {
  const myProperty = new TinyProperty(0, null, null, 'queue');
  let linkCalledCount = 0;
  let reentered = false;
  myProperty.lazyLink(value => {
    if (!reentered) {
      reentered = true;
      myProperty.value = value + 1;
      myProperty.link(newValue => {
        console.log(value, newValue);
        assert.ok(++linkCalledCount <= 1, 'should not be called from original change, just from link');
      });

      // This is great!. It isn't actually like a queue, but how strange it would be to have the above value change trigger
      // this listener because of the queue based reentrant notification strategy. It is better to guard against that so
      // this isn't called on previously called value changes.
      myProperty.lazyLink(() => {
        assert.ok(false, 'should not be called from original change');
      });
    }
  });
  myProperty.value = 1;
  myProperty.removeAllListeners();
  /////////////////////////////////////////
  myProperty.value = -1;
  myProperty.lazyLink(originalValue => {
    if (originalValue < 5) {
      let lazyLinkCalledCount = originalValue + 1;
      myProperty.value = originalValue + 1;
      assert.equal(myProperty.value, originalValue + 1, 'value is immediately correct for access (reentrantly)');
      myProperty.lazyLink(newValue => {
        assert.ok(newValue !== originalValue, `${originalValue}: should not be called from original change`);
        assert.equal(newValue, ++lazyLinkCalledCount, `${lazyLinkCalledCount}: should be called in order (lazyLink)`);
      });
    }
  });
  myProperty.value = 0;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJUaW55UHJvcGVydHkiLCJWZWN0b3IyIiwiUVVuaXQiLCJtb2R1bGUiLCJ0ZXN0IiwiYXNzZXJ0IiwicHJvcGVydHkiLCJsaW5rIiwidmFsdWUiLCJjb25zb2xlIiwibG9nIiwib2siLCJNeU9ic2VydmVkT2JqZWN0IiwiY29uc3RydWN0b3IiLCJoYXNGdW4iLCJoYWRGdW4iLCJoYXNGdW5Qcm9wZXJ0eSIsIm5ld1ZhbHVlIiwib2xkVmFsdWUiLCJ4IiwibGF6eUxpbmsiLCJjYWxsZWRDb3VudCIsIm15UHJvcGVydHkiLCJ2YWx1ZUNvbXBhcmlzb25TdHJhdGVneSIsInNvbWV0aGluZyIsIm90aGVyIiwiY291bnQiLCJmaW5hbENvdW50IiwibGFzdExpc3RlbmVyQ291bnQiLCJsaW5rQ2FsbGVkQ291bnQiLCJyZWVudGVyZWQiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJvcmlnaW5hbFZhbHVlIiwibGF6eUxpbmtDYWxsZWRDb3VudCIsImVxdWFsIl0sInNvdXJjZXMiOlsiVGlueVByb3BlcnR5VGVzdHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyNCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogUVVuaXQgdGVzdHMgZm9yIEVtaXR0ZXJcclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICogQGF1dGhvciBNaWNoYWVsIEthdXptYW5uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIENocmlzIEtsdXNlbmRvcmYgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFRpbnlQcm9wZXJ0eSBmcm9tICcuL1RpbnlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBJbnRlbnRpb25hbEFueSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvSW50ZW50aW9uYWxBbnkuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcblxyXG5RVW5pdC5tb2R1bGUoICdUaW55UHJvcGVydHknICk7XHJcblxyXG5RVW5pdC50ZXN0KCAnVGlueVByb3BlcnR5IEJhc2ljcycsIGFzc2VydCA9PiB7XHJcbiAgY29uc3QgcHJvcGVydHkgPSBuZXcgVGlueVByb3BlcnR5KCAneCcgKTtcclxuICBwcm9wZXJ0eS5saW5rKCB2YWx1ZSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZyggdmFsdWUgKTtcclxuICB9ICk7XHJcblxyXG4gIGFzc2VydC5vayggdHJ1ZSwgJ29uZSB0ZXN0JyApO1xyXG59ICk7XHJcblxyXG5RVW5pdC50ZXN0KCAnVGlueVByb3BlcnR5IG9uQmVmb3JlTm90aWZ5JywgYXNzZXJ0ID0+IHtcclxuXHJcbiAgY2xhc3MgTXlPYnNlcnZlZE9iamVjdCB7XHJcbiAgICBwdWJsaWMgaGFzRnVuOiBib29sZWFuO1xyXG4gICAgcHVibGljIGhhZEZ1bjogYm9vbGVhbiB8IG51bGw7XHJcbiAgICBwdWJsaWMgaGFzRnVuUHJvcGVydHk6IFRpbnlQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgIHRoaXMuaGFzRnVuID0gZmFsc2U7XHJcbiAgICAgIHRoaXMuaGFkRnVuID0gZmFsc2U7XHJcbiAgICAgIHRoaXMuaGFzRnVuUHJvcGVydHkgPSBuZXcgVGlueVByb3BlcnR5KCBmYWxzZSwgKCBuZXdWYWx1ZSwgb2xkVmFsdWUgKSA9PiB7XHJcbiAgICAgICAgdGhpcy5oYXNGdW4gPSBuZXdWYWx1ZTtcclxuICAgICAgICB0aGlzLmhhZEZ1biA9IG9sZFZhbHVlO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCB4ID0gbmV3IE15T2JzZXJ2ZWRPYmplY3QoKTtcclxuXHJcbiAgeC5oYXNGdW5Qcm9wZXJ0eS5sYXp5TGluayggKCBuZXdWYWx1ZSwgb2xkVmFsdWUgKSA9PiB7XHJcbiAgICBhc3NlcnQub2soIHguaGFkRnVuID09PSBvbGRWYWx1ZSwgJ29sZCB2YWx1ZSBzaG91bGQgbWF0Y2gnICk7XHJcbiAgICBhc3NlcnQub2soIHguaGFzRnVuID09PSBuZXdWYWx1ZSwgJ25ldyB2YWx1ZSBzaG91bGQgbWF0Y2gnICk7XHJcbiAgfSApO1xyXG5cclxuXHJcbiAgeC5oYXNGdW5Qcm9wZXJ0eS52YWx1ZSA9IHRydWU7XHJcbiAgeC5oYXNGdW5Qcm9wZXJ0eS52YWx1ZSA9IGZhbHNlO1xyXG4gIHguaGFzRnVuUHJvcGVydHkudmFsdWUgPSB0cnVlO1xyXG59ICk7XHJcblxyXG5RVW5pdC50ZXN0KCAnVGlueVByb3BlcnR5IHZhbHVlQ29tcGFyaXNvblN0cmF0ZWd5JywgYXNzZXJ0ID0+IHtcclxuXHJcbiAgbGV0IGNhbGxlZENvdW50ID0gMDtcclxuICBjb25zdCBteVByb3BlcnR5ID0gbmV3IFRpbnlQcm9wZXJ0eTxJbnRlbnRpb25hbEFueT4oIDAgKTtcclxuICBteVByb3BlcnR5LmxhenlMaW5rKCAoKSA9PiBjYWxsZWRDb3VudCsrICk7XHJcblxyXG4gIG15UHJvcGVydHkudmFsdWUgPSAwO1xyXG4gIGFzc2VydC5vayggY2FsbGVkQ291bnQgPT09IDAsICdubyB2YWx1ZSBjaGFuZ2UnICk7XHJcblxyXG4gIG15UHJvcGVydHkudmFsdWUgPSAxO1xyXG4gIGFzc2VydC5vayggY2FsbGVkQ291bnQgPT09IDEsICdyZWZlcmVuY2UgbnVtYmVyIHZhbHVlQ2hhbmdlJyApO1xyXG5cclxuICBteVByb3BlcnR5LnZhbHVlQ29tcGFyaXNvblN0cmF0ZWd5ID0gJ3JlZmVyZW5jZSc7XHJcbiAgbXlQcm9wZXJ0eS52YWx1ZSA9IDE7XHJcbiAgYXNzZXJ0Lm9rKCBjYWxsZWRDb3VudCA9PT0gMSwgJ25vIHJlZmVyZW5jZSBudW1iZXIgdmFsdWVDaGFuZ2UnICk7XHJcbiAgbXlQcm9wZXJ0eS52YWx1ZSA9IDM7XHJcbiAgYXNzZXJ0Lm9rKCBjYWxsZWRDb3VudCA9PT0gMiwgJ3JlZmVyZW5jZSBudW1iZXIgdmFsdWVDaGFuZ2UnICk7XHJcblxyXG4gIG15UHJvcGVydHkudmFsdWUgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG4gIGFzc2VydC5vayggY2FsbGVkQ291bnQgPT09IDMsICd2ZWN0b3IgaXMgZGlmZmVyZW50JyApO1xyXG4gIG15UHJvcGVydHkudmFsdWUgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG4gIGFzc2VydC5vayggY2FsbGVkQ291bnQgPT09IDQsICdzdGlsbCByZWZlcmVuY2UgdmVjdG9yIGlzIGRpZmZlcmVudCcgKTtcclxuICBteVByb3BlcnR5LnZhbHVlQ29tcGFyaXNvblN0cmF0ZWd5ID0gJ2VxdWFsc0Z1bmN0aW9uJztcclxuICBteVByb3BlcnR5LnZhbHVlID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuICBhc3NlcnQub2soIGNhbGxlZENvdW50ID09PSA0LCAnZXF1YWwnICk7XHJcbiAgbXlQcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCAwLCAzICk7XHJcbiAgYXNzZXJ0Lm9rKCBjYWxsZWRDb3VudCA9PT0gNSwgJ25vdCBlcXVhbCcgKTtcclxuXHJcbiAgbXlQcm9wZXJ0eS52YWx1ZUNvbXBhcmlzb25TdHJhdGVneSA9ICdsb2Rhc2hEZWVwJztcclxuICBteVByb3BlcnR5LnZhbHVlID0geyBzb21ldGhpbmc6ICdoaScgfTtcclxuICBhc3NlcnQub2soIGNhbGxlZENvdW50ID09PSA2LCAnbm90IGVxdWFsJyApO1xyXG4gIG15UHJvcGVydHkudmFsdWUgPSB7IHNvbWV0aGluZzogJ2hpJyB9O1xyXG4gIGFzc2VydC5vayggY2FsbGVkQ291bnQgPT09IDYsICdlcXVhbCcgKTtcclxuICBteVByb3BlcnR5LnZhbHVlID0geyBzb21ldGhpbmc6ICdoaScsIG90aGVyOiBmYWxzZSB9O1xyXG4gIGFzc2VydC5vayggY2FsbGVkQ291bnQgPT09IDcsICdub3QgZXF1YWwgd2l0aCBvdGhlciBrZXknICk7XHJcbn0gKTtcclxuXHJcblFVbml0LnRlc3QoICdUaW55UHJvcGVydHkgcmVlbnRyYW50IG5vdGlmeSBvcmRlciAocmVlbnRyYW50Tm90aWZpY2F0aW9uU3RyYXRlZ3k6cXVldWUpJywgYXNzZXJ0ID0+IHtcclxuICBsZXQgY291bnQgPSAyOyAvLyBzdGFydHMgYXMgYSB2YWx1ZSBvZiAxLCBzbyAyIGlzIHRoZSBmaXJzdCB2YWx1ZSB3ZSBjaGFuZ2UgdG8uXHJcblxyXG4gIC8vIHF1ZXVlIGlzIGRlZmF1bHRcclxuICBjb25zdCBteVByb3BlcnR5ID0gbmV3IFRpbnlQcm9wZXJ0eTxudW1iZXI+KCAxICk7XHJcblxyXG4gIG15UHJvcGVydHkubGF6eUxpbmsoICggdmFsdWUsIG9sZFZhbHVlICkgPT4ge1xyXG4gICAgaWYgKCB2YWx1ZSA8IDEwICkge1xyXG4gICAgICBteVByb3BlcnR5LnZhbHVlID0gdmFsdWUgKyAxO1xyXG4gICAgICBjb25zb2xlLmxvZyggJ3F1ZXVlOicsIG9sZFZhbHVlLCAnLT4nLCB2YWx1ZSApO1xyXG4gICAgfVxyXG4gIH0gKTtcclxuXHJcbiAgLy8gbm90aWZ5LXF1ZXVlOlxyXG4gIC8vIDEtPjJcclxuICAvLyAyLT4zXHJcbiAgLy8gMy0+NFxyXG4gIC8vIC4uLlxyXG4gIC8vIDgtPjlcclxuXHJcbiAgbXlQcm9wZXJ0eS5sYXp5TGluayggKCB2YWx1ZSwgb2xkVmFsdWUgKSA9PiB7XHJcbiAgICBhc3NlcnQub2soIHZhbHVlID09PSBvbGRWYWx1ZSArIDEsIGBpbmNyZW1lbnQgZWFjaCB0aW1lOiAke29sZFZhbHVlfSAtPiAke3ZhbHVlfWAgKTtcclxuICAgIGFzc2VydC5vayggdmFsdWUgPT09IGNvdW50KyssIGBpbmNyZW1lbnQgYnkgbW9zdCByZWNlbnQgY2hhbmdlZDogJHtjb3VudCAtIDJ9LT4ke2NvdW50IC0gMX0sIHJlY2VpdmVkOiAke29sZFZhbHVlfSAtPiAke3ZhbHVlfWAgKTtcclxuICB9ICk7XHJcbiAgbXlQcm9wZXJ0eS52YWx1ZSA9IGNvdW50O1xyXG59ICk7XHJcblxyXG5RVW5pdC50ZXN0KCAnVGlueVByb3BlcnR5IHJlZW50cmFudCBub3RpZnkgb3JkZXIgKHJlZW50cmFudE5vdGlmaWNhdGlvblN0cmF0ZWd5OnN0YWNrKScsIGFzc2VydCA9PiB7XHJcbiAgbGV0IGNvdW50ID0gMjsgLy8gc3RhcnRzIGFzIGEgdmFsdWUgb2YgMSwgc28gMiBpcyB0aGUgZmlyc3QgdmFsdWUgd2UgY2hhbmdlIHRvLlxyXG4gIGNvbnN0IGZpbmFsQ291bnQgPSAxMDtcclxuICBsZXQgbGFzdExpc3RlbmVyQ291bnQgPSAxMDtcclxuXHJcbiAgY29uc3QgbXlQcm9wZXJ0eSA9IG5ldyBUaW55UHJvcGVydHk8bnVtYmVyPiggY291bnQgLSAxLCBudWxsLCBudWxsLCAnc3RhY2snICk7XHJcblxyXG4gIG15UHJvcGVydHkubGF6eUxpbmsoICggdmFsdWUsIG9sZFZhbHVlICkgPT4ge1xyXG4gICAgaWYgKCB2YWx1ZSA8IGZpbmFsQ291bnQgKSB7XHJcbiAgICAgIG15UHJvcGVydHkudmFsdWUgPSB2YWx1ZSArIDE7XHJcbiAgICAgIGNvbnNvbGUubG9nKCAnc3RhY2s6Jywgb2xkVmFsdWUsICctPicsIHZhbHVlICk7XHJcbiAgICB9XHJcbiAgfSApO1xyXG5cclxuICAvLyBzdGFjay1ub3RpZnk6XHJcbiAgLy8gOC0+OVxyXG4gIC8vIDctPjhcclxuICAvLyA2LT43XHJcbiAgLy8gLi4uXHJcbiAgLy8gMS0+MlxyXG4gIG15UHJvcGVydHkubGF6eUxpbmsoICggdmFsdWUsIG9sZFZhbHVlICkgPT4ge1xyXG4gICAgY291bnQrKztcclxuICAgIGFzc2VydC5vayggdmFsdWUgPT09IG9sZFZhbHVlICsgMSwgYGluY3JlbWVudCBlYWNoIHRpbWU6ICR7b2xkVmFsdWV9IC0+ICR7dmFsdWV9YCApO1xyXG4gICAgYXNzZXJ0Lm9rKCB2YWx1ZSA9PT0gbGFzdExpc3RlbmVyQ291bnQtLSwgYGluY3JlbWVudCBpbiBvcmRlciBleHBlY3RlZDogJHtsYXN0TGlzdGVuZXJDb3VudH0tPiR7bGFzdExpc3RlbmVyQ291bnQgKyAxfSwgcmVjZWl2ZWQ6ICR7b2xkVmFsdWV9IC0+ICR7dmFsdWV9YCApO1xyXG4gICAgYXNzZXJ0Lm9rKCBvbGRWYWx1ZSA9PT0gbGFzdExpc3RlbmVyQ291bnQsIGBuZXcgY291bnQgaXMgJHtsYXN0TGlzdGVuZXJDb3VudH06IHRoZSBvbGRWYWx1ZSAobW9zdCByZWNlbnQgZmlyc3QgaW4gc3RhY2sgZmlyc3RgICk7XHJcbiAgfSApO1xyXG4gIG15UHJvcGVydHkudmFsdWUgPSBjb3VudDtcclxufSApO1xyXG5cclxuXHJcblFVbml0LnRlc3QoICdUaW55UHJvcGVydHkgcmVlbnRyYW50IGxhenlMaW5rcyAocmVlbnRyYW50Tm90aWZpY2F0aW9uU3RyYXRlZ3k6cXVldWUpJywgYXNzZXJ0ID0+IHtcclxuXHJcbiAgY29uc3QgbXlQcm9wZXJ0eSA9IG5ldyBUaW55UHJvcGVydHk8bnVtYmVyPiggMCwgbnVsbCwgbnVsbCwgJ3F1ZXVlJyApO1xyXG4gIGxldCBsaW5rQ2FsbGVkQ291bnQgPSAwO1xyXG4gIGxldCByZWVudGVyZWQgPSBmYWxzZTtcclxuICBteVByb3BlcnR5LmxhenlMaW5rKCB2YWx1ZSA9PiB7XHJcbiAgICBpZiAoICFyZWVudGVyZWQgKSB7XHJcbiAgICAgIHJlZW50ZXJlZCA9IHRydWU7XHJcbiAgICAgIG15UHJvcGVydHkudmFsdWUgPSB2YWx1ZSArIDE7XHJcblxyXG4gICAgICBteVByb3BlcnR5LmxpbmsoIG5ld1ZhbHVlID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyggdmFsdWUsIG5ld1ZhbHVlICk7XHJcbiAgICAgICAgYXNzZXJ0Lm9rKCArK2xpbmtDYWxsZWRDb3VudCA8PSAxLCAnc2hvdWxkIG5vdCBiZSBjYWxsZWQgZnJvbSBvcmlnaW5hbCBjaGFuZ2UsIGp1c3QgZnJvbSBsaW5rJyApO1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICAvLyBUaGlzIGlzIGdyZWF0IS4gSXQgaXNuJ3QgYWN0dWFsbHkgbGlrZSBhIHF1ZXVlLCBidXQgaG93IHN0cmFuZ2UgaXQgd291bGQgYmUgdG8gaGF2ZSB0aGUgYWJvdmUgdmFsdWUgY2hhbmdlIHRyaWdnZXJcclxuICAgICAgLy8gdGhpcyBsaXN0ZW5lciBiZWNhdXNlIG9mIHRoZSBxdWV1ZSBiYXNlZCByZWVudHJhbnQgbm90aWZpY2F0aW9uIHN0cmF0ZWd5LiBJdCBpcyBiZXR0ZXIgdG8gZ3VhcmQgYWdhaW5zdCB0aGF0IHNvXHJcbiAgICAgIC8vIHRoaXMgaXNuJ3QgY2FsbGVkIG9uIHByZXZpb3VzbHkgY2FsbGVkIHZhbHVlIGNoYW5nZXMuXHJcbiAgICAgIG15UHJvcGVydHkubGF6eUxpbmsoICgpID0+IHsgYXNzZXJ0Lm9rKCBmYWxzZSwgJ3Nob3VsZCBub3QgYmUgY2FsbGVkIGZyb20gb3JpZ2luYWwgY2hhbmdlJyApOyB9ICk7XHJcbiAgICB9XHJcbiAgfSApO1xyXG4gIG15UHJvcGVydHkudmFsdWUgPSAxO1xyXG5cclxuICBteVByb3BlcnR5LnJlbW92ZUFsbExpc3RlbmVycygpO1xyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xyXG4gIG15UHJvcGVydHkudmFsdWUgPSAtMTtcclxuICBteVByb3BlcnR5LmxhenlMaW5rKCBvcmlnaW5hbFZhbHVlID0+IHtcclxuXHJcbiAgICBpZiAoIG9yaWdpbmFsVmFsdWUgPCA1ICkge1xyXG4gICAgICBsZXQgbGF6eUxpbmtDYWxsZWRDb3VudCA9IG9yaWdpbmFsVmFsdWUgKyAxO1xyXG4gICAgICBteVByb3BlcnR5LnZhbHVlID0gb3JpZ2luYWxWYWx1ZSArIDE7XHJcbiAgICAgIGFzc2VydC5lcXVhbCggbXlQcm9wZXJ0eS52YWx1ZSwgb3JpZ2luYWxWYWx1ZSArIDEsICd2YWx1ZSBpcyBpbW1lZGlhdGVseSBjb3JyZWN0IGZvciBhY2Nlc3MgKHJlZW50cmFudGx5KScgKTtcclxuICAgICAgbXlQcm9wZXJ0eS5sYXp5TGluayggbmV3VmFsdWUgPT4ge1xyXG4gICAgICAgIGFzc2VydC5vayggbmV3VmFsdWUgIT09IG9yaWdpbmFsVmFsdWUsIGAke29yaWdpbmFsVmFsdWV9OiBzaG91bGQgbm90IGJlIGNhbGxlZCBmcm9tIG9yaWdpbmFsIGNoYW5nZWAgKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoIG5ld1ZhbHVlLCArK2xhenlMaW5rQ2FsbGVkQ291bnQsIGAke2xhenlMaW5rQ2FsbGVkQ291bnR9OiBzaG91bGQgYmUgY2FsbGVkIGluIG9yZGVyIChsYXp5TGluaylgICk7XHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuICB9ICk7XHJcbiAgbXlQcm9wZXJ0eS52YWx1ZSA9IDA7XHJcbn0gKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFlBQVksTUFBTSxtQkFBbUI7QUFFNUMsT0FBT0MsT0FBTyxNQUFNLHlCQUF5QjtBQUU3Q0MsS0FBSyxDQUFDQyxNQUFNLENBQUUsY0FBZSxDQUFDO0FBRTlCRCxLQUFLLENBQUNFLElBQUksQ0FBRSxxQkFBcUIsRUFBRUMsTUFBTSxJQUFJO0VBQzNDLE1BQU1DLFFBQVEsR0FBRyxJQUFJTixZQUFZLENBQUUsR0FBSSxDQUFDO0VBQ3hDTSxRQUFRLENBQUNDLElBQUksQ0FBRUMsS0FBSyxJQUFJO0lBQ3RCQyxPQUFPLENBQUNDLEdBQUcsQ0FBRUYsS0FBTSxDQUFDO0VBQ3RCLENBQUUsQ0FBQztFQUVISCxNQUFNLENBQUNNLEVBQUUsQ0FBRSxJQUFJLEVBQUUsVUFBVyxDQUFDO0FBQy9CLENBQUUsQ0FBQztBQUVIVCxLQUFLLENBQUNFLElBQUksQ0FBRSw2QkFBNkIsRUFBRUMsTUFBTSxJQUFJO0VBRW5ELE1BQU1PLGdCQUFnQixDQUFDO0lBS2RDLFdBQVdBLENBQUEsRUFBRztNQUNuQixJQUFJLENBQUNDLE1BQU0sR0FBRyxLQUFLO01BQ25CLElBQUksQ0FBQ0MsTUFBTSxHQUFHLEtBQUs7TUFDbkIsSUFBSSxDQUFDQyxjQUFjLEdBQUcsSUFBSWhCLFlBQVksQ0FBRSxLQUFLLEVB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