// Copyright 2019-2024, University of Colorado Boulder

/**
 * Event & listener abstraction for a single "event" type. The type provides extra functionality beyond just notifying
 * listeners. It adds PhET-iO instrumentation capabilities as well as validation. For the lightest-weight, fastest
 * solution with the smallest memory footprint, see `TinyEmitter`.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import optionize from '../../phet-core/js/optionize.js';
import FunctionIO from '../../tandem/js/types/FunctionIO.js';
import IOType from '../../tandem/js/types/IOType.js';
import VoidIO from '../../tandem/js/types/VoidIO.js';
import PhetioDataHandler from '../../tandem/js/PhetioDataHandler.js';
import axon from './axon.js';
import TinyEmitter from './TinyEmitter.js';
import Tandem from '../../tandem/js/Tandem.js';
import NullableIO from '../../tandem/js/types/NullableIO.js';
import StringIO from '../../tandem/js/types/StringIO.js';
import ArrayIO from '../../tandem/js/types/ArrayIO.js';
import IOTypeCache from '../../tandem/js/IOTypeCache.js';

// By default, Emitters are not stateful
const PHET_IO_STATE_DEFAULT = false;
export default class Emitter extends PhetioDataHandler {
  // provide Emitter functionality via composition

  constructor(providedOptions) {
    const options = optionize()({
      reentrantNotificationStrategy: 'stack',
      phetioOuterType: Emitter.EmitterIO,
      phetioState: PHET_IO_STATE_DEFAULT
    }, providedOptions);
    super(options);
    this.tinyEmitter = new TinyEmitter(null, options.hasListenerOrderDependencies, options.reentrantNotificationStrategy);
  }

  /**
   * Emit to notify listeners
   */
  emit(...args) {
    assert && assert(this.tinyEmitter instanceof TinyEmitter, 'Emitter should not emit until constructor complete');
    assert && this.validateArguments(...args);

    // Although this is not the idiomatic pattern (since it is guarded in the phetioStartEvent), this function is
    // called so many times that it is worth the optimization for PhET brand.
    Tandem.PHET_IO_ENABLED && this.isPhetioInstrumented() && this.phetioStartEvent('emitted', {
      data: this.getPhetioData(...args)
    });
    this.tinyEmitter.emit(...args);
    Tandem.PHET_IO_ENABLED && this.isPhetioInstrumented() && this.phetioEndEvent();
  }

  /**
   * Disposes an Emitter. All listeners are removed.
   */
  dispose() {
    this.tinyEmitter.dispose();
    super.dispose();
  }

  /**
   * Adds a listener which will be called during emit.
   */
  addListener(listener) {
    this.tinyEmitter.addListener(listener);
  }

  /**
   * Removes a listener
   */
  removeListener(listener) {
    this.tinyEmitter.removeListener(listener);
  }

  /**
   * Removes all the listeners
   */
  removeAllListeners() {
    this.tinyEmitter.removeAllListeners();
  }

  /**
   * Checks whether a listener is registered with this Emitter
   */
  hasListener(listener) {
    return this.tinyEmitter.hasListener(listener);
  }

  /**
   * Returns true if there are any listeners.
   */
  hasListeners() {
    return this.tinyEmitter.hasListeners();
  }

  /**
   * Returns the number of listeners.
   */
  getListenerCount() {
    return this.tinyEmitter.getListenerCount();
  }

  /**
   * Convenience function for debugging a Property's value. It prints the new value on registration and when changed.
   * @param name - debug name to be printed on the console
   * @returns - the handle to the listener added in case it needs to be removed later
   */
  debug(name) {
    const listener = (...args) => console.log(name, ...args);
    this.addListener(listener);
    return listener;
  }

  /**
   * PhET-iO Type for Emitter.
   *
   * Providing validators to instrumented Emitters:
   * Instrumented Emitters should have their `validators` for each argument passed via EmitterIO (the phetioType).
   * To provide validators, there are two methods. First, by default each IOType has its own
   * validator that will be used. So specifying an argument object like `{ type: NumberIO }` will automatically use
   * `NumberIO.validator` as the validator. This can be overridden with the `validator` key (second option), like
   * { type: NumberIO, validator: { isValidValue: v=> typeof v === 'number' &&  v < 5 } }`
   * NOTE: currently the implementation is either/or, if a validator is provided via the `validator` key, the validator
   * from the `type` will be ignored.
   * see https://github.com/phetsims/axon/issues/204 for more details.
   *
   * @author Sam Reid (PhET Interactive Simulations)
   * @author Michael Kauzmann (PhET Interactive Simulations)
   * @author Andrew Adare (PhET Interactive Simulations)
   */
  static EmitterIO = parameterTypes => {
    const key = parameterTypes.map(getTypeName).join(',');
    if (!cache.has(key)) {
      cache.set(key, new IOType(`EmitterIO<${parameterTypes.map(getTypeName).join(', ')}>`, {
        valueType: Emitter,
        documentation: 'Emits when an event occurs and calls added listeners.',
        parameterTypes: parameterTypes,
        events: ['emitted'],
        metadataDefaults: {
          phetioState: PHET_IO_STATE_DEFAULT
        },
        methods: {
          addListener: {
            returnType: VoidIO,
            parameterTypes: [FunctionIO(VoidIO, parameterTypes)],
            implementation: Emitter.prototype.addListener,
            documentation: 'Adds a listener which will be called when the emitter emits.'
          },
          removeListener: {
            returnType: VoidIO,
            parameterTypes: [FunctionIO(VoidIO, parameterTypes)],
            implementation: Emitter.prototype.removeListener,
            documentation: 'Remove a listener.'
          },
          emit: {
            returnType: VoidIO,
            parameterTypes: parameterTypes,
            // Match `Emitter.emit`'s dynamic number of arguments
            implementation: function (...values) {
              this.emit(...values);
            },
            documentation: 'Emits a single event to all listeners.',
            invocableForReadOnlyElements: false
          },
          getValidationErrors: {
            returnType: ArrayIO(NullableIO(StringIO)),
            parameterTypes: parameterTypes,
            implementation: function (...values) {
              return this.getValidationErrors(...values);
            },
            documentation: 'Checks to see if the proposed values are valid. Returns an array of length N where each element is an error (string) or null if the value is valid.'
          }
        }
      }));
    }
    return cache.get(key);
  };
}
const getTypeName = ioType => ioType.typeName;

// {Map.<string, IOType>} - Cache each parameterized IOType so that
// it is only created once.
const cache = new IOTypeCache();
axon.register('Emitter', Emitter);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvcHRpb25pemUiLCJGdW5jdGlvbklPIiwiSU9UeXBlIiwiVm9pZElPIiwiUGhldGlvRGF0YUhhbmRsZXIiLCJheG9uIiwiVGlueUVtaXR0ZXIiLCJUYW5kZW0iLCJOdWxsYWJsZUlPIiwiU3RyaW5nSU8iLCJBcnJheUlPIiwiSU9UeXBlQ2FjaGUiLCJQSEVUX0lPX1NUQVRFX0RFRkFVTFQiLCJFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwicmVlbnRyYW50Tm90aWZpY2F0aW9uU3RyYXRlZ3kiLCJwaGV0aW9PdXRlclR5cGUiLCJFbWl0dGVySU8iLCJwaGV0aW9TdGF0ZSIsInRpbnlFbWl0dGVyIiwiaGFzTGlzdGVuZXJPcmRlckRlcGVuZGVuY2llcyIsImVtaXQiLCJhcmdzIiwiYXNzZXJ0IiwidmFsaWRhdGVBcmd1bWVudHMiLCJQSEVUX0lPX0VOQUJMRUQiLCJpc1BoZXRpb0luc3RydW1lbnRlZCIsInBoZXRpb1N0YXJ0RXZlbnQiLCJkYXRhIiwiZ2V0UGhldGlvRGF0YSIsInBoZXRpb0VuZEV2ZW50IiwiZGlzcG9zZSIsImFkZExpc3RlbmVyIiwibGlzdGVuZXIiLCJyZW1vdmVMaXN0ZW5lciIsInJlbW92ZUFsbExpc3RlbmVycyIsImhhc0xpc3RlbmVyIiwiaGFzTGlzdGVuZXJzIiwiZ2V0TGlzdGVuZXJDb3VudCIsImRlYnVnIiwibmFtZSIsImNvbnNvbGUiLCJsb2ciLCJwYXJhbWV0ZXJUeXBlcyIsImtleSIsIm1hcCIsImdldFR5cGVOYW1lIiwiam9pbiIsImNhY2hlIiwiaGFzIiwic2V0IiwidmFsdWVUeXBlIiwiZG9jdW1lbnRhdGlvbiIsImV2ZW50cyIsIm1ldGFkYXRhRGVmYXVsdHMiLCJtZXRob2RzIiwicmV0dXJuVHlwZSIsImltcGxlbWVudGF0aW9uIiwicHJvdG90eXBlIiwidmFsdWVzIiwiaW52b2NhYmxlRm9yUmVhZE9ubHlFbGVtZW50cyIsImdldFZhbGlkYXRpb25FcnJvcnMiLCJnZXQiLCJpb1R5cGUiLCJ0eXBlTmFtZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRW1pdHRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBFdmVudCAmIGxpc3RlbmVyIGFic3RyYWN0aW9uIGZvciBhIHNpbmdsZSBcImV2ZW50XCIgdHlwZS4gVGhlIHR5cGUgcHJvdmlkZXMgZXh0cmEgZnVuY3Rpb25hbGl0eSBiZXlvbmQganVzdCBub3RpZnlpbmdcclxuICogbGlzdGVuZXJzLiBJdCBhZGRzIFBoRVQtaU8gaW5zdHJ1bWVudGF0aW9uIGNhcGFiaWxpdGllcyBhcyB3ZWxsIGFzIHZhbGlkYXRpb24uIEZvciB0aGUgbGlnaHRlc3Qtd2VpZ2h0LCBmYXN0ZXN0XHJcbiAqIHNvbHV0aW9uIHdpdGggdGhlIHNtYWxsZXN0IG1lbW9yeSBmb290cHJpbnQsIHNlZSBgVGlueUVtaXR0ZXJgLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIE1pY2hhZWwgS2F1em1hbm4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgRnVuY3Rpb25JTyBmcm9tICcuLi8uLi90YW5kZW0vanMvdHlwZXMvRnVuY3Rpb25JTy5qcyc7XHJcbmltcG9ydCBJT1R5cGUgZnJvbSAnLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0lPVHlwZS5qcyc7XHJcbmltcG9ydCBWb2lkSU8gZnJvbSAnLi4vLi4vdGFuZGVtL2pzL3R5cGVzL1ZvaWRJTy5qcyc7XHJcbmltcG9ydCBQaGV0aW9EYXRhSGFuZGxlciwgeyBQaGV0aW9EYXRhSGFuZGxlck9wdGlvbnMgfSBmcm9tICcuLi8uLi90YW5kZW0vanMvUGhldGlvRGF0YUhhbmRsZXIuanMnO1xyXG5pbXBvcnQgYXhvbiBmcm9tICcuL2F4b24uanMnO1xyXG5pbXBvcnQgVGlueUVtaXR0ZXIsIHsgVGlueUVtaXR0ZXJPcHRpb25zIH0gZnJvbSAnLi9UaW55RW1pdHRlci5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBURW1pdHRlciwgeyBURW1pdHRlckxpc3RlbmVyLCBURW1pdHRlclBhcmFtZXRlciB9IGZyb20gJy4vVEVtaXR0ZXIuanMnO1xyXG5pbXBvcnQgTnVsbGFibGVJTyBmcm9tICcuLi8uLi90YW5kZW0vanMvdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCBTdHJpbmdJTyBmcm9tICcuLi8uLi90YW5kZW0vanMvdHlwZXMvU3RyaW5nSU8uanMnO1xyXG5pbXBvcnQgQXJyYXlJTyBmcm9tICcuLi8uLi90YW5kZW0vanMvdHlwZXMvQXJyYXlJTy5qcyc7XHJcbmltcG9ydCBJT1R5cGVDYWNoZSBmcm9tICcuLi8uLi90YW5kZW0vanMvSU9UeXBlQ2FjaGUuanMnO1xyXG5cclxuLy8gQnkgZGVmYXVsdCwgRW1pdHRlcnMgYXJlIG5vdCBzdGF0ZWZ1bFxyXG5jb25zdCBQSEVUX0lPX1NUQVRFX0RFRkFVTFQgPSBmYWxzZTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSBQaWNrPFRpbnlFbWl0dGVyT3B0aW9ucywgJ3JlZW50cmFudE5vdGlmaWNhdGlvblN0cmF0ZWd5Jz47XHJcbmV4cG9ydCB0eXBlIEVtaXR0ZXJPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBTdHJpY3RPbWl0PFBoZXRpb0RhdGFIYW5kbGVyT3B0aW9ucywgJ3BoZXRpb091dGVyVHlwZSc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRW1pdHRlcjxUIGV4dGVuZHMgVEVtaXR0ZXJQYXJhbWV0ZXJbXSA9IFtdPiBleHRlbmRzIFBoZXRpb0RhdGFIYW5kbGVyPFQ+IGltcGxlbWVudHMgVEVtaXR0ZXI8VD4ge1xyXG5cclxuICAvLyBwcm92aWRlIEVtaXR0ZXIgZnVuY3Rpb25hbGl0eSB2aWEgY29tcG9zaXRpb25cclxuICBwcml2YXRlIHJlYWRvbmx5IHRpbnlFbWl0dGVyOiBUaW55RW1pdHRlcjxUPjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwcm92aWRlZE9wdGlvbnM/OiBFbWl0dGVyT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEVtaXR0ZXJPcHRpb25zLCBTZWxmT3B0aW9ucywgUGhldGlvRGF0YUhhbmRsZXJPcHRpb25zPigpKCB7XHJcbiAgICAgIHJlZW50cmFudE5vdGlmaWNhdGlvblN0cmF0ZWd5OiAnc3RhY2snLFxyXG5cclxuICAgICAgcGhldGlvT3V0ZXJUeXBlOiBFbWl0dGVyLkVtaXR0ZXJJTyxcclxuICAgICAgcGhldGlvU3RhdGU6IFBIRVRfSU9fU1RBVEVfREVGQVVMVFxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuICAgIHRoaXMudGlueUVtaXR0ZXIgPSBuZXcgVGlueUVtaXR0ZXIoIG51bGwsIG9wdGlvbnMuaGFzTGlzdGVuZXJPcmRlckRlcGVuZGVuY2llcywgb3B0aW9ucy5yZWVudHJhbnROb3RpZmljYXRpb25TdHJhdGVneSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRW1pdCB0byBub3RpZnkgbGlzdGVuZXJzXHJcbiAgICovXHJcbiAgcHVibGljIGVtaXQoIC4uLmFyZ3M6IFQgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLnRpbnlFbWl0dGVyIGluc3RhbmNlb2YgVGlueUVtaXR0ZXIsICdFbWl0dGVyIHNob3VsZCBub3QgZW1pdCB1bnRpbCBjb25zdHJ1Y3RvciBjb21wbGV0ZScgKTtcclxuICAgIGFzc2VydCAmJiB0aGlzLnZhbGlkYXRlQXJndW1lbnRzKCAuLi5hcmdzICk7XHJcblxyXG4gICAgLy8gQWx0aG91Z2ggdGhpcyBpcyBub3QgdGhlIGlkaW9tYXRpYyBwYXR0ZXJuIChzaW5jZSBpdCBpcyBndWFyZGVkIGluIHRoZSBwaGV0aW9TdGFydEV2ZW50KSwgdGhpcyBmdW5jdGlvbiBpc1xyXG4gICAgLy8gY2FsbGVkIHNvIG1hbnkgdGltZXMgdGhhdCBpdCBpcyB3b3J0aCB0aGUgb3B0aW1pemF0aW9uIGZvciBQaEVUIGJyYW5kLlxyXG4gICAgVGFuZGVtLlBIRVRfSU9fRU5BQkxFRCAmJiB0aGlzLmlzUGhldGlvSW5zdHJ1bWVudGVkKCkgJiYgdGhpcy5waGV0aW9TdGFydEV2ZW50KCAnZW1pdHRlZCcsIHtcclxuICAgICAgZGF0YTogdGhpcy5nZXRQaGV0aW9EYXRhKCAuLi5hcmdzIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnRpbnlFbWl0dGVyLmVtaXQoIC4uLmFyZ3MgKTtcclxuXHJcbiAgICBUYW5kZW0uUEhFVF9JT19FTkFCTEVEICYmIHRoaXMuaXNQaGV0aW9JbnN0cnVtZW50ZWQoKSAmJiB0aGlzLnBoZXRpb0VuZEV2ZW50KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEaXNwb3NlcyBhbiBFbWl0dGVyLiBBbGwgbGlzdGVuZXJzIGFyZSByZW1vdmVkLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy50aW55RW1pdHRlci5kaXNwb3NlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGRzIGEgbGlzdGVuZXIgd2hpY2ggd2lsbCBiZSBjYWxsZWQgZHVyaW5nIGVtaXQuXHJcbiAgICovXHJcbiAgcHVibGljIGFkZExpc3RlbmVyKCBsaXN0ZW5lcjogVEVtaXR0ZXJMaXN0ZW5lcjxUPiApOiB2b2lkIHtcclxuICAgIHRoaXMudGlueUVtaXR0ZXIuYWRkTGlzdGVuZXIoIGxpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW1vdmVzIGEgbGlzdGVuZXJcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlTGlzdGVuZXIoIGxpc3RlbmVyOiBURW1pdHRlckxpc3RlbmVyPFQ+ICk6IHZvaWQge1xyXG4gICAgdGhpcy50aW55RW1pdHRlci5yZW1vdmVMaXN0ZW5lciggbGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbW92ZXMgYWxsIHRoZSBsaXN0ZW5lcnNcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQWxsTGlzdGVuZXJzKCk6IHZvaWQge1xyXG4gICAgdGhpcy50aW55RW1pdHRlci5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENoZWNrcyB3aGV0aGVyIGEgbGlzdGVuZXIgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoaXMgRW1pdHRlclxyXG4gICAqL1xyXG4gIHB1YmxpYyBoYXNMaXN0ZW5lciggbGlzdGVuZXI6IFRFbWl0dGVyTGlzdGVuZXI8VD4gKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy50aW55RW1pdHRlci5oYXNMaXN0ZW5lciggbGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdHJ1ZSBpZiB0aGVyZSBhcmUgYW55IGxpc3RlbmVycy5cclxuICAgKi9cclxuICBwdWJsaWMgaGFzTGlzdGVuZXJzKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMudGlueUVtaXR0ZXIuaGFzTGlzdGVuZXJzKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgbGlzdGVuZXJzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRMaXN0ZW5lckNvdW50KCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy50aW55RW1pdHRlci5nZXRMaXN0ZW5lckNvdW50KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb252ZW5pZW5jZSBmdW5jdGlvbiBmb3IgZGVidWdnaW5nIGEgUHJvcGVydHkncyB2YWx1ZS4gSXQgcHJpbnRzIHRoZSBuZXcgdmFsdWUgb24gcmVnaXN0cmF0aW9uIGFuZCB3aGVuIGNoYW5nZWQuXHJcbiAgICogQHBhcmFtIG5hbWUgLSBkZWJ1ZyBuYW1lIHRvIGJlIHByaW50ZWQgb24gdGhlIGNvbnNvbGVcclxuICAgKiBAcmV0dXJucyAtIHRoZSBoYW5kbGUgdG8gdGhlIGxpc3RlbmVyIGFkZGVkIGluIGNhc2UgaXQgbmVlZHMgdG8gYmUgcmVtb3ZlZCBsYXRlclxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZWJ1ZyggbmFtZTogc3RyaW5nICk6IFRFbWl0dGVyTGlzdGVuZXI8VD4ge1xyXG4gICAgY29uc3QgbGlzdGVuZXIgPSAoIC4uLmFyZ3M6IFQgKSA9PiBjb25zb2xlLmxvZyggbmFtZSwgLi4uYXJncyApO1xyXG4gICAgdGhpcy5hZGRMaXN0ZW5lciggbGlzdGVuZXIgKTtcclxuICAgIHJldHVybiBsaXN0ZW5lcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBoRVQtaU8gVHlwZSBmb3IgRW1pdHRlci5cclxuICAgKlxyXG4gICAqIFByb3ZpZGluZyB2YWxpZGF0b3JzIHRvIGluc3RydW1lbnRlZCBFbWl0dGVyczpcclxuICAgKiBJbnN0cnVtZW50ZWQgRW1pdHRlcnMgc2hvdWxkIGhhdmUgdGhlaXIgYHZhbGlkYXRvcnNgIGZvciBlYWNoIGFyZ3VtZW50IHBhc3NlZCB2aWEgRW1pdHRlcklPICh0aGUgcGhldGlvVHlwZSkuXHJcbiAgICogVG8gcHJvdmlkZSB2YWxpZGF0b3JzLCB0aGVyZSBhcmUgdHdvIG1ldGhvZHMuIEZpcnN0LCBieSBkZWZhdWx0IGVhY2ggSU9UeXBlIGhhcyBpdHMgb3duXHJcbiAgICogdmFsaWRhdG9yIHRoYXQgd2lsbCBiZSB1c2VkLiBTbyBzcGVjaWZ5aW5nIGFuIGFyZ3VtZW50IG9iamVjdCBsaWtlIGB7IHR5cGU6IE51bWJlcklPIH1gIHdpbGwgYXV0b21hdGljYWxseSB1c2VcclxuICAgKiBgTnVtYmVySU8udmFsaWRhdG9yYCBhcyB0aGUgdmFsaWRhdG9yLiBUaGlzIGNhbiBiZSBvdmVycmlkZGVuIHdpdGggdGhlIGB2YWxpZGF0b3JgIGtleSAoc2Vjb25kIG9wdGlvbiksIGxpa2VcclxuICAgKiB7IHR5cGU6IE51bWJlcklPLCB2YWxpZGF0b3I6IHsgaXNWYWxpZFZhbHVlOiB2PT4gdHlwZW9mIHYgPT09ICdudW1iZXInICYmICB2IDwgNSB9IH1gXHJcbiAgICogTk9URTogY3VycmVudGx5IHRoZSBpbXBsZW1lbnRhdGlvbiBpcyBlaXRoZXIvb3IsIGlmIGEgdmFsaWRhdG9yIGlzIHByb3ZpZGVkIHZpYSB0aGUgYHZhbGlkYXRvcmAga2V5LCB0aGUgdmFsaWRhdG9yXHJcbiAgICogZnJvbSB0aGUgYHR5cGVgIHdpbGwgYmUgaWdub3JlZC5cclxuICAgKiBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2F4b24vaXNzdWVzLzIwNCBmb3IgbW9yZSBkZXRhaWxzLlxyXG4gICAqXHJcbiAgICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICAgKiBAYXV0aG9yIE1pY2hhZWwgS2F1em1hbm4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAgICogQGF1dGhvciBBbmRyZXcgQWRhcmUgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBFbWl0dGVySU8gPSAoIHBhcmFtZXRlclR5cGVzOiBJT1R5cGVbXSApOiBJT1R5cGUgPT4ge1xyXG5cclxuICAgIGNvbnN0IGtleSA9IHBhcmFtZXRlclR5cGVzLm1hcCggZ2V0VHlwZU5hbWUgKS5qb2luKCAnLCcgKTtcclxuXHJcbiAgICBpZiAoICFjYWNoZS5oYXMoIGtleSApICkge1xyXG4gICAgICBjYWNoZS5zZXQoIGtleSwgbmV3IElPVHlwZSggYEVtaXR0ZXJJTzwke3BhcmFtZXRlclR5cGVzLm1hcCggZ2V0VHlwZU5hbWUgKS5qb2luKCAnLCAnICl9PmAsIHtcclxuICAgICAgICB2YWx1ZVR5cGU6IEVtaXR0ZXIsXHJcbiAgICAgICAgZG9jdW1lbnRhdGlvbjogJ0VtaXRzIHdoZW4gYW4gZXZlbnQgb2NjdXJzIGFuZCBjYWxscyBhZGRlZCBsaXN0ZW5lcnMuJyxcclxuICAgICAgICBwYXJhbWV0ZXJUeXBlczogcGFyYW1ldGVyVHlwZXMsXHJcbiAgICAgICAgZXZlbnRzOiBbICdlbWl0dGVkJyBdLFxyXG4gICAgICAgIG1ldGFkYXRhRGVmYXVsdHM6IHtcclxuICAgICAgICAgIHBoZXRpb1N0YXRlOiBQSEVUX0lPX1NUQVRFX0RFRkFVTFRcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1ldGhvZHM6IHtcclxuICAgICAgICAgIGFkZExpc3RlbmVyOiB7XHJcbiAgICAgICAgICAgIHJldHVyblR5cGU6IFZvaWRJTyxcclxuICAgICAgICAgICAgcGFyYW1ldGVyVHlwZXM6IFsgRnVuY3Rpb25JTyggVm9pZElPLCBwYXJhbWV0ZXJUeXBlcyApIF0sXHJcbiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcixcclxuICAgICAgICAgICAgZG9jdW1lbnRhdGlvbjogJ0FkZHMgYSBsaXN0ZW5lciB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBlbWl0dGVyIGVtaXRzLidcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICByZW1vdmVMaXN0ZW5lcjoge1xyXG4gICAgICAgICAgICByZXR1cm5UeXBlOiBWb2lkSU8sXHJcbiAgICAgICAgICAgIHBhcmFtZXRlclR5cGVzOiBbIEZ1bmN0aW9uSU8oIFZvaWRJTywgcGFyYW1ldGVyVHlwZXMgKSBdLFxyXG4gICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogRW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIsXHJcbiAgICAgICAgICAgIGRvY3VtZW50YXRpb246ICdSZW1vdmUgYSBsaXN0ZW5lci4nXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgZW1pdDoge1xyXG4gICAgICAgICAgICByZXR1cm5UeXBlOiBWb2lkSU8sXHJcbiAgICAgICAgICAgIHBhcmFtZXRlclR5cGVzOiBwYXJhbWV0ZXJUeXBlcyxcclxuXHJcbiAgICAgICAgICAgIC8vIE1hdGNoIGBFbWl0dGVyLmVtaXRgJ3MgZHluYW1pYyBudW1iZXIgb2YgYXJndW1lbnRzXHJcbiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBmdW5jdGlvbiggdGhpczogRW1pdHRlcjx1bmtub3duW10+LCAuLi52YWx1ZXM6IHVua25vd25bXSApIHtcclxuICAgICAgICAgICAgICB0aGlzLmVtaXQoIC4uLnZhbHVlcyApO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBkb2N1bWVudGF0aW9uOiAnRW1pdHMgYSBzaW5nbGUgZXZlbnQgdG8gYWxsIGxpc3RlbmVycy4nLFxyXG4gICAgICAgICAgICBpbnZvY2FibGVGb3JSZWFkT25seUVsZW1lbnRzOiBmYWxzZVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGdldFZhbGlkYXRpb25FcnJvcnM6IHtcclxuICAgICAgICAgICAgcmV0dXJuVHlwZTogQXJyYXlJTyggTnVsbGFibGVJTyggU3RyaW5nSU8gKSApLFxyXG4gICAgICAgICAgICBwYXJhbWV0ZXJUeXBlczogcGFyYW1ldGVyVHlwZXMsXHJcbiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBmdW5jdGlvbiggdGhpczogRW1pdHRlcjx1bmtub3duW10+LCAuLi52YWx1ZXM6IHVua25vd25bXSApIHtcclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWxpZGF0aW9uRXJyb3JzKCAuLi52YWx1ZXMgKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZG9jdW1lbnRhdGlvbjogJ0NoZWNrcyB0byBzZWUgaWYgdGhlIHByb3Bvc2VkIHZhbHVlcyBhcmUgdmFsaWQuIFJldHVybnMgYW4gYXJyYXkgb2YgbGVuZ3RoIE4gd2hlcmUgZWFjaCBlbGVtZW50IGlzIGFuIGVycm9yIChzdHJpbmcpIG9yIG51bGwgaWYgdGhlIHZhbHVlIGlzIHZhbGlkLidcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gKSApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGNhY2hlLmdldCgga2V5ICkhO1xyXG4gIH07XHJcbn1cclxuXHJcbmNvbnN0IGdldFR5cGVOYW1lID0gKCBpb1R5cGU6IElPVHlwZSApID0+IGlvVHlwZS50eXBlTmFtZTtcclxuXHJcbi8vIHtNYXAuPHN0cmluZywgSU9UeXBlPn0gLSBDYWNoZSBlYWNoIHBhcmFtZXRlcml6ZWQgSU9UeXBlIHNvIHRoYXRcclxuLy8gaXQgaXMgb25seSBjcmVhdGVkIG9uY2UuXHJcbmNvbnN0IGNhY2hlID0gbmV3IElPVHlwZUNhY2hlPHN0cmluZz4oKTtcclxuXHJcbmF4b24ucmVnaXN0ZXIoICdFbWl0dGVyJywgRW1pdHRlciApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxTQUFTLE1BQU0saUNBQWlDO0FBRXZELE9BQU9DLFVBQVUsTUFBTSxxQ0FBcUM7QUFDNUQsT0FBT0MsTUFBTSxNQUFNLGlDQUFpQztBQUNwRCxPQUFPQyxNQUFNLE1BQU0saUNBQWlDO0FBQ3BELE9BQU9DLGlCQUFpQixNQUFvQyxzQ0FBc0M7QUFDbEcsT0FBT0MsSUFBSSxNQUFNLFdBQVc7QUFDNUIsT0FBT0MsV0FBVyxNQUE4QixrQkFBa0I7QUFDbEUsT0FBT0MsTUFBTSxNQUFNLDJCQUEyQjtBQUU5QyxPQUFPQyxVQUFVLE1BQU0scUNBQXFDO0FBQzVELE9BQU9DLFFBQVEsTUFBTSxtQ0FBbUM7QUFDeEQsT0FBT0MsT0FBTyxNQUFNLGtDQUFrQztBQUN0RCxPQUFPQyxXQUFXLE1BQU0sZ0NBQWdDOztBQUV4RDtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLEtBQUs7QUFLbkMsZUFBZSxNQUFNQyxPQUFPLFNBQTZDVCxpQkFBaUIsQ0FBMkI7RUFFbkg7O0VBR09VLFdBQVdBLENBQUVDLGVBQWdDLEVBQUc7SUFFckQsTUFBTUMsT0FBTyxHQUFHaEIsU0FBUyxDQUF3RCxDQUFDLENBQUU7TUFDbEZpQiw2QkFBNkIsRUFBRSxPQUFPO01BRXRDQyxlQUFlLEVBQUVMLE9BQU8sQ0FBQ00sU0FBUztNQUNsQ0MsV0FBVyxFQUFFUjtJQUNmLENBQUMsRUFBRUcsZUFBZ0IsQ0FBQztJQUVwQixLQUFLLENBQUVDLE9BQVEsQ0FBQztJQUNoQixJQUFJLENBQUNLLFdBQVcsR0FBRyxJQUFJZixXQUFXLENBQUUsSUFBSSxFQUFFVSxPQUFPLENBQUNNLDRCQUE0QixFQUFFTixPQUFPLENBQUNDLDZCQUE4QixDQUFDO0VBQ3pIOztFQUVBO0FBQ0Y7QUFDQTtFQUNTTSxJQUFJQSxDQUFFLEdBQUdDLElBQU8sRUFBUztJQUM5QkMsTUFBTSxJQUFJQSxNQUFNLENBQUUsSUFBSSxDQUFDSixXQUFXLFlBQVlmLFdBQVcsRUFBRSxvREFBcUQsQ0FBQztJQUNqSG1CLE1BQU0sSUFBSSxJQUFJLENBQUNDLGlCQUFpQixDQUFFLEdBQUdGLElBQUssQ0FBQzs7SUFFM0M7SUFDQTtJQUNBakIsTUFBTSxDQUFDb0IsZUFBZSxJQUFJLElBQUksQ0FBQ0Msb0JBQW9CLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQ0MsZ0JBQWdCLENBQUUsU0FBUyxFQUFFO01BQ3pGQyxJQUFJLEVBQUUsSUFBSSxDQUFDQyxhQUFhLENBQUUsR0FBR1AsSUFBSztJQUNwQyxDQUFFLENBQUM7SUFFSCxJQUFJLENBQUNILFdBQVcsQ0FBQ0UsSUFBSSxDQUFFLEdBQUdDLElBQUssQ0FBQztJQUVoQ2pCLE1BQU0sQ0FBQ29CLGVBQWUsSUFBSSxJQUFJLENBQUNDLG9CQUFvQixDQUFDLENBQUMsSUFBSSxJQUFJLENBQUNJLGNBQWMsQ0FBQyxDQUFDO0VBQ2hGOztFQUVBO0FBQ0Y7QUFDQTtFQUNrQkMsT0FBT0EsQ0FBQSxFQUFTO0lBQzlCLElBQUksQ0FBQ1osV0FBVyxDQUFDWSxPQUFPLENBQUMsQ0FBQztJQUMxQixLQUFLLENBQUNBLE9BQU8sQ0FBQyxDQUFDO0VBQ2pCOztFQUVBO0FBQ0Y7QUFDQTtFQUNTQyxXQUFXQSxDQUFFQyxRQUE2QixFQUFTO0lBQ3hELElBQUksQ0FBQ2QsV0FBVyxDQUFDYSxXQUFXLENBQUVDLFFBQVMsQ0FBQztFQUMxQzs7RUFFQTtBQUNGO0FBQ0E7RUFDU0MsY0FBY0EsQ0FBRUQsUUFBNkIsRUFBUztJQUMzRCxJQUFJLENBQUNkLFdBQVcsQ0FBQ2UsY0FBYyxDQUFFRCxRQUFTLENBQUM7RUFDN0M7O0VBRUE7QUFDRjtBQUNBO0VBQ1NFLGtCQUFrQkEsQ0FBQSxFQUFTO0lBQ2hDLElBQUksQ0FBQ2hCLFdBQVcsQ0FBQ2dCLGtCQUFrQixDQUFDLENBQUM7RUFDdkM7O0VBRUE7QUFDRjtBQUNBO0VBQ1NDLFdBQVdBLENBQUVILFFBQTZCLEVBQVk7SUFDM0QsT0FBTyxJQUFJLENBQUNkLFdBQVcsQ0FBQ2lCLFdBQVcsQ0FBRUgsUUFBUyxDQUFDO0VBQ2pEOztFQUVBO0FBQ0Y7QUFDQTtFQUNTSSxZQUFZQSxDQUFBLEVBQVk7SUFDN0IsT0FBTyxJQUFJLENBQUNsQixXQUFXLENBQUNrQixZQUFZLENBQUMsQ0FBQztFQUN4Qzs7RUFFQTtBQUNGO0FBQ0E7RUFDU0MsZ0JBQWdCQSxDQUFBLEVBQVc7SUFDaEMsT0FBTyxJQUFJLENBQUNuQixXQUFXLENBQUNtQixnQkFBZ0IsQ0FBQyxDQUFDO0VBQzVDOztFQUVBO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7RUFDU0MsS0FBS0EsQ0FBRUMsSUFBWSxFQUF3QjtJQUNoRCxNQUFNUCxRQUFRLEdBQUdBLENBQUUsR0FBR1gsSUFBTyxLQUFNbUIsT0FBTyxDQUFDQyxHQUFHLENBQUVGLElBQUksRUFBRSxHQUFHbEIsSUFBSyxDQUFDO0lBQy9ELElBQUksQ0FBQ1UsV0FBVyxDQUFFQyxRQUFTLENBQUM7SUFDNUIsT0FBT0EsUUFBUTtFQUNqQjs7RUFFQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0UsT0FBdUJoQixTQUFTLEdBQUswQixjQUF3QixJQUFjO0lBRXpFLE1BQU1DLEdBQUcsR0FBR0QsY0FBYyxDQUFDRSxHQUFHLENBQUVDLFdBQVksQ0FBQyxDQUFDQyxJQUFJLENBQUUsR0FBSSxDQUFDO0lBRXpELElBQUssQ0FBQ0MsS0FBSyxDQUFDQyxHQUFHLENBQUVMLEdBQUksQ0FBQyxFQUFHO01BQ3ZCSSxLQUFLLENBQUNFLEdBQUcsQ0FBRU4sR0FBRyxFQUFFLElBQUk1QyxNQUFNLENBQUcsYUFBWTJDLGNBQWMsQ0FBQ0UsR0FBRyxDQUFFQyxXQUFZLENBQUMsQ0FBQ0MsSUFBSSxDQUFFLElBQUssQ0FBRSxHQUFFLEVBQUU7UUFDMUZJLFNBQVMsRUFBRXhDLE9BQU87UUFDbEJ5QyxhQUFhLEVBQUUsdURBQXVEO1FBQ3RFVCxjQUFjLEVBQUVBLGNBQWM7UUFDOUJVLE1BQU0sRUFBRSxDQUFFLFNBQVMsQ0FBRTtRQUNyQkMsZ0JBQWdCLEVBQUU7VUFDaEJwQyxXQUFXLEVBQUVSO1FBQ2YsQ0FBQztRQUNENkMsT0FBTyxFQUFFO1VBQ1B2QixXQUFXLEVBQUU7WUFDWHdCLFVBQVUsRUFBRXZELE1BQU07WUFDbEIwQyxjQUFjLEVBQUUsQ0FBRTVDLFVBQVUsQ0FBRUUsTUFBTSxFQUFFMEMsY0FBZSxDQUFDLENBQUU7WUFDeERjLGNBQWMsRUFBRTlDLE9BQU8sQ0FBQytDLFNBQVMsQ0FBQzFCLFdBQVc7WUFDN0NvQixhQUFhLEVBQUU7VUFDakIsQ0FBQztVQUNEbEIsY0FBYyxFQUFFO1lBQ2RzQixVQUFVLEVBQUV2RCxNQUFNO1lBQ2xCMEMsY0FBYyxFQUFFLENBQUU1QyxVQUFVLENBQUVFLE1BQU0sRUFBRTBDLGNBQWUsQ0FBQyxDQUFFO1lBQ3hEYyxjQUFjLEVBQUU5QyxPQUFPLENBQUMrQyxTQUFTLENBQUN4QixjQUFjO1lBQ2hEa0IsYUFBYSxFQUFFO1VBQ2pCLENBQUM7VUFDRC9CLElBQUksRUFBRTtZQUNKbUMsVUFBVSxFQUFFdkQsTUFBTTtZQUNsQjBDLGNBQWMsRUFBRUEsY0FBYztZQUU5QjtZQUNBYyxjQUFjLEVBQUUsU0FBQUEsQ0FBb0MsR0FBR0UsTUFBaUIsRUFBRztjQUN6RSxJQUFJLENBQUN0QyxJQUFJLENBQUUsR0FBR3NDLE1BQU8sQ0FBQztZQUN4QixDQUFDO1lBQ0RQLGFBQWEsRUFBRSx3Q0FBd0M7WUFDdkRRLDRCQUE0QixFQUFFO1VBQ2hDLENBQUM7VUFDREMsbUJBQW1CLEVBQUU7WUFDbkJMLFVBQVUsRUFBRWhELE9BQU8sQ0FBRUYsVUFBVSxDQUFFQyxRQUFTLENBQUUsQ0FBQztZQUM3Q29DLGNBQWMsRUFBRUEsY0FBYztZQUM5QmMsY0FBYyxFQUFFLFNBQUFBLENBQW9DLEdBQUdFLE1BQWlCLEVBQUc7Y0FDekUsT0FBTyxJQUFJLENBQUNFLG1CQUFtQixDQUFFLEdBQUdGLE1BQU8sQ0FBQztZQUM5QyxDQUFDO1lBQ0RQLGFBQWEsRUFBRTtVQUNqQjtRQUNGO01BQ0YsQ0FBRSxDQUFFLENBQUM7SUFDUDtJQUNBLE9BQU9KLEtBQUssQ0FBQ2MsR0FBRyxDQUFFbEIsR0FBSSxDQUFDO0VBQ3pCLENBQUM7QUFDSDtBQUVBLE1BQU1FLFdBQVcsR0FBS2lCLE1BQWMsSUFBTUEsTUFBTSxDQUFDQyxRQUFROztBQUV6RDtBQUNBO0FBQ0EsTUFBTWhCLEtBQUssR0FBRyxJQUFJdkMsV0FBVyxDQUFTLENBQUM7QUFFdkNOLElBQUksQ0FBQzhELFFBQVEsQ0FBRSxTQUFTLEVBQUV0RCxPQUFRLENBQUMiLCJpZ25vcmVMaXN0IjpbXX0=