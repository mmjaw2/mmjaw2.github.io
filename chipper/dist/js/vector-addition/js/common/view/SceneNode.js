// Copyright 2019-2023, University of Colorado Boulder

/**
 * View for a scene node. Scene nodes allow screens to have multiple 'scenes'. For instance, 'Explore 2D' has a polar
 * and a Cartesian 'scene' and 'Explore 1D' has a horizontal and a vertical 'scene'.
 *
 * ## A 'Scene Node' contains:
 *  - a single GraphNode
 *  - a single VectorValuesToggleBox
 *  - Handle z-layering of all vector types (see https://github.com/phetsims/vector-addition/issues/19)
 *  - An option to include an EraserButton
 *  - A method to add a VectorCreatorPanel
 *
 * ## API
 *  - Not required to tell the Scene Node to create the SumVectorNodes and their Components (does this automatically
 *    for each VectorSet in the Graph)
 *  - However, it is required to 'tell' the Scene Node when other Vectors are created (see registerVector()). Once this
 *    is called, the Vector Nodes/Components are made and deleted once the Vector is removed.
 *
 * NOTE: SceneNode will not toggle its visibility based on when the GraphOrientation or the CoordinateSnapMode
 *       changes. This must be done externally.
 *
 * @author Brandon Li
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import EraserButton from '../../../../scenery-phet/js/buttons/EraserButton.js';
import { Node } from '../../../../scenery/js/imports.js';
import vectorAddition from '../../vectorAddition.js';
import GraphNode from './GraphNode.js';
import VectorSetNode from './VectorSetNode.js';
import VectorValuesToggleBox from './VectorValuesToggleBox.js';
import optionize from '../../../../phet-core/js/optionize.js';
export default class SceneNode extends Node {
  // parent for all VectorSetNodes

  // a layer for each VectorSet

  // for layout in subclasses

  constructor(graph, viewProperties, componentStyleProperty, providedOptions) {
    const options = optionize()({
      // SelfOptions
      includeEraser: true,
      // NodeOptions
      isDisposable: false
    }, providedOptions);
    super();

    //========================================================================================

    // Create one and only GraphNode
    const graphNode = new GraphNode(graph, viewProperties.gridVisibleProperty);

    // Create the one and only 'Vector Values' toggle box
    const vectorValuesToggleBox = new VectorValuesToggleBox(graph, {
      expandedProperty: viewProperties.vectorValuesExpandedProperty,
      centerX: graph.graphViewBounds.centerX,
      top: 35 // determined empirically
    });

    //----------------------------------------------------------------------------------------
    // Create containers for each and every type of Vector to handle z-layering of all vector types.

    this.vectorSetNodesParent = new Node();

    // Add the children in the correct z-order
    this.setChildren([graphNode, vectorValuesToggleBox, this.vectorSetNodesParent]);

    // Add an eraser button if necessary
    if (options.includeEraser) {
      const eraserButton = new EraserButton({
        listener: () => {
          this.interruptSubtreeInput(); // cancel all interactions for the scene
          graph.erase();
        },
        right: graph.graphViewBounds.maxX,
        top: graph.graphViewBounds.maxY + 15,
        touchAreaXDilation: 7,
        touchAreaYDilation: 7
      });
      this.addChild(eraserButton);
      eraserButton.moveToBack();

      // Disable the eraser button when the number of vectors on the graph is zero, that is, when all vector sets
      // contain no vectors. This is a bit more complicated than it should be, but it was added late in the
      // development process.
      // unmultilink is unnecessary, exists for the lifetime of the sim.
      const lengthProperties = _.map(graph.vectorSets, vectorSet => vectorSet.vectors.lengthProperty);
      Multilink.multilinkAny(lengthProperties, () => {
        const numberOfVectors = _.sumBy(lengthProperties, lengthProperty => lengthProperty.value);
        eraserButton.enabled = numberOfVectors !== 0;
      });
    }

    // a layer for each VectorSet
    this.vectorSetNodes = [];
    graph.vectorSets.forEach(vectorSet => {
      const vectorSetNode = new VectorSetNode(graph, vectorSet, viewProperties.valuesVisibleProperty, viewProperties.anglesVisibleProperty, componentStyleProperty);
      this.vectorSetNodesParent.addChild(vectorSetNode);
      this.vectorSetNodes.push(vectorSetNode);
    });
    this.vectorValuesToggleBox = vectorValuesToggleBox;
    this.vectorSets = graph.vectorSets;
  }

  /**
   * Gets the VectorSetNode associated with a VectorSet.
   */
  getVectorSetNode(vectorSet) {
    const index = this.vectorSets.indexOf(vectorSet);
    assert && assert(index !== -1, 'vectorSet not found');
    return this.vectorSetNodes[index];
  }

  /**
   * Registers a Vector, delegates to VectorSetNode.
   * @param vector - the vector model
   * @param vectorSet - the VectorSet the vector belongs to
   * @param [forwardingEvent] - see VectorSetNode
   */
  registerVector(vector, vectorSet, forwardingEvent) {
    this.getVectorSetNode(vectorSet).registerVector(vector, forwardingEvent);
  }

  /**
   * Adds a base vector to the scene.  Delegates to VectorSetNode.
   */
  addBaseVector(vectorSet, baseVector, baseVectorsVisibleProperty) {
    this.getVectorSetNode(vectorSet).addBaseVector(baseVector, baseVectorsVisibleProperty, vectorSet.vectorColorPalette);
  }

  /**
   * Adds a VectorCreatorPanel to the scene.
   */
  addVectorCreatorPanel(vectorCreatorPanel) {
    this.addChild(vectorCreatorPanel);
    vectorCreatorPanel.moveToBack();
  }
}
vectorAddition.register('SceneNode', SceneNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJFcmFzZXJCdXR0b24iLCJOb2RlIiwidmVjdG9yQWRkaXRpb24iLCJHcmFwaE5vZGUiLCJWZWN0b3JTZXROb2RlIiwiVmVjdG9yVmFsdWVzVG9nZ2xlQm94Iiwib3B0aW9uaXplIiwiU2NlbmVOb2RlIiwiY29uc3RydWN0b3IiLCJncmFwaCIsInZpZXdQcm9wZXJ0aWVzIiwiY29tcG9uZW50U3R5bGVQcm9wZXJ0eSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJpbmNsdWRlRXJhc2VyIiwiaXNEaXNwb3NhYmxlIiwiZ3JhcGhOb2RlIiwiZ3JpZFZpc2libGVQcm9wZXJ0eSIsInZlY3RvclZhbHVlc1RvZ2dsZUJveCIsImV4cGFuZGVkUHJvcGVydHkiLCJ2ZWN0b3JWYWx1ZXNFeHBhbmRlZFByb3BlcnR5IiwiY2VudGVyWCIsImdyYXBoVmlld0JvdW5kcyIsInRvcCIsInZlY3RvclNldE5vZGVzUGFyZW50Iiwic2V0Q2hpbGRyZW4iLCJlcmFzZXJCdXR0b24iLCJsaXN0ZW5lciIsImludGVycnVwdFN1YnRyZWVJbnB1dCIsImVyYXNlIiwicmlnaHQiLCJtYXhYIiwibWF4WSIsInRvdWNoQXJlYVhEaWxhdGlvbiIsInRvdWNoQXJlYVlEaWxhdGlvbiIsImFkZENoaWxkIiwibW92ZVRvQmFjayIsImxlbmd0aFByb3BlcnRpZXMiLCJfIiwibWFwIiwidmVjdG9yU2V0cyIsInZlY3RvclNldCIsInZlY3RvcnMiLCJsZW5ndGhQcm9wZXJ0eSIsIm11bHRpbGlua0FueSIsIm51bWJlck9mVmVjdG9ycyIsInN1bUJ5IiwidmFsdWUiLCJlbmFibGVkIiwidmVjdG9yU2V0Tm9kZXMiLCJmb3JFYWNoIiwidmVjdG9yU2V0Tm9kZSIsInZhbHVlc1Zpc2libGVQcm9wZXJ0eSIsImFuZ2xlc1Zpc2libGVQcm9wZXJ0eSIsInB1c2giLCJnZXRWZWN0b3JTZXROb2RlIiwiaW5kZXgiLCJpbmRleE9mIiwiYXNzZXJ0IiwicmVnaXN0ZXJWZWN0b3IiLCJ2ZWN0b3IiLCJmb3J3YXJkaW5nRXZlbnQiLCJhZGRCYXNlVmVjdG9yIiwiYmFzZVZlY3RvciIsImJhc2VWZWN0b3JzVmlzaWJsZVByb3BlcnR5IiwidmVjdG9yQ29sb3JQYWxldHRlIiwiYWRkVmVjdG9yQ3JlYXRvclBhbmVsIiwidmVjdG9yQ3JlYXRvclBhbmVsIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJTY2VuZU5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVmlldyBmb3IgYSBzY2VuZSBub2RlLiBTY2VuZSBub2RlcyBhbGxvdyBzY3JlZW5zIHRvIGhhdmUgbXVsdGlwbGUgJ3NjZW5lcycuIEZvciBpbnN0YW5jZSwgJ0V4cGxvcmUgMkQnIGhhcyBhIHBvbGFyXHJcbiAqIGFuZCBhIENhcnRlc2lhbiAnc2NlbmUnIGFuZCAnRXhwbG9yZSAxRCcgaGFzIGEgaG9yaXpvbnRhbCBhbmQgYSB2ZXJ0aWNhbCAnc2NlbmUnLlxyXG4gKlxyXG4gKiAjIyBBICdTY2VuZSBOb2RlJyBjb250YWluczpcclxuICogIC0gYSBzaW5nbGUgR3JhcGhOb2RlXHJcbiAqICAtIGEgc2luZ2xlIFZlY3RvclZhbHVlc1RvZ2dsZUJveFxyXG4gKiAgLSBIYW5kbGUgei1sYXllcmluZyBvZiBhbGwgdmVjdG9yIHR5cGVzIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3ZlY3Rvci1hZGRpdGlvbi9pc3N1ZXMvMTkpXHJcbiAqICAtIEFuIG9wdGlvbiB0byBpbmNsdWRlIGFuIEVyYXNlckJ1dHRvblxyXG4gKiAgLSBBIG1ldGhvZCB0byBhZGQgYSBWZWN0b3JDcmVhdG9yUGFuZWxcclxuICpcclxuICogIyMgQVBJXHJcbiAqICAtIE5vdCByZXF1aXJlZCB0byB0ZWxsIHRoZSBTY2VuZSBOb2RlIHRvIGNyZWF0ZSB0aGUgU3VtVmVjdG9yTm9kZXMgYW5kIHRoZWlyIENvbXBvbmVudHMgKGRvZXMgdGhpcyBhdXRvbWF0aWNhbGx5XHJcbiAqICAgIGZvciBlYWNoIFZlY3RvclNldCBpbiB0aGUgR3JhcGgpXHJcbiAqICAtIEhvd2V2ZXIsIGl0IGlzIHJlcXVpcmVkIHRvICd0ZWxsJyB0aGUgU2NlbmUgTm9kZSB3aGVuIG90aGVyIFZlY3RvcnMgYXJlIGNyZWF0ZWQgKHNlZSByZWdpc3RlclZlY3RvcigpKS4gT25jZSB0aGlzXHJcbiAqICAgIGlzIGNhbGxlZCwgdGhlIFZlY3RvciBOb2Rlcy9Db21wb25lbnRzIGFyZSBtYWRlIGFuZCBkZWxldGVkIG9uY2UgdGhlIFZlY3RvciBpcyByZW1vdmVkLlxyXG4gKlxyXG4gKiBOT1RFOiBTY2VuZU5vZGUgd2lsbCBub3QgdG9nZ2xlIGl0cyB2aXNpYmlsaXR5IGJhc2VkIG9uIHdoZW4gdGhlIEdyYXBoT3JpZW50YXRpb24gb3IgdGhlIENvb3JkaW5hdGVTbmFwTW9kZVxyXG4gKiAgICAgICBjaGFuZ2VzLiBUaGlzIG11c3QgYmUgZG9uZSBleHRlcm5hbGx5LlxyXG4gKlxyXG4gKiBAYXV0aG9yIEJyYW5kb24gTGlcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTXVsdGlsaW5rIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvTXVsdGlsaW5rLmpzJztcclxuaW1wb3J0IEVyYXNlckJ1dHRvbiBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvYnV0dG9ucy9FcmFzZXJCdXR0b24uanMnO1xyXG5pbXBvcnQgeyBOb2RlLCBOb2RlT3B0aW9ucywgUHJlc3NMaXN0ZW5lckV2ZW50IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHZlY3RvckFkZGl0aW9uIGZyb20gJy4uLy4uL3ZlY3RvckFkZGl0aW9uLmpzJztcclxuaW1wb3J0IEdyYXBoIGZyb20gJy4uL21vZGVsL0dyYXBoLmpzJztcclxuaW1wb3J0IFZlY3RvciBmcm9tICcuLi9tb2RlbC9WZWN0b3IuanMnO1xyXG5pbXBvcnQgVmVjdG9yU2V0IGZyb20gJy4uL21vZGVsL1ZlY3RvclNldC5qcyc7XHJcbmltcG9ydCBHcmFwaE5vZGUgZnJvbSAnLi9HcmFwaE5vZGUuanMnO1xyXG5pbXBvcnQgVmVjdG9yQWRkaXRpb25WaWV3UHJvcGVydGllcyBmcm9tICcuL1ZlY3RvckFkZGl0aW9uVmlld1Byb3BlcnRpZXMuanMnO1xyXG5pbXBvcnQgVmVjdG9yQ3JlYXRvclBhbmVsIGZyb20gJy4vVmVjdG9yQ3JlYXRvclBhbmVsLmpzJztcclxuaW1wb3J0IFZlY3RvclNldE5vZGUgZnJvbSAnLi9WZWN0b3JTZXROb2RlLmpzJztcclxuaW1wb3J0IFZlY3RvclZhbHVlc1RvZ2dsZUJveCBmcm9tICcuL1ZlY3RvclZhbHVlc1RvZ2dsZUJveC5qcyc7XHJcbmltcG9ydCBDb21wb25lbnRWZWN0b3JTdHlsZXMgZnJvbSAnLi4vbW9kZWwvQ29tcG9uZW50VmVjdG9yU3R5bGVzLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgQmFzZVZlY3RvciBmcm9tICcuLi9tb2RlbC9CYXNlVmVjdG9yLmpzJztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcbiAgaW5jbHVkZUVyYXNlcj86IGJvb2xlYW47IC8vIEluZGljYXRlcyBpZiBhbiBFcmFzZXJCdXR0b24gc2hvdWxkIGJlIGluY2x1ZGVkXHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBTY2VuZU5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnM7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY2VuZU5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgLy8gcGFyZW50IGZvciBhbGwgVmVjdG9yU2V0Tm9kZXNcclxuICBwcml2YXRlIHJlYWRvbmx5IHZlY3RvclNldE5vZGVzUGFyZW50OiBOb2RlO1xyXG5cclxuICAvLyBhIGxheWVyIGZvciBlYWNoIFZlY3RvclNldFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgdmVjdG9yU2V0Tm9kZXM6IFZlY3RvclNldE5vZGVbXTtcclxuXHJcbiAgLy8gZm9yIGxheW91dCBpbiBzdWJjbGFzc2VzXHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHZlY3RvclZhbHVlc1RvZ2dsZUJveDogTm9kZTtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSB2ZWN0b3JTZXRzOiBWZWN0b3JTZXRbXTtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBncmFwaDogR3JhcGgsXHJcbiAgICAgICAgICAgICAgICAgICAgICB2aWV3UHJvcGVydGllczogVmVjdG9yQWRkaXRpb25WaWV3UHJvcGVydGllcyxcclxuICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0eWxlUHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8Q29tcG9uZW50VmVjdG9yU3R5bGVzPixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IFNjZW5lTm9kZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxTY2VuZU5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgTm9kZU9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFNlbGZPcHRpb25zXHJcbiAgICAgIGluY2x1ZGVFcmFzZXI6IHRydWUsXHJcblxyXG4gICAgICAvLyBOb2RlT3B0aW9uc1xyXG4gICAgICBpc0Rpc3Bvc2FibGU6IGZhbHNlXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG5cclxuICAgIC8vIENyZWF0ZSBvbmUgYW5kIG9ubHkgR3JhcGhOb2RlXHJcbiAgICBjb25zdCBncmFwaE5vZGUgPSBuZXcgR3JhcGhOb2RlKCBncmFwaCwgdmlld1Byb3BlcnRpZXMuZ3JpZFZpc2libGVQcm9wZXJ0eSApO1xyXG5cclxuICAgIC8vIENyZWF0ZSB0aGUgb25lIGFuZCBvbmx5ICdWZWN0b3IgVmFsdWVzJyB0b2dnbGUgYm94XHJcbiAgICBjb25zdCB2ZWN0b3JWYWx1ZXNUb2dnbGVCb3ggPSBuZXcgVmVjdG9yVmFsdWVzVG9nZ2xlQm94KCBncmFwaCwge1xyXG4gICAgICBleHBhbmRlZFByb3BlcnR5OiB2aWV3UHJvcGVydGllcy52ZWN0b3JWYWx1ZXNFeHBhbmRlZFByb3BlcnR5LFxyXG4gICAgICBjZW50ZXJYOiBncmFwaC5ncmFwaFZpZXdCb3VuZHMuY2VudGVyWCxcclxuICAgICAgdG9wOiAzNSAvLyBkZXRlcm1pbmVkIGVtcGlyaWNhbGx5XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICAvLyBDcmVhdGUgY29udGFpbmVycyBmb3IgZWFjaCBhbmQgZXZlcnkgdHlwZSBvZiBWZWN0b3IgdG8gaGFuZGxlIHotbGF5ZXJpbmcgb2YgYWxsIHZlY3RvciB0eXBlcy5cclxuXHJcbiAgICB0aGlzLnZlY3RvclNldE5vZGVzUGFyZW50ID0gbmV3IE5vZGUoKTtcclxuXHJcbiAgICAvLyBBZGQgdGhlIGNoaWxkcmVuIGluIHRoZSBjb3JyZWN0IHotb3JkZXJcclxuICAgIHRoaXMuc2V0Q2hpbGRyZW4oIFtcclxuICAgICAgZ3JhcGhOb2RlLFxyXG4gICAgICB2ZWN0b3JWYWx1ZXNUb2dnbGVCb3gsXHJcbiAgICAgIHRoaXMudmVjdG9yU2V0Tm9kZXNQYXJlbnRcclxuICAgIF0gKTtcclxuXHJcbiAgICAvLyBBZGQgYW4gZXJhc2VyIGJ1dHRvbiBpZiBuZWNlc3NhcnlcclxuICAgIGlmICggb3B0aW9ucy5pbmNsdWRlRXJhc2VyICkge1xyXG5cclxuICAgICAgY29uc3QgZXJhc2VyQnV0dG9uID0gbmV3IEVyYXNlckJ1dHRvbigge1xyXG4gICAgICAgIGxpc3RlbmVyOiAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmludGVycnVwdFN1YnRyZWVJbnB1dCgpOyAvLyBjYW5jZWwgYWxsIGludGVyYWN0aW9ucyBmb3IgdGhlIHNjZW5lXHJcbiAgICAgICAgICBncmFwaC5lcmFzZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcmlnaHQ6IGdyYXBoLmdyYXBoVmlld0JvdW5kcy5tYXhYLFxyXG4gICAgICAgIHRvcDogZ3JhcGguZ3JhcGhWaWV3Qm91bmRzLm1heFkgKyAxNSxcclxuICAgICAgICB0b3VjaEFyZWFYRGlsYXRpb246IDcsXHJcbiAgICAgICAgdG91Y2hBcmVhWURpbGF0aW9uOiA3XHJcbiAgICAgIH0gKTtcclxuICAgICAgdGhpcy5hZGRDaGlsZCggZXJhc2VyQnV0dG9uICk7XHJcbiAgICAgIGVyYXNlckJ1dHRvbi5tb3ZlVG9CYWNrKCk7XHJcblxyXG4gICAgICAvLyBEaXNhYmxlIHRoZSBlcmFzZXIgYnV0dG9uIHdoZW4gdGhlIG51bWJlciBvZiB2ZWN0b3JzIG9uIHRoZSBncmFwaCBpcyB6ZXJvLCB0aGF0IGlzLCB3aGVuIGFsbCB2ZWN0b3Igc2V0c1xyXG4gICAgICAvLyBjb250YWluIG5vIHZlY3RvcnMuIFRoaXMgaXMgYSBiaXQgbW9yZSBjb21wbGljYXRlZCB0aGFuIGl0IHNob3VsZCBiZSwgYnV0IGl0IHdhcyBhZGRlZCBsYXRlIGluIHRoZVxyXG4gICAgICAvLyBkZXZlbG9wbWVudCBwcm9jZXNzLlxyXG4gICAgICAvLyB1bm11bHRpbGluayBpcyB1bm5lY2Vzc2FyeSwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbS5cclxuICAgICAgY29uc3QgbGVuZ3RoUHJvcGVydGllcyA9IF8ubWFwKCBncmFwaC52ZWN0b3JTZXRzLCB2ZWN0b3JTZXQgPT4gdmVjdG9yU2V0LnZlY3RvcnMubGVuZ3RoUHJvcGVydHkgKTtcclxuICAgICAgTXVsdGlsaW5rLm11bHRpbGlua0FueSggbGVuZ3RoUHJvcGVydGllcywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IG51bWJlck9mVmVjdG9ycyA9IF8uc3VtQnkoIGxlbmd0aFByb3BlcnRpZXMsIGxlbmd0aFByb3BlcnR5ID0+IGxlbmd0aFByb3BlcnR5LnZhbHVlICk7XHJcbiAgICAgICAgZXJhc2VyQnV0dG9uLmVuYWJsZWQgPSAoIG51bWJlck9mVmVjdG9ycyAhPT0gMCApO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gYSBsYXllciBmb3IgZWFjaCBWZWN0b3JTZXRcclxuICAgIHRoaXMudmVjdG9yU2V0Tm9kZXMgPSBbXTtcclxuICAgIGdyYXBoLnZlY3RvclNldHMuZm9yRWFjaCggdmVjdG9yU2V0ID0+IHtcclxuICAgICAgY29uc3QgdmVjdG9yU2V0Tm9kZSA9IG5ldyBWZWN0b3JTZXROb2RlKCBncmFwaCwgdmVjdG9yU2V0LFxyXG4gICAgICAgIHZpZXdQcm9wZXJ0aWVzLnZhbHVlc1Zpc2libGVQcm9wZXJ0eSwgdmlld1Byb3BlcnRpZXMuYW5nbGVzVmlzaWJsZVByb3BlcnR5LCBjb21wb25lbnRTdHlsZVByb3BlcnR5ICk7XHJcbiAgICAgIHRoaXMudmVjdG9yU2V0Tm9kZXNQYXJlbnQuYWRkQ2hpbGQoIHZlY3RvclNldE5vZGUgKTtcclxuICAgICAgdGhpcy52ZWN0b3JTZXROb2Rlcy5wdXNoKCB2ZWN0b3JTZXROb2RlICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy52ZWN0b3JWYWx1ZXNUb2dnbGVCb3ggPSB2ZWN0b3JWYWx1ZXNUb2dnbGVCb3g7XHJcblxyXG4gICAgdGhpcy52ZWN0b3JTZXRzID0gZ3JhcGgudmVjdG9yU2V0cztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldHMgdGhlIFZlY3RvclNldE5vZGUgYXNzb2NpYXRlZCB3aXRoIGEgVmVjdG9yU2V0LlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VmVjdG9yU2V0Tm9kZSggdmVjdG9yU2V0OiBWZWN0b3JTZXQgKTogVmVjdG9yU2V0Tm9kZSB7XHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMudmVjdG9yU2V0cy5pbmRleE9mKCB2ZWN0b3JTZXQgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGluZGV4ICE9PSAtMSwgJ3ZlY3RvclNldCBub3QgZm91bmQnICk7XHJcbiAgICByZXR1cm4gdGhpcy52ZWN0b3JTZXROb2Rlc1sgaW5kZXggXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlZ2lzdGVycyBhIFZlY3RvciwgZGVsZWdhdGVzIHRvIFZlY3RvclNldE5vZGUuXHJcbiAgICogQHBhcmFtIHZlY3RvciAtIHRoZSB2ZWN0b3IgbW9kZWxcclxuICAgKiBAcGFyYW0gdmVjdG9yU2V0IC0gdGhlIFZlY3RvclNldCB0aGUgdmVjdG9yIGJlbG9uZ3MgdG9cclxuICAgKiBAcGFyYW0gW2ZvcndhcmRpbmdFdmVudF0gLSBzZWUgVmVjdG9yU2V0Tm9kZVxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWdpc3RlclZlY3RvciggdmVjdG9yOiBWZWN0b3IsIHZlY3RvclNldDogVmVjdG9yU2V0LCBmb3J3YXJkaW5nRXZlbnQ/OiBQcmVzc0xpc3RlbmVyRXZlbnQgKTogdm9pZCB7XHJcbiAgICB0aGlzLmdldFZlY3RvclNldE5vZGUoIHZlY3RvclNldCApLnJlZ2lzdGVyVmVjdG9yKCB2ZWN0b3IsIGZvcndhcmRpbmdFdmVudCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkcyBhIGJhc2UgdmVjdG9yIHRvIHRoZSBzY2VuZS4gIERlbGVnYXRlcyB0byBWZWN0b3JTZXROb2RlLlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBhZGRCYXNlVmVjdG9yKCB2ZWN0b3JTZXQ6IFZlY3RvclNldCwgYmFzZVZlY3RvcjogQmFzZVZlY3RvciwgYmFzZVZlY3RvcnNWaXNpYmxlUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+ICk6IHZvaWQge1xyXG4gICAgdGhpcy5nZXRWZWN0b3JTZXROb2RlKCB2ZWN0b3JTZXQgKS5hZGRCYXNlVmVjdG9yKCBiYXNlVmVjdG9yLCBiYXNlVmVjdG9yc1Zpc2libGVQcm9wZXJ0eSwgdmVjdG9yU2V0LnZlY3RvckNvbG9yUGFsZXR0ZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkcyBhIFZlY3RvckNyZWF0b3JQYW5lbCB0byB0aGUgc2NlbmUuXHJcbiAgICovXHJcbiAgcHVibGljIGFkZFZlY3RvckNyZWF0b3JQYW5lbCggdmVjdG9yQ3JlYXRvclBhbmVsOiBWZWN0b3JDcmVhdG9yUGFuZWwgKTogdm9pZCB7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB2ZWN0b3JDcmVhdG9yUGFuZWwgKTtcclxuICAgIHZlY3RvckNyZWF0b3JQYW5lbC5tb3ZlVG9CYWNrKCk7XHJcbiAgfVxyXG59XHJcblxyXG52ZWN0b3JBZGRpdGlvbi5yZWdpc3RlciggJ1NjZW5lTm9kZScsIFNjZW5lTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFHQSxPQUFPQSxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELE9BQU9DLFlBQVksTUFBTSxxREFBcUQ7QUFDOUUsU0FBU0MsSUFBSSxRQUF5QyxtQ0FBbUM7QUFDekYsT0FBT0MsY0FBYyxNQUFNLHlCQUF5QjtBQUlwRCxPQUFPQyxTQUFTLE1BQU0sZ0JBQWdCO0FBR3RDLE9BQU9DLGFBQWEsTUFBTSxvQkFBb0I7QUFD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