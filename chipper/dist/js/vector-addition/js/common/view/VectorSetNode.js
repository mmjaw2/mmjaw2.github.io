// Copyright 2019-2023, University of Colorado Boulder

/**
 * VectorSetNode is responsible for creating the view for all vectors associated with a VectorSet.
 *
 * Responsibilities include:
 * - creating the Nodes for the sum vector and sum component vectors
 * - creating and managing Nodes for registered vectors
 * - handling layering of all Nodes related to vectors in the VectorSet
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Brandon Li
 */

import merge from '../../../../phet-core/js/merge.js';
import { Node } from '../../../../scenery/js/imports.js';
import vectorAddition from '../../vectorAddition.js';
import VectorAdditionConstants from '../VectorAdditionConstants.js';
import ComponentVectorNode from './ComponentVectorNode.js';
import SumComponentVectorNode from './SumComponentVectorNode.js';
import SumVectorNode from './SumVectorNode.js';
import VectorNode from './VectorNode.js';
export default class VectorSetNode extends Node {
  constructor(graph, vectorSet, valuesVisibleProperty, anglesVisibleProperty, componentStyleProperty) {
    const sumVector = vectorSet.sumVector;
    assert && assert(sumVector !== null);

    // Every VectorSet has a sum vector and sum component vectors, so create them
    const sumVectorNode = new SumVectorNode(sumVector, graph, valuesVisibleProperty, anglesVisibleProperty, vectorSet.sumVisibleProperty);
    const xSumComponentVectorNode = new SumComponentVectorNode(sumVector.xComponentVector, graph, componentStyleProperty, valuesVisibleProperty, vectorSet.sumVisibleProperty);
    const ySumComponentVectorNode = new SumComponentVectorNode(sumVector.yComponentVector, graph, componentStyleProperty, valuesVisibleProperty, vectorSet.sumVisibleProperty);
    super({
      children: [xSumComponentVectorNode, ySumComponentVectorNode, sumVectorNode],
      isDisposable: false
    });
    this.vectorSet = vectorSet;
    this.graph = graph;
    this.valuesVisibleProperty = valuesVisibleProperty;
    this.anglesVisibleProperty = anglesVisibleProperty;
    this.componentStyleProperty = componentStyleProperty;

    // When the sum vector becomes selected, move it and its component vectors to the front.
    // unlink is unnecessary, exists for the lifetime of the sim.
    graph.activeVectorProperty.link(activeVector => {
      if (activeVector === sumVectorNode.vector) {
        // move all vectors in the set to the front, see https://github.com/phetsims/vector-addition/issues/94
        this.moveToFront();

        // order is important - sum should be in front of components
        xSumComponentVectorNode.moveToFront();
        ySumComponentVectorNode.moveToFront();
        sumVectorNode.moveToFront();
      }
    });
  }

  /**
   * Registers a Vector by creating its associated VectorNode and the ComponentVectorNodes.
   * The Nodes are deleted if Vector is ever removed from its VectorSet.
   * @param vector - the vector model
   * @param [forwardingEvent] - if provided, it will forward this event to the Vector body drag listener. This is used
   *   to forward the click event from the VectorCreatorPanel to the VectorNode. If not provided, no event is forwarded.
   */
  registerVector(vector, forwardingEvent) {
    // Create the view for the vector and its component vectors
    const vectorNode = new VectorNode(vector, this.graph, this.valuesVisibleProperty, this.anglesVisibleProperty);
    const xComponentVectorNode = new ComponentVectorNode(vector.xComponentVector, this.graph, this.componentStyleProperty, this.valuesVisibleProperty);
    const yComponentVectorNode = new ComponentVectorNode(vector.yComponentVector, this.graph, this.componentStyleProperty, this.valuesVisibleProperty);
    this.addChild(xComponentVectorNode);
    this.addChild(yComponentVectorNode);
    this.addChild(vectorNode);

    // Optional event forwarding
    if (forwardingEvent) {
      vectorNode.forwardEvent(forwardingEvent);
    }

    // When the vector becomes active (selected), move it and its components to the front.
    // unlink is required when the vector is removed.
    const activeVectorListener = activeVector => {
      if (activeVector === vectorNode.vector) {
        // move all vectors in the set to the front, see https://github.com/phetsims/vector-addition/issues/94
        this.moveToFront();

        // order is important - vector should be in front of components
        xComponentVectorNode.moveToFront();
        yComponentVectorNode.moveToFront();
        vectorNode.moveToFront();
      }
    };
    this.graph.activeVectorProperty.link(activeVectorListener);

    // If the Vector is removed from the VectorSet, clean up.
    if (vector.isRemovable) {
      const removalListener = removedVector => {
        assert && assert(removedVector.isRemovable, 'vector is not removable');
        if (removedVector === vector) {
          // dispose the Nodes that were created
          xComponentVectorNode.dispose();
          yComponentVectorNode.dispose();
          vectorNode.dispose();

          // remove listeners
          this.vectorSet.vectors.removeItemRemovedListener(removalListener);
          this.graph.activeVectorProperty.unlink(activeVectorListener);
        }
      };
      this.vectorSet.vectors.addItemRemovedListener(removalListener);
    }
  }

  /**
   * Adds a base vector to the VectorSetNode.  Base vectors are never removed.
   * Base vectors do not have component vectors, see https://github.com/phetsims/vector-addition/issues/158
   */
  addBaseVector(baseVector, baseVectorsVisibleProperty, vectorColorPalette) {
    // Node for the base vector
    const baseVectorNode = new VectorNode(baseVector, this.graph, this.valuesVisibleProperty, this.anglesVisibleProperty, {
      arrowOptions: merge({}, VectorAdditionConstants.BASE_VECTOR_ARROW_OPTIONS, {
        fill: vectorColorPalette.baseVectorFill,
        stroke: vectorColorPalette.baseVectorStroke
      })
    });
    this.addChild(baseVectorNode);

    // Handle visibility
    baseVectorsVisibleProperty.linkAttribute(baseVectorNode, 'visible');

    // When the base vector becomes active (selected), move it (and the entire vector set) to the front.
    // unlink is unnecessary because base vectors exist for the lifetime of the sim.
    this.graph.activeVectorProperty.link(activeVector => {
      if (activeVector === baseVectorNode.vector) {
        // move all vectors in the set to the front, see https://github.com/phetsims/vector-addition/issues/94
        this.moveToFront();

        // move the base vector to the front
        baseVectorNode.moveToFront();
      }
    });
  }
}
vectorAddition.register('VectorSetNode', VectorSetNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtZXJnZSIsIk5vZGUiLCJ2ZWN0b3JBZGRpdGlvbiIsIlZlY3RvckFkZGl0aW9uQ29uc3RhbnRzIiwiQ29tcG9uZW50VmVjdG9yTm9kZSIsIlN1bUNvbXBvbmVudFZlY3Rvck5vZGUiLCJTdW1WZWN0b3JOb2RlIiwiVmVjdG9yTm9kZSIsIlZlY3RvclNldE5vZGUiLCJjb25zdHJ1Y3RvciIsImdyYXBoIiwidmVjdG9yU2V0IiwidmFsdWVzVmlzaWJsZVByb3BlcnR5IiwiYW5nbGVzVmlzaWJsZVByb3BlcnR5IiwiY29tcG9uZW50U3R5bGVQcm9wZXJ0eSIsInN1bVZlY3RvciIsImFzc2VydCIsInN1bVZlY3Rvck5vZGUiLCJzdW1WaXNpYmxlUHJvcGVydHkiLCJ4U3VtQ29tcG9uZW50VmVjdG9yTm9kZSIsInhDb21wb25lbnRWZWN0b3IiLCJ5U3VtQ29tcG9uZW50VmVjdG9yTm9kZSIsInlDb21wb25lbnRWZWN0b3IiLCJjaGlsZHJlbiIsImlzRGlzcG9zYWJsZSIsImFjdGl2ZVZlY3RvclByb3BlcnR5IiwibGluayIsImFjdGl2ZVZlY3RvciIsInZlY3RvciIsIm1vdmVUb0Zyb250IiwicmVnaXN0ZXJWZWN0b3IiLCJmb3J3YXJkaW5nRXZlbnQiLCJ2ZWN0b3JOb2RlIiwieENvbXBvbmVudFZlY3Rvck5vZGUiLCJ5Q29tcG9uZW50VmVjdG9yTm9kZSIsImFkZENoaWxkIiwiZm9yd2FyZEV2ZW50IiwiYWN0aXZlVmVjdG9yTGlzdGVuZXIiLCJpc1JlbW92YWJsZSIsInJlbW92YWxMaXN0ZW5lciIsInJlbW92ZWRWZWN0b3IiLCJkaXNwb3NlIiwidmVjdG9ycyIsInJlbW92ZUl0ZW1SZW1vdmVkTGlzdGVuZXIiLCJ1bmxpbmsiLCJhZGRJdGVtUmVtb3ZlZExpc3RlbmVyIiwiYWRkQmFzZVZlY3RvciIsImJhc2VWZWN0b3IiLCJiYXNlVmVjdG9yc1Zpc2libGVQcm9wZXJ0eSIsInZlY3RvckNvbG9yUGFsZXR0ZSIsImJhc2VWZWN0b3JOb2RlIiwiYXJyb3dPcHRpb25zIiwiQkFTRV9WRUNUT1JfQVJST1dfT1BUSU9OUyIsImZpbGwiLCJiYXNlVmVjdG9yRmlsbCIsInN0cm9rZSIsImJhc2VWZWN0b3JTdHJva2UiLCJsaW5rQXR0cmlidXRlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJWZWN0b3JTZXROb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE5LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFZlY3RvclNldE5vZGUgaXMgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIHRoZSB2aWV3IGZvciBhbGwgdmVjdG9ycyBhc3NvY2lhdGVkIHdpdGggYSBWZWN0b3JTZXQuXHJcbiAqXHJcbiAqIFJlc3BvbnNpYmlsaXRpZXMgaW5jbHVkZTpcclxuICogLSBjcmVhdGluZyB0aGUgTm9kZXMgZm9yIHRoZSBzdW0gdmVjdG9yIGFuZCBzdW0gY29tcG9uZW50IHZlY3RvcnNcclxuICogLSBjcmVhdGluZyBhbmQgbWFuYWdpbmcgTm9kZXMgZm9yIHJlZ2lzdGVyZWQgdmVjdG9yc1xyXG4gKiAtIGhhbmRsaW5nIGxheWVyaW5nIG9mIGFsbCBOb2RlcyByZWxhdGVkIHRvIHZlY3RvcnMgaW4gdGhlIFZlY3RvclNldFxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKiBAYXV0aG9yIEJyYW5kb24gTGlcclxuICovXHJcblxyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IHsgTm9kZSwgUHJlc3NMaXN0ZW5lckV2ZW50IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHZlY3RvckFkZGl0aW9uIGZyb20gJy4uLy4uL3ZlY3RvckFkZGl0aW9uLmpzJztcclxuaW1wb3J0IEJhc2VWZWN0b3IgZnJvbSAnLi4vbW9kZWwvQmFzZVZlY3Rvci5qcyc7XHJcbmltcG9ydCBHcmFwaCBmcm9tICcuLi9tb2RlbC9HcmFwaC5qcyc7XHJcbmltcG9ydCBWZWN0b3IgZnJvbSAnLi4vbW9kZWwvVmVjdG9yLmpzJztcclxuaW1wb3J0IFZlY3RvclNldCBmcm9tICcuLi9tb2RlbC9WZWN0b3JTZXQuanMnO1xyXG5pbXBvcnQgVmVjdG9yQWRkaXRpb25Db25zdGFudHMgZnJvbSAnLi4vVmVjdG9yQWRkaXRpb25Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgQ29tcG9uZW50VmVjdG9yTm9kZSBmcm9tICcuL0NvbXBvbmVudFZlY3Rvck5vZGUuanMnO1xyXG5pbXBvcnQgU3VtQ29tcG9uZW50VmVjdG9yTm9kZSBmcm9tICcuL1N1bUNvbXBvbmVudFZlY3Rvck5vZGUuanMnO1xyXG5pbXBvcnQgU3VtVmVjdG9yTm9kZSBmcm9tICcuL1N1bVZlY3Rvck5vZGUuanMnO1xyXG5pbXBvcnQgVmVjdG9yTm9kZSBmcm9tICcuL1ZlY3Rvck5vZGUuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBDb21wb25lbnRWZWN0b3JTdHlsZXMgZnJvbSAnLi4vbW9kZWwvQ29tcG9uZW50VmVjdG9yU3R5bGVzLmpzJztcclxuaW1wb3J0IFZlY3RvckNvbG9yUGFsZXR0ZSBmcm9tICcuLi9tb2RlbC9WZWN0b3JDb2xvclBhbGV0dGUuanMnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVmVjdG9yU2V0Tm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgdmVjdG9yU2V0OiBWZWN0b3JTZXQ7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZ3JhcGg6IEdyYXBoO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdmFsdWVzVmlzaWJsZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGFuZ2xlc1Zpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHJpdmF0ZSByZWFkb25seSBjb21wb25lbnRTdHlsZVByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PENvbXBvbmVudFZlY3RvclN0eWxlcz47XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggZ3JhcGg6IEdyYXBoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgdmVjdG9yU2V0OiBWZWN0b3JTZXQsXHJcbiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXNWaXNpYmxlUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PGJvb2xlYW4+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgYW5nbGVzVmlzaWJsZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPixcclxuICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0eWxlUHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8Q29tcG9uZW50VmVjdG9yU3R5bGVzPiApIHtcclxuXHJcbiAgICBjb25zdCBzdW1WZWN0b3IgPSB2ZWN0b3JTZXQuc3VtVmVjdG9yITtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHN1bVZlY3RvciAhPT0gbnVsbCApO1xyXG5cclxuICAgIC8vIEV2ZXJ5IFZlY3RvclNldCBoYXMgYSBzdW0gdmVjdG9yIGFuZCBzdW0gY29tcG9uZW50IHZlY3RvcnMsIHNvIGNyZWF0ZSB0aGVtXHJcbiAgICBjb25zdCBzdW1WZWN0b3JOb2RlID0gbmV3IFN1bVZlY3Rvck5vZGUoIHN1bVZlY3RvciwgZ3JhcGgsXHJcbiAgICAgIHZhbHVlc1Zpc2libGVQcm9wZXJ0eSwgYW5nbGVzVmlzaWJsZVByb3BlcnR5LCB2ZWN0b3JTZXQuc3VtVmlzaWJsZVByb3BlcnR5XHJcbiAgICApO1xyXG4gICAgY29uc3QgeFN1bUNvbXBvbmVudFZlY3Rvck5vZGUgPSBuZXcgU3VtQ29tcG9uZW50VmVjdG9yTm9kZSggc3VtVmVjdG9yLnhDb21wb25lbnRWZWN0b3IsIGdyYXBoLFxyXG4gICAgICBjb21wb25lbnRTdHlsZVByb3BlcnR5LCB2YWx1ZXNWaXNpYmxlUHJvcGVydHksIHZlY3RvclNldC5zdW1WaXNpYmxlUHJvcGVydHkgKTtcclxuICAgIGNvbnN0IHlTdW1Db21wb25lbnRWZWN0b3JOb2RlID0gbmV3IFN1bUNvbXBvbmVudFZlY3Rvck5vZGUoIHN1bVZlY3Rvci55Q29tcG9uZW50VmVjdG9yLCBncmFwaCxcclxuICAgICAgY29tcG9uZW50U3R5bGVQcm9wZXJ0eSwgdmFsdWVzVmlzaWJsZVByb3BlcnR5LCB2ZWN0b3JTZXQuc3VtVmlzaWJsZVByb3BlcnR5ICk7XHJcblxyXG4gICAgc3VwZXIoIHtcclxuICAgICAgY2hpbGRyZW46IFsgeFN1bUNvbXBvbmVudFZlY3Rvck5vZGUsIHlTdW1Db21wb25lbnRWZWN0b3JOb2RlLCBzdW1WZWN0b3JOb2RlIF0sXHJcbiAgICAgIGlzRGlzcG9zYWJsZTogZmFsc2VcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnZlY3RvclNldCA9IHZlY3RvclNldDtcclxuXHJcbiAgICB0aGlzLmdyYXBoID0gZ3JhcGg7XHJcbiAgICB0aGlzLnZhbHVlc1Zpc2libGVQcm9wZXJ0eSA9IHZhbHVlc1Zpc2libGVQcm9wZXJ0eTtcclxuICAgIHRoaXMuYW5nbGVzVmlzaWJsZVByb3BlcnR5ID0gYW5nbGVzVmlzaWJsZVByb3BlcnR5O1xyXG4gICAgdGhpcy5jb21wb25lbnRTdHlsZVByb3BlcnR5ID0gY29tcG9uZW50U3R5bGVQcm9wZXJ0eTtcclxuXHJcbiAgICAvLyBXaGVuIHRoZSBzdW0gdmVjdG9yIGJlY29tZXMgc2VsZWN0ZWQsIG1vdmUgaXQgYW5kIGl0cyBjb21wb25lbnQgdmVjdG9ycyB0byB0aGUgZnJvbnQuXHJcbiAgICAvLyB1bmxpbmsgaXMgdW5uZWNlc3NhcnksIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAgICBncmFwaC5hY3RpdmVWZWN0b3JQcm9wZXJ0eS5saW5rKCBhY3RpdmVWZWN0b3IgPT4ge1xyXG4gICAgICBpZiAoIGFjdGl2ZVZlY3RvciA9PT0gc3VtVmVjdG9yTm9kZS52ZWN0b3IgKSB7XHJcblxyXG4gICAgICAgIC8vIG1vdmUgYWxsIHZlY3RvcnMgaW4gdGhlIHNldCB0byB0aGUgZnJvbnQsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvdmVjdG9yLWFkZGl0aW9uL2lzc3Vlcy85NFxyXG4gICAgICAgIHRoaXMubW92ZVRvRnJvbnQoKTtcclxuXHJcbiAgICAgICAgLy8gb3JkZXIgaXMgaW1wb3J0YW50IC0gc3VtIHNob3VsZCBiZSBpbiBmcm9udCBvZiBjb21wb25lbnRzXHJcbiAgICAgICAgeFN1bUNvbXBvbmVudFZlY3Rvck5vZGUubW92ZVRvRnJvbnQoKTtcclxuICAgICAgICB5U3VtQ29tcG9uZW50VmVjdG9yTm9kZS5tb3ZlVG9Gcm9udCgpO1xyXG4gICAgICAgIHN1bVZlY3Rvck5vZGUubW92ZVRvRnJvbnQoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVnaXN0ZXJzIGEgVmVjdG9yIGJ5IGNyZWF0aW5nIGl0cyBhc3NvY2lhdGVkIFZlY3Rvck5vZGUgYW5kIHRoZSBDb21wb25lbnRWZWN0b3JOb2Rlcy5cclxuICAgKiBUaGUgTm9kZXMgYXJlIGRlbGV0ZWQgaWYgVmVjdG9yIGlzIGV2ZXIgcmVtb3ZlZCBmcm9tIGl0cyBWZWN0b3JTZXQuXHJcbiAgICogQHBhcmFtIHZlY3RvciAtIHRoZSB2ZWN0b3IgbW9kZWxcclxuICAgKiBAcGFyYW0gW2ZvcndhcmRpbmdFdmVudF0gLSBpZiBwcm92aWRlZCwgaXQgd2lsbCBmb3J3YXJkIHRoaXMgZXZlbnQgdG8gdGhlIFZlY3RvciBib2R5IGRyYWcgbGlzdGVuZXIuIFRoaXMgaXMgdXNlZFxyXG4gICAqICAgdG8gZm9yd2FyZCB0aGUgY2xpY2sgZXZlbnQgZnJvbSB0aGUgVmVjdG9yQ3JlYXRvclBhbmVsIHRvIHRoZSBWZWN0b3JOb2RlLiBJZiBub3QgcHJvdmlkZWQsIG5vIGV2ZW50IGlzIGZvcndhcmRlZC5cclxuICAgKi9cclxuICBwdWJsaWMgcmVnaXN0ZXJWZWN0b3IoIHZlY3RvcjogVmVjdG9yLCBmb3J3YXJkaW5nRXZlbnQ/OiBQcmVzc0xpc3RlbmVyRXZlbnQgKTogdm9pZCB7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSB2aWV3IGZvciB0aGUgdmVjdG9yIGFuZCBpdHMgY29tcG9uZW50IHZlY3RvcnNcclxuICAgIGNvbnN0IHZlY3Rvck5vZGUgPSBuZXcgVmVjdG9yTm9kZSggdmVjdG9yLCB0aGlzLmdyYXBoLCB0aGlzLnZhbHVlc1Zpc2libGVQcm9wZXJ0eSwgdGhpcy5hbmdsZXNWaXNpYmxlUHJvcGVydHkgKTtcclxuXHJcbiAgICBjb25zdCB4Q29tcG9uZW50VmVjdG9yTm9kZSA9IG5ldyBDb21wb25lbnRWZWN0b3JOb2RlKCB2ZWN0b3IueENvbXBvbmVudFZlY3RvcixcclxuICAgICAgdGhpcy5ncmFwaCxcclxuICAgICAgdGhpcy5jb21wb25lbnRTdHlsZVByb3BlcnR5LFxyXG4gICAgICB0aGlzLnZhbHVlc1Zpc2libGVQcm9wZXJ0eSApO1xyXG5cclxuICAgIGNvbnN0IHlDb21wb25lbnRWZWN0b3JOb2RlID0gbmV3IENvbXBvbmVudFZlY3Rvck5vZGUoIHZlY3Rvci55Q29tcG9uZW50VmVjdG9yLFxyXG4gICAgICB0aGlzLmdyYXBoLFxyXG4gICAgICB0aGlzLmNvbXBvbmVudFN0eWxlUHJvcGVydHksXHJcbiAgICAgIHRoaXMudmFsdWVzVmlzaWJsZVByb3BlcnR5ICk7XHJcblxyXG4gICAgdGhpcy5hZGRDaGlsZCggeENvbXBvbmVudFZlY3Rvck5vZGUgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIHlDb21wb25lbnRWZWN0b3JOb2RlICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB2ZWN0b3JOb2RlICk7XHJcblxyXG4gICAgLy8gT3B0aW9uYWwgZXZlbnQgZm9yd2FyZGluZ1xyXG4gICAgaWYgKCBmb3J3YXJkaW5nRXZlbnQgKSB7XHJcbiAgICAgIHZlY3Rvck5vZGUuZm9yd2FyZEV2ZW50KCBmb3J3YXJkaW5nRXZlbnQgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBXaGVuIHRoZSB2ZWN0b3IgYmVjb21lcyBhY3RpdmUgKHNlbGVjdGVkKSwgbW92ZSBpdCBhbmQgaXRzIGNvbXBvbmVudHMgdG8gdGhlIGZyb250LlxyXG4gICAgLy8gdW5saW5rIGlzIHJlcXVpcmVkIHdoZW4gdGhlIHZlY3RvciBpcyByZW1vdmVkLlxyXG4gICAgY29uc3QgYWN0aXZlVmVjdG9yTGlzdGVuZXIgPSAoIGFjdGl2ZVZlY3RvcjogVmVjdG9yIHwgbnVsbCApID0+IHtcclxuICAgICAgaWYgKCBhY3RpdmVWZWN0b3IgPT09IHZlY3Rvck5vZGUudmVjdG9yICkge1xyXG5cclxuICAgICAgICAvLyBtb3ZlIGFsbCB2ZWN0b3JzIGluIHRoZSBzZXQgdG8gdGhlIGZyb250LCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3ZlY3Rvci1hZGRpdGlvbi9pc3N1ZXMvOTRcclxuICAgICAgICB0aGlzLm1vdmVUb0Zyb250KCk7XHJcblxyXG4gICAgICAgIC8vIG9yZGVyIGlzIGltcG9ydGFudCAtIHZlY3RvciBzaG91bGQgYmUgaW4gZnJvbnQgb2YgY29tcG9uZW50c1xyXG4gICAgICAgIHhDb21wb25lbnRWZWN0b3JOb2RlLm1vdmVUb0Zyb250KCk7XHJcbiAgICAgICAgeUNvbXBvbmVudFZlY3Rvck5vZGUubW92ZVRvRnJvbnQoKTtcclxuICAgICAgICB2ZWN0b3JOb2RlLm1vdmVUb0Zyb250KCk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLmdyYXBoLmFjdGl2ZVZlY3RvclByb3BlcnR5LmxpbmsoIGFjdGl2ZVZlY3Rvckxpc3RlbmVyICk7XHJcblxyXG4gICAgLy8gSWYgdGhlIFZlY3RvciBpcyByZW1vdmVkIGZyb20gdGhlIFZlY3RvclNldCwgY2xlYW4gdXAuXHJcbiAgICBpZiAoIHZlY3Rvci5pc1JlbW92YWJsZSApIHtcclxuXHJcbiAgICAgIGNvbnN0IHJlbW92YWxMaXN0ZW5lciA9ICggcmVtb3ZlZFZlY3RvcjogVmVjdG9yICkgPT4ge1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHJlbW92ZWRWZWN0b3IuaXNSZW1vdmFibGUsICd2ZWN0b3IgaXMgbm90IHJlbW92YWJsZScgKTtcclxuXHJcbiAgICAgICAgaWYgKCByZW1vdmVkVmVjdG9yID09PSB2ZWN0b3IgKSB7XHJcblxyXG4gICAgICAgICAgLy8gZGlzcG9zZSB0aGUgTm9kZXMgdGhhdCB3ZXJlIGNyZWF0ZWRcclxuICAgICAgICAgIHhDb21wb25lbnRWZWN0b3JOb2RlLmRpc3Bvc2UoKTtcclxuICAgICAgICAgIHlDb21wb25lbnRWZWN0b3JOb2RlLmRpc3Bvc2UoKTtcclxuICAgICAgICAgIHZlY3Rvck5vZGUuZGlzcG9zZSgpO1xyXG5cclxuICAgICAgICAgIC8vIHJlbW92ZSBsaXN0ZW5lcnNcclxuICAgICAgICAgIHRoaXMudmVjdG9yU2V0LnZlY3RvcnMucmVtb3ZlSXRlbVJlbW92ZWRMaXN0ZW5lciggcmVtb3ZhbExpc3RlbmVyICk7XHJcbiAgICAgICAgICB0aGlzLmdyYXBoLmFjdGl2ZVZlY3RvclByb3BlcnR5LnVubGluayggYWN0aXZlVmVjdG9yTGlzdGVuZXIgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgICB0aGlzLnZlY3RvclNldC52ZWN0b3JzLmFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIoIHJlbW92YWxMaXN0ZW5lciApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkcyBhIGJhc2UgdmVjdG9yIHRvIHRoZSBWZWN0b3JTZXROb2RlLiAgQmFzZSB2ZWN0b3JzIGFyZSBuZXZlciByZW1vdmVkLlxyXG4gICAqIEJhc2UgdmVjdG9ycyBkbyBub3QgaGF2ZSBjb21wb25lbnQgdmVjdG9ycywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy92ZWN0b3ItYWRkaXRpb24vaXNzdWVzLzE1OFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRCYXNlVmVjdG9yKCBiYXNlVmVjdG9yOiBCYXNlVmVjdG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBiYXNlVmVjdG9yc1Zpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZlY3RvckNvbG9yUGFsZXR0ZTogVmVjdG9yQ29sb3JQYWxldHRlICk6IHZvaWQge1xyXG5cclxuICAgIC8vIE5vZGUgZm9yIHRoZSBiYXNlIHZlY3RvclxyXG4gICAgY29uc3QgYmFzZVZlY3Rvck5vZGUgPSBuZXcgVmVjdG9yTm9kZSggYmFzZVZlY3RvciwgdGhpcy5ncmFwaCxcclxuICAgICAgdGhpcy52YWx1ZXNWaXNpYmxlUHJvcGVydHksXHJcbiAgICAgIHRoaXMuYW5nbGVzVmlzaWJsZVByb3BlcnR5LCB7XHJcbiAgICAgICAgYXJyb3dPcHRpb25zOiBtZXJnZSgge30sIFZlY3RvckFkZGl0aW9uQ29uc3RhbnRzLkJBU0VfVkVDVE9SX0FSUk9XX09QVElPTlMsIHtcclxuICAgICAgICAgIGZpbGw6IHZlY3RvckNvbG9yUGFsZXR0ZS5iYXNlVmVjdG9yRmlsbCxcclxuICAgICAgICAgIHN0cm9rZTogdmVjdG9yQ29sb3JQYWxldHRlLmJhc2VWZWN0b3JTdHJva2VcclxuICAgICAgICB9IClcclxuICAgICAgfSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggYmFzZVZlY3Rvck5vZGUgKTtcclxuXHJcbiAgICAvLyBIYW5kbGUgdmlzaWJpbGl0eVxyXG4gICAgYmFzZVZlY3RvcnNWaXNpYmxlUHJvcGVydHkubGlua0F0dHJpYnV0ZSggYmFzZVZlY3Rvck5vZGUsICd2aXNpYmxlJyApO1xyXG5cclxuICAgIC8vIFdoZW4gdGhlIGJhc2UgdmVjdG9yIGJlY29tZXMgYWN0aXZlIChzZWxlY3RlZCksIG1vdmUgaXQgKGFuZCB0aGUgZW50aXJlIHZlY3RvciBzZXQpIHRvIHRoZSBmcm9udC5cclxuICAgIC8vIHVubGluayBpcyB1bm5lY2Vzc2FyeSBiZWNhdXNlIGJhc2UgdmVjdG9ycyBleGlzdCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAgICB0aGlzLmdyYXBoLmFjdGl2ZVZlY3RvclByb3BlcnR5LmxpbmsoIGFjdGl2ZVZlY3RvciA9PiB7XHJcbiAgICAgIGlmICggYWN0aXZlVmVjdG9yID09PSBiYXNlVmVjdG9yTm9kZS52ZWN0b3IgKSB7XHJcblxyXG4gICAgICAgIC8vIG1vdmUgYWxsIHZlY3RvcnMgaW4gdGhlIHNldCB0byB0aGUgZnJvbnQsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvdmVjdG9yLWFkZGl0aW9uL2lzc3Vlcy85NFxyXG4gICAgICAgIHRoaXMubW92ZVRvRnJvbnQoKTtcclxuXHJcbiAgICAgICAgLy8gbW92ZSB0aGUgYmFzZSB2ZWN0b3IgdG8gdGhlIGZyb250XHJcbiAgICAgICAgYmFzZVZlY3Rvck5vZGUubW92ZVRvRnJvbnQoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxudmVjdG9yQWRkaXRpb24ucmVnaXN0ZXIoICdWZWN0b3JTZXROb2RlJywgVmVjdG9yU2V0Tm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFHQSxPQUFPQSxLQUFLLE1BQU0sbUNBQW1DO0FBQ3JELFNBQVNDLElBQUksUUFBNEIsbUNBQW1DO0FBQzVFLE9BQU9DLGNBQWMsTUFBTSx5QkFBeUI7QUFLcEQsT0FBT0MsdUJBQXVCLE1BQU0sK0JBQStCO0FBQ25FLE9BQU9DLG1CQUFtQixNQUFNLDBCQUEwQjtBQUMxRCxPQUFPQyxzQkFBc0Is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