// Copyright 2013-2024, University of Colorado Boulder

/**
 * Styles needed to determine a stroked line shape. Generally immutable.
 *
 * Mirrors much of what is done with SVG/Canvas, see https://svgwg.org/svg2-draft/painting.html for details.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Utils from '../../../dot/js/Utils.js';
import merge from '../../../phet-core/js/merge.js';
import { Arc, kite, Line } from '../imports.js';

// constants
const lineLineIntersection = Utils.lineLineIntersection;
const DEFAULT_OPTIONS = {
  lineWidth: 1,
  lineCap: 'butt',
  lineJoin: 'miter',
  lineDash: [],
  lineDashOffset: 0,
  miterLimit: 10
};
export default class LineStyles {
  // The width of the line (will be offset to each side by lineWidth/2)

  // 'butt', 'round' or 'square' - Controls appearance at endpoints for non-closed subpaths.
  // - butt: straight-line at end point, going through the endpoint (perpendicular to the tangent)
  // - round: circular border with radius lineWidth/2 around endpoints
  // - square: straight-line past the end point (by lineWidth/2)
  // See: https://svgwg.org/svg2-draft/painting.html#LineCaps

  // 'miter', 'round' or 'bevel' - Controls appearance at joints between segments (at the point)
  // - miter: Use sharp corners (which aren't too sharp, see miterLimit). Extends edges until they meed.
  // - round: circular border with radius lineWidth/2 around joints
  // - bevel: directly joins the gap with a line segment.
  // See: https://svgwg.org/svg2-draft/painting.html#LineJoin

  // Even values in the array are the "dash" length, odd values are the "gap" length.
  // NOTE: If there is an odd number of entries, it behaves like lineDash.concat( lineDash ).
  // See: https://svgwg.org/svg2-draft/painting.html#StrokeDashing

  // Offset from the start of the subpath where the start of the line-dash array starts.

  // When to cut off lineJoin:miter to look like lineJoin:bevel. See https://svgwg.org/svg2-draft/painting.html

  constructor(options) {
    const filledOptions = merge({}, DEFAULT_OPTIONS, options);
    this.lineWidth = filledOptions.lineWidth;
    this.lineCap = filledOptions.lineCap;
    this.lineJoin = filledOptions.lineJoin;
    this.lineDash = filledOptions.lineDash;
    this.lineDashOffset = filledOptions.lineDashOffset;
    this.miterLimit = filledOptions.miterLimit;
    assert && assert(typeof this.lineWidth === 'number', `lineWidth should be a number: ${this.lineWidth}`);
    assert && assert(isFinite(this.lineWidth), `lineWidth should be a finite number: ${this.lineWidth}`);
    assert && assert(this.lineWidth >= 0, `lineWidth should be non-negative: ${this.lineWidth}`);
    assert && assert(this.lineCap === 'butt' || this.lineCap === 'round' || this.lineCap === 'square', `Invalid lineCap: ${this.lineCap}`);
    assert && assert(this.lineJoin === 'miter' || this.lineJoin === 'round' || this.lineJoin === 'bevel', `Invalid lineJoin: ${this.lineJoin}`);
    assert && assert(Array.isArray(this.lineDash), `lineDash should be an array: ${this.lineDash}`);
    assert && assert(_.every(this.lineDash, dash => typeof dash === 'number' && isFinite(dash) && dash >= 0), `Every lineDash should be a non-negative finite number: ${this.lineDash}`);
    assert && assert(typeof this.lineDashOffset === 'number', `lineDashOffset should be a number: ${this.lineDashOffset}`);
    assert && assert(isFinite(this.lineDashOffset), `lineDashOffset should be a finite number: ${this.lineDashOffset}`);
    assert && assert(typeof this.miterLimit === 'number', `miterLimit should be a number: ${this.miterLimit}`);
    assert && assert(isFinite(this.miterLimit), `miterLimit should be a finite number: ${this.miterLimit}`);
  }

  /**
   * Determines of this lineStyles is equal to the other LineStyles
   */
  equals(other) {
    const typical = this.lineWidth === other.lineWidth && this.lineCap === other.lineCap && this.lineJoin === other.lineJoin && this.miterLimit === other.miterLimit && this.lineDashOffset === other.lineDashOffset;
    if (!typical) {
      return false;
    }
    if (this.lineDash.length === other.lineDash.length) {
      for (let i = 0; i < this.lineDash.length; i++) {
        if (this.lineDash[i] !== other.lineDash[i]) {
          return false;
        }
      }
    } else {
      // line dashes must be different
      return false;
    }
    return true;
  }

  /**
   * Returns a copy of this LineStyles.
   */
  copy() {
    return new LineStyles({
      lineWidth: this.lineWidth,
      lineCap: this.lineCap,
      lineJoin: this.lineJoin,
      lineDash: this.lineDash,
      lineDashOffset: this.lineDashOffset,
      miterLimit: this.miterLimit
    });
  }

  /**
   * Creates an array of Segments that make up a line join, to the left side.
   *
   * Joins two segments together on the logical "left" side, at 'center' (where they meet), and un-normalized tangent
   * vectors in the direction of the stroking. To join on the "right" side, switch the tangent order and negate them.
   */
  leftJoin(center, fromTangent, toTangent) {
    fromTangent = fromTangent.normalized();
    toTangent = toTangent.normalized();

    // where our join path starts and ends
    const fromPoint = center.plus(fromTangent.perpendicular.negated().times(this.lineWidth / 2));
    const toPoint = center.plus(toTangent.perpendicular.negated().times(this.lineWidth / 2));
    const bevel = fromPoint.equals(toPoint) ? [] : [new Line(fromPoint, toPoint)];
    let fromAngle;
    let toAngle;
    let theta;

    // only insert a join on the non-acute-angle side
    // epsilon present for https://github.com/phetsims/kite/issues/73, where we don't want to join barely-existing
    // joins.
    if (fromTangent.perpendicular.dot(toTangent) > 1e-12) {
      switch (this.lineJoin) {
        case 'round':
          fromAngle = fromTangent.angle + Math.PI / 2;
          toAngle = toTangent.angle + Math.PI / 2;
          return [new Arc(center, this.lineWidth / 2, fromAngle, toAngle, true)];
        case 'miter':
          theta = fromTangent.angleBetween(toTangent.negated());
          if (1 / Math.sin(theta / 2) <= this.miterLimit && theta < Math.PI - 0.00001) {
            // draw the miter
            const miterPoint = lineLineIntersection(fromPoint, fromPoint.plus(fromTangent), toPoint, toPoint.plus(toTangent));
            if (miterPoint) {
              return [new Line(fromPoint, miterPoint), new Line(miterPoint, toPoint)];
            } else {
              return [new Line(fromPoint, toPoint)];
            }
          } else {
            // angle too steep, use bevel instead. same as below, but copied for linter
            return bevel;
          }
        case 'bevel':
          return bevel;
        default:
          throw new Error(`invalid lineJoin: ${this.lineJoin}`);
      }
    } else {
      // no join necessary here since we have the acute angle. just simple lineTo for now so that the next segment starts from the right place
      // TODO: can we prevent self-intersection here? https://github.com/phetsims/kite/issues/76
      return bevel;
    }
  }

  /**
   * Creates an array of Segments that make up a line join, to the right side.
   *
   * Joins two segments together on the logical "right" side, at 'center' (where they meet), and normalized tangent
   * vectors in the direction of the stroking. To join on the "left" side, switch the tangent order and negate them.
   */
  rightJoin(center, fromTangent, toTangent) {
    return this.leftJoin(center, toTangent.negated(), fromTangent.negated());
  }

  /**
   * Creates an array of Segments that make up a line cap from the endpoint 'center' in the direction of the tangent
   */
  cap(center, tangent) {
    tangent = tangent.normalized();
    const fromPoint = center.plus(tangent.perpendicular.times(-this.lineWidth / 2));
    const toPoint = center.plus(tangent.perpendicular.times(this.lineWidth / 2));
    let tangentAngle;
    let toLeft;
    let toRight;
    let toFront;
    let left;
    let right;
    switch (this.lineCap) {
      case 'butt':
        return [new Line(fromPoint, toPoint)];
      case 'round':
        tangentAngle = tangent.angle;
        return [new Arc(center, this.lineWidth / 2, tangentAngle + Math.PI / 2, tangentAngle - Math.PI / 2, true)];
      case 'square':
        toLeft = tangent.perpendicular.negated().times(this.lineWidth / 2);
        toRight = tangent.perpendicular.times(this.lineWidth / 2);
        toFront = tangent.times(this.lineWidth / 2);
        left = center.plus(toLeft).plus(toFront);
        right = center.plus(toRight).plus(toFront);
        return [new Line(fromPoint, left), new Line(left, right), new Line(right, toPoint)];
      default:
        throw new Error(`invalid lineCap: ${this.lineCap}`);
    }
  }
}
kite.register('LineStyles', LineStyles);
export { DEFAULT_OPTIONS as LINE_STYLE_DEFAULT_OPTIONS };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIm1lcmdlIiwiQXJjIiwia2l0ZSIsIkxpbmUiLCJsaW5lTGluZUludGVyc2VjdGlvbiIsIkRFRkFVTFRfT1BUSU9OUyIsImxpbmVXaWR0aCIsImxpbmVDYXAiLCJsaW5lSm9pbiIsImxpbmVEYXNoIiwibGluZURhc2hPZmZzZXQiLCJtaXRlckxpbWl0IiwiTGluZVN0eWxlcyIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImZpbGxlZE9wdGlvbnMiLCJhc3NlcnQiLCJpc0Zpbml0ZSIsIkFycmF5IiwiaXNBcnJheSIsIl8iLCJldmVyeSIsImRhc2giLCJlcXVhbHMiLCJvdGhlciIsInR5cGljYWwiLCJsZW5ndGgiLCJpIiwiY29weSIsImxlZnRKb2luIiwiY2VudGVyIiwiZnJvbVRhbmdlbnQiLCJ0b1RhbmdlbnQiLCJub3JtYWxpemVkIiwiZnJvbVBvaW50IiwicGx1cyIsInBlcnBlbmRpY3VsYXIiLCJuZWdhdGVkIiwidGltZXMiLCJ0b1BvaW50IiwiYmV2ZWwiLCJmcm9tQW5nbGUiLCJ0b0FuZ2xlIiwidGhldGEiLCJkb3QiLCJhbmdsZSIsIk1hdGgiLCJQSSIsImFuZ2xlQmV0d2VlbiIsInNpbiIsIm1pdGVyUG9pbnQiLCJFcnJvciIsInJpZ2h0Sm9pbiIsImNhcCIsInRhbmdlbnQiLCJ0YW5nZW50QW5nbGUiLCJ0b0xlZnQiLCJ0b1JpZ2h0IiwidG9Gcm9udCIsImxlZnQiLCJyaWdodCIsInJlZ2lzdGVyIiwiTElORV9TVFlMRV9ERUZBVUxUX09QVElPTlMiXSwic291cmNlcyI6WyJMaW5lU3R5bGVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDEzLTIwMjQsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFN0eWxlcyBuZWVkZWQgdG8gZGV0ZXJtaW5lIGEgc3Ryb2tlZCBsaW5lIHNoYXBlLiBHZW5lcmFsbHkgaW1tdXRhYmxlLlxyXG4gKlxyXG4gKiBNaXJyb3JzIG11Y2ggb2Ygd2hhdCBpcyBkb25lIHdpdGggU1ZHL0NhbnZhcywgc2VlIGh0dHBzOi8vc3Znd2cub3JnL3N2ZzItZHJhZnQvcGFpbnRpbmcuaHRtbCBmb3IgZGV0YWlscy5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBtZXJnZSBmcm9tICcuLi8uLi8uLi9waGV0LWNvcmUvanMvbWVyZ2UuanMnO1xyXG5pbXBvcnQgeyBBcmMsIGtpdGUsIExpbmUsIFNlZ21lbnQgfSBmcm9tICcuLi9pbXBvcnRzLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBsaW5lTGluZUludGVyc2VjdGlvbiA9IFV0aWxzLmxpbmVMaW5lSW50ZXJzZWN0aW9uO1xyXG5cclxuY29uc3QgREVGQVVMVF9PUFRJT05TID0ge1xyXG4gIGxpbmVXaWR0aDogMSxcclxuICBsaW5lQ2FwOiAnYnV0dCcsXHJcbiAgbGluZUpvaW46ICdtaXRlcicsXHJcbiAgbGluZURhc2g6IFtdLFxyXG4gIGxpbmVEYXNoT2Zmc2V0OiAwLFxyXG4gIG1pdGVyTGltaXQ6IDEwXHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBMaW5lQ2FwID0gJ2J1dHQnIHwgJ3JvdW5kJyB8ICdzcXVhcmUnO1xyXG5leHBvcnQgdHlwZSBMaW5lSm9pbiA9ICdtaXRlcicgfCAncm91bmQnIHwgJ2JldmVsJztcclxuZXhwb3J0IHR5cGUgTGluZVN0eWxlc09wdGlvbnMgPSB7XHJcbiAgbGluZVdpZHRoPzogbnVtYmVyO1xyXG4gIGxpbmVDYXA/OiBMaW5lQ2FwO1xyXG4gIGxpbmVKb2luPzogTGluZUpvaW47XHJcbiAgbGluZURhc2g/OiBudW1iZXJbXTtcclxuICBsaW5lRGFzaE9mZnNldD86IG51bWJlcjtcclxuICBtaXRlckxpbWl0PzogbnVtYmVyO1xyXG59O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTGluZVN0eWxlcyB7XHJcblxyXG4gIC8vIFRoZSB3aWR0aCBvZiB0aGUgbGluZSAod2lsbCBiZSBvZmZzZXQgdG8gZWFjaCBzaWRlIGJ5IGxpbmVXaWR0aC8yKVxyXG4gIHB1YmxpYyBsaW5lV2lkdGg6IG51bWJlcjtcclxuXHJcbiAgLy8gJ2J1dHQnLCAncm91bmQnIG9yICdzcXVhcmUnIC0gQ29udHJvbHMgYXBwZWFyYW5jZSBhdCBlbmRwb2ludHMgZm9yIG5vbi1jbG9zZWQgc3VicGF0aHMuXHJcbiAgLy8gLSBidXR0OiBzdHJhaWdodC1saW5lIGF0IGVuZCBwb2ludCwgZ29pbmcgdGhyb3VnaCB0aGUgZW5kcG9pbnQgKHBlcnBlbmRpY3VsYXIgdG8gdGhlIHRhbmdlbnQpXHJcbiAgLy8gLSByb3VuZDogY2lyY3VsYXIgYm9yZGVyIHdpdGggcmFkaXVzIGxpbmVXaWR0aC8yIGFyb3VuZCBlbmRwb2ludHNcclxuICAvLyAtIHNxdWFyZTogc3RyYWlnaHQtbGluZSBwYXN0IHRoZSBlbmQgcG9pbnQgKGJ5IGxpbmVXaWR0aC8yKVxyXG4gIC8vIFNlZTogaHR0cHM6Ly9zdmd3Zy5vcmcvc3ZnMi1kcmFmdC9wYWludGluZy5odG1sI0xpbmVDYXBzXHJcbiAgcHVibGljIGxpbmVDYXA6IExpbmVDYXA7XHJcblxyXG4gIC8vICdtaXRlcicsICdyb3VuZCcgb3IgJ2JldmVsJyAtIENvbnRyb2xzIGFwcGVhcmFuY2UgYXQgam9pbnRzIGJldHdlZW4gc2VnbWVudHMgKGF0IHRoZSBwb2ludClcclxuICAvLyAtIG1pdGVyOiBVc2Ugc2hhcnAgY29ybmVycyAod2hpY2ggYXJlbid0IHRvbyBzaGFycCwgc2VlIG1pdGVyTGltaXQpLiBFeHRlbmRzIGVkZ2VzIHVudGlsIHRoZXkgbWVlZC5cclxuICAvLyAtIHJvdW5kOiBjaXJjdWxhciBib3JkZXIgd2l0aCByYWRpdXMgbGluZVdpZHRoLzIgYXJvdW5kIGpvaW50c1xyXG4gIC8vIC0gYmV2ZWw6IGRpcmVjdGx5IGpvaW5zIHRoZSBnYXAgd2l0aCBhIGxpbmUgc2VnbWVudC5cclxuICAvLyBTZWU6IGh0dHBzOi8vc3Znd2cub3JnL3N2ZzItZHJhZnQvcGFpbnRpbmcuaHRtbCNMaW5lSm9pblxyXG4gIHB1YmxpYyBsaW5lSm9pbjogTGluZUpvaW47XHJcblxyXG4gIC8vIEV2ZW4gdmFsdWVzIGluIHRoZSBhcnJheSBhcmUgdGhlIFwiZGFzaFwiIGxlbmd0aCwgb2RkIHZhbHVlcyBhcmUgdGhlIFwiZ2FwXCIgbGVuZ3RoLlxyXG4gIC8vIE5PVEU6IElmIHRoZXJlIGlzIGFuIG9kZCBudW1iZXIgb2YgZW50cmllcywgaXQgYmVoYXZlcyBsaWtlIGxpbmVEYXNoLmNvbmNhdCggbGluZURhc2ggKS5cclxuICAvLyBTZWU6IGh0dHBzOi8vc3Znd2cub3JnL3N2ZzItZHJhZnQvcGFpbnRpbmcuaHRtbCNTdHJva2VEYXNoaW5nXHJcbiAgcHVibGljIGxpbmVEYXNoOiBudW1iZXJbXTtcclxuXHJcbiAgLy8gT2Zmc2V0IGZyb20gdGhlIHN0YXJ0IG9mIHRoZSBzdWJwYXRoIHdoZXJlIHRoZSBzdGFydCBvZiB0aGUgbGluZS1kYXNoIGFycmF5IHN0YXJ0cy5cclxuICBwdWJsaWMgbGluZURhc2hPZmZzZXQ6IG51bWJlcjtcclxuXHJcbiAgLy8gV2hlbiB0byBjdXQgb2ZmIGxpbmVKb2luOm1pdGVyIHRvIGxvb2sgbGlrZSBsaW5lSm9pbjpiZXZlbC4gU2VlIGh0dHBzOi8vc3Znd2cub3JnL3N2ZzItZHJhZnQvcGFpbnRpbmcuaHRtbFxyXG4gIHB1YmxpYyBtaXRlckxpbWl0OiBudW1iZXI7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvciggb3B0aW9ucz86IExpbmVTdHlsZXNPcHRpb25zICkge1xyXG4gICAgY29uc3QgZmlsbGVkT3B0aW9ucyA9IG1lcmdlKCB7fSwgREVGQVVMVF9PUFRJT05TLCBvcHRpb25zICkgYXMgUmVxdWlyZWQ8TGluZVN0eWxlc09wdGlvbnM+O1xyXG5cclxuICAgIHRoaXMubGluZVdpZHRoID0gZmlsbGVkT3B0aW9ucy5saW5lV2lkdGg7XHJcbiAgICB0aGlzLmxpbmVDYXAgPSBmaWxsZWRPcHRpb25zLmxpbmVDYXA7XHJcbiAgICB0aGlzLmxpbmVKb2luID0gZmlsbGVkT3B0aW9ucy5saW5lSm9pbjtcclxuICAgIHRoaXMubGluZURhc2ggPSBmaWxsZWRPcHRpb25zLmxpbmVEYXNoO1xyXG4gICAgdGhpcy5saW5lRGFzaE9mZnNldCA9IGZpbGxlZE9wdGlvbnMubGluZURhc2hPZmZzZXQ7XHJcbiAgICB0aGlzLm1pdGVyTGltaXQgPSBmaWxsZWRPcHRpb25zLm1pdGVyTGltaXQ7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdHlwZW9mIHRoaXMubGluZVdpZHRoID09PSAnbnVtYmVyJywgYGxpbmVXaWR0aCBzaG91bGQgYmUgYSBudW1iZXI6ICR7dGhpcy5saW5lV2lkdGh9YCApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggaXNGaW5pdGUoIHRoaXMubGluZVdpZHRoICksIGBsaW5lV2lkdGggc2hvdWxkIGJlIGEgZmluaXRlIG51bWJlcjogJHt0aGlzLmxpbmVXaWR0aH1gICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLmxpbmVXaWR0aCA+PSAwLCBgbGluZVdpZHRoIHNob3VsZCBiZSBub24tbmVnYXRpdmU6ICR7dGhpcy5saW5lV2lkdGh9YCApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5saW5lQ2FwID09PSAnYnV0dCcgfHwgdGhpcy5saW5lQ2FwID09PSAncm91bmQnIHx8IHRoaXMubGluZUNhcCA9PT0gJ3NxdWFyZScsXHJcbiAgICAgIGBJbnZhbGlkIGxpbmVDYXA6ICR7dGhpcy5saW5lQ2FwfWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMubGluZUpvaW4gPT09ICdtaXRlcicgfHwgdGhpcy5saW5lSm9pbiA9PT0gJ3JvdW5kJyB8fCB0aGlzLmxpbmVKb2luID09PSAnYmV2ZWwnLFxyXG4gICAgICBgSW52YWxpZCBsaW5lSm9pbjogJHt0aGlzLmxpbmVKb2lufWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIEFycmF5LmlzQXJyYXkoIHRoaXMubGluZURhc2ggKSwgYGxpbmVEYXNoIHNob3VsZCBiZSBhbiBhcnJheTogJHt0aGlzLmxpbmVEYXNofWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIF8uZXZlcnkoIHRoaXMubGluZURhc2gsIGRhc2ggPT4gKCB0eXBlb2YgZGFzaCA9PT0gJ251bWJlcicgKSAmJiBpc0Zpbml0ZSggZGFzaCApICYmIGRhc2ggPj0gMCApLFxyXG4gICAgICBgRXZlcnkgbGluZURhc2ggc2hvdWxkIGJlIGEgbm9uLW5lZ2F0aXZlIGZpbml0ZSBudW1iZXI6ICR7dGhpcy5saW5lRGFzaH1gICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0eXBlb2YgdGhpcy5saW5lRGFzaE9mZnNldCA9PT0gJ251bWJlcicsIGBsaW5lRGFzaE9mZnNldCBzaG91bGQgYmUgYSBudW1iZXI6ICR7dGhpcy5saW5lRGFzaE9mZnNldH1gICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBpc0Zpbml0ZSggdGhpcy5saW5lRGFzaE9mZnNldCApLCBgbGluZURhc2hPZmZzZXQgc2hvdWxkIGJlIGEgZmluaXRlIG51bWJlcjogJHt0aGlzLmxpbmVEYXNoT2Zmc2V0fWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHR5cGVvZiB0aGlzLm1pdGVyTGltaXQgPT09ICdudW1iZXInLCBgbWl0ZXJMaW1pdCBzaG91bGQgYmUgYSBudW1iZXI6ICR7dGhpcy5taXRlckxpbWl0fWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGlzRmluaXRlKCB0aGlzLm1pdGVyTGltaXQgKSwgYG1pdGVyTGltaXQgc2hvdWxkIGJlIGEgZmluaXRlIG51bWJlcjogJHt0aGlzLm1pdGVyTGltaXR9YCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGV0ZXJtaW5lcyBvZiB0aGlzIGxpbmVTdHlsZXMgaXMgZXF1YWwgdG8gdGhlIG90aGVyIExpbmVTdHlsZXNcclxuICAgKi9cclxuICBwdWJsaWMgZXF1YWxzKCBvdGhlcjogTGluZVN0eWxlcyApOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHR5cGljYWwgPSB0aGlzLmxpbmVXaWR0aCA9PT0gb3RoZXIubGluZVdpZHRoICYmXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5saW5lQ2FwID09PSBvdGhlci5saW5lQ2FwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5saW5lSm9pbiA9PT0gb3RoZXIubGluZUpvaW4gJiZcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1pdGVyTGltaXQgPT09IG90aGVyLm1pdGVyTGltaXQgJiZcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxpbmVEYXNoT2Zmc2V0ID09PSBvdGhlci5saW5lRGFzaE9mZnNldDtcclxuICAgIGlmICggIXR5cGljYWwgKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIHRoaXMubGluZURhc2gubGVuZ3RoID09PSBvdGhlci5saW5lRGFzaC5sZW5ndGggKSB7XHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMubGluZURhc2gubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgICAgaWYgKCB0aGlzLmxpbmVEYXNoWyBpIF0gIT09IG90aGVyLmxpbmVEYXNoWyBpIF0gKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgLy8gbGluZSBkYXNoZXMgbXVzdCBiZSBkaWZmZXJlbnRcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBhIGNvcHkgb2YgdGhpcyBMaW5lU3R5bGVzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb3B5KCk6IExpbmVTdHlsZXMge1xyXG4gICAgcmV0dXJuIG5ldyBMaW5lU3R5bGVzKCB7XHJcbiAgICAgIGxpbmVXaWR0aDogdGhpcy5saW5lV2lkdGgsXHJcbiAgICAgIGxpbmVDYXA6IHRoaXMubGluZUNhcCxcclxuICAgICAgbGluZUpvaW46IHRoaXMubGluZUpvaW4sXHJcbiAgICAgIGxpbmVEYXNoOiB0aGlzLmxpbmVEYXNoLFxyXG4gICAgICBsaW5lRGFzaE9mZnNldDogdGhpcy5saW5lRGFzaE9mZnNldCxcclxuICAgICAgbWl0ZXJMaW1pdDogdGhpcy5taXRlckxpbWl0XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIFNlZ21lbnRzIHRoYXQgbWFrZSB1cCBhIGxpbmUgam9pbiwgdG8gdGhlIGxlZnQgc2lkZS5cclxuICAgKlxyXG4gICAqIEpvaW5zIHR3byBzZWdtZW50cyB0b2dldGhlciBvbiB0aGUgbG9naWNhbCBcImxlZnRcIiBzaWRlLCBhdCAnY2VudGVyJyAod2hlcmUgdGhleSBtZWV0KSwgYW5kIHVuLW5vcm1hbGl6ZWQgdGFuZ2VudFxyXG4gICAqIHZlY3RvcnMgaW4gdGhlIGRpcmVjdGlvbiBvZiB0aGUgc3Ryb2tpbmcuIFRvIGpvaW4gb24gdGhlIFwicmlnaHRcIiBzaWRlLCBzd2l0Y2ggdGhlIHRhbmdlbnQgb3JkZXIgYW5kIG5lZ2F0ZSB0aGVtLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBsZWZ0Sm9pbiggY2VudGVyOiBWZWN0b3IyLCBmcm9tVGFuZ2VudDogVmVjdG9yMiwgdG9UYW5nZW50OiBWZWN0b3IyICk6IFNlZ21lbnRbXSB7XHJcbiAgICBmcm9tVGFuZ2VudCA9IGZyb21UYW5nZW50Lm5vcm1hbGl6ZWQoKTtcclxuICAgIHRvVGFuZ2VudCA9IHRvVGFuZ2VudC5ub3JtYWxpemVkKCk7XHJcblxyXG4gICAgLy8gd2hlcmUgb3VyIGpvaW4gcGF0aCBzdGFydHMgYW5kIGVuZHNcclxuICAgIGNvbnN0IGZyb21Qb2ludCA9IGNlbnRlci5wbHVzKCBmcm9tVGFuZ2VudC5wZXJwZW5kaWN1bGFyLm5lZ2F0ZWQoKS50aW1lcyggdGhpcy5saW5lV2lkdGggLyAyICkgKTtcclxuICAgIGNvbnN0IHRvUG9pbnQgPSBjZW50ZXIucGx1cyggdG9UYW5nZW50LnBlcnBlbmRpY3VsYXIubmVnYXRlZCgpLnRpbWVzKCB0aGlzLmxpbmVXaWR0aCAvIDIgKSApO1xyXG5cclxuICAgIGNvbnN0IGJldmVsID0gKCBmcm9tUG9pbnQuZXF1YWxzKCB0b1BvaW50ICkgPyBbXSA6IFsgbmV3IExpbmUoIGZyb21Qb2ludCwgdG9Qb2ludCApIF0gKTtcclxuXHJcbiAgICBsZXQgZnJvbUFuZ2xlO1xyXG4gICAgbGV0IHRvQW5nbGU7XHJcbiAgICBsZXQgdGhldGE7XHJcblxyXG4gICAgLy8gb25seSBpbnNlcnQgYSBqb2luIG9uIHRoZSBub24tYWN1dGUtYW5nbGUgc2lkZVxyXG4gICAgLy8gZXBzaWxvbiBwcmVzZW50IGZvciBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMva2l0ZS9pc3N1ZXMvNzMsIHdoZXJlIHdlIGRvbid0IHdhbnQgdG8gam9pbiBiYXJlbHktZXhpc3RpbmdcclxuICAgIC8vIGpvaW5zLlxyXG4gICAgaWYgKCBmcm9tVGFuZ2VudC5wZXJwZW5kaWN1bGFyLmRvdCggdG9UYW5nZW50ICkgPiAxZS0xMiApIHtcclxuICAgICAgc3dpdGNoKCB0aGlzLmxpbmVKb2luICkge1xyXG4gICAgICAgIGNhc2UgJ3JvdW5kJzpcclxuICAgICAgICAgIGZyb21BbmdsZSA9IGZyb21UYW5nZW50LmFuZ2xlICsgTWF0aC5QSSAvIDI7XHJcbiAgICAgICAgICB0b0FuZ2xlID0gdG9UYW5nZW50LmFuZ2xlICsgTWF0aC5QSSAvIDI7XHJcbiAgICAgICAgICByZXR1cm4gWyBuZXcgQXJjKCBjZW50ZXIsIHRoaXMubGluZVdpZHRoIC8gMiwgZnJvbUFuZ2xlLCB0b0FuZ2xlLCB0cnVlICkgXTtcclxuICAgICAgICBjYXNlICdtaXRlcic6XHJcbiAgICAgICAgICB0aGV0YSA9IGZyb21UYW5nZW50LmFuZ2xlQmV0d2VlbiggdG9UYW5nZW50Lm5lZ2F0ZWQoKSApO1xyXG4gICAgICAgICAgaWYgKCAxIC8gTWF0aC5zaW4oIHRoZXRhIC8gMiApIDw9IHRoaXMubWl0ZXJMaW1pdCAmJiB0aGV0YSA8IE1hdGguUEkgLSAwLjAwMDAxICkge1xyXG4gICAgICAgICAgICAvLyBkcmF3IHRoZSBtaXRlclxyXG4gICAgICAgICAgICBjb25zdCBtaXRlclBvaW50ID0gbGluZUxpbmVJbnRlcnNlY3Rpb24oIGZyb21Qb2ludCwgZnJvbVBvaW50LnBsdXMoIGZyb21UYW5nZW50ICksIHRvUG9pbnQsIHRvUG9pbnQucGx1cyggdG9UYW5nZW50ICkgKTtcclxuICAgICAgICAgICAgaWYgKCBtaXRlclBvaW50ICkge1xyXG4gICAgICAgICAgICAgIHJldHVybiBbXHJcbiAgICAgICAgICAgICAgICBuZXcgTGluZSggZnJvbVBvaW50LCBtaXRlclBvaW50ICksXHJcbiAgICAgICAgICAgICAgICBuZXcgTGluZSggbWl0ZXJQb2ludCwgdG9Qb2ludCApXHJcbiAgICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICByZXR1cm4gW1xyXG4gICAgICAgICAgICAgICAgbmV3IExpbmUoIGZyb21Qb2ludCwgdG9Qb2ludCApXHJcbiAgICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIGFuZ2xlIHRvbyBzdGVlcCwgdXNlIGJldmVsIGluc3RlYWQuIHNhbWUgYXMgYmVsb3csIGJ1dCBjb3BpZWQgZm9yIGxpbnRlclxyXG4gICAgICAgICAgICByZXR1cm4gYmV2ZWw7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgY2FzZSAnYmV2ZWwnOlxyXG4gICAgICAgICAgcmV0dXJuIGJldmVsO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIGBpbnZhbGlkIGxpbmVKb2luOiAke3RoaXMubGluZUpvaW59YCApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgLy8gbm8gam9pbiBuZWNlc3NhcnkgaGVyZSBzaW5jZSB3ZSBoYXZlIHRoZSBhY3V0ZSBhbmdsZS4ganVzdCBzaW1wbGUgbGluZVRvIGZvciBub3cgc28gdGhhdCB0aGUgbmV4dCBzZWdtZW50IHN0YXJ0cyBmcm9tIHRoZSByaWdodCBwbGFjZVxyXG4gICAgICAvLyBUT0RPOiBjYW4gd2UgcHJldmVudCBzZWxmLWludGVyc2VjdGlvbiBoZXJlPyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMva2l0ZS9pc3N1ZXMvNzZcclxuICAgICAgcmV0dXJuIGJldmVsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiBTZWdtZW50cyB0aGF0IG1ha2UgdXAgYSBsaW5lIGpvaW4sIHRvIHRoZSByaWdodCBzaWRlLlxyXG4gICAqXHJcbiAgICogSm9pbnMgdHdvIHNlZ21lbnRzIHRvZ2V0aGVyIG9uIHRoZSBsb2dpY2FsIFwicmlnaHRcIiBzaWRlLCBhdCAnY2VudGVyJyAod2hlcmUgdGhleSBtZWV0KSwgYW5kIG5vcm1hbGl6ZWQgdGFuZ2VudFxyXG4gICAqIHZlY3RvcnMgaW4gdGhlIGRpcmVjdGlvbiBvZiB0aGUgc3Ryb2tpbmcuIFRvIGpvaW4gb24gdGhlIFwibGVmdFwiIHNpZGUsIHN3aXRjaCB0aGUgdGFuZ2VudCBvcmRlciBhbmQgbmVnYXRlIHRoZW0uXHJcbiAgICovXHJcbiAgcHVibGljIHJpZ2h0Sm9pbiggY2VudGVyOiBWZWN0b3IyLCBmcm9tVGFuZ2VudDogVmVjdG9yMiwgdG9UYW5nZW50OiBWZWN0b3IyICk6IFNlZ21lbnRbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5sZWZ0Sm9pbiggY2VudGVyLCB0b1RhbmdlbnQubmVnYXRlZCgpLCBmcm9tVGFuZ2VudC5uZWdhdGVkKCkgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgU2VnbWVudHMgdGhhdCBtYWtlIHVwIGEgbGluZSBjYXAgZnJvbSB0aGUgZW5kcG9pbnQgJ2NlbnRlcicgaW4gdGhlIGRpcmVjdGlvbiBvZiB0aGUgdGFuZ2VudFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjYXAoIGNlbnRlcjogVmVjdG9yMiwgdGFuZ2VudDogVmVjdG9yMiApOiBTZWdtZW50W10ge1xyXG4gICAgdGFuZ2VudCA9IHRhbmdlbnQubm9ybWFsaXplZCgpO1xyXG5cclxuICAgIGNvbnN0IGZyb21Qb2ludCA9IGNlbnRlci5wbHVzKCB0YW5nZW50LnBlcnBlbmRpY3VsYXIudGltZXMoIC10aGlzLmxpbmVXaWR0aCAvIDIgKSApO1xyXG4gICAgY29uc3QgdG9Qb2ludCA9IGNlbnRlci5wbHVzKCB0YW5nZW50LnBlcnBlbmRpY3VsYXIudGltZXMoIHRoaXMubGluZVdpZHRoIC8gMiApICk7XHJcblxyXG4gICAgbGV0IHRhbmdlbnRBbmdsZTtcclxuICAgIGxldCB0b0xlZnQ7XHJcbiAgICBsZXQgdG9SaWdodDtcclxuICAgIGxldCB0b0Zyb250O1xyXG4gICAgbGV0IGxlZnQ7XHJcbiAgICBsZXQgcmlnaHQ7XHJcblxyXG4gICAgc3dpdGNoKCB0aGlzLmxpbmVDYXAgKSB7XHJcbiAgICAgIGNhc2UgJ2J1dHQnOlxyXG4gICAgICAgIHJldHVybiBbIG5ldyBMaW5lKCBmcm9tUG9pbnQsIHRvUG9pbnQgKSBdO1xyXG4gICAgICBjYXNlICdyb3VuZCc6XHJcbiAgICAgICAgdGFuZ2VudEFuZ2xlID0gdGFuZ2VudC5hbmdsZTtcclxuICAgICAgICByZXR1cm4gWyBuZXcgQXJjKCBjZW50ZXIsIHRoaXMubGluZVdpZHRoIC8gMiwgdGFuZ2VudEFuZ2xlICsgTWF0aC5QSSAvIDIsIHRhbmdlbnRBbmdsZSAtIE1hdGguUEkgLyAyLCB0cnVlICkgXTtcclxuICAgICAgY2FzZSAnc3F1YXJlJzpcclxuICAgICAgICB0b0xlZnQgPSB0YW5nZW50LnBlcnBlbmRpY3VsYXIubmVnYXRlZCgpLnRpbWVzKCB0aGlzLmxpbmVXaWR0aCAvIDIgKTtcclxuICAgICAgICB0b1JpZ2h0ID0gdGFuZ2VudC5wZXJwZW5kaWN1bGFyLnRpbWVzKCB0aGlzLmxpbmVXaWR0aCAvIDIgKTtcclxuICAgICAgICB0b0Zyb250ID0gdGFuZ2VudC50aW1lcyggdGhpcy5saW5lV2lkdGggLyAyICk7XHJcblxyXG4gICAgICAgIGxlZnQgPSBjZW50ZXIucGx1cyggdG9MZWZ0ICkucGx1cyggdG9Gcm9udCApO1xyXG4gICAgICAgIHJpZ2h0ID0gY2VudGVyLnBsdXMoIHRvUmlnaHQgKS5wbHVzKCB0b0Zyb250ICk7XHJcbiAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgIG5ldyBMaW5lKCBmcm9tUG9pbnQsIGxlZnQgKSxcclxuICAgICAgICAgIG5ldyBMaW5lKCBsZWZ0LCByaWdodCApLFxyXG4gICAgICAgICAgbmV3IExpbmUoIHJpZ2h0LCB0b1BvaW50IClcclxuICAgICAgICBdO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvciggYGludmFsaWQgbGluZUNhcDogJHt0aGlzLmxpbmVDYXB9YCApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxua2l0ZS5yZWdpc3RlciggJ0xpbmVTdHlsZXMnLCBMaW5lU3R5bGVzICk7XHJcblxyXG5leHBvcnQgeyBERUZBVUxUX09QVElPTlMgYXMgTElORV9TVFlMRV9ERUZBVUxUX09QVElPTlMgfTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLEtBQUssTUFBTSwwQkFBMEI7QUFFNUMsT0FBT0MsS0FBSyxNQUFNLGdDQUFnQztBQUNsRCxTQUFTQyxHQUFHLEVBQUVD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T0FBTztNQUNsQixLQUFLLE1BQU07UUFDVCxPQUFPLENBQUUsSUFBSUosSUFBSSxDQUFFK0IsU0FBUyxFQUFFSyxPQUFRLENBQUMsQ0FBRTtNQUMzQyxLQUFLLE9BQU87UUFDVmdCLFlBQVksR0FBR0QsT0FBTyxDQUFDVCxLQUFLO1FBQzVCLE9BQU8sQ0FBRSxJQUFJNUMsR0FBRyxDQUFFNkIsTUFBTSxFQUFFLElBQUksQ0FBQ3hCLFNBQVMsR0FBRyxDQUFDLEVBQUVpRCxZQUFZLEdBQUdULElBQUksQ0FBQ0MsRUFBRSxHQUFHLENBQUMsRUFBRVEsWUFBWSxHQUFHVCxJQUFJLENBQUNDLEVBQUUsR0FBRyxDQUFDLEVBQUUsSUFBSyxDQUFDLENBQUU7TUFDaEgsS0FBSyxRQUFRO1FBQ1hTLE1BQU0sR0FBR0YsT0FBTyxDQUFDbEIsYUFBYSxDQUFDQyxPQUFPLENBQUMsQ0FBQyxDQUFDQyxLQUFLLENBQUUsSUFBSSxDQUFDaEMsU0FBUyxHQUFHLENBQUUsQ0FBQztRQUNwRW1ELE9BQU8sR0FBR0gsT0FBTyxDQUFDbEIsYUFBYSxDQUFDRSxLQUFLLENBQUUsSUFBSSxDQUFDaEMsU0FBUyxHQUFHLENBQUUsQ0FBQztRQUMzRG9ELE9BQU8sR0FBR0osT0FBTyxDQUFDaEIsS0FBSyxDQUFFLElBQUksQ0FBQ2hDLFNBQVMsR0FBRyxDQUFFLENBQUM7UUFFN0NxRCxJQUFJLEdBQUc3QixNQUFNLENBQUNLLElBQUksQ0FBRXFCLE1BQU8sQ0FBQyxDQUFDckIsSUFBSSxDQUFFdUIsT0FBUSxDQUFDO1FBQzVDRSxLQUFLLEdBQUc5QixNQUFNLENBQUNLLElBQUksQ0FBRXNCLE9BQVEsQ0FBQyxDQUFDdEIsSUFBSSxDQUFFdUIsT0FBUSxDQUFDO1FBQzlDLE9BQU8sQ0FDTCxJQUFJdkQsSUFBSSxDQUFFK0IsU0FBUyxFQUFFeUIsSUFBSyxDQUFDLEVBQzNCLElBQUl4RCxJQUFJLENBQUV3RCxJQUFJLEVBQUVDLEtBQU0sQ0FBQyxFQUN2QixJQUFJekQsSUFBSSxDQUFFeUQsS0FBSyxFQUFFckIsT0FBUSxDQUFDLENBQzNCO01BQ0g7UUFDRSxNQUFNLElBQUlZLEtBQUssQ0FBRyxvQkFBbUIsSUFBSSxDQUFDNUMsT0FBUSxFQUFFLENBQUM7SUFDekQ7RUFDRjtBQUNGO0FBRUFMLElBQUksQ0FBQzJELFFBQVEsQ0FBRSxZQUFZLEVBQUVqRCxVQUFXLENBQUM7QUFFekMsU0FBU1AsZUFBZSxJQUFJeUQsMEJBQTBCIiwiaWdub3JlTGlzdCI6W119