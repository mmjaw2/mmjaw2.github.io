// Copyright 2022-2023, University of Colorado Boulder

/**
 * An instrumented class that wraps a function that does "work" that needs to be interoperable with PhET-iO.
 * PhetioAction supports the following features:
 *
 * 1. Data stream support: The function will be wrapped in an `executed` event and added to the data stream, nesting
 * subsequent events the action's "work" cascades to as child events.
 * 2. Interopererability: PhetioActionIO supports the `execute` method so that PhetioAction instances can be executed
 * from the PhET-iO wrapper.
 * 3. It also has an emitter if you want to listen to when the action is done doing its work, https://github.com/phetsims/phet-io/issues/1543
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import tandemNamespace from './tandemNamespace.js';
import IOType from './types/IOType.js';
import optionize from '../../phet-core/js/optionize.js';
import Tandem from './Tandem.js';
import VoidIO from './types/VoidIO.js';
import PhetioDataHandler from './PhetioDataHandler.js';
import Emitter from '../../axon/js/Emitter.js';
import PhetioObject from './PhetioObject.js';
import ArrayIO from './types/ArrayIO.js';
import NullableIO from './types/NullableIO.js';
import StringIO from './types/StringIO.js';
import IOTypeCache from './IOTypeCache.js';
const EMPTY_ARRAY = [];

// By default, PhetioActions are not stateful
const PHET_IO_STATE_DEFAULT = false;

// undefined and never are not allowed as parameters to PhetioAction

class PhetioAction extends PhetioDataHandler {
  // Keep track of it this instance is currently executing its action, see execute() for implementation. This needs to
  // be a stack because reentrant PhetioAction execute calls are supported.

  // Disposal can potentially occur from the action that is being executed. If this is the case, we still want to emit
  // the executedEmitter upon completion of the action, so defer disposal of the executedEmitter (and
  // disposePhetioAction in general), until the execute() function is complete. This doesn't need to be a stack because
  // we do not allow reentrant PhetioActions (guarded with an assertion in execute()).

  // Called upon disposal of PhetioAction, but if dispose() is called while the action is executing, defer calling this
  // function until the execute() function is complete.

  // To listen to when the action has completed.

  static PhetioActionIO = parameterTypes => {
    const key = parameterTypes.map(getTypeName).join(',');
    if (!cache.has(key)) {
      cache.set(key, new IOType(`PhetioActionIO<${parameterTypes.map(getTypeName).join(', ')}>`, {
        valueType: PhetioAction,
        documentation: 'Executes when an event occurs',
        events: ['executed'],
        parameterTypes: parameterTypes,
        metadataDefaults: {
          phetioState: PHET_IO_STATE_DEFAULT
        },
        methods: {
          execute: {
            returnType: VoidIO,
            parameterTypes: parameterTypes,
            implementation: function (...values) {
              this.execute(...values);
            },
            documentation: 'Executes the function the PhetioAction is wrapping.',
            invocableForReadOnlyElements: false
          },
          getValidationErrors: {
            returnType: ArrayIO(NullableIO(StringIO)),
            parameterTypes: parameterTypes,
            implementation: function (...values) {
              return this.getValidationErrors(...values);
            },
            documentation: 'Checks to see if the proposed values are valid. Returns an array of length N where each element is an error (string) or null if the value is valid.'
          }
        }
      }));
    }
    return cache.get(key);
  };

  /**
   * @param action - the function that is called when this PhetioAction occurs
   * @param providedOptions
   */
  constructor(action, providedOptions) {
    const options = optionize()({
      // We need to define this here in addition to PhetioDataHandler to pass to executedEmitter
      parameters: EMPTY_ARRAY,
      // PhetioDataHandler
      phetioOuterType: PhetioAction.PhetioActionIO,
      // PhetioObject
      phetioState: PHET_IO_STATE_DEFAULT,
      phetioReadOnly: PhetioObject.DEFAULT_OPTIONS.phetioReadOnly,
      phetioHighFrequency: PhetioObject.DEFAULT_OPTIONS.phetioHighFrequency,
      phetioEventType: PhetioObject.DEFAULT_OPTIONS.phetioEventType,
      phetioDocumentation: 'A class that wraps a function, adding API to execute that function and data stream capture.'
    }, providedOptions);
    super(options);
    this.action = action;
    this.isExecutingCount = 0;
    this.disposeOnExecuteCompletion = false;
    this.executedEmitter = new Emitter({
      parameters: options.parameters,
      tandem: options.tandem?.createTandem('executedEmitter'),
      hasListenerOrderDependencies: options.hasListenerOrderDependencies,
      phetioState: options.phetioState,
      phetioReadOnly: options.phetioReadOnly,
      phetioHighFrequency: options.phetioHighFrequency,
      phetioEventType: options.phetioEventType,
      phetioDocumentation: 'Emitter that emits when this actions work is complete'
    });
    this.disposePhetioAction = () => {
      this.executedEmitter.dispose();
    };
  }

  /**
   * Invokes the action.
   * @params - expected parameters are based on options.parameters, see constructor
   */
  execute(...args) {
    assert && assert(!this.isDisposed, 'should not be called if disposed');

    // We delay the disposal of composed entities to handle reentrant cases of disposing ourself.
    assert && assert(!this.executedEmitter.isDisposed, 'self should not be disposed');
    this.isExecutingCount++;
    assert && super.validateArguments(...args);

    // Although this is not the idiomatic pattern (since it is guarded in the phetioStartEvent), this function is
    // called so many times that it is worth the optimization for PhET brand.
    Tandem.PHET_IO_ENABLED && this.isPhetioInstrumented() && this.phetioStartEvent('executed', {
      data: this.getPhetioData(...args)
    });
    this.action.apply(null, args);
    this.executedEmitter.emit(...args);
    Tandem.PHET_IO_ENABLED && this.isPhetioInstrumented() && this.phetioEndEvent();
    this.isExecutingCount--;
    if (this.disposeOnExecuteCompletion && this.isExecutingCount === 0) {
      this.disposePhetioAction();
      this.disposeOnExecuteCompletion = false;
    }
  }

  /**
   * Note: Be careful about adding disposal logic directly to this function, it is likely preferred to add it to
   * disposePhetioAction instead, see disposeOnExecuteCompletion for details.
   */
  dispose() {
    if (this.isExecutingCount > 0) {
      // Defer disposing components until executing is completed, see disposeOnExecuteCompletion.
      this.disposeOnExecuteCompletion = true;
    } else {
      this.disposePhetioAction();
    }

    // Always dispose the object itself, or PhetioObject will assert out.
    super.dispose();
  }
}
const getTypeName = ioType => ioType.typeName;

// cache each parameterized IOType so that it is only created once.
const cache = new IOTypeCache();
tandemNamespace.register('PhetioAction', PhetioAction);
export default PhetioAction;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ0YW5kZW1OYW1lc3BhY2UiLCJJT1R5cGUiLCJvcHRpb25pemUiLCJUYW5kZW0iLCJWb2lkSU8iLCJQaGV0aW9EYXRhSGFuZGxlciIsIkVtaXR0ZXIiLCJQaGV0aW9PYmplY3QiLCJBcnJheUlPIiwiTnVsbGFibGVJTyIsIlN0cmluZ0lPIiwiSU9UeXBlQ2FjaGUiLCJFTVBUWV9BUlJBWSIsIlBIRVRfSU9fU1RBVEVfREVGQVVMVCIsIlBoZXRpb0FjdGlvbiIsIlBoZXRpb0FjdGlvbklPIiwicGFyYW1ldGVyVHlwZXMiLCJrZXkiLCJtYXAiLCJnZXRUeXBlTmFtZSIsImpvaW4iLCJjYWNoZSIsImhhcyIsInNldCIsInZhbHVlVHlwZSIsImRvY3VtZW50YXRpb24iLCJldmVudHMiLCJtZXRhZGF0YURlZmF1bHRzIiwicGhldGlvU3RhdGUiLCJtZXRob2RzIiwiZXhlY3V0ZSIsInJldHVyblR5cGUiLCJpbXBsZW1lbnRhdGlvbiIsInZhbHVlcyIsImludm9jYWJsZUZvclJlYWRPbmx5RWxlbWVudHMiLCJnZXRWYWxpZGF0aW9uRXJyb3JzIiwiZ2V0IiwiY29uc3RydWN0b3IiLCJhY3Rpb24iLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwicGFyYW1ldGVycyIsInBoZXRpb091dGVyVHlwZSIsInBoZXRpb1JlYWRPbmx5IiwiREVGQVVMVF9PUFRJT05TIiwicGhldGlvSGlnaEZyZXF1ZW5jeSIsInBoZXRpb0V2ZW50VHlwZSIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJpc0V4ZWN1dGluZ0NvdW50IiwiZGlzcG9zZU9uRXhlY3V0ZUNvbXBsZXRpb24iLCJleGVjdXRlZEVtaXR0ZXIiLCJ0YW5kZW0iLCJjcmVhdGVUYW5kZW0iLCJoYXNMaXN0ZW5lck9yZGVyRGVwZW5kZW5jaWVzIiwiZGlzcG9zZVBoZXRpb0FjdGlvbiIsImRpc3Bvc2UiLCJhcmdzIiwiYXNzZXJ0IiwiaXNEaXNwb3NlZCIsInZhbGlkYXRlQXJndW1lbnRzIiwiUEhFVF9JT19FTkFCTEVEIiwiaXNQaGV0aW9JbnN0cnVtZW50ZWQiLCJwaGV0aW9TdGFydEV2ZW50IiwiZGF0YSIsImdldFBoZXRpb0RhdGEiLCJhcHBseSIsImVtaXQiLCJwaGV0aW9FbmRFdmVudCIsImlvVHlwZSIsInR5cGVOYW1lIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJQaGV0aW9BY3Rpb24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjItMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQW4gaW5zdHJ1bWVudGVkIGNsYXNzIHRoYXQgd3JhcHMgYSBmdW5jdGlvbiB0aGF0IGRvZXMgXCJ3b3JrXCIgdGhhdCBuZWVkcyB0byBiZSBpbnRlcm9wZXJhYmxlIHdpdGggUGhFVC1pTy5cclxuICogUGhldGlvQWN0aW9uIHN1cHBvcnRzIHRoZSBmb2xsb3dpbmcgZmVhdHVyZXM6XHJcbiAqXHJcbiAqIDEuIERhdGEgc3RyZWFtIHN1cHBvcnQ6IFRoZSBmdW5jdGlvbiB3aWxsIGJlIHdyYXBwZWQgaW4gYW4gYGV4ZWN1dGVkYCBldmVudCBhbmQgYWRkZWQgdG8gdGhlIGRhdGEgc3RyZWFtLCBuZXN0aW5nXHJcbiAqIHN1YnNlcXVlbnQgZXZlbnRzIHRoZSBhY3Rpb24ncyBcIndvcmtcIiBjYXNjYWRlcyB0byBhcyBjaGlsZCBldmVudHMuXHJcbiAqIDIuIEludGVyb3BlcmVyYWJpbGl0eTogUGhldGlvQWN0aW9uSU8gc3VwcG9ydHMgdGhlIGBleGVjdXRlYCBtZXRob2Qgc28gdGhhdCBQaGV0aW9BY3Rpb24gaW5zdGFuY2VzIGNhbiBiZSBleGVjdXRlZFxyXG4gKiBmcm9tIHRoZSBQaEVULWlPIHdyYXBwZXIuXHJcbiAqIDMuIEl0IGFsc28gaGFzIGFuIGVtaXR0ZXIgaWYgeW91IHdhbnQgdG8gbGlzdGVuIHRvIHdoZW4gdGhlIGFjdGlvbiBpcyBkb25lIGRvaW5nIGl0cyB3b3JrLCBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvcGhldC1pby9pc3N1ZXMvMTU0M1xyXG4gKlxyXG4gKiBAYXV0aG9yIE1pY2hhZWwgS2F1em1hbm4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IHRhbmRlbU5hbWVzcGFjZSBmcm9tICcuL3RhbmRlbU5hbWVzcGFjZS5qcyc7XHJcbmltcG9ydCBJT1R5cGUgZnJvbSAnLi90eXBlcy9JT1R5cGUuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplLCB7IEVtcHR5U2VsZk9wdGlvbnMgfSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBWb2lkSU8gZnJvbSAnLi90eXBlcy9Wb2lkSU8uanMnO1xyXG5pbXBvcnQgUGhldGlvRGF0YUhhbmRsZXIsIHsgUGFyYW1ldGVyLCBQaGV0aW9EYXRhSGFuZGxlck9wdGlvbnMgfSBmcm9tICcuL1BoZXRpb0RhdGFIYW5kbGVyLmpzJztcclxuaW1wb3J0IEludGVudGlvbmFsQW55IGZyb20gJy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9JbnRlbnRpb25hbEFueS5qcyc7XHJcbmltcG9ydCBFbWl0dGVyIGZyb20gJy4uLy4uL2F4b24vanMvRW1pdHRlci5qcyc7XHJcbmltcG9ydCBQaGV0aW9PYmplY3QgZnJvbSAnLi9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgU3RyaWN0T21pdCBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvU3RyaWN0T21pdC5qcyc7XHJcbmltcG9ydCBBcnJheUlPIGZyb20gJy4vdHlwZXMvQXJyYXlJTy5qcyc7XHJcbmltcG9ydCBOdWxsYWJsZUlPIGZyb20gJy4vdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCBTdHJpbmdJTyBmcm9tICcuL3R5cGVzL1N0cmluZ0lPLmpzJztcclxuaW1wb3J0IElPVHlwZUNhY2hlIGZyb20gJy4vSU9UeXBlQ2FjaGUuanMnO1xyXG5cclxuXHJcbmNvbnN0IEVNUFRZX0FSUkFZOiBQYXJhbWV0ZXJbXSA9IFtdO1xyXG5cclxuLy8gQnkgZGVmYXVsdCwgUGhldGlvQWN0aW9ucyBhcmUgbm90IHN0YXRlZnVsXHJcbmNvbnN0IFBIRVRfSU9fU1RBVEVfREVGQVVMVCA9IGZhbHNlO1xyXG5cclxuLy8gdW5kZWZpbmVkIGFuZCBuZXZlciBhcmUgbm90IGFsbG93ZWQgYXMgcGFyYW1ldGVycyB0byBQaGV0aW9BY3Rpb25cclxudHlwZSBBY3Rpb25QYXJhbWV0ZXIgPSBFeGNsdWRlPEludGVudGlvbmFsQW55LCB1bmRlZmluZWQgfCBuZXZlcj47XHJcblxyXG5leHBvcnQgdHlwZSBBY3Rpb25PcHRpb25zID0gU3RyaWN0T21pdDxQaGV0aW9EYXRhSGFuZGxlck9wdGlvbnMsICdwaGV0aW9PdXRlclR5cGUnPjtcclxuXHJcbmNsYXNzIFBoZXRpb0FjdGlvbjxUIGV4dGVuZHMgQWN0aW9uUGFyYW1ldGVyW10gPSBbXT4gZXh0ZW5kcyBQaGV0aW9EYXRhSGFuZGxlcjxUPiB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgYWN0aW9uOiAoIC4uLmFyZ3M6IFQgKSA9PiB2b2lkO1xyXG5cclxuICAvLyBLZWVwIHRyYWNrIG9mIGl0IHRoaXMgaW5zdGFuY2UgaXMgY3VycmVudGx5IGV4ZWN1dGluZyBpdHMgYWN0aW9uLCBzZWUgZXhlY3V0ZSgpIGZvciBpbXBsZW1lbnRhdGlvbi4gVGhpcyBuZWVkcyB0b1xyXG4gIC8vIGJlIGEgc3RhY2sgYmVjYXVzZSByZWVudHJhbnQgUGhldGlvQWN0aW9uIGV4ZWN1dGUgY2FsbHMgYXJlIHN1cHBvcnRlZC5cclxuICBwcml2YXRlIGlzRXhlY3V0aW5nQ291bnQ6IG51bWJlcjtcclxuXHJcbiAgLy8gRGlzcG9zYWwgY2FuIHBvdGVudGlhbGx5IG9jY3VyIGZyb20gdGhlIGFjdGlvbiB0aGF0IGlzIGJlaW5nIGV4ZWN1dGVkLiBJZiB0aGlzIGlzIHRoZSBjYXNlLCB3ZSBzdGlsbCB3YW50IHRvIGVtaXRcclxuICAvLyB0aGUgZXhlY3V0ZWRFbWl0dGVyIHVwb24gY29tcGxldGlvbiBvZiB0aGUgYWN0aW9uLCBzbyBkZWZlciBkaXNwb3NhbCBvZiB0aGUgZXhlY3V0ZWRFbWl0dGVyIChhbmRcclxuICAvLyBkaXNwb3NlUGhldGlvQWN0aW9uIGluIGdlbmVyYWwpLCB1bnRpbCB0aGUgZXhlY3V0ZSgpIGZ1bmN0aW9uIGlzIGNvbXBsZXRlLiBUaGlzIGRvZXNuJ3QgbmVlZCB0byBiZSBhIHN0YWNrIGJlY2F1c2VcclxuICAvLyB3ZSBkbyBub3QgYWxsb3cgcmVlbnRyYW50IFBoZXRpb0FjdGlvbnMgKGd1YXJkZWQgd2l0aCBhbiBhc3NlcnRpb24gaW4gZXhlY3V0ZSgpKS5cclxuICBwcml2YXRlIGRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uOiBib29sZWFuO1xyXG5cclxuICAvLyBDYWxsZWQgdXBvbiBkaXNwb3NhbCBvZiBQaGV0aW9BY3Rpb24sIGJ1dCBpZiBkaXNwb3NlKCkgaXMgY2FsbGVkIHdoaWxlIHRoZSBhY3Rpb24gaXMgZXhlY3V0aW5nLCBkZWZlciBjYWxsaW5nIHRoaXNcclxuICAvLyBmdW5jdGlvbiB1bnRpbCB0aGUgZXhlY3V0ZSgpIGZ1bmN0aW9uIGlzIGNvbXBsZXRlLlxyXG4gIHByaXZhdGUgZGlzcG9zZVBoZXRpb0FjdGlvbjogKCkgPT4gdm9pZDtcclxuXHJcbiAgLy8gVG8gbGlzdGVuIHRvIHdoZW4gdGhlIGFjdGlvbiBoYXMgY29tcGxldGVkLlxyXG4gIHB1YmxpYyByZWFkb25seSBleGVjdXRlZEVtaXR0ZXI6IEVtaXR0ZXI8VD47XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgUGhldGlvQWN0aW9uSU8gPSAoIHBhcmFtZXRlclR5cGVzOiBJT1R5cGVbXSApOiBJT1R5cGUgPT4ge1xyXG4gICAgY29uc3Qga2V5ID0gcGFyYW1ldGVyVHlwZXMubWFwKCBnZXRUeXBlTmFtZSApLmpvaW4oICcsJyApO1xyXG4gICAgaWYgKCAhY2FjaGUuaGFzKCBrZXkgKSApIHtcclxuICAgICAgY2FjaGUuc2V0KCBrZXksIG5ldyBJT1R5cGUoIGBQaGV0aW9BY3Rpb25JTzwke3BhcmFtZXRlclR5cGVzLm1hcCggZ2V0VHlwZU5hbWUgKS5qb2luKCAnLCAnICl9PmAsIHtcclxuICAgICAgICB2YWx1ZVR5cGU6IFBoZXRpb0FjdGlvbixcclxuICAgICAgICBkb2N1bWVudGF0aW9uOiAnRXhlY3V0ZXMgd2hlbiBhbiBldmVudCBvY2N1cnMnLFxyXG4gICAgICAgIGV2ZW50czogWyAnZXhlY3V0ZWQnIF0sXHJcbiAgICAgICAgcGFyYW1ldGVyVHlwZXM6IHBhcmFtZXRlclR5cGVzLFxyXG4gICAgICAgIG1ldGFkYXRhRGVmYXVsdHM6IHtcclxuICAgICAgICAgIHBoZXRpb1N0YXRlOiBQSEVUX0lPX1NUQVRFX0RFRkFVTFRcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1ldGhvZHM6IHtcclxuICAgICAgICAgIGV4ZWN1dGU6IHtcclxuICAgICAgICAgICAgcmV0dXJuVHlwZTogVm9pZElPLFxyXG4gICAgICAgICAgICBwYXJhbWV0ZXJUeXBlczogcGFyYW1ldGVyVHlwZXMsXHJcbiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBmdW5jdGlvbiggdGhpczogUGhldGlvQWN0aW9uPHVua25vd25bXT4sIC4uLnZhbHVlczogdW5rbm93bltdICkge1xyXG4gICAgICAgICAgICAgIHRoaXMuZXhlY3V0ZSggLi4udmFsdWVzICk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGRvY3VtZW50YXRpb246ICdFeGVjdXRlcyB0aGUgZnVuY3Rpb24gdGhlIFBoZXRpb0FjdGlvbiBpcyB3cmFwcGluZy4nLFxyXG4gICAgICAgICAgICBpbnZvY2FibGVGb3JSZWFkT25seUVsZW1lbnRzOiBmYWxzZVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGdldFZhbGlkYXRpb25FcnJvcnM6IHtcclxuICAgICAgICAgICAgcmV0dXJuVHlwZTogQXJyYXlJTyggTnVsbGFibGVJTyggU3RyaW5nSU8gKSApLFxyXG4gICAgICAgICAgICBwYXJhbWV0ZXJUeXBlczogcGFyYW1ldGVyVHlwZXMsXHJcbiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBmdW5jdGlvbiggdGhpczogRW1pdHRlcjx1bmtub3duW10+LCAuLi52YWx1ZXM6IHVua25vd25bXSApIHtcclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWxpZGF0aW9uRXJyb3JzKCAuLi52YWx1ZXMgKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZG9jdW1lbnRhdGlvbjogJ0NoZWNrcyB0byBzZWUgaWYgdGhlIHByb3Bvc2VkIHZhbHVlcyBhcmUgdmFsaWQuIFJldHVybnMgYW4gYXJyYXkgb2YgbGVuZ3RoIE4gd2hlcmUgZWFjaCBlbGVtZW50IGlzIGFuIGVycm9yIChzdHJpbmcpIG9yIG51bGwgaWYgdGhlIHZhbHVlIGlzIHZhbGlkLidcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gKSApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGNhY2hlLmdldCgga2V5ICkhO1xyXG4gIH07XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBhY3Rpb24gLSB0aGUgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgd2hlbiB0aGlzIFBoZXRpb0FjdGlvbiBvY2N1cnNcclxuICAgKiBAcGFyYW0gcHJvdmlkZWRPcHRpb25zXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBhY3Rpb246ICggLi4uYXJnczogVCApID0+IHZvaWQsIHByb3ZpZGVkT3B0aW9ucz86IEFjdGlvbk9wdGlvbnMgKSB7XHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEFjdGlvbk9wdGlvbnMsIEVtcHR5U2VsZk9wdGlvbnMsIFBoZXRpb0RhdGFIYW5kbGVyT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gV2UgbmVlZCB0byBkZWZpbmUgdGhpcyBoZXJlIGluIGFkZGl0aW9uIHRvIFBoZXRpb0RhdGFIYW5kbGVyIHRvIHBhc3MgdG8gZXhlY3V0ZWRFbWl0dGVyXHJcbiAgICAgIHBhcmFtZXRlcnM6IEVNUFRZX0FSUkFZLFxyXG5cclxuICAgICAgLy8gUGhldGlvRGF0YUhhbmRsZXJcclxuICAgICAgcGhldGlvT3V0ZXJUeXBlOiBQaGV0aW9BY3Rpb24uUGhldGlvQWN0aW9uSU8sXHJcblxyXG4gICAgICAvLyBQaGV0aW9PYmplY3RcclxuICAgICAgcGhldGlvU3RhdGU6IFBIRVRfSU9fU1RBVEVfREVGQVVMVCxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IFBoZXRpb09iamVjdC5ERUZBVUxUX09QVElPTlMucGhldGlvUmVhZE9ubHksXHJcbiAgICAgIHBoZXRpb0hpZ2hGcmVxdWVuY3k6IFBoZXRpb09iamVjdC5ERUZBVUxUX09QVElPTlMucGhldGlvSGlnaEZyZXF1ZW5jeSxcclxuICAgICAgcGhldGlvRXZlbnRUeXBlOiBQaGV0aW9PYmplY3QuREVGQVVMVF9PUFRJT05TLnBoZXRpb0V2ZW50VHlwZSxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ0EgY2xhc3MgdGhhdCB3cmFwcyBhIGZ1bmN0aW9uLCBhZGRpbmcgQVBJIHRvIGV4ZWN1dGUgdGhhdCBmdW5jdGlvbiBhbmQgZGF0YSBzdHJlYW0gY2FwdHVyZS4nXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuYWN0aW9uID0gYWN0aW9uO1xyXG5cclxuICAgIHRoaXMuaXNFeGVjdXRpbmdDb3VudCA9IDA7XHJcbiAgICB0aGlzLmRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uID0gZmFsc2U7XHJcblxyXG4gICAgdGhpcy5leGVjdXRlZEVtaXR0ZXIgPSBuZXcgRW1pdHRlcjxUPigge1xyXG4gICAgICBwYXJhbWV0ZXJzOiBvcHRpb25zLnBhcmFtZXRlcnMsXHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0/LmNyZWF0ZVRhbmRlbSggJ2V4ZWN1dGVkRW1pdHRlcicgKSxcclxuICAgICAgaGFzTGlzdGVuZXJPcmRlckRlcGVuZGVuY2llczogb3B0aW9ucy5oYXNMaXN0ZW5lck9yZGVyRGVwZW5kZW5jaWVzLFxyXG4gICAgICBwaGV0aW9TdGF0ZTogb3B0aW9ucy5waGV0aW9TdGF0ZSxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IG9wdGlvbnMucGhldGlvUmVhZE9ubHksXHJcbiAgICAgIHBoZXRpb0hpZ2hGcmVxdWVuY3k6IG9wdGlvbnMucGhldGlvSGlnaEZyZXF1ZW5jeSxcclxuICAgICAgcGhldGlvRXZlbnRUeXBlOiBvcHRpb25zLnBoZXRpb0V2ZW50VHlwZSxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ0VtaXR0ZXIgdGhhdCBlbWl0cyB3aGVuIHRoaXMgYWN0aW9ucyB3b3JrIGlzIGNvbXBsZXRlJ1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuZGlzcG9zZVBoZXRpb0FjdGlvbiA9ICgpID0+IHtcclxuICAgICAgdGhpcy5leGVjdXRlZEVtaXR0ZXIuZGlzcG9zZSgpO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEludm9rZXMgdGhlIGFjdGlvbi5cclxuICAgKiBAcGFyYW1zIC0gZXhwZWN0ZWQgcGFyYW1ldGVycyBhcmUgYmFzZWQgb24gb3B0aW9ucy5wYXJhbWV0ZXJzLCBzZWUgY29uc3RydWN0b3JcclxuICAgKi9cclxuICBwdWJsaWMgZXhlY3V0ZSggLi4uYXJnczogVCApOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICF0aGlzLmlzRGlzcG9zZWQsICdzaG91bGQgbm90IGJlIGNhbGxlZCBpZiBkaXNwb3NlZCcgKTtcclxuXHJcbiAgICAvLyBXZSBkZWxheSB0aGUgZGlzcG9zYWwgb2YgY29tcG9zZWQgZW50aXRpZXMgdG8gaGFuZGxlIHJlZW50cmFudCBjYXNlcyBvZiBkaXNwb3Npbmcgb3Vyc2VsZi5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICF0aGlzLmV4ZWN1dGVkRW1pdHRlci5pc0Rpc3Bvc2VkLCAnc2VsZiBzaG91bGQgbm90IGJlIGRpc3Bvc2VkJyApO1xyXG5cclxuICAgIHRoaXMuaXNFeGVjdXRpbmdDb3VudCsrO1xyXG5cclxuICAgIGFzc2VydCAmJiBzdXBlci52YWxpZGF0ZUFyZ3VtZW50cyggLi4uYXJncyApO1xyXG5cclxuICAgIC8vIEFsdGhvdWdoIHRoaXMgaXMgbm90IHRoZSBpZGlvbWF0aWMgcGF0dGVybiAoc2luY2UgaXQgaXMgZ3VhcmRlZCBpbiB0aGUgcGhldGlvU3RhcnRFdmVudCksIHRoaXMgZnVuY3Rpb24gaXNcclxuICAgIC8vIGNhbGxlZCBzbyBtYW55IHRpbWVzIHRoYXQgaXQgaXMgd29ydGggdGhlIG9wdGltaXphdGlvbiBmb3IgUGhFVCBicmFuZC5cclxuICAgIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgJiYgdGhpcy5pc1BoZXRpb0luc3RydW1lbnRlZCgpICYmIHRoaXMucGhldGlvU3RhcnRFdmVudCggJ2V4ZWN1dGVkJywge1xyXG4gICAgICBkYXRhOiB0aGlzLmdldFBoZXRpb0RhdGEoIC4uLmFyZ3MgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuYWN0aW9uLmFwcGx5KCBudWxsLCBhcmdzICk7XHJcbiAgICB0aGlzLmV4ZWN1dGVkRW1pdHRlci5lbWl0KCAuLi5hcmdzICk7XHJcblxyXG4gICAgVGFuZGVtLlBIRVRfSU9fRU5BQkxFRCAmJiB0aGlzLmlzUGhldGlvSW5zdHJ1bWVudGVkKCkgJiYgdGhpcy5waGV0aW9FbmRFdmVudCgpO1xyXG5cclxuICAgIHRoaXMuaXNFeGVjdXRpbmdDb3VudC0tO1xyXG5cclxuICAgIGlmICggdGhpcy5kaXNwb3NlT25FeGVjdXRlQ29tcGxldGlvbiAmJiB0aGlzLmlzRXhlY3V0aW5nQ291bnQgPT09IDAgKSB7XHJcbiAgICAgIHRoaXMuZGlzcG9zZVBoZXRpb0FjdGlvbigpO1xyXG4gICAgICB0aGlzLmRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBOb3RlOiBCZSBjYXJlZnVsIGFib3V0IGFkZGluZyBkaXNwb3NhbCBsb2dpYyBkaXJlY3RseSB0byB0aGlzIGZ1bmN0aW9uLCBpdCBpcyBsaWtlbHkgcHJlZmVycmVkIHRvIGFkZCBpdCB0b1xyXG4gICAqIGRpc3Bvc2VQaGV0aW9BY3Rpb24gaW5zdGVhZCwgc2VlIGRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uIGZvciBkZXRhaWxzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLmlzRXhlY3V0aW5nQ291bnQgPiAwICkge1xyXG5cclxuICAgICAgLy8gRGVmZXIgZGlzcG9zaW5nIGNvbXBvbmVudHMgdW50aWwgZXhlY3V0aW5nIGlzIGNvbXBsZXRlZCwgc2VlIGRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uLlxyXG4gICAgICB0aGlzLmRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmRpc3Bvc2VQaGV0aW9BY3Rpb24oKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBBbHdheXMgZGlzcG9zZSB0aGUgb2JqZWN0IGl0c2VsZiwgb3IgUGhldGlvT2JqZWN0IHdpbGwgYXNzZXJ0IG91dC5cclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IGdldFR5cGVOYW1lID0gKCBpb1R5cGU6IElPVHlwZSApID0+IGlvVHlwZS50eXBlTmFtZTtcclxuXHJcbi8vIGNhY2hlIGVhY2ggcGFyYW1ldGVyaXplZCBJT1R5cGUgc28gdGhhdCBpdCBpcyBvbmx5IGNyZWF0ZWQgb25jZS5cclxuY29uc3QgY2FjaGUgPSBuZXcgSU9UeXBlQ2FjaGU8c3RyaW5nPigpO1xyXG5cclxudGFuZGVtTmFtZXNwYWNlLnJlZ2lzdGVyKCAnUGhldGlvQWN0aW9uJywgUGhldGlvQWN0aW9uICk7XHJcbmV4cG9ydCBkZWZhdWx0IFBoZXRpb0Fj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QUFNLElBQUlBLE1BQU0sQ0FBRSxDQUFDLElBQUksQ0FBQ1AsZUFBZSxDQUFDUSxVQUFVLEVBQUUsNkJBQThCLENBQUM7SUFFbkYsSUFBSSxDQUFDVixnQkFBZ0IsRUFBRTtJQUV2QlMsTUFBTSxJQUFJLEtBQUssQ0FBQ0UsaUJBQWlCLENBQUUsR0FBR0gsSUFBSyxDQUFDOztJQUU1QztJQUNBO0lBQ0FyRCxNQUFNLENBQUN5RCxlQUFlLElBQUksSUFBSSxDQUFDQyxvQkFBb0IsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDQyxnQkFBZ0IsQ0FBRSxVQUFVLEVBQUU7TUFDMUZDLElBQUksRUFBRSxJQUFJLENBQUNDLGFBQWEsQ0FBRSxHQUFHUixJQUFLO0lBQ3BDLENBQUUsQ0FBQztJQUVILElBQUksQ0FBQ2xCLE1BQU0sQ0FBQzJCLEtBQUssQ0FBRSxJQUFJLEVBQUVULElBQUssQ0FBQztJQUMvQixJQUFJLENBQUNOLGVBQWUsQ0FBQ2dCLElBQUksQ0FBRSxHQUFHVixJQUFLLENBQUM7SUFFcENyRCxNQUFNLENBQUN5RCxlQUFlLElBQUksSUFBSSxDQUFDQyxvQkFBb0IsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDTSxjQUFjLENBQUMsQ0FBQztJQUU5RSxJQUFJLENBQUNuQixnQkFBZ0IsRUFBRTtJQUV2QixJQUFLLElBQUksQ0FBQ0MsMEJBQTBCLElBQUksSUFBSSxDQUFDRCxnQkFBZ0IsS0FBSyxDQUFDLEVBQUc7TUFDcEUsSUFBSSxDQUFDTSxtQkFBbUIsQ0FBQyxDQUFDO01BQzFCLElBQUksQ0FBQ0wsMEJBQTBCLEdBQUcsS0FBSztJQUN6QztFQUNGOztFQUVBO0FBQ0Y7QUFDQTtBQUNBO0VBQ2tCTSxPQUFPQSxDQUFBLEVBQVM7SUFDOUIsSUFBSyxJQUFJLENBQUNQLGdCQUFnQixHQUFHLENBQUMsRUFBRztNQUUvQjtNQUNBLElBQUksQ0FBQ0MsMEJBQTBCLEdBQUcsSUFBSTtJQUN4QyxDQUFDLE1BQ0k7TUFDSCxJQUFJLENBQUNLLG1CQUFtQixDQUFDLENBQUM7SUFDNUI7O0lBRUE7SUFDQSxLQUFLLENBQUNDLE9BQU8sQ0FBQyxDQUFDO0VBQ2pCO0FBQ0Y7QUFFQSxNQUFNcEMsV0FBVyxHQUFLaUQsTUFBYyxJQUFNQSxNQUFNLENBQUNDLFFBQVE7O0FBRXpEO0FBQ0EsTUFBTWhELEtBQUssR0FBRyxJQUFJVixXQUFXLENBQVMsQ0FBQztBQUV2Q1gsZUFBZSxDQUFDc0UsUUFBUSxDQUFFLGNBQWMsRUFBRXhELFlBQWEsQ0FBQztBQUN4RCxlQUFlQSxZQUFZIiwiaWdub3JlTGlzdCI6W119