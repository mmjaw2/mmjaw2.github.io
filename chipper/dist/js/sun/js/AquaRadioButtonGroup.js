// Copyright 2013-2024, University of Colorado Boulder

/**
 * AquaRadioButtonGroup creates a group of AquaRadioButtons and manages their layout.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Chris Malley (PixelZoom, Inc.)
 */

import optionize, { combineOptions } from '../../phet-core/js/optionize.js';
import { FlowBox, KeyboardUtils, PDOMPeer, SceneryConstants } from '../../scenery/js/imports.js';
import multiSelectionSoundPlayerFactory from '../../tambo/js/multiSelectionSoundPlayerFactory.js';
import Tandem from '../../tandem/js/Tandem.js';
import AquaRadioButton from './AquaRadioButton.js';
import sun from './sun.js';
import Emitter from '../../axon/js/Emitter.js';
import { getGroupItemNodes } from './GroupItemOptions.js';
// pdom - An id for each instance of AquaRadioButtonGroup, passed to individual buttons in the group.
// Each button in a radio button group must have the same "name" attribute to be considered in a group, otherwise
// arrow keys will navigate all radio type inputs in the document.
let instanceCount = 0;

// to prefix instanceCount in case there are different kinds of "groups"
const CLASS_NAME = 'AquaRadioButtonGroup';
// additional options that are common to 'group items'

export default class AquaRadioButtonGroup extends FlowBox {
  onInputEmitter = new Emitter();
  constructor(property, items, providedOptions) {
    instanceCount++;
    const options = optionize()({
      // AquaRadioButtonGroupOptions
      touchAreaXDilation: 0,
      touchAreaYDilation: 0,
      mouseAreaXDilation: 0,
      mouseAreaYDilation: 0,
      // FlowBoxOptions
      orientation: 'vertical',
      // Aqua radio buttons are typically vertical, rarely horizontal
      spacing: 3,
      // space between each button, perpendicular to options.orientation
      stretch: true,
      disabledOpacity: SceneryConstants.DISABLED_OPACITY,
      // phet-io
      tandem: Tandem.REQUIRED,
      tandemNameSuffix: 'RadioButtonGroup',
      visiblePropertyOptions: {
        phetioFeatured: true
      },
      phetioEnabledPropertyInstrumented: true,
      // opt into default PhET-iO instrumented enabledProperty
      phetioFeatured: true,
      // pdom
      tagName: 'ul',
      labelTagName: 'h3',
      ariaRole: 'radiogroup',
      groupFocusHighlight: true
    }, providedOptions);
    const nodes = getGroupItemNodes(items, options.tandem);

    // Default to a left alignment for vertical layout
    if (options.orientation === 'vertical') {
      options.align = options.align || 'left';
    }

    // Create a radio button for each item
    const radioButtons = items.map((item, index) => {
      // @ts-expect-error - runtime check to prevent prior pattern, see https://github.com/phetsims/sun/issues/794
      assert && assert(!item.tandem, 'Cannot specify tandem any more');
      const node = nodes[index];
      assert && assert(!node.hasPDOMContent, 'Accessibility is provided by AquaRadioButton and AquaRadioButtonGroupItem.labelContent. ' + 'Additional PDOM content in the provided Node could break accessibility.');
      return new AquaRadioButton(property, item.value, node, combineOptions({
        a11yNameAttribute: CLASS_NAME + instanceCount,
        labelContent: item.labelContent || null,
        soundPlayer: multiSelectionSoundPlayerFactory.getSelectionSoundPlayer(index),
        tandem: item.tandemName ? options.tandem.createTandem(item.tandemName) : options.tandem === Tandem.OPT_OUT ? Tandem.OPT_OUT : Tandem.REQUIRED,
        // NOTE: This does NOT support dynamic orientation changes. If you need that, change RectangularButton to support
        // dynamic options
        touchAreaXDilation: options.orientation === 'horizontal' ? options.spacing / 2 : options.touchAreaXDilation,
        touchAreaYDilation: options.orientation === 'vertical' ? options.spacing / 2 : options.touchAreaYDilation,
        mouseAreaXDilation: options.orientation === 'horizontal' ? options.spacing / 2 : options.mouseAreaXDilation,
        mouseAreaYDilation: options.orientation === 'vertical' ? options.spacing / 2 : options.mouseAreaYDilation
      }, options.radioButtonOptions, item.options));
    });
    options.children = radioButtons;
    super(options);

    // pdom - this node's primary sibling is aria-labelledby its own label so the label content is read whenever
    // a member of the group receives focus
    this.addAriaLabelledbyAssociation({
      thisElementName: PDOMPeer.PRIMARY_SIBLING,
      otherNode: this,
      otherElementName: PDOMPeer.LABEL_SIBLING
    });

    // zoom - signify that key input is reserved and we should not pan when user presses arrow keys
    // See https://github.com/phetsims/scenery/issues/974
    const intentListener = {
      keydown: event => {
        if (KeyboardUtils.isArrowKey(event.domEvent)) {
          event.pointer.reserveForKeyboardDrag();
        }
      }
    };
    this.addInputListener(intentListener);
    const boundOnRadioButtonInput = this.onRadioButtonInput.bind(this);
    for (let i = 0; i < radioButtons.length; i++) {
      const radioButton = radioButtons[i];
      radioButton.onInputEmitter.addListener(boundOnRadioButtonInput);
    }

    // Add linked element after the radio button is instrumented
    this.addLinkedElement(property, {
      tandemName: 'property'
    });
    this.disposeAquaRadioButtonGroup = () => {
      this.removeInputListener(intentListener);
      radioButtons.forEach(radioButton => radioButton.dispose());
      this.onInputEmitter.dispose();
      nodes.forEach(node => node.dispose());
    };
    this.radioButtons = radioButtons;
  }
  onRadioButtonInput() {
    this.onInputEmitter.emit();
  }
  dispose() {
    this.disposeAquaRadioButtonGroup();
    super.dispose();
  }

  /**
   * Gets the radio button that corresponds to the specified value.
   */
  getButton(value) {
    const button = _.find(this.radioButtons, radioButton => radioButton.value === value);
    assert && assert(button, `no radio button found for value ${value}`);
    return button;
  }
}
sun.register('AquaRadioButtonGroup', AquaRadioButtonGroup);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvcHRpb25pemUiLCJjb21iaW5lT3B0aW9ucyIsIkZsb3dCb3giLCJLZXlib2FyZFV0aWxzIiwiUERPTVBlZXIiLCJTY2VuZXJ5Q29uc3RhbnRzIiwibXVsdGlTZWxlY3Rpb25Tb3VuZFBsYXllckZhY3RvcnkiLCJUYW5kZW0iLCJBcXVhUmFkaW9CdXR0b24iLCJzdW4iLCJFbWl0dGVyIiwiZ2V0R3JvdXBJdGVtTm9kZXMiLCJpbnN0YW5jZUNvdW50IiwiQ0xBU1NfTkFNRSIsIkFxdWFSYWRpb0J1dHRvbkdyb3VwIiwib25JbnB1dEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsInByb3BlcnR5IiwiaXRlbXMiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwidG91Y2hBcmVhWERpbGF0aW9uIiwidG91Y2hBcmVhWURpbGF0aW9uIiwibW91c2VBcmVhWERpbGF0aW9uIiwibW91c2VBcmVhWURpbGF0aW9uIiwib3JpZW50YXRpb24iLCJzcGFjaW5nIiwic3RyZXRjaCIsImRpc2FibGVkT3BhY2l0eSIsIkRJU0FCTEVEX09QQUNJVFkiLCJ0YW5kZW0iLCJSRVFVSVJFRCIsInRhbmRlbU5hbWVTdWZmaXgiLCJ2aXNpYmxlUHJvcGVydHlPcHRpb25zIiwicGhldGlvRmVhdHVyZWQiLCJwaGV0aW9FbmFibGVkUHJvcGVydHlJbnN0cnVtZW50ZWQiLCJ0YWdOYW1lIiwibGFiZWxUYWdOYW1lIiwiYXJpYVJvbGUiLCJncm91cEZvY3VzSGlnaGxpZ2h0Iiwibm9kZXMiLCJhbGlnbiIsInJhZGlvQnV0dG9ucyIsIm1hcCIsIml0ZW0iLCJpbmRleCIsImFzc2VydCIsIm5vZGUiLCJoYXNQRE9NQ29udGVudCIsInZhbHVlIiwiYTExeU5hbWVBdHRyaWJ1dGUiLCJsYWJlbENvbnRlbnQiLCJzb3VuZFBsYXllciIsImdldFNlbGVjdGlvblNvdW5kUGxheWVyIiwidGFuZGVtTmFtZSIsImNyZWF0ZVRhbmRlbSIsIk9QVF9PVVQiLCJyYWRpb0J1dHRvbk9wdGlvbnMiLCJjaGlsZHJlbiIsImFkZEFyaWFMYWJlbGxlZGJ5QXNzb2NpYXRpb24iLCJ0aGlzRWxlbWVudE5hbWUiLCJQUklNQVJZX1NJQkxJTkciLCJvdGhlck5vZGUiLCJvdGhlckVsZW1lbnROYW1lIiwiTEFCRUxfU0lCTElORyIsImludGVudExpc3RlbmVyIiwia2V5ZG93biIsImV2ZW50IiwiaXNBcnJvd0tleSIsImRvbUV2ZW50IiwicG9pbnRlciIsInJlc2VydmVGb3JLZXlib2FyZERyYWciLCJhZGRJbnB1dExpc3RlbmVyIiwiYm91bmRPblJhZGlvQnV0dG9uSW5wdXQiLCJvblJhZGlvQnV0dG9uSW5wdXQiLCJiaW5kIiwiaSIsImxlbmd0aCIsInJhZGlvQnV0dG9uIiwiYWRkTGlzdGVuZXIiLCJhZGRMaW5rZWRFbGVtZW50IiwiZGlzcG9zZUFxdWFSYWRpb0J1dHRvbkdyb3VwIiwicmVtb3ZlSW5wdXRMaXN0ZW5lciIsImZvckVhY2giLCJkaXNwb3NlIiwiZW1pdCIsImdldEJ1dHRvbiIsImJ1dHRvbiIsIl8iLCJmaW5kIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJBcXVhUmFkaW9CdXR0b25Hcm91cC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxMy0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBcXVhUmFkaW9CdXR0b25Hcm91cCBjcmVhdGVzIGEgZ3JvdXAgb2YgQXF1YVJhZGlvQnV0dG9ucyBhbmQgbWFuYWdlcyB0aGVpciBsYXlvdXQuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplLCB7IGNvbWJpbmVPcHRpb25zIH0gZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCB7IEZsb3dCb3gsIEZsb3dCb3hPcHRpb25zLCBLZXlib2FyZFV0aWxzLCBQRE9NUGVlciwgU2NlbmVyeUNvbnN0YW50cywgU2NlbmVyeUV2ZW50IH0gZnJvbSAnLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IG11bHRpU2VsZWN0aW9uU291bmRQbGF5ZXJGYWN0b3J5IGZyb20gJy4uLy4uL3RhbWJvL2pzL211bHRpU2VsZWN0aW9uU291bmRQbGF5ZXJGYWN0b3J5LmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IEFxdWFSYWRpb0J1dHRvbiwgeyBBcXVhUmFkaW9CdXR0b25PcHRpb25zIH0gZnJvbSAnLi9BcXVhUmFkaW9CdXR0b24uanMnO1xyXG5pbXBvcnQgc3VuIGZyb20gJy4vc3VuLmpzJztcclxuaW1wb3J0IEVtaXR0ZXIgZnJvbSAnLi4vLi4vYXhvbi9qcy9FbWl0dGVyLmpzJztcclxuaW1wb3J0IFRFbWl0dGVyIGZyb20gJy4uLy4uL2F4b24vanMvVEVtaXR0ZXIuanMnO1xyXG5pbXBvcnQgR3JvdXBJdGVtT3B0aW9ucywgeyBnZXRHcm91cEl0ZW1Ob2RlcyB9IGZyb20gJy4vR3JvdXBJdGVtT3B0aW9ucy5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IFBoZXRpb1Byb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvUGhldGlvUHJvcGVydHkuanMnO1xyXG5cclxuLy8gcGRvbSAtIEFuIGlkIGZvciBlYWNoIGluc3RhbmNlIG9mIEFxdWFSYWRpb0J1dHRvbkdyb3VwLCBwYXNzZWQgdG8gaW5kaXZpZHVhbCBidXR0b25zIGluIHRoZSBncm91cC5cclxuLy8gRWFjaCBidXR0b24gaW4gYSByYWRpbyBidXR0b24gZ3JvdXAgbXVzdCBoYXZlIHRoZSBzYW1lIFwibmFtZVwiIGF0dHJpYnV0ZSB0byBiZSBjb25zaWRlcmVkIGluIGEgZ3JvdXAsIG90aGVyd2lzZVxyXG4vLyBhcnJvdyBrZXlzIHdpbGwgbmF2aWdhdGUgYWxsIHJhZGlvIHR5cGUgaW5wdXRzIGluIHRoZSBkb2N1bWVudC5cclxubGV0IGluc3RhbmNlQ291bnQgPSAwO1xyXG5cclxuLy8gdG8gcHJlZml4IGluc3RhbmNlQ291bnQgaW4gY2FzZSB0aGVyZSBhcmUgZGlmZmVyZW50IGtpbmRzIG9mIFwiZ3JvdXBzXCJcclxuY29uc3QgQ0xBU1NfTkFNRSA9ICdBcXVhUmFkaW9CdXR0b25Hcm91cCc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBvcHRpb25zIHByb3BhZ2F0ZWQgdG8gQXF1YVJhZGlvQnV0dG9uIGluc3RhbmNlc1xyXG4gIHJhZGlvQnV0dG9uT3B0aW9ucz86IFN0cmljdE9taXQ8QXF1YVJhZGlvQnV0dG9uT3B0aW9ucywgJ2ExMXlOYW1lQXR0cmlidXRlJyB8ICdsYWJlbENvbnRlbnQnIHwgJ3NvdW5kUGxheWVyJyB8ICd0YW5kZW0nPjtcclxuXHJcbiAgLy8gRGlsYXRpb24gb2YgcG9pbnRlciBhcmVhcyBmb3IgZWFjaCByYWRpbyBidXR0b24uXHJcbiAgLy8gWCBkaWxhdGlvbiBpcyBpZ25vcmVkIGZvciBvcmllbnRhdGlvbiA9PT0gJ2hvcml6b250YWwnLlxyXG4gIC8vIFkgZGlsYXRpb24gaXMgaWdub3JlZCBmb3Igb3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcuXHJcbiAgdG91Y2hBcmVhWERpbGF0aW9uPzogbnVtYmVyO1xyXG4gIHRvdWNoQXJlYVlEaWxhdGlvbj86IG51bWJlcjtcclxuICBtb3VzZUFyZWFYRGlsYXRpb24/OiBudW1iZXI7XHJcbiAgbW91c2VBcmVhWURpbGF0aW9uPzogbnVtYmVyO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgQXF1YVJhZGlvQnV0dG9uR3JvdXBPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBTdHJpY3RPbWl0PEZsb3dCb3hPcHRpb25zLCAnY2hpbGRyZW4nPjtcclxuXHJcbmV4cG9ydCB0eXBlIEFxdWFSYWRpb0J1dHRvbkdyb3VwSXRlbTxUPiA9IHtcclxuICB2YWx1ZTogVDsgLy8gdmFsdWUgYXNzb2NpYXRlZCB3aXRoIHRoZSBidXR0b25cclxuICBsYWJlbENvbnRlbnQ/OiBzdHJpbmcgfCBUUmVhZE9ubHlQcm9wZXJ0eTxzdHJpbmc+OyAvLyBsYWJlbCBmb3IgYTExeVxyXG4gIG9wdGlvbnM/OiBTdHJpY3RPbWl0PEFxdWFSYWRpb0J1dHRvbk9wdGlvbnMsICd0YW5kZW0nPjsgLy8gb3B0aW9ucyBwYXNzZWQgdG8gQXF1YVJhZGlvQnV0dG9uIGNvbnN0cnVjdG9yXHJcbn0gJiBHcm91cEl0ZW1PcHRpb25zOyAvLyBhZGRpdGlvbmFsIG9wdGlvbnMgdGhhdCBhcmUgY29tbW9uIHRvICdncm91cCBpdGVtcydcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFxdWFSYWRpb0J1dHRvbkdyb3VwPFQ+IGV4dGVuZHMgRmxvd0JveCB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgcmFkaW9CdXR0b25zOiBBcXVhUmFkaW9CdXR0b248VD5bXTtcclxuICBwdWJsaWMgcmVhZG9ubHkgb25JbnB1dEVtaXR0ZXI6IFRFbWl0dGVyID0gbmV3IEVtaXR0ZXIoKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VBcXVhUmFkaW9CdXR0b25Hcm91cDogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwcm9wZXJ0eTogUGhldGlvUHJvcGVydHk8VD4sIGl0ZW1zOiBBcXVhUmFkaW9CdXR0b25Hcm91cEl0ZW08VD5bXSwgcHJvdmlkZWRPcHRpb25zPzogQXF1YVJhZGlvQnV0dG9uR3JvdXBPcHRpb25zICkge1xyXG5cclxuICAgIGluc3RhbmNlQ291bnQrKztcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEFxdWFSYWRpb0J1dHRvbkdyb3VwT3B0aW9ucywgU3RyaWN0T21pdDxTZWxmT3B0aW9ucywgJ3JhZGlvQnV0dG9uT3B0aW9ucyc+LCBGbG93Qm94T3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gQXF1YVJhZGlvQnV0dG9uR3JvdXBPcHRpb25zXHJcbiAgICAgIHRvdWNoQXJlYVhEaWxhdGlvbjogMCxcclxuICAgICAgdG91Y2hBcmVhWURpbGF0aW9uOiAwLFxyXG4gICAgICBtb3VzZUFyZWFYRGlsYXRpb246IDAsXHJcbiAgICAgIG1vdXNlQXJlYVlEaWxhdGlvbjogMCxcclxuXHJcbiAgICAgIC8vIEZsb3dCb3hPcHRpb25zXHJcbiAgICAgIG9yaWVudGF0aW9uOiAndmVydGljYWwnLCAvLyBBcXVhIHJhZGlvIGJ1dHRvbnMgYXJlIHR5cGljYWxseSB2ZXJ0aWNhbCwgcmFyZWx5IGhvcml6b250YWxcclxuICAgICAgc3BhY2luZzogMywgLy8gc3BhY2UgYmV0d2VlbiBlYWNoIGJ1dHRvbiwgcGVycGVuZGljdWxhciB0byBvcHRpb25zLm9yaWVudGF0aW9uXHJcbiAgICAgIHN0cmV0Y2g6IHRydWUsXHJcbiAgICAgIGRpc2FibGVkT3BhY2l0eTogU2NlbmVyeUNvbnN0YW50cy5ESVNBQkxFRF9PUEFDSVRZLFxyXG5cclxuICAgICAgLy8gcGhldC1pb1xyXG4gICAgICB0YW5kZW06IFRhbmRlbS5SRVFVSVJFRCxcclxuICAgICAgdGFuZGVtTmFtZVN1ZmZpeDogJ1JhZGlvQnV0dG9uR3JvdXAnLFxyXG4gICAgICB2aXNpYmxlUHJvcGVydHlPcHRpb25zOiB7IHBoZXRpb0ZlYXR1cmVkOiB0cnVlIH0sXHJcbiAgICAgIHBoZXRpb0VuYWJsZWRQcm9wZXJ0eUluc3RydW1lbnRlZDogdHJ1ZSwgLy8gb3B0IGludG8gZGVmYXVsdCBQaEVULWlPIGluc3RydW1lbnRlZCBlbmFibGVkUHJvcGVydHlcclxuICAgICAgcGhldGlvRmVhdHVyZWQ6IHRydWUsXHJcblxyXG4gICAgICAvLyBwZG9tXHJcbiAgICAgIHRhZ05hbWU6ICd1bCcsXHJcbiAgICAgIGxhYmVsVGFnTmFtZTogJ2gzJyxcclxuICAgICAgYXJpYVJvbGU6ICdyYWRpb2dyb3VwJyxcclxuICAgICAgZ3JvdXBGb2N1c0hpZ2hsaWdodDogdHJ1ZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgY29uc3Qgbm9kZXMgPSBnZXRHcm91cEl0ZW1Ob2RlcyggaXRlbXMsIG9wdGlvbnMudGFuZGVtICk7XHJcblxyXG4gICAgLy8gRGVmYXVsdCB0byBhIGxlZnQgYWxpZ25tZW50IGZvciB2ZXJ0aWNhbCBsYXlvdXRcclxuICAgIGlmICggb3B0aW9ucy5vcmllbnRhdGlvbiA9PT0gJ3ZlcnRpY2FsJyApIHtcclxuICAgICAgb3B0aW9ucy5hbGlnbiA9IG9wdGlvbnMuYWxpZ24gfHwgJ2xlZnQnO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENyZWF0ZSBhIHJhZGlvIGJ1dHRvbiBmb3IgZWFjaCBpdGVtXHJcbiAgICBjb25zdCByYWRpb0J1dHRvbnMgPSBpdGVtcy5tYXAoICggaXRlbSwgaW5kZXggKSA9PiB7XHJcblxyXG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIC0gcnVudGltZSBjaGVjayB0byBwcmV2ZW50IHByaW9yIHBhdHRlcm4sIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvc3VuL2lzc3Vlcy83OTRcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggIWl0ZW0udGFuZGVtLCAnQ2Fubm90IHNwZWNpZnkgdGFuZGVtIGFueSBtb3JlJyApO1xyXG5cclxuICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzWyBpbmRleCBdO1xyXG5cclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggIW5vZGUuaGFzUERPTUNvbnRlbnQsXHJcbiAgICAgICAgJ0FjY2Vzc2liaWxpdHkgaXMgcHJvdmlkZWQgYnkgQXF1YVJhZGlvQnV0dG9uIGFuZCBBcXVhUmFkaW9CdXR0b25Hcm91cEl0ZW0ubGFiZWxDb250ZW50LiAnICtcclxuICAgICAgICAnQWRkaXRpb25hbCBQRE9NIGNvbnRlbnQgaW4gdGhlIHByb3ZpZGVkIE5vZGUgY291bGQgYnJlYWsgYWNjZXNzaWJpbGl0eS4nICk7XHJcblxyXG4gICAgICByZXR1cm4gbmV3IEFxdWFSYWRpb0J1dHRvbiggcHJvcGVydHksIGl0ZW0udmFsdWUsIG5vZGUsXHJcbiAgICAgICAgY29tYmluZU9wdGlvbnM8QXF1YVJhZGlvQnV0dG9uT3B0aW9ucz4oIHtcclxuICAgICAgICAgIGExMXlOYW1lQXR0cmlidXRlOiBDTEFTU19OQU1FICsgaW5zdGFuY2VDb3VudCxcclxuICAgICAgICAgIGxhYmVsQ29udGVudDogaXRlbS5sYWJlbENvbnRlbnQgfHwgbnVsbCxcclxuICAgICAgICAgIHNvdW5kUGxheWVyOiBtdWx0aVNlbGVjdGlvblNvdW5kUGxheWVyRmFjdG9yeS5nZXRTZWxlY3Rpb25Tb3VuZFBsYXllciggaW5kZXggKSxcclxuICAgICAgICAgIHRhbmRlbTogaXRlbS50YW5kZW1OYW1lID8gb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCBpdGVtLnRhbmRlbU5hbWUgKSA6XHJcbiAgICAgICAgICAgICAgICAgIG9wdGlvbnMudGFuZGVtID09PSBUYW5kZW0uT1BUX09VVCA/IFRhbmRlbS5PUFRfT1VUIDpcclxuICAgICAgICAgICAgICAgICAgVGFuZGVtLlJFUVVJUkVELFxyXG4gICAgICAgICAgLy8gTk9URTogVGhpcyBkb2VzIE5PVCBzdXBwb3J0IGR5bmFtaWMgb3JpZW50YXRpb24gY2hhbmdlcy4gSWYgeW91IG5lZWQgdGhhdCwgY2hhbmdlIFJlY3Rhbmd1bGFyQnV0dG9uIHRvIHN1cHBvcnRcclxuICAgICAgICAgIC8vIGR5bmFtaWMgb3B0aW9uc1xyXG4gICAgICAgICAgdG91Y2hBcmVhWERpbGF0aW9uOiBvcHRpb25zLm9yaWVudGF0aW9uID09PSAnaG9yaXpvbnRhbCcgPyBvcHRpb25zLnNwYWNpbmcgLyAyIDogb3B0aW9ucy50b3VjaEFyZWFYRGlsYXRpb24sXHJcbiAgICAgICAgICB0b3VjaEFyZWFZRGlsYXRpb246IG9wdGlvbnMub3JpZW50YXRpb24gPT09ICd2ZXJ0aWNhbCcgPyBvcHRpb25zLnNwYWNpbmcgLyAyIDogb3B0aW9ucy50b3VjaEFyZWFZRGlsYXRpb24sXHJcbiAgICAgICAgICBtb3VzZUFyZWFYRGlsYXRpb246IG9wdGlvbnMub3JpZW50YXRpb24gPT09ICdob3Jpem9udGFsJyA/IG9wdGlvbnMuc3BhY2luZyAvIDIgOiBvcHRpb25zLm1vdXNlQXJlYVhEaWxhdGlvbixcclxuICAgICAgICAgIG1vdXNlQXJlYVlEaWxhdGlvbjogb3B0aW9ucy5vcmllbnRhdGlvbiA9PT0gJ3ZlcnRpY2FsJyA/IG9wdGlvbnMuc3BhY2luZyAvIDIgOiBvcHRpb25zLm1vdXNlQXJlYVlEaWxhdGlvblxyXG4gICAgICAgIH0sIG9wdGlvbnMucmFkaW9CdXR0b25PcHRpb25zLCBpdGVtLm9wdGlvbnMgKSApO1xyXG4gICAgfSApO1xyXG4gICAgb3B0aW9ucy5jaGlsZHJlbiA9IHJhZGlvQnV0dG9ucztcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIHBkb20gLSB0aGlzIG5vZGUncyBwcmltYXJ5IHNpYmxpbmcgaXMgYXJpYS1sYWJlbGxlZGJ5IGl0cyBvd24gbGFiZWwgc28gdGhlIGxhYmVsIGNvbnRlbnQgaXMgcmVhZCB3aGVuZXZlclxyXG4gICAgLy8gYSBtZW1iZXIgb2YgdGhlIGdyb3VwIHJlY2VpdmVzIGZvY3VzXHJcbiAgICB0aGlzLmFkZEFyaWFMYWJlbGxlZGJ5QXNzb2NpYXRpb24oIHtcclxuICAgICAgdGhpc0VsZW1lbnROYW1lOiBQRE9NUGVlci5QUklNQVJZX1NJQkxJTkcsXHJcbiAgICAgIG90aGVyTm9kZTogdGhpcyxcclxuICAgICAgb3RoZXJFbGVtZW50TmFtZTogUERPTVBlZXIuTEFCRUxfU0lCTElOR1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHpvb20gLSBzaWduaWZ5IHRoYXQga2V5IGlucHV0IGlzIHJlc2VydmVkIGFuZCB3ZSBzaG91bGQgbm90IHBhbiB3aGVuIHVzZXIgcHJlc3NlcyBhcnJvdyBrZXlzXHJcbiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3NjZW5lcnkvaXNzdWVzLzk3NFxyXG4gICAgY29uc3QgaW50ZW50TGlzdGVuZXIgPSB7XHJcbiAgICAgIGtleWRvd246ICggZXZlbnQ6IFNjZW5lcnlFdmVudDxLZXlib2FyZEV2ZW50PiApID0+IHtcclxuICAgICAgICBpZiAoIEtleWJvYXJkVXRpbHMuaXNBcnJvd0tleSggZXZlbnQuZG9tRXZlbnQgKSApIHtcclxuICAgICAgICAgIGV2ZW50LnBvaW50ZXIucmVzZXJ2ZUZvcktleWJvYXJkRHJhZygpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggaW50ZW50TGlzdGVuZXIgKTtcclxuXHJcbiAgICBjb25zdCBib3VuZE9uUmFkaW9CdXR0b25JbnB1dCA9IHRoaXMub25SYWRpb0J1dHRvbklucHV0LmJpbmQoIHRoaXMgKTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHJhZGlvQnV0dG9ucy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgY29uc3QgcmFkaW9CdXR0b24gPSByYWRpb0J1dHRvbnNbIGkgXTtcclxuICAgICAgcmFkaW9CdXR0b24ub25JbnB1dEVtaXR0ZXIuYWRkTGlzdGVuZXIoIGJvdW5kT25SYWRpb0J1dHRvbklucHV0ICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWRkIGxpbmtlZCBlbGVtZW50IGFmdGVyIHRoZSByYWRpbyBidXR0b24gaXMgaW5zdHJ1bWVudGVkXHJcbiAgICB0aGlzLmFkZExpbmtlZEVsZW1lbnQoIHByb3BlcnR5LCB7XHJcbiAgICAgIHRhbmRlbU5hbWU6ICdwcm9wZXJ0eSdcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmRpc3Bvc2VBcXVhUmFkaW9CdXR0b25Hcm91cCA9ICgpID0+IHtcclxuICAgICAgdGhpcy5yZW1vdmVJbnB1dExpc3RlbmVyKCBpbnRlbnRMaXN0ZW5lciApO1xyXG4gICAgICByYWRpb0J1dHRvbnMuZm9yRWFjaCggcmFkaW9CdXR0b24gPT4gcmFkaW9CdXR0b24uZGlzcG9zZSgpICk7XHJcbiAgICAgIHRoaXMub25JbnB1dEVtaXR0ZXIuZGlzcG9zZSgpO1xyXG4gICAgICBub2Rlcy5mb3JFYWNoKCBub2RlID0+IG5vZGUuZGlzcG9zZSgpICk7XHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMucmFkaW9CdXR0b25zID0gcmFkaW9CdXR0b25zO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvblJhZGlvQnV0dG9uSW5wdXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLm9uSW5wdXRFbWl0dGVyLmVtaXQoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlQXF1YVJhZGlvQnV0dG9uR3JvdXAoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldHMgdGhlIHJhZGlvIGJ1dHRvbiB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSBzcGVjaWZpZWQgdmFsdWUuXHJcbiAgICovXHJcbiAgcHVibGljIGdldEJ1dHRvbiggdmFsdWU6IFQgKTogQXF1YVJhZGlvQnV0dG9uPFQ+IHtcclxuICAgIGNvbnN0IGJ1dHRvbiA9IF8uZmluZCggdGhpcy5yYWRpb0J1dHRvbnMsICggcmFkaW9CdXR0b246IEFxdWFSYWRpb0J1dHRvbjxUPiApID0+IHJhZGlvQnV0dG9uLnZhbHVlID09PSB2YWx1ZSApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggYnV0dG9uLCBgbm8gcmFkaW8gYnV0dG9uIGZvdW5kIGZvciB2YWx1ZSAke3ZhbHVlfWAgKTtcclxuICAgIHJldHVybiBidXR0b24hO1xyXG4gIH1cclxufVxyXG5cclxuc3VuLnJlZ2lzdGVyKCAnQXF1YVJhZGlvQnV0dG9uR3JvdXAnLCBBcXVhUmFkaW9C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