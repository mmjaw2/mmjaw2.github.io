// Copyright 2017-2023, University of Colorado Boulder

/**
 * MenuItem is an item in the PhetMenu.
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import PhetFont from '../../scenery-phet/js/PhetFont.js';
import { allowLinksProperty, FireListener, ManualConstraint, Node, Path, Rectangle, Text, Voicing, WidthSizable } from '../../scenery/js/imports.js';
import checkSolidShape from '../../sherpa/js/fontawesome-5/checkSolidShape.js';
import EventType from '../../tandem/js/EventType.js';
import sun from './sun.js';
import optionize from '../../phet-core/js/optionize.js';
// the check mark used for toggle-able menu items
const CHECK_MARK_NODE = new Path(checkSolidShape, {
  fill: 'rgba(0,0,0,0.7)',
  maxWidth: 15.5
});

// constants
const FONT_SIZE = 18;
const HIGHLIGHT_COLOR = '#a6d2f4';
const MAX_ITEM_WIDTH = 400;
const CHECK_PADDING = 2; // padding between the check and text
const CHECK_OFFSET = CHECK_MARK_NODE.width + CHECK_PADDING; // offset that includes the check mark's width and padding
const LEFT_X_MARGIN = 2;
const RIGHT_X_MARGIN = 5;
const Y_MARGIN = 3;
const CORNER_RADIUS = 5;
export default class MenuItem extends WidthSizable(Voicing(Node)) {
  // if this MenuItem will be shown in the menu. Some items are just created to maintain a
  // consistent PhET-iO API for all sim runtimes, see https://github.com/phetsims/phet-io/issues/1457

  // if there should be a horizontal separator between this MenuItem and the one above it

  /**
   * @param closeCallback - called when firing the menu item, most likely this should close the PhetMenu.
   * @param labelStringProperty - label for the menu item
   * @param callback - called when the menu item is selected
   * @param present - see present field
   * @param shouldBeHiddenWhenLinksAreNotAllowed
   * @param [providedOptions]
   */
  constructor(closeCallback, labelStringProperty, callback, present, shouldBeHiddenWhenLinksAreNotAllowed, providedOptions) {
    // Extend the object with defaults.
    const options = optionize()({
      // SelfOptions
      separatorBefore: false,
      checkedProperty: null,
      textFill: 'black',
      // VoicingOptions
      cursor: 'pointer',
      // phet-io
      phetioDocumentation: 'Item buttons shown in a popup menu',
      phetioEventType: EventType.USER,
      // pdom
      tagName: 'button',
      containerTagName: 'li',
      containerAriaRole: 'none',
      // this is required for JAWS to handle focus correctly, see https://github.com/phetsims/john-travoltage/issues/225
      ariaRole: 'menuitem',
      // 'menuitem' role does not get click events on iOS VoiceOver, position siblings so that
      // we get Pointer events instead
      positionInPDOM: true
    }, providedOptions);
    super();
    if (shouldBeHiddenWhenLinksAreNotAllowed) {
      this.setVisibleProperty(allowLinksProperty);
    }
    const labelStringListener = labelString => {
      this.innerContent = labelString;
      this.voicingNameResponse = labelString;
    };
    labelStringProperty.link(labelStringListener);
    this.present = present;
    const labelText = new Text(labelStringProperty, {
      font: new PhetFont(FONT_SIZE),
      fill: options.textFill,
      maxWidth: MAX_ITEM_WIDTH
    });
    const highlight = new Rectangle({
      cornerRadius: CORNER_RADIUS
    });
    labelText.boundsProperty.link(textBounds => {
      this.localMinimumWidth = textBounds.width + LEFT_X_MARGIN + RIGHT_X_MARGIN + CHECK_OFFSET;
      highlight.rectHeight = textBounds.height + Y_MARGIN + Y_MARGIN;
    });
    this.localPreferredWidthProperty.link(preferredWidth => {
      if (preferredWidth === null) {
        preferredWidth = this.localMinimumWidth;
      } else {
        preferredWidth = Math.max(this.localMinimumWidth || 0, preferredWidth);
      }
      if (preferredWidth) {
        highlight.rectWidth = preferredWidth;
      }
    });
    this.addChild(highlight);
    this.addChild(labelText);
    ManualConstraint.create(this, [highlight, labelText], (highlightProxy, labelTextProxy) => {
      labelTextProxy.left = highlightProxy.left + LEFT_X_MARGIN + CHECK_OFFSET; // labelStringProperty is left aligned
      labelTextProxy.centerY = highlightProxy.centerY;
    });
    this.addInputListener({
      enter: () => {
        highlight.fill = HIGHLIGHT_COLOR;
      },
      exit: () => {
        highlight.fill = null;
      }
    });
    this.addInputListener(new FireListener({
      tandem: options.tandem?.createTandem('fireListener'),
      fire: event => {
        closeCallback(event);
        callback(event);
      }
    }));
    this.separatorBefore = options.separatorBefore;

    // Optionally add a check mark and hook up visibility changes.
    let checkedListener = null;
    if (options.checkedProperty) {
      const checkMarkWrapper = new Node({
        children: [CHECK_MARK_NODE],
        right: labelText.left - CHECK_PADDING,
        centerY: labelText.centerY
      });
      checkedListener = isChecked => {
        checkMarkWrapper.visible = isChecked;
      };
      options.checkedProperty.link(checkedListener);
      this.addChild(checkMarkWrapper);
    }
    this.mutate(options);
    this.disposeMenuItem = () => {
      if (options.checkedProperty && checkedListener && options.checkedProperty.hasListener(checkedListener)) {
        options.checkedProperty.unlink(checkedListener);
      }
      if (labelStringProperty.hasListener(labelStringListener)) {
        labelStringProperty.unlink(labelStringListener);
      }
      labelText.dispose();
    };
  }
  dispose() {
    this.disposeMenuItem();
    super.dispose();
  }
}
sun.register('MenuItem', MenuItem);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQaGV0Rm9udCIsImFsbG93TGlua3NQcm9wZXJ0eSIsIkZpcmVMaXN0ZW5lciIsIk1hbnVhbENvbnN0cmFpbnQiLCJOb2RlIiwiUGF0aCIsIlJlY3RhbmdsZSIsIlRleHQiLCJWb2ljaW5nIiwiV2lkdGhTaXphYmxlIiwiY2hlY2tTb2xpZFNoYXBlIiwiRXZlbnRUeXBlIiwic3VuIiwib3B0aW9uaXplIiwiQ0hFQ0tfTUFSS19OT0RFIiwiZmlsbCIsIm1heFdpZHRoIiwiRk9OVF9TSVpFIiwiSElHSExJR0hUX0NPTE9SIiwiTUFYX0lURU1fV0lEVEgiLCJDSEVDS19QQURESU5HIiwiQ0hFQ0tfT0ZGU0VUIiwid2lkdGgiLCJMRUZUX1hfTUFSR0lOIiwiUklHSFRfWF9NQVJHSU4iLCJZX01BUkdJTiIsIkNPUk5FUl9SQURJVVMiLCJNZW51SXRlbSIsImNvbnN0cnVjdG9yIiwiY2xvc2VDYWxsYmFjayIsImxhYmVsU3RyaW5nUHJvcGVydHkiLCJjYWxsYmFjayIsInByZXNlbnQiLCJzaG91bGRCZUhpZGRlbldoZW5MaW5rc0FyZU5vdEFsbG93ZWQiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwic2VwYXJhdG9yQmVmb3JlIiwiY2hlY2tlZFByb3BlcnR5IiwidGV4dEZpbGwiLCJjdXJzb3IiLCJwaGV0aW9Eb2N1bWVudGF0aW9uIiwicGhldGlvRXZlbnRUeXBlIiwiVVNFUiIsInRhZ05hbWUiLCJjb250YWluZXJUYWdOYW1lIiwiY29udGFpbmVyQXJpYVJvbGUiLCJhcmlhUm9sZSIsInBvc2l0aW9uSW5QRE9NIiwic2V0VmlzaWJsZVByb3BlcnR5IiwibGFiZWxTdHJpbmdMaXN0ZW5lciIsImxhYmVsU3RyaW5nIiwiaW5uZXJDb250ZW50Iiwidm9pY2luZ05hbWVSZXNwb25zZSIsImxpbmsiLCJsYWJlbFRleHQiLCJmb250IiwiaGlnaGxpZ2h0IiwiY29ybmVyUmFkaXVzIiwiYm91bmRzUHJvcGVydHkiLCJ0ZXh0Qm91bmRzIiwibG9jYWxNaW5pbXVtV2lkdGgiLCJyZWN0SGVpZ2h0IiwiaGVpZ2h0IiwibG9jYWxQcmVmZXJyZWRXaWR0aFByb3BlcnR5IiwicHJlZmVycmVkV2lkdGgiLCJNYXRoIiwibWF4IiwicmVjdFdpZHRoIiwiYWRkQ2hpbGQiLCJjcmVhdGUiLCJoaWdobGlnaHRQcm94eSIsImxhYmVsVGV4dFByb3h5IiwibGVmdCIsImNlbnRlclkiLCJhZGRJbnB1dExpc3RlbmVyIiwiZW50ZXIiLCJleGl0IiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwiZmlyZSIsImV2ZW50IiwiY2hlY2tlZExpc3RlbmVyIiwiY2hlY2tNYXJrV3JhcHBlciIsImNoaWxkcmVuIiwicmlnaHQiLCJpc0NoZWNrZWQiLCJ2aXNpYmxlIiwibXV0YXRlIiwiZGlzcG9zZU1lbnVJdGVtIiwiaGFzTGlzdGVuZXIiLCJ1bmxpbmsiLCJkaXNwb3NlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJNZW51SXRlbS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBNZW51SXRlbSBpcyBhbiBpdGVtIGluIHRoZSBQaGV0TWVudS5cclxuICpcclxuICogQGF1dGhvciBNaWNoYWVsIEthdXptYW5uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBUUHJvcGVydHkgZnJvbSAnLi4vLi4vYXhvbi9qcy9UUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUGhldEZvbnQgZnJvbSAnLi4vLi4vc2NlbmVyeS1waGV0L2pzL1BoZXRGb250LmpzJztcclxuaW1wb3J0IHsgYWxsb3dMaW5rc1Byb3BlcnR5LCBGaXJlTGlzdGVuZXIsIE1hbnVhbENvbnN0cmFpbnQsIE5vZGUsIE5vZGVPcHRpb25zLCBQYXRoLCBSZWN0YW5nbGUsIFNjZW5lcnlFdmVudCwgVGV4dCwgVFBhaW50LCBWb2ljaW5nLCBWb2ljaW5nT3B0aW9ucywgV2lkdGhTaXphYmxlIH0gZnJvbSAnLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGNoZWNrU29saWRTaGFwZSBmcm9tICcuLi8uLi9zaGVycGEvanMvZm9udGF3ZXNvbWUtNS9jaGVja1NvbGlkU2hhcGUuanMnO1xyXG5pbXBvcnQgRXZlbnRUeXBlIGZyb20gJy4uLy4uL3RhbmRlbS9qcy9FdmVudFR5cGUuanMnO1xyXG5pbXBvcnQgc3VuIGZyb20gJy4vc3VuLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvVFJlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5cclxuLy8gdGhlIGNoZWNrIG1hcmsgdXNlZCBmb3IgdG9nZ2xlLWFibGUgbWVudSBpdGVtc1xyXG5jb25zdCBDSEVDS19NQVJLX05PREUgPSBuZXcgUGF0aCggY2hlY2tTb2xpZFNoYXBlLCB7XHJcbiAgZmlsbDogJ3JnYmEoMCwwLDAsMC43KScsXHJcbiAgbWF4V2lkdGg6IDE1LjVcclxufSApO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEZPTlRfU0laRSA9IDE4O1xyXG5jb25zdCBISUdITElHSFRfQ09MT1IgPSAnI2E2ZDJmNCc7XHJcbmNvbnN0IE1BWF9JVEVNX1dJRFRIID0gNDAwO1xyXG5jb25zdCBDSEVDS19QQURESU5HID0gMjsgIC8vIHBhZGRpbmcgYmV0d2VlbiB0aGUgY2hlY2sgYW5kIHRleHRcclxuY29uc3QgQ0hFQ0tfT0ZGU0VUID0gQ0hFQ0tfTUFSS19OT0RFLndpZHRoICsgQ0hFQ0tfUEFERElORzsgLy8gb2Zmc2V0IHRoYXQgaW5jbHVkZXMgdGhlIGNoZWNrIG1hcmsncyB3aWR0aCBhbmQgcGFkZGluZ1xyXG5jb25zdCBMRUZUX1hfTUFSR0lOID0gMjtcclxuY29uc3QgUklHSFRfWF9NQVJHSU4gPSA1O1xyXG5jb25zdCBZX01BUkdJTiA9IDM7XHJcbmNvbnN0IENPUk5FUl9SQURJVVMgPSA1O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuXHJcbiAgLy8gaWYgdGhlcmUgc2hvdWxkIGJlIGEgaG9yaXpvbnRhbCBzZXBhcmF0b3IgYmV0d2VlbiB0aGlzIE1lbnVJdGVtIGFuZCB0aGUgb25lIGltbWVkaWF0ZWx5IHByZXZpb3VzXHJcbiAgc2VwYXJhdG9yQmVmb3JlPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gaWYgcHJvdmlkZWQgYWRkIGEgY2hlY2ttYXJrIG5leHQgdG8gdGhlIE1lbnVJdGVtIHRleHQgd2hlbmV2ZXIgdGhpcyBQcm9wZXJ0eSBpcyB0cnVlLlxyXG4gIGNoZWNrZWRQcm9wZXJ0eT86IFRQcm9wZXJ0eTxib29sZWFuPiB8IG51bGw7XHJcblxyXG4gIHRleHRGaWxsPzogVFBhaW50O1xyXG59O1xyXG50eXBlIFBhcmVudE9wdGlvbnMgPSBWb2ljaW5nT3B0aW9ucyAmIE5vZGVPcHRpb25zO1xyXG5leHBvcnQgdHlwZSBNZW51SXRlbU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBhcmVudE9wdGlvbnM7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNZW51SXRlbSBleHRlbmRzIFdpZHRoU2l6YWJsZSggVm9pY2luZyggTm9kZSApICkge1xyXG5cclxuICAvLyBpZiB0aGlzIE1lbnVJdGVtIHdpbGwgYmUgc2hvd24gaW4gdGhlIG1lbnUuIFNvbWUgaXRlbXMgYXJlIGp1c3QgY3JlYXRlZCB0byBtYWludGFpbiBhXHJcbiAgLy8gY29uc2lzdGVudCBQaEVULWlPIEFQSSBmb3IgYWxsIHNpbSBydW50aW1lcywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9waGV0LWlvL2lzc3Vlcy8xNDU3XHJcbiAgcHVibGljIHJlYWRvbmx5IHByZXNlbnQ6IGJvb2xlYW47XHJcblxyXG4gIC8vIGlmIHRoZXJlIHNob3VsZCBiZSBhIGhvcml6b250YWwgc2VwYXJhdG9yIGJldHdlZW4gdGhpcyBNZW51SXRlbSBhbmQgdGhlIG9uZSBhYm92ZSBpdFxyXG4gIHB1YmxpYyByZWFkb25seSBzZXBhcmF0b3JCZWZvcmU6IGJvb2xlYW47XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zZU1lbnVJdGVtOiAoKSA9PiB2b2lkO1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gY2xvc2VDYWxsYmFjayAtIGNhbGxlZCB3aGVuIGZpcmluZyB0aGUgbWVudSBpdGVtLCBtb3N0IGxpa2VseSB0aGlzIHNob3VsZCBjbG9zZSB0aGUgUGhldE1lbnUuXHJcbiAgICogQHBhcmFtIGxhYmVsU3RyaW5nUHJvcGVydHkgLSBsYWJlbCBmb3IgdGhlIG1lbnUgaXRlbVxyXG4gICAqIEBwYXJhbSBjYWxsYmFjayAtIGNhbGxlZCB3aGVuIHRoZSBtZW51IGl0ZW0gaXMgc2VsZWN0ZWRcclxuICAgKiBAcGFyYW0gcHJlc2VudCAtIHNlZSBwcmVzZW50IGZpZWxkXHJcbiAgICogQHBhcmFtIHNob3VsZEJlSGlkZGVuV2hlbkxpbmtzQXJlTm90QWxsb3dlZFxyXG4gICAqIEBwYXJhbSBbcHJvdmlkZWRPcHRpb25zXVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggY2xvc2VDYWxsYmFjazogKCBldmVudDogU2NlbmVyeUV2ZW50ICkgPT4gdm9pZCxcclxuICAgICAgICAgICAgICAgICAgICAgIGxhYmVsU3RyaW5nUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PHN0cmluZz4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogKCBldmVudDogU2NlbmVyeUV2ZW50ICkgPT4gdm9pZCwgcHJlc2VudDogYm9vbGVhbixcclxuICAgICAgICAgICAgICAgICAgICAgIHNob3VsZEJlSGlkZGVuV2hlbkxpbmtzQXJlTm90QWxsb3dlZDogYm9vbGVhbixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IE1lbnVJdGVtT3B0aW9ucyApIHtcclxuXHJcbiAgICAvLyBFeHRlbmQgdGhlIG9iamVjdCB3aXRoIGRlZmF1bHRzLlxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxNZW51SXRlbU9wdGlvbnMsIFNlbGZPcHRpb25zLCBQYXJlbnRPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBTZWxmT3B0aW9uc1xyXG4gICAgICBzZXBhcmF0b3JCZWZvcmU6IGZhbHNlLFxyXG4gICAgICBjaGVja2VkUHJvcGVydHk6IG51bGwsXHJcbiAgICAgIHRleHRGaWxsOiAnYmxhY2snLFxyXG5cclxuICAgICAgLy8gVm9pY2luZ09wdGlvbnNcclxuICAgICAgY3Vyc29yOiAncG9pbnRlcicsXHJcblxyXG4gICAgICAvLyBwaGV0LWlvXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdJdGVtIGJ1dHRvbnMgc2hvd24gaW4gYSBwb3B1cCBtZW51JyxcclxuICAgICAgcGhldGlvRXZlbnRUeXBlOiBFdmVudFR5cGUuVVNFUixcclxuXHJcbiAgICAgIC8vIHBkb21cclxuICAgICAgdGFnTmFtZTogJ2J1dHRvbicsXHJcbiAgICAgIGNvbnRhaW5lclRhZ05hbWU6ICdsaScsXHJcbiAgICAgIGNvbnRhaW5lckFyaWFSb2xlOiAnbm9uZScsIC8vIHRoaXMgaXMgcmVxdWlyZWQgZm9yIEpBV1MgdG8gaGFuZGxlIGZvY3VzIGNvcnJlY3RseSwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9qb2huLXRyYXZvbHRhZ2UvaXNzdWVzLzIyNVxyXG4gICAgICBhcmlhUm9sZTogJ21lbnVpdGVtJyxcclxuXHJcbiAgICAgIC8vICdtZW51aXRlbScgcm9sZSBkb2VzIG5vdCBnZXQgY2xpY2sgZXZlbnRzIG9uIGlPUyBWb2ljZU92ZXIsIHBvc2l0aW9uIHNpYmxpbmdzIHNvIHRoYXRcclxuICAgICAgLy8gd2UgZ2V0IFBvaW50ZXIgZXZlbnRzIGluc3RlYWRcclxuICAgICAgcG9zaXRpb25JblBET006IHRydWVcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgaWYgKCBzaG91bGRCZUhpZGRlbldoZW5MaW5rc0FyZU5vdEFsbG93ZWQgKSB7XHJcbiAgICAgIHRoaXMuc2V0VmlzaWJsZVByb3BlcnR5KCBhbGxvd0xpbmtzUHJvcGVydHkgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBsYWJlbFN0cmluZ0xpc3RlbmVyID0gKCBsYWJlbFN0cmluZzogc3RyaW5nICkgPT4ge1xyXG4gICAgICB0aGlzLmlubmVyQ29udGVudCA9IGxhYmVsU3RyaW5nO1xyXG4gICAgICB0aGlzLnZvaWNpbmdOYW1lUmVzcG9uc2UgPSBsYWJlbFN0cmluZztcclxuICAgIH07XHJcbiAgICBsYWJlbFN0cmluZ1Byb3BlcnR5LmxpbmsoIGxhYmVsU3RyaW5nTGlzdGVuZXIgKTtcclxuXHJcbiAgICB0aGlzLnByZXNlbnQgPSBwcmVzZW50O1xyXG5cclxuICAgIGNvbnN0IGxhYmVsVGV4dCA9IG5ldyBUZXh0KCBsYWJlbFN0cmluZ1Byb3BlcnR5LCB7XHJcbiAgICAgIGZvbnQ6IG5ldyBQaGV0Rm9udCggRk9OVF9TSVpFICksXHJcbiAgICAgIGZpbGw6IG9wdGlvbnMudGV4dEZpbGwsXHJcbiAgICAgIG1heFdpZHRoOiBNQVhfSVRFTV9XSURUSFxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGhpZ2hsaWdodCA9IG5ldyBSZWN0YW5nbGUoIHtcclxuICAgICAgY29ybmVyUmFkaXVzOiBDT1JORVJfUkFESVVTXHJcbiAgICB9ICk7XHJcblxyXG4gICAgbGFiZWxUZXh0LmJvdW5kc1Byb3BlcnR5LmxpbmsoIHRleHRCb3VuZHMgPT4ge1xyXG4gICAgICB0aGlzLmxvY2FsTWluaW11bVdpZHRoID0gdGV4dEJvdW5kcy53aWR0aCArIExFRlRfWF9NQVJHSU4gKyBSSUdIVF9YX01BUkdJTiArIENIRUNLX09GRlNFVDtcclxuICAgICAgaGlnaGxpZ2h0LnJlY3RIZWlnaHQgPSB0ZXh0Qm91bmRzLmhlaWdodCArIFlfTUFSR0lOICsgWV9NQVJHSU47XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5sb2NhbFByZWZlcnJlZFdpZHRoUHJvcGVydHkubGluayggcHJlZmVycmVkV2lkdGggPT4ge1xyXG4gICAgICBpZiAoIHByZWZlcnJlZFdpZHRoID09PSBudWxsICkge1xyXG4gICAgICAgIHByZWZlcnJlZFdpZHRoID0gdGhpcy5sb2NhbE1pbmltdW1XaWR0aDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBwcmVmZXJyZWRXaWR0aCA9IE1hdGgubWF4KCB0aGlzLmxvY2FsTWluaW11bVdpZHRoIHx8IDAsIHByZWZlcnJlZFdpZHRoICk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCBwcmVmZXJyZWRXaWR0aCApIHtcclxuICAgICAgICBoaWdobGlnaHQucmVjdFdpZHRoID0gcHJlZmVycmVkV2lkdGg7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmFkZENoaWxkKCBoaWdobGlnaHQgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGxhYmVsVGV4dCApO1xyXG5cclxuICAgIE1hbnVhbENvbnN0cmFpbnQuY3JlYXRlKCB0aGlzLCBbIGhpZ2hsaWdodCwgbGFiZWxUZXh0IF0sICggaGlnaGxpZ2h0UHJveHksIGxhYmVsVGV4dFByb3h5ICkgPT4ge1xyXG4gICAgICBsYWJlbFRleHRQcm94eS5sZWZ0ID0gaGlnaGxpZ2h0UHJveHkubGVmdCArIExFRlRfWF9NQVJHSU4gKyBDSEVDS19PRkZTRVQ7IC8vIGxhYmVsU3RyaW5nUHJvcGVydHkgaXMgbGVmdCBhbGlnbmVkXHJcbiAgICAgIGxhYmVsVGV4dFByb3h5LmNlbnRlclkgPSBoaWdobGlnaHRQcm94eS5jZW50ZXJZO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lcigge1xyXG4gICAgICBlbnRlcjogKCkgPT4geyBoaWdobGlnaHQuZmlsbCA9IEhJR0hMSUdIVF9DT0xPUjsgfSxcclxuICAgICAgZXhpdDogKCkgPT4geyBoaWdobGlnaHQuZmlsbCA9IG51bGw7IH1cclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIG5ldyBGaXJlTGlzdGVuZXIoIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbT8uY3JlYXRlVGFuZGVtKCAnZmlyZUxpc3RlbmVyJyApLFxyXG4gICAgICBmaXJlOiAoIGV2ZW50OiBTY2VuZXJ5RXZlbnQgKSA9PiB7XHJcbiAgICAgICAgY2xvc2VDYWxsYmFjayggZXZlbnQgKTtcclxuICAgICAgICBjYWxsYmFjayggZXZlbnQgKTtcclxuICAgICAgfVxyXG4gICAgfSApICk7XHJcblxyXG4gICAgdGhpcy5zZXBhcmF0b3JCZWZvcmUgPSBvcHRpb25zLnNlcGFyYXRvckJlZm9yZTtcclxuXHJcbiAgICAvLyBPcHRpb25hbGx5IGFkZCBhIGNoZWNrIG1hcmsgYW5kIGhvb2sgdXAgdmlzaWJpbGl0eSBjaGFuZ2VzLlxyXG4gICAgbGV0IGNoZWNrZWRMaXN0ZW5lcjogKCAoIGlzQ2hlY2tlZDogYm9vbGVhbiApID0+IHZvaWQgKSB8IG51bGwgPSBudWxsO1xyXG4gICAgaWYgKCBvcHRpb25zLmNoZWNrZWRQcm9wZXJ0eSApIHtcclxuICAgICAgY29uc3QgY2hlY2tNYXJrV3JhcHBlciA9IG5ldyBOb2RlKCB7XHJcbiAgICAgICAgY2hpbGRyZW46IFsgQ0hFQ0tfTUFSS19OT0RFIF0sXHJcbiAgICAgICAgcmlnaHQ6IGxhYmVsVGV4dC5sZWZ0IC0gQ0hFQ0tfUEFERElORyxcclxuICAgICAgICBjZW50ZXJZOiBsYWJlbFRleHQuY2VudGVyWVxyXG4gICAgICB9ICk7XHJcbiAgICAgIGNoZWNrZWRMaXN0ZW5lciA9ICggaXNDaGVja2VkOiBib29sZWFuICkgPT4ge1xyXG4gICAgICAgIGNoZWNrTWFya1dyYXBwZXIudmlzaWJsZSA9IGlzQ2hlY2tlZDtcclxuICAgICAgfTtcclxuICAgICAgb3B0aW9ucy5jaGVja2VkUHJvcGVydHkubGluayggY2hlY2tlZExpc3RlbmVyICk7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIGNoZWNrTWFya1dyYXBwZXIgKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLm11dGF0ZSggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuZGlzcG9zZU1lbnVJdGVtID0gKCkgPT4ge1xyXG4gICAgICBpZiAoIG9wdGlvbnMuY2hlY2tlZFByb3BlcnR5ICYmIGNoZWNrZWRMaXN0ZW5lciAmJiBvcHRpb25zLmNoZWNrZWRQcm9wZXJ0eS5oYXNMaXN0ZW5lciggY2hlY2tlZExpc3RlbmVyICkgKSB7XHJcbiAgICAgICAgb3B0aW9ucy5jaGVja2VkUHJvcGVydHkudW5saW5rKCBjaGVja2VkTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCBsYWJlbFN0cmluZ1Byb3BlcnR5Lmhhc0xpc3RlbmVyKCBsYWJlbFN0cmluZ0xpc3RlbmVyICkgKSB7XHJcbiAgICAgICAgbGFiZWxTdHJpbmdQcm9wZXJ0eS51bmxpbmsoIGxhYmVsU3RyaW5nTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgbGFiZWxUZXh0LmRpc3Bvc2UoKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZU1lbnVJdGVtKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5zdW4ucmVnaXN0ZXIoICdNZW51SXRlbScsIE1lbnVJdGVtICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLE9BQU9BLFFBQVEsTUFBTSxtQ0FBbUM7QUFDeEQsU0FBU0Msa0JBQWtCLEVBQUVDLFlBQVksRUFBRUMsZ0JBQWdCLEVBQUVDLElBQUksRUFBZUMsSUFBSSxFQUFFQyxTQUFTLEVBQWdCQyxJQUFJLEVBQVVDLE9BQU8sRUFBa0JDLFlBQVksUUFBUSw2QkFBNkI7QUFDdk0sT0FBT0MsZUFBZSxNQUFNLGtEQUFrRDtBQUM5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