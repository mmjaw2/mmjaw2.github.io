// Copyright 2019-2024, University of Colorado Boulder

/**
 * A static object used to send aria-live updates to a screen reader. These are alerts that are independent of user
 * focus. This will create and reference 'aria-live' elements in the HTML document and update their content. You
 * will need to get these elements and add them to the document through a reference to this.ariaLiveElements.
 * A number of elements such as the following are created and used:
 *
 *    <p id="elements-1-polite-1" aria-live="polite"></p>
 *    <p id="elements-1-polite-2" aria-live="polite"></p>
 *    <p id="elements-1-polite-3" aria-live="polite"></p>
 *    <p id="elements-1-polite-4" aria-live="polite"></p>
 *
 *    <p id="elements-1-assertive-1" aria-live="assertive"></p>
 *    <p id="elements-1-assertive-2" aria-live="assertive"></p>
 *    <p id="elements-1-assertive-3" aria-live="assertive"></p>
 *    <p id="elements-1-assertive-4" aria-live="assertive"></p>
 *
 * It was discovered that cycling through using these elements prevented a VoiceOver bug where alerts would interrupt
 * each other. Starting from the first element, content is set on each element in order and cycles through.
 *
 * Many aria-live and related attributes were tested, but none were well supported or particularly useful for PhET sims,
 * see https://github.com/phetsims/chipper/issues/472.
 *
 * @author Jesse Greenberg
 * @author John Blanco
 */

import stepTimer from '../../axon/js/stepTimer.js';
import Enumeration from '../../phet-core/js/Enumeration.js';
import EnumerationValue from '../../phet-core/js/EnumerationValue.js';
import optionize from '../../phet-core/js/optionize.js';
import platform from '../../phet-core/js/platform.js';
import { PDOMUtils } from '../../scenery/js/imports.js';
import Announcer from './Announcer.js';
import utteranceQueueNamespace from './utteranceQueueNamespace.js';
import { isTReadOnlyProperty } from '../../axon/js/TReadOnlyProperty.js';

// constants
const NUMBER_OF_ARIA_LIVE_ELEMENTS = 4;

// one indexed for the element ids, unique to each AriaLiveAnnouncer instance
let ariaLiveAnnouncerIndex = 1;

// Possible supported values for the `aria-live` attributes created in AriaLiveAnnouncer.
class AriaLive extends EnumerationValue {
  constructor(attributeString) {
    super();
    this.attributeString = attributeString;
  }
  static POLITE = new AriaLive('polite');
  static ASSERTIVE = new AriaLive('assertive');
  static enumeration = new Enumeration(AriaLive);
}

// Options for the announce method

/**
 * @returns - a container holding each aria-live elements created
 */
function createBatchOfPriorityLiveElements(ariaLivePriority) {
  const priority = ariaLivePriority.attributeString;
  const container = document.createElement('div');
  for (let i = 1; i <= NUMBER_OF_ARIA_LIVE_ELEMENTS; i++) {
    const newParagraph = document.createElement('p');
    newParagraph.setAttribute('id', `elements-${ariaLiveAnnouncerIndex}-${priority}-${i}`);

    // set aria-live on individual paragraph elements to prevent VoiceOver from interrupting alerts, see
    // https://github.com/phetsims/molecules-and-light/issues/235
    newParagraph.setAttribute('aria-live', priority);
    container.appendChild(newParagraph);
  }
  return container;
}
class AriaLiveAnnouncer extends Announcer {
  // index of current aria-live element to use, updated every time an event triggers

  // DOM elements which will receive the updated content.

  // The Announcer only speaks one Utterance per this interval or else VoiceOver reads alerts out of order.
  // This is also the interval at which alert content is cleared from the DOM once set so that it cannot be found
  // with the virtual cursor after setting.
  static ARIA_LIVE_DELAY = 200;
  constructor(providedOptions) {
    const options = optionize()({
      // By default, don't care about response collector Properties, as they are designed for Voicing more than
      // aria-live description.
      respectResponseCollectorProperties: false,
      lang: 'en'
    }, providedOptions);
    super(options);
    this.politeElementIndex = 0;
    this.assertiveElementIndex = 0;
    this.ariaLiveContainer = document.createElement('div'); //container div
    this.ariaLiveContainer.setAttribute('lang', options.lang);
    this.ariaLiveContainer.setAttribute('id', `aria-live-elements-${ariaLiveAnnouncerIndex}`);
    this.ariaLiveContainer.setAttribute('style', 'position: absolute; left: 0px; top: 0px; width: 0px; height: 0px; ' + 'clip: rect(0px 0px 0px 0px); pointer-events: none;');

    // By having four elements and cycling through each one, we can get around a VoiceOver bug where a new
    // alert would interrupt the previous alert if it wasn't finished speaking, see https://github.com/phetsims/scenery-phet/issues/362
    const politeElementContainer = createBatchOfPriorityLiveElements(AriaLive.POLITE);
    const assertiveElementContainer = createBatchOfPriorityLiveElements(AriaLive.ASSERTIVE);
    this.ariaLiveContainer.appendChild(politeElementContainer);
    this.ariaLiveContainer.appendChild(assertiveElementContainer);
    this.politeElements = Array.from(politeElementContainer.children);
    this.assertiveElements = Array.from(assertiveElementContainer.children);

    // increment index so the next AriaLiveAnnouncer instance has different ids for its elements.
    ariaLiveAnnouncerIndex++;
  }

  /**
   * Announce an alert, setting textContent to an aria-live element.
   */
  announce(announceText, utterance, providedOptions) {
    const options = optionize()({
      // By default, alert to a polite aria-live element
      ariaLivePriority: AriaLive.POLITE
    }, providedOptions);

    // aria-live and AT has no API to detect successful speech, we can only assume every announce is successful
    this.hasSpoken = true;

    // Don't update if null
    if (announceText) {
      if (isTReadOnlyProperty(announceText)) {
        announceText = announceText.value;
      }
      if (options.ariaLivePriority === AriaLive.POLITE) {
        const element = this.politeElements[this.politeElementIndex];
        this.updateLiveElement(element, announceText, utterance);

        // update index for next time
        this.politeElementIndex = (this.politeElementIndex + 1) % this.politeElements.length;
      } else if (options.ariaLivePriority === AriaLive.ASSERTIVE) {
        const element = this.assertiveElements[this.assertiveElementIndex];
        this.updateLiveElement(element, announceText, utterance);
        // update index for next time
        this.assertiveElementIndex = (this.assertiveElementIndex + 1) % this.assertiveElements.length;
      } else {
        assert && assert(false, 'unsupported aria live prioirity');
      }
    }

    // With aria-live we don't have information about when the screen reader is done speaking
    // the content, so we have to emit this right away
    this.announcementCompleteEmitter.emit(utterance, announceText);
  }

  /**
   * The implementation of cancel for AriaLiveAnnouncer. We do not know whether the AT is speaking content so
   * this function is a no-op for aria-live.
   */
  cancel() {
    // See docs
  }

  /**
   * The implementation of cancelUtterance for AriaLiveAnnouncer. We do not know whether the AT is speaking content so
   * this function is a no-op for aria-live.
   */
  cancelUtterance(utterance) {
    // See docs
  }

  /**
   * Update an element with the 'aria-live' attribute by setting its text content.
   *
   * @param liveElement - the HTML element that will send the alert to the assistive technology
   * @param textContent - the content to be announced
   * @param utterance
   */
  updateLiveElement(liveElement, textContent, utterance) {
    // fully clear the old textContent so that sequential alerts with identical text will be announced, which
    // some screen readers might have prevented
    liveElement.textContent = '';

    // element must be visible for alerts to be spoken
    liveElement.hidden = false;

    // UtteranceQueue cannot announce again until after the following timeouts.
    this.readyToAnnounce = false;

    // must be done asynchronously from setting hidden above or else the screen reader
    // will fail to read the content
    stepTimer.setTimeout(() => {
      // make sure that the utterance is not out of date right before it is actually sent to assistive technology
      if (utterance.predicate()) {
        PDOMUtils.setTextContent(liveElement, textContent);

        // Hide the content so that it cant be read with the virtual cursor. Must be done
        // behind at least 200 ms delay or else alerts may be missed by NVDA and VoiceOver, see
        // https://github.com/phetsims/scenery-phet/issues/491
        stepTimer.setTimeout(() => {
          if (platform.safari) {
            // Using `hidden` rather than clearing textContent works better on mobile VO,
            // see https://github.com/phetsims/scenery-phet/issues/490
            liveElement.hidden = true;
          } else {
            liveElement.textContent = '';
          }

          // Wait until after this timeout to let the UtteranceQueue can announce Utterances again. This delay
          // seems to be necessary to force VoiceOver to speak aria-live alerts in first-in-first-out order.
          // See https://github.com/phetsims/utterance-queue/issues/88
          this.readyToAnnounce = true;
        }, AriaLiveAnnouncer.ARIA_LIVE_DELAY);
      } else {
        this.readyToAnnounce = true; // If the predicate fails, we are ready to announce again.
      }
    }, 0);
  }

  // Possible values for the `aria-live` attribute (priority) that can be alerted (like "polite" and
  // "assertive"), see AriaLiveAnnounceOptions for details.
  static AriaLive = AriaLive;
}
utteranceQueueNamespace.register('AriaLiveAnnouncer', AriaLiveAnnouncer);
export default AriaLiveAnnouncer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzdGVwVGltZXIiLCJFbnVtZXJhdGlvbiIsIkVudW1lcmF0aW9uVmFsdWUiLCJvcHRpb25pemUiLCJwbGF0Zm9ybSIsIlBET01VdGlscyIsIkFubm91bmNlciIsInV0dGVyYW5jZVF1ZXVlTmFtZXNwYWNlIiwiaXNUUmVhZE9ubHlQcm9wZXJ0eSIsIk5VTUJFUl9PRl9BUklBX0xJVkVfRUxFTUVOVFMiLCJhcmlhTGl2ZUFubm91bmNlckluZGV4IiwiQXJpYUxpdmUiLCJjb25zdHJ1Y3RvciIsImF0dHJpYnV0ZVN0cmluZyIsIlBPTElURSIsIkFTU0VSVElWRSIsImVudW1lcmF0aW9uIiwiY3JlYXRlQmF0Y2hPZlByaW9yaXR5TGl2ZUVsZW1lbnRzIiwiYXJpYUxpdmVQcmlvcml0eSIsInByaW9yaXR5IiwiY29udGFpbmVyIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiaSIsIm5ld1BhcmFncmFwaCIsInNldEF0dHJpYnV0ZSIsImFwcGVuZENoaWxkIiwiQXJpYUxpdmVBbm5vdW5jZXIiLCJBUklBX0xJVkVfREVMQVkiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwicmVzcGVjdFJlc3BvbnNlQ29sbGVjdG9yUHJvcGVydGllcyIsImxhbmciLCJwb2xpdGVFbGVtZW50SW5kZXgiLCJhc3NlcnRpdmVFbGVtZW50SW5kZXgiLCJhcmlhTGl2ZUNvbnRhaW5lciIsInBvbGl0ZUVsZW1lbnRDb250YWluZXIiLCJhc3NlcnRpdmVFbGVtZW50Q29udGFpbmVyIiwicG9saXRlRWxlbWVudHMiLCJBcnJheSIsImZyb20iLCJjaGlsZHJlbiIsImFzc2VydGl2ZUVsZW1lbnRzIiwiYW5ub3VuY2UiLCJhbm5vdW5jZVRleHQiLCJ1dHRlcmFuY2UiLCJoYXNTcG9rZW4iLCJ2YWx1ZSIsImVsZW1lbnQiLCJ1cGRhdGVMaXZlRWxlbWVudCIsImxlbmd0aCIsImFzc2VydCIsImFubm91bmNlbWVudENvbXBsZXRlRW1pdHRlciIsImVtaXQiLCJjYW5jZWwiLCJjYW5jZWxVdHRlcmFuY2UiLCJsaXZlRWxlbWVudCIsInRleHRDb250ZW50IiwiaGlkZGVuIiwicmVhZHlUb0Fubm91bmNlIiwic2V0VGltZW91dCIsInByZWRpY2F0ZSIsInNldFRleHRDb250ZW50Iiwic2FmYXJpIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJBcmlhTGl2ZUFubm91bmNlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIHN0YXRpYyBvYmplY3QgdXNlZCB0byBzZW5kIGFyaWEtbGl2ZSB1cGRhdGVzIHRvIGEgc2NyZWVuIHJlYWRlci4gVGhlc2UgYXJlIGFsZXJ0cyB0aGF0IGFyZSBpbmRlcGVuZGVudCBvZiB1c2VyXHJcbiAqIGZvY3VzLiBUaGlzIHdpbGwgY3JlYXRlIGFuZCByZWZlcmVuY2UgJ2FyaWEtbGl2ZScgZWxlbWVudHMgaW4gdGhlIEhUTUwgZG9jdW1lbnQgYW5kIHVwZGF0ZSB0aGVpciBjb250ZW50LiBZb3VcclxuICogd2lsbCBuZWVkIHRvIGdldCB0aGVzZSBlbGVtZW50cyBhbmQgYWRkIHRoZW0gdG8gdGhlIGRvY3VtZW50IHRocm91Z2ggYSByZWZlcmVuY2UgdG8gdGhpcy5hcmlhTGl2ZUVsZW1lbnRzLlxyXG4gKiBBIG51bWJlciBvZiBlbGVtZW50cyBzdWNoIGFzIHRoZSBmb2xsb3dpbmcgYXJlIGNyZWF0ZWQgYW5kIHVzZWQ6XHJcbiAqXHJcbiAqICAgIDxwIGlkPVwiZWxlbWVudHMtMS1wb2xpdGUtMVwiIGFyaWEtbGl2ZT1cInBvbGl0ZVwiPjwvcD5cclxuICogICAgPHAgaWQ9XCJlbGVtZW50cy0xLXBvbGl0ZS0yXCIgYXJpYS1saXZlPVwicG9saXRlXCI+PC9wPlxyXG4gKiAgICA8cCBpZD1cImVsZW1lbnRzLTEtcG9saXRlLTNcIiBhcmlhLWxpdmU9XCJwb2xpdGVcIj48L3A+XHJcbiAqICAgIDxwIGlkPVwiZWxlbWVudHMtMS1wb2xpdGUtNFwiIGFyaWEtbGl2ZT1cInBvbGl0ZVwiPjwvcD5cclxuICpcclxuICogICAgPHAgaWQ9XCJlbGVtZW50cy0xLWFzc2VydGl2ZS0xXCIgYXJpYS1saXZlPVwiYXNzZXJ0aXZlXCI+PC9wPlxyXG4gKiAgICA8cCBpZD1cImVsZW1lbnRzLTEtYXNzZXJ0aXZlLTJcIiBhcmlhLWxpdmU9XCJhc3NlcnRpdmVcIj48L3A+XHJcbiAqICAgIDxwIGlkPVwiZWxlbWVudHMtMS1hc3NlcnRpdmUtM1wiIGFyaWEtbGl2ZT1cImFzc2VydGl2ZVwiPjwvcD5cclxuICogICAgPHAgaWQ9XCJlbGVtZW50cy0xLWFzc2VydGl2ZS00XCIgYXJpYS1saXZlPVwiYXNzZXJ0aXZlXCI+PC9wPlxyXG4gKlxyXG4gKiBJdCB3YXMgZGlzY292ZXJlZCB0aGF0IGN5Y2xpbmcgdGhyb3VnaCB1c2luZyB0aGVzZSBlbGVtZW50cyBwcmV2ZW50ZWQgYSBWb2ljZU92ZXIgYnVnIHdoZXJlIGFsZXJ0cyB3b3VsZCBpbnRlcnJ1cHRcclxuICogZWFjaCBvdGhlci4gU3RhcnRpbmcgZnJvbSB0aGUgZmlyc3QgZWxlbWVudCwgY29udGVudCBpcyBzZXQgb24gZWFjaCBlbGVtZW50IGluIG9yZGVyIGFuZCBjeWNsZXMgdGhyb3VnaC5cclxuICpcclxuICogTWFueSBhcmlhLWxpdmUgYW5kIHJlbGF0ZWQgYXR0cmlidXRlcyB3ZXJlIHRlc3RlZCwgYnV0IG5vbmUgd2VyZSB3ZWxsIHN1cHBvcnRlZCBvciBwYXJ0aWN1bGFybHkgdXNlZnVsIGZvciBQaEVUIHNpbXMsXHJcbiAqIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY2hpcHBlci9pc3N1ZXMvNDcyLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZ1xyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IHN0ZXBUaW1lciBmcm9tICcuLi8uLi9heG9uL2pzL3N0ZXBUaW1lci5qcyc7XHJcbmltcG9ydCBFbnVtZXJhdGlvbiBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvRW51bWVyYXRpb24uanMnO1xyXG5pbXBvcnQgRW51bWVyYXRpb25WYWx1ZSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvRW51bWVyYXRpb25WYWx1ZS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBwbGF0Zm9ybSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvcGxhdGZvcm0uanMnO1xyXG5pbXBvcnQgeyBQRE9NVXRpbHMgfSBmcm9tICcuLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgQW5ub3VuY2VyLCB7IEFubm91bmNlckFubm91bmNlT3B0aW9ucywgQW5ub3VuY2VyT3B0aW9ucyB9IGZyb20gJy4vQW5ub3VuY2VyLmpzJztcclxuaW1wb3J0IFV0dGVyYW5jZSBmcm9tICcuL1V0dGVyYW5jZS5qcyc7XHJcbmltcG9ydCB1dHRlcmFuY2VRdWV1ZU5hbWVzcGFjZSBmcm9tICcuL3V0dGVyYW5jZVF1ZXVlTmFtZXNwYWNlLmpzJztcclxuaW1wb3J0IHsgUmVzb2x2ZWRSZXNwb25zZSB9IGZyb20gJy4vUmVzcG9uc2VQYWNrZXQuanMnO1xyXG5pbXBvcnQgeyBpc1RSZWFkT25seVByb3BlcnR5IH0gZnJvbSAnLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgTlVNQkVSX09GX0FSSUFfTElWRV9FTEVNRU5UUyA9IDQ7XHJcblxyXG4vLyBvbmUgaW5kZXhlZCBmb3IgdGhlIGVsZW1lbnQgaWRzLCB1bmlxdWUgdG8gZWFjaCBBcmlhTGl2ZUFubm91bmNlciBpbnN0YW5jZVxyXG5sZXQgYXJpYUxpdmVBbm5vdW5jZXJJbmRleCA9IDE7XHJcblxyXG4vLyBQb3NzaWJsZSBzdXBwb3J0ZWQgdmFsdWVzIGZvciB0aGUgYGFyaWEtbGl2ZWAgYXR0cmlidXRlcyBjcmVhdGVkIGluIEFyaWFMaXZlQW5ub3VuY2VyLlxyXG5jbGFzcyBBcmlhTGl2ZSBleHRlbmRzIEVudW1lcmF0aW9uVmFsdWUge1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcHVibGljIHJlYWRvbmx5IGF0dHJpYnV0ZVN0cmluZzogc3RyaW5nICkgeyBzdXBlcigpO31cclxuXHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBQT0xJVEUgPSBuZXcgQXJpYUxpdmUoICdwb2xpdGUnICk7XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBBU1NFUlRJVkUgPSBuZXcgQXJpYUxpdmUoICdhc3NlcnRpdmUnICk7XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgZW51bWVyYXRpb24gPSBuZXcgRW51bWVyYXRpb24oIEFyaWFMaXZlICk7XHJcbn1cclxuXHJcbi8vIE9wdGlvbnMgZm9yIHRoZSBhbm5vdW5jZSBtZXRob2RcclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICBhcmlhTGl2ZVByaW9yaXR5PzogQXJpYUxpdmU7XHJcbn07XHJcbnR5cGUgQXJpYUxpdmVBbm5vdW5jZXJBbm5vdW5jZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIEFubm91bmNlckFubm91bmNlT3B0aW9ucztcclxuXHJcbi8qKlxyXG4gKiBAcmV0dXJucyAtIGEgY29udGFpbmVyIGhvbGRpbmcgZWFjaCBhcmlhLWxpdmUgZWxlbWVudHMgY3JlYXRlZFxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlQmF0Y2hPZlByaW9yaXR5TGl2ZUVsZW1lbnRzKCBhcmlhTGl2ZVByaW9yaXR5OiBBcmlhTGl2ZSApOiBIVE1MRGl2RWxlbWVudCB7XHJcbiAgY29uc3QgcHJpb3JpdHkgPSBhcmlhTGl2ZVByaW9yaXR5LmF0dHJpYnV0ZVN0cmluZztcclxuICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApO1xyXG4gIGZvciAoIGxldCBpID0gMTsgaSA8PSBOVU1CRVJfT0ZfQVJJQV9MSVZFX0VMRU1FTlRTOyBpKysgKSB7XHJcbiAgICBjb25zdCBuZXdQYXJhZ3JhcGggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAncCcgKTtcclxuICAgIG5ld1BhcmFncmFwaC5zZXRBdHRyaWJ1dGUoICdpZCcsIGBlbGVtZW50cy0ke2FyaWFMaXZlQW5ub3VuY2VySW5kZXh9LSR7cHJpb3JpdHl9LSR7aX1gICk7XHJcblxyXG4gICAgLy8gc2V0IGFyaWEtbGl2ZSBvbiBpbmRpdmlkdWFsIHBhcmFncmFwaCBlbGVtZW50cyB0byBwcmV2ZW50IFZvaWNlT3ZlciBmcm9tIGludGVycnVwdGluZyBhbGVydHMsIHNlZVxyXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL21vbGVjdWxlcy1hbmQtbGlnaHQvaXNzdWVzLzIzNVxyXG4gICAgbmV3UGFyYWdyYXBoLnNldEF0dHJpYnV0ZSggJ2FyaWEtbGl2ZScsIHByaW9yaXR5ICk7XHJcbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoIG5ld1BhcmFncmFwaCApO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGNvbnRhaW5lcjtcclxufVxyXG5cclxudHlwZSBBcmlhTGl2ZUFubm91bmNlclNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBUaGUgbGFuZ3VhZ2UgZm9yIHlvdXIgY29udGVudC4gQ2hhbmdpbmcgdGhpcyB3aWxsIGltcGFjdCB0aGUgc3BlZWNoIGVuZ2luZSBvZiBhIHNjcmVlbiByZWFkZXIuXHJcbiAgbGFuZz86IHN0cmluZztcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIEFyaWFMaXZlQW5ub3VuY2VyT3B0aW9ucyA9IEFyaWFMaXZlQW5ub3VuY2VyU2VsZk9wdGlvbnMgJiBBbm5vdW5jZXJPcHRpb25zO1xyXG5cclxuY2xhc3MgQXJpYUxpdmVBbm5vdW5jZXIgZXh0ZW5kcyBBbm5vdW5jZXIge1xyXG5cclxuICAvLyBpbmRleCBvZiBjdXJyZW50IGFyaWEtbGl2ZSBlbGVtZW50IHRvIHVzZSwgdXBkYXRlZCBldmVyeSB0aW1lIGFuIGV2ZW50IHRyaWdnZXJzXHJcbiAgcHJpdmF0ZSBwb2xpdGVFbGVtZW50SW5kZXg6IG51bWJlcjtcclxuICBwcml2YXRlIGFzc2VydGl2ZUVsZW1lbnRJbmRleDogbnVtYmVyO1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgYXJpYUxpdmVDb250YWluZXI6IEhUTUxEaXZFbGVtZW50O1xyXG5cclxuICAvLyBET00gZWxlbWVudHMgd2hpY2ggd2lsbCByZWNlaXZlIHRoZSB1cGRhdGVkIGNvbnRlbnQuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBwb2xpdGVFbGVtZW50czogSFRNTEVsZW1lbnRbXTtcclxuICBwcml2YXRlIHJlYWRvbmx5IGFzc2VydGl2ZUVsZW1lbnRzOiBIVE1MRWxlbWVudFtdO1xyXG5cclxuICAvLyBUaGUgQW5ub3VuY2VyIG9ubHkgc3BlYWtzIG9uZSBVdHRlcmFuY2UgcGVyIHRoaXMgaW50ZXJ2YWwgb3IgZWxzZSBWb2ljZU92ZXIgcmVhZHMgYWxlcnRzIG91dCBvZiBvcmRlci5cclxuICAvLyBUaGlzIGlzIGFsc28gdGhlIGludGVydmFsIGF0IHdoaWNoIGFsZXJ0IGNvbnRlbnQgaXMgY2xlYXJlZCBmcm9tIHRoZSBET00gb25jZSBzZXQgc28gdGhhdCBpdCBjYW5ub3QgYmUgZm91bmRcclxuICAvLyB3aXRoIHRoZSB2aXJ0dWFsIGN1cnNvciBhZnRlciBzZXR0aW5nLlxyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgQVJJQV9MSVZFX0RFTEFZID0gMjAwO1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHByb3ZpZGVkT3B0aW9ucz86IEFyaWFMaXZlQW5ub3VuY2VyT3B0aW9ucyApIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8QXJpYUxpdmVBbm5vdW5jZXJPcHRpb25zLCBBcmlhTGl2ZUFubm91bmNlclNlbGZPcHRpb25zLCBBbm5vdW5jZXJPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBCeSBkZWZhdWx0LCBkb24ndCBjYXJlIGFib3V0IHJlc3BvbnNlIGNvbGxlY3RvciBQcm9wZXJ0aWVzLCBhcyB0aGV5IGFyZSBkZXNpZ25lZCBmb3IgVm9pY2luZyBtb3JlIHRoYW5cclxuICAgICAgLy8gYXJpYS1saXZlIGRlc2NyaXB0aW9uLlxyXG4gICAgICByZXNwZWN0UmVzcG9uc2VDb2xsZWN0b3JQcm9wZXJ0aWVzOiBmYWxzZSxcclxuICAgICAgbGFuZzogJ2VuJ1xyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICB0aGlzLnBvbGl0ZUVsZW1lbnRJbmRleCA9IDA7XHJcbiAgICB0aGlzLmFzc2VydGl2ZUVsZW1lbnRJbmRleCA9IDA7XHJcblxyXG4gICAgdGhpcy5hcmlhTGl2ZUNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICk7IC8vY29udGFpbmVyIGRpdlxyXG4gICAgdGhpcy5hcmlhTGl2ZUNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoICdsYW5nJywgb3B0aW9ucy5sYW5nICk7XHJcbiAgICB0aGlzLmFyaWFMaXZlQ29udGFpbmVyLnNldEF0dHJpYnV0ZSggJ2lkJywgYGFyaWEtbGl2ZS1lbGVtZW50cy0ke2FyaWFMaXZlQW5ub3VuY2VySW5kZXh9YCApO1xyXG4gICAgdGhpcy5hcmlhTGl2ZUNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoICdzdHlsZScsICdwb3NpdGlvbjogYWJzb2x1dGU7IGxlZnQ6IDBweDsgdG9wOiAwcHg7IHdpZHRoOiAwcHg7IGhlaWdodDogMHB4OyAnICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2xpcDogcmVjdCgwcHggMHB4IDBweCAwcHgpOyBwb2ludGVyLWV2ZW50czogbm9uZTsnICk7XHJcblxyXG4gICAgLy8gQnkgaGF2aW5nIGZvdXIgZWxlbWVudHMgYW5kIGN5Y2xpbmcgdGhyb3VnaCBlYWNoIG9uZSwgd2UgY2FuIGdldCBhcm91bmQgYSBWb2ljZU92ZXIgYnVnIHdoZXJlIGEgbmV3XHJcbiAgICAvLyBhbGVydCB3b3VsZCBpbnRlcnJ1cHQgdGhlIHByZXZpb3VzIGFsZXJ0IGlmIGl0IHdhc24ndCBmaW5pc2hlZCBzcGVha2luZywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zY2VuZXJ5LXBoZXQvaXNzdWVzLzM2MlxyXG4gICAgY29uc3QgcG9saXRlRWxlbWVudENvbnRhaW5lciA9IGNyZWF0ZUJhdGNoT2ZQcmlvcml0eUxpdmVFbGVtZW50cyggQXJpYUxpdmUuUE9MSVRFICk7XHJcbiAgICBjb25zdCBhc3NlcnRpdmVFbGVtZW50Q29udGFpbmVyID0gY3JlYXRlQmF0Y2hPZlByaW9yaXR5TGl2ZUVsZW1lbnRzKCBBcmlhTGl2ZS5BU1NFUlRJVkUgKTtcclxuXHJcbiAgICB0aGlzLmFyaWFMaXZlQ29udGFpbmVyLmFwcGVuZENoaWxkKCBwb2xpdGVFbGVtZW50Q29udGFpbmVyICk7XHJcbiAgICB0aGlzLmFyaWFMaXZlQ29udGFpbmVyLmFwcGVuZENoaWxkKCBhc3NlcnRpdmVFbGVtZW50Q29udGFpbmVyICk7XHJcblxyXG4gICAgdGhpcy5wb2xpdGVFbGVtZW50cyA9IEFycmF5LmZyb20oIHBvbGl0ZUVsZW1lbnRDb250YWluZXIuY2hpbGRyZW4gKSBhcyBIVE1MRWxlbWVudFtdO1xyXG4gICAgdGhpcy5hc3NlcnRpdmVFbGVtZW50cyA9IEFycmF5LmZyb20oIGFzc2VydGl2ZUVsZW1lbnRDb250YWluZXIuY2hpbGRyZW4gKSBhcyBIVE1MRWxlbWVudFtdO1xyXG5cclxuICAgIC8vIGluY3JlbWVudCBpbmRleCBzbyB0aGUgbmV4dCBBcmlhTGl2ZUFubm91bmNlciBpbnN0YW5jZSBoYXMgZGlmZmVyZW50IGlkcyBmb3IgaXRzIGVsZW1lbnRzLlxyXG4gICAgYXJpYUxpdmVBbm5vdW5jZXJJbmRleCsrO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQW5ub3VuY2UgYW4gYWxlcnQsIHNldHRpbmcgdGV4dENvbnRlbnQgdG8gYW4gYXJpYS1saXZlIGVsZW1lbnQuXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIGFubm91bmNlKCBhbm5vdW5jZVRleHQ6IFJlc29sdmVkUmVzcG9uc2UsIHV0dGVyYW5jZTogVXR0ZXJhbmNlLCBwcm92aWRlZE9wdGlvbnM/OiBBcmlhTGl2ZUFubm91bmNlckFubm91bmNlT3B0aW9ucyApOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEFyaWFMaXZlQW5ub3VuY2VyQW5ub3VuY2VPcHRpb25zLCBTZWxmT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gQnkgZGVmYXVsdCwgYWxlcnQgdG8gYSBwb2xpdGUgYXJpYS1saXZlIGVsZW1lbnRcclxuICAgICAgYXJpYUxpdmVQcmlvcml0eTogQXJpYUxpdmUuUE9MSVRFXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBhcmlhLWxpdmUgYW5kIEFUIGhhcyBubyBBUEkgdG8gZGV0ZWN0IHN1Y2Nlc3NmdWwgc3BlZWNoLCB3ZSBjYW4gb25seSBhc3N1bWUgZXZlcnkgYW5ub3VuY2UgaXMgc3VjY2Vzc2Z1bFxyXG4gICAgdGhpcy5oYXNTcG9rZW4gPSB0cnVlO1xyXG5cclxuICAgIC8vIERvbid0IHVwZGF0ZSBpZiBudWxsXHJcbiAgICBpZiAoIGFubm91bmNlVGV4dCApIHtcclxuICAgICAgaWYgKCBpc1RSZWFkT25seVByb3BlcnR5KCBhbm5vdW5jZVRleHQgKSApIHtcclxuICAgICAgICBhbm5vdW5jZVRleHQgPSBhbm5vdW5jZVRleHQudmFsdWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICggb3B0aW9ucy5hcmlhTGl2ZVByaW9yaXR5ID09PSBBcmlhTGl2ZS5QT0xJVEUgKSB7XHJcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMucG9saXRlRWxlbWVudHNbIHRoaXMucG9saXRlRWxlbWVudEluZGV4IF07XHJcbiAgICAgICAgdGhpcy51cGRhdGVMaXZlRWxlbWVudCggZWxlbWVudCwgYW5ub3VuY2VUZXh0LCB1dHRlcmFuY2UgKTtcclxuXHJcbiAgICAgICAgLy8gdXBkYXRlIGluZGV4IGZvciBuZXh0IHRpbWVcclxuICAgICAgICB0aGlzLnBvbGl0ZUVsZW1lbnRJbmRleCA9ICggdGhpcy5wb2xpdGVFbGVtZW50SW5kZXggKyAxICkgJSB0aGlzLnBvbGl0ZUVsZW1lbnRzLmxlbmd0aDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIGlmICggb3B0aW9ucy5hcmlhTGl2ZVByaW9yaXR5ID09PSBBcmlhTGl2ZS5BU1NFUlRJVkUgKSB7XHJcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuYXNzZXJ0aXZlRWxlbWVudHNbIHRoaXMuYXNzZXJ0aXZlRWxlbWVudEluZGV4IF07XHJcbiAgICAgICAgdGhpcy51cGRhdGVMaXZlRWxlbWVudCggZWxlbWVudCwgYW5ub3VuY2VUZXh0LCB1dHRlcmFuY2UgKTtcclxuICAgICAgICAvLyB1cGRhdGUgaW5kZXggZm9yIG5leHQgdGltZVxyXG4gICAgICAgIHRoaXMuYXNzZXJ0aXZlRWxlbWVudEluZGV4ID0gKCB0aGlzLmFzc2VydGl2ZUVsZW1lbnRJbmRleCArIDEgKSAlIHRoaXMuYXNzZXJ0aXZlRWxlbWVudHMubGVuZ3RoO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAndW5zdXBwb3J0ZWQgYXJpYSBsaXZlIHByaW9pcml0eScgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFdpdGggYXJpYS1saXZlIHdlIGRvbid0IGhhdmUgaW5mb3JtYXRpb24gYWJvdXQgd2hlbiB0aGUgc2NyZWVuIHJlYWRlciBpcyBkb25lIHNwZWFraW5nXHJcbiAgICAvLyB0aGUgY29udGVudCwgc28gd2UgaGF2ZSB0byBlbWl0IHRoaXMgcmlnaHQgYXdheVxyXG4gICAgdGhpcy5hbm5vdW5jZW1lbnRDb21wbGV0ZUVtaXR0ZXIuZW1pdCggdXR0ZXJhbmNlLCBhbm5vdW5jZVRleHQgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSBpbXBsZW1lbnRhdGlvbiBvZiBjYW5jZWwgZm9yIEFyaWFMaXZlQW5ub3VuY2VyLiBXZSBkbyBub3Qga25vdyB3aGV0aGVyIHRoZSBBVCBpcyBzcGVha2luZyBjb250ZW50IHNvXHJcbiAgICogdGhpcyBmdW5jdGlvbiBpcyBhIG5vLW9wIGZvciBhcmlhLWxpdmUuXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIGNhbmNlbCgpOiB2b2lkIHtcclxuICAgIC8vIFNlZSBkb2NzXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUaGUgaW1wbGVtZW50YXRpb24gb2YgY2FuY2VsVXR0ZXJhbmNlIGZvciBBcmlhTGl2ZUFubm91bmNlci4gV2UgZG8gbm90IGtub3cgd2hldGhlciB0aGUgQVQgaXMgc3BlYWtpbmcgY29udGVudCBzb1xyXG4gICAqIHRoaXMgZnVuY3Rpb24gaXMgYSBuby1vcCBmb3IgYXJpYS1saXZlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvdmVycmlkZSBjYW5jZWxVdHRlcmFuY2UoIHV0dGVyYW5jZTogVXR0ZXJhbmNlICk6IHZvaWQge1xyXG4gICAgLy8gU2VlIGRvY3NcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSBhbiBlbGVtZW50IHdpdGggdGhlICdhcmlhLWxpdmUnIGF0dHJpYnV0ZSBieSBzZXR0aW5nIGl0cyB0ZXh0IGNvbnRlbnQuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gbGl2ZUVsZW1lbnQgLSB0aGUgSFRNTCBlbGVtZW50IHRoYXQgd2lsbCBzZW5kIHRoZSBhbGVydCB0byB0aGUgYXNzaXN0aXZlIHRlY2hub2xvZ3lcclxuICAgKiBAcGFyYW0gdGV4dENvbnRlbnQgLSB0aGUgY29udGVudCB0byBiZSBhbm5vdW5jZWRcclxuICAgKiBAcGFyYW0gdXR0ZXJhbmNlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVMaXZlRWxlbWVudCggbGl2ZUVsZW1lbnQ6IEhUTUxFbGVtZW50LCB0ZXh0Q29udGVudDogc3RyaW5nIHwgbnVtYmVyLCB1dHRlcmFuY2U6IFV0dGVyYW5jZSApOiB2b2lkIHtcclxuXHJcbiAgICAvLyBmdWxseSBjbGVhciB0aGUgb2xkIHRleHRDb250ZW50IHNvIHRoYXQgc2VxdWVudGlhbCBhbGVydHMgd2l0aCBpZGVudGljYWwgdGV4dCB3aWxsIGJlIGFubm91bmNlZCwgd2hpY2hcclxuICAgIC8vIHNvbWUgc2NyZWVuIHJlYWRlcnMgbWlnaHQgaGF2ZSBwcmV2ZW50ZWRcclxuICAgIGxpdmVFbGVtZW50LnRleHRDb250ZW50ID0gJyc7XHJcblxyXG4gICAgLy8gZWxlbWVudCBtdXN0IGJlIHZpc2libGUgZm9yIGFsZXJ0cyB0byBiZSBzcG9rZW5cclxuICAgIGxpdmVFbGVtZW50LmhpZGRlbiA9IGZhbHNlO1xyXG5cclxuICAgIC8vIFV0dGVyYW5jZVF1ZXVlIGNhbm5vdCBhbm5vdW5jZSBhZ2FpbiB1bnRpbCBhZnRlciB0aGUgZm9sbG93aW5nIHRpbWVvdXRzLlxyXG4gICAgdGhpcy5yZWFkeVRvQW5ub3VuY2UgPSBmYWxzZTtcclxuXHJcbiAgICAvLyBtdXN0IGJlIGRvbmUgYXN5bmNocm9ub3VzbHkgZnJvbSBzZXR0aW5nIGhpZGRlbiBhYm92ZSBvciBlbHNlIHRoZSBzY3JlZW4gcmVhZGVyXHJcbiAgICAvLyB3aWxsIGZhaWwgdG8gcmVhZCB0aGUgY29udGVudFxyXG4gICAgc3RlcFRpbWVyLnNldFRpbWVvdXQoICgpID0+IHtcclxuXHJcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSB1dHRlcmFuY2UgaXMgbm90IG91dCBvZiBkYXRlIHJpZ2h0IGJlZm9yZSBpdCBpcyBhY3R1YWxseSBzZW50IHRvIGFzc2lzdGl2ZSB0ZWNobm9sb2d5XHJcbiAgICAgIGlmICggdXR0ZXJhbmNlLnByZWRpY2F0ZSgpICkge1xyXG5cclxuICAgICAgICBQRE9NVXRpbHMuc2V0VGV4dENvbnRlbnQoIGxpdmVFbGVtZW50LCB0ZXh0Q29udGVudCApO1xyXG5cclxuICAgICAgICAvLyBIaWRlIHRoZSBjb250ZW50IHNvIHRoYXQgaXQgY2FudCBiZSByZWFkIHdpdGggdGhlIHZpcnR1YWwgY3Vyc29yLiBNdXN0IGJlIGRvbmVcclxuICAgICAgICAvLyBiZWhpbmQgYXQgbGVhc3QgMjAwIG1zIGRlbGF5IG9yIGVsc2UgYWxlcnRzIG1heSBiZSBtaXNzZWQgYnkgTlZEQSBhbmQgVm9pY2VPdmVyLCBzZWVcclxuICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvc2NlbmVyeS1waGV0L2lzc3Vlcy80OTFcclxuICAgICAgICBzdGVwVGltZXIuc2V0VGltZW91dCggKCkgPT4ge1xyXG5cclxuICAgICAgICAgIGlmICggcGxhdGZvcm0uc2FmYXJpICkge1xyXG5cclxuICAgICAgICAgICAgLy8gVXNpbmcgYGhpZGRlbmAgcmF0aGVyIHRoYW4gY2xlYXJpbmcgdGV4dENvbnRlbnQgd29ya3MgYmV0dGVyIG9uIG1vYmlsZSBWTyxcclxuICAgICAgICAgICAgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zY2VuZXJ5LXBoZXQvaXNzdWVzLzQ5MFxyXG4gICAgICAgICAgICBsaXZlRWxlbWVudC5oaWRkZW4gPSB0cnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxpdmVFbGVtZW50LnRleHRDb250ZW50ID0gJyc7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgLy8gV2FpdCB1bnRpbCBhZnRlciB0aGlzIHRpbWVvdXQgdG8gbGV0IHRoZSBVdHRlcmFuY2VRdWV1ZSBjYW4gYW5ub3VuY2UgVXR0ZXJhbmNlcyBhZ2Fpbi4gVGhpcyBkZWxheVxyXG4gICAgICAgICAgLy8gc2VlbXMgdG8gYmUgbmVjZXNzYXJ5IHRvIGZvcmNlIFZvaWNlT3ZlciB0byBzcGVhayBhcmlhLWxpdmUgYWxlcnRzIGluIGZpcnN0LWluLWZpcnN0LW91dCBvcmRlci5cclxuICAgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvdXR0ZXJhbmNlLXF1ZXVlL2lzc3Vlcy84OFxyXG4gICAgICAgICAgdGhpcy5yZWFkeVRvQW5ub3VuY2UgPSB0cnVlO1xyXG4gICAgICAgIH0sIEFyaWFMaXZlQW5ub3VuY2VyLkFSSUFfTElWRV9ERUxBWSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHRoaXMucmVhZHlUb0Fubm91bmNlID0gdHJ1ZTsgLy8gSWYgdGhlIHByZWRpY2F0ZSBmYWlscywgd2UgYXJlIHJlYWR5IHRvIGFubm91bmNlIGFnYWluLlxyXG4gICAgICB9XHJcbiAgICB9LCAwICk7XHJcbiAgfVxyXG5cclxuICAvLyBQb3NzaWJsZSB2YWx1ZXMgZm9yIHRoZSBgYXJpYS1saXZlYCBhdHRyaWJ1dGUgKHByaW9yaXR5KSB0aGF0IGNhbiBiZSBhbGVydGVkIChsaWtlIFwicG9saXRlXCIgYW5kXHJcbiAgLy8gXCJhc3NlcnRpdmVcIiksIHNlZSBBcmlhTGl2ZUFubm91bmNlT3B0aW9ucyBmb3IgZGV0YWlscy5cclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEFyaWFMaXZlID0gQXJpYUxpdmU7XHJcbn1cclxuXHJcbnV0dGVyYW5jZVF1ZXVlTmFtZXNwYWNlLnJlZ2lzdGVyKCAnQXJpYUxpdmVBbm5vdW5jZXInLCBBcmlhTGl2ZUFubm91bmNlciApO1xyXG5leHBvcnQgZGVmYXVsdCBBcmlhTGl2ZUFubm91bmNlcjsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFNBQVMsTUFBTSw0QkFBNEI7QUFDbEQsT0FBT0MsV0FBVyxNQUFNLG1DQUFtQztBQUMzRCxPQUFPQyxnQkFBZ0IsTUFBTSx3Q0FBd0M7QUFDckUsT0FBT0MsU0FBUyxNQUFNLGlDQUFpQztBQUN2RCxPQUFPQyxRQUFRLE1BQU0sZ0NBQWdDO0FBQ3JELFNBQVNDLFNBQVMsUUFBUSw2QkFBNkI7QUFDdkQsT0FBT0MsU0FBUyxNQUFzRCxnQkFBZ0I7QUFFdEYsT0FBT0MsdUJBQXVCLE1BQU0sOEJBQThCO0FBRWxFLFNBQVNDLG1CQUFtQixRQUFRLG9DQUFvQzs7QUFFeEU7QUFDQSxNQUFNQyw0QkFBNEIsR0FBRyxDQUFDOztBQUV0QztBQUNBLElBQUlDLHNCQUFzQixHQUFHLENBQUM7O0FBRTlCO0FBQ0EsTUFBTUMsUUFBUSxTQUFTVCxnQkFBZ0IsQ0FBQztFQUMvQlUsV0FBV0EsQ0FBa0JDLGVBQXVCLEVBQUc7SUFBRSxLQUFLLENBQUMsQ0FBQztJQUFDLEtBQXBDQSxlQUF1QixHQUF2QkEsZUFBdUI7RUFBYTtFQUV4RSxPQUF1QkMsTUFBTSxHQUFHLElBQUlILFFBQVEsQ0FBRSxRQUFTLENBQUM7RUFDeEQsT0FBdUJJLFNBQVMsR0FBRyxJQUFJSixRQUFRLENBQUUsV0FBWSxDQUFDO0VBRTlELE9BQXVCSyxXQUFXLEdBQUcsSUFBSWYsV0FBVyxDQUFFVSxRQUFTLENBQUM7QUFDbEU7O0FBRUE7O0FBTUE7QUFDQTtBQUNBO0FBQ0EsU0FBU00saUNBQWlDQSxDQUFFQyxnQkFBMEIsRUFBbUI7RUFDdkYsTUFBTUMsUUFBUSxHQUFHRCxnQkFBZ0IsQ0FBQ0wsZUFBZTtFQUNqRCxNQUFNTyxTQUFTLEdBQUdDLFFBQVEsQ0FBQ0MsYUFBYSxDQUFFLEtBQU0sQ0FBQztFQUNqRCxLQUFNLElBQUlDLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsSUFBSWQsNEJBQTRCLEVBQUVjLENBQUMsRUFBRSxFQUFHO0lBQ3hELE1BQU1DLFlBQVksR0FBR0gsUUFBUSxDQUFDQyxhQUFhLENBQUUsR0FBSSxDQUFDO0lBQ2xERSxZQUFZLENBQUNDLFlBQVksQ0FBRSxJQUFJLEVBQUcsWUFBV2Ysc0JBQXVCLElBQUdTLFFBQVMsSUFBR0ksQ0FBRSxFQUFFLENBQUM7O0lBRXhGO0lBQ0E7SUFDQUMsWUFBWSxDQUFDQyxZQUFZLENBQUUsV0FBVyxFQUFFTixRQUFTLENBQUM7SUFDbERDLFNBQVMsQ0FBQ00sV0FBVyxDQUFFRixZQUFhLENBQUM7RUFDdkM7RUFFQSxPQUFPSixTQUFTO0FBQ2xCO0FBVUEsTUFBTU8saUJBQWlCLFNBQVNyQixTQUFTLENBQUM7RUFFeEM7O0VBTUE7O0VBSUE7RUFDQTtFQUNBO0VBQ0EsT0FBdUJzQixlQUFlLEdBQUcsR0FBRztFQUVyQ2hCLFdBQVdBLENBQUVpQixlQUEwQyxFQUFHO0lBQy9ELE1BQU1DLE9BQU8sR0FBRzNCLFNBQVMsQ0FBMkUsQ0FBQyxDQUFFO01BRXJHO01BQ0E7TUFDQTRCLGtDQUFrQyxFQUFFLEtBQUs7TUFDekNDLElBQUksRUFBRTtJQUNSLENBQUMsRUFBRUgsZUFBZ0IsQ0FBQztJQUVwQixLQUFLLENBQUVDLE9BQVEsQ0FBQztJQUVoQixJQUFJLENBQUNHLGtCQUFrQixHQUFHLENBQUM7SUFDM0IsSUFBSSxDQUFDQyxxQkFBcUIsR0FBRyxDQUFDO0lBRTlCLElBQUksQ0FBQ0MsaUJBQWlCLEdBQUdkLFFBQVEsQ0FBQ0MsYUFBYSxDQUFFLEtBQU0sQ0FBQyxDQUFDLENBQUM7SUFDMUQsSUFBSSxDQUFDYSxpQkFBaUIsQ0FBQ1YsWUFBWSxDQUFFLE1BQU0sRUFBRUssT0FBTyxDQUFDRSxJQUFLLENBQUM7SUFDM0QsSUFBSSxDQUFDRyxpQkFBaUIsQ0FBQ1YsWUFBWSxDQUFFLElBQUksRUFBRyxzQkFBcUJmLHNCQUF1QixFQUFFLENBQUM7SUFDM0YsSUFBSSxDQUFDeUIsaUJBQWlCLENBQUNWLFlBQVksQ0FBRSxPQUFPLEVBQUUsb0VBQW9FLEdBQ3BFLG9EQUFxRCxDQUFDOztJQUVwRztJQUNBO0lBQ0EsTUFBTVcsc0JBQXNCLEdBQUduQixpQ0FBaUMsQ0FBRU4sUUFBUSxDQUFDRyxNQUFPLENBQUM7SUFDbkYsTUFBTXVCLHlCQUF5QixHQUFHcEIsaUNBQWlDLENBQUVOLFFBQVEsQ0FBQ0ksU0FBVSxDQUFDO0lBRXpGLElBQUksQ0FBQ29CLGlCQUFpQixDQUFDVCxXQUFXLENBQUVVLHNCQUF1QixDQUFDO0lBQzVELElBQUksQ0FBQ0QsaUJBQWlCLENBQUNULFdBQVcsQ0FBRVcseUJBQTBCLENBQUM7SUFFL0QsSUFBSSxDQUFDQyxjQUFjLEdBQUdDLEtBQUssQ0FBQ0MsSUFBSSxDQUFFSixzQkFBc0IsQ0FBQ0ssUUFBUyxDQUFrQjtJQUNwRixJQUFJLENBQUNDLGlCQUFpQixHQUFHSCxLQUFLLENBQUNDLElBQUksQ0FBRUgseUJBQXlCLENBQUNJLFFBQVMsQ0FBa0I7O0lBRTFGO0lBQ0EvQixzQkFBc0IsRUFBRTtFQUMxQjs7RUFFQTtBQUNGO0FBQ0E7RUFDa0JpQyxRQUFRQSxDQUFFQyxZQUE4QixFQUFFQyxTQUFvQixFQUFFaEIsZUFBa0QsRUFBUztJQUV6SSxNQUFNQyxPQUFPLEdBQUczQixTQUFTLENBQWdELENBQUMsQ0FBRTtNQUUxRTtNQUNBZSxnQkFBZ0IsRUFBRVAsUUFBUSxDQUFDRztJQUM3QixDQUFDLEVBQUVlLGVBQWdCLENBQUM7O0lBRXBCO0lBQ0EsSUFBSSxDQUFDaUIsU0FBUyxHQUFHLElBQUk7O0lBRXJCO0lBQ0EsSUFBS0YsWUFBWSxFQUFHO01BQ2xCLElBQUtwQyxtQkFBbUIsQ0FBRW9DLFlBQWEsQ0FBQyxFQUFHO1FBQ3pDQSxZQUFZLEdBQUdBLFlBQVksQ0FBQ0csS0FBSztNQUNuQztNQUVBLElBQUtqQixPQUFPLENBQUNaLGdCQUFnQixLQUFLUCxRQUFRLENBQUNHLE1BQU0sRUFBRztRQUNsRCxNQUFNa0MsT0FBTyxHQUFHLElBQUksQ0FBQ1YsY0FBYyxDQUFFLElBQUksQ0FBQ0wsa0JBQWtCLENBQUU7UUFDOUQsSUFBSSxDQUFDZ0IsaUJBQWlCLENBQUVELE9BQU8sRUFBRUosWUFBWSxFQUFFQyxTQUFVLENBQUM7O1FBRTFEO1FBQ0EsSUFBSSxDQUFDWixrQkFBa0IsR0FBRyxDQUFFLElBQUksQ0FBQ0Esa0JBQWtCLEdBQUcsQ0FBQyxJQUFLLElBQUksQ0FBQ0ssY0FBYyxDQUFDWSxNQUFNO01BQ3hGLENBQUMsTUFDSSxJQUFLcEIsT0FBTyxDQUFDWixnQkFBZ0IsS0FBS1AsUUFBUSxDQUFDSSxTQUFTLEVBQUc7UUFDMUQsTUFBTWlDLE9BQU8sR0FBRyxJQUFJLENBQUNOLGlCQUFpQixDQUFFLElBQUksQ0FBQ1IscUJBQXFCLENBQUU7UUFDcEUsSUFBSSxDQUFDZSxpQkFBaUIsQ0FBRUQsT0FBTyxFQUFFSixZQUFZLEVBQUVDLFNBQVUsQ0FBQztRQUMxRDtRQUNBLElBQUksQ0FBQ1gscUJBQXFCLEdBQUcsQ0FBRSxJQUFJLENBQUNBLHFCQUFxQixHQUFHLENBQUMsSUFBSyxJQUFJLENBQUNRLGlCQUFpQixDQUFDUSxNQUFNO01BQ2pHLENBQUMsTUFDSTtRQUNIQyxNQUFNLElBQUlBLE1BQU0sQ0FBRSxLQUFLLEVBQUUsaUNBQWtDLENBQUM7TUFDOUQ7SUFDRjs7SUFFQTtJQUNBO0lBQ0EsSUFBSSxDQUFDQywyQkFBMkIsQ0FBQ0MsSUFBSSxDQUFFUixTQUFTLEVBQUVELFlBQWEsQ0FBQztFQUNsRTs7RUFFQTtBQUNGO0FBQ0E7QUFDQTtFQUNrQlUsTUFBTUEsQ0FBQSxFQUFTO0lBQzdCO0VBQUE7O0VBR0Y7QUFDRjtBQUNBO0FBQ0E7RUFDa0JDLGVBQWVBLENBQUVWLFNBQW9CLEVBQVM7SUFDNUQ7RUFBQTs7RUFHRjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNVSSxpQkFBaUJBLENBQUVPLFdBQXdCLEVBQUVDLFdBQTRCLEVBQUVaLFNBQW9CLEVBQVM7SUFFOUc7SUFDQTtJQUNBVyxXQUFXLENBQUNDLFdBQVcsR0FBRyxFQUFFOztJQUU1QjtJQUNBRCxXQUFXLENBQUNFLE1BQU0sR0FBRyxLQUFLOztJQUUxQjtJQUNBLElBQUksQ0FBQ0MsZUFBZSxHQUFHLEtBQUs7O0lBRTVCO0lBQ0E7SUFDQTNELFNBQVMsQ0FBQzRELFVBQVUsQ0FBRSxNQUFNO01BRTFCO01BQ0EsSUFBS2YsU0FBUyxDQUFDZ0IsU0FBUyxDQUFDLENBQUMsRUFBRztRQUUzQnhELFNBQVMsQ0FBQ3lELGNBQWMsQ0FBRU4sV0FBVyxFQUFFQyxXQUFZLENBQUM7O1FBRXBEO1FBQ0E7UUFDQTtRQUNBekQsU0FBUyxDQUFDNEQsVUFBVSxDQUFFLE1BQU07VUFFMUIsSUFBS3hELFFBQVEsQ0FBQzJELE1BQU0sRUFBRztZQUVyQjtZQUNBO1lBQ0FQLFdBQVcsQ0FBQ0UsTUFBTSxHQUFHLElBQUk7VUFDM0IsQ0FBQyxNQUNJO1lBQ0hGLFdBQVcsQ0FBQ0MsV0FBVyxHQUFHLEVBQUU7VUFDOUI7O1VBRUE7VUFDQTtVQUNBO1VBQ0EsSUFBSSxDQUFDRSxlQUFlLEdBQUcsSUFBSTtRQUM3QixDQUFDLEVBQUVoQyxpQkFBaUIsQ0FBQ0MsZUFBZ0IsQ0FBQztNQUN4QyxDQUFDLE1BQ0k7UUFDSCxJQUFJLENBQUMrQixlQUFlLEdBQUcsSUFBSSxDQUFDLENBQUM7TUFDL0I7SUFDRixDQUFDLEVBQUUsQ0FBRSxDQUFDO0VBQ1I7O0VBRUE7RUFDQTtFQUNBLE9BQXVCaEQsUUFBUSxHQUFHQSxRQUFRO0FBQzVDO0FBRUFKLHVCQUF1QixDQUFDeUQsUUFBUSxDQUFFLG1CQUFtQixFQUFFckMsaUJBQWtCLENBQUM7QUFDMUUsZUFBZUEsaUJBQWlCIiwiaWdub3JlTGlzdCI6W119