// Copyright 2023-2024, University of Colorado Boulder

/* eslint-env node */

/**
 * Shortens changeable symbols in a WGSL string
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

/**
 * @param {string} str
 * @param symbolInfo {{
 *   preamble: string,
 *   symbols: string[],
 *   newSymbols: string[],
 *   symbolCounts: Record<string,number>,
 *   floatZeroSymbol: string,
 *   floatOneSymbol: string,
 *   intZeroSymbol: string,
 *   intOneSymbol: string
 * }}
 * @returns {string}
 */
const wgslMangle = (str, symbolInfo) => {
  const symbols = symbolInfo.symbols;
  const newSymbols = symbolInfo.newSymbols;
  const symbolCounts = symbolInfo.symbolCounts;
  const floatZeroSymbol = symbolInfo.floatZeroSymbol;
  const floatOneSymbol = symbolInfo.floatOneSymbol;
  const intZeroSymbol = symbolInfo.intZeroSymbol;
  const intOneSymbol = symbolInfo.intOneSymbol;

  // Replace symbols[ i ] with newSymbols[ i ], but with:
  // 1. No going back, since some newSymbols might be in symbols.
  // 2. Ignore imports
  // 3. Strip out unused constants

  // Regexp that should match any symbol that is to be replaced (with 1char on each side)
  let firstIndex = 0;

  // eslint-disable-next-line no-constant-condition
  while (true) {
    const match = new RegExp(`[^\\w](${symbols.join('|')})[^\\w]`).exec(str.slice(firstIndex));
    if (!match) {
      break;
    }
    const name = match[1];
    const index = symbols.indexOf(name);
    if (index < 0) {
      throw new Error('bad regexp');
    }
    const index0 = firstIndex + match.index + 1;
    const index1 = index0 + name.length;
    const before = str.substring(0, index0);
    const after = str.substring(index1);

    // We still have to do import stuff
    if (!before.endsWith('#import ')) {
      // Try to strip out unused variables
      const afterMatch = /[=]\d+u;/.exec(after);
      if (symbolCounts[name] === 1 && before.endsWith('const ') && afterMatch) {
        const newBefore = before.slice(0, before.length - 'const '.length);
        str = newBefore + after.slice(afterMatch[0].length);
        firstIndex = newBefore.length - 1;
      } else {
        const newBefore = before + newSymbols[index];
        str = newBefore + after;
        firstIndex = newBefore.length - 1;
      }
    } else {
      firstIndex = index1 - 1;
    }
  }

  // Replace some numeric literals with replacement symbols that are shorter(!)
  str = str.replace(/([^0-9a-fA-FxX])0\.([^0-9a-fA-FxXeEfh:pP])/g, (m, before, after) => {
    return before + floatZeroSymbol + after;
  });
  str = str.replace(/([^0-9a-fA-FxX])1\.([^0-9a-fA-FxXeEfh:pP])/g, (m, before, after) => {
    return before + floatOneSymbol + after;
  });
  str = str.replace(/([^0-9a-fA-FxX])0u([^0-9a-fA-FxXeEfh:pP])/g, (m, before, after) => {
    return before + intZeroSymbol + after;
  });
  str = str.replace(/([^0-9a-fA-FxX])1u([^0-9a-fA-FxXeEfh:pP])/g, (m, before, after) => {
    return before + intOneSymbol + after;
  });

  // Remove whitespace around the replacement symbols, since it won't be interpreted as a literal
  [floatZeroSymbol, floatOneSymbol, intZeroSymbol, intOneSymbol].forEach(symbol => {
    str = str.replace(new RegExp(`- ${symbol}`), `-${symbol}`);
  });
  return str;
};
module.exports = wgslMangle;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ3Z3NsTWFuZ2xlIiwic3RyIiwic3ltYm9sSW5mbyIsInN5bWJvbHMiLCJuZXdTeW1ib2xzIiwic3ltYm9sQ291bnRzIiwiZmxvYXRaZXJvU3ltYm9sIiwiZmxvYXRPbmVTeW1ib2wiLCJpbnRaZXJvU3ltYm9sIiwiaW50T25lU3ltYm9sIiwiZmlyc3RJbmRleCIsIm1hdGNoIiwiUmVnRXhwIiwiam9pbiIsImV4ZWMiLCJzbGljZSIsIm5hbWUiLCJpbmRleCIsImluZGV4T2YiLCJFcnJvciIsImluZGV4MCIsImluZGV4MSIsImxlbmd0aCIsImJlZm9yZSIsInN1YnN0cmluZyIsImFmdGVyIiwiZW5kc1dpdGgiLCJhZnRlck1hdGNoIiwibmV3QmVmb3JlIiwicmVwbGFjZSIsIm0iLCJmb3JFYWNoIiwic3ltYm9sIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIndnc2xNYW5nbGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjMtMjAyNCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKiBlc2xpbnQtZW52IG5vZGUgKi9cclxuXHJcbi8qKlxyXG4gKiBTaG9ydGVucyBjaGFuZ2VhYmxlIHN5bWJvbHMgaW4gYSBXR1NMIHN0cmluZ1xyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBzdHJcclxuICogQHBhcmFtIHN5bWJvbEluZm8ge3tcclxuICogICBwcmVhbWJsZTogc3RyaW5nLFxyXG4gKiAgIHN5bWJvbHM6IHN0cmluZ1tdLFxyXG4gKiAgIG5ld1N5bWJvbHM6IHN0cmluZ1tdLFxyXG4gKiAgIHN5bWJvbENvdW50czogUmVjb3JkPHN0cmluZyxudW1iZXI+LFxyXG4gKiAgIGZsb2F0WmVyb1N5bWJvbDogc3RyaW5nLFxyXG4gKiAgIGZsb2F0T25lU3ltYm9sOiBzdHJpbmcsXHJcbiAqICAgaW50WmVyb1N5bWJvbDogc3RyaW5nLFxyXG4gKiAgIGludE9uZVN5bWJvbDogc3RyaW5nXHJcbiAqIH19XHJcbiAqIEByZXR1cm5zIHtzdHJpbmd9XHJcbiAqL1xyXG5jb25zdCB3Z3NsTWFuZ2xlID0gKCBzdHIsIHN5bWJvbEluZm8gKSA9PiB7XHJcbiAgY29uc3Qgc3ltYm9scyA9IHN5bWJvbEluZm8uc3ltYm9scztcclxuICBjb25zdCBuZXdTeW1ib2xzID0gc3ltYm9sSW5mby5uZXdTeW1ib2xzO1xyXG4gIGNvbnN0IHN5bWJvbENvdW50cyA9IHN5bWJvbEluZm8uc3ltYm9sQ291bnRzO1xyXG4gIGNvbnN0IGZsb2F0WmVyb1N5bWJvbCA9IHN5bWJvbEluZm8uZmxvYXRaZXJvU3ltYm9sO1xyXG4gIGNvbnN0IGZsb2F0T25lU3ltYm9sID0gc3ltYm9sSW5mby5mbG9hdE9uZVN5bWJvbDtcclxuICBjb25zdCBpbnRaZXJvU3ltYm9sID0gc3ltYm9sSW5mby5pbnRaZXJvU3ltYm9sO1xyXG4gIGNvbnN0IGludE9uZVN5bWJvbCA9IHN5bWJvbEluZm8uaW50T25lU3ltYm9sO1xyXG5cclxuICAvLyBSZXBsYWNlIHN5bWJvbHNbIGkgXSB3aXRoIG5ld1N5bWJvbHNbIGkgXSwgYnV0IHdpdGg6XHJcbiAgLy8gMS4gTm8gZ29pbmcgYmFjaywgc2luY2Ugc29tZSBuZXdTeW1ib2xzIG1pZ2h0IGJlIGluIHN5bWJvbHMuXHJcbiAgLy8gMi4gSWdub3JlIGltcG9ydHNcclxuICAvLyAzLiBTdHJpcCBvdXQgdW51c2VkIGNvbnN0YW50c1xyXG5cclxuICAvLyBSZWdleHAgdGhhdCBzaG91bGQgbWF0Y2ggYW55IHN5bWJvbCB0aGF0IGlzIHRvIGJlIHJlcGxhY2VkICh3aXRoIDFjaGFyIG9uIGVhY2ggc2lkZSlcclxuICBsZXQgZmlyc3RJbmRleCA9IDA7XHJcblxyXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zdGFudC1jb25kaXRpb25cclxuICB3aGlsZSAoIHRydWUgKSB7XHJcbiAgICBjb25zdCBtYXRjaCA9IG5ldyBSZWdFeHAoIGBbXlxcXFx3XSgke3N5bWJvbHMuam9pbiggJ3wnICl9KVteXFxcXHddYCApLmV4ZWMoIHN0ci5zbGljZSggZmlyc3RJbmRleCApICk7XHJcbiAgICBpZiAoICFtYXRjaCApIHtcclxuICAgICAgYnJlYWs7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbmFtZSA9IG1hdGNoWyAxIF07XHJcbiAgICBjb25zdCBpbmRleCA9IHN5bWJvbHMuaW5kZXhPZiggbmFtZSApO1xyXG4gICAgaWYgKCBpbmRleCA8IDAgKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvciggJ2JhZCByZWdleHAnICk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBpbmRleDAgPSBmaXJzdEluZGV4ICsgbWF0Y2guaW5kZXggKyAxO1xyXG4gICAgY29uc3QgaW5kZXgxID0gaW5kZXgwICsgbmFtZS5sZW5ndGg7XHJcbiAgICBjb25zdCBiZWZvcmUgPSBzdHIuc3Vic3RyaW5nKCAwLCBpbmRleDAgKTtcclxuICAgIGNvbnN0IGFmdGVyID0gc3RyLnN1YnN0cmluZyggaW5kZXgxICk7XHJcblxyXG4gICAgLy8gV2Ugc3RpbGwgaGF2ZSB0byBkbyBpbXBvcnQgc3R1ZmZcclxuICAgIGlmICggIWJlZm9yZS5lbmRzV2l0aCggJyNpbXBvcnQgJyApICkge1xyXG4gICAgICAvLyBUcnkgdG8gc3RyaXAgb3V0IHVudXNlZCB2YXJpYWJsZXNcclxuICAgICAgY29uc3QgYWZ0ZXJNYXRjaCA9IC9bPV1cXGQrdTsvLmV4ZWMoIGFmdGVyICk7XHJcblxyXG4gICAgICBpZiAoIHN5bWJvbENvdW50c1sgbmFtZSBdID09PSAxICYmIGJlZm9yZS5lbmRzV2l0aCggJ2NvbnN0ICcgKSAmJiBhZnRlck1hdGNoICkge1xyXG4gICAgICAgIGNvbnN0IG5ld0JlZm9yZSA9IGJlZm9yZS5zbGljZSggMCwgYmVmb3JlLmxlbmd0aCAtICdjb25zdCAnLmxlbmd0aCApO1xyXG4gICAgICAgIHN0ciA9IG5ld0JlZm9yZSArIGFmdGVyLnNsaWNlKCBhZnRlck1hdGNoWyAwIF0ubGVuZ3RoICk7XHJcbiAgICAgICAgZmlyc3RJbmRleCA9IG5ld0JlZm9yZS5sZW5ndGggLSAxO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IG5ld0JlZm9yZSA9IGJlZm9yZSArIG5ld1N5bWJvbHNbIGluZGV4IF07XHJcbiAgICAgICAgc3RyID0gbmV3QmVmb3JlICsgYWZ0ZXI7XHJcbiAgICAgICAgZmlyc3RJbmRleCA9IG5ld0JlZm9yZS5sZW5ndGggLSAxO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgZmlyc3RJbmRleCA9IGluZGV4MSAtIDE7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBSZXBsYWNlIHNvbWUgbnVtZXJpYyBsaXRlcmFscyB3aXRoIHJlcGxhY2VtZW50IHN5bWJvbHMgdGhhdCBhcmUgc2hvcnRlcighKVxyXG4gIHN0ciA9IHN0ci5yZXBsYWNlKCAvKFteMC05YS1mQS1GeFhdKTBcXC4oW14wLTlhLWZBLUZ4WGVFZmg6cFBdKS9nLCAoIG0sIGJlZm9yZSwgYWZ0ZXIgKSA9PiB7XHJcbiAgICByZXR1cm4gYmVmb3JlICsgZmxvYXRaZXJvU3ltYm9sICsgYWZ0ZXI7XHJcbiAgfSApO1xyXG4gIHN0ciA9IHN0ci5yZXBsYWNlKCAvKFteMC05YS1mQS1GeFhdKTFcXC4oW14wLTlhLWZBLUZ4WGVFZmg6cFBdKS9nLCAoIG0sIGJlZm9yZSwgYWZ0ZXIgKSA9PiB7XHJcbiAgICByZXR1cm4gYmVmb3JlICsgZmxvYXRPbmVTeW1ib2wgKyBhZnRlcjtcclxuICB9ICk7XHJcbiAgc3RyID0gc3RyLnJlcGxhY2UoIC8oW14wLTlhLWZBLUZ4WF0pMHUoW14wLTlhLWZBLUZ4WGVFZmg6cFBdKS9nLCAoIG0sIGJlZm9yZSwgYWZ0ZXIgKSA9PiB7XHJcbiAgICByZXR1cm4gYmVmb3JlICsgaW50WmVyb1N5bWJvbCArIGFmdGVyO1xyXG4gIH0gKTtcclxuICBzdHIgPSBzdHIucmVwbGFjZSggLyhbXjAtOWEtZkEtRnhYXSkxdShbXjAtOWEtZkEtRnhYZUVmaDpwUF0pL2csICggbSwgYmVmb3JlLCBhZnRlciApID0+IHtcclxuICAgIHJldHVybiBiZWZvcmUgKyBpbnRPbmVTeW1ib2wgKyBhZnRlcjtcclxuICB9ICk7XHJcblxyXG4gIC8vIFJlbW92ZSB3aGl0ZXNwYWNlIGFyb3VuZCB0aGUgcmVwbGFjZW1lbnQgc3ltYm9scywgc2luY2UgaXQgd29uJ3QgYmUgaW50ZXJwcmV0ZWQgYXMgYSBsaXRlcmFsXHJcbiAgWyBmbG9hdFplcm9TeW1ib2wsIGZsb2F0T25lU3ltYm9sLCBpbnRaZXJvU3ltYm9sLCBpbnRPbmVTeW1ib2wgXS5mb3JFYWNoKCBzeW1ib2wgPT4ge1xyXG4gICAgc3RyID0gc3RyLnJlcGxhY2UoIG5ldyBSZWdFeHAoIGAtICR7c3ltYm9sfWAgKSwgYC0ke3N5bWJvbH1gICk7XHJcbiAgfSApO1xyXG5cclxuICByZXR1cm4gc3RyO1xyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB3Z3NsTWFuZ2xlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTUEsVUFBVSxHQUFHQSxDQUFFQyxHQUFHLEVBQUVDLFVBQVUsS0FBTTtFQUN4QyxNQUFNQyxPQUFPLEdBQUdELFVBQVUsQ0FBQ0MsT0FBTztFQUNsQyxNQUFNQyxVQUFVLEdBQUdGLFVBQVUsQ0FBQ0UsVUFBVTtFQUN4QyxNQUFNQyxZQUFZLEdBQUdILFVBQVUsQ0FBQ0csWUFBWTtFQUM1QyxNQUFNQyxlQUFlLEdBQUdKLFVBQVUsQ0FBQ0ksZUFBZTtFQUNsRCxNQUFNQyxjQUFjLEdBQUdMLFVBQVUsQ0FBQ0ssY0FBYztFQUNoRCxNQUFNQyxhQUFhLEdBQUdOLFVBQVUsQ0FBQ00s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