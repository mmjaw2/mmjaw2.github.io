// Copyright 2017-2024, University of Colorado Boulder

/**
 * Creates an object that stores information about all dependencies (including their SHAs and current branches)
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

const assert = require('assert');
const ChipperStringUtils = require('../common/ChipperStringUtils');
const execute = require('../../../perennial-alias/js/common/execute');
const getPhetLibs = require('./getPhetLibs');
const grunt = require('grunt');

// Our definition of an allowed simName is defined in the buildServer: https://github.com/phetsims/perennial/blob/78025b7ae6064e9ab5260cea5e532f3bf24c3ec8/js/build-server/taskWorker.js#L99-L98
// We don't want to be this strict though, because 3rd parties are allowed to name sims to be whatever they want. So
// for the purposes of dependencies, we just need to make sure it is a name, and not a path.
const simNameRegex = /^[^/]+$/;

/**
 * Returns an object in the dependencies.json format. Keys are repo names (or 'comment'). Repo keys have 'sha' and 'branch' fields.
 * @public
 *
 * @param {string} repo
 * @returns {Promise.<Object>} - In the dependencies.json format. JSON.stringify if you want to output to a file
 */
module.exports = async function getDependencies(repo) {
  const packageObject = grunt.file.readJSON(`../${repo}/package.json`);
  const version = packageObject.version;

  // Accumulate dependencies for all brands
  const dependencies = getPhetLibs(repo).filter(dependency => dependency !== 'babel'); // Remove babel since it should be kept at main

  // We need to check dependencies for the main brand, so we can know what is guaranteed to be public
  const mainDependencies = getPhetLibs(repo, 'phet').filter(dependency => dependency !== 'babel');
  grunt.log.debug(`Scanning dependencies from:\n${dependencies.toString()}`);
  const dependenciesInfo = {
    comment: `# ${repo} ${version} ${new Date().toString()}`
  };
  for (const dependency of dependencies) {
    assert(!dependenciesInfo.dependency, `there was already a dependency named ${dependency}`);
    if (!simNameRegex.test(dependency)) {
      throw new Error(`Dependency name is not valid: ${dependency}`);
    } else if (!grunt.file.exists(`../${dependency}`)) {
      if (mainDependencies.includes(dependency)) {
        throw new Error(`Dependency not found: ${dependency}`);
      }

      // NOTE NOTE NOTE: This error message is checked for on the perennial build side (it will fail the build). Do NOT change this without changing that.
      grunt.log.warn(`WARNING404: Skipping potentially non-public dependency ${dependency}`);
      continue;
    }
    let sha = null;
    let branch = null;
    try {
      sha = (await execute('git', ['rev-parse', 'HEAD'], `../${dependency}`)).trim();
      branch = (await execute('git', ['rev-parse', '--abbrev-ref', 'HEAD'], `../${dependency}`)).trim();
    } catch (e) {
      // We support repos that are not git repositories, see https://github.com/phetsims/chipper/issues/1011
      console.log(`Did not find git information for ${dependency}`);
    }
    grunt.log.debug(`${ChipperStringUtils.padString(dependency, 20) + branch} ${sha}`);
    dependenciesInfo[dependency] = {
      sha: sha,
      branch: branch
    };
  }
  return dependenciesInfo;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhc3NlcnQiLCJyZXF1aXJlIiwiQ2hpcHBlclN0cmluZ1V0aWxzIiwiZXhlY3V0ZSIsImdldFBoZXRMaWJzIiwiZ3J1bnQiLCJzaW1OYW1lUmVnZXgiLCJtb2R1bGUiLCJleHBvcnRzIiwiZ2V0RGVwZW5kZW5jaWVzIiwicmVwbyIsInBhY2thZ2VPYmplY3QiLCJmaWxlIiwicmVhZEpTT04iLCJ2ZXJzaW9uIiwiZGVwZW5kZW5jaWVzIiwiZmlsdGVyIiwiZGVwZW5kZW5jeSIsIm1haW5EZXBlbmRlbmNpZXMiLCJsb2ciLCJkZWJ1ZyIsInRvU3RyaW5nIiwiZGVwZW5kZW5jaWVzSW5mbyIsImNvbW1lbnQiLCJEYXRlIiwidGVzdCIsIkVycm9yIiwiZXhpc3RzIiwiaW5jbHVkZXMiLCJ3YXJuIiwic2hhIiwiYnJhbmNoIiwidHJpbSIsImUiLCJjb25zb2xlIiwicGFkU3RyaW5nIl0sInNvdXJjZXMiOlsiZ2V0RGVwZW5kZW5jaWVzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LTIwMjQsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgYW4gb2JqZWN0IHRoYXQgc3RvcmVzIGluZm9ybWF0aW9uIGFib3V0IGFsbCBkZXBlbmRlbmNpZXMgKGluY2x1ZGluZyB0aGVpciBTSEFzIGFuZCBjdXJyZW50IGJyYW5jaGVzKVxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuXHJcbmNvbnN0IGFzc2VydCA9IHJlcXVpcmUoICdhc3NlcnQnICk7XHJcbmNvbnN0IENoaXBwZXJTdHJpbmdVdGlscyA9IHJlcXVpcmUoICcuLi9jb21tb24vQ2hpcHBlclN0cmluZ1V0aWxzJyApO1xyXG5jb25zdCBleGVjdXRlID0gcmVxdWlyZSggJy4uLy4uLy4uL3BlcmVubmlhbC1hbGlhcy9qcy9jb21tb24vZXhlY3V0ZScgKTtcclxuY29uc3QgZ2V0UGhldExpYnMgPSByZXF1aXJlKCAnLi9nZXRQaGV0TGlicycgKTtcclxuY29uc3QgZ3J1bnQgPSByZXF1aXJlKCAnZ3J1bnQnICk7XHJcblxyXG4vLyBPdXIgZGVmaW5pdGlvbiBvZiBhbiBhbGxvd2VkIHNpbU5hbWUgaXMgZGVmaW5lZCBpbiB0aGUgYnVpbGRTZXJ2ZXI6IGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9wZXJlbm5pYWwvYmxvYi83ODAyNWI3YWU2MDY0ZTlhYjUyNjBjZWE1ZTUzMmYzYmYyNGMzZWM4L2pzL2J1aWxkLXNlcnZlci90YXNrV29ya2VyLmpzI0w5OS1MOThcclxuLy8gV2UgZG9uJ3Qgd2FudCB0byBiZSB0aGlzIHN0cmljdCB0aG91Z2gsIGJlY2F1c2UgM3JkIHBhcnRpZXMgYXJlIGFsbG93ZWQgdG8gbmFtZSBzaW1zIHRvIGJlIHdoYXRldmVyIHRoZXkgd2FudC4gU29cclxuLy8gZm9yIHRoZSBwdXJwb3NlcyBvZiBkZXBlbmRlbmNpZXMsIHdlIGp1c3QgbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgYSBuYW1lLCBhbmQgbm90IGEgcGF0aC5cclxuY29uc3Qgc2ltTmFtZVJlZ2V4ID0gL15bXi9dKyQvO1xyXG5cclxuLyoqXHJcbiAqIFJldHVybnMgYW4gb2JqZWN0IGluIHRoZSBkZXBlbmRlbmNpZXMuanNvbiBmb3JtYXQuIEtleXMgYXJlIHJlcG8gbmFtZXMgKG9yICdjb21tZW50JykuIFJlcG8ga2V5cyBoYXZlICdzaGEnIGFuZCAnYnJhbmNoJyBmaWVsZHMuXHJcbiAqIEBwdWJsaWNcclxuICpcclxuICogQHBhcmFtIHtzdHJpbmd9IHJlcG9cclxuICogQHJldHVybnMge1Byb21pc2UuPE9iamVjdD59IC0gSW4gdGhlIGRlcGVuZGVuY2llcy5qc29uIGZvcm1hdC4gSlNPTi5zdHJpbmdpZnkgaWYgeW91IHdhbnQgdG8gb3V0cHV0IHRvIGEgZmlsZVxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiBnZXREZXBlbmRlbmNpZXMoIHJlcG8gKSB7XHJcblxyXG4gIGNvbnN0IHBhY2thZ2VPYmplY3QgPSBncnVudC5maWxlLnJlYWRKU09OKCBgLi4vJHtyZXBvfS9wYWNrYWdlLmpzb25gICk7XHJcbiAgY29uc3QgdmVyc2lvbiA9IHBhY2thZ2VPYmplY3QudmVyc2lvbjtcclxuXHJcbiAgLy8gQWNjdW11bGF0ZSBkZXBlbmRlbmNpZXMgZm9yIGFsbCBicmFuZHNcclxuICBjb25zdCBkZXBlbmRlbmNpZXMgPSBnZXRQaGV0TGlicyggcmVwbyApLmZpbHRlciggZGVwZW5kZW5jeSA9PiBkZXBlbmRlbmN5ICE9PSAnYmFiZWwnICk7IC8vIFJlbW92ZSBiYWJlbCBzaW5jZSBpdCBzaG91bGQgYmUga2VwdCBhdCBtYWluXHJcblxyXG4gIC8vIFdlIG5lZWQgdG8gY2hlY2sgZGVwZW5kZW5jaWVzIGZvciB0aGUgbWFpbiBicmFuZCwgc28gd2UgY2FuIGtub3cgd2hhdCBpcyBndWFyYW50ZWVkIHRvIGJlIHB1YmxpY1xyXG4gIGNvbnN0IG1haW5EZXBlbmRlbmNpZXMgPSBnZXRQaGV0TGlicyggcmVwbywgJ3BoZXQnICkuZmlsdGVyKCBkZXBlbmRlbmN5ID0+IGRlcGVuZGVuY3kgIT09ICdiYWJlbCcgKTtcclxuXHJcbiAgZ3J1bnQubG9nLmRlYnVnKCBgU2Nhbm5pbmcgZGVwZW5kZW5jaWVzIGZyb206XFxuJHtkZXBlbmRlbmNpZXMudG9TdHJpbmcoKX1gICk7XHJcblxyXG4gIGNvbnN0IGRlcGVuZGVuY2llc0luZm8gPSB7XHJcbiAgICBjb21tZW50OiBgIyAke3JlcG99ICR7dmVyc2lvbn0gJHtuZXcgRGF0ZSgpLnRvU3RyaW5nKCl9YFxyXG4gIH07XHJcblxyXG4gIGZvciAoIGNvbnN0IGRlcGVuZGVuY3kgb2YgZGVwZW5kZW5jaWVzICkge1xyXG4gICAgYXNzZXJ0KCAhZGVwZW5kZW5jaWVzSW5mby5kZXBlbmRlbmN5LCBgdGhlcmUgd2FzIGFscmVhZHkgYSBkZXBlbmRlbmN5IG5hbWVkICR7ZGVwZW5kZW5jeX1gICk7XHJcblxyXG4gICAgaWYgKCAhc2ltTmFtZVJlZ2V4LnRlc3QoIGRlcGVuZGVuY3kgKSApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCBgRGVwZW5kZW5jeSBuYW1lIGlzIG5vdCB2YWxpZDogJHtkZXBlbmRlbmN5fWAgKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCAhZ3J1bnQuZmlsZS5leGlzdHMoIGAuLi8ke2RlcGVuZGVuY3l9YCApICkge1xyXG4gICAgICBpZiAoIG1haW5EZXBlbmRlbmNpZXMuaW5jbHVkZXMoIGRlcGVuZGVuY3kgKSApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIGBEZXBlbmRlbmN5IG5vdCBmb3VuZDogJHtkZXBlbmRlbmN5fWAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gTk9URSBOT1RFIE5PVEU6IFRoaXMgZXJyb3IgbWVzc2FnZSBpcyBjaGVja2VkIGZvciBvbiB0aGUgcGVyZW5uaWFsIGJ1aWxkIHNpZGUgKGl0IHdpbGwgZmFpbCB0aGUgYnVpbGQpLiBEbyBOT1QgY2hhbmdlIHRoaXMgd2l0aG91dCBjaGFuZ2luZyB0aGF0LlxyXG4gICAgICBncnVudC5sb2cud2FybiggYFdBUk5JTkc0MDQ6IFNraXBwaW5nIHBvdGVudGlhbGx5IG5vbi1wdWJsaWMgZGVwZW5kZW5jeSAke2RlcGVuZGVuY3l9YCApO1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2hhID0gbnVsbDtcclxuICAgIGxldCBicmFuY2ggPSBudWxsO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIHNoYSA9ICggYXdhaXQgZXhlY3V0ZSggJ2dpdCcsIFsgJ3Jldi1wYXJzZScsICdIRUFEJyBdLCBgLi4vJHtkZXBlbmRlbmN5fWAgKSApLnRyaW0oKTtcclxuICAgICAgYnJhbmNoID0gKCBhd2FpdCBleGVjdXRlKCAnZ2l0JywgWyAncmV2LXBhcnNlJywgJy0tYWJicmV2LXJlZicsICdIRUFEJyBdLCBgLi4vJHtkZXBlbmRlbmN5fWAgKSApLnRyaW0oKTtcclxuICAgIH1cclxuICAgIGNhdGNoKCBlICkge1xyXG4gICAgICAvLyBXZSBzdXBwb3J0IHJlcG9zIHRoYXQgYXJlIG5vdCBnaXQgcmVwb3NpdG9yaWVzLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2NoaXBwZXIvaXNzdWVzLzEwMTFcclxuICAgICAgY29uc29sZS5sb2coIGBEaWQgbm90IGZpbmQgZ2l0IGluZm9ybWF0aW9uIGZvciAke2RlcGVuZGVuY3l9YCApO1xyXG4gICAgfVxyXG5cclxuICAgIGdydW50LmxvZy5kZWJ1ZyggYCR7Q2hpcHBlclN0cmluZ1V0aWxzLnBhZFN0cmluZyggZGVwZW5kZW5jeSwgMjAgKSArIGJyYW5jaH0gJHtzaGF9YCApO1xyXG4gICAgZGVwZW5kZW5jaWVzSW5mb1sgZGVwZW5kZW5jeSBdID0geyBzaGE6IHNoYSwgYnJhbmNoOiBicmFuY2ggfTtcclxuICB9XHJcblxyXG4gIHJldHVybiBkZXBlbmRlbmNpZXNJbmZvO1xyXG59OyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLE1BQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFFLFFBQVMsQ0FBQztBQUNsQyxNQUFNQyxrQkFBa0IsR0FBR0QsT0FBTyxDQUFFLDhCQUErQixDQUFDO0FBQ3BFLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFFLDRDQUE2QyxDQUFDO0FBQ3ZFLE1BQU1HLFdBQVcsR0FBR0gsT0FBTyxDQUFFLGVBQWdCLENBQUM7QUFDOUMsTUFBTUksS0FBSyxHQUFHSixPQUFPLENBQUUsT0FBUSxDQUFDOztBQUVoQztBQUNBO0FBQ0E7QUFDQSxNQUFNSyxZQUFZLEdBQUcsU0FBUzs7QUFFOUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQUMsTUFBTSxDQUFDQyxPQUFPLEdBQUcsZUFBZUMsZUFBZUEsQ0FBRUMsSUFBSSxFQUFH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