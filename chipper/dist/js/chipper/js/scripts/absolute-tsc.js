// Copyright 2022-2024, University of Colorado Boulder

/**
 * The tsc type checker outputs type errors using relative paths only, which are not hyperlinked in WebStorm and IntelliJ.
 * This thin wrapper uses a heuristic to convert the relative paths to absolute paths.  Combined with an "output filter",
 * this makes the type errors clickable in the tool output panel.
 *
 * To support CacheLayer, this must be run from chipper/
 *
 * Usage from command line:
 * cd chipper/
 * node js/scripts/absolute-tsc.js {{TS_CONFIG_DIRECTORY}}
 * node js/scripts/absolute-tsc.js ../chipper/tsconfig/all
 *
 * Configure WebStorm with the following external tool:
 * program: node
 * arguments: js/scripts/absolute-tsc.js ${dir with a tsconfig, like ../chipper/tsconfig/all}
 * working dir: ${chipper/, like /Users/samreid/apache-document-root/main/chipper}
 *
 * To share a cache with pre-commit-hooks use: ../chipper/tsconfig/all
 *
 * IMPORTANT!!! This makes the files paths clickable in Webstorm:
 * output filters: $FILE_PATH$\($LINE$\,$COLUMN$\)
 *
 * If you run into a memory error, consider setting the environment variable like so:
 * export NODE_OPTIONS=--max_old_space_size=4096
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */
const start = Date.now();
const execute = require('../../../perennial-alias/js/common/execute');
const CacheLayer = require('../common/CacheLayer');
const os = require('os');
const path = require('path');
const {
  resolve
} = require('path'); // eslint-disable-line require-statement-match

const args = process.argv.slice(2);
if (!args || args.length === 0) {
  console.log('usage: path to dir with a tsconfig file');
}
(async () => {
  const cacheKey = 'absolute-tsc#' + args[0];
  if (CacheLayer.isCacheSafe(cacheKey)) {
    // console.log( 'cache safe for: ' + cacheKey );
    return;
  }

  // console.log( 'changes detected...' );

  const results = await execute('node', [`${__dirname}/../../../chipper/node_modules/typescript/bin/tsc`], args[0], {
    errors: 'resolve',
    // TODO: it would be nice not to need this, https://github.com/phetsims/chipper/issues/1415
    childProcessEnv: {
      NODE_OPTIONS: '--max-old-space-size=8192'
    }
  });

  // If there was a problem running tsc, report it here.  The type errors are reported on stdout below.
  if (results.stderr.length > 0 || results.error) {
    console.log(results);
  }
  const end = Date.now();
  const elapsed = end - start;
  if (results.stdout.trim().length === 0) {
    console.log(`0 errors in ${elapsed}ms`);
    CacheLayer.onSuccess(cacheKey);
  } else {
    const lines = results.stdout.trim().split(os.EOL);
    const mapped = lines.map(line => {
      if (line.includes('): error TS')) {
        const parenthesesIndex = line.indexOf('(');
        const linePath = line.substring(0, parenthesesIndex);
        const resolved = resolve(process.cwd() + path.sep + args[0] + path.sep + linePath);
        return resolved + line.substring(parenthesesIndex);
      } else {
        return line;
      }
    });

    // If a line starts without whitespace, it begins a new error
    const errorCount = mapped.filter(line => line === line.trim()).length;
    console.log(mapped.join('\n'));
    console.log(`${errorCount} ${errorCount === 1 ? 'error' : 'errors'} in ${elapsed}ms`);
    process.exit(1);
  }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzdGFydCIsIkRhdGUiLCJub3ciLCJleGVjdXRlIiwicmVxdWlyZSIsIkNhY2hlTGF5ZXIiLCJvcyIsInBhdGgiLCJyZXNvbHZlIiwiYXJncyIsInByb2Nlc3MiLCJhcmd2Iiwic2xpY2UiLCJsZW5ndGgiLCJjb25zb2xlIiwibG9nIiwiY2FjaGVLZXkiLCJpc0NhY2hlU2FmZSIsInJlc3VsdHMiLCJfX2Rpcm5hbWUiLCJlcnJvcnMiLCJjaGlsZFByb2Nlc3NFbnYiLCJOT0RFX09QVElPTlMiLCJzdGRlcnIiLCJlcnJvciIsImVuZCIsImVsYXBzZWQiLCJzdGRvdXQiLCJ0cmltIiwib25TdWNjZXNzIiwibGluZXMiLCJzcGxpdCIsIkVPTCIsIm1hcHBlZCIsIm1hcCIsImxpbmUiLCJpbmNsdWRlcyIsInBhcmVudGhlc2VzSW5kZXgiLCJpbmRleE9mIiwibGluZVBhdGgiLCJzdWJzdHJpbmciLCJyZXNvbHZlZCIsImN3ZCIsInNlcCIsImVycm9yQ291bnQiLCJmaWx0ZXIiLCJqb2luIiwiZXhpdCJdLCJzb3VyY2VzIjpbImFic29sdXRlLXRzYy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMi0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBUaGUgdHNjIHR5cGUgY2hlY2tlciBvdXRwdXRzIHR5cGUgZXJyb3JzIHVzaW5nIHJlbGF0aXZlIHBhdGhzIG9ubHksIHdoaWNoIGFyZSBub3QgaHlwZXJsaW5rZWQgaW4gV2ViU3Rvcm0gYW5kIEludGVsbGlKLlxyXG4gKiBUaGlzIHRoaW4gd3JhcHBlciB1c2VzIGEgaGV1cmlzdGljIHRvIGNvbnZlcnQgdGhlIHJlbGF0aXZlIHBhdGhzIHRvIGFic29sdXRlIHBhdGhzLiAgQ29tYmluZWQgd2l0aCBhbiBcIm91dHB1dCBmaWx0ZXJcIixcclxuICogdGhpcyBtYWtlcyB0aGUgdHlwZSBlcnJvcnMgY2xpY2thYmxlIGluIHRoZSB0b29sIG91dHB1dCBwYW5lbC5cclxuICpcclxuICogVG8gc3VwcG9ydCBDYWNoZUxheWVyLCB0aGlzIG11c3QgYmUgcnVuIGZyb20gY2hpcHBlci9cclxuICpcclxuICogVXNhZ2UgZnJvbSBjb21tYW5kIGxpbmU6XHJcbiAqIGNkIGNoaXBwZXIvXHJcbiAqIG5vZGUganMvc2NyaXB0cy9hYnNvbHV0ZS10c2MuanMge3tUU19DT05GSUdfRElSRUNUT1JZfX1cclxuICogbm9kZSBqcy9zY3JpcHRzL2Fic29sdXRlLXRzYy5qcyAuLi9jaGlwcGVyL3RzY29uZmlnL2FsbFxyXG4gKlxyXG4gKiBDb25maWd1cmUgV2ViU3Rvcm0gd2l0aCB0aGUgZm9sbG93aW5nIGV4dGVybmFsIHRvb2w6XHJcbiAqIHByb2dyYW06IG5vZGVcclxuICogYXJndW1lbnRzOiBqcy9zY3JpcHRzL2Fic29sdXRlLXRzYy5qcyAke2RpciB3aXRoIGEgdHNjb25maWcsIGxpa2UgLi4vY2hpcHBlci90c2NvbmZpZy9hbGx9XHJcbiAqIHdvcmtpbmcgZGlyOiAke2NoaXBwZXIvLCBsaWtlIC9Vc2Vycy9zYW1yZWlkL2FwYWNoZS1kb2N1bWVudC1yb290L21haW4vY2hpcHBlcn1cclxuICpcclxuICogVG8gc2hhcmUgYSBjYWNoZSB3aXRoIHByZS1jb21taXQtaG9va3MgdXNlOiAuLi9jaGlwcGVyL3RzY29uZmlnL2FsbFxyXG4gKlxyXG4gKiBJTVBPUlRBTlQhISEgVGhpcyBtYWtlcyB0aGUgZmlsZXMgcGF0aHMgY2xpY2thYmxlIGluIFdlYnN0b3JtOlxyXG4gKiBvdXRwdXQgZmlsdGVyczogJEZJTEVfUEFUSCRcXCgkTElORSRcXCwkQ09MVU1OJFxcKVxyXG4gKlxyXG4gKiBJZiB5b3UgcnVuIGludG8gYSBtZW1vcnkgZXJyb3IsIGNvbnNpZGVyIHNldHRpbmcgdGhlIGVudmlyb25tZW50IHZhcmlhYmxlIGxpa2Ugc286XHJcbiAqIGV4cG9ydCBOT0RFX09QVElPTlM9LS1tYXhfb2xkX3NwYWNlX3NpemU9NDA5NlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpO1xyXG5jb25zdCBleGVjdXRlID0gcmVxdWlyZSggJy4uLy4uLy4uL3BlcmVubmlhbC1hbGlhcy9qcy9jb21tb24vZXhlY3V0ZScgKTtcclxuY29uc3QgQ2FjaGVMYXllciA9IHJlcXVpcmUoICcuLi9jb21tb24vQ2FjaGVMYXllcicgKTtcclxuY29uc3Qgb3MgPSByZXF1aXJlKCAnb3MnICk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCAncGF0aCcgKTtcclxuY29uc3QgeyByZXNvbHZlIH0gPSByZXF1aXJlKCAncGF0aCcgKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLXN0YXRlbWVudC1tYXRjaFxyXG5cclxuY29uc3QgYXJncyA9IHByb2Nlc3MuYXJndi5zbGljZSggMiApO1xyXG5pZiAoICFhcmdzIHx8IGFyZ3MubGVuZ3RoID09PSAwICkge1xyXG4gIGNvbnNvbGUubG9nKCAndXNhZ2U6IHBhdGggdG8gZGlyIHdpdGggYSB0c2NvbmZpZyBmaWxlJyApO1xyXG59XHJcblxyXG4oIGFzeW5jICgpID0+IHtcclxuXHJcbiAgY29uc3QgY2FjaGVLZXkgPSAnYWJzb2x1dGUtdHNjIycgKyBhcmdzWyAwIF07XHJcbiAgaWYgKCBDYWNoZUxheWVyLmlzQ2FjaGVTYWZlKCBjYWNoZUtleSApICkge1xyXG4gICAgLy8gY29uc29sZS5sb2coICdjYWNoZSBzYWZlIGZvcjogJyArIGNhY2hlS2V5ICk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICAvLyBjb25zb2xlLmxvZyggJ2NoYW5nZXMgZGV0ZWN0ZWQuLi4nICk7XHJcblxyXG4gIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBleGVjdXRlKCAnbm9kZScsIFsgYCR7X19kaXJuYW1lfS8uLi8uLi8uLi9jaGlwcGVyL25vZGVfbW9kdWxlcy90eXBlc2NyaXB0L2Jpbi90c2NgIF0sIGFyZ3NbIDAgXSwge1xyXG4gICAgZXJyb3JzOiAncmVzb2x2ZScsXHJcblxyXG4gICAgLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSBub3QgdG8gbmVlZCB0aGlzLCBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY2hpcHBlci9pc3N1ZXMvMTQxNVxyXG4gICAgY2hpbGRQcm9jZXNzRW52OiB7IE5PREVfT1BUSU9OUzogJy0tbWF4LW9sZC1zcGFjZS1zaXplPTgxOTInIH1cclxuICB9ICk7XHJcblxyXG4gIC8vIElmIHRoZXJlIHdhcyBhIHByb2JsZW0gcnVubmluZyB0c2MsIHJlcG9ydCBpdCBoZXJlLiAgVGhlIHR5cGUgZXJyb3JzIGFyZSByZXBvcnRlZCBvbiBzdGRvdXQgYmVsb3cuXHJcbiAgaWYgKCByZXN1bHRzLnN0ZGVyci5sZW5ndGggPiAwIHx8IHJlc3VsdHMuZXJyb3IgKSB7XHJcbiAgICBjb25zb2xlLmxvZyggcmVzdWx0cyApO1xyXG4gIH1cclxuICBjb25zdCBlbmQgPSBEYXRlLm5vdygpO1xyXG4gIGNvbnN0IGVsYXBzZWQgPSBlbmQgLSBzdGFydDtcclxuXHJcbiAgaWYgKCByZXN1bHRzLnN0ZG91dC50cmltKCkubGVuZ3RoID09PSAwICkge1xyXG5cclxuICAgIGNvbnNvbGUubG9nKCBgMCBlcnJvcnMgaW4gJHtlbGFwc2VkfW1zYCApO1xyXG4gICAgQ2FjaGVMYXllci5vblN1Y2Nlc3MoIGNhY2hlS2V5ICk7XHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgY29uc3QgbGluZXMgPSByZXN1bHRzLnN0ZG91dC50cmltKCkuc3BsaXQoIG9zLkVPTCApO1xyXG4gICAgY29uc3QgbWFwcGVkID0gbGluZXMubWFwKCBsaW5lID0+IHtcclxuXHJcbiAgICAgIGlmICggbGluZS5pbmNsdWRlcyggJyk6IGVycm9yIFRTJyApICkge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudGhlc2VzSW5kZXggPSBsaW5lLmluZGV4T2YoICcoJyApO1xyXG5cclxuICAgICAgICBjb25zdCBsaW5lUGF0aCA9IGxpbmUuc3Vic3RyaW5nKCAwLCBwYXJlbnRoZXNlc0luZGV4ICk7XHJcbiAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSByZXNvbHZlKCBwcm9jZXNzLmN3ZCgpICsgcGF0aC5zZXAgKyBhcmdzWyAwIF0gKyBwYXRoLnNlcCArIGxpbmVQYXRoICk7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmVkICsgbGluZS5zdWJzdHJpbmcoIHBhcmVudGhlc2VzSW5kZXggKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbGluZTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIElmIGEgbGluZSBzdGFydHMgd2l0aG91dCB3aGl0ZXNwYWNlLCBpdCBiZWdpbnMgYSBuZXcgZXJyb3JcclxuICAgIGNvbnN0IGVycm9yQ291bnQgPSBtYXBwZWQuZmlsdGVyKCBsaW5lID0+IGxpbmUgPT09IGxpbmUudHJpbSgpICkubGVuZ3RoO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKCBtYXBwZWQuam9pbiggJ1xcbicgKSApO1xyXG4gICAgY29uc29sZS5sb2coIGAke2Vycm9yQ291bnR9ICR7ZXJyb3JDb3VudCA9PT0gMSA/ICdlcnJvcicgOiAnZXJyb3JzJ30gaW4gJHtlbGFwc2VkfW1zYCApO1xyXG4gICAgcHJvY2Vzcy5leGl0KCAxICk7XHJcbiAgfVxyXG59ICkoKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLEtBQUssR0FBR0MsSUFBSSxDQUFDQyxHQUFHLENBQUMsQ0FBQztBQUN4QixNQUFNQyxPQUFPLEdBQUdDLE9BQU8sQ0FBRSw0Q0FBNkMsQ0FBQztBQUN2RSxNQUFNQyxVQUFVLEdBQUdELE9BQU8sQ0FBRSxzQkFBdUIsQ0FBQztBQUNwRCxNQUFNRSxFQUFFLEdBQUdGLE9BQU8sQ0FBRSxJQUFLLENBQUM7QUFDMUIsTUFBTUcsSUFBSSxHQUFHSCxPQUFPLENBQUUsTUFBTyxDQUFDO0FBQzlCLE1BQU07RUFBRUk7QUFBUSxDQUFDLEdBQUdKLE9BQU8sQ0FBRSxNQUFPLENBQUMsQ0FBQyxDQUFDOztBQUV2QyxNQUFNSyxJQUFJLEdBQUdDLE9BQU8sQ0FBQ0MsSUFBSSxDQUFDQyxLQUFLLENBQUUsQ0FBRSxDQUFDO0FBQ3BDLElBQUssQ0FBQ0gsSUFBSSxJQUFJQSxJQUFJLENBQUNJLE1BQU0sS0FBSyxDQUFDLEVBQUc7RUFDaENDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFFLHlDQUEwQyxDQUFDO0FBQzFEO0FBRUEsQ0FBRSxZQUFZO0VBRVosTUFBTUMsUUFBUSxHQUFHLGVBQWUsR0FBR1AsSUFBSSxDQUFFLENBQUMsQ0FBRTtFQUM1QyxJQUFLSixVQUFVLENBQUNZLFdBQVcsQ0FBRUQsUUFBUyxDQUFDLEVBQUc7SUFDeEM7SUFDQTtFQUNGOztFQUVBOztFQUVBLE1BQU1FLE9BQU8sR0FBRyxNQUFNZixPQUFPLENBQUUsTUFBTSxFQUFFLENBQUcsR0FBRWdCLFNBQVUsbURBQWtELENBQUUsRUFBRVYsSUFBSSxDQUFFLENBQUMsQ0FBRSxFQUFFO0lBQ3JIVyxNQUFNLEVBQUUsU0FBUztJQUVqQjtJQUNBQyxlQUFlLEVBQUU7TUFBRUMsWUFBWSxFQUFFO0lBQTRCO0VBQy9ELENBQUUsQ0FBQzs7RUFFSDtFQUNBLElBQUtKLE9BQU8sQ0FBQ0ssTUFBTSxDQUFDVixNQUFNLEdBQUcsQ0FBQyxJQUFJSyxPQUFPLENBQUNNLEtBQUssRUFBRztJQUNoRFYsT0FBTyxDQUFDQyxHQUFHLENBQUVHLE9BQVEsQ0FBQztFQUN4QjtFQUNBLE1BQU1PLEdBQUcsR0FBR3hCLElBQUksQ0FBQ0MsR0FBRyxDQUFDLENBQUM7RUFDdEIsTUFBTXdCLE9BQU8sR0FBR0QsR0FBRyxHQUFHekIsS0FBSztFQUUzQixJQUFLa0IsT0FBTyxDQUFDUyxNQUFNLENBQUNDLElBQUksQ0FBQyxDQUFDLENBQUNmLE1BQU0sS0FBSyxDQUFDLEVBQUc7SUFFeENDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFHLGVBQWNXLE9BQVEsSUFBSSxDQUFDO0lBQ3pDckIsVUFBVSxDQUFDd0IsU0FBUyxDQUFFYixRQUFTLENBQUM7RUFDbEMsQ0FBQyxNQUNJO0lBQ0gsTUFBTWMsS0FBSyxHQUFHWixPQUFPLENBQUNTLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDLENBQUMsQ0FBQ0csS0FBSyxDQUFFekIsRUFBRSxDQUFDMEIsR0FBSSxDQUFDO0lBQ25ELE1BQU1DLE1BQU0sR0FBR0gsS0FBSyxDQUFDSSxHQUFHLENBQUVDLElBQUksSUFBSTtNQUVoQyxJQUFLQSxJQUFJLENBQUNDLFFBQVEsQ0FBRSxhQUFjLENBQUMsRUFBRztRQUNwQyxNQUFNQyxnQkFBZ0IsR0FBR0YsSUFBSSxDQUFDRyxPQUFPLENBQUUsR0FBSSxDQUFDO1FBRTVDLE1BQU1DLFFBQVEsR0FBR0osSUFBSSxDQUFDSyxTQUFTLENBQUUsQ0FBQyxFQUFFSCxnQkFBaUIsQ0FBQztRQUN0RCxNQUFNSSxRQUFRLEdBQUdqQyxPQUFPLENBQUVFLE9BQU8sQ0FBQ2dDLEdBQUcsQ0FBQyxDQUFDLEdBQUduQyxJQUFJLENBQUNvQyxHQUFHLEdBQUdsQyxJQUFJLENBQUUsQ0FBQyxDQUFFLEdBQUdGLElBQUksQ0FBQ29DLEdBQUcsR0FBR0osUUFBUyxDQUFDO1FBQ3RGLE9BQU9FLFFBQVEsR0FBR04sSUFBSSxDQUFDSyxTQUFTLENBQUVILGdCQUFpQixDQUFDO01BQ3RELENBQUMsTUFDSTtRQUNILE9BQU9GLElBQUk7TUFDYjtJQUNGLENBQUUsQ0FBQzs7SUFFSDtJQUNBLE1BQU1TLFVBQVUsR0FBR1gsTUFBTSxDQUFDWSxNQUFNLENBQUVWLElBQUksSUFBSUEsSUFBSSxLQUFLQSxJQUFJLENBQUNQLElBQUksQ0FBQyxDQUFFLENBQUMsQ0FBQ2YsTUFBTTtJQUV2RUMsT0FBTyxDQUFDQyxHQUFHLENBQUVrQixNQUFNLENBQUNhLElBQUksQ0FBRSxJQUFLLENBQUUsQ0FBQztJQUNsQ2hDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFHLEdBQUU2QixVQUFXLElBQUdBLFVBQVUsS0FBSyxDQUFDLEdBQUcsT0FBTyxHQUFHLFFBQVMsT0FBTWxCLE9BQVEsSUFBSSxDQUFDO0lBQ3ZGaEIsT0FBTyxDQUFDcUMsSUFBSSxDQUFFLENBQUUsQ0FBQztFQUNuQjtBQUNGLENBQUMsRUFBRyxDQUFDIiwiaWdub3JlTGlzdCI6W119