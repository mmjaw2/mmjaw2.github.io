// Copyright 2023-2024, University of Colorado Boulder

/**
 * A Property that will contain a set of all ancestor Nodes of a given Node.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import TinyEmitter from '../../../axon/js/TinyEmitter.js';
import TinyProperty from '../../../axon/js/TinyProperty.js';
import { scenery } from '../imports.js';
const valueComparisonStrategy = (a, b) => {
  // Don't fire notifications if it hasn't changed.
  return a.size === b.size && _.every([...a], node => b.has(node));
};
export default class AncestorNodesProperty extends TinyProperty {
  // A set of nodes where we are listening to whether their parents change
  listenedNodeSet = new Set();
  // Fired whenever we need to update the internal value (i.e. a parent was added or removed somewhere in the chain)
  updateEmitter = new TinyEmitter();
  constructor(node) {
    super(new Set());
    this.node = node;
    this.valueComparisonStrategy = valueComparisonStrategy;
    this._nodeUpdateListener = this.update.bind(this);

    // Listen to our own parent changes too (even though we aren't an ancestor)
    this.addNodeListener(node);
    this.update();
  }
  update() {
    // Nodes that were touched in the scan (we should listen to changes to ANY of these to see if there is a connection
    // or disconnection). This could potentially cause our Property to change
    const nodeSet = new Set();

    // Recursively scan to identify all ancestors
    (function recurse(node) {
      const parents = node.parents;
      parents.forEach(parent => {
        nodeSet.add(parent);
        recurse(parent);
      });
    })(this.node);

    // Add in new needed listeners
    nodeSet.forEach(node => {
      if (!this.listenedNodeSet.has(node)) {
        this.addNodeListener(node);
      }
    });

    // Remove listeners not needed anymore
    this.listenedNodeSet.forEach(node => {
      // NOTE: do NOT remove the listener that is listening to our node for changes (it's not an ancestor, and won't
      // come up in this list)
      if (!nodeSet.has(node) && node !== this.node) {
        this.removeNodeListener(node);
      }
    });
    this.value = nodeSet;
    this.updateEmitter.emit();
  }
  addNodeListener(node) {
    this.listenedNodeSet.add(node);
    node.parentAddedEmitter.addListener(this._nodeUpdateListener);
    node.parentRemovedEmitter.addListener(this._nodeUpdateListener);
  }
  removeNodeListener(node) {
    this.listenedNodeSet.delete(node);
    node.parentAddedEmitter.removeListener(this._nodeUpdateListener);
    node.parentRemovedEmitter.removeListener(this._nodeUpdateListener);
  }
  dispose() {
    this.listenedNodeSet.forEach(node => this.removeNodeListener(node));
    super.dispose();
  }
}
scenery.register('AncestorNodesProperty', AncestorNodesProperty);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJUaW55RW1pdHRlciIsIlRpbnlQcm9wZXJ0eSIsInNjZW5lcnkiLCJ2YWx1ZUNvbXBhcmlzb25TdHJhdGVneSIsImEiLCJiIiwic2l6ZSIsIl8iLCJldmVyeSIsIm5vZGUiLCJoYXMiLCJBbmNlc3Rvck5vZGVzUHJvcGVydHkiLCJsaXN0ZW5lZE5vZGVTZXQiLCJTZXQiLCJ1cGRhdGVFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJfbm9kZVVwZGF0ZUxpc3RlbmVyIiwidXBkYXRlIiwiYmluZCIsImFkZE5vZGVMaXN0ZW5lciIsIm5vZGVTZXQiLCJyZWN1cnNlIiwicGFyZW50cyIsImZvckVhY2giLCJwYXJlbnQiLCJhZGQiLCJyZW1vdmVOb2RlTGlzdGVuZXIiLCJ2YWx1ZSIsImVtaXQiLCJwYXJlbnRBZGRlZEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsInBhcmVudFJlbW92ZWRFbWl0dGVyIiwiZGVsZXRlIiwicmVtb3ZlTGlzdGVuZXIiLCJkaXNwb3NlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJBbmNlc3Rvck5vZGVzUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjMtMjAyNCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSBQcm9wZXJ0eSB0aGF0IHdpbGwgY29udGFpbiBhIHNldCBvZiBhbGwgYW5jZXN0b3IgTm9kZXMgb2YgYSBnaXZlbiBOb2RlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IFRpbnlFbWl0dGVyIGZyb20gJy4uLy4uLy4uL2F4b24vanMvVGlueUVtaXR0ZXIuanMnO1xyXG5pbXBvcnQgVGlueVByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvVGlueVByb3BlcnR5LmpzJztcclxuaW1wb3J0IHsgTm9kZSwgc2NlbmVyeSB9IGZyb20gJy4uL2ltcG9ydHMuanMnO1xyXG5cclxuY29uc3QgdmFsdWVDb21wYXJpc29uU3RyYXRlZ3kgPSAoIGE6IFNldDxOb2RlPiwgYjogU2V0PE5vZGU+ICk6IGJvb2xlYW4gPT4ge1xyXG5cclxuICAvLyBEb24ndCBmaXJlIG5vdGlmaWNhdGlvbnMgaWYgaXQgaGFzbid0IGNoYW5nZWQuXHJcbiAgcmV0dXJuIGEuc2l6ZSA9PT0gYi5zaXplICYmIF8uZXZlcnkoIFsgLi4uYSBdLCBub2RlID0+IGIuaGFzKCBub2RlICkgKTtcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFuY2VzdG9yTm9kZXNQcm9wZXJ0eSBleHRlbmRzIFRpbnlQcm9wZXJ0eTxTZXQ8Tm9kZT4+IHtcclxuXHJcbiAgLy8gQSBzZXQgb2Ygbm9kZXMgd2hlcmUgd2UgYXJlIGxpc3RlbmluZyB0byB3aGV0aGVyIHRoZWlyIHBhcmVudHMgY2hhbmdlXHJcbiAgcHJpdmF0ZSByZWFkb25seSBsaXN0ZW5lZE5vZGVTZXQgPSBuZXcgU2V0PE5vZGU+KCk7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX25vZGVVcGRhdGVMaXN0ZW5lcjogKCkgPT4gdm9pZDtcclxuXHJcbiAgLy8gRmlyZWQgd2hlbmV2ZXIgd2UgbmVlZCB0byB1cGRhdGUgdGhlIGludGVybmFsIHZhbHVlIChpLmUuIGEgcGFyZW50IHdhcyBhZGRlZCBvciByZW1vdmVkIHNvbWV3aGVyZSBpbiB0aGUgY2hhaW4pXHJcbiAgcHVibGljIHJlYWRvbmx5IHVwZGF0ZUVtaXR0ZXIgPSBuZXcgVGlueUVtaXR0ZXIoKTtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwdWJsaWMgcmVhZG9ubHkgbm9kZTogTm9kZSApIHtcclxuICAgIHN1cGVyKCBuZXcgU2V0KCkgKTtcclxuICAgIHRoaXMudmFsdWVDb21wYXJpc29uU3RyYXRlZ3kgPSB2YWx1ZUNvbXBhcmlzb25TdHJhdGVneTtcclxuXHJcbiAgICB0aGlzLl9ub2RlVXBkYXRlTGlzdGVuZXIgPSB0aGlzLnVwZGF0ZS5iaW5kKCB0aGlzICk7XHJcblxyXG4gICAgLy8gTGlzdGVuIHRvIG91ciBvd24gcGFyZW50IGNoYW5nZXMgdG9vIChldmVuIHRob3VnaCB3ZSBhcmVuJ3QgYW4gYW5jZXN0b3IpXHJcbiAgICB0aGlzLmFkZE5vZGVMaXN0ZW5lciggbm9kZSApO1xyXG5cclxuICAgIHRoaXMudXBkYXRlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZSgpOiB2b2lkIHtcclxuICAgIC8vIE5vZGVzIHRoYXQgd2VyZSB0b3VjaGVkIGluIHRoZSBzY2FuICh3ZSBzaG91bGQgbGlzdGVuIHRvIGNoYW5nZXMgdG8gQU5ZIG9mIHRoZXNlIHRvIHNlZSBpZiB0aGVyZSBpcyBhIGNvbm5lY3Rpb25cclxuICAgIC8vIG9yIGRpc2Nvbm5lY3Rpb24pLiBUaGlzIGNvdWxkIHBvdGVudGlhbGx5IGNhdXNlIG91ciBQcm9wZXJ0eSB0byBjaGFuZ2VcclxuICAgIGNvbnN0IG5vZGVTZXQgPSBuZXcgU2V0PE5vZGU+KCk7XHJcblxyXG4gICAgLy8gUmVjdXJzaXZlbHkgc2NhbiB0byBpZGVudGlmeSBhbGwgYW5jZXN0b3JzXHJcbiAgICAoIGZ1bmN0aW9uIHJlY3Vyc2UoIG5vZGU6IE5vZGUgKSB7XHJcbiAgICAgIGNvbnN0IHBhcmVudHMgPSBub2RlLnBhcmVudHM7XHJcblxyXG4gICAgICBwYXJlbnRzLmZvckVhY2goIHBhcmVudCA9PiB7XHJcbiAgICAgICAgbm9kZVNldC5hZGQoIHBhcmVudCApO1xyXG4gICAgICAgIHJlY3Vyc2UoIHBhcmVudCApO1xyXG4gICAgICB9ICk7XHJcbiAgICB9ICkoIHRoaXMubm9kZSApO1xyXG5cclxuICAgIC8vIEFkZCBpbiBuZXcgbmVlZGVkIGxpc3RlbmVyc1xyXG4gICAgbm9kZVNldC5mb3JFYWNoKCBub2RlID0+IHtcclxuICAgICAgaWYgKCAhdGhpcy5saXN0ZW5lZE5vZGVTZXQuaGFzKCBub2RlICkgKSB7XHJcbiAgICAgICAgdGhpcy5hZGROb2RlTGlzdGVuZXIoIG5vZGUgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFJlbW92ZSBsaXN0ZW5lcnMgbm90IG5lZWRlZCBhbnltb3JlXHJcbiAgICB0aGlzLmxpc3RlbmVkTm9kZVNldC5mb3JFYWNoKCBub2RlID0+IHtcclxuICAgICAgLy8gTk9URTogZG8gTk9UIHJlbW92ZSB0aGUgbGlzdGVuZXIgdGhhdCBpcyBsaXN0ZW5pbmcgdG8gb3VyIG5vZGUgZm9yIGNoYW5nZXMgKGl0J3Mgbm90IGFuIGFuY2VzdG9yLCBhbmQgd29uJ3RcclxuICAgICAgLy8gY29tZSB1cCBpbiB0aGlzIGxpc3QpXHJcbiAgICAgIGlmICggIW5vZGVTZXQuaGFzKCBub2RlICkgJiYgbm9kZSAhPT0gdGhpcy5ub2RlICkge1xyXG4gICAgICAgIHRoaXMucmVtb3ZlTm9kZUxpc3RlbmVyKCBub2RlICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnZhbHVlID0gbm9kZVNldDtcclxuXHJcbiAgICB0aGlzLnVwZGF0ZUVtaXR0ZXIuZW1pdCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhZGROb2RlTGlzdGVuZXIoIG5vZGU6IE5vZGUgKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3RlbmVkTm9kZVNldC5hZGQoIG5vZGUgKTtcclxuICAgIG5vZGUucGFyZW50QWRkZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLl9ub2RlVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIG5vZGUucGFyZW50UmVtb3ZlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHRoaXMuX25vZGVVcGRhdGVMaXN0ZW5lciApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW1vdmVOb2RlTGlzdGVuZXIoIG5vZGU6IE5vZGUgKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3RlbmVkTm9kZVNldC5kZWxldGUoIG5vZGUgKTtcclxuICAgIG5vZGUucGFyZW50QWRkZWRFbWl0dGVyLnJlbW92ZUxpc3RlbmVyKCB0aGlzLl9ub2RlVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIG5vZGUucGFyZW50UmVtb3ZlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMuX25vZGVVcGRhdGVMaXN0ZW5lciApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3RlbmVkTm9kZVNldC5mb3JFYWNoKCBub2RlID0+IHRoaXMucmVtb3ZlTm9kZUxpc3RlbmVyKCBub2RlICkgKTtcclxuXHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5zY2VuZXJ5LnJlZ2lzdGVyKCAnQW5jZXN0b3JOb2Rlc1Byb3BlcnR5JywgQW5jZXN0b3JOb2Rlc1Byb3BlcnR5ICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFdBQVcsTUFBTSxpQ0FBaUM7QUFDekQsT0FBT0MsWUFBWSxNQUFNLGtDQUFrQztBQUMzRCxTQUFlQyxPQUFPLFFBQVEsZUFBZTtBQUU3QyxNQUFNQyx1QkFBdUIsR0FBR0EsQ0FBRUMsQ0FBWSxFQUFFQyxDQUFZLEtBQWU7RUFFekU7RUFDQSxPQUFPRCxDQUFDLENBQUNFLElBQUksS0FBS0QsQ0FBQyxDQUFDQyxJQUFJLElBQUlDLENBQUMsQ0FBQ0MsS0FBSyxDQUFFLENBQUUsR0FBR0osQ0FBQyxDQUFFLEVBQUVLLElBQUksSUFBSUosQ0FBQyxDQUFDSyxHQUFHLENBQUVELElBQUssQ0FBRSxDQUFDO0FBQ3hFLENBQUM7QUFFRCxlQUFlLE1BQU1FLHFCQUFxQixTQUFTVixZQUFZLENBQVk7RUFFekU7RUFDaUJXLGVBQWUsR0FBRyxJQUFJQyxHQUFHLENBQU8sQ0FBQztFQUlsRDtFQUNnQkMsYUFBYSxHQUFHLElBQUlkLFdBQVcsQ0FBQyxDQUFDO0VBRTFDZSxXQUFXQSxDQUFrQk4sSUFBVSxFQUFHO0lBQy9DLEtBQUssQ0FBRSxJQUFJSSxHQUFHLENBQUMsQ0FBRSxDQUFDO0lBQUMsS0FEZUosSUFBVSxHQUFW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