// Copyright 2024, University of Colorado Boulder

/**
 * A Property that will contain a list of Trails where the root of the trail is a root Node of a Display, and the leaf
 * node is the provided Node.
 *
 * // REVIEW: This is a very complicated component and deserves a bit more doc. Some ideas about what to explain:
 * // REVIEW:   1. That this is synchronously updated and doesn't listen to instances.
 * // REVIEW:   2.
 * // REVIEW:   2.
 * // REVIEW:   2.
 *
 * // REVIEW: can you describe this a bit more. Do you mean any Node in a trail? What about if the provided Node is disposed?
 * NOTE: If a Node is disposed, it will be removed from the trails.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import TinyProperty from '../../../axon/js/TinyProperty.js';
import { Display, scenery, Trail } from '../imports.js';
import optionize from '../../../phet-core/js/optionize.js';
export default class DisplayedTrailsProperty extends TinyProperty {
  // REVIEW: How about a rename like "targetNode", no strong preference if you don't want to.

  // REVIEW: Please add doc why we only need to listen to a Node once, even if it is in multiple trails?
  listenedNodeSet = new Set();

  // Recorded options
  // REVIEW: Please rename this and the option to something less confusing. Perhaps `displaySupport`, or
  // `whichDisplay`, or something that sounds like it could be a predicate.

  /**
   * We will contain Trails whose leaf node (lastNode) is this provided Node.
   */
  constructor(node, providedOptions) {
    const options = optionize()({
      // Listen to all displays
      display: null,
      // Default to visual trails (just children), with only pruning by normal visibility
      followPDOMOrder: false,
      requireVisible: true,
      requirePDOMVisible: false,
      requireEnabled: false,
      requireInputEnabled: false
    }, providedOptions);
    super([]);

    // Save options for later updates
    this.node = node;
    this.display = options.display;
    this.followPDOMOrder = options.followPDOMOrder;
    this.requireVisible = options.requireVisible;
    this.requirePDOMVisible = options.requirePDOMVisible;
    this.requireEnabled = options.requireEnabled;
    this.requireInputEnabled = options.requireInputEnabled;
    this._trailUpdateListener = this.update.bind(this);
    this.update();
  }
  update() {
    // Factored out because we're using a "function" below for recursion (NOT an arrow function)
    const display = this.display;
    const followPDOMOrder = this.followPDOMOrder;
    const requireVisible = this.requireVisible;
    const requirePDOMVisible = this.requirePDOMVisible;
    const requireEnabled = this.requireEnabled;
    const requireInputEnabled = this.requireInputEnabled;

    // Trails accumulated in our recursion that will be our Property's value
    const trails = [];

    // Nodes that were touched in the scan (we should listen to changes to ANY of these to see if there is a connection
    // or disconnection). This could potentially cause our Property to change
    const nodeSet = new Set();

    // Modified in-place during the search
    const trail = new Trail(this.node);

    // We will recursively add things to the "front" of the trail (ancestors)
    (function recurse() {
      const root = trail.rootNode();

      // If a Node is disposed, we won't add listeners to it, so we abort slightly earlier.
      if (root.isDisposed) {
        return;
      }
      nodeSet.add(root);

      // REVIEW: Please say why we need listeners on this Node. Also please confirm (via doc) that adding
      // If we fail other conditions, we won't add a trail OR recurse, but we will STILL have listeners added to the Node.
      if (requireVisible && !root.visible || requirePDOMVisible && !root.pdomVisible || requireEnabled && !root.enabled || requireInputEnabled && !root.inputEnabled) {
        return;
      }
      const displays = root.getRootedDisplays();

      // REVIEW: initialize to false?
      let displayMatches;
      if (display === null) {
        displayMatches = displays.length > 0;
      } else if (display instanceof Display) {
        displayMatches = displays.includes(display);
      } else {
        displayMatches = displays.some(display);
      }
      if (displayMatches) {
        // Create a permanent copy that won't be mutated
        trails.push(trail.copy());
      }

      // REVIEW: I'm officially confused about this feature. What is the value of "either or", why not be able to
      // support both visual and PDOM in the same Property? If this is indeed best, please be sure to explain where
      // the option is defined.
      const parents = followPDOMOrder && root.pdomParent ? [root.pdomParent] : root.parents;
      parents.forEach(parent => {
        trail.addAncestor(parent);
        recurse();
        trail.removeAncestor();
      });
    })();

    // REVIEW: Webstorm flagged the next 29 lines as duplicated with TrailsBetweenProperty. Let's factor that our or fix that somehow.
    // Add in new needed listeners
    nodeSet.forEach(node => {
      if (!this.listenedNodeSet.has(node)) {
        this.addNodeListener(node);
      }
    });

    // Remove listeners not needed anymore
    this.listenedNodeSet.forEach(node => {
      if (!nodeSet.has(node)) {
        this.removeNodeListener(node);
      }
    });

    // Guard in a way that deepEquality on the Property wouldn't (because of the Array wrapper)
    // NOTE: Duplicated with TrailsBetweenProperty, likely can be factored out.
    // REVIEW: ^^^^ +1, yes please factor out.
    const currentTrails = this.value;
    let trailsEqual = currentTrails.length === trails.length;
    if (trailsEqual) {
      for (let i = 0; i < trails.length; i++) {
        if (!currentTrails[i].equals(trails[i])) {
          trailsEqual = false;
          break;
        }
      }
    }

    // REVIEW: Can this be improved upon by utilizing a custom valueComparisonStrategy? I don't see that being much
    // less performant given that you are doing all the above work on each call to update().
    if (!trailsEqual) {
      this.value = trails;
    }
  }

  // REVIEW: Rename to either `addNodeListeners`, or something more general like `listenToNode()`.
  addNodeListener(node) {
    this.listenedNodeSet.add(node);

    // Unconditional listeners, which affect all nodes.
    node.parentAddedEmitter.addListener(this._trailUpdateListener);
    node.parentRemovedEmitter.addListener(this._trailUpdateListener);
    node.rootedDisplayChangedEmitter.addListener(this._trailUpdateListener);
    node.disposeEmitter.addListener(this._trailUpdateListener);
    if (this.followPDOMOrder) {
      node.pdomParentChangedEmitter.addListener(this._trailUpdateListener);
    }
    if (this.requireVisible) {
      node.visibleProperty.lazyLink(this._trailUpdateListener);
    }
    if (this.requirePDOMVisible) {
      node.pdomVisibleProperty.lazyLink(this._trailUpdateListener);
    }
    if (this.requireEnabled) {
      node.enabledProperty.lazyLink(this._trailUpdateListener);
    }
    if (this.requireInputEnabled) {
      node.inputEnabledProperty.lazyLink(this._trailUpdateListener);
    }
  }
  removeNodeListener(node) {
    this.listenedNodeSet.delete(node);
    node.parentAddedEmitter.removeListener(this._trailUpdateListener);
    node.parentRemovedEmitter.removeListener(this._trailUpdateListener);
    node.rootedDisplayChangedEmitter.removeListener(this._trailUpdateListener);
    node.disposeEmitter.removeListener(this._trailUpdateListener);
    if (this.followPDOMOrder) {
      node.pdomParentChangedEmitter.removeListener(this._trailUpdateListener);
    }
    if (this.requireVisible) {
      node.visibleProperty.unlink(this._trailUpdateListener);
    }
    if (this.requirePDOMVisible) {
      node.pdomVisibleProperty.unlink(this._trailUpdateListener);
    }
    if (this.requireEnabled) {
      node.enabledProperty.unlink(this._trailUpdateListener);
    }
    if (this.requireInputEnabled) {
      node.inputEnabledProperty.unlink(this._trailUpdateListener);
    }
  }

  // REVIEW: I always forget why you don't need to also clear your reference to the provided Node. Do you?
  // REVIEW: Also maybe assert here that your provided node is in this listened to Node set?
  dispose() {
    this.listenedNodeSet.forEach(node => this.removeNodeListener(node));
    super.dispose();
  }
}
scenery.register('DisplayedTrailsProperty', DisplayedTrailsProperty);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJUaW55UHJvcGVydHkiLCJEaXNwbGF5Iiwic2NlbmVyeSIsIlRyYWlsIiwib3B0aW9uaXplIiwiRGlzcGxheWVkVHJhaWxzUHJvcGVydHkiLCJsaXN0ZW5lZE5vZGVTZXQiLCJTZXQiLCJjb25zdHJ1Y3RvciIsIm5vZGUiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiZGlzcGxheSIsImZvbGxvd1BET01PcmRlciIsInJlcXVpcmVWaXNpYmxlIiwicmVxdWlyZVBET01WaXNpYmxlIiwicmVxdWlyZUVuYWJsZWQiLCJyZXF1aXJlSW5wdXRFbmFibGVkIiwiX3RyYWlsVXBkYXRlTGlzdGVuZXIiLCJ1cGRhdGUiLCJiaW5kIiwidHJhaWxzIiwibm9kZVNldCIsInRyYWlsIiwicmVjdXJzZSIsInJvb3QiLCJyb290Tm9kZSIsImlzRGlzcG9zZWQiLCJhZGQiLCJ2aXNpYmxlIiwicGRvbVZpc2libGUiLCJlbmFibGVkIiwiaW5wdXRFbmFibGVkIiwiZGlzcGxheXMiLCJnZXRSb290ZWREaXNwbGF5cyIsImRpc3BsYXlNYXRjaGVzIiwibGVuZ3RoIiwiaW5jbHVkZXMiLCJzb21lIiwicHVzaCIsImNvcHkiLCJwYXJlbnRzIiwicGRvbVBhcmVudCIsImZvckVhY2giLCJwYXJlbnQiLCJhZGRBbmNlc3RvciIsInJlbW92ZUFuY2VzdG9yIiwiaGFzIiwiYWRkTm9kZUxpc3RlbmVyIiwicmVtb3ZlTm9kZUxpc3RlbmVyIiwiY3VycmVudFRyYWlscyIsInZhbHVlIiwidHJhaWxzRXF1YWwiLCJpIiwiZXF1YWxzIiwicGFyZW50QWRkZWRFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJwYXJlbnRSZW1vdmVkRW1pdHRlciIsInJvb3RlZERpc3BsYXlDaGFuZ2VkRW1pdHRlciIsImRpc3Bvc2VFbWl0dGVyIiwicGRvbVBhcmVudENoYW5nZWRFbWl0dGVyIiwidmlzaWJsZVByb3BlcnR5IiwibGF6eUxpbmsiLCJwZG9tVmlzaWJsZVByb3BlcnR5IiwiZW5hYmxlZFByb3BlcnR5IiwiaW5wdXRFbmFibGVkUHJvcGVydHkiLCJkZWxldGUiLCJyZW1vdmVMaXN0ZW5lciIsInVubGluayIsImRpc3Bvc2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkRpc3BsYXllZFRyYWlsc1Byb3BlcnR5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIFByb3BlcnR5IHRoYXQgd2lsbCBjb250YWluIGEgbGlzdCBvZiBUcmFpbHMgd2hlcmUgdGhlIHJvb3Qgb2YgdGhlIHRyYWlsIGlzIGEgcm9vdCBOb2RlIG9mIGEgRGlzcGxheSwgYW5kIHRoZSBsZWFmXHJcbiAqIG5vZGUgaXMgdGhlIHByb3ZpZGVkIE5vZGUuXHJcbiAqXHJcbiAqIC8vIFJFVklFVzogVGhpcyBpcyBhIHZlcnkgY29tcGxpY2F0ZWQgY29tcG9uZW50IGFuZCBkZXNlcnZlcyBhIGJpdCBtb3JlIGRvYy4gU29tZSBpZGVhcyBhYm91dCB3aGF0IHRvIGV4cGxhaW46XHJcbiAqIC8vIFJFVklFVzogICAxLiBUaGF0IHRoaXMgaXMgc3luY2hyb25vdXNseSB1cGRhdGVkIGFuZCBkb2Vzbid0IGxpc3RlbiB0byBpbnN0YW5jZXMuXHJcbiAqIC8vIFJFVklFVzogICAyLlxyXG4gKiAvLyBSRVZJRVc6ICAgMi5cclxuICogLy8gUkVWSUVXOiAgIDIuXHJcbiAqXHJcbiAqIC8vIFJFVklFVzogY2FuIHlvdSBkZXNjcmliZSB0aGlzIGEgYml0IG1vcmUuIERvIHlvdSBtZWFuIGFueSBOb2RlIGluIGEgdHJhaWw/IFdoYXQgYWJvdXQgaWYgdGhlIHByb3ZpZGVkIE5vZGUgaXMgZGlzcG9zZWQ/XHJcbiAqIE5PVEU6IElmIGEgTm9kZSBpcyBkaXNwb3NlZCwgaXQgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIHRyYWlscy5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBUaW55UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9UaW55UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgeyBEaXNwbGF5LCBOb2RlLCBzY2VuZXJ5LCBUcmFpbCB9IGZyb20gJy4uL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5cclxudHlwZSBEaXNwbGF5UHJlZGljYXRlID0gRGlzcGxheSB8ICggKCBkaXNwbGF5OiBEaXNwbGF5ICkgPT4gYm9vbGVhbiApIHwgbnVsbDtcclxuXHJcbmV4cG9ydCB0eXBlIERpc3BsYXllZFRyYWlsc1Byb3BlcnR5T3B0aW9ucyA9IHtcclxuICAvLyBJZiBwcm92aWRlZCwgd2Ugd2lsbCBvbmx5IHJlcG9ydCB0cmFpbHMgdGhhdCBhcmUgcm9vdGVkIGZvciB0aGUgc3BlY2lmaWMgRGlzcGxheSBwcm92aWRlZC5cclxuICBkaXNwbGF5PzogRGlzcGxheVByZWRpY2F0ZTtcclxuXHJcbiAgLy8gSWYgdHJ1ZSwgd2Ugd2lsbCBhZGRpdGlvbmFsbHkgZm9sbG93IHRoZSBwZG9tUGFyZW50IGlmIGl0IGlzIGF2YWlsYWJsZSAoaWYgb3VyIGNoaWxkIG5vZGUgaXMgc3BlY2lmaWVkIGluIGEgcGRvbU9yZGVyIG9mIGFub3RoZXJcclxuICAvLyBub2RlLCB3ZSB3aWxsIGZvbGxvdyB0aGF0IG9yZGVyKS5cclxuICAvLyBUaGlzIGVzc2VudGlhbGx5IHRyYWNrcyB0aGUgZm9sbG93aW5nOlxyXG4gIC8vXHJcbiAgLy8gUkVWSUVXOiBJJ2QgYWN0dWFsbHkgYWRkIFthLXpdP1Bkb21bQS1aXSB0byBiYWQtc2ltLXRleHQgaWYgeW91J3JlIGFscmlnaHQgd2l0aCB0aGF0LiBDbG9zZSB0byBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY2hpcHBlci9ibG9iL2Y1NmMyNzM5NzBmMjJmODU3YmM4ZjViZDAxNDhmMjU2NTM0YTcwMmYvZXNsaW50L3J1bGVzL2JhZC1zaW0tdGV4dC5qcyNMMzUtTDM2XHJcbiAgLy9cclxuICAvLyBSRVZJRVc6IEFyZW4ndCB0aGVzZSBib29sZWFuIHZhbHVlcyBvcHBvc2l0ZT8gZm9sbG93UERPTU9yZGVyOnRydWUgc2hvdWxkIHJlc3BlY3QgcGRvbU9yZGVyLiBBbHNvLCBpdCBpc24ndCBjbGVhclxyXG4gIC8vICAgICAgICAgZnJvbSB0aGUgZG9jIGhvdyB5b3UgYXNrIGZvciBcImFsbCB0cmFpbHMsIHZpc3VhbCBvciBQRE9NXCIuIElzIHRoYXQgcGFydCBvZiB0aGUgZmVhdHVyZXNldD8gSSBiZWxpZXZlXHJcbiAgLy8gICAgICAgICB0aGF0IGxpa2VseSB3ZSB3b3VsZCBhbHdheXMgZm9yY2UgdmlzaWJsZSBhcyBhIGJhc2UgZmVhdHVyZSwgYW5kIG9ubHkgYWRkIG9uIHZpc2liaWxpdHksIGJ1dCB0aGlzIHNob3VsZFxyXG4gIC8vICAgICAgICAgYmUgZXhwbGFpbmVkLiBBcyBlYXN5IGFzIHRoZSBkb2MgdXBkYXRlIGFib3ZlIEkganVzdCBkaWQ6IFwid2Ugd2lsbCBfYWRkaXRpb25hbGx5XyBmb2xsb3cgdGhlIHBkb21QYXJlbnRcIlxyXG4gIC8vIC0gZm9sbG93UERPTU9yZGVyOiB0cnVlID0gdmlzdWFsIHRyYWlscyAoanVzdCBjaGlsZHJlbilcclxuICAvLyAtIGZvbGxvd1BET01PcmRlcjogZmFsc2UgPSBwZG9tIHRyYWlscyAocmVzcGVjdGluZyBwZG9tT3JkZXIpXHJcbiAgZm9sbG93UERPTU9yZGVyPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gSWYgdHJ1ZSwgd2Ugd2lsbCBvbmx5IHJlcG9ydCB0cmFpbHMgd2hlcmUgZXZlcnkgbm9kZSBpcyB2aXNpYmxlOiB0cnVlLlxyXG4gIHJlcXVpcmVWaXNpYmxlPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gSWYgdHJ1ZSwgd2Ugd2lsbCBvbmx5IHJlcG9ydCB0cmFpbHMgd2hlcmUgZXZlcnkgbm9kZSBpcyBwZG9tVmlzaWJsZTogdHJ1ZS5cclxuICByZXF1aXJlUERPTVZpc2libGU/OiBib29sZWFuO1xyXG5cclxuICAvLyBJZiB0cnVlLCB3ZSB3aWxsIG9ubHkgcmVwb3J0IHRyYWlscyB3aGVyZSBldmVyeSBub2RlIGlzIGVuYWJsZWQ6IHRydWUuXHJcbiAgcmVxdWlyZUVuYWJsZWQ/OiBib29sZWFuO1xyXG5cclxuICAvLyBJZiB0cnVlLCB3ZSB3aWxsIG9ubHkgcmVwb3J0IHRyYWlscyB3aGVyZSBldmVyeSBub2RlIGlzIGlucHV0RW5hYmxlZDogdHJ1ZS5cclxuICByZXF1aXJlSW5wdXRFbmFibGVkPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gUkVWSUVXOiBJbnN0ZWFkIG9mIGZvbGxvd2luZyB0aGUgc2FtZSBmZWF0dXJlIGFib3ZlLCBjYW4gd2UganVzdCB1c2UgYHBpY2thYmxlOmZhbHNlYCB0byBoZWxwIHVzIHBydW5lLiBJIGFncmVlXHJcbiAgLy8gICAgICAgICAgIGl0IG1heSBub3QgYmUgd29ydGggd2hpbGUgdG8gbGlzdGVuIHRvIHRoZSBjb21ibyBvZiBwaWNrYWJsZStpbnB1dExpc3RlbmVyTGVuZ3RoLiBDYW4geW91IGRlc2NyaWJlIHdoYXQgYmVuZWZpdFxyXG4gIC8vICAgICAgICAgICB3ZSBtYXkgZ2V0IGJ5IGFkZGluZyBpbiBQaWNrYWJsZSBsaXN0ZW5pbmc/XHJcbiAgLy8gTk9URTogQ291bGQgdGhpbmsgYWJvdXQgYWRkaW5nIHBpY2thYmlsaXR5IGhlcmUgaW4gdGhlIGZ1dHVyZS4gVGhlIGNvbXBsaWNhdGlvbiBpcyB0aGF0IGl0IGRvZXNuJ3QgbWVhc3VyZSBvdXIgaGl0XHJcbiAgLy8gdGVzdGluZyBwcmVjaXNlbHksIGJlY2F1c2Ugb2YgcGlja2FibGU6bnVsbCAoZGVmYXVsdCkgYW5kIHRoZSBwb3RlbnRpYWwgZXhpc3RlbmNlIG9mIGlucHV0IGxpc3RlbmVycy5cclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERpc3BsYXllZFRyYWlsc1Byb3BlcnR5IGV4dGVuZHMgVGlueVByb3BlcnR5PFRyYWlsW10+IHtcclxuXHJcbiAgLy8gUkVWSUVXOiBIb3cgYWJvdXQgYSByZW5hbWUgbGlrZSBcInRhcmdldE5vZGVcIiwgbm8gc3Ryb25nIHByZWZlcmVuY2UgaWYgeW91IGRvbid0IHdhbnQgdG8uXHJcbiAgcHVibGljIHJlYWRvbmx5IG5vZGU6IE5vZGU7XHJcblxyXG4gIC8vIFJFVklFVzogUGxlYXNlIGFkZCBkb2Mgd2h5IHdlIG9ubHkgbmVlZCB0byBsaXN0ZW4gdG8gYSBOb2RlIG9uY2UsIGV2ZW4gaWYgaXQgaXMgaW4gbXVsdGlwbGUgdHJhaWxzP1xyXG4gIHB1YmxpYyByZWFkb25seSBsaXN0ZW5lZE5vZGVTZXQ6IFNldDxOb2RlPiA9IG5ldyBTZXQ8Tm9kZT4oKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IF90cmFpbFVwZGF0ZUxpc3RlbmVyOiAoKSA9PiB2b2lkO1xyXG5cclxuICAvLyBSZWNvcmRlZCBvcHRpb25zXHJcbiAgLy8gUkVWSUVXOiBQbGVhc2UgcmVuYW1lIHRoaXMgYW5kIHRoZSBvcHRpb24gdG8gc29tZXRoaW5nIGxlc3MgY29uZnVzaW5nLiBQZXJoYXBzIGBkaXNwbGF5U3VwcG9ydGAsIG9yXHJcbiAgLy8gYHdoaWNoRGlzcGxheWAsIG9yIHNvbWV0aGluZyB0aGF0IHNvdW5kcyBsaWtlIGl0IGNvdWxkIGJlIGEgcHJlZGljYXRlLlxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcGxheTogRGlzcGxheVByZWRpY2F0ZTtcclxuICBwcml2YXRlIHJlYWRvbmx5IGZvbGxvd1BET01PcmRlcjogYm9vbGVhbjtcclxuICBwcml2YXRlIHJlYWRvbmx5IHJlcXVpcmVWaXNpYmxlOiBib29sZWFuO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWlyZVBET01WaXNpYmxlOiBib29sZWFuO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWlyZUVuYWJsZWQ6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSByZWFkb25seSByZXF1aXJlSW5wdXRFbmFibGVkOiBib29sZWFuO1xyXG5cclxuICAvKipcclxuICAgKiBXZSB3aWxsIGNvbnRhaW4gVHJhaWxzIHdob3NlIGxlYWYgbm9kZSAobGFzdE5vZGUpIGlzIHRoaXMgcHJvdmlkZWQgTm9kZS5cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIG5vZGU6IE5vZGUsIHByb3ZpZGVkT3B0aW9ucz86IERpc3BsYXllZFRyYWlsc1Byb3BlcnR5T3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPERpc3BsYXllZFRyYWlsc1Byb3BlcnR5T3B0aW9ucz4oKSgge1xyXG4gICAgICAvLyBMaXN0ZW4gdG8gYWxsIGRpc3BsYXlzXHJcbiAgICAgIGRpc3BsYXk6IG51bGwsXHJcblxyXG4gICAgICAvLyBEZWZhdWx0IHRvIHZpc3VhbCB0cmFpbHMgKGp1c3QgY2hpbGRyZW4pLCB3aXRoIG9ubHkgcHJ1bmluZyBieSBub3JtYWwgdmlzaWJpbGl0eVxyXG4gICAgICBmb2xsb3dQRE9NT3JkZXI6IGZhbHNlLFxyXG4gICAgICByZXF1aXJlVmlzaWJsZTogdHJ1ZSxcclxuICAgICAgcmVxdWlyZVBET01WaXNpYmxlOiBmYWxzZSxcclxuICAgICAgcmVxdWlyZUVuYWJsZWQ6IGZhbHNlLFxyXG4gICAgICByZXF1aXJlSW5wdXRFbmFibGVkOiBmYWxzZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIFtdICk7XHJcblxyXG4gICAgLy8gU2F2ZSBvcHRpb25zIGZvciBsYXRlciB1cGRhdGVzXHJcbiAgICB0aGlzLm5vZGUgPSBub2RlO1xyXG4gICAgdGhpcy5kaXNwbGF5ID0gb3B0aW9ucy5kaXNwbGF5O1xyXG4gICAgdGhpcy5mb2xsb3dQRE9NT3JkZXIgPSBvcHRpb25zLmZvbGxvd1BET01PcmRlcjtcclxuICAgIHRoaXMucmVxdWlyZVZpc2libGUgPSBvcHRpb25zLnJlcXVpcmVWaXNpYmxlO1xyXG4gICAgdGhpcy5yZXF1aXJlUERPTVZpc2libGUgPSBvcHRpb25zLnJlcXVpcmVQRE9NVmlzaWJsZTtcclxuICAgIHRoaXMucmVxdWlyZUVuYWJsZWQgPSBvcHRpb25zLnJlcXVpcmVFbmFibGVkO1xyXG4gICAgdGhpcy5yZXF1aXJlSW5wdXRFbmFibGVkID0gb3B0aW9ucy5yZXF1aXJlSW5wdXRFbmFibGVkO1xyXG5cclxuICAgIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgPSB0aGlzLnVwZGF0ZS5iaW5kKCB0aGlzICk7XHJcblxyXG4gICAgdGhpcy51cGRhdGUoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlKCk6IHZvaWQge1xyXG5cclxuICAgIC8vIEZhY3RvcmVkIG91dCBiZWNhdXNlIHdlJ3JlIHVzaW5nIGEgXCJmdW5jdGlvblwiIGJlbG93IGZvciByZWN1cnNpb24gKE5PVCBhbiBhcnJvdyBmdW5jdGlvbilcclxuICAgIGNvbnN0IGRpc3BsYXkgPSB0aGlzLmRpc3BsYXk7XHJcbiAgICBjb25zdCBmb2xsb3dQRE9NT3JkZXIgPSB0aGlzLmZvbGxvd1BET01PcmRlcjtcclxuICAgIGNvbnN0IHJlcXVpcmVWaXNpYmxlID0gdGhpcy5yZXF1aXJlVmlzaWJsZTtcclxuICAgIGNvbnN0IHJlcXVpcmVQRE9NVmlzaWJsZSA9IHRoaXMucmVxdWlyZVBET01WaXNpYmxlO1xyXG4gICAgY29uc3QgcmVxdWlyZUVuYWJsZWQgPSB0aGlzLnJlcXVpcmVFbmFibGVkO1xyXG4gICAgY29uc3QgcmVxdWlyZUlucHV0RW5hYmxlZCA9IHRoaXMucmVxdWlyZUlucHV0RW5hYmxlZDtcclxuXHJcbiAgICAvLyBUcmFpbHMgYWNjdW11bGF0ZWQgaW4gb3VyIHJlY3Vyc2lvbiB0aGF0IHdpbGwgYmUgb3VyIFByb3BlcnR5J3MgdmFsdWVcclxuICAgIGNvbnN0IHRyYWlsczogVHJhaWxbXSA9IFtdO1xyXG5cclxuICAgIC8vIE5vZGVzIHRoYXQgd2VyZSB0b3VjaGVkIGluIHRoZSBzY2FuICh3ZSBzaG91bGQgbGlzdGVuIHRvIGNoYW5nZXMgdG8gQU5ZIG9mIHRoZXNlIHRvIHNlZSBpZiB0aGVyZSBpcyBhIGNvbm5lY3Rpb25cclxuICAgIC8vIG9yIGRpc2Nvbm5lY3Rpb24pLiBUaGlzIGNvdWxkIHBvdGVudGlhbGx5IGNhdXNlIG91ciBQcm9wZXJ0eSB0byBjaGFuZ2VcclxuICAgIGNvbnN0IG5vZGVTZXQgPSBuZXcgU2V0PE5vZGU+KCk7XHJcblxyXG4gICAgLy8gTW9kaWZpZWQgaW4tcGxhY2UgZHVyaW5nIHRoZSBzZWFyY2hcclxuICAgIGNvbnN0IHRyYWlsID0gbmV3IFRyYWlsKCB0aGlzLm5vZGUgKTtcclxuXHJcbiAgICAvLyBXZSB3aWxsIHJlY3Vyc2l2ZWx5IGFkZCB0aGluZ3MgdG8gdGhlIFwiZnJvbnRcIiBvZiB0aGUgdHJhaWwgKGFuY2VzdG9ycylcclxuICAgICggZnVuY3Rpb24gcmVjdXJzZSgpIHtcclxuICAgICAgY29uc3Qgcm9vdCA9IHRyYWlsLnJvb3ROb2RlKCk7XHJcblxyXG4gICAgICAvLyBJZiBhIE5vZGUgaXMgZGlzcG9zZWQsIHdlIHdvbid0IGFkZCBsaXN0ZW5lcnMgdG8gaXQsIHNvIHdlIGFib3J0IHNsaWdodGx5IGVhcmxpZXIuXHJcbiAgICAgIGlmICggcm9vdC5pc0Rpc3Bvc2VkICkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgbm9kZVNldC5hZGQoIHJvb3QgKTtcclxuXHJcbiAgICAgIC8vIFJFVklFVzogUGxlYXNlIHNheSB3aHkgd2UgbmVlZCBsaXN0ZW5lcnMgb24gdGhpcyBOb2RlLiBBbHNvIHBsZWFzZSBjb25maXJtICh2aWEgZG9jKSB0aGF0IGFkZGluZ1xyXG4gICAgICAvLyBJZiB3ZSBmYWlsIG90aGVyIGNvbmRpdGlvbnMsIHdlIHdvbid0IGFkZCBhIHRyYWlsIE9SIHJlY3Vyc2UsIGJ1dCB3ZSB3aWxsIFNUSUxMIGhhdmUgbGlzdGVuZXJzIGFkZGVkIHRvIHRoZSBOb2RlLlxyXG4gICAgICBpZiAoXHJcbiAgICAgICAgKCByZXF1aXJlVmlzaWJsZSAmJiAhcm9vdC52aXNpYmxlICkgfHxcclxuICAgICAgICAoIHJlcXVpcmVQRE9NVmlzaWJsZSAmJiAhcm9vdC5wZG9tVmlzaWJsZSApIHx8XHJcbiAgICAgICAgKCByZXF1aXJlRW5hYmxlZCAmJiAhcm9vdC5lbmFibGVkICkgfHxcclxuICAgICAgICAoIHJlcXVpcmVJbnB1dEVuYWJsZWQgJiYgIXJvb3QuaW5wdXRFbmFibGVkIClcclxuICAgICAgKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBkaXNwbGF5cyA9IHJvb3QuZ2V0Um9vdGVkRGlzcGxheXMoKTtcclxuXHJcbiAgICAgIC8vIFJFVklFVzogaW5pdGlhbGl6ZSB0byBmYWxzZT9cclxuICAgICAgbGV0IGRpc3BsYXlNYXRjaGVzOiBib29sZWFuO1xyXG5cclxuICAgICAgaWYgKCBkaXNwbGF5ID09PSBudWxsICkge1xyXG4gICAgICAgIGRpc3BsYXlNYXRjaGVzID0gZGlzcGxheXMubGVuZ3RoID4gMDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIGlmICggZGlzcGxheSBpbnN0YW5jZW9mIERpc3BsYXkgKSB7XHJcbiAgICAgICAgZGlzcGxheU1hdGNoZXMgPSBkaXNwbGF5cy5pbmNsdWRlcyggZGlzcGxheSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIGRpc3BsYXlNYXRjaGVzID0gZGlzcGxheXMuc29tZSggZGlzcGxheSApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIGRpc3BsYXlNYXRjaGVzICkge1xyXG4gICAgICAgIC8vIENyZWF0ZSBhIHBlcm1hbmVudCBjb3B5IHRoYXQgd29uJ3QgYmUgbXV0YXRlZFxyXG4gICAgICAgIHRyYWlscy5wdXNoKCB0cmFpbC5jb3B5KCkgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUkVWSUVXOiBJJ20gb2ZmaWNpYWxseSBjb25mdXNlZCBhYm91dCB0aGlzIGZlYXR1cmUuIFdoYXQgaXMgdGhlIHZhbHVlIG9mIFwiZWl0aGVyIG9yXCIsIHdoeSBub3QgYmUgYWJsZSB0b1xyXG4gICAgICAvLyBzdXBwb3J0IGJvdGggdmlzdWFsIGFuZCBQRE9NIGluIHRoZSBzYW1lIFByb3BlcnR5PyBJZiB0aGlzIGlzIGluZGVlZCBiZXN0LCBwbGVhc2UgYmUgc3VyZSB0byBleHBsYWluIHdoZXJlXHJcbiAgICAgIC8vIHRoZSBvcHRpb24gaXMgZGVmaW5lZC5cclxuICAgICAgY29uc3QgcGFyZW50cyA9IGZvbGxvd1BET01PcmRlciAmJiByb290LnBkb21QYXJlbnQgPyBbIHJvb3QucGRvbVBhcmVudCBdIDogcm9vdC5wYXJlbnRzO1xyXG5cclxuICAgICAgcGFyZW50cy5mb3JFYWNoKCBwYXJlbnQgPT4ge1xyXG4gICAgICAgIHRyYWlsLmFkZEFuY2VzdG9yKCBwYXJlbnQgKTtcclxuICAgICAgICByZWN1cnNlKCk7XHJcbiAgICAgICAgdHJhaWwucmVtb3ZlQW5jZXN0b3IoKTtcclxuICAgICAgfSApO1xyXG4gICAgfSApKCk7XHJcblxyXG4gICAgLy8gUkVWSUVXOiBXZWJzdG9ybSBmbGFnZ2VkIHRoZSBuZXh0IDI5IGxpbmVzIGFzIGR1cGxpY2F0ZWQgd2l0aCBUcmFpbHNCZXR3ZWVuUHJvcGVydHkuIExldCdzIGZhY3RvciB0aGF0IG91ciBvciBmaXggdGhhdCBzb21laG93LlxyXG4gICAgLy8gQWRkIGluIG5ldyBuZWVkZWQgbGlzdGVuZXJzXHJcbiAgICBub2RlU2V0LmZvckVhY2goIG5vZGUgPT4ge1xyXG4gICAgICBpZiAoICF0aGlzLmxpc3RlbmVkTm9kZVNldC5oYXMoIG5vZGUgKSApIHtcclxuICAgICAgICB0aGlzLmFkZE5vZGVMaXN0ZW5lciggbm9kZSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gUmVtb3ZlIGxpc3RlbmVycyBub3QgbmVlZGVkIGFueW1vcmVcclxuICAgIHRoaXMubGlzdGVuZWROb2RlU2V0LmZvckVhY2goIG5vZGUgPT4ge1xyXG4gICAgICBpZiAoICFub2RlU2V0Lmhhcyggbm9kZSApICkge1xyXG4gICAgICAgIHRoaXMucmVtb3ZlTm9kZUxpc3RlbmVyKCBub2RlICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBHdWFyZCBpbiBhIHdheSB0aGF0IGRlZXBFcXVhbGl0eSBvbiB0aGUgUHJvcGVydHkgd291bGRuJ3QgKGJlY2F1c2Ugb2YgdGhlIEFycmF5IHdyYXBwZXIpXHJcbiAgICAvLyBOT1RFOiBEdXBsaWNhdGVkIHdpdGggVHJhaWxzQmV0d2VlblByb3BlcnR5LCBsaWtlbHkgY2FuIGJlIGZhY3RvcmVkIG91dC5cclxuICAgIC8vIFJFVklFVzogXl5eXiArMSwgeWVzIHBsZWFzZSBmYWN0b3Igb3V0LlxyXG4gICAgY29uc3QgY3VycmVudFRyYWlscyA9IHRoaXMudmFsdWU7XHJcbiAgICBsZXQgdHJhaWxzRXF1YWwgPSBjdXJyZW50VHJhaWxzLmxlbmd0aCA9PT0gdHJhaWxzLmxlbmd0aDtcclxuICAgIGlmICggdHJhaWxzRXF1YWwgKSB7XHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRyYWlscy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICBpZiAoICFjdXJyZW50VHJhaWxzWyBpIF0uZXF1YWxzKCB0cmFpbHNbIGkgXSApICkge1xyXG4gICAgICAgICAgdHJhaWxzRXF1YWwgPSBmYWxzZTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFJFVklFVzogQ2FuIHRoaXMgYmUgaW1wcm92ZWQgdXBvbiBieSB1dGlsaXppbmcgYSBjdXN0b20gdmFsdWVDb21wYXJpc29uU3RyYXRlZ3k/IEkgZG9uJ3Qgc2VlIHRoYXQgYmVpbmcgbXVjaFxyXG4gICAgLy8gbGVzcyBwZXJmb3JtYW50IGdpdmVuIHRoYXQgeW91IGFyZSBkb2luZyBhbGwgdGhlIGFib3ZlIHdvcmsgb24gZWFjaCBjYWxsIHRvIHVwZGF0ZSgpLlxyXG4gICAgaWYgKCAhdHJhaWxzRXF1YWwgKSB7XHJcbiAgICAgIHRoaXMudmFsdWUgPSB0cmFpbHM7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBSRVZJRVc6IFJlbmFtZSB0byBlaXRoZXIgYGFkZE5vZGVMaXN0ZW5lcnNgLCBvciBzb21ldGhpbmcgbW9yZSBnZW5lcmFsIGxpa2UgYGxpc3RlblRvTm9kZSgpYC5cclxuICBwcml2YXRlIGFkZE5vZGVMaXN0ZW5lciggbm9kZTogTm9kZSApOiB2b2lkIHtcclxuICAgIHRoaXMubGlzdGVuZWROb2RlU2V0LmFkZCggbm9kZSApO1xyXG5cclxuICAgIC8vIFVuY29uZGl0aW9uYWwgbGlzdGVuZXJzLCB3aGljaCBhZmZlY3QgYWxsIG5vZGVzLlxyXG4gICAgbm9kZS5wYXJlbnRBZGRlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIG5vZGUucGFyZW50UmVtb3ZlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIG5vZGUucm9vdGVkRGlzcGxheUNoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLl90cmFpbFVwZGF0ZUxpc3RlbmVyICk7XHJcbiAgICBub2RlLmRpc3Bvc2VFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLl90cmFpbFVwZGF0ZUxpc3RlbmVyICk7XHJcblxyXG4gICAgaWYgKCB0aGlzLmZvbGxvd1BET01PcmRlciApIHtcclxuICAgICAgbm9kZS5wZG9tUGFyZW50Q2hhbmdlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIH1cclxuICAgIGlmICggdGhpcy5yZXF1aXJlVmlzaWJsZSApIHtcclxuICAgICAgbm9kZS52aXNpYmxlUHJvcGVydHkubGF6eUxpbmsoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIH1cclxuICAgIGlmICggdGhpcy5yZXF1aXJlUERPTVZpc2libGUgKSB7XHJcbiAgICAgIG5vZGUucGRvbVZpc2libGVQcm9wZXJ0eS5sYXp5TGluayggdGhpcy5fdHJhaWxVcGRhdGVMaXN0ZW5lciApO1xyXG4gICAgfVxyXG4gICAgaWYgKCB0aGlzLnJlcXVpcmVFbmFibGVkICkge1xyXG4gICAgICBub2RlLmVuYWJsZWRQcm9wZXJ0eS5sYXp5TGluayggdGhpcy5fdHJhaWxVcGRhdGVMaXN0ZW5lciApO1xyXG4gICAgfVxyXG4gICAgaWYgKCB0aGlzLnJlcXVpcmVJbnB1dEVuYWJsZWQgKSB7XHJcbiAgICAgIG5vZGUuaW5wdXRFbmFibGVkUHJvcGVydHkubGF6eUxpbmsoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlTm9kZUxpc3RlbmVyKCBub2RlOiBOb2RlICk6IHZvaWQge1xyXG4gICAgdGhpcy5saXN0ZW5lZE5vZGVTZXQuZGVsZXRlKCBub2RlICk7XHJcbiAgICBub2RlLnBhcmVudEFkZGVkRW1pdHRlci5yZW1vdmVMaXN0ZW5lciggdGhpcy5fdHJhaWxVcGRhdGVMaXN0ZW5lciApO1xyXG4gICAgbm9kZS5wYXJlbnRSZW1vdmVkRW1pdHRlci5yZW1vdmVMaXN0ZW5lciggdGhpcy5fdHJhaWxVcGRhdGVMaXN0ZW5lciApO1xyXG4gICAgbm9kZS5yb290ZWREaXNwbGF5Q2hhbmdlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIG5vZGUuZGlzcG9zZUVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuXHJcbiAgICBpZiAoIHRoaXMuZm9sbG93UERPTU9yZGVyICkge1xyXG4gICAgICBub2RlLnBkb21QYXJlbnRDaGFuZ2VkRW1pdHRlci5yZW1vdmVMaXN0ZW5lciggdGhpcy5fdHJhaWxVcGRhdGVMaXN0ZW5lciApO1xyXG4gICAgfVxyXG4gICAgaWYgKCB0aGlzLnJlcXVpcmVWaXNpYmxlICkge1xyXG4gICAgICBub2RlLnZpc2libGVQcm9wZXJ0eS51bmxpbmsoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIH1cclxuICAgIGlmICggdGhpcy5yZXF1aXJlUERPTVZpc2libGUgKSB7XHJcbiAgICAgIG5vZGUucGRvbVZpc2libGVQcm9wZXJ0eS51bmxpbmsoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIH1cclxuICAgIGlmICggdGhpcy5yZXF1aXJlRW5hYmxlZCApIHtcclxuICAgICAgbm9kZS5lbmFibGVkUHJvcGVydHkudW5saW5rKCB0aGlzLl90cmFpbFVwZGF0ZUxpc3RlbmVyICk7XHJcbiAgICB9XHJcbiAgICBpZiAoIHRoaXMucmVxdWlyZUlucHV0RW5hYmxlZCApIHtcclxuICAgICAgbm9kZS5pbnB1dEVuYWJsZWRQcm9wZXJ0eS51bmxpbmsoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFJFVklFVzogSSBhbHdheXMgZm9yZ2V0IHdoeSB5b3UgZG9uJ3QgbmVlZCB0byBhbHNvIGNsZWFyIHlvdXIgcmVmZXJlbmNlIHRvIHRoZSBwcm92aWRlZCBOb2RlLiBEbyB5b3U/XHJcbiAgLy8gUkVWSUVXOiBBbHNvIG1heWJlIGFzc2VydCBoZXJlIHRoYXQgeW91ciBwcm92aWRlZCBub2RlIGlzIGluIHRoaXMgbGlzdGVuZWQgdG8gTm9kZSBzZXQ/XHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3RlbmVkTm9kZVNldC5mb3JFYWNoKCBub2RlID0+IHRoaXMucmVtb3ZlTm9kZUxpc3RlbmVyKCBub2RlICkgKTtcclxuXHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5zY2VuZXJ5LnJlZ2lzdGVyKCAnRGlzcGxheWVkVHJhaWxzUHJvcGVydHknLCBEaXNwbGF5ZWRUcmFpbHNQcm9wZXJ0eSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FB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