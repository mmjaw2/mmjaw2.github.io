// Copyright 2017-2024, University of Colorado Boulder

/**
 * A listener for common button usage, providing the fire() method/callback and helpful properties. NOTE that it doesn't
 * need to be an actual button (or look like a button), this is useful whenever that type of "fire" behavior is helpful.
 *
 * For example usage, see scenery/examples/input.html. Usually you can just pass a fire callback and things work.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import CallbackTimer from '../../../axon/js/CallbackTimer.js';
import Emitter from '../../../axon/js/Emitter.js';
import optionize from '../../../phet-core/js/optionize.js';
import EventType from '../../../tandem/js/EventType.js';
import PhetioObject from '../../../tandem/js/PhetioObject.js';
import Tandem from '../../../tandem/js/Tandem.js';
import NullableIO from '../../../tandem/js/types/NullableIO.js';
import { PressListener, scenery, SceneryEvent } from '../imports.js';
export default class FireListener extends PressListener {
  constructor(providedOptions) {
    const options = optionize()({
      fire: _.noop,
      fireOnDown: false,
      fireOnHold: false,
      fireOnHoldDelay: 400,
      fireOnHoldInterval: 100,
      // phet-io
      tandem: Tandem.REQUIRED,
      // Though FireListener is not instrumented, declare these here to support properly passing this to children
      phetioReadOnly: PhetioObject.DEFAULT_OPTIONS.phetioReadOnly
    }, providedOptions);
    assert && assert(typeof options.fire === 'function', 'The fire callback should be a function');
    assert && assert(typeof options.fireOnDown === 'boolean', 'fireOnDown should be a boolean');

    // @ts-expect-error TODO see https://github.com/phetsims/phet-core/issues/128
    super(options);
    this._fireOnDown = options.fireOnDown;
    this.firedEmitter = new Emitter({
      tandem: options.tandem.createTandem('firedEmitter'),
      phetioEventType: EventType.USER,
      phetioReadOnly: options.phetioReadOnly,
      phetioDocumentation: 'Emits at the time that the listener fires',
      parameters: [{
        name: 'event',
        phetioType: NullableIO(SceneryEvent.SceneryEventIO)
      }]
    });
    // @ts-expect-error TODO Emitter https://github.com/phetsims/scenery/issues/1581
    this.firedEmitter.addListener(options.fire);

    // Create a timer to handle the optional fire-on-hold feature.
    // When that feature is enabled, calling this.fire is delegated to the timer.
    if (options.fireOnHold) {
      this._timer = new CallbackTimer({
        callback: this.fire.bind(this, null),
        // Pass null for fire-on-hold events
        delay: options.fireOnHoldDelay,
        interval: options.fireOnHoldInterval
      });
    }
  }

  /**
   * Fires any associated button fire callback.
   *
   * NOTE: This is safe to call on the listener externally.
   */
  fire(event) {
    sceneryLog && sceneryLog.InputListener && sceneryLog.InputListener('FireListener fire');
    sceneryLog && sceneryLog.InputListener && sceneryLog.push();
    this.firedEmitter.emit(event);
    sceneryLog && sceneryLog.InputListener && sceneryLog.pop();
  }

  /**
   * Presses the button.
   *
   * NOTE: This is safe to call externally in order to attempt to start a press. fireListener.canPress( event ) can
   * be used to determine whether this will actually start a press.
   *
   * @param event
   * @param [targetNode] - If provided, will take the place of the targetNode for this call. Useful for
   *                              forwarded presses.
   * @param [callback] - to be run at the end of the function, but only on success
   * @returns success - Returns whether the press was actually started
   */
  press(event, targetNode, callback) {
    return super.press(event, targetNode, () => {
      // This function is only called on success
      if (this._fireOnDown) {
        this.fire(event);
      }
      if (this._timer) {
        this._timer.start();
      }
      callback && callback();
    });
  }

  /**
   * Releases the button.
   *
   * NOTE: This can be safely called externally in order to force a release of this button (no actual 'up' event is
   * needed). If the cancel/interrupt behavior is more preferable (will not fire the button), then call interrupt()
   * on this listener instead.
   *
   * @param [event] - scenery event if there was one
   * @param [callback] - called at the end of the release
   */
  release(event, callback) {
    super.release(event, () => {
      // Notify after the rest of release is called in order to prevent it from triggering interrupt().
      const shouldFire = !this._fireOnDown && this.isHoveringProperty.value && !this.interrupted;
      if (this._timer) {
        this._timer.stop(shouldFire);
      } else if (shouldFire) {
        this.fire(event || null);
      }
      callback && callback();
    });
  }

  /**
   * Clicks the listener, pressing it and releasing it immediately. Part of the scenery input API, triggered from PDOM
   * events for accessibility.
   *
   * Click does not involve the FireListener timer because it is a discrete event that
   * presses and releases the listener immediately. This behavior is a limitation imposed
   * by screen reader technology. See PressListener.click for more information.
   *
   * NOTE: This can be safely called externally in order to click the listener, event is not required.
   * fireListener.canClick() can be used to determine if this will actually trigger a click.
   *
   * @param [event]
   * @param [callback] - called at the end of the click
   */
  click(event, callback) {
    return super.click(event, () => {
      // don't click if listener was interrupted before this callback
      if (!this.interrupted) {
        this.fire(event);
      }
      callback && callback();
    });
  }

  /**
   * Interrupts the listener, releasing it (canceling behavior).
   *
   * This effectively releases/ends the press, and sets the `interrupted` flag to true while firing these events
   * so that code can determine whether a release/end happened naturally, or was canceled in some way.
   *
   * This can be called manually, but can also be called through node.interruptSubtreeInput().
   */
  interrupt() {
    super.interrupt();
    this._timer && this._timer.stop(false); // Stop the timer, don't fire if we haven't already
  }
  dispose() {
    this.firedEmitter.dispose();
    this._timer && this._timer.dispose();
    super.dispose();
  }
}
scenery.register('FireListener', FireListener);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDYWxsYmFja1RpbWVyIiwiRW1pdHRlciIsIm9wdGlvbml6ZSIsIkV2ZW50VHlwZSIsIlBoZXRpb09iamVjdCIsIlRhbmRlbSIsIk51bGxhYmxlSU8iLCJQcmVzc0xpc3RlbmVyIiwic2NlbmVyeSIsIlNjZW5lcnlFdmVudCIsIkZpcmVMaXN0ZW5lciIsImNvbnN0cnVjdG9yIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsImZpcmUiLCJfIiwibm9vcCIsImZpcmVPbkRvd24iLCJmaXJlT25Ib2xkIiwiZmlyZU9uSG9sZERlbGF5IiwiZmlyZU9uSG9sZEludGVydmFsIiwidGFuZGVtIiwiUkVRVUlSRUQiLCJwaGV0aW9SZWFkT25seSIsIkRFRkFVTFRfT1BUSU9OUyIsImFzc2VydCIsIl9maXJlT25Eb3duIiwiZmlyZWRFbWl0dGVyIiwiY3JlYXRlVGFuZGVtIiwicGhldGlvRXZlbnRUeXBlIiwiVVNFUiIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJwYXJhbWV0ZXJzIiwibmFtZSIsInBoZXRpb1R5cGUiLCJTY2VuZXJ5RXZlbnRJTyIsImFkZExpc3RlbmVyIiwiX3RpbWVyIiwiY2FsbGJhY2siLCJiaW5kIiwiZGVsYXkiLCJpbnRlcnZhbCIsImV2ZW50Iiwic2NlbmVyeUxvZyIsIklucHV0TGlzdGVuZXIiLCJwdXNoIiwiZW1pdCIsInBvcCIsInByZXNzIiwidGFyZ2V0Tm9kZSIsInN0YXJ0IiwicmVsZWFzZSIsInNob3VsZEZpcmUiLCJpc0hvdmVyaW5nUHJvcGVydHkiLCJ2YWx1ZSIsImludGVycnVwdGVkIiwic3RvcCIsImNsaWNrIiwiaW50ZXJydXB0IiwiZGlzcG9zZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRmlyZUxpc3RlbmVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LTIwMjQsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgbGlzdGVuZXIgZm9yIGNvbW1vbiBidXR0b24gdXNhZ2UsIHByb3ZpZGluZyB0aGUgZmlyZSgpIG1ldGhvZC9jYWxsYmFjayBhbmQgaGVscGZ1bCBwcm9wZXJ0aWVzLiBOT1RFIHRoYXQgaXQgZG9lc24ndFxyXG4gKiBuZWVkIHRvIGJlIGFuIGFjdHVhbCBidXR0b24gKG9yIGxvb2sgbGlrZSBhIGJ1dHRvbiksIHRoaXMgaXMgdXNlZnVsIHdoZW5ldmVyIHRoYXQgdHlwZSBvZiBcImZpcmVcIiBiZWhhdmlvciBpcyBoZWxwZnVsLlxyXG4gKlxyXG4gKiBGb3IgZXhhbXBsZSB1c2FnZSwgc2VlIHNjZW5lcnkvZXhhbXBsZXMvaW5wdXQuaHRtbC4gVXN1YWxseSB5b3UgY2FuIGp1c3QgcGFzcyBhIGZpcmUgY2FsbGJhY2sgYW5kIHRoaW5ncyB3b3JrLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IENhbGxiYWNrVGltZXIgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9DYWxsYmFja1RpbWVyLmpzJztcclxuaW1wb3J0IEVtaXR0ZXIgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9FbWl0dGVyLmpzJztcclxuaW1wb3J0IFRFbWl0dGVyIGZyb20gJy4uLy4uLy4uL2F4b24vanMvVEVtaXR0ZXIuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgRXZlbnRUeXBlIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9FdmVudFR5cGUuanMnO1xyXG5pbXBvcnQgUGhldGlvT2JqZWN0IGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgTnVsbGFibGVJTyBmcm9tICcuLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIFByZXNzTGlzdGVuZXIsIFByZXNzTGlzdGVuZXJPcHRpb25zLCBzY2VuZXJ5LCBTY2VuZXJ5RXZlbnQsIFRJbnB1dExpc3RlbmVyIH0gZnJvbSAnLi4vaW1wb3J0cy5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIC8vIENhbGxlZCBhcyBmaXJlKCkgd2hlbiB0aGUgYnV0dG9uIGlzIGZpcmVkLlxyXG4gIGZpcmU/OiAoIGV2ZW50OiBTY2VuZXJ5RXZlbnQ8TW91c2VFdmVudCB8IFRvdWNoRXZlbnQgfCBQb2ludGVyRXZlbnQgfCBGb2N1c0V2ZW50IHwgS2V5Ym9hcmRFdmVudD4gKSA9PiB2b2lkO1xyXG5cclxuICAvLyBJZiB0cnVlLCB0aGUgYnV0dG9uIHdpbGwgZmlyZSB3aGVuIHRoZSBidXR0b24gaXMgcHJlc3NlZC4gSWYgZmFsc2UsIHRoZSBidXR0b24gd2lsbCBmaXJlIHdoZW4gdGhlXHJcbiAgLy8gYnV0dG9uIGlzIHJlbGVhc2VkIHdoaWxlIHRoZSBwb2ludGVyIGlzIG92ZXIgdGhlIGJ1dHRvbi5cclxuICBmaXJlT25Eb3duPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gZmlyZS1vbi1ob2xkIGZlYXR1cmUsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvc2NlbmVyeS9pc3N1ZXMvMTAwNFxyXG4gIC8vIFRPRE86IHRoZXNlIG9wdGlvbnMgYXJlIG5vdCBzdXBwb3J0ZWQgd2l0aCBQRE9NIGludGVyYWN0aW9uLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3NjZW5lcnkvaXNzdWVzLzExMTdcclxuICBmaXJlT25Ib2xkPzogYm9vbGVhbjsgLy8gaXMgdGhlIGZpcmUtb24taG9sZCBmZWF0dXJlIGVuYWJsZWQ/XHJcbiAgZmlyZU9uSG9sZERlbGF5PzogbnVtYmVyOyAvLyBzdGFydCB0byBmaXJlIGNvbnRpbnVvdXNseSBhZnRlciBwcmVzc2luZyBmb3IgdGhpcyBsb25nIChtaWxsaXNlY29uZHMpXHJcbiAgZmlyZU9uSG9sZEludGVydmFsPzogbnVtYmVyOyAvLyBmaXJlIGNvbnRpbnVvdXNseSBhdCB0aGlzIGludGVydmFsIChtaWxsaXNlY29uZHMpXHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBGaXJlTGlzdGVuZXJPcHRpb25zPExpc3RlbmVyIGV4dGVuZHMgRmlyZUxpc3RlbmVyPiA9IFNlbGZPcHRpb25zICYgUHJlc3NMaXN0ZW5lck9wdGlvbnM8TGlzdGVuZXI+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRmlyZUxpc3RlbmVyIGV4dGVuZHMgUHJlc3NMaXN0ZW5lciBpbXBsZW1lbnRzIFRJbnB1dExpc3RlbmVyIHtcclxuXHJcbiAgcHJpdmF0ZSBfZmlyZU9uRG93bjogYm9vbGVhbjtcclxuICBwcml2YXRlIGZpcmVkRW1pdHRlcjogVEVtaXR0ZXI8WyBTY2VuZXJ5RXZlbnQ8TW91c2VFdmVudCB8IFRvdWNoRXZlbnQgfCBQb2ludGVyRXZlbnQgfCBGb2N1c0V2ZW50IHwgS2V5Ym9hcmRFdmVudD4gfCBudWxsIF0+O1xyXG4gIHByaXZhdGUgX3RpbWVyPzogQ2FsbGJhY2tUaW1lcjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwcm92aWRlZE9wdGlvbnM/OiBGaXJlTGlzdGVuZXJPcHRpb25zPEZpcmVMaXN0ZW5lcj4gKSB7XHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEZpcmVMaXN0ZW5lck9wdGlvbnM8RmlyZUxpc3RlbmVyPiwgU2VsZk9wdGlvbnMsIFByZXNzTGlzdGVuZXJPcHRpb25zPEZpcmVMaXN0ZW5lcj4+KCkoIHtcclxuICAgICAgZmlyZTogXy5ub29wLFxyXG4gICAgICBmaXJlT25Eb3duOiBmYWxzZSxcclxuICAgICAgZmlyZU9uSG9sZDogZmFsc2UsXHJcbiAgICAgIGZpcmVPbkhvbGREZWxheTogNDAwLFxyXG4gICAgICBmaXJlT25Ib2xkSW50ZXJ2YWw6IDEwMCxcclxuXHJcbiAgICAgIC8vIHBoZXQtaW9cclxuICAgICAgdGFuZGVtOiBUYW5kZW0uUkVRVUlSRUQsXHJcblxyXG4gICAgICAvLyBUaG91Z2ggRmlyZUxpc3RlbmVyIGlzIG5vdCBpbnN0cnVtZW50ZWQsIGRlY2xhcmUgdGhlc2UgaGVyZSB0byBzdXBwb3J0IHByb3Blcmx5IHBhc3NpbmcgdGhpcyB0byBjaGlsZHJlblxyXG4gICAgICBwaGV0aW9SZWFkT25seTogUGhldGlvT2JqZWN0LkRFRkFVTFRfT1BUSU9OUy5waGV0aW9SZWFkT25seVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdHlwZW9mIG9wdGlvbnMuZmlyZSA9PT0gJ2Z1bmN0aW9uJywgJ1RoZSBmaXJlIGNhbGxiYWNrIHNob3VsZCBiZSBhIGZ1bmN0aW9uJyApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdHlwZW9mIG9wdGlvbnMuZmlyZU9uRG93biA9PT0gJ2Jvb2xlYW4nLCAnZmlyZU9uRG93biBzaG91bGQgYmUgYSBib29sZWFuJyApO1xyXG5cclxuICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgVE9ETyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3BoZXQtY29yZS9pc3N1ZXMvMTI4XHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuX2ZpcmVPbkRvd24gPSBvcHRpb25zLmZpcmVPbkRvd247XHJcblxyXG4gICAgdGhpcy5maXJlZEVtaXR0ZXIgPSBuZXcgRW1pdHRlcjxbIFNjZW5lcnlFdmVudDxNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCB8IFBvaW50ZXJFdmVudCB8IEZvY3VzRXZlbnQgfCBLZXlib2FyZEV2ZW50PiB8IG51bGwgXT4oIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdmaXJlZEVtaXR0ZXInICksXHJcbiAgICAgIHBoZXRpb0V2ZW50VHlwZTogRXZlbnRUeXBlLlVTRVIsXHJcbiAgICAgIHBoZXRpb1JlYWRPbmx5OiBvcHRpb25zLnBoZXRpb1JlYWRPbmx5LFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnRW1pdHMgYXQgdGhlIHRpbWUgdGhhdCB0aGUgbGlzdGVuZXIgZmlyZXMnLFxyXG4gICAgICBwYXJhbWV0ZXJzOiBbIHtcclxuICAgICAgICBuYW1lOiAnZXZlbnQnLFxyXG4gICAgICAgIHBoZXRpb1R5cGU6IE51bGxhYmxlSU8oIFNjZW5lcnlFdmVudC5TY2VuZXJ5RXZlbnRJTyApXHJcbiAgICAgIH0gXVxyXG4gICAgfSApO1xyXG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvciBUT0RPIEVtaXR0ZXIgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3NjZW5lcnkvaXNzdWVzLzE1ODFcclxuICAgIHRoaXMuZmlyZWRFbWl0dGVyLmFkZExpc3RlbmVyKCBvcHRpb25zLmZpcmUgKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgYSB0aW1lciB0byBoYW5kbGUgdGhlIG9wdGlvbmFsIGZpcmUtb24taG9sZCBmZWF0dXJlLlxyXG4gICAgLy8gV2hlbiB0aGF0IGZlYXR1cmUgaXMgZW5hYmxlZCwgY2FsbGluZyB0aGlzLmZpcmUgaXMgZGVsZWdhdGVkIHRvIHRoZSB0aW1lci5cclxuICAgIGlmICggb3B0aW9ucy5maXJlT25Ib2xkICkge1xyXG4gICAgICB0aGlzLl90aW1lciA9IG5ldyBDYWxsYmFja1RpbWVyKCB7XHJcbiAgICAgICAgY2FsbGJhY2s6IHRoaXMuZmlyZS5iaW5kKCB0aGlzLCBudWxsICksIC8vIFBhc3MgbnVsbCBmb3IgZmlyZS1vbi1ob2xkIGV2ZW50c1xyXG4gICAgICAgIGRlbGF5OiBvcHRpb25zLmZpcmVPbkhvbGREZWxheSxcclxuICAgICAgICBpbnRlcnZhbDogb3B0aW9ucy5maXJlT25Ib2xkSW50ZXJ2YWxcclxuICAgICAgfSApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmlyZXMgYW55IGFzc29jaWF0ZWQgYnV0dG9uIGZpcmUgY2FsbGJhY2suXHJcbiAgICpcclxuICAgKiBOT1RFOiBUaGlzIGlzIHNhZmUgdG8gY2FsbCBvbiB0aGUgbGlzdGVuZXIgZXh0ZXJuYWxseS5cclxuICAgKi9cclxuICBwdWJsaWMgZmlyZSggZXZlbnQ6IFNjZW5lcnlFdmVudDxNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCB8IFBvaW50ZXJFdmVudCB8IEZvY3VzRXZlbnQgfCBLZXlib2FyZEV2ZW50PiB8IG51bGwgKTogdm9pZCB7XHJcbiAgICBzY2VuZXJ5TG9nICYmIHNjZW5lcnlMb2cuSW5wdXRMaXN0ZW5lciAmJiBzY2VuZXJ5TG9nLklucHV0TGlzdGVuZXIoICdGaXJlTGlzdGVuZXIgZmlyZScgKTtcclxuICAgIHNjZW5lcnlMb2cgJiYgc2NlbmVyeUxvZy5JbnB1dExpc3RlbmVyICYmIHNjZW5lcnlMb2cucHVzaCgpO1xyXG5cclxuICAgIHRoaXMuZmlyZWRFbWl0dGVyLmVtaXQoIGV2ZW50ICk7XHJcblxyXG4gICAgc2NlbmVyeUxvZyAmJiBzY2VuZXJ5TG9nLklucHV0TGlzdGVuZXIgJiYgc2NlbmVyeUxvZy5wb3AoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFByZXNzZXMgdGhlIGJ1dHRvbi5cclxuICAgKlxyXG4gICAqIE5PVEU6IFRoaXMgaXMgc2FmZSB0byBjYWxsIGV4dGVybmFsbHkgaW4gb3JkZXIgdG8gYXR0ZW1wdCB0byBzdGFydCBhIHByZXNzLiBmaXJlTGlzdGVuZXIuY2FuUHJlc3MoIGV2ZW50ICkgY2FuXHJcbiAgICogYmUgdXNlZCB0byBkZXRlcm1pbmUgd2hldGhlciB0aGlzIHdpbGwgYWN0dWFsbHkgc3RhcnQgYSBwcmVzcy5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBldmVudFxyXG4gICAqIEBwYXJhbSBbdGFyZ2V0Tm9kZV0gLSBJZiBwcm92aWRlZCwgd2lsbCB0YWtlIHRoZSBwbGFjZSBvZiB0aGUgdGFyZ2V0Tm9kZSBmb3IgdGhpcyBjYWxsLiBVc2VmdWwgZm9yXHJcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3J3YXJkZWQgcHJlc3Nlcy5cclxuICAgKiBAcGFyYW0gW2NhbGxiYWNrXSAtIHRvIGJlIHJ1biBhdCB0aGUgZW5kIG9mIHRoZSBmdW5jdGlvbiwgYnV0IG9ubHkgb24gc3VjY2Vzc1xyXG4gICAqIEByZXR1cm5zIHN1Y2Nlc3MgLSBSZXR1cm5zIHdoZXRoZXIgdGhlIHByZXNzIHdhcyBhY3R1YWxseSBzdGFydGVkXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIHByZXNzKCBldmVudDogU2NlbmVyeUV2ZW50PE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50IHwgUG9pbnRlckV2ZW50IHwgRm9jdXNFdmVudCB8IEtleWJvYXJkRXZlbnQ+LCB0YXJnZXROb2RlPzogTm9kZSwgY2FsbGJhY2s/OiAoKSA9PiB2b2lkICk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHN1cGVyLnByZXNzKCBldmVudCwgdGFyZ2V0Tm9kZSwgKCkgPT4ge1xyXG4gICAgICAvLyBUaGlzIGZ1bmN0aW9uIGlzIG9ubHkgY2FsbGVkIG9uIHN1Y2Nlc3NcclxuICAgICAgaWYgKCB0aGlzLl9maXJlT25Eb3duICkge1xyXG4gICAgICAgIHRoaXMuZmlyZSggZXZlbnQgKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIHRoaXMuX3RpbWVyICkge1xyXG4gICAgICAgIHRoaXMuX3RpbWVyLnN0YXJ0KCk7XHJcbiAgICAgIH1cclxuICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbGVhc2VzIHRoZSBidXR0b24uXHJcbiAgICpcclxuICAgKiBOT1RFOiBUaGlzIGNhbiBiZSBzYWZlbHkgY2FsbGVkIGV4dGVybmFsbHkgaW4gb3JkZXIgdG8gZm9yY2UgYSByZWxlYXNlIG9mIHRoaXMgYnV0dG9uIChubyBhY3R1YWwgJ3VwJyBldmVudCBpc1xyXG4gICAqIG5lZWRlZCkuIElmIHRoZSBjYW5jZWwvaW50ZXJydXB0IGJlaGF2aW9yIGlzIG1vcmUgcHJlZmVyYWJsZSAod2lsbCBub3QgZmlyZSB0aGUgYnV0dG9uKSwgdGhlbiBjYWxsIGludGVycnVwdCgpXHJcbiAgICogb24gdGhpcyBsaXN0ZW5lciBpbnN0ZWFkLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIFtldmVudF0gLSBzY2VuZXJ5IGV2ZW50IGlmIHRoZXJlIHdhcyBvbmVcclxuICAgKiBAcGFyYW0gW2NhbGxiYWNrXSAtIGNhbGxlZCBhdCB0aGUgZW5kIG9mIHRoZSByZWxlYXNlXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIHJlbGVhc2UoIGV2ZW50PzogU2NlbmVyeUV2ZW50PE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50IHwgUG9pbnRlckV2ZW50IHwgRm9jdXNFdmVudCB8IEtleWJvYXJkRXZlbnQ+LCBjYWxsYmFjaz86ICgpID0+IHZvaWQgKTogdm9pZCB7XHJcbiAgICBzdXBlci5yZWxlYXNlKCBldmVudCwgKCkgPT4ge1xyXG4gICAgICAvLyBOb3RpZnkgYWZ0ZXIgdGhlIHJlc3Qgb2YgcmVsZWFzZSBpcyBjYWxsZWQgaW4gb3JkZXIgdG8gcHJldmVudCBpdCBmcm9tIHRyaWdnZXJpbmcgaW50ZXJydXB0KCkuXHJcbiAgICAgIGNvbnN0IHNob3VsZEZpcmUgPSAhdGhpcy5fZmlyZU9uRG93biAmJiB0aGlzLmlzSG92ZXJpbmdQcm9wZXJ0eS52YWx1ZSAmJiAhdGhpcy5pbnRlcnJ1cHRlZDtcclxuICAgICAgaWYgKCB0aGlzLl90aW1lciApIHtcclxuICAgICAgICB0aGlzLl90aW1lci5zdG9wKCBzaG91bGRGaXJlICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIHNob3VsZEZpcmUgKSB7XHJcbiAgICAgICAgdGhpcy5maXJlKCBldmVudCB8fCBudWxsICk7XHJcbiAgICAgIH1cclxuICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENsaWNrcyB0aGUgbGlzdGVuZXIsIHByZXNzaW5nIGl0IGFuZCByZWxlYXNpbmcgaXQgaW1tZWRpYXRlbHkuIFBhcnQgb2YgdGhlIHNjZW5lcnkgaW5wdXQgQVBJLCB0cmlnZ2VyZWQgZnJvbSBQRE9NXHJcbiAgICogZXZlbnRzIGZvciBhY2Nlc3NpYmlsaXR5LlxyXG4gICAqXHJcbiAgICogQ2xpY2sgZG9lcyBub3QgaW52b2x2ZSB0aGUgRmlyZUxpc3RlbmVyIHRpbWVyIGJlY2F1c2UgaXQgaXMgYSBkaXNjcmV0ZSBldmVudCB0aGF0XHJcbiAgICogcHJlc3NlcyBhbmQgcmVsZWFzZXMgdGhlIGxpc3RlbmVyIGltbWVkaWF0ZWx5LiBUaGlzIGJlaGF2aW9yIGlzIGEgbGltaXRhdGlvbiBpbXBvc2VkXHJcbiAgICogYnkgc2NyZWVuIHJlYWRlciB0ZWNobm9sb2d5LiBTZWUgUHJlc3NMaXN0ZW5lci5jbGljayBmb3IgbW9yZSBpbmZvcm1hdGlvbi5cclxuICAgKlxyXG4gICAqIE5PVEU6IFRoaXMgY2FuIGJlIHNhZmVseSBjYWxsZWQgZXh0ZXJuYWxseSBpbiBvcmRlciB0byBjbGljayB0aGUgbGlzdGVuZXIsIGV2ZW50IGlzIG5vdCByZXF1aXJlZC5cclxuICAgKiBmaXJlTGlzdGVuZXIuY2FuQ2xpY2soKSBjYW4gYmUgdXNlZCB0byBkZXRlcm1pbmUgaWYgdGhpcyB3aWxsIGFjdHVhbGx5IHRyaWdnZXIgYSBjbGljay5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBbZXZlbnRdXHJcbiAgICogQHBhcmFtIFtjYWxsYmFja10gLSBjYWxsZWQgYXQgdGhlIGVuZCBvZiB0aGUgY2xpY2tcclxuICAgKi9cclxuICBwdWJsaWMgb3ZlcnJpZGUgY2xpY2soIGV2ZW50OiBTY2VuZXJ5RXZlbnQ8TW91c2VFdmVudD4gfCBudWxsLCBjYWxsYmFjaz86ICgpID0+IHZvaWQgKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gc3VwZXIuY2xpY2soIGV2ZW50LCAoKSA9PiB7XHJcblxyXG4gICAgICAvLyBkb24ndCBjbGljayBpZiBsaXN0ZW5lciB3YXMgaW50ZXJydXB0ZWQgYmVmb3JlIHRoaXMgY2FsbGJhY2tcclxuICAgICAgaWYgKCAhdGhpcy5pbnRlcnJ1cHRlZCApIHtcclxuICAgICAgICB0aGlzLmZpcmUoIGV2ZW50ICk7XHJcbiAgICAgIH1cclxuICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEludGVycnVwdHMgdGhlIGxpc3RlbmVyLCByZWxlYXNpbmcgaXQgKGNhbmNlbGluZyBiZWhhdmlvcikuXHJcbiAgICpcclxuICAgKiBUaGlzIGVmZmVjdGl2ZWx5IHJlbGVhc2VzL2VuZHMgdGhlIHByZXNzLCBhbmQgc2V0cyB0aGUgYGludGVycnVwdGVkYCBmbGFnIHRvIHRydWUgd2hpbGUgZmlyaW5nIHRoZXNlIGV2ZW50c1xyXG4gICAqIHNvIHRoYXQgY29kZSBjYW4gZGV0ZXJtaW5lIHdoZXRoZXIgYSByZWxlYXNlL2VuZCBoYXBwZW5lZCBuYXR1cmFsbHksIG9yIHdhcyBjYW5jZWxlZCBpbiBzb21lIHdheS5cclxuICAgKlxyXG4gICAqIFRoaXMgY2FuIGJlIGNhbGxlZCBtYW51YWxseSwgYnV0IGNhbiBhbHNvIGJlIGNhbGxlZCB0aHJvdWdoIG5vZGUuaW50ZXJydXB0U3VidHJlZUlucHV0KCkuXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIGludGVycnVwdCgpOiB2b2lkIHtcclxuICAgIHN1cGVyLmludGVycnVwdCgpO1xyXG5cclxuICAgIHRoaXMuX3RpbWVyICYmIHRoaXMuX3RpbWVyLnN0b3AoIGZhbHNlICk7IC8vIFN0b3AgdGhlIHRpbWVyLCBkb24ndCBmaXJlIGlmIHdlIGhhdmVuJ3QgYWxyZWFkeVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLmZpcmVkRW1pdHRlci5kaXNwb3NlKCk7XHJcbiAgICB0aGlzLl90aW1lciAmJiB0aGlzLl90aW1lci5kaXNwb3NlKCk7XHJcblxyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxu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