// Copyright 2022-2024, University of Colorado Boulder

/**
 * Supertype for LayoutConstraints that are based on an actual Node where the layout takes place. Generally used with
 * layout containers that are subtypes of LayoutNode.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Property from '../../../../axon/js/Property.js';
import TinyProperty from '../../../../axon/js/TinyProperty.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import { LayoutConstraint, scenery } from '../../imports.js';
import optionize from '../../../../phet-core/js/optionize.js';
import Vector2 from '../../../../dot/js/Vector2.js';
// Position changes smaller than this will be ignored
const CHANGE_POSITION_THRESHOLD = 1e-9;

// Type export designed for use with clients

export default class NodeLayoutConstraint extends LayoutConstraint {
  _excludeInvisible = true;

  // Reports out the used layout bounds (may be larger than actual bounds, since it will include margins, etc.)
  // Layout nodes can use this to adjust their localBounds. FlowBox/GridBox uses this for their localBounds.
  // (scenery-internal)

  // (scenery-internal)

  /**
   * Recommended for ancestorNode to be the layout container, and that the layout container extends LayoutNode.
   * (scenery-internal)
   */
  constructor(ancestorNode, providedOptions) {
    // The omitted options are set to proper defaults below
    const options = optionize()({
      // As options, so we could hook into a Node's preferred/minimum sizes if desired
      preferredWidthProperty: new TinyProperty(null),
      preferredHeightProperty: new TinyProperty(null),
      minimumWidthProperty: new TinyProperty(null),
      minimumHeightProperty: new TinyProperty(null),
      layoutOriginProperty: new TinyProperty(Vector2.ZERO)
    }, providedOptions);
    super(ancestorNode);
    this.layoutBoundsProperty = new Property(Bounds2.NOTHING, {
      valueComparisonStrategy: 'equalsFunction'
    });
    this.preferredWidthProperty = options.preferredWidthProperty;
    this.preferredHeightProperty = options.preferredHeightProperty;
    this.minimumWidthProperty = options.minimumWidthProperty;
    this.minimumHeightProperty = options.minimumHeightProperty;
    this.layoutOriginProperty = options.layoutOriginProperty;
    this.preferredWidthProperty.lazyLink(this._updateLayoutListener);
    this.preferredHeightProperty.lazyLink(this._updateLayoutListener);
    this.layoutOriginProperty.lazyLink(this._updateLayoutListener);
  }

  /**
   * Filters out cells to only those that will be involved in layout
   */
  filterLayoutCells(cells) {
    // We'll check to make sure cells are disposed in a common place, so it's not duplicated
    assert && assert(_.every(cells, cell => !cell.node.isDisposed), 'A cell\'s node should not be disposed when layout happens');
    return cells.filter(cell => {
      return cell.isConnected() && cell.proxy.bounds.isValid() && (!this.excludeInvisible || cell.node.visible);
    });
  }
  get excludeInvisible() {
    return this._excludeInvisible;
  }
  set excludeInvisible(value) {
    if (this._excludeInvisible !== value) {
      this._excludeInvisible = value;
      this.updateLayoutAutomatically();
    }
  }

  /**
   * Sets preferred size of content in a central location (so we could hook in animation in the future)
   * (scenery-internal)
   */
  setProxyPreferredSize(orientation, proxy, preferredSize) {
    proxy[orientation.preferredSize] = preferredSize;
  }

  /**
   * Sets position of content in a central location (so we could hook in animation in the future)
   * (scenery-internal)
   */
  setProxyMinSide(orientation, proxy, minSide) {
    if (Math.abs(proxy[orientation.minSide] - minSide) > CHANGE_POSITION_THRESHOLD) {
      proxy[orientation.minSide] = minSide;
    }
  }

  /**
   * Sets origin-based position of content in a central location (so we could hook in animation in the future)
   * (scenery-internal)
   */
  setProxyOrigin(orientation, proxy, origin) {
    if (Math.abs(proxy[orientation.coordinate] - origin) > CHANGE_POSITION_THRESHOLD) {
      proxy[orientation.coordinate] = origin;
    }
  }

  /**
   * Releases references
   */
  dispose() {
    // In case they're from external sources (since these constraints can be used without a dedicated Node that is also
    // being disposed.
    this.preferredWidthProperty.unlink(this._updateLayoutListener);
    this.preferredHeightProperty.unlink(this._updateLayoutListener);
    this.layoutOriginProperty.unlink(this._updateLayoutListener);
    super.dispose();
  }
}
scenery.register('NodeLayoutConstraint', NodeLayoutConstraint);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIlRpbnlQcm9wZXJ0eSIsIkJvdW5kczIiLCJMYXlvdXRDb25zdHJhaW50Iiwic2NlbmVyeSIsIm9wdGlvbml6ZSIsIlZlY3RvcjIiLCJDSEFOR0VfUE9TSVRJT05fVEhSRVNIT0xEIiwiTm9kZUxheW91dENvbnN0cmFpbnQiLCJfZXhjbHVkZUludmlzaWJsZSIsImNvbnN0cnVjdG9yIiwiYW5jZXN0b3JOb2RlIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInByZWZlcnJlZFdpZHRoUHJvcGVydHkiLCJwcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eSIsIm1pbmltdW1XaWR0aFByb3BlcnR5IiwibWluaW11bUhlaWdodFByb3BlcnR5IiwibGF5b3V0T3JpZ2luUHJvcGVydHkiLCJaRVJPIiwibGF5b3V0Qm91bmRzUHJvcGVydHkiLCJOT1RISU5HIiwidmFsdWVDb21wYXJpc29uU3RyYXRlZ3kiLCJsYXp5TGluayIsIl91cGRhdGVMYXlvdXRMaXN0ZW5lciIsImZpbHRlckxheW91dENlbGxzIiwiY2VsbHMiLCJhc3NlcnQiLCJfIiwiZXZlcnkiLCJjZWxsIiwibm9kZSIsImlzRGlzcG9zZWQiLCJmaWx0ZXIiLCJpc0Nvbm5lY3RlZCIsInByb3h5IiwiYm91bmRzIiwiaXNWYWxpZCIsImV4Y2x1ZGVJbnZpc2libGUiLCJ2aXNpYmxlIiwidmFsdWUiLCJ1cGRhdGVMYXlvdXRBdXRvbWF0aWNhbGx5Iiwic2V0UHJveHlQcmVmZXJyZWRTaXplIiwib3JpZW50YXRpb24iLCJwcmVmZXJyZWRTaXplIiwic2V0UHJveHlNaW5TaWRlIiwibWluU2lkZSIsIk1hdGgiLCJhYnMiLCJzZXRQcm94eU9yaWdpbiIsIm9yaWdpbiIsImNvb3JkaW5hdGUiLCJkaXNwb3NlIiwidW5saW5rIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJOb2RlTGF5b3V0Q29uc3RyYWludC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMi0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTdXBlcnR5cGUgZm9yIExheW91dENvbnN0cmFpbnRzIHRoYXQgYXJlIGJhc2VkIG9uIGFuIGFjdHVhbCBOb2RlIHdoZXJlIHRoZSBsYXlvdXQgdGFrZXMgcGxhY2UuIEdlbmVyYWxseSB1c2VkIHdpdGhcclxuICogbGF5b3V0IGNvbnRhaW5lcnMgdGhhdCBhcmUgc3VidHlwZXMgb2YgTGF5b3V0Tm9kZS5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgVGlueVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVGlueVByb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgeyBMYXlvdXRDb25zdHJhaW50LCBMYXlvdXRQcm94eSwgTWFyZ2luTGF5b3V0Q2VsbCwgTm9kZSwgc2NlbmVyeSB9IGZyb20gJy4uLy4uL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgVFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFByb3BlcnR5LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgT3JpZW50YXRpb24gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL09yaWVudGF0aW9uLmpzJztcclxuXHJcbi8vIFBvc2l0aW9uIGNoYW5nZXMgc21hbGxlciB0aGFuIHRoaXMgd2lsbCBiZSBpZ25vcmVkXHJcbmNvbnN0IENIQU5HRV9QT1NJVElPTl9USFJFU0hPTEQgPSAxZS05O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICAvLyBXaGV0aGVyIGludmlzaWJsZSBOb2RlcyBhcmUgZXhjbHVkZWQgZnJvbSB0aGUgbGF5b3V0LlxyXG4gIGV4Y2x1ZGVJbnZpc2libGU/OiBib29sZWFuO1xyXG5cclxuICAvLyBJZiBhdmFpbGFibGUsIHRoZSBsb2NhbCB2ZXJzaW9ucyBvZiB0aGVzZSBQcm9wZXJ0aWVzIGZvciB0aGUgbGF5b3V0IGNvbnRhaW5lciBzaG91bGQgYmUgcGFzc2VkIGluLiBXZSBkbyB0aGVcclxuICAvLyBsYXlvdXQgaW4gdGhlIGxvY2FsIGNvb3JkaW5hdGUgZnJhbWUgb2YgZS5nLiBHcmlkQm94L0Zsb3dCb3guIEl0J3MgbmFtZWQgdGhpcyB3YXkganVzdCBmb3IgZWFzZS1vZi11c2Ugd2l0aGluXHJcbiAgLy8gdGhpcyBjb2RlLlxyXG4gIHByZWZlcnJlZFdpZHRoUHJvcGVydHk/OiBUUHJvcGVydHk8bnVtYmVyIHwgbnVsbD47XHJcbiAgcHJlZmVycmVkSGVpZ2h0UHJvcGVydHk/OiBUUHJvcGVydHk8bnVtYmVyIHwgbnVsbD47XHJcbiAgbWluaW11bVdpZHRoUHJvcGVydHk/OiBUUHJvcGVydHk8bnVtYmVyIHwgbnVsbD47XHJcbiAgbWluaW11bUhlaWdodFByb3BlcnR5PzogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG5cclxuICAvLyBJZiBwcm92aWRlZCwgd2lsbCBwb3NpdGlvbiBjb250ZW50IGF0IGFuIG9mZnNldCBmcm9tIHRoZSBub3JtYWwgb3JpZ2luXHJcbiAgbGF5b3V0T3JpZ2luUHJvcGVydHk/OiBUUHJvcGVydHk8VmVjdG9yMj47XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBOb2RlTGF5b3V0Q29uc3RyYWludE9wdGlvbnMgPSBTZWxmT3B0aW9ucztcclxuXHJcbi8vIFR5cGUgZXhwb3J0IGRlc2lnbmVkIGZvciB1c2Ugd2l0aCBjbGllbnRzXHJcbmV4cG9ydCB0eXBlIE5vZGVMYXlvdXRBdmFpbGFibGVDb25zdHJhaW50T3B0aW9ucyA9IFBpY2s8Tm9kZUxheW91dENvbnN0cmFpbnRPcHRpb25zLCAnZXhjbHVkZUludmlzaWJsZScgfCAnbGF5b3V0T3JpZ2luUHJvcGVydHknPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE5vZGVMYXlvdXRDb25zdHJhaW50IGV4dGVuZHMgTGF5b3V0Q29uc3RyYWludCB7XHJcblxyXG4gIHByaXZhdGUgX2V4Y2x1ZGVJbnZpc2libGUgPSB0cnVlO1xyXG5cclxuICAvLyBSZXBvcnRzIG91dCB0aGUgdXNlZCBsYXlvdXQgYm91bmRzIChtYXkgYmUgbGFyZ2VyIHRoYW4gYWN0dWFsIGJvdW5kcywgc2luY2UgaXQgd2lsbCBpbmNsdWRlIG1hcmdpbnMsIGV0Yy4pXHJcbiAgLy8gTGF5b3V0IG5vZGVzIGNhbiB1c2UgdGhpcyB0byBhZGp1c3QgdGhlaXIgbG9jYWxCb3VuZHMuIEZsb3dCb3gvR3JpZEJveCB1c2VzIHRoaXMgZm9yIHRoZWlyIGxvY2FsQm91bmRzLlxyXG4gIC8vIChzY2VuZXJ5LWludGVybmFsKVxyXG4gIHB1YmxpYyByZWFkb25seSBsYXlvdXRCb3VuZHNQcm9wZXJ0eTogVFByb3BlcnR5PEJvdW5kczI+O1xyXG5cclxuICAvLyAoc2NlbmVyeS1pbnRlcm5hbClcclxuICBwdWJsaWMgcmVhZG9ubHkgcHJlZmVycmVkV2lkdGhQcm9wZXJ0eTogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG4gIHB1YmxpYyByZWFkb25seSBwcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eTogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG4gIHB1YmxpYyByZWFkb25seSBtaW5pbXVtV2lkdGhQcm9wZXJ0eTogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG4gIHB1YmxpYyByZWFkb25seSBtaW5pbXVtSGVpZ2h0UHJvcGVydHk6IFRQcm9wZXJ0eTxudW1iZXIgfCBudWxsPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGF5b3V0T3JpZ2luUHJvcGVydHk6IFRQcm9wZXJ0eTxWZWN0b3IyPjtcclxuXHJcbiAgLyoqXHJcbiAgICogUmVjb21tZW5kZWQgZm9yIGFuY2VzdG9yTm9kZSB0byBiZSB0aGUgbGF5b3V0IGNvbnRhaW5lciwgYW5kIHRoYXQgdGhlIGxheW91dCBjb250YWluZXIgZXh0ZW5kcyBMYXlvdXROb2RlLlxyXG4gICAqIChzY2VuZXJ5LWludGVybmFsKVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggYW5jZXN0b3JOb2RlOiBOb2RlLCBwcm92aWRlZE9wdGlvbnM/OiBOb2RlTGF5b3V0Q29uc3RyYWludE9wdGlvbnMgKSB7XHJcblxyXG4gICAgLy8gVGhlIG9taXR0ZWQgb3B0aW9ucyBhcmUgc2V0IHRvIHByb3BlciBkZWZhdWx0cyBiZWxvd1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxOb2RlTGF5b3V0Q29uc3RyYWludE9wdGlvbnMsIFN0cmljdE9taXQ8U2VsZk9wdGlvbnMsICdleGNsdWRlSW52aXNpYmxlJz4+KCkoIHtcclxuICAgICAgLy8gQXMgb3B0aW9ucywgc28gd2UgY291bGQgaG9vayBpbnRvIGEgTm9kZSdzIHByZWZlcnJlZC9taW5pbXVtIHNpemVzIGlmIGRlc2lyZWRcclxuICAgICAgcHJlZmVycmVkV2lkdGhQcm9wZXJ0eTogbmV3IFRpbnlQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCApLFxyXG4gICAgICBwcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eTogbmV3IFRpbnlQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCApLFxyXG4gICAgICBtaW5pbXVtV2lkdGhQcm9wZXJ0eTogbmV3IFRpbnlQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCApLFxyXG4gICAgICBtaW5pbXVtSGVpZ2h0UHJvcGVydHk6IG5ldyBUaW55UHJvcGVydHk8bnVtYmVyIHwgbnVsbD4oIG51bGwgKSxcclxuICAgICAgbGF5b3V0T3JpZ2luUHJvcGVydHk6IG5ldyBUaW55UHJvcGVydHk8VmVjdG9yMj4oIFZlY3RvcjIuWkVSTyApXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggYW5jZXN0b3JOb2RlICk7XHJcblxyXG4gICAgdGhpcy5sYXlvdXRCb3VuZHNQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggQm91bmRzMi5OT1RISU5HLCB7XHJcbiAgICAgIHZhbHVlQ29tcGFyaXNvblN0cmF0ZWd5OiAnZXF1YWxzRnVuY3Rpb24nXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5wcmVmZXJyZWRXaWR0aFByb3BlcnR5ID0gb3B0aW9ucy5wcmVmZXJyZWRXaWR0aFByb3BlcnR5O1xyXG4gICAgdGhpcy5wcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eSA9IG9wdGlvbnMucHJlZmVycmVkSGVpZ2h0UHJvcGVydHk7XHJcbiAgICB0aGlzLm1pbmltdW1XaWR0aFByb3BlcnR5ID0gb3B0aW9ucy5taW5pbXVtV2lkdGhQcm9wZXJ0eTtcclxuICAgIHRoaXMubWluaW11bUhlaWdodFByb3BlcnR5ID0gb3B0aW9ucy5taW5pbXVtSGVpZ2h0UHJvcGVydHk7XHJcbiAgICB0aGlzLmxheW91dE9yaWdpblByb3BlcnR5ID0gb3B0aW9ucy5sYXlvdXRPcmlnaW5Qcm9wZXJ0eTtcclxuXHJcbiAgICB0aGlzLnByZWZlcnJlZFdpZHRoUHJvcGVydHkubGF6eUxpbmsoIHRoaXMuX3VwZGF0ZUxheW91dExpc3RlbmVyICk7XHJcbiAgICB0aGlzLnByZWZlcnJlZEhlaWdodFByb3BlcnR5LmxhenlMaW5rKCB0aGlzLl91cGRhdGVMYXlvdXRMaXN0ZW5lciApO1xyXG4gICAgdGhpcy5sYXlvdXRPcmlnaW5Qcm9wZXJ0eS5sYXp5TGluayggdGhpcy5fdXBkYXRlTGF5b3V0TGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZpbHRlcnMgb3V0IGNlbGxzIHRvIG9ubHkgdGhvc2UgdGhhdCB3aWxsIGJlIGludm9sdmVkIGluIGxheW91dFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBmaWx0ZXJMYXlvdXRDZWxsczxDZWxsIGV4dGVuZHMgTWFyZ2luTGF5b3V0Q2VsbD4oIGNlbGxzOiBDZWxsW10gKTogQ2VsbFtdIHtcclxuICAgIC8vIFdlJ2xsIGNoZWNrIHRvIG1ha2Ugc3VyZSBjZWxscyBhcmUgZGlzcG9zZWQgaW4gYSBjb21tb24gcGxhY2UsIHNvIGl0J3Mgbm90IGR1cGxpY2F0ZWRcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIF8uZXZlcnkoIGNlbGxzLCBjZWxsID0+ICFjZWxsLm5vZGUuaXNEaXNwb3NlZCApLCAnQSBjZWxsXFwncyBub2RlIHNob3VsZCBub3QgYmUgZGlzcG9zZWQgd2hlbiBsYXlvdXQgaGFwcGVucycgKTtcclxuXHJcbiAgICByZXR1cm4gY2VsbHMuZmlsdGVyKCBjZWxsID0+IHtcclxuICAgICAgcmV0dXJuIGNlbGwuaXNDb25uZWN0ZWQoKSAmJiBjZWxsLnByb3h5LmJvdW5kcy5pc1ZhbGlkKCkgJiYgKCAhdGhpcy5leGNsdWRlSW52aXNpYmxlIHx8IGNlbGwubm9kZS52aXNpYmxlICk7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGV4Y2x1ZGVJbnZpc2libGUoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXhjbHVkZUludmlzaWJsZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZXQgZXhjbHVkZUludmlzaWJsZSggdmFsdWU6IGJvb2xlYW4gKSB7XHJcbiAgICBpZiAoIHRoaXMuX2V4Y2x1ZGVJbnZpc2libGUgIT09IHZhbHVlICkge1xyXG4gICAgICB0aGlzLl9leGNsdWRlSW52aXNpYmxlID0gdmFsdWU7XHJcblxyXG4gICAgICB0aGlzLnVwZGF0ZUxheW91dEF1dG9tYXRpY2FsbHkoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgcHJlZmVycmVkIHNpemUgb2YgY29udGVudCBpbiBhIGNlbnRyYWwgbG9jYXRpb24gKHNvIHdlIGNvdWxkIGhvb2sgaW4gYW5pbWF0aW9uIGluIHRoZSBmdXR1cmUpXHJcbiAgICogKHNjZW5lcnktaW50ZXJuYWwpXHJcbiAgICovXHJcbiAgcHVibGljIHNldFByb3h5UHJlZmVycmVkU2l6ZSggb3JpZW50YXRpb246IE9yaWVudGF0aW9uLCBwcm94eTogTGF5b3V0UHJveHksIHByZWZlcnJlZFNpemU6IG51bWJlciB8IG51bGwgKTogdm9pZCB7XHJcbiAgICBwcm94eVsgb3JpZW50YXRpb24ucHJlZmVycmVkU2l6ZSBdID0gcHJlZmVycmVkU2l6ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgcG9zaXRpb24gb2YgY29udGVudCBpbiBhIGNlbnRyYWwgbG9jYXRpb24gKHNvIHdlIGNvdWxkIGhvb2sgaW4gYW5pbWF0aW9uIGluIHRoZSBmdXR1cmUpXHJcbiAgICogKHNjZW5lcnktaW50ZXJuYWwpXHJcbiAgICovXHJcbiAgcHVibGljIHNldFByb3h5TWluU2lkZSggb3JpZW50YXRpb246IE9yaWVudGF0aW9uLCBwcm94eTogTGF5b3V0UHJveHksIG1pblNpZGU6IG51bWJlciApOiB2b2lkIHtcclxuICAgIGlmICggTWF0aC5hYnMoIHByb3h5WyBvcmllbnRhdGlvbi5taW5TaWRlIF0gLSBtaW5TaWRlICkgPiBDSEFOR0VfUE9TSVRJT05fVEhSRVNIT0xEICkge1xyXG4gICAgICBwcm94eVsgb3JpZW50YXRpb24ubWluU2lkZSBdID0gbWluU2lkZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgb3JpZ2luLWJhc2VkIHBvc2l0aW9uIG9mIGNvbnRlbnQgaW4gYSBjZW50cmFsIGxvY2F0aW9uIChzbyB3ZSBjb3VsZCBob29rIGluIGFuaW1hdGlvbiBpbiB0aGUgZnV0dXJlKVxyXG4gICAqIChzY2VuZXJ5LWludGVybmFsKVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRQcm94eU9yaWdpbiggb3JpZW50YXRpb246IE9yaWVudGF0aW9uLCBwcm94eTogTGF5b3V0UHJveHksIG9yaWdpbjogbnVtYmVyICk6IHZvaWQge1xyXG4gICAgaWYgKCBNYXRoLmFicyggcHJveHlbIG9yaWVudGF0aW9uLmNvb3JkaW5hdGUgXSAtIG9yaWdpbiApID4gQ0hBTkdFX1BPU0lUSU9OX1RIUkVTSE9MRCApIHtcclxuICAgICAgcHJveHlbIG9yaWVudGF0aW9uLmNvb3JkaW5hdGUgXSA9IG9yaWdpbjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbGVhc2VzIHJlZmVyZW5jZXNcclxuICAgKi9cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIC8vIEluIGNhc2UgdGhleSdyZSBmcm9tIGV4dGVybmFsIHNvdXJjZXMgKHNpbmNlIHRoZXNlIGNvbnN0cmFpbnRzIGNhbiBiZSB1c2VkIHdpdGhvdXQgYSBkZWRpY2F0ZWQgTm9kZSB0aGF0IGlzIGFsc29cclxuICAgIC8vIGJlaW5nIGRpc3Bvc2VkLlxyXG4gICAgdGhpcy5wcmVmZXJyZWRXaWR0aFByb3BlcnR5LnVubGluayggdGhpcy5fdXBkYXRlTGF5b3V0TGlzdGVuZXIgKTtcclxuICAgIHRoaXMucHJlZmVycmVkSGVpZ2h0UHJvcGVydHkudW5saW5rKCB0aGlzLl91cGRhdGVMYXlvdXRMaXN0ZW5lciApO1xyXG4gICAgdGhpcy5sYXlvdXRPcmlnaW5Qcm9wZXJ0eS51bmxpbmsoIHRoaXMuX3VwZGF0ZUxheW91dExpc3RlbmVyICk7XHJcblxyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuc2NlbmVyeS5yZWdpc3RlciggJ05vZGVMYXlvdXRDb25zdHJhaW50JywgTm9kZUxheW91dENvbnN0cmFpbnQgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxRQUFRLE1B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