// Copyright 2016-2024, University of Colorado Boulder

/**
 * SVG drawable for Text nodes.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import platform from '../../../../phet-core/js/platform.js';
import Poolable from '../../../../phet-core/js/Poolable.js';
import { scenery, svgns, SVGSelfDrawable, TextStatefulDrawable, Utils } from '../../imports.js';

// TODO: change this based on memory and performance characteristics of the platform https://github.com/phetsims/scenery/issues/1581
const keepSVGTextElements = true; // whether we should pool SVG elements for the SVG rendering states, or whether we should free them when possible for memory

// Some browsers (IE/Edge) can't handle our UTF-8 embedding marks AND SVG textLength/spacingAndGlyphs. We disable
// using these features, because they aren't necessary on these browsers.
// See https://github.com/phetsims/scenery/issues/455 for more information.
const useSVGTextLengthAdjustments = !platform.edge;

// Safari seems to have many issues with text and repaint regions, resulting in artifacts showing up when not correctly
// repainted (https://github.com/phetsims/qa/issues/1039#issuecomment-1949196606), and
// cutting off some portions of the text (https://github.com/phetsims/scenery/issues/1610).
// We have persistently created "transparent" rectangles to force repaints (requiring the client to do so), but this
// seems to not work in many cases, and seems to be a usability issue to have to add workarounds.
// If we place it in the same SVG group as the text, we'll get the same transform, but it seems to provide a consistent
// workaround.
const useTransparentSVGTextWorkaround = platform.safari;
class TextSVGDrawable extends TextStatefulDrawable(SVGSelfDrawable) {
  /**
   * @public
   * @override
   *
   * @param {number} renderer
   * @param {Instance} instance
   */
  initialize(renderer, instance) {
    super.initialize(renderer, instance, true, keepSVGTextElements); // usesPaint: true

    // @private {boolean}
    this.hasLength = false;
    if (!this.svgElement) {
      const text = document.createElementNS(svgns, 'text');

      // @private {SVGTextElement}
      this.text = text;

      // If we're applying the workaround, we'll nest everything under a group element
      if (useTransparentSVGTextWorkaround) {
        const group = document.createElementNS(svgns, 'g');
        group.appendChild(text);
        this.svgElement = group;

        // "transparent" fill seems to trick Safari into repainting the region correctly.
        this.workaroundRect = document.createElementNS(svgns, 'rect');
        this.workaroundRect.setAttribute('fill', 'transparent');
        group.appendChild(this.workaroundRect);
      } else {
        // @protected {SVGTextElement|SVGGroup} - Sole SVG element for this drawable, implementing API for SVGSelfDrawable
        this.svgElement = text;
      }
      text.appendChild(document.createTextNode(''));

      // TODO: flag adjustment for SVG qualities https://github.com/phetsims/scenery/issues/1581
      text.setAttribute('dominant-baseline', 'alphabetic'); // to match Canvas right now
      text.setAttribute('text-rendering', 'geometricPrecision');
      text.setAttributeNS('http://www.w3.org/XML/1998/namespace', 'xml:space', 'preserve');
      text.setAttribute('direction', 'ltr');
    }
  }

  /**
   * Updates the SVG elements so that they will appear like the current node's representation.
   * @protected
   *
   * Implements the interface for SVGSelfDrawable (and is called from the SVGSelfDrawable's update).
   */
  updateSVGSelf() {
    const text = this.text;

    // set all of the font attributes, since we can't use the combined one
    if (this.dirtyFont) {
      text.setAttribute('font-family', this.node._font.getFamily());
      text.setAttribute('font-size', this.node._font.getSize());
      text.setAttribute('font-style', this.node._font.getStyle());
      text.setAttribute('font-weight', this.node._font.getWeight());
      text.setAttribute('font-stretch', this.node._font.getStretch());
    }

    // update the text-node's value
    if (this.dirtyText) {
      text.lastChild.nodeValue = Utils.safariEmbeddingMarkWorkaround(this.node.renderedText);
    }

    // text length correction, tested with scenery/tests/text-quality-test.html to determine how to match Canvas/SVG rendering (and overall length)
    if (this.dirtyBounds && useSVGTextLengthAdjustments) {
      const useLengthAdjustment = this.node._boundsMethod !== 'accurate' && isFinite(this.node.selfBounds.width);
      if (useLengthAdjustment) {
        if (!this.hasLength) {
          this.hasLength = true;
          text.setAttribute('lengthAdjust', 'spacingAndGlyphs');
        }
        text.setAttribute('textLength', this.node.selfBounds.width);
      } else if (this.hasLength) {
        this.hasLength = false;
        text.removeAttribute('lengthAdjust');
        text.removeAttribute('textLength');
      }
      if (useTransparentSVGTextWorkaround) {
        // Since text can get bigger/smaller, lets make the region larger than the "reported" bounds - this is needed
        // for the usually-problematic locales that have glyphs that extend well past the normal browser-reported
        // bounds. Since this is transparent, we can make it larger than the actual bounds.
        const paddingRatio = 0.2;
        const horizontalPadding = this.node.selfBounds.width * paddingRatio;
        const verticalPadding = this.node.selfBounds.height * paddingRatio;
        this.workaroundRect.setAttribute('x', this.node.selfBounds.minX - horizontalPadding);
        this.workaroundRect.setAttribute('y', this.node.selfBounds.minY - verticalPadding);
        this.workaroundRect.setAttribute('width', this.node.selfBounds.width + 2 * horizontalPadding);
        this.workaroundRect.setAttribute('height', this.node.selfBounds.height + 2 * verticalPadding);
      }
    }

    // Apply any fill/stroke changes to our element.
    this.updateFillStrokeStyle(text);
  }
}
scenery.register('TextSVGDrawable', TextSVGDrawable);
Poolable.mixInto(TextSVGDrawable);
export default TextSVGDrawable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwbGF0Zm9ybSIsIlBvb2xhYmxlIiwic2NlbmVyeSIsInN2Z25zIiwiU1ZHU2VsZkRyYXdhYmxlIiwiVGV4dFN0YXRlZnVsRHJhd2FibGUiLCJVdGlscyIsImtlZXBTVkdUZXh0RWxlbWVudHMiLCJ1c2VTVkdUZXh0TGVuZ3RoQWRqdXN0bWVudHMiLCJlZGdlIiwidXNlVHJhbnNwYXJlbnRTVkdUZXh0V29ya2Fyb3VuZCIsInNhZmFyaSIsIlRleHRTVkdEcmF3YWJsZSIsImluaXRpYWxpemUiLCJyZW5kZXJlciIsImluc3RhbmNlIiwiaGFzTGVuZ3RoIiwic3ZnRWxlbWVudCIsInRleHQiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnROUyIsImdyb3VwIiwiYXBwZW5kQ2hpbGQiLCJ3b3JrYXJvdW5kUmVjdCIsInNldEF0dHJpYnV0ZSIsImNyZWF0ZVRleHROb2RlIiwic2V0QXR0cmlidXRlTlMiLCJ1cGRhdGVTVkdTZWxmIiwiZGlydHlGb250Iiwibm9kZSIsIl9mb250IiwiZ2V0RmFtaWx5IiwiZ2V0U2l6ZSIsImdldFN0eWxlIiwiZ2V0V2VpZ2h0IiwiZ2V0U3RyZXRjaCIsImRpcnR5VGV4dCIsImxhc3RDaGlsZCIsIm5vZGVWYWx1ZSIsInNhZmFyaUVtYmVkZGluZ01hcmtXb3JrYXJvdW5kIiwicmVuZGVyZWRUZXh0IiwiZGlydHlCb3VuZHMiLCJ1c2VMZW5ndGhBZGp1c3RtZW50IiwiX2JvdW5kc01ldGhvZCIsImlzRmluaXRlIiwic2VsZkJvdW5kcyIsIndpZHRoIiwicmVtb3ZlQXR0cmlidXRlIiwicGFkZGluZ1JhdGlvIiwiaG9yaXpvbnRhbFBhZGRpbmciLCJ2ZXJ0aWNhbFBhZGRpbmciLCJoZWlnaHQiLCJtaW5YIiwibWluWSIsInVwZGF0ZUZpbGxTdHJva2VTdHlsZSIsInJlZ2lzdGVyIiwibWl4SW50byJdLCJzb3VyY2VzIjpbIlRleHRTVkdEcmF3YWJsZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNi0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTVkcgZHJhd2FibGUgZm9yIFRleHQgbm9kZXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5pbXBvcnQgcGxhdGZvcm0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3BsYXRmb3JtLmpzJztcclxuaW1wb3J0IFBvb2xhYmxlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9Qb29sYWJsZS5qcyc7XHJcbmltcG9ydCB7IHNjZW5lcnksIHN2Z25zLCBTVkdTZWxmRHJhd2FibGUsIFRleHRTdGF0ZWZ1bERyYXdhYmxlLCBVdGlscyB9IGZyb20gJy4uLy4uL2ltcG9ydHMuanMnO1xyXG5cclxuLy8gVE9ETzogY2hhbmdlIHRoaXMgYmFzZWQgb24gbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBjaGFyYWN0ZXJpc3RpY3Mgb2YgdGhlIHBsYXRmb3JtIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zY2VuZXJ5L2lzc3Vlcy8xNTgxXHJcbmNvbnN0IGtlZXBTVkdUZXh0RWxlbWVudHMgPSB0cnVlOyAvLyB3aGV0aGVyIHdlIHNob3VsZCBwb29sIFNWRyBlbGVtZW50cyBmb3IgdGhlIFNWRyByZW5kZXJpbmcgc3RhdGVzLCBvciB3aGV0aGVyIHdlIHNob3VsZCBmcmVlIHRoZW0gd2hlbiBwb3NzaWJsZSBmb3IgbWVtb3J5XHJcblxyXG4vLyBTb21lIGJyb3dzZXJzIChJRS9FZGdlKSBjYW4ndCBoYW5kbGUgb3VyIFVURi04IGVtYmVkZGluZyBtYXJrcyBBTkQgU1ZHIHRleHRMZW5ndGgvc3BhY2luZ0FuZEdseXBocy4gV2UgZGlzYWJsZVxyXG4vLyB1c2luZyB0aGVzZSBmZWF0dXJlcywgYmVjYXVzZSB0aGV5IGFyZW4ndCBuZWNlc3Nhcnkgb24gdGhlc2UgYnJvd3NlcnMuXHJcbi8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvc2NlbmVyeS9pc3N1ZXMvNDU1IGZvciBtb3JlIGluZm9ybWF0aW9uLlxyXG5jb25zdCB1c2VTVkdUZXh0TGVuZ3RoQWRqdXN0bWVudHMgPSAhcGxhdGZvcm0uZWRnZTtcclxuXHJcbi8vIFNhZmFyaSBzZWVtcyB0byBoYXZlIG1hbnkgaXNzdWVzIHdpdGggdGV4dCBhbmQgcmVwYWludCByZWdpb25zLCByZXN1bHRpbmcgaW4gYXJ0aWZhY3RzIHNob3dpbmcgdXAgd2hlbiBub3QgY29ycmVjdGx5XHJcbi8vIHJlcGFpbnRlZCAoaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3FhL2lzc3Vlcy8xMDM5I2lzc3VlY29tbWVudC0xOTQ5MTk2NjA2KSwgYW5kXHJcbi8vIGN1dHRpbmcgb2ZmIHNvbWUgcG9ydGlvbnMgb2YgdGhlIHRleHQgKGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zY2VuZXJ5L2lzc3Vlcy8xNjEwKS5cclxuLy8gV2UgaGF2ZSBwZXJzaXN0ZW50bHkgY3JlYXRlZCBcInRyYW5zcGFyZW50XCIgcmVjdGFuZ2xlcyB0byBmb3JjZSByZXBhaW50cyAocmVxdWlyaW5nIHRoZSBjbGllbnQgdG8gZG8gc28pLCBidXQgdGhpc1xyXG4vLyBzZWVtcyB0byBub3Qgd29yayBpbiBtYW55IGNhc2VzLCBhbmQgc2VlbXMgdG8gYmUgYSB1c2FiaWxpdHkgaXNzdWUgdG8gaGF2ZSB0byBhZGQgd29ya2Fyb3VuZHMuXHJcbi8vIElmIHdlIHBsYWNlIGl0IGluIHRoZSBzYW1lIFNWRyBncm91cCBhcyB0aGUgdGV4dCwgd2UnbGwgZ2V0IHRoZSBzYW1lIHRyYW5zZm9ybSwgYnV0IGl0IHNlZW1zIHRvIHByb3ZpZGUgYSBjb25zaXN0ZW50XHJcbi8vIHdvcmthcm91bmQuXHJcbmNvbnN0IHVzZVRyYW5zcGFyZW50U1ZHVGV4dFdvcmthcm91bmQgPSBwbGF0Zm9ybS5zYWZhcmk7XHJcblxyXG5jbGFzcyBUZXh0U1ZHRHJhd2FibGUgZXh0ZW5kcyBUZXh0U3RhdGVmdWxEcmF3YWJsZSggU1ZHU2VsZkRyYXdhYmxlICkge1xyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSByZW5kZXJlclxyXG4gICAqIEBwYXJhbSB7SW5zdGFuY2V9IGluc3RhbmNlXHJcbiAgICovXHJcbiAgaW5pdGlhbGl6ZSggcmVuZGVyZXIsIGluc3RhbmNlICkge1xyXG4gICAgc3VwZXIuaW5pdGlhbGl6ZSggcmVuZGVyZXIsIGluc3RhbmNlLCB0cnVlLCBrZWVwU1ZHVGV4dEVsZW1lbnRzICk7IC8vIHVzZXNQYWludDogdHJ1ZVxyXG5cclxuICAgIC8vIEBwcml2YXRlIHtib29sZWFufVxyXG4gICAgdGhpcy5oYXNMZW5ndGggPSBmYWxzZTtcclxuXHJcbiAgICBpZiAoICF0aGlzLnN2Z0VsZW1lbnQgKSB7XHJcbiAgICAgIGNvbnN0IHRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoIHN2Z25zLCAndGV4dCcgKTtcclxuXHJcbiAgICAgIC8vIEBwcml2YXRlIHtTVkdUZXh0RWxlbWVudH1cclxuICAgICAgdGhpcy50ZXh0ID0gdGV4dDtcclxuXHJcbiAgICAgIC8vIElmIHdlJ3JlIGFwcGx5aW5nIHRoZSB3b3JrYXJvdW5kLCB3ZSdsbCBuZXN0IGV2ZXJ5dGhpbmcgdW5kZXIgYSBncm91cCBlbGVtZW50XHJcbiAgICAgIGlmICggdXNlVHJhbnNwYXJlbnRTVkdUZXh0V29ya2Fyb3VuZCApIHtcclxuICAgICAgICBjb25zdCBncm91cCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggc3ZnbnMsICdnJyApO1xyXG4gICAgICAgIGdyb3VwLmFwcGVuZENoaWxkKCB0ZXh0ICk7XHJcblxyXG4gICAgICAgIHRoaXMuc3ZnRWxlbWVudCA9IGdyb3VwO1xyXG5cclxuICAgICAgICAvLyBcInRyYW5zcGFyZW50XCIgZmlsbCBzZWVtcyB0byB0cmljayBTYWZhcmkgaW50byByZXBhaW50aW5nIHRoZSByZWdpb24gY29ycmVjdGx5LlxyXG4gICAgICAgIHRoaXMud29ya2Fyb3VuZFJlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoIHN2Z25zLCAncmVjdCcgKTtcclxuICAgICAgICB0aGlzLndvcmthcm91bmRSZWN0LnNldEF0dHJpYnV0ZSggJ2ZpbGwnLCAndHJhbnNwYXJlbnQnICk7XHJcbiAgICAgICAgZ3JvdXAuYXBwZW5kQ2hpbGQoIHRoaXMud29ya2Fyb3VuZFJlY3QgKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICAvLyBAcHJvdGVjdGVkIHtTVkdUZXh0RWxlbWVudHxTVkdHcm91cH0gLSBTb2xlIFNWRyBlbGVtZW50IGZvciB0aGlzIGRyYXdhYmxlLCBpbXBsZW1lbnRpbmcgQVBJIGZvciBTVkdTZWxmRHJhd2FibGVcclxuICAgICAgICB0aGlzLnN2Z0VsZW1lbnQgPSB0ZXh0O1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0ZXh0LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggJycgKSApO1xyXG5cclxuICAgICAgLy8gVE9ETzogZmxhZyBhZGp1c3RtZW50IGZvciBTVkcgcXVhbGl0aWVzIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zY2VuZXJ5L2lzc3Vlcy8xNTgxXHJcbiAgICAgIHRleHQuc2V0QXR0cmlidXRlKCAnZG9taW5hbnQtYmFzZWxpbmUnLCAnYWxwaGFiZXRpYycgKTsgLy8gdG8gbWF0Y2ggQ2FudmFzIHJpZ2h0IG5vd1xyXG4gICAgICB0ZXh0LnNldEF0dHJpYnV0ZSggJ3RleHQtcmVuZGVyaW5nJywgJ2dlb21ldHJpY1ByZWNpc2lvbicgKTtcclxuICAgICAgdGV4dC5zZXRBdHRyaWJ1dGVOUyggJ2h0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZScsICd4bWw6c3BhY2UnLCAncHJlc2VydmUnICk7XHJcbiAgICAgIHRleHQuc2V0QXR0cmlidXRlKCAnZGlyZWN0aW9uJywgJ2x0cicgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgdGhlIFNWRyBlbGVtZW50cyBzbyB0aGF0IHRoZXkgd2lsbCBhcHBlYXIgbGlrZSB0aGUgY3VycmVudCBub2RlJ3MgcmVwcmVzZW50YXRpb24uXHJcbiAgICogQHByb3RlY3RlZFxyXG4gICAqXHJcbiAgICogSW1wbGVtZW50cyB0aGUgaW50ZXJmYWNlIGZvciBTVkdTZWxmRHJhd2FibGUgKGFuZCBpcyBjYWxsZWQgZnJvbSB0aGUgU1ZHU2VsZkRyYXdhYmxlJ3MgdXBkYXRlKS5cclxuICAgKi9cclxuICB1cGRhdGVTVkdTZWxmKCkge1xyXG4gICAgY29uc3QgdGV4dCA9IHRoaXMudGV4dDtcclxuXHJcbiAgICAvLyBzZXQgYWxsIG9mIHRoZSBmb250IGF0dHJpYnV0ZXMsIHNpbmNlIHdlIGNhbid0IHVzZSB0aGUgY29tYmluZWQgb25lXHJcbiAgICBpZiAoIHRoaXMuZGlydHlGb250ICkge1xyXG4gICAgICB0ZXh0LnNldEF0dHJpYnV0ZSggJ2ZvbnQtZmFtaWx5JywgdGhpcy5ub2RlLl9mb250LmdldEZhbWlseSgpICk7XHJcbiAgICAgIHRleHQuc2V0QXR0cmlidXRlKCAnZm9udC1zaXplJywgdGhpcy5ub2RlLl9mb250LmdldFNpemUoKSApO1xyXG4gICAgICB0ZXh0LnNldEF0dHJpYnV0ZSggJ2ZvbnQtc3R5bGUnLCB0aGlzLm5vZGUuX2ZvbnQuZ2V0U3R5bGUoKSApO1xyXG4gICAgICB0ZXh0LnNldEF0dHJpYnV0ZSggJ2ZvbnQtd2VpZ2h0JywgdGhpcy5ub2RlLl9mb250LmdldFdlaWdodCgpICk7XHJcbiAgICAgIHRleHQuc2V0QXR0cmlidXRlKCAnZm9udC1zdHJldGNoJywgdGhpcy5ub2RlLl9mb250LmdldFN0cmV0Y2goKSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHVwZGF0ZSB0aGUgdGV4dC1ub2RlJ3MgdmFsdWVcclxuICAgIGlmICggdGhpcy5kaXJ0eVRleHQgKSB7XHJcbiAgICAgIHRleHQubGFzdENoaWxkLm5vZGVWYWx1ZSA9IFV0aWxzLnNhZmFyaUVtYmVkZGluZ01hcmtXb3JrYXJvdW5kKCB0aGlzLm5vZGUucmVuZGVyZWRUZXh0ICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gdGV4dCBsZW5ndGggY29ycmVjdGlvbiwgdGVzdGVkIHdpdGggc2NlbmVyeS90ZXN0cy90ZXh0LXF1YWxpdHktdGVzdC5odG1sIHRvIGRldGVybWluZSBob3cgdG8gbWF0Y2ggQ2FudmFzL1NWRyByZW5kZXJpbmcgKGFuZCBvdmVyYWxsIGxlbmd0aClcclxuICAgIGlmICggdGhpcy5kaXJ0eUJvdW5kcyAmJiB1c2VTVkdUZXh0TGVuZ3RoQWRqdXN0bWVudHMgKSB7XHJcbiAgICAgIGNvbnN0IHVzZUxlbmd0aEFkanVzdG1lbnQgPSB0aGlzLm5vZGUuX2JvdW5kc01ldGhvZCAhPT0gJ2FjY3VyYXRlJyAmJiBpc0Zpbml0ZSggdGhpcy5ub2RlLnNlbGZCb3VuZHMud2lkdGggKTtcclxuXHJcbiAgICAgIGlmICggdXNlTGVuZ3RoQWRqdXN0bWVudCApIHtcclxuICAgICAgICBpZiAoICF0aGlzLmhhc0xlbmd0aCApIHtcclxuICAgICAgICAgIHRoaXMuaGFzTGVuZ3RoID0gdHJ1ZTtcclxuICAgICAgICAgIHRleHQuc2V0QXR0cmlidXRlKCAnbGVuZ3RoQWRqdXN0JywgJ3NwYWNpbmdBbmRHbHlwaHMnICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRleHQuc2V0QXR0cmlidXRlKCAndGV4dExlbmd0aCcsIHRoaXMubm9kZS5zZWxmQm91bmRzLndpZHRoICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIHRoaXMuaGFzTGVuZ3RoICkge1xyXG4gICAgICAgIHRoaXMuaGFzTGVuZ3RoID0gZmFsc2U7XHJcbiAgICAgICAgdGV4dC5yZW1vdmVBdHRyaWJ1dGUoICdsZW5ndGhBZGp1c3QnICk7XHJcbiAgICAgICAgdGV4dC5yZW1vdmVBdHRyaWJ1dGUoICd0ZXh0TGVuZ3RoJyApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIHVzZVRyYW5zcGFyZW50U1ZHVGV4dFdvcmthcm91bmQgKSB7XHJcbiAgICAgICAgLy8gU2luY2UgdGV4dCBjYW4gZ2V0IGJpZ2dlci9zbWFsbGVyLCBsZXRzIG1ha2UgdGhlIHJlZ2lvbiBsYXJnZXIgdGhhbiB0aGUgXCJyZXBvcnRlZFwiIGJvdW5kcyAtIHRoaXMgaXMgbmVlZGVkXHJcbiAgICAgICAgLy8gZm9yIHRoZSB1c3VhbGx5LXByb2JsZW1hdGljIGxvY2FsZXMgdGhhdCBoYXZlIGdseXBocyB0aGF0IGV4dGVuZCB3ZWxsIHBhc3QgdGhlIG5vcm1hbCBicm93c2VyLXJlcG9ydGVkXHJcbiAgICAgICAgLy8gYm91bmRzLiBTaW5jZSB0aGlzIGlzIHRyYW5zcGFyZW50LCB3ZSBjYW4gbWFrZSBpdCBsYXJnZXIgdGhhbiB0aGUgYWN0dWFsIGJvdW5kcy5cclxuICAgICAgICBjb25zdCBwYWRkaW5nUmF0aW8gPSAwLjI7XHJcbiAgICAgICAgY29uc3QgaG9yaXpvbnRhbFBhZGRpbmcgPSB0aGlzLm5vZGUuc2VsZkJvdW5kcy53aWR0aCAqIHBhZGRpbmdSYXRpbztcclxuICAgICAgICBjb25zdCB2ZXJ0aWNhbFBhZGRpbmcgPSB0aGlzLm5vZGUuc2VsZkJvdW5kcy5oZWlnaHQgKiBwYWRkaW5nUmF0aW87XHJcbiAgICAgICAgdGhpcy53b3JrYXJvdW5kUmVjdC5zZXRBdHRyaWJ1dGUoICd4JywgdGhpcy5ub2RlLnNlbGZCb3VuZHMubWluWCAtIGhvcml6b250YWxQYWRkaW5nICk7XHJcbiAgICAgICAgdGhpcy53b3JrYXJvdW5kUmVjdC5zZXRBdHRyaWJ1dGUoICd5JywgdGhpcy5ub2RlLnNlbGZCb3VuZHMubWluWSAtIHZlcnRpY2FsUGFkZGluZyApO1xyXG4gICAgICAgIHRoaXMud29ya2Fyb3VuZFJlY3Quc2V0QXR0cmlidXRlKCAnd2lkdGgnLCB0aGlzLm5vZGUuc2VsZkJvdW5kcy53aWR0aCArIDIgKiBob3Jpem9udGFsUGFkZGluZyApO1xyXG4gICAgICAgIHRoaXMud29ya2Fyb3VuZFJlY3Quc2V0QXR0cmlidXRlKCAnaGVpZ2h0JywgdGhpcy5ub2RlLnNlbGZCb3VuZHMuaGVpZ2h0ICsgMiAqIHZlcnRpY2FsUGFkZGluZyApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQXBwbHkgYW55IGZpbGwvc3Ryb2tlIGNoYW5nZXMgdG8gb3VyIGVsZW1lbnQuXHJcbiAgICB0aGlzLnVwZGF0ZUZpbGxTdHJva2VTdHlsZSggdGV4dCApO1xyXG4gIH1cclxufVxyXG5cclxuc2NlbmVyeS5yZWdpc3RlciggJ1RleHRTVkdEcmF3YWJsZScsIFRleHRTVkdEcmF3YWJsZSApO1xyXG5cclxuUG9vbGFibGUubWl4SW50byggVGV4dFNWR0RyYXdhYmxlICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBUZXh0U1ZHRHJhd2FibGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFFBQVEsTUFBTSxzQ0FBc0M7QUFDM0QsT0FBT0MsUUFBUSxNQUFNLHNDQUFzQztBQUMzRCxTQUFTQyxPQUFPLEVBQUVDLEtBQUssRUFBRUMsZUFBZSxFQUFFQyxvQkFBb0IsRUFBRUMsS0FBSyxRQUFRLGtCQUFrQjs7QUFFL0Y7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsQ0FBQzs7QUFFbEM7QUFDQTtBQUNBO0FBQ0EsTUFBTUMsMkJBQTJCLEdBQUcsQ0FBQ1IsUUFBUSxDQUFDUyxJQUFJOztBQUVsRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLCtCQUErQixHQUFHVixRQUFRLENBQUNXLE1BQU07QUFFdkQsTUFBTUMsZUFBZSxTQUFTUCxvQkFBb0IsQ0FBRUQsZUFBZ0IsQ0FBQyxDQUFDO0VBQ3BFO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0VTLFVBQVVBLENBQUVDLFFBQVEsRUFBRUMsUUFBUSxFQUFHO0lBQy9CLEtBQUssQ0FBQ0YsVUFBVSxDQUFFQyxRQUFRLEVBQUVDLFFBQVEsRUFBRSxJ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