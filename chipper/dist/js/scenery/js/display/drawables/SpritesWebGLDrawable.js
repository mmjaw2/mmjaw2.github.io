// Copyright 2019-2024, University of Colorado Boulder

/**
 * WebGL drawable for Sprites.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import animationFrameTimer from '../../../../axon/js/animationFrameTimer.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import platform from '../../../../phet-core/js/platform.js';
import Poolable from '../../../../phet-core/js/Poolable.js';
import { Renderer, scenery, ShaderProgram, SpriteSheet, WebGLSelfDrawable } from '../../imports.js';

// constants
const COMPONENTS = 5; // { X Y U V A }
const FLOAT_QUANTITY = COMPONENTS * 6; // 6 vertices

// scratch values - corner vertices in the relative transform root coordinate space
const upperLeft = new Vector2(0, 0);
const lowerLeft = new Vector2(0, 0);
const upperRight = new Vector2(0, 0);
const lowerRight = new Vector2(0, 0);
class SpritesWebGLDrawable extends WebGLSelfDrawable {
  /**
   * @public
   * @override
   *
   * @param {number} renderer
   * @param {Instance} instance
   */
  initialize(renderer, instance) {
    super.initialize(renderer, instance);

    // @private {function}
    this.contextChangeListener = this.onWebGLContextChange.bind(this);

    // @private {SpriteSheet}
    this.spriteSheet = new SpriteSheet(true);

    // @private {Object} - Maps {number} SpriteImage.id => {Bounds2} UV bounds
    this.spriteImageUVMap = {};

    // @private {Float32Array}
    this.vertexArray = new Float32Array(128 * FLOAT_QUANTITY);

    // @private {Float32Array}
    this.transformMatrixArray = new Float32Array(9);

    // @private {function}
    this.spriteChangeListener = this.onSpriteChange.bind(this);
    this.node._sprites.forEach(sprite => {
      sprite.imageProperty.lazyLink(this.spriteChangeListener);
      this.addSpriteImage(sprite.imageProperty.value);
    });

    // @private {boolean} - See https://github.com/phetsims/natural-selection/issues/243
    this.hasDrawn = false;
  }

  /**
   * Adds a SpriteImage to our SpriteSheet.
   * @private
   *
   * @param {SpriteImage} spriteImage
   */
  addSpriteImage(spriteImage) {
    this.spriteImageUVMap[spriteImage.id] = this.spriteSheet.addImage(spriteImage.image, spriteImage.image.width, spriteImage.image.height).uvBounds;
  }

  /**
   * Removes a SpriteImage from our SpriteSheet.
   * @private
   *
   * @param {SpriteImage} spriteImage
   */
  removeSpriteImage(spriteImage) {
    this.spriteSheet.removeImage(spriteImage.image);
    delete this.spriteImageUVMap[spriteImage.id];
  }

  /**
   * Called when a Sprite's SpriteImage changes.
   * @private
   *
   * @param {SpriteImage} newSpriteImage
   * @param {SpriteImage} oldSpriteImage
   */
  onSpriteChange(newSpriteImage, oldSpriteImage) {
    this.removeSpriteImage(oldSpriteImage);
    this.addSpriteImage(newSpriteImage);
  }

  /**
   * Sets up everything with a new WebGL context
   *
   * @private
   */
  setup() {
    const gl = this.webGLBlock.gl;
    this.spriteSheet.initializeContext(gl);

    // @private {ShaderProgram}
    this.shaderProgram = new ShaderProgram(gl, [
    // vertex shader
    'attribute vec2 aVertex;', 'attribute vec2 aTextureCoord;', 'attribute float aAlpha;', 'varying vec2 vTextureCoord;', 'varying float vAlpha;', 'uniform mat3 uProjectionMatrix;', 'uniform mat3 uTransformMatrix;', 'void main() {', '  vTextureCoord = aTextureCoord;', '  vAlpha = aAlpha;', '  vec3 ndc = uProjectionMatrix * ( uTransformMatrix * vec3( aVertex, 1.0 ) );',
    // homogeneous map to to normalized device coordinates
    '  gl_Position = vec4( ndc.xy, 0.0, 1.0 );', '}'].join('\n'), [
    // fragment shader
    'precision mediump float;', 'varying vec2 vTextureCoord;', 'varying float vAlpha;', 'uniform sampler2D uTexture;', 'void main() {', '  vec4 color = texture2D( uTexture, vTextureCoord, -0.7 );',
    // mipmap LOD bias of -0.7 (for now)
    // our input and output is premultiplied alpha, so we need to multiply the color by the alpha
    '  color *= vAlpha;', '  gl_FragColor = color;', '}'].join('\n'), {
      attributes: ['aVertex', 'aTextureCoord', 'aAlpha'],
      uniforms: ['uTexture', 'uProjectionMatrix', 'uTransformMatrix']
    });

    // @private {WebGLBuffer}
    this.vertexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, this.vertexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, this.vertexArray, gl.DYNAMIC_DRAW); // fully buffer at the start
  }

  /**
   * Callback for when the WebGL context changes. We'll reconstruct the painter.
   * @public
   */
  onWebGLContextChange() {
    this.setup();
  }

  /**
   * Called when this drawable is added to a block.
   * @public
   *
   * @param {WebGLBlock} webGLBlock
   */
  onAddToBlock(webGLBlock) {
    // @private {WebGLBlock}
    this.webGLBlock = webGLBlock;
    this.setup();
    webGLBlock.glChangedEmitter.addListener(this.contextChangeListener);
  }

  /**
   * Called when this drawable is removed from a block.
   * @public
   *
   * @param {WebGLBlock} webGLBlock
   */
  onRemoveFromBlock(webGLBlock) {
    webGLBlock.glChangedEmitter.removeListener(this.contextChangeListener);
  }

  /**
   * Draws the WebGL content.
   * @public
   */
  draw() {
    const length = this.node._spriteInstances.length;

    // Don't render anything if we have nothing
    if (length === 0) {
      return 0;
    }
    assert && assert(this.node.canvasBounds.isValid(), 'Sprites canvasBounds should be set and have non-negative area if it renders sprites');
    this.spriteSheet.updateTexture();
    this.shaderProgram.use();
    let vertexArrayIndex = 0;
    let changedLength = false;

    // if our vertex data won't fit, keep doubling the size until it fits
    while (FLOAT_QUANTITY * length > this.vertexArray.length) {
      this.vertexArray = new Float32Array(this.vertexArray.length * 2);
      changedLength = true;
    }
    for (let i = 0; i < length; i++) {
      const spriteInstance = this.node._spriteInstances[i];
      const spriteImage = spriteInstance.sprite.imageProperty.value;
      const alpha = spriteInstance.alpha * spriteImage.imageOpacity;
      const uvBounds = this.spriteImageUVMap[spriteImage.id];
      const matrix = spriteInstance.matrix;
      const offset = spriteImage.offset;
      const width = spriteImage.image.width;
      const height = spriteImage.image.height;

      // Compute our vertices
      matrix.multiplyVector2(upperLeft.setXY(-offset.x, -offset.y));
      matrix.multiplyVector2(lowerLeft.setXY(-offset.x, height - offset.y));
      matrix.multiplyVector2(upperRight.setXY(width - offset.x, -offset.y));
      matrix.multiplyVector2(lowerRight.setXY(width - offset.x, height - offset.y));

      // copy our vertex data into the main array (consensus was that this is the fastest way to fill in data)
      this.vertexArray[vertexArrayIndex + 0] = upperLeft.x;
      this.vertexArray[vertexArrayIndex + 1] = upperLeft.y;
      this.vertexArray[vertexArrayIndex + 2] = uvBounds.minX;
      this.vertexArray[vertexArrayIndex + 3] = uvBounds.minY;
      this.vertexArray[vertexArrayIndex + 4] = alpha;
      this.vertexArray[vertexArrayIndex + 5] = lowerLeft.x;
      this.vertexArray[vertexArrayIndex + 6] = lowerLeft.y;
      this.vertexArray[vertexArrayIndex + 7] = uvBounds.minX;
      this.vertexArray[vertexArrayIndex + 8] = uvBounds.maxY;
      this.vertexArray[vertexArrayIndex + 9] = alpha;
      this.vertexArray[vertexArrayIndex + 10] = upperRight.x;
      this.vertexArray[vertexArrayIndex + 11] = upperRight.y;
      this.vertexArray[vertexArrayIndex + 12] = uvBounds.maxX;
      this.vertexArray[vertexArrayIndex + 13] = uvBounds.minY;
      this.vertexArray[vertexArrayIndex + 14] = alpha;
      this.vertexArray[vertexArrayIndex + 15] = upperRight.x;
      this.vertexArray[vertexArrayIndex + 16] = upperRight.y;
      this.vertexArray[vertexArrayIndex + 17] = uvBounds.maxX;
      this.vertexArray[vertexArrayIndex + 18] = uvBounds.minY;
      this.vertexArray[vertexArrayIndex + 19] = alpha;
      this.vertexArray[vertexArrayIndex + 20] = lowerLeft.x;
      this.vertexArray[vertexArrayIndex + 21] = lowerLeft.y;
      this.vertexArray[vertexArrayIndex + 22] = uvBounds.minX;
      this.vertexArray[vertexArrayIndex + 23] = uvBounds.maxY;
      this.vertexArray[vertexArrayIndex + 24] = alpha;
      this.vertexArray[vertexArrayIndex + 25] = lowerRight.x;
      this.vertexArray[vertexArrayIndex + 26] = lowerRight.y;
      this.vertexArray[vertexArrayIndex + 27] = uvBounds.maxX;
      this.vertexArray[vertexArrayIndex + 28] = uvBounds.maxY;
      this.vertexArray[vertexArrayIndex + 29] = alpha;
      vertexArrayIndex += FLOAT_QUANTITY;
    }
    const gl = this.webGLBlock.gl;

    // (uniform) projection transform into normalized device coordinates
    gl.uniformMatrix3fv(this.shaderProgram.uniformLocations.uProjectionMatrix, false, this.webGLBlock.projectionMatrixArray);

    // (uniform) transformation matrix that is common to all sprites
    this.instance.relativeTransform.matrix.copyToArray(this.transformMatrixArray);
    gl.uniformMatrix3fv(this.shaderProgram.uniformLocations.uTransformMatrix, false, this.transformMatrixArray);
    gl.bindBuffer(gl.ARRAY_BUFFER, this.vertexBuffer);
    // if we increased in length, we need to do a full bufferData to resize it on the GPU side
    if (changedLength) {
      gl.bufferData(gl.ARRAY_BUFFER, this.vertexArray, gl.DYNAMIC_DRAW); // fully buffer at the start
    }
    // otherwise do a more efficient update that only sends part of the array over
    else {
      gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.vertexArray.subarray(0, vertexArrayIndex));
    }
    const sizeOfFloat = Float32Array.BYTES_PER_ELEMENT;
    const stride = COMPONENTS * sizeOfFloat;
    gl.vertexAttribPointer(this.shaderProgram.attributeLocations.aVertex, 2, gl.FLOAT, false, stride, 0 * sizeOfFloat);
    gl.vertexAttribPointer(this.shaderProgram.attributeLocations.aTextureCoord, 2, gl.FLOAT, false, stride, 2 * sizeOfFloat);
    gl.vertexAttribPointer(this.shaderProgram.attributeLocations.aAlpha, 1, gl.FLOAT, false, stride, 4 * sizeOfFloat);
    gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D, this.spriteSheet.texture);
    gl.uniform1i(this.shaderProgram.uniformLocations.uTexture, 0);
    gl.drawArrays(gl.TRIANGLES, 0, vertexArrayIndex / COMPONENTS);
    gl.bindTexture(gl.TEXTURE_2D, null);
    this.shaderProgram.unuse();

    // See https://github.com/phetsims/natural-selection/issues/243
    if (!this.hasDrawn && platform.safari) {
      // Redraw once more if we're in Safari, since it's undetermined why an initial draw isn't working.
      // Everything seems to otherwise be in place.
      animationFrameTimer.setTimeout(() => this.markDirty(), 0);
    }
    this.hasDrawn = true;
    return 1;
  }

  /**
   * Disposes the drawable.
   * @public
   * @override
   */
  dispose() {
    this.node._sprites.forEach(sprite => {
      sprite.imageProperty.unlink(this.spriteChangeListener);
    });
    if (this.webGLBlock) {
      this.webGLBlock = null;
    }

    // super
    super.dispose();
  }

  /**
   * A "catch-all" dirty method that directly marks the paintDirty flag and triggers propagation of dirty
   * information. This can be used by other mark* methods, or directly itself if the paintDirty flag is checked.
   * @public
   *
   * It should be fired (indirectly or directly) for anything besides transforms that needs to make a drawable
   * dirty.
   */
  markPaintDirty() {
    this.markDirty();
  }
}

// We use a custom renderer for the needed flexibility
SpritesWebGLDrawable.prototype.webglRenderer = Renderer.webglCustom;
scenery.register('SpritesWebGLDrawable', SpritesWebGLDrawable);
Poolable.mixInto(SpritesWebGLDrawable);
export default SpritesWebGLDrawable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhbmltYXRpb25GcmFtZVRpbWVyIiwiVmVjdG9yMiIsInBsYXRmb3JtIiwiUG9vbGFibGUiLCJSZW5kZXJlciIsInNjZW5lcnkiLCJTaGFkZXJQcm9ncmFtIiwiU3ByaXRlU2hlZXQiLCJXZWJHTFNlbGZEcmF3YWJsZSIsIkNPTVBPTkVOVFMiLCJGTE9BVF9RVUFOVElUWSIsInVwcGVyTGVmdCIsImxvd2VyTGVmdCIsInVwcGVyUmlnaHQiLCJsb3dlclJpZ2h0IiwiU3ByaXRlc1dlYkdMRHJhd2FibGUiLCJpbml0aWFsaXplIiwicmVuZGVyZXIiLCJpbnN0YW5jZSIsImNvbnRleHRDaGFuZ2VMaXN0ZW5lciIsIm9uV2ViR0xDb250ZXh0Q2hhbmdlIiwiYmluZCIsInNwcml0ZVNoZWV0Iiwic3ByaXRlSW1hZ2VVVk1hcCIsInZlcnRleEFycmF5IiwiRmxvYXQzMkFycmF5IiwidHJhbnNmb3JtTWF0cml4QXJyYXkiLCJzcHJpdGVDaGFuZ2VMaXN0ZW5lciIsIm9uU3ByaXRlQ2hhbmdlIiwibm9kZSIsIl9zcHJpdGVzIiwiZm9yRWFjaCIsInNwcml0ZSIsImltYWdlUHJvcGVydHkiLCJsYXp5TGluayIsImFkZFNwcml0ZUltYWdlIiwidmFsdWUiLCJoYXNEcmF3biIsInNwcml0ZUltYWdlIiwiaWQiLCJhZGRJbWFnZSIsImltYWdlIiwid2lkdGgiLCJoZWlnaHQiLCJ1dkJvdW5kcyIsInJlbW92ZVNwcml0ZUltYWdlIiwicmVtb3ZlSW1hZ2UiLCJuZXdTcHJpdGVJbWFnZSIsIm9sZFNwcml0ZUltYWdlIiwic2V0dXAiLCJnbCIsIndlYkdMQmxvY2siLCJpbml0aWFsaXplQ29udGV4dCIsInNoYWRlclByb2dyYW0iLCJqb2luIiwiYXR0cmlidXRlcyIsInVuaWZvcm1zIiwidmVydGV4QnVmZmVyIiwiY3JlYXRlQnVmZmVyIiwiYmluZEJ1ZmZlciIsIkFSUkFZX0JVRkZFUiIsImJ1ZmZlckRhdGEiLCJEWU5BTUlDX0RSQVciLCJvbkFkZFRvQmxvY2siLCJnbENoYW5nZWRFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJvblJlbW92ZUZyb21CbG9jayIsInJlbW92ZUxpc3RlbmVyIiwiZHJhdyIsImxlbmd0aCIsIl9zcHJpdGVJbnN0YW5jZXMiLCJhc3NlcnQiLCJjYW52YXNCb3VuZHMiLCJpc1ZhbGlkIiwidXBkYXRlVGV4dHVyZSIsInVzZSIsInZlcnRleEFycmF5SW5kZXgiLCJjaGFuZ2VkTGVuZ3RoIiwiaSIsInNwcml0ZUluc3RhbmNlIiwiYWxwaGEiLCJpbWFnZU9wYWNpdHkiLCJtYXRyaXgiLCJvZmZzZXQiLCJtdWx0aXBseVZlY3RvcjIiLCJzZXRYWSIsIngiLCJ5IiwibWluWCIsIm1pblkiLCJtYXhZIiwibWF4WCIsInVuaWZvcm1NYXRyaXgzZnYiLCJ1bmlmb3JtTG9jYXRpb25zIiwidVByb2plY3Rpb25NYXRyaXgiLCJwcm9qZWN0aW9uTWF0cml4QXJyYXkiLCJyZWxhdGl2ZVRyYW5zZm9ybSIsImNvcHlUb0FycmF5IiwidVRyYW5zZm9ybU1hdHJpeCIsImJ1ZmZlclN1YkRhdGEiLCJzdWJhcnJheSIsInNpemVPZkZsb2F0IiwiQllURVNfUEVSX0VMRU1FTlQiLCJzdHJpZGUiLCJ2ZXJ0ZXhBdHRyaWJQb2ludGVyIiwiYXR0cmlidXRlTG9jYXRpb25zIiwiYVZlcnRleCIsIkZMT0FUIiwiYVRleHR1cmVDb29yZCIsImFBbHBoYSIsImFjdGl2ZVRleHR1cmUiLCJURVhUVVJFMCIsImJpbmRUZXh0dXJlIiwiVEVYVFVSRV8yRCIsInRleHR1cmUiLCJ1bmlmb3JtMWkiLCJ1VGV4dHVyZSIsImRyYXdBcnJheXMiLCJUUklBTkdMRVMiLCJ1bnVzZSIsInNhZmFyaSIsInNldFRpbWVvdXQiLCJtYXJrRGlydHkiLCJkaXNwb3NlIiwidW5saW5rIiwibWFya1BhaW50RGlydHkiLCJwcm90b3R5cGUiLCJ3ZWJnbFJlbmRlcmVyIiwid2ViZ2xDdXN0b20iLCJyZWdpc3RlciIsIm1peEludG8iXSwic291cmNlcyI6WyJTcHJpdGVzV2ViR0xEcmF3YWJsZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBXZWJHTCBkcmF3YWJsZSBmb3IgU3ByaXRlcy5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBhbmltYXRpb25GcmFtZVRpbWVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvYW5pbWF0aW9uRnJhbWVUaW1lci5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IHBsYXRmb3JtIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9wbGF0Zm9ybS5qcyc7XHJcbmltcG9ydCBQb29sYWJsZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvUG9vbGFibGUuanMnO1xyXG5pbXBvcnQgeyBSZW5kZXJlciwgc2NlbmVyeSwgU2hhZGVyUHJvZ3JhbSwgU3ByaXRlU2hlZXQsIFdlYkdMU2VsZkRyYXdhYmxlIH0gZnJvbSAnLi4vLi4vaW1wb3J0cy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgQ09NUE9ORU5UUyA9IDU7IC8vIHsgWCBZIFUgViBBIH1cclxuY29uc3QgRkxPQVRfUVVBTlRJVFkgPSBDT01QT05FTlRTICogNjsgLy8gNiB2ZXJ0aWNlc1xyXG5cclxuLy8gc2NyYXRjaCB2YWx1ZXMgLSBjb3JuZXIgdmVydGljZXMgaW4gdGhlIHJlbGF0aXZlIHRyYW5zZm9ybSByb290IGNvb3JkaW5hdGUgc3BhY2VcclxuY29uc3QgdXBwZXJMZWZ0ID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuY29uc3QgbG93ZXJMZWZ0ID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuY29uc3QgdXBwZXJSaWdodCA9IG5ldyBWZWN0b3IyKCAwLCAwICk7XHJcbmNvbnN0IGxvd2VyUmlnaHQgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG5cclxuY2xhc3MgU3ByaXRlc1dlYkdMRHJhd2FibGUgZXh0ZW5kcyBXZWJHTFNlbGZEcmF3YWJsZSB7XHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IHJlbmRlcmVyXHJcbiAgICogQHBhcmFtIHtJbnN0YW5jZX0gaW5zdGFuY2VcclxuICAgKi9cclxuICBpbml0aWFsaXplKCByZW5kZXJlciwgaW5zdGFuY2UgKSB7XHJcbiAgICBzdXBlci5pbml0aWFsaXplKCByZW5kZXJlciwgaW5zdGFuY2UgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7ZnVuY3Rpb259XHJcbiAgICB0aGlzLmNvbnRleHRDaGFuZ2VMaXN0ZW5lciA9IHRoaXMub25XZWJHTENvbnRleHRDaGFuZ2UuYmluZCggdGhpcyApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtTcHJpdGVTaGVldH1cclxuICAgIHRoaXMuc3ByaXRlU2hlZXQgPSBuZXcgU3ByaXRlU2hlZXQoIHRydWUgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7T2JqZWN0fSAtIE1hcHMge251bWJlcn0gU3ByaXRlSW1hZ2UuaWQgPT4ge0JvdW5kczJ9IFVWIGJvdW5kc1xyXG4gICAgdGhpcy5zcHJpdGVJbWFnZVVWTWFwID0ge307XHJcblxyXG4gICAgLy8gQHByaXZhdGUge0Zsb2F0MzJBcnJheX1cclxuICAgIHRoaXMudmVydGV4QXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KCAxMjggKiBGTE9BVF9RVUFOVElUWSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtGbG9hdDMyQXJyYXl9XHJcbiAgICB0aGlzLnRyYW5zZm9ybU1hdHJpeEFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSggOSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtmdW5jdGlvbn1cclxuICAgIHRoaXMuc3ByaXRlQ2hhbmdlTGlzdGVuZXIgPSB0aGlzLm9uU3ByaXRlQ2hhbmdlLmJpbmQoIHRoaXMgKTtcclxuXHJcbiAgICB0aGlzLm5vZGUuX3Nwcml0ZXMuZm9yRWFjaCggc3ByaXRlID0+IHtcclxuICAgICAgc3ByaXRlLmltYWdlUHJvcGVydHkubGF6eUxpbmsoIHRoaXMuc3ByaXRlQ2hhbmdlTGlzdGVuZXIgKTtcclxuICAgICAgdGhpcy5hZGRTcHJpdGVJbWFnZSggc3ByaXRlLmltYWdlUHJvcGVydHkudmFsdWUgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7Ym9vbGVhbn0gLSBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL25hdHVyYWwtc2VsZWN0aW9uL2lzc3Vlcy8yNDNcclxuICAgIHRoaXMuaGFzRHJhd24gPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFkZHMgYSBTcHJpdGVJbWFnZSB0byBvdXIgU3ByaXRlU2hlZXQuXHJcbiAgICogQHByaXZhdGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7U3ByaXRlSW1hZ2V9IHNwcml0ZUltYWdlXHJcbiAgICovXHJcbiAgYWRkU3ByaXRlSW1hZ2UoIHNwcml0ZUltYWdlICkge1xyXG4gICAgdGhpcy5zcHJpdGVJbWFnZVVWTWFwWyBzcHJpdGVJbWFnZS5pZCBdID0gdGhpcy5zcHJpdGVTaGVldC5hZGRJbWFnZSggc3ByaXRlSW1hZ2UuaW1hZ2UsIHNwcml0ZUltYWdlLmltYWdlLndpZHRoLCBzcHJpdGVJbWFnZS5pbWFnZS5oZWlnaHQgKS51dkJvdW5kcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbW92ZXMgYSBTcHJpdGVJbWFnZSBmcm9tIG91ciBTcHJpdGVTaGVldC5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtTcHJpdGVJbWFnZX0gc3ByaXRlSW1hZ2VcclxuICAgKi9cclxuICByZW1vdmVTcHJpdGVJbWFnZSggc3ByaXRlSW1hZ2UgKSB7XHJcbiAgICB0aGlzLnNwcml0ZVNoZWV0LnJlbW92ZUltYWdlKCBzcHJpdGVJbWFnZS5pbWFnZSApO1xyXG5cclxuICAgIGRlbGV0ZSB0aGlzLnNwcml0ZUltYWdlVVZNYXBbIHNwcml0ZUltYWdlLmlkIF07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDYWxsZWQgd2hlbiBhIFNwcml0ZSdzIFNwcml0ZUltYWdlIGNoYW5nZXMuXHJcbiAgICogQHByaXZhdGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7U3ByaXRlSW1hZ2V9IG5ld1Nwcml0ZUltYWdlXHJcbiAgICogQHBhcmFtIHtTcHJpdGVJbWFnZX0gb2xkU3ByaXRlSW1hZ2VcclxuICAgKi9cclxuICBvblNwcml0ZUNoYW5nZSggbmV3U3ByaXRlSW1hZ2UsIG9sZFNwcml0ZUltYWdlICkge1xyXG4gICAgdGhpcy5yZW1vdmVTcHJpdGVJbWFnZSggb2xkU3ByaXRlSW1hZ2UgKTtcclxuICAgIHRoaXMuYWRkU3ByaXRlSW1hZ2UoIG5ld1Nwcml0ZUltYWdlICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXRzIHVwIGV2ZXJ5dGhpbmcgd2l0aCBhIG5ldyBXZWJHTCBjb250ZXh0XHJcbiAgICpcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHNldHVwKCkge1xyXG4gICAgY29uc3QgZ2wgPSB0aGlzLndlYkdMQmxvY2suZ2w7XHJcblxyXG4gICAgdGhpcy5zcHJpdGVTaGVldC5pbml0aWFsaXplQ29udGV4dCggZ2wgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7U2hhZGVyUHJvZ3JhbX1cclxuICAgIHRoaXMuc2hhZGVyUHJvZ3JhbSA9IG5ldyBTaGFkZXJQcm9ncmFtKCBnbCwgW1xyXG4gICAgICAvLyB2ZXJ0ZXggc2hhZGVyXHJcbiAgICAgICdhdHRyaWJ1dGUgdmVjMiBhVmVydGV4OycsXHJcbiAgICAgICdhdHRyaWJ1dGUgdmVjMiBhVGV4dHVyZUNvb3JkOycsXHJcbiAgICAgICdhdHRyaWJ1dGUgZmxvYXQgYUFscGhhOycsXHJcbiAgICAgICd2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsnLFxyXG4gICAgICAndmFyeWluZyBmbG9hdCB2QWxwaGE7JyxcclxuICAgICAgJ3VuaWZvcm0gbWF0MyB1UHJvamVjdGlvbk1hdHJpeDsnLFxyXG4gICAgICAndW5pZm9ybSBtYXQzIHVUcmFuc2Zvcm1NYXRyaXg7JyxcclxuXHJcbiAgICAgICd2b2lkIG1haW4oKSB7JyxcclxuICAgICAgJyAgdlRleHR1cmVDb29yZCA9IGFUZXh0dXJlQ29vcmQ7JyxcclxuICAgICAgJyAgdkFscGhhID0gYUFscGhhOycsXHJcbiAgICAgICcgIHZlYzMgbmRjID0gdVByb2plY3Rpb25NYXRyaXggKiAoIHVUcmFuc2Zvcm1NYXRyaXggKiB2ZWMzKCBhVmVydGV4LCAxLjAgKSApOycsIC8vIGhvbW9nZW5lb3VzIG1hcCB0byB0byBub3JtYWxpemVkIGRldmljZSBjb29yZGluYXRlc1xyXG4gICAgICAnICBnbF9Qb3NpdGlvbiA9IHZlYzQoIG5kYy54eSwgMC4wLCAxLjAgKTsnLFxyXG4gICAgICAnfSdcclxuICAgIF0uam9pbiggJ1xcbicgKSwgW1xyXG4gICAgICAvLyBmcmFnbWVudCBzaGFkZXJcclxuICAgICAgJ3ByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OycsXHJcbiAgICAgICd2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsnLFxyXG4gICAgICAndmFyeWluZyBmbG9hdCB2QWxwaGE7JyxcclxuICAgICAgJ3VuaWZvcm0gc2FtcGxlcjJEIHVUZXh0dXJlOycsXHJcblxyXG4gICAgICAndm9pZCBtYWluKCkgeycsXHJcbiAgICAgICcgIHZlYzQgY29sb3IgPSB0ZXh0dXJlMkQoIHVUZXh0dXJlLCB2VGV4dHVyZUNvb3JkLCAtMC43ICk7JywgLy8gbWlwbWFwIExPRCBiaWFzIG9mIC0wLjcgKGZvciBub3cpXHJcbiAgICAgIC8vIG91ciBpbnB1dCBhbmQgb3V0cHV0IGlzIHByZW11bHRpcGxpZWQgYWxwaGEsIHNvIHdlIG5lZWQgdG8gbXVsdGlwbHkgdGhlIGNvbG9yIGJ5IHRoZSBhbHBoYVxyXG4gICAgICAnICBjb2xvciAqPSB2QWxwaGE7JyxcclxuICAgICAgJyAgZ2xfRnJhZ0NvbG9yID0gY29sb3I7JyxcclxuICAgICAgJ30nXHJcbiAgICBdLmpvaW4oICdcXG4nICksIHtcclxuICAgICAgYXR0cmlidXRlczogWyAnYVZlcnRleCcsICdhVGV4dHVyZUNvb3JkJywgJ2FBbHBoYScgXSxcclxuICAgICAgdW5pZm9ybXM6IFsgJ3VUZXh0dXJlJywgJ3VQcm9qZWN0aW9uTWF0cml4JywgJ3VUcmFuc2Zvcm1NYXRyaXgnIF1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7V2ViR0xCdWZmZXJ9XHJcbiAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpO1xyXG5cclxuICAgIGdsLmJpbmRCdWZmZXIoIGdsLkFSUkFZX0JVRkZFUiwgdGhpcy52ZXJ0ZXhCdWZmZXIgKTtcclxuICAgIGdsLmJ1ZmZlckRhdGEoIGdsLkFSUkFZX0JVRkZFUiwgdGhpcy52ZXJ0ZXhBcnJheSwgZ2wuRFlOQU1JQ19EUkFXICk7IC8vIGZ1bGx5IGJ1ZmZlciBhdCB0aGUgc3RhcnRcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxiYWNrIGZvciB3aGVuIHRoZSBXZWJHTCBjb250ZXh0IGNoYW5nZXMuIFdlJ2xsIHJlY29uc3RydWN0IHRoZSBwYWludGVyLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBvbldlYkdMQ29udGV4dENoYW5nZSgpIHtcclxuICAgIHRoaXMuc2V0dXAoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxlZCB3aGVuIHRoaXMgZHJhd2FibGUgaXMgYWRkZWQgdG8gYSBibG9jay5cclxuICAgKiBAcHVibGljXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge1dlYkdMQmxvY2t9IHdlYkdMQmxvY2tcclxuICAgKi9cclxuICBvbkFkZFRvQmxvY2soIHdlYkdMQmxvY2sgKSB7XHJcbiAgICAvLyBAcHJpdmF0ZSB7V2ViR0xCbG9ja31cclxuICAgIHRoaXMud2ViR0xCbG9jayA9IHdlYkdMQmxvY2s7XHJcblxyXG4gICAgdGhpcy5zZXR1cCgpO1xyXG5cclxuICAgIHdlYkdMQmxvY2suZ2xDaGFuZ2VkRW1pdHRlci5hZGRMaXN0ZW5lciggdGhpcy5jb250ZXh0Q2hhbmdlTGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxlZCB3aGVuIHRoaXMgZHJhd2FibGUgaXMgcmVtb3ZlZCBmcm9tIGEgYmxvY2suXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHBhcmFtIHtXZWJHTEJsb2NrfSB3ZWJHTEJsb2NrXHJcbiAgICovXHJcbiAgb25SZW1vdmVGcm9tQmxvY2soIHdlYkdMQmxvY2sgKSB7XHJcbiAgICB3ZWJHTEJsb2NrLmdsQ2hhbmdlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMuY29udGV4dENoYW5nZUxpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEcmF3cyB0aGUgV2ViR0wgY29udGVudC5cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZHJhdygpIHtcclxuICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMubm9kZS5fc3ByaXRlSW5zdGFuY2VzLmxlbmd0aDtcclxuXHJcbiAgICAvLyBEb24ndCByZW5kZXIgYW55dGhpbmcgaWYgd2UgaGF2ZSBub3RoaW5nXHJcbiAgICBpZiAoIGxlbmd0aCA9PT0gMCApIHtcclxuICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5ub2RlLmNhbnZhc0JvdW5kcy5pc1ZhbGlkKCksXHJcbiAgICAgICdTcHJpdGVzIGNhbnZhc0JvdW5kcyBzaG91bGQgYmUgc2V0IGFuZCBoYXZlIG5vbi1uZWdhdGl2ZSBhcmVhIGlmIGl0IHJlbmRlcnMgc3ByaXRlcycgKTtcclxuXHJcbiAgICB0aGlzLnNwcml0ZVNoZWV0LnVwZGF0ZVRleHR1cmUoKTtcclxuXHJcbiAgICB0aGlzLnNoYWRlclByb2dyYW0udXNlKCk7XHJcblxyXG4gICAgbGV0IHZlcnRleEFycmF5SW5kZXggPSAwO1xyXG4gICAgbGV0IGNoYW5nZWRMZW5ndGggPSBmYWxzZTtcclxuXHJcbiAgICAvLyBpZiBvdXIgdmVydGV4IGRhdGEgd29uJ3QgZml0LCBrZWVwIGRvdWJsaW5nIHRoZSBzaXplIHVudGlsIGl0IGZpdHNcclxuICAgIHdoaWxlICggRkxPQVRfUVVBTlRJVFkgKiBsZW5ndGggPiB0aGlzLnZlcnRleEFycmF5Lmxlbmd0aCApIHtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoIHRoaXMudmVydGV4QXJyYXkubGVuZ3RoICogMiApO1xyXG4gICAgICBjaGFuZ2VkTGVuZ3RoID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyApIHtcclxuICAgICAgY29uc3Qgc3ByaXRlSW5zdGFuY2UgPSB0aGlzLm5vZGUuX3Nwcml0ZUluc3RhbmNlc1sgaSBdO1xyXG4gICAgICBjb25zdCBzcHJpdGVJbWFnZSA9IHNwcml0ZUluc3RhbmNlLnNwcml0ZS5pbWFnZVByb3BlcnR5LnZhbHVlO1xyXG4gICAgICBjb25zdCBhbHBoYSA9IHNwcml0ZUluc3RhbmNlLmFscGhhICogc3ByaXRlSW1hZ2UuaW1hZ2VPcGFjaXR5O1xyXG4gICAgICBjb25zdCB1dkJvdW5kcyA9IHRoaXMuc3ByaXRlSW1hZ2VVVk1hcFsgc3ByaXRlSW1hZ2UuaWQgXTtcclxuICAgICAgY29uc3QgbWF0cml4ID0gc3ByaXRlSW5zdGFuY2UubWF0cml4O1xyXG4gICAgICBjb25zdCBvZmZzZXQgPSBzcHJpdGVJbWFnZS5vZmZzZXQ7XHJcblxyXG4gICAgICBjb25zdCB3aWR0aCA9IHNwcml0ZUltYWdlLmltYWdlLndpZHRoO1xyXG4gICAgICBjb25zdCBoZWlnaHQgPSBzcHJpdGVJbWFnZS5pbWFnZS5oZWlnaHQ7XHJcblxyXG4gICAgICAvLyBDb21wdXRlIG91ciB2ZXJ0aWNlc1xyXG4gICAgICBtYXRyaXgubXVsdGlwbHlWZWN0b3IyKCB1cHBlckxlZnQuc2V0WFkoIC1vZmZzZXQueCwgLW9mZnNldC55ICkgKTtcclxuICAgICAgbWF0cml4Lm11bHRpcGx5VmVjdG9yMiggbG93ZXJMZWZ0LnNldFhZKCAtb2Zmc2V0LngsIGhlaWdodCAtIG9mZnNldC55ICkgKTtcclxuICAgICAgbWF0cml4Lm11bHRpcGx5VmVjdG9yMiggdXBwZXJSaWdodC5zZXRYWSggd2lkdGggLSBvZmZzZXQueCwgLW9mZnNldC55ICkgKTtcclxuICAgICAgbWF0cml4Lm11bHRpcGx5VmVjdG9yMiggbG93ZXJSaWdodC5zZXRYWSggd2lkdGggLSBvZmZzZXQueCwgaGVpZ2h0IC0gb2Zmc2V0LnkgKSApO1xyXG5cclxuICAgICAgLy8gY29weSBvdXIgdmVydGV4IGRhdGEgaW50byB0aGUgbWFpbiBhcnJheSAoY29uc2Vuc3VzIHdhcyB0aGF0IHRoaXMgaXMgdGhlIGZhc3Rlc3Qgd2F5IHRvIGZpbGwgaW4gZGF0YSlcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDAgXSA9IHVwcGVyTGVmdC54O1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMSBdID0gdXBwZXJMZWZ0Lnk7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAyIF0gPSB1dkJvdW5kcy5taW5YO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMyBdID0gdXZCb3VuZHMubWluWTtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDQgXSA9IGFscGhhO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgNSBdID0gbG93ZXJMZWZ0Lng7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyA2IF0gPSBsb3dlckxlZnQueTtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDcgXSA9IHV2Qm91bmRzLm1pblg7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyA4IF0gPSB1dkJvdW5kcy5tYXhZO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgOSBdID0gYWxwaGE7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAxMCBdID0gdXBwZXJSaWdodC54O1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMTEgXSA9IHVwcGVyUmlnaHQueTtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDEyIF0gPSB1dkJvdW5kcy5tYXhYO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMTMgXSA9IHV2Qm91bmRzLm1pblk7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAxNCBdID0gYWxwaGE7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAxNSBdID0gdXBwZXJSaWdodC54O1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMTYgXSA9IHVwcGVyUmlnaHQueTtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDE3IF0gPSB1dkJvdW5kcy5tYXhYO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMTggXSA9IHV2Qm91bmRzLm1pblk7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAxOSBdID0gYWxwaGE7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAyMCBdID0gbG93ZXJMZWZ0Lng7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAyMSBdID0gbG93ZXJMZWZ0Lnk7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAyMiBdID0gdXZCb3VuZHMubWluWDtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDIzIF0gPSB1dkJvdW5kcy5tYXhZO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMjQgXSA9IGFscGhhO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMjUgXSA9IGxvd2VyUmlnaHQueDtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDI2IF0gPSBsb3dlclJpZ2h0Lnk7XHJcbiAgICAgIHRoaXMudmVydGV4QXJyYXlbIHZlcnRleEFycmF5SW5kZXggKyAyNyBdID0gdXZCb3VuZHMubWF4WDtcclxuICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsgdmVydGV4QXJyYXlJbmRleCArIDI4IF0gPSB1dkJvdW5kcy5tYXhZO1xyXG4gICAgICB0aGlzLnZlcnRleEFycmF5WyB2ZXJ0ZXhBcnJheUluZGV4ICsgMjkgXSA9IGFscGhhO1xyXG5cclxuICAgICAgdmVydGV4QXJyYXlJbmRleCArPSBGTE9BVF9RVUFOVElUWTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBnbCA9IHRoaXMud2ViR0xCbG9jay5nbDtcclxuXHJcbiAgICAvLyAodW5pZm9ybSkgcHJvamVjdGlvbiB0cmFuc2Zvcm0gaW50byBub3JtYWxpemVkIGRldmljZSBjb29yZGluYXRlc1xyXG4gICAgZ2wudW5pZm9ybU1hdHJpeDNmdiggdGhpcy5zaGFkZXJQcm9ncmFtLnVuaWZvcm1Mb2NhdGlvbnMudVByb2plY3Rpb25NYXRyaXgsIGZhbHNlLCB0aGlzLndlYkdMQmxvY2sucHJvamVjdGlvbk1hdHJpeEFycmF5ICk7XHJcblxyXG4gICAgLy8gKHVuaWZvcm0pIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCB0aGF0IGlzIGNvbW1vbiB0byBhbGwgc3ByaXRlc1xyXG4gICAgdGhpcy5pbnN0YW5jZS5yZWxhdGl2ZVRyYW5zZm9ybS5tYXRyaXguY29weVRvQXJyYXkoIHRoaXMudHJhbnNmb3JtTWF0cml4QXJyYXkgKTtcclxuICAgIGdsLnVuaWZvcm1NYXRyaXgzZnYoIHRoaXMuc2hhZGVyUHJvZ3JhbS51bmlmb3JtTG9jYXRpb25zLnVUcmFuc2Zvcm1NYXRyaXgsIGZhbHNlLCB0aGlzLnRyYW5zZm9ybU1hdHJpeEFycmF5ICk7XHJcblxyXG4gICAgZ2wuYmluZEJ1ZmZlciggZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlciApO1xyXG4gICAgLy8gaWYgd2UgaW5jcmVhc2VkIGluIGxlbmd0aCwgd2UgbmVlZCB0byBkbyBhIGZ1bGwgYnVmZmVyRGF0YSB0byByZXNpemUgaXQgb24gdGhlIEdQVSBzaWRlXHJcbiAgICBpZiAoIGNoYW5nZWRMZW5ndGggKSB7XHJcbiAgICAgIGdsLmJ1ZmZlckRhdGEoIGdsLkFSUkFZX0JVRkZFUiwgdGhpcy52ZXJ0ZXhBcnJheSwgZ2wuRFlOQU1JQ19EUkFXICk7IC8vIGZ1bGx5IGJ1ZmZlciBhdCB0aGUgc3RhcnRcclxuICAgIH1cclxuICAgIC8vIG90aGVyd2lzZSBkbyBhIG1vcmUgZWZmaWNpZW50IHVwZGF0ZSB0aGF0IG9ubHkgc2VuZHMgcGFydCBvZiB0aGUgYXJyYXkgb3ZlclxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGdsLmJ1ZmZlclN1YkRhdGEoIGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy52ZXJ0ZXhBcnJheS5zdWJhcnJheSggMCwgdmVydGV4QXJyYXlJbmRleCApICk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc2l6ZU9mRmxvYXQgPSBGbG9hdDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7XHJcbiAgICBjb25zdCBzdHJpZGUgPSBDT01QT05FTlRTICogc2l6ZU9mRmxvYXQ7XHJcbiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKCB0aGlzLnNoYWRlclByb2dyYW0uYXR0cmlidXRlTG9jYXRpb25zLmFWZXJ0ZXgsIDIsIGdsLkZMT0FULCBmYWxzZSwgc3RyaWRlLCAwICogc2l6ZU9mRmxvYXQgKTtcclxuICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoIHRoaXMuc2hhZGVyUHJvZ3JhbS5hdHRyaWJ1dGVMb2NhdGlvbnMuYVRleHR1cmVDb29yZCwgMiwgZ2wuRkxPQVQsIGZhbHNlLCBzdHJpZGUsIDIgKiBzaXplT2ZGbG9hdCApO1xyXG4gICAgZ2wudmVydGV4QXR0cmliUG9pbnRlciggdGhpcy5zaGFkZXJQcm9ncmFtLmF0dHJpYnV0ZUxvY2F0aW9ucy5hQWxwaGEsIDEsIGdsLkZMT0FULCBmYWxzZSwgc3RyaWRlLCA0ICogc2l6ZU9mRmxvYXQgKTtcclxuXHJcbiAgICBnbC5hY3RpdmVUZXh0dXJlKCBnbC5URVhUVVJFMCApO1xyXG4gICAgZ2wuYmluZFRleHR1cmUoIGdsLlRFWFRVUkVfMkQsIHRoaXMuc3ByaXRlU2hlZXQudGV4dHVyZSApO1xyXG4gICAgZ2wudW5pZm9ybTFpKCB0aGlzLnNoYWRlclByb2dyYW0udW5pZm9ybUxvY2F0aW9ucy51VGV4dHVyZSwgMCApO1xyXG5cclxuICAgIGdsLmRyYXdBcnJheXMoIGdsLlRSSUFOR0xFUywgMCwgdmVydGV4QXJyYXlJbmRleCAvIENPTVBPTkVOVFMgKTtcclxuXHJcbiAgICBnbC5iaW5kVGV4dHVyZSggZ2wuVEVYVFVSRV8yRCwgbnVsbCApO1xyXG5cclxuICAgIHRoaXMuc2hhZGVyUHJvZ3JhbS51bnVzZSgpO1xyXG5cclxuICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvbmF0dXJhbC1zZWxlY3Rpb24vaXNzdWVzLzI0M1xyXG4gICAgaWYgKCAhdGhpcy5oYXNEcmF3biAmJiBwbGF0Zm9ybS5zYWZhcmkgKSB7XHJcbiAgICAgIC8vIFJlZHJhdyBvbmNlIG1vcmUgaWYgd2UncmUgaW4gU2FmYXJpLCBzaW5jZSBpdCdzIHVuZGV0ZXJtaW5lZCB3aHkgYW4gaW5pdGlhbCBkcmF3IGlzbid0IHdvcmtpbmcuXHJcbiAgICAgIC8vIEV2ZXJ5dGhpbmcgc2VlbXMgdG8gb3RoZXJ3aXNlIGJlIGluIHBsYWNlLlxyXG4gICAgICBhbmltYXRpb25GcmFtZVRpbWVyLnNldFRpbWVvdXQoICgpID0+IHRoaXMubWFya0RpcnR5KCksIDAgKTtcclxuICAgIH1cclxuICAgIHRoaXMuaGFzRHJhd24gPSB0cnVlO1xyXG5cclxuICAgIHJldHVybiAxO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGlzcG9zZXMgdGhlIGRyYXdhYmxlLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgdGhpcy5ub2RlLl9zcHJpdGVzLmZvckVhY2goIHNwcml0ZSA9PiB7XHJcbiAgICAgIHNwcml0ZS5pbWFnZVByb3BlcnR5LnVubGluayggdGhpcy5zcHJpdGVDaGFuZ2VMaXN0ZW5lciApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGlmICggdGhpcy53ZWJHTEJsb2NrICkge1xyXG4gICAgICB0aGlzLndlYkdMQmxvY2sgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHN1cGVyXHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBIFwiY2F0Y2gtYWxsXCIgZGlydHkgbWV0aG9kIHRoYXQgZGlyZWN0bHkgbWFya3MgdGhlIHBhaW50RGlydHkgZmxhZyBhbmQgdHJpZ2dlcnMgcHJvcGFnYXRpb24gb2YgZGlydHlcclxuICAgKiBpbmZvcm1hdGlvbi4gVGhpcyBjYW4gYmUgdXNlZCBieSBvdGhlciBtYXJrKiBtZXRob2RzLCBvciBkaXJlY3RseSBpdHNlbGYgaWYgdGhlIHBhaW50RGlydHkgZmxhZyBpcyBjaGVja2VkLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEl0IHNob3VsZCBiZSBmaXJlZCAoaW5kaXJlY3RseSBvciBkaXJlY3RseSkgZm9yIGFueXRoaW5nIGJlc2lkZXMgdHJhbnNmb3JtcyB0aGF0IG5lZWRzIHRvIG1ha2UgYSBkcmF3YWJsZVxyXG4gICAqIGRpcnR5LlxyXG4gICAqL1xyXG4gIG1hcmtQYWludERpcnR5KCkge1xyXG4gICAgdGhpcy5tYXJrRGlydHkoKTtcclxuICB9XHJcbn1cclxuXHJcbi8vIFdlIHVzZSBhIGN1c3RvbSByZW5kZXJlciBmb3IgdGhlIG5lZWRlZCBmbGV4aWJpbGl0eVxyXG5TcHJpdGVzV2ViR0xEcmF3YWJsZS5wcm90b3R5cGUud2ViZ2xSZW5kZXJlciA9IFJlbmRlcmVyLndlYmdsQ3VzdG9tO1xyXG5cclxuc2NlbmVyeS5yZWdpc3RlciggJ1Nwcml0ZXNXZWJHTERyYXdhYmxlJywgU3ByaXRlc1dlYkdMRHJhd2FibGUgKTtcclxuXHJcblBvb2xhYmxlLm1peEludG8oIFNwcml0ZXNXZWJHTERyYXdhYmxlICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBTcHJpdGVzV2ViR0xEcmF3YWJsZTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsbUJBQW1CLE1BQU0sNENBQTRDO0FBQzVFLE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsUUFBUSxNQUFNLHNDQUFzQztBQUMzRCxPQUFPQyxRQUFRLE1BQU0sc0NBQXNDO0FBQzNELFNBQVNDLFFBQVEsRUFBRUMsT0FBTyxFQUFFQyxhQUFhLEVBQUVDLFdBQVcsRUFBRUMsaUJBQWlCLFFBQVEsa0JBQWtCOztBQUVuRztBQUNBLE1BQU1DLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUN0QixNQUFNQyxjQUFjLEdBQUdELFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQzs7QUFFdkM7QUFDQSxNQUFNRSxTQUFTLEdBQUcsSUFBSVYsT0FB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