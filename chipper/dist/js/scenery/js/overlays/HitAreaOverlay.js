// Copyright 2019-2024, University of Colorado Boulder

/**
 * Displays the "hittable" mouse/touch regions for items with input listeners.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import { Shape } from '../../../kite/js/imports.js';
import { scenery, ShapeBasedOverlay, Trail } from '../imports.js';
export default class HitAreaOverlay extends ShapeBasedOverlay {
  constructor(display, rootNode) {
    super(display, rootNode, 'hitAreaOverlay');
  }
  addShapes() {
    new Trail(this.rootNode).eachTrailUnder(trail => {
      const node = trail.lastNode();
      if (!node.isVisible() || node.pickable === false) {
        // skip this subtree if the node is invisible
        return true;
      }
      if (node.inputListeners.length && trail.isVisible()) {
        const mouseShape = HitAreaOverlay.getLocalMouseShape(node);
        const touchShape = HitAreaOverlay.getLocalTouchShape(node);
        const matrix = trail.getMatrix();
        if (!mouseShape.bounds.isEmpty()) {
          this.addShape(mouseShape.transformed(matrix), 'rgba(0,0,255,0.8)', true);
        }
        if (!touchShape.bounds.isEmpty()) {
          this.addShape(touchShape.transformed(matrix), 'rgba(255,0,0,0.8)', false);
        }
      }
      return false;
    });
  }
  static getLocalMouseShape(node) {
    let shape = Shape.union([node.mouseArea ? node.mouseArea instanceof Shape ? node.mouseArea : Shape.bounds(node.mouseArea) : node.getSelfShape(), ...node.children.filter(child => {
      return node.visible && node.pickable !== false;
    }).map(child => {
      return HitAreaOverlay.getLocalMouseShape(child).transformed(child.matrix);
    })]);
    if (node.hasClipArea()) {
      shape = shape.shapeIntersection(node.clipArea);
    }
    return shape;
  }
  static getLocalTouchShape(node) {
    let shape = Shape.union([node.touchArea ? node.touchArea instanceof Shape ? node.touchArea : Shape.bounds(node.touchArea) : node.getSelfShape(), ...node.children.filter(child => {
      return node.visible && node.pickable !== false;
    }).map(child => {
      return HitAreaOverlay.getLocalTouchShape(child).transformed(child.matrix);
    })]);
    if (node.hasClipArea()) {
      shape = shape.shapeIntersection(node.clipArea);
    }
    return shape;
  }
}
scenery.register('HitAreaOverlay', HitAreaOverlay);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTaGFwZSIsInNjZW5lcnkiLCJTaGFwZUJhc2VkT3ZlcmxheSIsIlRyYWlsIiwiSGl0QXJlYU92ZXJsYXkiLCJjb25zdHJ1Y3RvciIsImRpc3BsYXkiLCJyb290Tm9kZSIsImFkZFNoYXBlcyIsImVhY2hUcmFpbFVuZGVyIiwidHJhaWwiLCJub2RlIiwibGFzdE5vZGUiLCJpc1Zpc2libGUiLCJwaWNrYWJsZSIsImlucHV0TGlzdGVuZXJzIiwibGVuZ3RoIiwibW91c2VTaGFwZSIsImdldExvY2FsTW91c2VTaGFwZSIsInRvdWNoU2hhcGUiLCJnZXRMb2NhbFRvdWNoU2hhcGUiLCJtYXRyaXgiLCJnZXRNYXRyaXgiLCJib3VuZHMiLCJpc0VtcHR5IiwiYWRkU2hhcGUiLCJ0cmFuc2Zvcm1lZCIsInNoYXBlIiwidW5pb24iLCJtb3VzZUFyZWEiLCJnZXRTZWxmU2hhcGUiLCJjaGlsZHJlbiIsImZpbHRlciIsImNoaWxkIiwidmlzaWJsZSIsIm1hcCIsImhhc0NsaXBBcmVhIiwic2hhcGVJbnRlcnNlY3Rpb24iLCJjbGlwQXJlYSIsInRvdWNoQXJlYSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiSGl0QXJlYU92ZXJsYXkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyNCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRGlzcGxheXMgdGhlIFwiaGl0dGFibGVcIiBtb3VzZS90b3VjaCByZWdpb25zIGZvciBpdGVtcyB3aXRoIGlucHV0IGxpc3RlbmVycy5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHsgRGlzcGxheSwgTm9kZSwgc2NlbmVyeSwgU2hhcGVCYXNlZE92ZXJsYXksIFRPdmVybGF5LCBUcmFpbCB9IGZyb20gJy4uL2ltcG9ydHMuanMnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGl0QXJlYU92ZXJsYXkgZXh0ZW5kcyBTaGFwZUJhc2VkT3ZlcmxheSBpbXBsZW1lbnRzIFRPdmVybGF5IHtcclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGRpc3BsYXk6IERpc3BsYXksIHJvb3ROb2RlOiBOb2RlICkge1xyXG4gICAgc3VwZXIoIGRpc3BsYXksIHJvb3ROb2RlLCAnaGl0QXJlYU92ZXJsYXknICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYWRkU2hhcGVzKCk6IHZvaWQge1xyXG4gICAgbmV3IFRyYWlsKCB0aGlzLnJvb3ROb2RlICkuZWFjaFRyYWlsVW5kZXIoIHRyYWlsID0+IHtcclxuICAgICAgY29uc3Qgbm9kZSA9IHRyYWlsLmxhc3ROb2RlKCk7XHJcblxyXG4gICAgICBpZiAoICFub2RlLmlzVmlzaWJsZSgpIHx8IG5vZGUucGlja2FibGUgPT09IGZhbHNlICkge1xyXG4gICAgICAgIC8vIHNraXAgdGhpcyBzdWJ0cmVlIGlmIHRoZSBub2RlIGlzIGludmlzaWJsZVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIG5vZGUuaW5wdXRMaXN0ZW5lcnMubGVuZ3RoICYmIHRyYWlsLmlzVmlzaWJsZSgpICkge1xyXG4gICAgICAgIGNvbnN0IG1vdXNlU2hhcGUgPSBIaXRBcmVhT3ZlcmxheS5nZXRMb2NhbE1vdXNlU2hhcGUoIG5vZGUgKTtcclxuICAgICAgICBjb25zdCB0b3VjaFNoYXBlID0gSGl0QXJlYU92ZXJsYXkuZ2V0TG9jYWxUb3VjaFNoYXBlKCBub2RlICk7XHJcbiAgICAgICAgY29uc3QgbWF0cml4ID0gdHJhaWwuZ2V0TWF0cml4KCk7XHJcblxyXG4gICAgICAgIGlmICggIW1vdXNlU2hhcGUuYm91bmRzLmlzRW1wdHkoKSApIHtcclxuICAgICAgICAgIHRoaXMuYWRkU2hhcGUoIG1vdXNlU2hhcGUudHJhbnNmb3JtZWQoIG1hdHJpeCApLCAncmdiYSgwLDAsMjU1LDAuOCknLCB0cnVlICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICggIXRvdWNoU2hhcGUuYm91bmRzLmlzRW1wdHkoKSApIHtcclxuICAgICAgICAgIHRoaXMuYWRkU2hhcGUoIHRvdWNoU2hhcGUudHJhbnNmb3JtZWQoIG1hdHJpeCApLCAncmdiYSgyNTUsMCwwLDAuOCknLCBmYWxzZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0TG9jYWxNb3VzZVNoYXBlKCBub2RlOiBOb2RlICk6IFNoYXBlIHtcclxuICAgIGxldCBzaGFwZSA9IFNoYXBlLnVuaW9uKCBbXHJcbiAgICAgIG5vZGUubW91c2VBcmVhID8gKCBub2RlLm1vdXNlQXJlYSBpbnN0YW5jZW9mIFNoYXBlID8gbm9kZS5tb3VzZUFyZWEgOiBTaGFwZS5ib3VuZHMoIG5vZGUubW91c2VBcmVhICkgKSA6IG5vZGUuZ2V0U2VsZlNoYXBlKCksXHJcbiAgICAgIC4uLm5vZGUuY2hpbGRyZW4uZmlsdGVyKCAoIGNoaWxkOiBOb2RlICkgPT4ge1xyXG4gICAgICAgIHJldHVybiBub2RlLnZpc2libGUgJiYgbm9kZS5waWNrYWJsZSAhPT0gZmFsc2U7XHJcbiAgICAgIH0gKS5tYXAoIGNoaWxkID0+IHtcclxuICAgICAgICByZXR1cm4gSGl0QXJlYU92ZXJsYXkuZ2V0TG9jYWxNb3VzZVNoYXBlKCBjaGlsZCApLnRyYW5zZm9ybWVkKCBjaGlsZC5tYXRyaXggKTtcclxuICAgICAgfSApXHJcbiAgICBdICk7XHJcbiAgICBpZiAoIG5vZGUuaGFzQ2xpcEFyZWEoKSApIHtcclxuICAgICAgc2hhcGUgPSBzaGFwZS5zaGFwZUludGVyc2VjdGlvbiggbm9kZS5jbGlwQXJlYSEgKTtcclxuICAgIH1cclxuICAgIHJldHVybiBzaGFwZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc3RhdGljIGdldExvY2FsVG91Y2hTaGFwZSggbm9kZTogTm9kZSApOiBTaGFwZSB7XHJcbiAgICBsZXQgc2hhcGUgPSBTaGFwZS51bmlvbiggW1xyXG4gICAgICBub2RlLnRvdWNoQXJlYSA/ICggbm9kZS50b3VjaEFyZWEgaW5zdGFuY2VvZiBTaGFwZSA/IG5vZGUudG91Y2hBcmVhIDogU2hhcGUuYm91bmRzKCBub2RlLnRvdWNoQXJlYSApICkgOiBub2RlLmdldFNlbGZTaGFwZSgpLFxyXG4gICAgICAuLi5ub2RlLmNoaWxkcmVuLmZpbHRlciggKCBjaGlsZDogTm9kZSApID0+IHtcclxuICAgICAgICByZXR1cm4gbm9kZS52aXNpYmxlICYmIG5vZGUucGlja2FibGUgIT09IGZhbHNlO1xyXG4gICAgICB9ICkubWFwKCBjaGlsZCA9PiB7XHJcbiAgICAgICAgcmV0dXJuIEhpdEFyZWFPdmVybGF5LmdldExvY2FsVG91Y2hTaGFwZSggY2hpbGQgKS50cmFuc2Zvcm1lZCggY2hpbGQubWF0cml4ICk7XHJcbiAgICAgIH0gKVxyXG4gICAgXSApO1xyXG4gICAgaWYgKCBub2RlLmhhc0NsaXBBcmVhKCkgKSB7XHJcbiAgICAgIHNoYXBlID0gc2hhcGUuc2hhcGVJbnRlcnNlY3Rpb24oIG5vZGUuY2xpcEFyZWEhICk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc2hhcGU7XHJcbiAgfVxyXG59XHJcblxyXG5zY2VuZXJ5LnJlZ2lzdGVyKCAnSGl0QXJlYU92ZXJsYXknLCBIaXRBcmVhT3ZlcmxheSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxTQUFTQSxLQUFLLFFBQVEsNkJBQTZCO0FBQ25ELFNBQXdCQyxPQUFPLEVBQUVDLGlCQUFpQixFQUFZQyxLQUFLLFFBQVEsZUFBZTtBQUUxRixlQUFlLE1BQU1DLGNBQWMsU0FBU0YsaUJBQWlCLENBQXFCO0VBQ3pFRyxXQUFXQSxDQUFFQyxPQUFnQixFQUFFQyxRQUFjLEVB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