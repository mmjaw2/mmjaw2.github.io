// Copyright 2013-2024, University of Colorado Boulder

/**
 * Reset All button, typically used to reset everything ('reset all') on a Screen.
 * Extends ResetButton, adding things that are specific to 'reset all'.
 *
 * @author John Blanco (PhET Interactive Simulations)
 * @author Chris Malley (PixelZoom, Inc.)
 */

import { KeyboardListener, voicingUtteranceQueue } from '../../../scenery/js/imports.js';
import resetAllSoundPlayer from '../../../tambo/js/shared-sound-players/resetAllSoundPlayer.js';
import optionize from '../../../phet-core/js/optionize.js';
import Tandem from '../../../tandem/js/Tandem.js';
import ActivationUtterance from '../../../utterance-queue/js/ActivationUtterance.js';
import PhetColorScheme from '../PhetColorScheme.js';
import sceneryPhet from '../sceneryPhet.js';
import SceneryPhetConstants from '../SceneryPhetConstants.js';
import SceneryPhetStrings from '../SceneryPhetStrings.js';
import ResetButton from './ResetButton.js';
import TinyProperty from '../../../axon/js/TinyProperty.js';
const MARGIN_COEFFICIENT = 5 / SceneryPhetConstants.DEFAULT_BUTTON_RADIUS;
const isResettingAllProperty = new TinyProperty(false);
export default class ResetAllButton extends ResetButton {
  constructor(providedOptions) {
    const options = optionize()({
      // ResetAllButtonOptions
      radius: SceneryPhetConstants.DEFAULT_BUTTON_RADIUS,
      // {boolean} - option specific to ResetAllButton. If true, then the reset all button will reset back to the
      // previous PhET-iO state, if applicable.
      phetioRestoreScreenStateOnReset: true,
      // Fine tuned in https://github.com/phetsims/tasks/issues/985 and should not be overridden lightly.
      touchAreaDilation: 5.2,
      baseColor: PhetColorScheme.RESET_ALL_BUTTON_BASE_COLOR,
      arrowColor: 'white',
      // phet-io
      tandem: Tandem.REQUIRED,
      tandemNameSuffix: 'ResetAllButton',
      phetioDocumentation: 'The orange, round button that can be used to restore the initial state',
      // sound generation
      soundPlayer: resetAllSoundPlayer,
      // pdom
      innerContent: SceneryPhetStrings.a11y.resetAll.labelStringProperty,
      // voicing
      voicingNameResponse: SceneryPhetStrings.a11y.resetAll.labelStringProperty,
      voicingContextResponse: SceneryPhetStrings.a11y.voicing.resetAll.contextResponseStringProperty
    }, providedOptions);
    assert && assert(options.xMargin === undefined && options.yMargin === undefined, 'resetAllButton sets margins');
    options.xMargin = options.yMargin = options.radius * MARGIN_COEFFICIENT;
    super(options);

    // a11y - When reset all button is fired, disable alerts so that there isn't an excessive stream of alerts while
    // many Properties are reset. When callbacks are ended for reset all, enable alerts again and announce an alert that
    // everything was reset.
    const resetUtterance = new ActivationUtterance({
      alert: SceneryPhetStrings.a11y.resetAll.alertStringProperty
    });
    let voicingEnabledOnFire = voicingUtteranceQueue.enabled;
    const ariaEnabledOnFirePerUtteranceQueueMap = new Map(); // Keep track of the enabled of each connected description UtteranceQueue
    this.pushButtonModel.isFiringProperty.lazyLink(isFiring => {
      // Handle voicingUtteranceQueue.
      if (isFiring) {
        voicingEnabledOnFire = voicingUtteranceQueue.enabled;
        voicingUtteranceQueue.enabled = false;
        voicingUtteranceQueue.clear();
      } else {
        // Every ResetAllButton has the option to reset to the last PhET-iO state if desired.
        if (Tandem.PHET_IO_ENABLED && options.phetioRestoreScreenStateOnReset &&
        // Even though this is Tandem.REQUIRED, still be graceful if not yet instrumented.
        this.isPhetioInstrumented()) {
          phet.phetio.phetioEngine.phetioStateEngine.restoreStateForScreen(options.tandem);
        }

        // Restore the enabled state to each utteranceQueue after resetting.
        voicingUtteranceQueue.enabled = voicingEnabledOnFire;
        this.voicingSpeakFullResponse();
      }

      // Handle each connected description UtteranceQueue.
      this.forEachUtteranceQueue(utteranceQueue => {
        if (isFiring) {
          // Mute and clear the utteranceQueue.
          ariaEnabledOnFirePerUtteranceQueueMap.set(utteranceQueue, utteranceQueue.enabled);
          utteranceQueue.enabled = false;
          utteranceQueue.clear();
        } else {
          utteranceQueue.enabled = ariaEnabledOnFirePerUtteranceQueueMap.get(utteranceQueue) || utteranceQueue.enabled;
          utteranceQueue.addToBack(resetUtterance);
        }
      });
    });
    const keyboardListener = KeyboardListener.createGlobal(this, {
      keys: ['alt+r'],
      fire: () => this.pdomClick(),
      // fires on up because the listener will often call interruptSubtreeInput (interrupting this keyboard listener)
      fireOnDown: false
    });

    // Add a listener that will set and clear the static flag that signals when a reset all is in progress.
    const flagSettingListener = isFiring => {
      isResettingAllProperty.value = isFiring;
    };
    this.pushButtonModel.isFiringProperty.lazyLink(flagSettingListener);
    this.disposeResetAllButton = () => {
      keyboardListener.dispose();
      ariaEnabledOnFirePerUtteranceQueueMap.clear();
      this.pushButtonModel.isFiringProperty.unlink(flagSettingListener);
    };
  }
  dispose() {
    this.disposeResetAllButton();
    super.dispose();
  }

  // A flag that is true whenever any "reset all" is in progress.  This is often useful for muting sounds that shouldn't
  // be triggered by model value changes that occur due to a reset.
  static isResettingAllProperty = isResettingAllProperty;
}
sceneryPhet.register('ResetAllButton', ResetAllButton);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJLZXlib2FyZExpc3RlbmVyIiwidm9pY2luZ1V0dGVyYW5jZVF1ZXVlIiwicmVzZXRBbGxTb3VuZFBsYXllciIsIm9wdGlvbml6ZSIsIlRhbmRlbSIsIkFjdGl2YXRpb25VdHRlcmFuY2UiLCJQaGV0Q29sb3JTY2hlbWUiLCJzY2VuZXJ5UGhldCIsIlNjZW5lcnlQaGV0Q29uc3RhbnRzIiwiU2NlbmVyeVBoZXRTdHJpbmdzIiwiUmVzZXRCdXR0b24iLCJUaW55UHJvcGVydHkiLCJNQVJHSU5fQ09FRkZJQ0lFTlQiLCJERUZBVUxUX0JVVFRPTl9SQURJVVMiLCJpc1Jlc2V0dGluZ0FsbFByb3BlcnR5IiwiUmVzZXRBbGxCdXR0b24iLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJyYWRpdXMiLCJwaGV0aW9SZXN0b3JlU2NyZWVuU3RhdGVPblJlc2V0IiwidG91Y2hBcmVhRGlsYXRpb24iLCJiYXNlQ29sb3IiLCJSRVNFVF9BTExfQlVUVE9OX0JBU0VfQ09MT1IiLCJhcnJvd0NvbG9yIiwidGFuZGVtIiwiUkVRVUlSRUQiLCJ0YW5kZW1OYW1lU3VmZml4IiwicGhldGlvRG9jdW1lbnRhdGlvbiIsInNvdW5kUGxheWVyIiwiaW5uZXJDb250ZW50IiwiYTExeSIsInJlc2V0QWxsIiwibGFiZWxTdHJpbmdQcm9wZXJ0eSIsInZvaWNpbmdOYW1lUmVzcG9uc2UiLCJ2b2ljaW5nQ29udGV4dFJlc3BvbnNlIiwidm9pY2luZyIsImNvbnRleHRSZXNwb25zZVN0cmluZ1Byb3BlcnR5IiwiYXNzZXJ0IiwieE1hcmdpbiIsInVuZGVmaW5lZCIsInlNYXJnaW4iLCJyZXNldFV0dGVyYW5jZSIsImFsZXJ0IiwiYWxlcnRTdHJpbmdQcm9wZXJ0eSIsInZvaWNpbmdFbmFibGVkT25GaXJlIiwiZW5hYmxlZCIsImFyaWFFbmFibGVkT25GaXJlUGVyVXR0ZXJhbmNlUXVldWVNYXAiLCJNYXAiLCJwdXNoQnV0dG9uTW9kZWwiLCJpc0ZpcmluZ1Byb3BlcnR5IiwibGF6eUxpbmsiLCJpc0ZpcmluZyIsImNsZWFyIiwiUEhFVF9JT19FTkFCTEVEIiwiaXNQaGV0aW9JbnN0cnVtZW50ZWQiLCJwaGV0IiwicGhldGlvIiwicGhldGlvRW5naW5lIiwicGhldGlvU3RhdGVFbmdpbmUiLCJyZXN0b3JlU3RhdGVGb3JTY3JlZW4iLCJ2b2ljaW5nU3BlYWtGdWxsUmVzcG9uc2UiLCJmb3JFYWNoVXR0ZXJhbmNlUXVldWUiLCJ1dHRlcmFuY2VRdWV1ZSIsInNldCIsImdldCIsImFkZFRvQmFjayIsImtleWJvYXJkTGlzdGVuZXIiLCJjcmVhdGVHbG9iYWwiLCJrZXlzIiwiZmlyZSIsInBkb21DbGljayIsImZpcmVPbkRvd24iLCJmbGFnU2V0dGluZ0xpc3RlbmVyIiwidmFsdWUiLCJkaXNwb3NlUmVzZXRBbGxCdXR0b24iLCJkaXNwb3NlIiwidW5saW5rIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJSZXNldEFsbEJ1dHRvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxMy0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBSZXNldCBBbGwgYnV0dG9uLCB0eXBpY2FsbHkgdXNlZCB0byByZXNldCBldmVyeXRoaW5nICgncmVzZXQgYWxsJykgb24gYSBTY3JlZW4uXHJcbiAqIEV4dGVuZHMgUmVzZXRCdXR0b24sIGFkZGluZyB0aGluZ3MgdGhhdCBhcmUgc3BlY2lmaWMgdG8gJ3Jlc2V0IGFsbCcuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY28gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgS2V5Ym9hcmRMaXN0ZW5lciwgdm9pY2luZ1V0dGVyYW5jZVF1ZXVlIH0gZnJvbSAnLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgcmVzZXRBbGxTb3VuZFBsYXllciBmcm9tICcuLi8uLi8uLi90YW1iby9qcy9zaGFyZWQtc291bmQtcGxheWVycy9yZXNldEFsbFNvdW5kUGxheWVyLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IEFjdGl2YXRpb25VdHRlcmFuY2UgZnJvbSAnLi4vLi4vLi4vdXR0ZXJhbmNlLXF1ZXVlL2pzL0FjdGl2YXRpb25VdHRlcmFuY2UuanMnO1xyXG5pbXBvcnQgUGhldENvbG9yU2NoZW1lIGZyb20gJy4uL1BoZXRDb2xvclNjaGVtZS5qcyc7XHJcbmltcG9ydCBzY2VuZXJ5UGhldCBmcm9tICcuLi9zY2VuZXJ5UGhldC5qcyc7XHJcbmltcG9ydCBTY2VuZXJ5UGhldENvbnN0YW50cyBmcm9tICcuLi9TY2VuZXJ5UGhldENvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBTY2VuZXJ5UGhldFN0cmluZ3MgZnJvbSAnLi4vU2NlbmVyeVBoZXRTdHJpbmdzLmpzJztcclxuaW1wb3J0IFJlc2V0QnV0dG9uLCB7IFJlc2V0QnV0dG9uT3B0aW9ucyB9IGZyb20gJy4vUmVzZXRCdXR0b24uanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUaW55UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9UaW55UHJvcGVydHkuanMnO1xyXG5cclxuY29uc3QgTUFSR0lOX0NPRUZGSUNJRU5UID0gNSAvIFNjZW5lcnlQaGV0Q29uc3RhbnRzLkRFRkFVTFRfQlVUVE9OX1JBRElVUztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcbiAgcGhldGlvUmVzdG9yZVNjcmVlblN0YXRlT25SZXNldD86IGJvb2xlYW47XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBSZXNldEFsbEJ1dHRvbk9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFN0cmljdE9taXQ8UmVzZXRCdXR0b25PcHRpb25zLCAneE1hcmdpbicgfCAneU1hcmdpbic+O1xyXG5cclxuY29uc3QgaXNSZXNldHRpbmdBbGxQcm9wZXJ0eSA9IG5ldyBUaW55UHJvcGVydHkoIGZhbHNlICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXNldEFsbEJ1dHRvbiBleHRlbmRzIFJlc2V0QnV0dG9uIHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBkaXNwb3NlUmVzZXRBbGxCdXR0b246ICgpID0+IHZvaWQ7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcHJvdmlkZWRPcHRpb25zPzogUmVzZXRBbGxCdXR0b25PcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8UmVzZXRBbGxCdXR0b25PcHRpb25zLCBTZWxmT3B0aW9ucywgUmVzZXRCdXR0b25PcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBSZXNldEFsbEJ1dHRvbk9wdGlvbnNcclxuICAgICAgcmFkaXVzOiBTY2VuZXJ5UGhldENvbnN0YW50cy5ERUZBVUxUX0JVVFRPTl9SQURJVVMsXHJcblxyXG4gICAgICAvLyB7Ym9vbGVhbn0gLSBvcHRpb24gc3BlY2lmaWMgdG8gUmVzZXRBbGxCdXR0b24uIElmIHRydWUsIHRoZW4gdGhlIHJlc2V0IGFsbCBidXR0b24gd2lsbCByZXNldCBiYWNrIHRvIHRoZVxyXG4gICAgICAvLyBwcmV2aW91cyBQaEVULWlPIHN0YXRlLCBpZiBhcHBsaWNhYmxlLlxyXG4gICAgICBwaGV0aW9SZXN0b3JlU2NyZWVuU3RhdGVPblJlc2V0OiB0cnVlLFxyXG5cclxuICAgICAgLy8gRmluZSB0dW5lZCBpbiBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvdGFza3MvaXNzdWVzLzk4NSBhbmQgc2hvdWxkIG5vdCBiZSBvdmVycmlkZGVuIGxpZ2h0bHkuXHJcbiAgICAgIHRvdWNoQXJlYURpbGF0aW9uOiA1LjIsXHJcbiAgICAgIGJhc2VDb2xvcjogUGhldENvbG9yU2NoZW1lLlJFU0VUX0FMTF9CVVRUT05fQkFTRV9DT0xPUixcclxuICAgICAgYXJyb3dDb2xvcjogJ3doaXRlJyxcclxuXHJcbiAgICAgIC8vIHBoZXQtaW9cclxuICAgICAgdGFuZGVtOiBUYW5kZW0uUkVRVUlSRUQsXHJcbiAgICAgIHRhbmRlbU5hbWVTdWZmaXg6ICdSZXNldEFsbEJ1dHRvbicsXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdUaGUgb3JhbmdlLCByb3VuZCBidXR0b24gdGhhdCBjYW4gYmUgdXNlZCB0byByZXN0b3JlIHRoZSBpbml0aWFsIHN0YXRlJyxcclxuXHJcbiAgICAgIC8vIHNvdW5kIGdlbmVyYXRpb25cclxuICAgICAgc291bmRQbGF5ZXI6IHJlc2V0QWxsU291bmRQbGF5ZXIsXHJcblxyXG4gICAgICAvLyBwZG9tXHJcbiAgICAgIGlubmVyQ29udGVudDogU2NlbmVyeVBoZXRTdHJpbmdzLmExMXkucmVzZXRBbGwubGFiZWxTdHJpbmdQcm9wZXJ0eSxcclxuXHJcbiAgICAgIC8vIHZvaWNpbmdcclxuICAgICAgdm9pY2luZ05hbWVSZXNwb25zZTogU2NlbmVyeVBoZXRTdHJpbmdzLmExMXkucmVzZXRBbGwubGFiZWxTdHJpbmdQcm9wZXJ0eSxcclxuICAgICAgdm9pY2luZ0NvbnRleHRSZXNwb25zZTogU2NlbmVyeVBoZXRTdHJpbmdzLmExMXkudm9pY2luZy5yZXNldEFsbC5jb250ZXh0UmVzcG9uc2VTdHJpbmdQcm9wZXJ0eVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggb3B0aW9ucy54TWFyZ2luID09PSB1bmRlZmluZWQgJiYgb3B0aW9ucy55TWFyZ2luID09PSB1bmRlZmluZWQsICdyZXNldEFsbEJ1dHRvbiBzZXRzIG1hcmdpbnMnICk7XHJcbiAgICBvcHRpb25zLnhNYXJnaW4gPSBvcHRpb25zLnlNYXJnaW4gPSBvcHRpb25zLnJhZGl1cyAqIE1BUkdJTl9DT0VGRklDSUVOVDtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIGExMXkgLSBXaGVuIHJlc2V0IGFsbCBidXR0b24gaXMgZmlyZWQsIGRpc2FibGUgYWxlcnRzIHNvIHRoYXQgdGhlcmUgaXNuJ3QgYW4gZXhjZXNzaXZlIHN0cmVhbSBvZiBhbGVydHMgd2hpbGVcclxuICAgIC8vIG1hbnkgUHJvcGVydGllcyBhcmUgcmVzZXQuIFdoZW4gY2FsbGJhY2tzIGFyZSBlbmRlZCBmb3IgcmVzZXQgYWxsLCBlbmFibGUgYWxlcnRzIGFnYWluIGFuZCBhbm5vdW5jZSBhbiBhbGVydCB0aGF0XHJcbiAgICAvLyBldmVyeXRoaW5nIHdhcyByZXNldC5cclxuICAgIGNvbnN0IHJlc2V0VXR0ZXJhbmNlID0gbmV3IEFjdGl2YXRpb25VdHRlcmFuY2UoIHsgYWxlcnQ6IFNjZW5lcnlQaGV0U3RyaW5ncy5hMTF5LnJlc2V0QWxsLmFsZXJ0U3RyaW5nUHJvcGVydHkgfSApO1xyXG4gICAgbGV0IHZvaWNpbmdFbmFibGVkT25GaXJlID0gdm9pY2luZ1V0dGVyYW5jZVF1ZXVlLmVuYWJsZWQ7XHJcbiAgICBjb25zdCBhcmlhRW5hYmxlZE9uRmlyZVBlclV0dGVyYW5jZVF1ZXVlTWFwID0gbmV3IE1hcCgpOyAvLyBLZWVwIHRyYWNrIG9mIHRoZSBlbmFibGVkIG9mIGVhY2ggY29ubmVjdGVkIGRlc2NyaXB0aW9uIFV0dGVyYW5jZVF1ZXVlXHJcbiAgICB0aGlzLnB1c2hCdXR0b25Nb2RlbC5pc0ZpcmluZ1Byb3BlcnR5LmxhenlMaW5rKCAoIGlzRmlyaW5nOiBib29sZWFuICkgPT4ge1xyXG5cclxuICAgICAgLy8gSGFuZGxlIHZvaWNpbmdVdHRlcmFuY2VRdWV1ZS5cclxuICAgICAgaWYgKCBpc0ZpcmluZyApIHtcclxuICAgICAgICB2b2ljaW5nRW5hYmxlZE9uRmlyZSA9IHZvaWNpbmdVdHRlcmFuY2VRdWV1ZS5lbmFibGVkO1xyXG4gICAgICAgIHZvaWNpbmdVdHRlcmFuY2VRdWV1ZS5lbmFibGVkID0gZmFsc2U7XHJcbiAgICAgICAgdm9pY2luZ1V0dGVyYW5jZVF1ZXVlLmNsZWFyKCk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcblxyXG4gICAgICAgIC8vIEV2ZXJ5IFJlc2V0QWxsQnV0dG9uIGhhcyB0aGUgb3B0aW9uIHRvIHJlc2V0IHRvIHRoZSBsYXN0IFBoRVQtaU8gc3RhdGUgaWYgZGVzaXJlZC5cclxuICAgICAgICBpZiAoIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgJiYgb3B0aW9ucy5waGV0aW9SZXN0b3JlU2NyZWVuU3RhdGVPblJlc2V0ICYmXHJcblxyXG4gICAgICAgICAgICAgLy8gRXZlbiB0aG91Z2ggdGhpcyBpcyBUYW5kZW0uUkVRVUlSRUQsIHN0aWxsIGJlIGdyYWNlZnVsIGlmIG5vdCB5ZXQgaW5zdHJ1bWVudGVkLlxyXG4gICAgICAgICAgICAgdGhpcy5pc1BoZXRpb0luc3RydW1lbnRlZCgpICkge1xyXG4gICAgICAgICAgcGhldC5waGV0aW8ucGhldGlvRW5naW5lLnBoZXRpb1N0YXRlRW5naW5lLnJlc3RvcmVTdGF0ZUZvclNjcmVlbiggb3B0aW9ucy50YW5kZW0gKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFJlc3RvcmUgdGhlIGVuYWJsZWQgc3RhdGUgdG8gZWFjaCB1dHRlcmFuY2VRdWV1ZSBhZnRlciByZXNldHRpbmcuXHJcbiAgICAgICAgdm9pY2luZ1V0dGVyYW5jZVF1ZXVlLmVuYWJsZWQgPSB2b2ljaW5nRW5hYmxlZE9uRmlyZTtcclxuICAgICAgICB0aGlzLnZvaWNpbmdTcGVha0Z1bGxSZXNwb25zZSgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBIYW5kbGUgZWFjaCBjb25uZWN0ZWQgZGVzY3JpcHRpb24gVXR0ZXJhbmNlUXVldWUuXHJcbiAgICAgIHRoaXMuZm9yRWFjaFV0dGVyYW5jZVF1ZXVlKCB1dHRlcmFuY2VRdWV1ZSA9PiB7XHJcblxyXG4gICAgICAgIGlmICggaXNGaXJpbmcgKSB7XHJcblxyXG4gICAgICAgICAgLy8gTXV0ZSBhbmQgY2xlYXIgdGhlIHV0dGVyYW5jZVF1ZXVlLlxyXG4gICAgICAgICAgYXJpYUVuYWJsZWRPbkZpcmVQZXJVdHRlcmFuY2VRdWV1ZU1hcC5zZXQoIHV0dGVyYW5jZVF1ZXVlLCB1dHRlcmFuY2VRdWV1ZS5lbmFibGVkICk7XHJcbiAgICAgICAgICB1dHRlcmFuY2VRdWV1ZS5lbmFibGVkID0gZmFsc2U7XHJcbiAgICAgICAgICB1dHRlcmFuY2VRdWV1ZS5jbGVhcigpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIHV0dGVyYW5jZVF1ZXVlLmVuYWJsZWQgPSBhcmlhRW5hYmxlZE9uRmlyZVBlclV0dGVyYW5jZVF1ZXVlTWFwLmdldCggdXR0ZXJhbmNlUXVldWUgKSB8fCB1dHRlcmFuY2VRdWV1ZS5lbmFibGVkO1xyXG4gICAgICAgICAgdXR0ZXJhbmNlUXVldWUuYWRkVG9CYWNrKCByZXNldFV0dGVyYW5jZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGtleWJvYXJkTGlzdGVuZXIgPSBLZXlib2FyZExpc3RlbmVyLmNyZWF0ZUdsb2JhbCggdGhpcywge1xyXG4gICAgICBrZXlzOiBbICdhbHQrcicgXSxcclxuICAgICAgZmlyZTogKCkgPT4gdGhpcy5wZG9tQ2xpY2soKSxcclxuXHJcbiAgICAgIC8vIGZpcmVzIG9uIHVwIGJlY2F1c2UgdGhlIGxpc3RlbmVyIHdpbGwgb2Z0ZW4gY2FsbCBpbnRlcnJ1cHRTdWJ0cmVlSW5wdXQgKGludGVycnVwdGluZyB0aGlzIGtleWJvYXJkIGxpc3RlbmVyKVxyXG4gICAgICBmaXJlT25Eb3duOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEFkZCBhIGxpc3RlbmVyIHRoYXQgd2lsbCBzZXQgYW5kIGNsZWFyIHRoZSBzdGF0aWMgZmxhZyB0aGF0IHNpZ25hbHMgd2hlbiBhIHJlc2V0IGFsbCBpcyBpbiBwcm9ncmVzcy5cclxuICAgIGNvbnN0IGZsYWdTZXR0aW5nTGlzdGVuZXIgPSAoIGlzRmlyaW5nIDogYm9vbGVhbiApID0+IHtcclxuICAgICAgaXNSZXNldHRpbmdBbGxQcm9wZXJ0eS52YWx1ZSA9IGlzRmlyaW5nO1xyXG4gICAgfTtcclxuICAgIHRoaXMucHVzaEJ1dHRvbk1vZGVsLmlzRmlyaW5nUHJvcGVydHkubGF6eUxpbmsoIGZsYWdTZXR0aW5nTGlzdGVuZXIgKTtcclxuXHJcbiAgICB0aGlzLmRpc3Bvc2VSZXNldEFsbEJ1dHRvbiA9ICgpID0+IHtcclxuICAgICAga2V5Ym9hcmRMaXN0ZW5lci5kaXNwb3NlKCk7XHJcbiAgICAgIGFyaWFFbmFibGVkT25GaXJlUGVyVXR0ZXJhbmNlUXVldWVNYXAuY2xlYXIoKTtcclxuICAgICAgdGhpcy5wdXNoQnV0dG9uTW9kZWwuaXNGaXJpbmdQcm9wZXJ0eS51bmxpbmsoIGZsYWdTZXR0aW5nTGlzdGVuZXIgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZVJlc2V0QWxsQnV0dG9uKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvLyBBIGZsYWcgdGhhdCBpcyB0cnVlIHdoZW5ldmVyIGFueSBcInJlc2V0IGFsbFwiIGlzIGluIHByb2dyZXNzLiAgVGhpcyBpcyBvZnRlbiB1c2VmdWwgZm9yIG11dGluZyBzb3VuZHMgdGhhdCBzaG91bGRuJ3RcclxuICAvLyBiZSB0cmlnZ2VyZWQgYnkgbW9kZWwgdmFsdWUgY2hhbmdlcyB0aGF0IG9jY3VyIGR1ZSB0byBhIHJlc2V0LlxyXG4gIHB1YmxpYyBzdGF0aWMgaXNSZXNldHRpbmdBbGxQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4gPSBpc1Jlc2V0dGluZ0FsbFByb3BlcnR5O1xyXG59XHJcblxyXG5zY2VuZXJ5UGhldC5yZWdpc3RlciggJ1Jlc2V0QWxsQnV0dG9uJywgUmVzZXRBbGxCdXR0b24gKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLFNBQVNBLGdCQUFnQixFQUFFQyxxQkFBcUIsUUFBUSxnQ0FBZ0M7QUFFeEYsT0FBT0MsbUJBQW1CLE1BQU0sK0RBQStEO0FBQy9GLE9BQU9DLFNBQVMsTUFBTSxvQ0FBb0M7QUFDMUQsT0FBT0MsTUFBTSxNQUFNLDhCQUE4QjtBQUNqRCxPQUFPQyxtQkFBbUIsTUFBTSxvREFBb0Q7QUFDcEYsT0FBT0MsZUFBZSxNQUFNLHVCQUF1QjtBQUNuRCxPQUFPQyxXQUFXLE1BQU0sbUJBQW1CO0FBQzNDLE9BQU9DLG9CQUFvQixNQUFNLDRCQUE0QjtBQUM3RCxPQUFPQyxrQkFBa0IsTUFBTSwwQkFBMEI7QUFDekQsT0FBT0MsV0FBVyxNQUE4QixrQkFBa0I7QUFFbEUsT0FBT0MsWUFBWSxNQUFNLGtDQUFrQztBQUUzRCxNQUFNQyxrQkFBa0IsR0FBRyxDQUFDLEdBQUdKLG9CQUFvQixDQUFDSyxxQkFBcUI7QUFRekUsTUFBTUMsc0JBQXNCLEdBQUcsSUFBSUgsWUFBWSxDQUFFLEtBQU0sQ0FBQztBQUV4RCxlQUFlLE1BQU1JLGNBQWMsU0FBU0wsV0FBVyxDQUFDO0VBSS9DTSxXQUFXQSxDQUFFQyxlQUF1QyxFQUFHO0lBRTVELE1BQU1DLE9BQU8sR0FBR2YsU0FBUyxDQUF5RCxDQUFDLENBQUU7TUFFbkY7TUFDQWdCLE1BQU0sRUFBRVgsb0JBQW9CLENBQUNLLHFCQUFxQjtNQUVsRDtNQUNBO01BQ0FPLCtCQUErQixFQUFFLElBQUk7TUFFckM7TUFDQUMsaUJBQWlCLEVBQUUsR0FBRztNQUN0QkMsU0FBUyxFQUFFaEIsZUFBZSxDQUFDaUIsMkJBQTJCO01B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