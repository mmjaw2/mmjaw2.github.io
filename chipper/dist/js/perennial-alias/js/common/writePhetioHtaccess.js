// Copyright 2017-2019, University of Colorado Boulder
// @author Matt Pennington (PhET Interactive Simulations)

const buildLocal = require('./buildLocal');
const devScp = require('./devScp');
const writeFile = require('./writeFile');
const axios = require('axios');
const fs = require('graceful-fs'); // eslint-disable-line require-statement-match
const winston = require('../../../../../../perennial-alias/node_modules/winston');

// A list of directories directly nested under the phet-io build output folder that should be password protected. Slashes
// added later.
const PASSWORD_PROTECTED_SUB_DIRS = ['wrappers', 'doc'];

/**
 * Writes the htaccess file to password protect the exclusive content for phet-io sims
 * @param {string} passwordProtectPath - deployment location, with no trailing slash
 * @param {
 *  {
 *    [simName]:string,
 *    [version]:string,
 *    [directory]:string,
 *    checkoutDir: string,
 *    isProductionDeploy: boolean
 *  } | null } [latestOption]
 *      if isProductionDeploy is true, then we are publishing to production. We then write the /latest/ redirect .htaccess file.
 *      This is only to be used for production deploys by the build-server. directory is the write destination.
 *      checkoutDir is where the release branch repos live locally.
 *      simName, version, and directory are required if isProductionDeploy is true
 * @param {string} [devVersionPath] - if provided, scp the htaccess files to here, relatively
 */
module.exports = async function writePhetioHtaccess(passwordProtectPath, latestOption, devVersionPath) {
  const authFilepath = '/etc/httpd/conf/phet-io_pw';
  const isProductionDeploy = latestOption?.isProductionDeploy;

  // This option is for production deploys by the build-server
  // If we are provided a simName and version then write a .htaccess file to redirect
  // https://phet-io.colorado.edu/sims/{{sim-name}}/{{major}}.{{minor}} to https://phet-io.colorado.edu/sims/{{sim-name}}/{{major}}.{{minor}}.{{latest}}{{[-suffix]}}
  if (isProductionDeploy) {
    if (latestOption.simName && latestOption.version && latestOption.directory && latestOption.checkoutDir) {
      const redirectFilepath = `${latestOption.directory + latestOption.simName}/.htaccess`;
      let latestRedirectContents = 'RewriteEngine on\n' + `RewriteBase /sims/${latestOption.simName}/\n`;
      const versions = (await axios(`${buildLocal.productionServerURL}/services/metadata/phetio?name=${latestOption.simName}&latest=true`)).data;
      for (const v of versions) {
        // Add a trailing slash to /sims/sim-name/x.y
        latestRedirectContents += `RewriteRule ^${v.versionMajor}.${v.versionMinor}$ ${v.versionMajor}.${v.versionMinor}/ [R=301,L]\n`;
        // Rewrite /sims/sim-name/x.y/* to /sims/sim-name/x.y.z/*
        latestRedirectContents += `RewriteRule ^${v.versionMajor}.${v.versionMinor}/(.*) ${v.versionMajor}.${v.versionMinor}.${v.versionMaintenance}${v.versionSuffix ? '-' : ''}${v.versionSuffix}/$1\n`;
      }
      // 'RewriteRule latest(.*) ' + latestOption.version + '$1\n';
      latestRedirectContents += 'RewriteCond %{QUERY_STRING} =download\n' + 'RewriteRule ([^/]*)$ - [L,E=download:$1]\n' + 'Header onsuccess set Content-disposition "attachment; filename=%{download}e" env=download\n';
      await writeFile(redirectFilepath, latestRedirectContents);
    } else {
      winston.error(`simName: ${latestOption.simName}`);
      winston.error(`version: ${latestOption.version}`);
      winston.error(`directory: ${latestOption.directory}`);
      winston.error(`checkoutDir: ${latestOption.checkoutDir}`);
      throw new Error('latestOption is missing one of the required parameters (simName, version, directory, or checkoutDir)');
    }
  }
  const simPackage = isProductionDeploy ? JSON.parse(fs.readFileSync(`${latestOption.checkoutDir}/${latestOption.simName}/package.json`)) : null;
  const htaccessFilename = '.htaccess';
  const getSubdirHtaccessPath = subdir => `${subdir}/${htaccessFilename}`;
  const getSubdirHtaccessFullPath = subdir => `${passwordProtectPath}/${getSubdirHtaccessPath(subdir)}`;
  const rootHtaccessFullPath = `${passwordProtectPath}/${htaccessFilename}`;

  // Only allow public accessibility with htaccess mutation if in production deploy when the "allowPublicAccess" flag
  // is present. Commented out lines keep password protection, but comment them in with `allowPublicAccess`.
  let commentSymbol = '#';
  if (simPackage && simPackage.phet && simPackage.phet['phet-io'] && simPackage.phet['phet-io'].allowPublicAccess) {
    commentSymbol = '';
  }
  try {
    const basePasswordProtectContents = `
AuthType Basic
AuthName "PhET-iO Password Protected Area"
AuthUserFile ${authFilepath}
<LimitExcept OPTIONS>
  Require valid-user
</LimitExcept>
`;
    const passwordProtectWrapperContents = `${basePasswordProtectContents}

# Editing these directly is not supported and will be overwritten by maintenance releases. Please change by modifying 
# the sim's package.json allowPublicAccess flag followed by a re-deploy.
${commentSymbol} Satisfy Any
${commentSymbol} Allow from all
`;

    // Write a file to add authentication to subdirectories like wrappers/ or doc/
    for (const subdir of PASSWORD_PROTECTED_SUB_DIRS) {
      const htaccessPathToDir = getSubdirHtaccessFullPath(subdir);

      // if the directory exists
      if (fs.existsSync(htaccessPathToDir.replace(htaccessFilename, ''))) {
        await writeFile(htaccessPathToDir, passwordProtectWrapperContents);
        if (devVersionPath) {
          await devScp(htaccessPathToDir, `${devVersionPath}/phet-io/${getSubdirHtaccessPath(subdir)}`);
        }
      }
    }
    const phetioParentDir = latestOption?.checkoutDir || '..';
    const phetioPackage = JSON.parse(fs.readFileSync(`${phetioParentDir}/phet-io/package.json`));

    // We only want to cache for a production deploy, and not on the dev server
    const cachingDirective = isProductionDeploy ? `
# If the request is for a SIM, anything in the /lib or /xhtml dirs, or is the api.json file, then allow it to be cached
<If "-f %{REQUEST_FILENAME} && %{REQUEST_FILENAME} =~ m#(${latestOption.simName}_all.*\\.html|api\\.json|/lib/.*|/xhtml/.*)$#">
  ExpiresActive on
  ExpiresDefault "access plus 1 day"
  Header append Cache-Control "public"
  Header append Cache-Control "stale-while-revalidate=5184000"
  Header append Cache-Control "stale-if-error=5184000"
</If>
` : '';

    // Write a file to add authentication to the top level index pages
    if (phetioPackage.phet && phetioPackage.phet.addRootHTAccessFile) {
      const rootHtaccessContent = `<FilesMatch "(index\\.\\w+)$">\n${basePasswordProtectContents}</FilesMatch>
      
${cachingDirective}
                        
# Editing these directly is not supported and will be overwritten by maintenance releases. Please change by modifying 
# the sim's package.json allowPublicAccess flag followed by a re-deploy.
${commentSymbol} Satisfy Any
${commentSymbol} Allow from all
`;
      await writeFile(rootHtaccessFullPath, rootHtaccessContent);
      if (devVersionPath) {
        await devScp(rootHtaccessFullPath, `${devVersionPath}/phet-io/${htaccessFilename}`);
      }
    }
    winston.debug('phetio authentication htaccess written');
  } catch (err) {
    winston.debug('phetio authentication htaccess not written');
    throw err;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJidWlsZExvY2FsIiwicmVxdWlyZSIsImRldlNjcCIsIndyaXRlRmlsZSIsImF4aW9zIiwiZnMiLCJ3aW5zdG9uIiwiUEFTU1dPUkRfUFJPVEVDVEVEX1NVQl9ESVJTIiwibW9kdWxlIiwiZXhwb3J0cyIsIndyaXRlUGhldGlvSHRhY2Nlc3MiLCJwYXNzd29yZFByb3RlY3RQYXRoIiwibGF0ZXN0T3B0aW9uIiwiZGV2VmVyc2lvblBhdGgiLCJhdXRoRmlsZXBhdGgiLCJpc1Byb2R1Y3Rpb25EZXBsb3kiLCJzaW1OYW1lIiwidmVyc2lvbiIsImRpcmVjdG9yeSIsImNoZWNrb3V0RGlyIiwicmVkaXJlY3RGaWxlcGF0aCIsImxhdGVzdFJlZGlyZWN0Q29udGVudHMiLCJ2ZXJzaW9ucyIsInByb2R1Y3Rpb25TZXJ2ZXJVUkwiLCJkYXRhIiwidiIsInZlcnNpb25NYWpvciIsInZlcnNpb25NaW5vciIsInZlcnNpb25NYWludGVuYW5jZSIsInZlcnNpb25TdWZmaXgiLCJlcnJvciIsIkVycm9yIiwic2ltUGFja2FnZSIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsImh0YWNjZXNzRmlsZW5hbWUiLCJnZXRTdWJkaXJIdGFjY2Vzc1BhdGgiLCJzdWJkaXIiLCJnZXRTdWJkaXJIdGFjY2Vzc0Z1bGxQYXRoIiwicm9vdEh0YWNjZXNzRnVsbFBhdGgiLCJjb21tZW50U3ltYm9sIiwicGhldCIsImFsbG93UHVibGljQWNjZXNzIiwiYmFzZVBhc3N3b3JkUHJvdGVjdENvbnRlbnRzIiwicGFzc3dvcmRQcm90ZWN0V3JhcHBlckNvbnRlbnRzIiwiaHRhY2Nlc3NQYXRoVG9EaXIiLCJleGlzdHNTeW5jIiwicmVwbGFjZSIsInBoZXRpb1BhcmVudERpciIsInBoZXRpb1BhY2thZ2UiLCJjYWNoaW5nRGlyZWN0aXZlIiwiYWRkUm9vdEhUQWNjZXNzRmlsZSIsInJvb3RIdGFjY2Vzc0NvbnRlbnQiLCJkZWJ1ZyIsImVyciJdLCJzb3VyY2VzIjpbIndyaXRlUGhldGlvSHRhY2Nlc3MuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTctMjAxOSwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcbi8vIEBhdXRob3IgTWF0dCBQZW5uaW5ndG9uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG5cclxuY29uc3QgYnVpbGRMb2NhbCA9IHJlcXVpcmUoICcuL2J1aWxkTG9jYWwnICk7XHJcbmNvbnN0IGRldlNjcCA9IHJlcXVpcmUoICcuL2RldlNjcCcgKTtcclxuY29uc3Qgd3JpdGVGaWxlID0gcmVxdWlyZSggJy4vd3JpdGVGaWxlJyApO1xyXG5jb25zdCBheGlvcyA9IHJlcXVpcmUoICdheGlvcycgKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCAnZ3JhY2VmdWwtZnMnICk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1zdGF0ZW1lbnQtbWF0Y2hcclxuY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUoICd3aW5zdG9uJyApO1xyXG5cclxuLy8gQSBsaXN0IG9mIGRpcmVjdG9yaWVzIGRpcmVjdGx5IG5lc3RlZCB1bmRlciB0aGUgcGhldC1pbyBidWlsZCBvdXRwdXQgZm9sZGVyIHRoYXQgc2hvdWxkIGJlIHBhc3N3b3JkIHByb3RlY3RlZC4gU2xhc2hlc1xyXG4vLyBhZGRlZCBsYXRlci5cclxuY29uc3QgUEFTU1dPUkRfUFJPVEVDVEVEX1NVQl9ESVJTID0gWyAnd3JhcHBlcnMnLCAnZG9jJyBdO1xyXG5cclxuLyoqXHJcbiAqIFdyaXRlcyB0aGUgaHRhY2Nlc3MgZmlsZSB0byBwYXNzd29yZCBwcm90ZWN0IHRoZSBleGNsdXNpdmUgY29udGVudCBmb3IgcGhldC1pbyBzaW1zXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBwYXNzd29yZFByb3RlY3RQYXRoIC0gZGVwbG95bWVudCBsb2NhdGlvbiwgd2l0aCBubyB0cmFpbGluZyBzbGFzaFxyXG4gKiBAcGFyYW0ge1xyXG4gKiAge1xyXG4gKiAgICBbc2ltTmFtZV06c3RyaW5nLFxyXG4gKiAgICBbdmVyc2lvbl06c3RyaW5nLFxyXG4gKiAgICBbZGlyZWN0b3J5XTpzdHJpbmcsXHJcbiAqICAgIGNoZWNrb3V0RGlyOiBzdHJpbmcsXHJcbiAqICAgIGlzUHJvZHVjdGlvbkRlcGxveTogYm9vbGVhblxyXG4gKiAgfSB8IG51bGwgfSBbbGF0ZXN0T3B0aW9uXVxyXG4gKiAgICAgIGlmIGlzUHJvZHVjdGlvbkRlcGxveSBpcyB0cnVlLCB0aGVuIHdlIGFyZSBwdWJsaXNoaW5nIHRvIHByb2R1Y3Rpb24uIFdlIHRoZW4gd3JpdGUgdGhlIC9sYXRlc3QvIHJlZGlyZWN0IC5odGFjY2VzcyBmaWxlLlxyXG4gKiAgICAgIFRoaXMgaXMgb25seSB0byBiZSB1c2VkIGZvciBwcm9kdWN0aW9uIGRlcGxveXMgYnkgdGhlIGJ1aWxkLXNlcnZlci4gZGlyZWN0b3J5IGlzIHRoZSB3cml0ZSBkZXN0aW5hdGlvbi5cclxuICogICAgICBjaGVja291dERpciBpcyB3aGVyZSB0aGUgcmVsZWFzZSBicmFuY2ggcmVwb3MgbGl2ZSBsb2NhbGx5LlxyXG4gKiAgICAgIHNpbU5hbWUsIHZlcnNpb24sIGFuZCBkaXJlY3RvcnkgYXJlIHJlcXVpcmVkIGlmIGlzUHJvZHVjdGlvbkRlcGxveSBpcyB0cnVlXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBbZGV2VmVyc2lvblBhdGhdIC0gaWYgcHJvdmlkZWQsIHNjcCB0aGUgaHRhY2Nlc3MgZmlsZXMgdG8gaGVyZSwgcmVsYXRpdmVseVxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiB3cml0ZVBoZXRpb0h0YWNjZXNzKCBwYXNzd29yZFByb3RlY3RQYXRoLCBsYXRlc3RPcHRpb24sIGRldlZlcnNpb25QYXRoICkge1xyXG4gIGNvbnN0IGF1dGhGaWxlcGF0aCA9ICcvZXRjL2h0dHBkL2NvbmYvcGhldC1pb19wdyc7XHJcblxyXG4gIGNvbnN0IGlzUHJvZHVjdGlvbkRlcGxveSA9IGxhdGVzdE9wdGlvbj8uaXNQcm9kdWN0aW9uRGVwbG95O1xyXG5cclxuICAvLyBUaGlzIG9wdGlvbiBpcyBmb3IgcHJvZHVjdGlvbiBkZXBsb3lzIGJ5IHRoZSBidWlsZC1zZXJ2ZXJcclxuICAvLyBJZiB3ZSBhcmUgcHJvdmlkZWQgYSBzaW1OYW1lIGFuZCB2ZXJzaW9uIHRoZW4gd3JpdGUgYSAuaHRhY2Nlc3MgZmlsZSB0byByZWRpcmVjdFxyXG4gIC8vIGh0dHBzOi8vcGhldC1pby5jb2xvcmFkby5lZHUvc2ltcy97e3NpbS1uYW1lfX0ve3ttYWpvcn19Lnt7bWlub3J9fSB0byBodHRwczovL3BoZXQtaW8uY29sb3JhZG8uZWR1L3NpbXMve3tzaW0tbmFtZX19L3t7bWFqb3J9fS57e21pbm9yfX0ue3tsYXRlc3R9fXt7Wy1zdWZmaXhdfX1cclxuICBpZiAoIGlzUHJvZHVjdGlvbkRlcGxveSApIHtcclxuICAgIGlmICggbGF0ZXN0T3B0aW9uLnNpbU5hbWUgJiYgbGF0ZXN0T3B0aW9uLnZlcnNpb24gJiYgbGF0ZXN0T3B0aW9uLmRpcmVjdG9yeSAmJiBsYXRlc3RPcHRpb24uY2hlY2tvdXREaXIgKSB7XHJcbiAgICAgIGNvbnN0IHJlZGlyZWN0RmlsZXBhdGggPSBgJHtsYXRlc3RPcHRpb24uZGlyZWN0b3J5ICsgbGF0ZXN0T3B0aW9uLnNpbU5hbWV9Ly5odGFjY2Vzc2A7XHJcbiAgICAgIGxldCBsYXRlc3RSZWRpcmVjdENvbnRlbnRzID0gJ1Jld3JpdGVFbmdpbmUgb25cXG4nICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgUmV3cml0ZUJhc2UgL3NpbXMvJHtsYXRlc3RPcHRpb24uc2ltTmFtZX0vXFxuYDtcclxuICAgICAgY29uc3QgdmVyc2lvbnMgPSAoIGF3YWl0IGF4aW9zKCBgJHtidWlsZExvY2FsLnByb2R1Y3Rpb25TZXJ2ZXJVUkx9L3NlcnZpY2VzL21ldGFkYXRhL3BoZXRpbz9uYW1lPSR7bGF0ZXN0T3B0aW9uLnNpbU5hbWV9JmxhdGVzdD10cnVlYCApICkuZGF0YTtcclxuICAgICAgZm9yICggY29uc3QgdiBvZiB2ZXJzaW9ucyApIHtcclxuICAgICAgICAvLyBBZGQgYSB0cmFpbGluZyBzbGFzaCB0byAvc2ltcy9zaW0tbmFtZS94LnlcclxuICAgICAgICBsYXRlc3RSZWRpcmVjdENvbnRlbnRzICs9IGBSZXdyaXRlUnVsZSBeJHt2LnZlcnNpb25NYWpvcn0uJHt2LnZlcnNpb25NaW5vcn0kICR7di52ZXJzaW9uTWFqb3J9LiR7di52ZXJzaW9uTWlub3J9LyBbUj0zMDEsTF1cXG5gO1xyXG4gICAgICAgIC8vIFJld3JpdGUgL3NpbXMvc2ltLW5hbWUveC55LyogdG8gL3NpbXMvc2ltLW5hbWUveC55LnovKlxyXG4gICAgICAgIGxhdGVzdFJlZGlyZWN0Q29udGVudHMgKz0gYFJld3JpdGVSdWxlIF4ke3YudmVyc2lvbk1ham9yfS4ke3YudmVyc2lvbk1pbm9yfS8oLiopICR7di52ZXJzaW9uTWFqb3J9LiR7di52ZXJzaW9uTWlub3J9LiR7di52ZXJzaW9uTWFpbnRlbmFuY2V9JHt2LnZlcnNpb25TdWZmaXggPyAnLScgOiAnJ30ke3YudmVyc2lvblN1ZmZpeH0vJDFcXG5gO1xyXG4gICAgICB9XHJcbiAgICAgIC8vICdSZXdyaXRlUnVsZSBsYXRlc3QoLiopICcgKyBsYXRlc3RPcHRpb24udmVyc2lvbiArICckMVxcbic7XHJcbiAgICAgIGxhdGVzdFJlZGlyZWN0Q29udGVudHMgKz0gJ1Jld3JpdGVDb25kICV7UVVFUllfU1RSSU5HfSA9ZG93bmxvYWRcXG4nICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnUmV3cml0ZVJ1bGUgKFteL10qKSQgLSBbTCxFPWRvd25sb2FkOiQxXVxcbicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdIZWFkZXIgb25zdWNjZXNzIHNldCBDb250ZW50LWRpc3Bvc2l0aW9uIFwiYXR0YWNobWVudDsgZmlsZW5hbWU9JXtkb3dubG9hZH1lXCIgZW52PWRvd25sb2FkXFxuJztcclxuICAgICAgYXdhaXQgd3JpdGVGaWxlKCByZWRpcmVjdEZpbGVwYXRoLCBsYXRlc3RSZWRpcmVjdENvbnRlbnRzICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgd2luc3Rvbi5lcnJvciggYHNpbU5hbWU6ICR7bGF0ZXN0T3B0aW9uLnNpbU5hbWV9YCApO1xyXG4gICAgICB3aW5zdG9uLmVycm9yKCBgdmVyc2lvbjogJHtsYXRlc3RPcHRpb24udmVyc2lvbn1gICk7XHJcbiAgICAgIHdpbnN0b24uZXJyb3IoIGBkaXJlY3Rvcnk6ICR7bGF0ZXN0T3B0aW9uLmRpcmVjdG9yeX1gICk7XHJcbiAgICAgIHdpbnN0b24uZXJyb3IoIGBjaGVja291dERpcjogJHtsYXRlc3RPcHRpb24uY2hlY2tvdXREaXJ9YCApO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoICdsYXRlc3RPcHRpb24gaXMgbWlzc2luZyBvbmUgb2YgdGhlIHJlcXVpcmVkIHBhcmFtZXRlcnMgKHNpbU5hbWUsIHZlcnNpb24sIGRpcmVjdG9yeSwgb3IgY2hlY2tvdXREaXIpJyApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2ltUGFja2FnZSA9IGlzUHJvZHVjdGlvbkRlcGxveSA/IEpTT04ucGFyc2UoIGZzLnJlYWRGaWxlU3luYyggYCR7bGF0ZXN0T3B0aW9uLmNoZWNrb3V0RGlyfS8ke2xhdGVzdE9wdGlvbi5zaW1OYW1lfS9wYWNrYWdlLmpzb25gICkgKSA6IG51bGw7XHJcblxyXG4gIGNvbnN0IGh0YWNjZXNzRmlsZW5hbWUgPSAnLmh0YWNjZXNzJztcclxuICBjb25zdCBnZXRTdWJkaXJIdGFjY2Vzc1BhdGggPSBzdWJkaXIgPT4gYCR7c3ViZGlyfS8ke2h0YWNjZXNzRmlsZW5hbWV9YDtcclxuICBjb25zdCBnZXRTdWJkaXJIdGFjY2Vzc0Z1bGxQYXRoID0gc3ViZGlyID0+IGAke3Bhc3N3b3JkUHJvdGVjdFBhdGh9LyR7Z2V0U3ViZGlySHRhY2Nlc3NQYXRoKCBzdWJkaXIgKX1gO1xyXG4gIGNvbnN0IHJvb3RIdGFjY2Vzc0Z1bGxQYXRoID0gYCR7cGFzc3dvcmRQcm90ZWN0UGF0aH0vJHtodGFjY2Vzc0ZpbGVuYW1lfWA7XHJcblxyXG4gIC8vIE9ubHkgYWxsb3cgcHVibGljIGFjY2Vzc2liaWxpdHkgd2l0aCBodGFjY2VzcyBtdXRhdGlvbiBpZiBpbiBwcm9kdWN0aW9uIGRlcGxveSB3aGVuIHRoZSBcImFsbG93UHVibGljQWNjZXNzXCIgZmxhZ1xyXG4gIC8vIGlzIHByZXNlbnQuIENvbW1lbnRlZCBvdXQgbGluZXMga2VlcCBwYXNzd29yZCBwcm90ZWN0aW9uLCBidXQgY29tbWVudCB0aGVtIGluIHdpdGggYGFsbG93UHVibGljQWNjZXNzYC5cclxuICBsZXQgY29tbWVudFN5bWJvbCA9ICcjJztcclxuXHJcbiAgaWYgKCBzaW1QYWNrYWdlICYmIHNpbVBhY2thZ2UucGhldCAmJiBzaW1QYWNrYWdlLnBoZXRbICdwaGV0LWlvJyBdICYmIHNpbVBhY2thZ2UucGhldFsgJ3BoZXQtaW8nIF0uYWxsb3dQdWJsaWNBY2Nlc3MgKSB7XHJcbiAgICBjb21tZW50U3ltYm9sID0gJyc7XHJcbiAgfVxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBiYXNlUGFzc3dvcmRQcm90ZWN0Q29udGVudHMgPSBgXHJcbkF1dGhUeXBlIEJhc2ljXHJcbkF1dGhOYW1lIFwiUGhFVC1pTyBQYXNzd29yZCBQcm90ZWN0ZWQgQXJlYVwiXHJcbkF1dGhVc2VyRmlsZSAke2F1dGhGaWxlcGF0aH1cclxuPExpbWl0RXhjZXB0IE9QVElPTlM+XHJcbiAgUmVxdWlyZSB2YWxpZC11c2VyXHJcbjwvTGltaXRFeGNlcHQ+XHJcbmA7XHJcblxyXG4gICAgY29uc3QgcGFzc3dvcmRQcm90ZWN0V3JhcHBlckNvbnRlbnRzID0gYCR7YmFzZVBhc3N3b3JkUHJvdGVjdENvbnRlbnRzfVxyXG5cclxuIyBFZGl0aW5nIHRoZXNlIGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgb3ZlcndyaXR0ZW4gYnkgbWFpbnRlbmFuY2UgcmVsZWFzZXMuIFBsZWFzZSBjaGFuZ2UgYnkgbW9kaWZ5aW5nIFxyXG4jIHRoZSBzaW0ncyBwYWNrYWdlLmpzb24gYWxsb3dQdWJsaWNBY2Nlc3MgZmxhZyBmb2xsb3dlZCBieSBhIHJlLWRlcGxveS5cclxuJHtjb21tZW50U3ltYm9sfSBTYXRpc2Z5IEFueVxyXG4ke2NvbW1lbnRTeW1ib2x9IEFsbG93IGZyb20gYWxsXHJcbmA7XHJcblxyXG4gICAgLy8gV3JpdGUgYSBmaWxlIHRvIGFkZCBhdXRoZW50aWNhdGlvbiB0byBzdWJkaXJlY3RvcmllcyBsaWtlIHdyYXBwZXJzLyBvciBkb2MvXHJcbiAgICBmb3IgKCBjb25zdCBzdWJkaXIgb2YgUEFTU1dPUkRfUFJPVEVDVEVEX1NVQl9ESVJTICkge1xyXG4gICAgICBjb25zdCBodGFjY2Vzc1BhdGhUb0RpciA9IGdldFN1YmRpckh0YWNjZXNzRnVsbFBhdGgoIHN1YmRpciApO1xyXG5cclxuICAgICAgLy8gaWYgdGhlIGRpcmVjdG9yeSBleGlzdHNcclxuICAgICAgaWYgKCBmcy5leGlzdHNTeW5jKCBodGFjY2Vzc1BhdGhUb0Rpci5yZXBsYWNlKCBodGFjY2Vzc0ZpbGVuYW1lLCAnJyApICkgKSB7XHJcblxyXG4gICAgICAgIGF3YWl0IHdyaXRlRmlsZSggaHRhY2Nlc3NQYXRoVG9EaXIsIHBhc3N3b3JkUHJvdGVjdFdyYXBwZXJDb250ZW50cyApO1xyXG4gICAgICAgIGlmICggZGV2VmVyc2lvblBhdGggKSB7XHJcbiAgICAgICAgICBhd2FpdCBkZXZTY3AoIGh0YWNjZXNzUGF0aFRvRGlyLCBgJHtkZXZWZXJzaW9uUGF0aH0vcGhldC1pby8ke2dldFN1YmRpckh0YWNjZXNzUGF0aCggc3ViZGlyICl9YCApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHBoZXRpb1BhcmVudERpciA9IGxhdGVzdE9wdGlvbj8uY2hlY2tvdXREaXIgfHwgJy4uJztcclxuICAgIGNvbnN0IHBoZXRpb1BhY2thZ2UgPSBKU09OLnBhcnNlKCBmcy5yZWFkRmlsZVN5bmMoIGAke3BoZXRpb1BhcmVudERpcn0vcGhldC1pby9wYWNrYWdlLmpzb25gICkgKTtcclxuXHJcbiAgICAvLyBXZSBvbmx5IHdhbnQgdG8gY2FjaGUgZm9yIGEgcHJvZHVjdGlvbiBkZXBsb3ksIGFuZCBub3Qgb24gdGhlIGRldiBzZXJ2ZXJcclxuICAgIGNvbnN0IGNhY2hpbmdEaXJlY3RpdmUgPSBpc1Byb2R1Y3Rpb25EZXBsb3kgPyBgXHJcbiMgSWYgdGhlIHJlcXVlc3QgaXMgZm9yIGEgU0lNLCBhbnl0aGluZyBpbiB0aGUgL2xpYiBvciAveGh0bWwgZGlycywgb3IgaXMgdGhlIGFwaS5qc29uIGZpbGUsIHRoZW4gYWxsb3cgaXQgdG8gYmUgY2FjaGVkXHJcbjxJZiBcIi1mICV7UkVRVUVTVF9GSUxFTkFNRX0gJiYgJXtSRVFVRVNUX0ZJTEVOQU1FfSA9fiBtIygke2xhdGVzdE9wdGlvbi5zaW1OYW1lfV9hbGwuKlxcXFwuaHRtbHxhcGlcXFxcLmpzb258L2xpYi8uKnwveGh0bWwvLiopJCNcIj5cclxuICBFeHBpcmVzQWN0aXZlIG9uXHJcbiAgRXhwaXJlc0RlZmF1bHQgXCJhY2Nlc3MgcGx1cyAxIGRheVwiXHJcbiAgSGVhZGVyIGFwcGVuZCBDYWNoZS1Db250cm9sIFwicHVibGljXCJcclxuICBIZWFkZXIgYXBwZW5kIENhY2hlLUNvbnRyb2wgXCJzdGFsZS13aGlsZS1yZXZhbGlkYXRlPTUxODQwMDBcIlxyXG4gIEhlYWRlciBhcHBlbmQgQ2FjaGUtQ29udHJvbCBcInN0YWxlLWlmLWVycm9yPTUxODQwMDBcIlxyXG48L0lmPlxyXG5gIDogJyc7XHJcblxyXG4gICAgLy8gV3JpdGUgYSBmaWxlIHRvIGFkZCBhdXRoZW50aWNhdGlvbiB0byB0aGUgdG9wIGxldmVsIGluZGV4IHBhZ2VzXHJcbiAgICBpZiAoIHBoZXRpb1BhY2thZ2UucGhldCAmJiBwaGV0aW9QYWNrYWdlLnBoZXQuYWRkUm9vdEhUQWNjZXNzRmlsZSApIHtcclxuICAgICAgY29uc3Qgcm9vdEh0YWNjZXNzQ29udGVudCA9IGA8RmlsZXNNYXRjaCBcIihpbmRleFxcXFwuXFxcXHcrKSRcIj5cXG4ke1xyXG4gICAgICAgIGJhc2VQYXNzd29yZFByb3RlY3RDb250ZW50c1xyXG4gICAgICB9PC9GaWxlc01hdGNoPlxyXG4gICAgICBcclxuJHtjYWNoaW5nRGlyZWN0aXZlfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcclxuIyBFZGl0aW5nIHRoZXNlIGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgb3ZlcndyaXR0ZW4gYnkgbWFpbnRlbmFuY2UgcmVsZWFzZXMuIFBsZWFzZSBjaGFuZ2UgYnkgbW9kaWZ5aW5nIFxyXG4jIHRoZSBzaW0ncyBwYWNrYWdlLmpzb24gYWxsb3dQdWJsaWNBY2Nlc3MgZmxhZyBmb2xsb3dlZCBieSBhIHJlLWRlcGxveS5cclxuJHtjb21tZW50U3ltYm9sfSBTYXRpc2Z5IEFueVxyXG4ke2NvbW1lbnRTeW1ib2x9IEFsbG93IGZyb20gYWxsXHJcbmA7XHJcbiAgICAgIGF3YWl0IHdyaXRlRmlsZSggcm9vdEh0YWNjZXNzRnVsbFBhdGgsIHJvb3RIdGFjY2Vzc0NvbnRlbnQgKTtcclxuICAgICAgaWYgKCBkZXZWZXJzaW9uUGF0aCApIHtcclxuICAgICAgICBhd2FpdCBkZXZTY3AoIHJvb3RIdGFjY2Vzc0Z1bGxQYXRoLCBgJHtkZXZWZXJzaW9uUGF0aH0vcGhldC1pby8ke2h0YWNjZXNzRmlsZW5hbWV9YCApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB3aW5zdG9uLmRlYnVnKCAncGhldGlvIGF1dGhlbnRpY2F0aW9uIGh0YWNjZXNzIHdyaXR0ZW4nICk7XHJcbiAgfVxyXG4gIGNhdGNoKCBlcnIgKSB7XHJcbiAgICB3aW5zdG9uLmRlYnVnKCAncGhldGlvIGF1dGhlbnRpY2F0aW9uIGh0YWNjZXNzIG5vdCB3cml0dGVuJyApO1xyXG4gICAgdGhyb3cgZXJyO1xyXG4gIH1cclxufTsiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxPQUFP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