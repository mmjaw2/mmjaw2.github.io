// Copyright 2017, University of Colorado Boulder

/**
 * Deploys an rc version after incrementing the test version number.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

const SimVersion = require('../common/SimVersion');
const booleanPrompt = require('../common/booleanPrompt');
const build = require('../common/build');
const buildLocal = require('../common/buildLocal');
const buildServerRequest = require('../common/buildServerRequest');
const checkoutMain = require('../common/checkoutMain');
const checkoutTarget = require('../common/checkoutTarget');
const devDirectoryExists = require('../common/devDirectoryExists');
const getDependencies = require('../common/getDependencies');
const getRepoVersion = require('../common/getRepoVersion');
const gitCheckout = require('../common/gitCheckout');
const gitIsClean = require('../common/gitIsClean');
const gitPush = require('../common/gitPush');
const hasRemoteBranch = require('../common/hasRemoteBranch');
const loadJSON = require('../common/loadJSON');
const npmUpdate = require('../common/npmUpdate');
const setRepoVersion = require('../common/setRepoVersion');
const updateDependenciesJSON = require('../common/updateDependenciesJSON');
const vpnCheck = require('../common/vpnCheck');
const createRelease = require('./createRelease');
const grunt = require('grunt');

/**
 * Deploys an rc version after incrementing the test version number.
 * @public
 *
 * @param {string} repo
 * @param {string} branch
 * @param {Array.<string>} brands
 * @param {boolean} noninteractive
 * @param {string} [message] - Optional message to append to the version-increment commit.
 * @returns {Promise.<SimVersion>}
 */
module.exports = async function rc(repo, branch, brands, noninteractive, message) {
  SimVersion.ensureReleaseBranch(branch);
  if (!(await vpnCheck())) {
    grunt.fail.fatal('VPN or being on campus is required for this build. Ensure VPN is enabled, or that you have access to phet-server2.int.colorado.edu');
  }
  const isClean = await gitIsClean(repo);
  if (!isClean) {
    throw new Error(`Unclean status in ${repo}, cannot create release branch`);
  }
  if (!(await hasRemoteBranch(repo, branch))) {
    if (noninteractive || !(await booleanPrompt(`Release branch ${branch} does not exist. Create it?`, false))) {
      throw new Error('Aborted rc deployment due to non-existing branch');
    }
    await createRelease(repo, branch, brands);
  }

  // PhET-iO simulations require validation for RCs. Error out if "phet.phet-io.validation=false" is in package.json.
  await gitCheckout(repo, branch);
  if (brands.includes('phet-io')) {
    const packageObject = await loadJSON(`../${repo}/package.json`);
    if (packageObject.phet['phet-io'] && packageObject.phet['phet-io'].hasOwnProperty('validation') && !packageObject.phet['phet-io'].validation) {
      throw new Error('PhET-iO simulations require validation for RCs');
    }
  }
  await checkoutTarget(repo, branch, true); // include npm update

  try {
    const previousVersion = await getRepoVersion(repo);
    if (previousVersion.testType !== 'rc' && previousVersion.testType !== null) {
      throw new Error(`Aborted rc deployment since the version number cannot be incremented safely (testType:${previousVersion.testType})`);
    }
    const version = new SimVersion(previousVersion.major, previousVersion.minor, previousVersion.maintenance + (previousVersion.testType === null ? 1 : 0), {
      testType: 'rc',
      testNumber: previousVersion.testNumber ? previousVersion.testNumber + 1 : 1
    });
    const versionString = version.toString();
    const simPath = buildLocal.devDeployPath + repo;
    const versionPath = `${simPath}/${versionString}`;
    const versionPathExists = await devDirectoryExists(versionPath);
    if (versionPathExists) {
      throw new Error(`Directory ${versionPath} already exists.  If you intend to replace the content then remove the directory manually from ${buildLocal.devDeployServer}.`);
    }
    if (!(await booleanPrompt(`Deploy ${versionString} to ${buildLocal.devDeployServer}`, noninteractive))) {
      throw new Error('Aborted rc deployment');
    }
    await setRepoVersion(repo, version, message);
    await gitPush(repo, branch);

    // Make sure our correct npm dependencies are set
    await npmUpdate(repo);
    await npmUpdate('chipper');
    await npmUpdate('perennial-alias');

    // No special options required here, as we send the main request to the build server
    grunt.log.writeln(await build(repo, {
      brands: brands,
      minify: !noninteractive
    }));
    if (!(await booleanPrompt(`Please test the built version of ${repo}.\nIs it ready to deploy`, noninteractive))) {
      // Abort version update
      await setRepoVersion(repo, previousVersion, message);
      await gitPush(repo, branch);

      // Abort checkout
      await checkoutMain(repo, true);
      throw new Error('Aborted rc deployment (aborted version change too).');
    }

    // Move over dependencies.json and commit/push
    await updateDependenciesJSON(repo, brands, versionString, branch);

    // Send the build request
    await buildServerRequest(repo, version, branch, await getDependencies(repo), {
      locales: ['en'],
      brands: brands,
      servers: ['dev']
    });

    // Move back to main
    await checkoutMain(repo, true);
    const versionURL = `https://phet-dev.colorado.edu/html/${repo}/${versionString}`;
    if (brands.includes('phet')) {
      grunt.log.writeln(`Deployed: ${versionURL}/phet/${repo}_all_phet.html`);
    }
    if (brands.includes('phet-io')) {
      grunt.log.writeln(`Deployed: ${versionURL}/phet-io/`);
    }
    grunt.log.writeln('Please wait for the build-server to complete the deployment, and then test!');
    grunt.log.writeln(`To view the current build status, visit ${buildLocal.productionServerURL}/deploy-status`);
    return version;
  } catch (e) {
    grunt.log.warn('Detected failure during deploy, reverting to main');
    await checkoutMain(repo, true);
    throw e;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTaW1WZXJzaW9uIiwicmVxdWlyZSIsImJvb2xlYW5Qcm9tcHQiLCJidWlsZCIsImJ1aWxkTG9jYWwiLCJidWlsZFNlcnZlclJlcXVlc3QiLCJjaGVja291dE1haW4iLCJjaGVja291dFRhcmdldCIsImRldkRpcmVjdG9yeUV4aXN0cyIsImdldERlcGVuZGVuY2llcyIsImdldFJlcG9WZXJzaW9uIiwiZ2l0Q2hlY2tvdXQiLCJnaXRJc0NsZWFuIiwiZ2l0UHVzaCIsImhhc1JlbW90ZUJyYW5jaCIsImxvYWRKU09OIiwibnBtVXBkYXRlIiwic2V0UmVwb1ZlcnNpb24iLCJ1cGRhdGVEZXBlbmRlbmNpZXNKU09OIiwidnBuQ2hlY2siLCJjcmVhdGVSZWxlYXNlIiwiZ3J1bnQiLCJtb2R1bGUiLCJleHBvcnRzIiwicmMiLCJyZXBvIiwiYnJhbmNoIiwiYnJhbmRzIiwibm9uaW50ZXJhY3RpdmUiLCJtZXNzYWdlIiwiZW5zdXJlUmVsZWFzZUJyYW5jaCIsImZhaWwiLCJmYXRhbCIsImlzQ2xlYW4iLCJFcnJvciIsImluY2x1ZGVzIiwicGFja2FnZU9iamVjdCIsInBoZXQiLCJoYXNPd25Qcm9wZXJ0eSIsInZhbGlkYXRpb24iLCJwcmV2aW91c1ZlcnNpb24iLCJ0ZXN0VHlwZSIsInZlcnNpb24iLCJtYWpvciIsIm1pbm9yIiwibWFpbnRlbmFuY2UiLCJ0ZXN0TnVtYmVyIiwidmVyc2lvblN0cmluZyIsInRvU3RyaW5nIiwic2ltUGF0aCIsImRldkRlcGxveVBhdGgiLCJ2ZXJzaW9uUGF0aCIsInZlcnNpb25QYXRoRXhpc3RzIiwiZGV2RGVwbG95U2VydmVyIiwibG9nIiwid3JpdGVsbiIsIm1pbmlmeSIsImxvY2FsZXMiLCJzZXJ2ZXJzIiwidmVyc2lvblVSTCIsInByb2R1Y3Rpb25TZXJ2ZXJVUkwiLCJlIiwid2FybiJdLCJzb3VyY2VzIjpbInJjLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBEZXBsb3lzIGFuIHJjIHZlcnNpb24gYWZ0ZXIgaW5jcmVtZW50aW5nIHRoZSB0ZXN0IHZlcnNpb24gbnVtYmVyLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuY29uc3QgU2ltVmVyc2lvbiA9IHJlcXVpcmUoICcuLi9jb21tb24vU2ltVmVyc2lvbicgKTtcclxuY29uc3QgYm9vbGVhblByb21wdCA9IHJlcXVpcmUoICcuLi9jb21tb24vYm9vbGVhblByb21wdCcgKTtcclxuY29uc3QgYnVpbGQgPSByZXF1aXJlKCAnLi4vY29tbW9uL2J1aWxkJyApO1xyXG5jb25zdCBidWlsZExvY2FsID0gcmVxdWlyZSggJy4uL2NvbW1vbi9idWlsZExvY2FsJyApO1xyXG5jb25zdCBidWlsZFNlcnZlclJlcXVlc3QgPSByZXF1aXJlKCAnLi4vY29tbW9uL2J1aWxkU2VydmVyUmVxdWVzdCcgKTtcclxuY29uc3QgY2hlY2tvdXRNYWluID0gcmVxdWlyZSggJy4uL2NvbW1vbi9jaGVja291dE1haW4nICk7XHJcbmNvbnN0IGNoZWNrb3V0VGFyZ2V0ID0gcmVxdWlyZSggJy4uL2NvbW1vbi9jaGVja291dFRhcmdldCcgKTtcclxuY29uc3QgZGV2RGlyZWN0b3J5RXhpc3RzID0gcmVxdWlyZSggJy4uL2NvbW1vbi9kZXZEaXJlY3RvcnlFeGlzdHMnICk7XHJcbmNvbnN0IGdldERlcGVuZGVuY2llcyA9IHJlcXVpcmUoICcuLi9jb21tb24vZ2V0RGVwZW5kZW5jaWVzJyApO1xyXG5jb25zdCBnZXRSZXBvVmVyc2lvbiA9IHJlcXVpcmUoICcuLi9jb21tb24vZ2V0UmVwb1ZlcnNpb24nICk7XHJcbmNvbnN0IGdpdENoZWNrb3V0ID0gcmVxdWlyZSggJy4uL2NvbW1vbi9naXRDaGVja291dCcgKTtcclxuY29uc3QgZ2l0SXNDbGVhbiA9IHJlcXVpcmUoICcuLi9jb21tb24vZ2l0SXNDbGVhbicgKTtcclxuY29uc3QgZ2l0UHVzaCA9IHJlcXVpcmUoICcuLi9jb21tb24vZ2l0UHVzaCcgKTtcclxuY29uc3QgaGFzUmVtb3RlQnJhbmNoID0gcmVxdWlyZSggJy4uL2NvbW1vbi9oYXNSZW1vdGVCcmFuY2gnICk7XHJcbmNvbnN0IGxvYWRKU09OID0gcmVxdWlyZSggJy4uL2NvbW1vbi9sb2FkSlNPTicgKTtcclxuY29uc3QgbnBtVXBkYXRlID0gcmVxdWlyZSggJy4uL2NvbW1vbi9ucG1VcGRhdGUnICk7XHJcbmNvbnN0IHNldFJlcG9WZXJzaW9uID0gcmVxdWlyZSggJy4uL2NvbW1vbi9zZXRSZXBvVmVyc2lvbicgKTtcclxuY29uc3QgdXBkYXRlRGVwZW5kZW5jaWVzSlNPTiA9IHJlcXVpcmUoICcuLi9jb21tb24vdXBkYXRlRGVwZW5kZW5jaWVzSlNPTicgKTtcclxuY29uc3QgdnBuQ2hlY2sgPSByZXF1aXJlKCAnLi4vY29tbW9uL3ZwbkNoZWNrJyApO1xyXG5jb25zdCBjcmVhdGVSZWxlYXNlID0gcmVxdWlyZSggJy4vY3JlYXRlUmVsZWFzZScgKTtcclxuY29uc3QgZ3J1bnQgPSByZXF1aXJlKCAnZ3J1bnQnICk7XHJcblxyXG4vKipcclxuICogRGVwbG95cyBhbiByYyB2ZXJzaW9uIGFmdGVyIGluY3JlbWVudGluZyB0aGUgdGVzdCB2ZXJzaW9uIG51bWJlci5cclxuICogQHB1YmxpY1xyXG4gKlxyXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVwb1xyXG4gKiBAcGFyYW0ge3N0cmluZ30gYnJhbmNoXHJcbiAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz59IGJyYW5kc1xyXG4gKiBAcGFyYW0ge2Jvb2xlYW59IG5vbmludGVyYWN0aXZlXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBbbWVzc2FnZV0gLSBPcHRpb25hbCBtZXNzYWdlIHRvIGFwcGVuZCB0byB0aGUgdmVyc2lvbi1pbmNyZW1lbnQgY29tbWl0LlxyXG4gKiBAcmV0dXJucyB7UHJvbWlzZS48U2ltVmVyc2lvbj59XHJcbiAqL1xyXG5tb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uIHJjKCByZXBvLCBicmFuY2gsIGJyYW5kcywgbm9uaW50ZXJhY3RpdmUsIG1lc3NhZ2UgKSB7XHJcbiAgU2ltVmVyc2lvbi5lbnN1cmVSZWxlYXNlQnJhbmNoKCBicmFuY2ggKTtcclxuXHJcbiAgaWYgKCAhKCBhd2FpdCB2cG5DaGVjaygpICkgKSB7XHJcbiAgICBncnVudC5mYWlsLmZhdGFsKCAnVlBOIG9yIGJlaW5nIG9uIGNhbXB1cyBpcyByZXF1aXJlZCBmb3IgdGhpcyBidWlsZC4gRW5zdXJlIFZQTiBpcyBlbmFibGVkLCBvciB0aGF0IHlvdSBoYXZlIGFjY2VzcyB0byBwaGV0LXNlcnZlcjIuaW50LmNvbG9yYWRvLmVkdScgKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGlzQ2xlYW4gPSBhd2FpdCBnaXRJc0NsZWFuKCByZXBvICk7XHJcbiAgaWYgKCAhaXNDbGVhbiApIHtcclxuICAgIHRocm93IG5ldyBFcnJvciggYFVuY2xlYW4gc3RhdHVzIGluICR7cmVwb30sIGNhbm5vdCBjcmVhdGUgcmVsZWFzZSBicmFuY2hgICk7XHJcbiAgfVxyXG5cclxuICBpZiAoICEoIGF3YWl0IGhhc1JlbW90ZUJyYW5jaCggcmVwbywgYnJhbmNoICkgKSApIHtcclxuICAgIGlmICggbm9uaW50ZXJhY3RpdmUgfHwgIWF3YWl0IGJvb2xlYW5Qcm9tcHQoIGBSZWxlYXNlIGJyYW5jaCAke2JyYW5jaH0gZG9lcyBub3QgZXhpc3QuIENyZWF0ZSBpdD9gLCBmYWxzZSApICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoICdBYm9ydGVkIHJjIGRlcGxveW1lbnQgZHVlIHRvIG5vbi1leGlzdGluZyBicmFuY2gnICk7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgY3JlYXRlUmVsZWFzZSggcmVwbywgYnJhbmNoLCBicmFuZHMgKTtcclxuICB9XHJcblxyXG4gIC8vIFBoRVQtaU8gc2ltdWxhdGlvbnMgcmVxdWlyZSB2YWxpZGF0aW9uIGZvciBSQ3MuIEVycm9yIG91dCBpZiBcInBoZXQucGhldC1pby52YWxpZGF0aW9uPWZhbHNlXCIgaXMgaW4gcGFja2FnZS5qc29uLlxyXG4gIGF3YWl0IGdpdENoZWNrb3V0KCByZXBvLCBicmFuY2ggKTtcclxuICBpZiAoIGJyYW5kcy5pbmNsdWRlcyggJ3BoZXQtaW8nICkgKSB7XHJcbiAgICBjb25zdCBwYWNrYWdlT2JqZWN0ID0gYXdhaXQgbG9hZEpTT04oIGAuLi8ke3JlcG99L3BhY2thZ2UuanNvbmAgKTtcclxuICAgIGlmICggcGFja2FnZU9iamVjdC5waGV0WyAncGhldC1pbycgXSAmJiBwYWNrYWdlT2JqZWN0LnBoZXRbICdwaGV0LWlvJyBdLmhhc093blByb3BlcnR5KCAndmFsaWRhdGlvbicgKSAmJlxyXG4gICAgICAgICAhcGFja2FnZU9iamVjdC5waGV0WyAncGhldC1pbycgXS52YWxpZGF0aW9uICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoICdQaEVULWlPIHNpbXVsYXRpb25zIHJlcXVpcmUgdmFsaWRhdGlvbiBmb3IgUkNzJyApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXdhaXQgY2hlY2tvdXRUYXJnZXQoIHJlcG8sIGJyYW5jaCwgdHJ1ZSApOyAvLyBpbmNsdWRlIG5wbSB1cGRhdGVcclxuXHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHByZXZpb3VzVmVyc2lvbiA9IGF3YWl0IGdldFJlcG9WZXJzaW9uKCByZXBvICk7XHJcblxyXG4gICAgaWYgKCBwcmV2aW91c1ZlcnNpb24udGVzdFR5cGUgIT09ICdyYycgJiYgcHJldmlvdXNWZXJzaW9uLnRlc3RUeXBlICE9PSBudWxsICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoIGBBYm9ydGVkIHJjIGRlcGxveW1lbnQgc2luY2UgdGhlIHZlcnNpb24gbnVtYmVyIGNhbm5vdCBiZSBpbmNyZW1lbnRlZCBzYWZlbHkgKHRlc3RUeXBlOiR7cHJldmlvdXNWZXJzaW9uLnRlc3RUeXBlfSlgICk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdmVyc2lvbiA9IG5ldyBTaW1WZXJzaW9uKCBwcmV2aW91c1ZlcnNpb24ubWFqb3IsIHByZXZpb3VzVmVyc2lvbi5taW5vciwgcHJldmlvdXNWZXJzaW9uLm1haW50ZW5hbmNlICsgKCBwcmV2aW91c1ZlcnNpb24udGVzdFR5cGUgPT09IG51bGwgPyAxIDogMCApLCB7XHJcbiAgICAgIHRlc3RUeXBlOiAncmMnLFxyXG4gICAgICB0ZXN0TnVtYmVyOiBwcmV2aW91c1ZlcnNpb24udGVzdE51bWJlciA/IHByZXZpb3VzVmVyc2lvbi50ZXN0TnVtYmVyICsgMSA6IDFcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCB2ZXJzaW9uU3RyaW5nID0gdmVyc2lvbi50b1N0cmluZygpO1xyXG4gICAgY29uc3Qgc2ltUGF0aCA9IGJ1aWxkTG9jYWwuZGV2RGVwbG95UGF0aCArIHJlcG87XHJcbiAgICBjb25zdCB2ZXJzaW9uUGF0aCA9IGAke3NpbVBhdGh9LyR7dmVyc2lvblN0cmluZ31gO1xyXG5cclxuICAgIGNvbnN0IHZlcnNpb25QYXRoRXhpc3RzID0gYXdhaXQgZGV2RGlyZWN0b3J5RXhpc3RzKCB2ZXJzaW9uUGF0aCApO1xyXG5cclxuICAgIGlmICggdmVyc2lvblBhdGhFeGlzdHMgKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvciggYERpcmVjdG9yeSAke3ZlcnNpb25QYXRofSBhbHJlYWR5IGV4aXN0cy4gIElmIHlvdSBpbnRlbmQgdG8gcmVwbGFjZSB0aGUgY29udGVudCB0aGVuIHJlbW92ZSB0aGUgZGlyZWN0b3J5IG1hbnVhbGx5IGZyb20gJHtidWlsZExvY2FsLmRldkRlcGxveVNlcnZlcn0uYCApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICggIWF3YWl0IGJvb2xlYW5Qcm9tcHQoIGBEZXBsb3kgJHt2ZXJzaW9uU3RyaW5nfSB0byAke2J1aWxkTG9jYWwuZGV2RGVwbG95U2VydmVyfWAsIG5vbmludGVyYWN0aXZlICkgKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvciggJ0Fib3J0ZWQgcmMgZGVwbG95bWVudCcgKTtcclxuICAgIH1cclxuXHJcbiAgICBhd2FpdCBzZXRSZXBvVmVyc2lvbiggcmVwbywgdmVyc2lvbiwgbWVzc2FnZSApO1xyXG4gICAgYXdhaXQgZ2l0UHVzaCggcmVwbywgYnJhbmNoICk7XHJcblxyXG4gICAgLy8gTWFrZSBzdXJlIG91ciBjb3JyZWN0IG5wbSBkZXBlbmRlbmNpZXMgYXJlIHNldFxyXG4gICAgYXdhaXQgbnBtVXBkYXRlKCByZXBvICk7XHJcbiAgICBhd2FpdCBucG1VcGRhdGUoICdjaGlwcGVyJyApO1xyXG4gICAgYXdhaXQgbnBtVXBkYXRlKCAncGVyZW5uaWFsLWFsaWFzJyApO1xyXG5cclxuICAgIC8vIE5vIHNwZWNpYWwgb3B0aW9ucyByZXF1aXJlZCBoZXJlLCBhcyB3ZSBzZW5kIHRoZSBtYWluIHJlcXVlc3QgdG8gdGhlIGJ1aWxkIHNlcnZlclxyXG4gICAgZ3J1bnQubG9nLndyaXRlbG4oIGF3YWl0IGJ1aWxkKCByZXBvLCB7XHJcbiAgICAgIGJyYW5kczogYnJhbmRzLFxyXG4gICAgICBtaW5pZnk6ICFub25pbnRlcmFjdGl2ZVxyXG4gICAgfSApICk7XHJcblxyXG4gICAgaWYgKCAhYXdhaXQgYm9vbGVhblByb21wdCggYFBsZWFzZSB0ZXN0IHRoZSBidWlsdCB2ZXJzaW9uIG9mICR7cmVwb30uXFxuSXMgaXQgcmVhZHkgdG8gZGVwbG95YCwgbm9uaW50ZXJhY3RpdmUgKSApIHtcclxuICAgICAgLy8gQWJvcnQgdmVyc2lvbiB1cGRhdGVcclxuICAgICAgYXdhaXQgc2V0UmVwb1ZlcnNpb24oIHJlcG8sIHByZXZpb3VzVmVyc2lvbiwgbWVzc2FnZSApO1xyXG4gICAgICBhd2FpdCBnaXRQdXNoKCByZXBvLCBicmFuY2ggKTtcclxuXHJcbiAgICAgIC8vIEFib3J0IGNoZWNrb3V0XHJcbiAgICAgIGF3YWl0IGNoZWNrb3V0TWFpbiggcmVwbywgdHJ1ZSApO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoICdBYm9ydGVkIHJjIGRlcGxveW1lbnQgKGFib3J0ZWQgdmVyc2lvbiBjaGFuZ2UgdG9vKS4nICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTW92ZSBvdmVyIGRlcGVuZGVuY2llcy5qc29uIGFuZCBjb21taXQvcHVzaFxyXG4gICAgYXdhaXQgdXBkYXRlRGVwZW5kZW5jaWVzSlNPTiggcmVwbywgYnJhbmRzLCB2ZXJzaW9uU3RyaW5nLCBicmFuY2ggKTtcclxuXHJcbiAgICAvLyBTZW5kIHRoZSBidWlsZCByZXF1ZXN0XHJcbiAgICBhd2FpdCBidWlsZFNlcnZlclJlcXVlc3QoIHJlcG8sIHZlcnNpb24sIGJyYW5jaCwgYXdhaXQgZ2V0RGVwZW5kZW5jaWVzKCByZXBvICksIHtcclxuICAgICAgbG9jYWxlczogWyAnZW4nIF0sXHJcbiAgICAgIGJyYW5kczogYnJhbmRzLFxyXG4gICAgICBzZXJ2ZXJzOiBbICdkZXYnIF1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBNb3ZlIGJhY2sgdG8gbWFpblxyXG4gICAgYXdhaXQgY2hlY2tvdXRNYWluKCByZXBvLCB0cnVlICk7XHJcblxyXG4gICAgY29uc3QgdmVyc2lvblVSTCA9IGBodHRwczovL3BoZXQtZGV2LmNvbG9yYWRvLmVkdS9odG1sLyR7cmVwb30vJHt2ZXJzaW9uU3RyaW5nfWA7XHJcblxyXG4gICAgaWYgKCBicmFuZHMuaW5jbHVkZXMoICdwaGV0JyApICkge1xyXG4gICAgICBncnVudC5sb2cud3JpdGVsbiggYERlcGxveWVkOiAke3ZlcnNpb25VUkx9L3BoZXQvJHtyZXBvfV9hbGxfcGhldC5odG1sYCApO1xyXG4gICAgfVxyXG4gICAgaWYgKCBicmFuZHMuaW5jbHVkZXMoICdwaGV0LWlvJyApICkge1xyXG4gICAgICBncnVudC5sb2cud3JpdGVsbiggYERlcGxveWVkOiAke3ZlcnNpb25VUkx9L3BoZXQtaW8vYCApO1xyXG4gICAgfVxyXG5cclxuICAgIGdydW50LmxvZy53cml0ZWxuKCAnUGxlYXNlIHdhaXQgZm9yIHRoZSBidWlsZC1zZXJ2ZXIgdG8gY29tcGxldGUgdGhlIGRlcGxveW1lbnQsIGFuZCB0aGVuIHRlc3QhJyApO1xyXG4gICAgZ3J1bnQubG9nLndyaXRlbG4oIGBUbyB2aWV3IHRoZSBjdXJyZW50IGJ1aWxkIHN0YXR1cywgdmlzaXQgJHtidWlsZExvY2FsLnByb2R1Y3Rpb25TZXJ2ZXJVUkx9L2RlcGxveS1zdGF0dXNgICk7XHJcblxyXG4gICAgcmV0dXJuIHZlcnNpb247XHJcbiAgfVxyXG4gIGNhdGNoKCBlICkge1xyXG4gICAgZ3J1bnQubG9nLndhcm4oICdEZXRlY3RlZCBmYWlsdXJlIGR1cmluZyBkZXBsb3ksIHJldmVydGluZyB0byBtYWluJyApO1xyXG4gICAgYXdhaXQgY2hlY2tvdXRNYWluKCByZXBvLCB0cnVlICk7XHJcbiAgICB0aHJvdyBlO1xyXG4gIH1cclxufTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUUsc0JBQXVCLENBQUM7QUFDcEQsTUFBTUMsYUFBYSxHQUFHRCxPQUFPLENBQUUseUJBQTBCLENBQUM7QUFDMUQsTUFBTUUsS0FBSyxHQUFHRixPQUFPLENBQUUsaUJBQWtCLENBQUM7QUFDMUMsTUFBTUcsVUFBVSxHQUFHSCxPQUFPLENBQUUsc0JBQXVCLENBQUM7QUFDcEQsTUFBTUksa0JBQWtCLEdBQUdKLE9BQU8sQ0FBRSw4QkFBK0IsQ0FBQztBQUNwRSxNQUFNSyxZQUFZLEdBQUdMLE9BQU8sQ0FBRSx3QkFBeUIsQ0FBQztBQUN4RCxNQUFNTSxjQUFjLEdBQUdOLE9BQU8sQ0FBRSwwQkFBMkIsQ0FBQztBQUM1RCxNQUFNTyxrQkFBa0IsR0FBR1AsT0FBTyxDQUFFLDhCQUErQixDQUFDO0FBQ3BFLE1BQU1RLGVBQWUsR0FBR1IsT0FBTyxDQUFFLDJCQUE0QixDQUFDO0FBQzlELE1BQU1TLGNBQWMsR0FBR1QsT0FBTyxDQUFFLDBCQUEyQixDQUFDO0FBQzVELE1BQU1VLFdBQVcsR0FBR1YsT0FBTyxDQUFFLHVCQUF3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