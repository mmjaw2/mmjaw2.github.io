// Copyright 2021, University of Colorado Boulder
// @author Matt Pennington (PhET Interactive Simulations)

const axios = require('axios');
const getFullStringMap = require('./getFullStringMap');
const loadJSON = require('../common/loadJSON');
const gitCheckout = require('../common/gitCheckout');

/**
 * NOTE: release branch NEEDS to be checked out for this to be called, since we'll need the dependencies.json file
 *
 * @param {string} simName
 * @param {string[]} locales - a list of locale codes
 * @param {string} checkoutDir
 * @returns {Promise.<{}>}
 */
const parseScreenNamesFromSimulation = async (simName, locales, checkoutDir) => {
  const stringMap = await getFullStringMap(simName, checkoutDir);
  const packageObject = await loadJSON(`${checkoutDir}/${simName}/package.json`);
  const screenNameKeys = packageObject.phet.screenNameKeys || [];
  const result = {};
  for (const locale of locales) {
    // TODO: proper locale fallback for https://github.com/phetsims/joist/issues/963
    result[locale] = screenNameKeys.map(key => stringMap[key][locale] || stringMap[key][locale.slice(0, 2)] || stringMap[key].en);
  }
  return result;
};
const parseScreenNamesAllSimulations = async () => {
  const url = 'https://phet.colorado.edu/services/metadata/1.3/simulations?format=json&type=html&summary';
  const projects = (await axios.get(url)).data.projects;
  const screenNameObject = {};
  for (let projectIndex = 0; projectIndex < projects.length; projectIndex++) {
    const project = projects[projectIndex];
    const simulation = project.simulations[0];
    const simName = simulation.name;
    const locales = Object.keys(simulation.localizedSimulations);
    await gitCheckout(simName, `${project.version.major}.${project.version.minor}`);
    screenNameObject[simName] = await parseScreenNamesFromSimulation(simName, locales, '..');
    await gitCheckout(simName, 'main');
  }
  return screenNameObject;
};
module.exports = {
  parseScreenNames: parseScreenNamesFromSimulation,
  parseScreenNamesAllSimulations: parseScreenNamesAllSimulations
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJheGlvcyIsInJlcXVpcmUiLCJnZXRGdWxsU3RyaW5nTWFwIiwibG9hZEpTT04iLCJnaXRDaGVja291dCIsInBhcnNlU2NyZWVuTmFtZXNGcm9tU2ltdWxhdGlvbiIsInNpbU5hbWUiLCJsb2NhbGVzIiwiY2hlY2tvdXREaXIiLCJzdHJpbmdNYXAiLCJwYWNrYWdlT2JqZWN0Iiwic2NyZWVuTmFtZUtleXMiLCJwaGV0IiwicmVzdWx0IiwibG9jYWxlIiwibWFwIiwia2V5Iiwic2xpY2UiLCJlbiIsInBhcnNlU2NyZWVuTmFtZXNBbGxTaW11bGF0aW9ucyIsInVybCIsInByb2plY3RzIiwiZ2V0IiwiZGF0YSIsInNjcmVlbk5hbWVPYmplY3QiLCJwcm9qZWN0SW5kZXgiLCJsZW5ndGgiLCJwcm9qZWN0Iiwic2ltdWxhdGlvbiIsInNpbXVsYXRpb25zIiwibmFtZSIsIk9iamVjdCIsImtleXMiLCJsb2NhbGl6ZWRTaW11bGF0aW9ucyIsInZlcnNpb24iLCJtYWpvciIsIm1pbm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsInBhcnNlU2NyZWVuTmFtZXMiXSwic291cmNlcyI6WyJwYXJzZVNjcmVlbk5hbWVzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIxLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuLy8gQGF1dGhvciBNYXR0IFBlbm5pbmd0b24gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcblxyXG5jb25zdCBheGlvcyA9IHJlcXVpcmUoICdheGlvcycgKTtcclxuY29uc3QgZ2V0RnVsbFN0cmluZ01hcCA9IHJlcXVpcmUoICcuL2dldEZ1bGxTdHJpbmdNYXAnICk7XHJcbmNvbnN0IGxvYWRKU09OID0gcmVxdWlyZSggJy4uL2NvbW1vbi9sb2FkSlNPTicgKTtcclxuY29uc3QgZ2l0Q2hlY2tvdXQgPSByZXF1aXJlKCAnLi4vY29tbW9uL2dpdENoZWNrb3V0JyApO1xyXG5cclxuLyoqXHJcbiAqIE5PVEU6IHJlbGVhc2UgYnJhbmNoIE5FRURTIHRvIGJlIGNoZWNrZWQgb3V0IGZvciB0aGlzIHRvIGJlIGNhbGxlZCwgc2luY2Ugd2UnbGwgbmVlZCB0aGUgZGVwZW5kZW5jaWVzLmpzb24gZmlsZVxyXG4gKlxyXG4gKiBAcGFyYW0ge3N0cmluZ30gc2ltTmFtZVxyXG4gKiBAcGFyYW0ge3N0cmluZ1tdfSBsb2NhbGVzIC0gYSBsaXN0IG9mIGxvY2FsZSBjb2Rlc1xyXG4gKiBAcGFyYW0ge3N0cmluZ30gY2hlY2tvdXREaXJcclxuICogQHJldHVybnMge1Byb21pc2UuPHt9Pn1cclxuICovXHJcbmNvbnN0IHBhcnNlU2NyZWVuTmFtZXNGcm9tU2ltdWxhdGlvbiA9IGFzeW5jICggc2ltTmFtZSwgbG9jYWxlcywgY2hlY2tvdXREaXIgKSA9PiB7XHJcblxyXG4gIGNvbnN0IHN0cmluZ01hcCA9IGF3YWl0IGdldEZ1bGxTdHJpbmdNYXAoIHNpbU5hbWUsIGNoZWNrb3V0RGlyICk7XHJcbiAgY29uc3QgcGFja2FnZU9iamVjdCA9IGF3YWl0IGxvYWRKU09OKCBgJHtjaGVja291dERpcn0vJHtzaW1OYW1lfS9wYWNrYWdlLmpzb25gICk7XHJcbiAgY29uc3Qgc2NyZWVuTmFtZUtleXMgPSBwYWNrYWdlT2JqZWN0LnBoZXQuc2NyZWVuTmFtZUtleXMgfHwgW107XHJcblxyXG4gIGNvbnN0IHJlc3VsdCA9IHt9O1xyXG4gIGZvciAoIGNvbnN0IGxvY2FsZSBvZiBsb2NhbGVzICkge1xyXG4gICAgLy8gVE9ETzogcHJvcGVyIGxvY2FsZSBmYWxsYmFjayBmb3IgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy85NjNcclxuICAgIHJlc3VsdFsgbG9jYWxlIF0gPSBzY3JlZW5OYW1lS2V5cy5tYXAoIGtleSA9PiBzdHJpbmdNYXBbIGtleSBdWyBsb2NhbGUgXSB8fCBzdHJpbmdNYXBbIGtleSBdWyBsb2NhbGUuc2xpY2UoIDAsIDIgKSBdIHx8IHN0cmluZ01hcFsga2V5IF0uZW4gKTtcclxuICB9XHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufTtcclxuXHJcbmNvbnN0IHBhcnNlU2NyZWVuTmFtZXNBbGxTaW11bGF0aW9ucyA9IGFzeW5jICgpID0+IHtcclxuICBjb25zdCB1cmwgPSAnaHR0cHM6Ly9waGV0LmNvbG9yYWRvLmVkdS9zZXJ2aWNlcy9tZXRhZGF0YS8xLjMvc2ltdWxhdGlvbnM/Zm9ybWF0PWpzb24mdHlwZT1odG1sJnN1bW1hcnknO1xyXG4gIGNvbnN0IHByb2plY3RzID0gKCBhd2FpdCBheGlvcy5nZXQoIHVybCApICkuZGF0YS5wcm9qZWN0cztcclxuXHJcbiAgY29uc3Qgc2NyZWVuTmFtZU9iamVjdCA9IHt9O1xyXG5cclxuICBmb3IgKCBsZXQgcHJvamVjdEluZGV4ID0gMDsgcHJvamVjdEluZGV4IDwgcHJvamVjdHMubGVuZ3RoOyBwcm9qZWN0SW5kZXgrKyApIHtcclxuICAgIGNvbnN0IHByb2plY3QgPSBwcm9qZWN0c1sgcHJvamVjdEluZGV4IF07XHJcbiAgICBjb25zdCBzaW11bGF0aW9uID0gcHJvamVjdC5zaW11bGF0aW9uc1sgMCBdO1xyXG4gICAgY29uc3Qgc2ltTmFtZSA9IHNpbXVsYXRpb24ubmFtZTtcclxuICAgIGNvbnN0IGxvY2FsZXMgPSBPYmplY3Qua2V5cyggc2ltdWxhdGlvbi5sb2NhbGl6ZWRTaW11bGF0aW9ucyApO1xyXG4gICAgYXdhaXQgZ2l0Q2hlY2tvdXQoIHNpbU5hbWUsIGAke3Byb2plY3QudmVyc2lvbi5tYWpvcn0uJHtwcm9qZWN0LnZlcnNpb24ubWlub3J9YCApO1xyXG4gICAgc2NyZWVuTmFtZU9iamVjdFsgc2ltTmFtZSBdID0gYXdhaXQgcGFyc2VTY3JlZW5OYW1lc0Zyb21TaW11bGF0aW9uKCBzaW1OYW1lLCBsb2NhbGVzLCAnLi4nICk7XHJcbiAgICBhd2FpdCBnaXRDaGVja291dCggc2ltTmFtZSwgJ21haW4nICk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gc2NyZWVuTmFtZU9iamVjdDtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHBhcnNlU2NyZWVuTmFtZXM6IHBhcnNlU2NyZWVuTmFtZXNGcm9tU2ltdWxhdGlvbixcclxuICBwYXJzZVNjcmVlbk5hbWVzQWxsU2ltdWxhdGlvbnM6IHBhcnNlU2NyZWVuTmFtZXNBbGxTaW11bGF0aW9uc1xyXG59OyJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTs7QUFFQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBRSxPQUFRLENBQUM7QUFDaEMsTUFBTUMsZ0JBQWdCLEdBQUdELE9BQU8sQ0FBRSxvQkFBcUIsQ0FBQztBQUN4RCxNQUFNRSxRQUFRLEdBQUdGLE9BQU8sQ0FBRSxvQkFBcUIsQ0FBQztBQUNoRCxNQUFNRyxXQUFXLEdBQUdILE9BQU8sQ0FBRSx1QkFBd0IsQ0FBQzs7QUFFdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1JLDhCQUE4QixHQUFHLE1BQUFBLENBQVFDLE9BQU8sRUFBRUMsT0FBTyxFQUFFQyxXQUFXLEtBQU07RUFFaEYsTUFBTUMsU0FBUyxHQUFHLE1BQU1QLGdCQUFnQixDQUFFSSxPQUFPLEVBQUVFLFdBQVksQ0FBQztFQUNoRSxNQUFNRSxhQUFhLEdBQUcsTUFBTVAsUUFBUSxDQUFHLEdBQUVLLFdBQVksSUFBR0YsT0FBUSxlQUFlLENBQUM7RUFDaEYsTUFBTUssY0FBYyxHQUFHRCxhQUFhLENBQUNFLElBQUksQ0FBQ0QsY0FBYyxJQUFJLEVBQUU7RUFFOUQsTUFBTUUsTUFBTSxHQUFHLENBQUMsQ0FBQztFQUNqQixLQUFNLE1BQU1DLE1BQU0sSUFBSVAsT0FBTyxFQUFHO0lBQzlCO0lBQ0FNLE1BQU0sQ0FBRUMsTUFBTSxDQUFFLEdBQUdILGNBQWMsQ0FBQ0ksR0FBRyxDQUFFQyxHQUFHLElBQUlQLFNBQVMsQ0FBRU8sR0FBRyxDQUFFLENBQUVGLE1BQU0sQ0FBRSxJQUFJTCxTQUFTLENBQUVPLEdBQUcsQ0FBRSxDQUFFRixNQUFNLENBQUNHLEtBQUssQ0FBRSxDQUFDLEVBQUUsQ0FBRSxDQUFDLENBQUUsSUFBSVIsU0FBUyxDQUFFTyxHQUFHLENBQUUsQ0FBQ0UsRUFBRyxDQUFDO0VBQy9JO0VBQ0EsT0FBT0wsTUFBTTtBQUNmLENBQUM7QUFFRCxNQUFNTSw4QkFBOEIsR0FBRyxNQUFBQSxDQUFBLEtBQVk7RUFDakQsTUFBTUMsR0FBRyxHQUFHLDJGQUEyRjtFQUN2RyxNQUFNQyxRQUFRLEdBQUcsQ0FBRSxNQUFNckIsS0FBSyxDQUFDc0IsR0FBRyxDQUFFRixHQUFJLENBQUMsRUFBR0csSUFBSSxDQUFDRixRQUFRO0VBRXpELE1BQU1HLGdCQUFnQixHQUFHLENBQUMsQ0FBQztFQUUzQixLQUFNLElBQUlDLFlBQVksR0FBRyxDQUFDLEVBQUVBLFlBQVksR0FBR0osUUFBUSxDQUFDSyxNQUFNLEVBQUVELFlBQVksRUFBRSxFQUFHO0lBQzNFLE1BQU1FLE9BQU8sR0FBR04sUUFBUSxDQUFFSSxZQUFZLENBQUU7SUFDeEMsTUFBTUcsVUFBVSxHQUFHRCxPQUFPLENBQUNFLFdBQVcsQ0FBRSxDQUFDLENBQUU7SUFDM0MsTUFBTXZCLE9BQU8sR0FBR3NCLFVBQVUsQ0FBQ0UsSUFBSTtJQUMvQixNQUFNdkIsT0FBTyxHQUFHd0IsTUFBTSxDQUFDQyxJQUFJLENBQUVKLFVBQVUsQ0FBQ0ssb0JBQXFCLENBQUM7SUFDOUQsTUFBTTdCLFdBQVcsQ0FBRUUsT0FBTyxFQUFHLEdBQUVxQixPQUFPLENBQUNPLE9BQU8sQ0FBQ0MsS0FBTSxJQUFHUixPQUFPLENBQUNPLE9BQU8sQ0FBQ0UsS0FBTSxFQUFFLENBQUM7SUFDakZaLGdCQUFnQixDQUFFbEIsT0FBTyxDQUFFLEdBQUcsTUFBTUQsOEJBQThCLENBQUVDLE9BQU8sRUFBRUMsT0FBTyxFQUFFLElBQUssQ0FBQztJQUM1RixNQUFNSCxXQUFXLENBQUVFLE9BQU8sRUFBRSxNQUFPLENBQUM7RUFDdEM7RUFFQSxPQUFPa0IsZ0JBQWdCO0FBQ3pCLENBQUM7QUFFRGEsTUFBTSxDQUFDQyxPQUFPLEdBQUc7RUFDZkMsZ0JBQWdCLEVBQUVsQyw4QkFBOEI7RUFDaERjLDhCQUE4QixFQUFFQTtBQUNsQyxDQUFDIiwiaWdub3JlTGlzdCI6W119